<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  NTUSTISC - AD Note - 環境建置 & Background
  #

[TOC]
Lecture Video: 2022/05/04 AD 安全1

  Background
  #



What is Directory Service?1


Windows Server 系統使用的目錄服務 就是 Active Directory


What is Active Directory(AD)?2

Windows的Windows Server中，負責架構中大型網路環境的集中式目錄管理服務(Directory Services)，他處理在組織中的網路物件，物件可以是使用者、群組、電腦、網域控制站、郵件、設定檔、組織單元、樹系等等，只要是在AD結構定義檔(Schema)中定義的物件，就可以儲存在AD資料檔中，並利用AD Service Interface來存取


What is Domain Service?1


執行 AD DS 的伺服器稱為 domain controllers (DCs)


What is LDAP?3
:::info

輕量型目錄存取協定 (LDAP) 是用來從 Active Directory 讀取資料，及將資料寫入 Active Directory 的標準協定。某些應用程式使用 LDAP 新增、移除或搜尋 Active Directory 中的使用者和群組，或是傳輸登入資料來驗證 Active Directory 中的使用者。每個 LDAP 通訊都包括用戶端 (如應用程式) 和伺服器 (例如 Active Directory)。
:::"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntust-isc/ad/ntustisc---ad-note---0x01%E7%92%B0%E5%A2%83%E5%BB%BA%E7%BD%AE--background/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="NTUSTISC - AD Note - 環境建置 & Background"><meta property="og:description" content="NTUSTISC - AD Note - 環境建置 & Background # [TOC]
Lecture Video: 2022/05/04 AD 安全1
Background # What is Directory Service?1
Windows Server 系統使用的目錄服務 就是 Active Directory
What is Active Directory(AD)?2
Windows的Windows Server中，負責架構中大型網路環境的集中式目錄管理服務(Directory Services)，他處理在組織中的網路物件，物件可以是使用者、群組、電腦、網域控制站、郵件、設定檔、組織單元、樹系等等，只要是在AD結構定義檔(Schema)中定義的物件，就可以儲存在AD資料檔中，並利用AD Service Interface來存取
What is Domain Service?1
執行 AD DS 的伺服器稱為 domain controllers (DCs)
What is LDAP?3 :::info
輕量型目錄存取協定 (LDAP) 是用來從 Active Directory 讀取資料，及將資料寫入 Active Directory 的標準協定。某些應用程式使用 LDAP 新增、移除或搜尋 Active Directory 中的使用者和群組，或是傳輸登入資料來驗證 Active Directory 中的使用者。每個 LDAP 通訊都包括用戶端 (如應用程式) 和伺服器 (例如 Active Directory)。 :::"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="AD"><meta property="article:tag" content="Information Security"><meta property="article:tag" content="NTUSTISC"><title>NTUSTISC - AD Note - 環境建置 & Background | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntust-isc/ad/ntustisc---ad-note---0x01%E7%92%B0%E5%A2%83%E5%BB%BA%E7%BD%AE--background/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>NTUSTISC - AD Note - 環境建置 & Background</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#background>Background</a><ul><li><a href=#內建gpo>內建GPO</a></li></ul></li><li><a href=#環境建置>環境建置</a><ul><li><a href=#實驗環境拓樸>實驗環境拓樸</a></li><li><a href=#帳號密碼>帳號密碼</a></li><li><a href=#詳細步驟>詳細步驟</a></li></ul></li><li><a href=#reference>Reference</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=ntustisc---ad-note---環境建置--background>NTUSTISC - AD Note - 環境建置 & Background
<a class=anchor href=#ntustisc---ad-note---%e7%92%b0%e5%a2%83%e5%bb%ba%e7%bd%ae--background>#</a></h1><p>[TOC]</p><p>Lecture Video: <a href="https://youtu.be/Cv2gNQkDM8Q?si=SycYwgWohlu97dc3">2022/05/04 AD 安全1</a></p><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><ul><li><p>What is Directory Service?<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><blockquote><p><img src=https://i.imgur.com/QVJYCoG.jpg alt>
Windows Server 系統使用的目錄服務 就是 Active Directory</p></blockquote></li><li><p>What is Active Directory(AD)?<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></p><blockquote><p>Windows的Windows Server中，負責架構中大型網路環境的集中式目錄管理服務(Directory Services)，他處理在組織中的網路物件，物件可以是<font color=FF0000>使用者、群組、電腦、網域控制站、郵件、設定檔、組織單元、樹系</font>等等，只要是在AD結構定義檔(Schema)中定義的物件，就可以儲存在AD資料檔中，並利用AD Service Interface來存取</p></blockquote></li><li><p>What is Domain Service?<sup id=fnref1:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><blockquote><p><img src=https://i.imgur.com/k2ma2Nf.jpg alt>
執行 AD DS 的伺服器稱為 domain controllers (DCs)</p></blockquote></li><li><p>What is LDAP?<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>
:::info</p><blockquote><p>輕量型目錄存取協定 (LDAP) 是用來從 Active Directory 讀取資料，及將資料寫入 Active Directory 的標準協定。某些應用程式使用 LDAP 新增、移除或搜尋 Active Directory 中的使用者和群組，或是傳輸登入資料來驗證 Active Directory 中的使用者。每個 LDAP 通訊都包括用戶端 (如應用程式) 和伺服器 (例如 Active Directory)。
:::</p></blockquote></li><li><p>What is Organization Units(OU)?[^fei-organization-units]</p><blockquote><p>容區(Container)：屬性集合，跟物件不同是容器可以包含多個「物件」
組織單位(Organization Units)：特殊容區，可包含其他物件、組織單位、群組原則</p></blockquote></li><li><p>What is Group Policy Object(GPO)?<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></p><blockquote><p>群組原則是透過群組原則物件(Group Policy Object,GPO)來設定，你要只要將GPO連結到指定的網域，此GPO內的設定值就會影響到該網域內的所有使用者與電腦。</p><h3 id=內建gpo>內建GPO
<a class=anchor href=#%e5%85%a7%e5%bb%bagpo>#</a></h3><p>AD DS網域有兩個內建的GPO</p><ol><li>Default Domain Policy:此GPO預設已備連結到網域，因此其設定值會套用到整個網域內的所有使用者與電腦。</li><li>Default Domain Controller Policy:此GPO預設已被連到組織單位Domain Controllers，因此其設定值會被套用到Domain Controllers內所有的使用者與電腦
(Domain Controllers 內預設只有網域控制站的電腦帳戶。)</li></ol></blockquote></li></ul><h2 id=環境建置>環境建置
<a class=anchor href=#%e7%92%b0%e5%a2%83%e5%bb%ba%e7%bd%ae>#</a></h2><p>:::info
這一整個lab雖然是從講師的drive下載下來的(連結爛掉了，有需要可以跟我拿)，但還是可以從網路中自己創一個有這麼多漏洞的lab環境。可以先安裝win2016的虛擬機，然後到<a href=https://github.com/WazeHell/vulnerable-AD>WazeHell/vulnerable-AD</a>下載script，在該環境中跑起來，就可以了，不果因為跑完之後的所有帳號或密碼都是隨機的，所以如果要看別人或是後續我寫的WP會有點困難
:::</p><h3 id=實驗環境拓樸>實驗環境拓樸
<a class=anchor href=#%e5%af%a6%e9%a9%97%e7%92%b0%e5%a2%83%e6%8b%93%e6%a8%b8>#</a></h3><p><img src=https://hackmd.io/_uploads/B14swTr62.png alt></p><h3 id=帳號密碼>帳號密碼
<a class=anchor href=#%e5%b8%b3%e8%99%9f%e5%af%86%e7%a2%bc>#</a></h3><ul><li>Win10(Client)
帳號：administrator
密碼：1qaz@WSX3edc<ul><li>一般的網域帳號
帳號：bear
密碼：1qaz@WSX3edc</li><li>低權限帳號
帳號：low
密碼：&lt;無></li></ul></li><li>Win2016(DC)
帳號：administrator
密碼：1qaz@WSX3edc</li><li>==Note==
:::info
如果要指定本機端的帳戶進行登入，可以在帳號前面加入<code>.\</code>的符號或是直接寫主機名稱，強制用本地端的帳號登入，這個帳戶就是沒有加入AD domain底下
:::</li></ul><h3 id=詳細步驟>詳細步驟
<a class=anchor href=#%e8%a9%b3%e7%b4%b0%e6%ad%a5%e9%a9%9f>#</a></h3><ol><li><p>把講師提供的兩支VM(win10/win2016)灌起來並自行下載<a href=https://old.kali.org/kali-images/kali-2022.4/>kali2022</a>，==建議用VMware==</p></li><li><p>啟用Neo4j & BloodHound
因為環境目前預設的JDK version是1.8，所以如果啟用後續會用到的Neo4j會出問題，所以我們要先改java版本，改成JDK-11，比較詳細的流程可以參考<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup></p><ol><li>Uninstall JDK-1.8</li><li>Download JDK-11 & Install it(<a href=https://www.oracle.com/tw/java/technologies/javase/jdk11-archive-downloads.html>Link</a>)<ul><li>下載之前會需要你登入Oracle帳號</li><li>如果想要知道哪一個版本的JAVA對應到哪一個版本的Neo4j，可以從這邊<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>找，照法就是在網址的地方中間有一個neo4j的版本，打上你的neo4j版本，他就會到對應的頁面告訴你JAVA的版本應該是多少，例如我的版本是4.3，就打上<code>https://neo4j.com/docs/operations-manual/4.3/installation/requirements/</code>，不過他也只有分3.x和4.x
<img src=https://hackmd.io/_uploads/r1_7srupn.png alt></li></ul></li><li>Modify Environment Variable<ul><li>更改環境變數這件事情一定要在Win10加入AD之前做的原因是，只要加入AD就無法改變環境變數的系統變數(如下圖)，那我有想過把Win10直接退掉AD的網域，不過過程困難重重，所以我想還是直接開一個新的Win10從頭來會比要快，而且加入AD後還不能連網，畢竟DNS都被改掉了，會很不方便
<img src=https://hackmd.io/_uploads/rJOVhBda3.png alt></li><li>首先要在系統變數的地方新增JAVA_HOME然後value就是當初安裝JDK-11的位置
<img src=https://hackmd.io/_uploads/Sy-fTr_a2.png alt></li><li>並在Path中新增<code>%JAVA_HOME%\bin</code>和<code>&lt;JDK-11 path to bin></code>並按下確定後到Command Prompt確認有沒有成功
<img src=https://hackmd.io/_uploads/BkbYTHOp2.png alt>
<img src=https://hackmd.io/_uploads/Syb-0BOa2.png alt></li></ul></li><li>Activate Neo4j
在neo4j的目錄中進到bin，然後打開cmd，輸入<code>$ neo4j.bat console</code>，理論上前面有做對，應該就會開啟Neo4j的服務
:::spoiler Activate Neo4j Log<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>C:<span style=color:#ae81ff>\t</span>ools<span style=color:#ae81ff>\n</span>eo4j-community-4.3.4<span style=color:#ae81ff>\b</span>in&gt;neo4j.bat console
</span></span><span style=display:flex><span>Directories in use:
</span></span><span style=display:flex><span>home:         C:<span style=color:#ae81ff>\t</span>ools<span style=color:#ae81ff>\n</span>eo4j-community-4.3.4
</span></span><span style=display:flex><span>config:       C:<span style=color:#ae81ff>\t</span>ools<span style=color:#ae81ff>\n</span>eo4j-community-4.3.4<span style=color:#ae81ff>\c</span>onf
</span></span><span style=display:flex><span>logs:         C:<span style=color:#ae81ff>\t</span>ools<span style=color:#ae81ff>\n</span>eo4j-community-4.3.4<span style=color:#ae81ff>\l</span>ogs
</span></span><span style=display:flex><span>plugins:      C:<span style=color:#ae81ff>\t</span>ools<span style=color:#ae81ff>\n</span>eo4j-community-4.3.4<span style=color:#ae81ff>\p</span>lugins
</span></span><span style=display:flex><span>import:       C:<span style=color:#ae81ff>\t</span>ools<span style=color:#ae81ff>\n</span>eo4j-community-4.3.4<span style=color:#ae81ff>\i</span>mport
</span></span><span style=display:flex><span>data:         C:<span style=color:#ae81ff>\t</span>ools<span style=color:#ae81ff>\n</span>eo4j-community-4.3.4<span style=color:#ae81ff>\d</span>ata
</span></span><span style=display:flex><span>certificates: C:<span style=color:#ae81ff>\t</span>ools<span style=color:#ae81ff>\n</span>eo4j-community-4.3.4<span style=color:#ae81ff>\c</span>ertificates
</span></span><span style=display:flex><span>licenses:     C:<span style=color:#ae81ff>\t</span>ools<span style=color:#ae81ff>\n</span>eo4j-community-4.3.4<span style=color:#ae81ff>\l</span>icenses
</span></span><span style=display:flex><span>run:          C:<span style=color:#ae81ff>\t</span>ools<span style=color:#ae81ff>\n</span>eo4j-community-4.3.4<span style=color:#ae81ff>\r</span>un
</span></span><span style=display:flex><span>Starting Neo4j.
</span></span><span style=display:flex><span>2023-08-27 03:48:08.068+0000 INFO  Starting...
</span></span><span style=display:flex><span>2023-08-27 03:48:10.649+0000 INFO  <span style=color:#f92672>========</span> Neo4j 4.3.4 <span style=color:#f92672>========</span>
</span></span><span style=display:flex><span>2023-08-27 03:48:12.832+0000 INFO  Initializing system graph model <span style=color:#66d9ef>for</span> component <span style=color:#e6db74>&#39;security-users&#39;</span> with version -1 and status UNINITIALIZED
</span></span><span style=display:flex><span>2023-08-27 03:48:12.848+0000 INFO  Setting up initial user from defaults: neo4j
</span></span><span style=display:flex><span>2023-08-27 03:48:12.848+0000 INFO  Creating new user <span style=color:#e6db74>&#39;neo4j&#39;</span> <span style=color:#f92672>(</span>passwordChangeRequired<span style=color:#f92672>=</span>true, suspended<span style=color:#f92672>=</span>false<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>2023-08-27 03:48:12.870+0000 INFO  Setting version <span style=color:#66d9ef>for</span> <span style=color:#e6db74>&#39;security-users&#39;</span> to <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>2023-08-27 03:48:12.870+0000 INFO  After initialization of system graph model component <span style=color:#e6db74>&#39;security-users&#39;</span> have version <span style=color:#ae81ff>3</span> and status CURRENT
</span></span><span style=display:flex><span>2023-08-27 03:48:12.870+0000 INFO  Performing postInitialization step <span style=color:#66d9ef>for</span> component <span style=color:#e6db74>&#39;security-users&#39;</span> with version <span style=color:#ae81ff>3</span> and status CURRENT
</span></span><span style=display:flex><span>2023-08-27 03:48:13.274+0000 INFO  Bolt enabled on 127.0.0.1:7687.
</span></span><span style=display:flex><span>2023-08-27 03:48:14.472+0000 INFO  Remote interface available at http://localhost:7474/
</span></span><span style=display:flex><span>2023-08-27 03:48:14.472+0000 INFO  Started.
</span></span><span style=display:flex><span>2023-08-27 03:51:44.289+0000 WARN  The client is unauthorized due to authentication failure.
</span></span></code></pre></div>:::
接著進到<code>http://localhost:7474/</code>，輸入預設帳密<code>neo4j/neo4j</code>，最後改密碼就好了
<img src=https://hackmd.io/_uploads/Syof1Uupn.png alt></li><li>Activate BloodHound
進到BloodHound/bin目錄然後執行<code>BloodHound.exe</code>輸入neo4j的帳密，就可以進到一個全新的bloodhound頁面
<img src=https://hackmd.io/_uploads/S1O51Idp2.png alt></li></ol></li><li><p>把Win10加入AD</p><ol><li>Check Win2016 IP - <code>192.168.183.129</code>
<img src=https://hackmd.io/_uploads/SJds2L8p3.png alt></li><li>將Win10的DNS指向AD
主要目的就是把Win10網卡的DNS指向前面找到的Domain，在<code>設定/網路和網際網路/狀態/變更介面卡選項/乙太網路/內容/網際網路通訊協定第4版(TCP/IPV4)/內容</code>就可以找到更改的地方，然後把Win2016的IP填入
<img src=https://hackmd.io/_uploads/SkcaAU8T2.png alt></li><li>更改Win10網域
從<code>控制台/系統及安全性/系統/變更設定/變更</code>中更改網域成<font color=ff0000><code>kuma.org</code></font>，填入帳密按確定就可以了
<img src=https://hackmd.io/_uploads/rkJPJD86n.png alt></li><li>Restart Win10</li><li>使用網域帳號登入
用bear這個帳號登入Win10
:::spoiler Result
<img src=https://hackmd.io/_uploads/rktozsvph.png alt>
可以看到系統資訊中，網域的部分已經變成kuma.org
:::</li></ol></li></ol><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://ithelp.ithome.com.tw/articles/10292831>AD Security - [Day2] 一起來學 AD 安全吧！：什麼是 AD(1) </a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://zh.wikipedia.org/zh-tw/Active_Directory>Active Directory</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://docs.aws.amazon.com/zh_tw/directoryservice/latest/admin-guide/ms_ad_ldap.html>啟用安全 LDAP (LDAPS)</a>
[^fei-organization-units]<a href=https://ithelp.ithome.com.tw/articles/10295116>AD Security - [Day5] 一起來學 AD 安全吧！：什麼是 AD(3) Container & OU & Security Group </a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://upas1030.pixnet.net/blog/post/116192137>GPO概念</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><a href=https://blog.csdn.net/Linsice/article/details/129748823>當安裝Neo4j後，在cmd中輸入neo4j遇到(ERROR!Neo4j cannot be started using java version 1.8.0_211</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p><a href=https://neo4j.com/docs/operations-manual/4.0/installation/requirements/>System requirements
</a>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#background>Background</a><ul><li><a href=#內建gpo>內建GPO</a></li></ul></li><li><a href=#環境建置>環境建置</a><ul><li><a href=#實驗環境拓樸>實驗環境拓樸</a></li><li><a href=#帳號密碼>帳號密碼</a></li><li><a href=#詳細步驟>詳細步驟</a></li></ul></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside></main></body></html>