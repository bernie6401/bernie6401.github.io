<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Simple Reverse - 0x29(2023 Lab - Unpackme)
  #


  Source code
  #

...
LOAD:0000000000005AE8 mov     rdi, [rsp+18h+start]            ; start
LOAD:0000000000005AED push    5
LOAD:0000000000005AEF pop     rdx                             ; prot
LOAD:0000000000005AF0 push    0Ah
LOAD:0000000000005AF2 pop     rax
LOAD:0000000000005AF3 syscall                                 ; LINUX - sys_mprotect
LOAD:0000000000005AF5 jmp     r13
LOAD:0000000000005AF5
LOAD:0000000000005AF5 sub_5A7C endp
LOAD:0000000000005AF5
LOAD:0000000000005AF8 ; ---------------------------------------------------------------------------
LOAD:0000000000005AF8
LOAD:0000000000005AF8 loc_5AF8:                               ; CODE XREF: start+2↑p
LOAD:0000000000005AF8 pop     rbp
LOAD:0000000000005AF9 call    sub_5A7C
LOAD:0000000000005AF9
LOAD:0000000000005AF9 ; ---------------------------------------------------------------------------
LOAD:0000000000005AFE aProcSelfExe db '/proc/self/exe',0
LOAD:0000000000005B0D align 2
LOAD:0000000000005B0E dw 1
LOAD:0000000000005B10 dq 81B00000C1100h, 0FFFFFF0000000200h, 7549F983004AE8E5h, 0FD374C8D48575344h, 0CE39482FEB5B565Eh, 0FFFFFBFF5E563273h
LOAD:0000000000005B10 dq 778F3C0A72803CACh, 2C06740FFE7E8006h, 56161BE477013CE8h, 0FFBFFFFF75D028ADh, 0D801F829C80F5FDFh, 0C35BDFEBAC0312ABh
LOAD:0000000000005B10 dq 8948505741564158h, 0DBFFEDFEEC8148E6h, 590A6A5F54591000h, 5003E8348A548F3h, 0B6AB48FE8949F875h, 0F60C0AFC0CCBB374h
LOAD:0000000000005B10 dq 4DF5FF6EDFFE02FFh, 5E57370FFFBAFC29h, 50F58596AED7B8Ch, 0DFFF6FDB0579C085h, 8D49FD91580F6A0Eh, 0E741AAA00B0FF7Dh
...
:::spoiler Real File main Function"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-cs/reverse/simple-reverse---0x292023-lab---unpackme/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Simple Reverse - 0x29(2023 Lab - Unpackme)"><meta property="og:description" content="Simple Reverse - 0x29(2023 Lab - Unpackme) # Source code # ... LOAD:0000000000005AE8 mov rdi, [rsp+18h+start] ; start LOAD:0000000000005AED push 5 LOAD:0000000000005AEF pop rdx ; prot LOAD:0000000000005AF0 push 0Ah LOAD:0000000000005AF2 pop rax LOAD:0000000000005AF3 syscall ; LINUX - sys_mprotect LOAD:0000000000005AF5 jmp r13 LOAD:0000000000005AF5 LOAD:0000000000005AF5 sub_5A7C endp LOAD:0000000000005AF5 LOAD:0000000000005AF8 ; --------------------------------------------------------------------------- LOAD:0000000000005AF8 LOAD:0000000000005AF8 loc_5AF8: ; CODE XREF: start+2↑p LOAD:0000000000005AF8 pop rbp LOAD:0000000000005AF9 call sub_5A7C LOAD:0000000000005AF9 LOAD:0000000000005AF9 ; --------------------------------------------------------------------------- LOAD:0000000000005AFE aProcSelfExe db '/proc/self/exe',0 LOAD:0000000000005B0D align 2 LOAD:0000000000005B0E dw 1 LOAD:0000000000005B10 dq 81B00000C1100h, 0FFFFFF0000000200h, 7549F983004AE8E5h, 0FD374C8D48575344h, 0CE39482FEB5B565Eh, 0FFFFFBFF5E563273h LOAD:0000000000005B10 dq 778F3C0A72803CACh, 2C06740FFE7E8006h, 56161BE477013CE8h, 0FFBFFFFF75D028ADh, 0D801F829C80F5FDFh, 0C35BDFEBAC0312ABh LOAD:0000000000005B10 dq 8948505741564158h, 0DBFFEDFEEC8148E6h, 590A6A5F54591000h, 5003E8348A548F3h, 0B6AB48FE8949F875h, 0F60C0AFC0CCBB374h LOAD:0000000000005B10 dq 4DF5FF6EDFFE02FFh, 5E57370FFFBAFC29h, 50F58596AED7B8Ch, 0DFFF6FDB0579C085h, 8D49FD91580F6A0Eh, 0E741AAA00B0FF7Dh ... :::spoiler Real File main Function"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="Eductf"><meta property="article:tag" content="CTF"><meta property="article:tag" content="Reverse"><title>Simple Reverse - 0x29(2023 Lab - Unpackme) | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-cs/reverse/simple-reverse---0x292023-lab---unpackme/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Simple Reverse - 0x29(2023 Lab - Unpackme)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#source-code>Source code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit>Exploit</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=simple-reverse---0x292023-lab---unpackme>Simple Reverse - 0x29(2023 Lab - Unpackme)
<a class=anchor href=#simple-reverse---0x292023-lab---unpackme>#</a></h1><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>...
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AE8 mov     rdi, [rsp<span style=color:#f92672>+</span><span style=color:#ae81ff>18</span>h<span style=color:#f92672>+</span>start]            ; start
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AED push    <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AEF pop     rdx                             ; prot
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AF0 push    <span style=color:#ae81ff>0</span>Ah
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AF2 pop     rax
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AF3 syscall                                 ; LINUX <span style=color:#f92672>-</span> sys_mprotect
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AF5 jmp     r13
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AF5
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AF5 sub_5A7C endp
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AF5
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AF8 ; <span style=color:#f92672>---------------------------------------------------------------------------</span>
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AF8
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AF8 loc_5AF8:                               ; CODE XREF: start<span style=color:#f92672>+</span><span style=color:#ae81ff>2</span><span style=color:#960050;background-color:#1e0010>↑</span>p
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AF8 pop     rbp
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AF9 call    sub_5A7C
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AF9
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AF9 ; <span style=color:#f92672>---------------------------------------------------------------------------</span>
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AFE aProcSelfExe db <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>/</span>proc<span style=color:#f92672>/</span>self<span style=color:#f92672>/</span>exe<span style=color:#960050;background-color:#1e0010>&#39;</span>,<span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>B0D align <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>B0E dw <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>B10 dq <span style=color:#ae81ff>81</span>B00000C1100h, <span style=color:#ae81ff>0FF</span>FFFF0000000200h, <span style=color:#ae81ff>7549F</span><span style=color:#ae81ff>983004</span>AE8E5h, <span style=color:#ae81ff>0F</span>D374C8D48575344h, <span style=color:#ae81ff>0</span>CE39482FEB5B565Eh, <span style=color:#ae81ff>0FF</span>FFFBFF5E563273h
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>B10 dq <span style=color:#ae81ff>778F</span><span style=color:#ae81ff>3</span>C0A72803CACh, <span style=color:#ae81ff>2</span>C06740FFE7E8006h, <span style=color:#ae81ff>56161</span>BE477013CE8h, <span style=color:#ae81ff>0FF</span>BFFFFF75D028ADh, <span style=color:#ae81ff>0</span>D801F829C80F5FDFh, <span style=color:#ae81ff>0</span>C35BDFEBAC0312ABh
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>B10 dq <span style=color:#ae81ff>8948505741564158</span>h, <span style=color:#ae81ff>0</span>DBFFEDFEEC8148E6h, <span style=color:#ae81ff>590</span>A6A5F54591000h, <span style=color:#ae81ff>5003E8348</span>A548F3h, <span style=color:#ae81ff>0</span>B6AB48FE8949F875h, <span style=color:#ae81ff>0F</span><span style=color:#ae81ff>60</span>C0AFC0CCBB374h
</span></span><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>B10 dq <span style=color:#ae81ff>4</span>DF5FF6EDFFE02FFh, <span style=color:#ae81ff>5E57370</span>FFFBAFC29h, <span style=color:#ae81ff>50F</span><span style=color:#ae81ff>58596</span>AED7B8Ch, <span style=color:#ae81ff>0</span>DFFF6FDB0579C085h, <span style=color:#ae81ff>8</span>D49FD91580F6A0Eh, <span style=color:#ae81ff>0E741</span>AAA00B0FF7Dh
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>:::spoiler Real File main Function</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#66d9ef>__cdecl</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>argv, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>envp)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> result; <span style=color:#75715e>// eax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int64</span> i; <span style=color:#75715e>// [rsp+8h] [rbp-58h]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>char</span> user_input[<span style=color:#ae81ff>32</span>]; <span style=color:#75715e>// [rsp+10h] [rbp-50h] BYREF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>char</span> v6[<span style=color:#ae81ff>40</span>]; <span style=color:#75715e>// [rsp+30h] [rbp-30h]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int64</span> v7; <span style=color:#75715e>// [rsp+58h] [rbp-8h]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  v7 <span style=color:#f92672>=</span> __readfsqword(<span style=color:#ae81ff>0x28u</span>);
</span></span><span style=display:flex><span>  printf(<span style=color:#e6db74>&#34;Enter input: &#34;</span>);
</span></span><span style=display:flex><span>  scanf(<span style=color:#e6db74>&#34;%s&#34;</span>, user_input);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( sub_10C0(user_input, qword_4018, <span style=color:#ae81ff>10LL</span>) )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    printf_0(<span style=color:#e6db74>&#34;Incorrect!&#34;</span>);
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> ( i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0LL</span>; i <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0x26</span>; <span style=color:#f92672>++</span>i )
</span></span><span style=display:flex><span>      v6[i] <span style=color:#f92672>=</span> user_input[i <span style=color:#f92672>%</span> <span style=color:#ae81ff>0xA</span>] <span style=color:#f92672>^</span> <span style=color:#f92672>*</span>(qword_4010 <span style=color:#f92672>+</span> i);
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;%s&#34;</span>);
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( v7 <span style=color:#f92672>!=</span> __readfsqword(<span style=color:#ae81ff>0x28u</span>) )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sub_10A0();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>:::</p><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><p>這一題一開始就知道是UPX加殼，但是直接試了upx幫忙decompress，卻遇到error，代表可能有一些問題(在Unix環境底下?)，所以我嘗試使用手動脫殼，去分析其中的內容</p><ol><li><p>首先可以先靜態看一下脫完殼之前是在哪邊跳轉，經過實測和判斷，應該是:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>LOAD:<span style=color:#ae81ff>0000000000005</span>AF5 jmp     r13
</span></span></code></pre></div><p>:::info
如何在動態取得這一行的位置呢?手動算出rebase address</p><ol><li>首先先用靜態分析看starti的時候的offset</li><li>開始動態執行程式</li><li>把目前指到的address拿去和靜態分析拿到的offset相減</li><li>(optional)可以用vmmap確認一下</li><li>再把我們想要得知的那一行的offset加回來</li></ol><hr><p><img src=https://hackmd.io/_uploads/Hk8-l9XXa.png alt=圖片.png>
一開始的offset是0x5888</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gef➤  starti
</span></span><span style=display:flex><span>gef➤  x/x 0x7ffff7ffd888-0x5888
</span></span><span style=display:flex><span>0x7ffff7ff8000: 0x7f
</span></span><span style=display:flex><span>gef➤  vmmap
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> Legend:  Code | Heap | Stack <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Start              End                Offset             Perm Path
</span></span><span style=display:flex><span>0x00007ffff7ff2000 0x00007ffff7ff6000 0x0000000000000000 r-- <span style=color:#f92672>[</span>vvar<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>0x00007ffff7ff6000 0x00007ffff7ff8000 0x0000000000000000 r-x <span style=color:#f92672>[</span>vdso<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>0x00007ffff7ff8000 0x00007ffff7ff9000 0x0000000000000000 rw- /mnt/d/NTU/Second Year/Computer Security/Reverse/Lab3/Unpackme/unpackme
</span></span><span style=display:flex><span>0x00007ffff7ff9000 0x00007ffff7ffd000 0x0000000000000000 rw-
</span></span><span style=display:flex><span>0x00007ffff7ffd000 0x00007ffff7fff000 0x0000000000000000 r-x /mnt/d/NTU/Second Year/Computer Security/Reverse/Lab3/Unpackme/unpackme
</span></span><span style=display:flex><span>0x00007ffffffdd000 0x00007ffffffff000 0x0000000000000000 rw- <span style=color:#f92672>[</span>stack<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>gef➤  x/10i 0x7ffff7ff8000+0x5AF5
</span></span><span style=display:flex><span>   0x7ffff7ffdaf5:      jmp    r13
</span></span><span style=display:flex><span>   0x7ffff7ffdaf8:      pop    rbp
</span></span><span style=display:flex><span>   0x7ffff7ffdaf9:      call   0x7ffff7ffda7c
</span></span><span style=display:flex><span>   0x7ffff7ffdafe:      <span style=color:#f92672>(</span>bad<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   0x7ffff7ffdaff:      jo     0x7ffff7ffdb73
</span></span><span style=display:flex><span>   0x7ffff7ffdb01:      outs   dx,DWORD PTR ds:<span style=color:#f92672>[</span>rsi<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   0x7ffff7ffdb02:      movsxd ebp,DWORD PTR <span style=color:#f92672>[</span>rdi<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   0x7ffff7ffdb04:      jae    0x7ffff7ffdb6b
</span></span><span style=display:flex><span>   0x7ffff7ffdb06:      ins    BYTE PTR es:<span style=color:#f92672>[</span>rdi<span style=color:#f92672>]</span>,dx
</span></span><span style=display:flex><span>   0x7ffff7ffdb07:      data16 <span style=color:#f92672>(</span>bad<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>:::</p></li><li><p>利用動態看r13的address會跳去哪邊$\to$0x00007ffff7ff1000</p></li><li><p>接下來我找不太到分析的地方，所以就直接c(continue)到user input的地方停下來，再看vmmap
:::spoiler vmmap</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span> Legend:  Code | Heap | Stack <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Start              End                Offset             Perm Path
</span></span><span style=display:flex><span>0x00007ffff7d84000 0x00007ffff7d87000 0x0000000000000000 rw-
</span></span><span style=display:flex><span>0x00007ffff7d87000 0x00007ffff7daf000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libc.so.6
</span></span><span style=display:flex><span>0x00007ffff7daf000 0x00007ffff7f44000 0x0000000000028000 r-x /usr/lib/x86_64-linux-gnu/libc.so.6
</span></span><span style=display:flex><span>0x00007ffff7f44000 0x00007ffff7f9c000 0x00000000001bd000 r-- /usr/lib/x86_64-linux-gnu/libc.so.6
</span></span><span style=display:flex><span>0x00007ffff7f9c000 0x00007ffff7fa0000 0x0000000000214000 r-- /usr/lib/x86_64-linux-gnu/libc.so.6
</span></span><span style=display:flex><span>0x00007ffff7fa0000 0x00007ffff7fa2000 0x0000000000218000 rw- /usr/lib/x86_64-linux-gnu/libc.so.6
</span></span><span style=display:flex><span>0x00007ffff7fa2000 0x00007ffff7faf000 0x0000000000000000 rw-
</span></span><span style=display:flex><span>0x00007ffff7fb3000 0x00007ffff7fb5000 0x0000000000000000 rw-
</span></span><span style=display:flex><span>0x00007ffff7fb5000 0x00007ffff7fb7000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span></span><span style=display:flex><span>0x00007ffff7fb7000 0x00007ffff7fe1000 0x0000000000002000 r-x /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span></span><span style=display:flex><span>0x00007ffff7fe1000 0x00007ffff7fec000 0x000000000002c000 r-- /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span></span><span style=display:flex><span>0x00007ffff7fec000 0x00007ffff7fed000 0x0000000000000000 ---
</span></span><span style=display:flex><span>0x00007ffff7fed000 0x00007ffff7fef000 0x0000000000037000 r-- /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span></span><span style=display:flex><span>0x00007ffff7fef000 0x00007ffff7ff1000 0x0000000000039000 rw- /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span></span><span style=display:flex><span>0x00007ffff7ff2000 0x00007ffff7ff6000 0x0000000000000000 r-- <span style=color:#f92672>[</span>vvar<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>0x00007ffff7ff6000 0x00007ffff7ff8000 0x0000000000000000 r-x <span style=color:#f92672>[</span>vdso<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>0x00007ffff7ff8000 0x00007ffff7ff9000 0x0000000000000000 r--
</span></span><span style=display:flex><span>0x00007ffff7ff9000 0x00007ffff7ffa000 0x0000000000000000 r-x
</span></span><span style=display:flex><span>0x00007ffff7ffa000 0x00007ffff7ffc000 0x0000000000000000 r--
</span></span><span style=display:flex><span>0x00007ffff7ffc000 0x00007ffff7ffd000 0x0000000000000000 rw-
</span></span><span style=display:flex><span>0x00007ffff7ffe000 0x00007ffff7fff000 0x0000000000000000 r-- /mnt/d/NTU/Second Year/Computer Security/Reverse/Lab3/Unpackme/unpackme
</span></span><span style=display:flex><span>0x00007ffff7fff000 0x00007ffff8020000 0x0000000000000000 rw- <span style=color:#f92672>[</span>heap<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>0x00007ffffffdd000 0x00007ffffffff000 0x0000000000000000 rw- <span style=color:#f92672>[</span>stack<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>:::
可以看到<code>0x00007ffff7ff8000</code>開始會有ELF的字樣，代表應該是他脫殼完的結果，我的作法是直接把<code>0x00007ffff7ff8000</code>~<code>0x00007ffff7ffd000</code>全部dump下來進行分析</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gef➤  x/s 0x00007ffff7ff8000
</span></span><span style=display:flex><span>0x7ffff7ff8000: <span style=color:#e6db74>&#34;\177ELF\002\001\001&#34;</span>
</span></span><span style=display:flex><span>gef➤  dump memory real_file 0x00007ffff7ff8000 0x00007ffff7ffd000
</span></span></code></pre></div></li><li><p>開始分析real_file，先用靜態看一下(如source code所示)
<img src=https://hackmd.io/_uploads/BylZUq7X6.png alt=圖片.png></p></li><li><p>找到我們要停的地方的offset$\to$<code>0x1213</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gef➤  x/10i 0x00007ffff7ff8000+0x1213
</span></span><span style=display:flex><span>   0x7ffff7ff9213:      mov    rcx,QWORD PTR <span style=color:#f92672>[</span>rip+0x2dfe<span style=color:#f92672>]</span>        <span style=color:#75715e># 0x7ffff7ffc018</span>
</span></span><span style=display:flex><span>   0x7ffff7ff921a:      lea    rax,<span style=color:#f92672>[</span>rbp-0x50<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   0x7ffff7ff921e:      mov    edx,0xa
</span></span><span style=display:flex><span>   0x7ffff7ff9223:      mov    rsi,rcx
</span></span><span style=display:flex><span>   0x7ffff7ff9226:      mov    rdi,rax
</span></span><span style=display:flex><span><span style=color:#f92672>=</span>&gt; 0x7ffff7ff9229:      call   0x7ffff7ff90c0
</span></span><span style=display:flex><span>   0x7ffff7ff922e:      test   eax,eax
</span></span><span style=display:flex><span>   0x7ffff7ff9230:      je     0x7ffff7ff924b
</span></span><span style=display:flex><span>   0x7ffff7ff9232:      lea    rax,<span style=color:#f92672>[</span>rip+0xe13<span style=color:#f92672>]</span>        <span style=color:#75715e># 0x7ffff7ffa04c</span>
</span></span><span style=display:flex><span>   0x7ffff7ff9239:      mov    rdi,rax
</span></span></code></pre></div><p>可以看到解析出來的assembly和IDA的差不多，代表我們找對地方</p></li><li><p>設定breakpoint後continue就可以在stack中看到key</p><pre tabindex=0><code>gef➤  b *(0x00007ffff7ff9000+0x229)
Breakpoint 1 at 0x7ffff7ff9229
gef➤  c
Continuing.
adjfl

Breakpoint 1, 0x00007ffff7ff9229 in ?? ()
</code></pre><pre tabindex=0><code class=language-────────────────────────────────────────────────────────────────────────────────────────── data-lang=──────────────────────────────────────────────────────────────────────────────────────────>0x7ffff7ff90c0 (
   $rdi = 0x00007fffffffd6c0 → 0x0000006c666a6461 (&#34;adjfl&#34;?),
   $rsi = 0x00007ffff7ffa030 → &#34;just_a_key&#34;,
   $rdx = 0x000000000000000a,
   $rcx = 0x00007ffff7ffa030 → &#34;just_a_key&#34;
)
</code></pre></li></ol><h2 id=exploit>Exploit
<a class=anchor href=#exploit>#</a></h2><p>key: <code>just_a_key</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./unpackme
</span></span><span style=display:flex><span>Enter input: just_a_key
</span></span><span style=display:flex><span>FLAG<span style=color:#f92672>{</span>just_4_simple_unpackme_challenge!<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Flag: <code>FLAG{just_4_simple_unpackme_challenge!}</code></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#source-code>Source code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit>Exploit</a></li></ul></nav></div></aside></main></body></html>