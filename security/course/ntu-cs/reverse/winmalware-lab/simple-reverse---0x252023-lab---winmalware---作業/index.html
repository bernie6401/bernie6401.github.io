<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Simple Reverse - 0x25(2023 Lab - WinMalware - 作業)
  #


  Description
  #


在 next stage payload 的 my_start 導出函數中，惡意程式透過 dynamic API resolution 手法取得了一些 APIs。請問其從 user32.dll 取得的 API 的名稱為何？
A list of all exported functions of user32.dll
Flag format: FLAG{WindowsAPIname}

  Background
  #

Dynamic API Resolution Background

  Recon
  #

根據前一個筆記，我們已經知道他怎麼找API，只是我們還不知道他用的到底是哪一個API，因為他有事先用過hash，題目也是要我們找到這一個部分，最簡單的做法是把user32.dll的所有API都用作者自定義的hash function做一遍，直到找到他要的那一個，目前問題最大的應該是不知道__ROL4__的意思，根據x86 and amd64 instruction reference

The rotate left (ROL) and rotate through carry left (RCL) instructions shift all the bits toward more-significant bit positions, except for the most-significant bit, which is rotated to the least-significant bit location. The rotate right (ROR) and rotate through carry right (RCR) instructions shift all the bits toward less significant bit positions, except for the least-significant bit, which is rotated to the most-significant bit location."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-cs/reverse/winmalware-lab/simple-reverse---0x252023-lab---winmalware---%E4%BD%9C%E6%A5%AD/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Simple Reverse - 0x25(2023 Lab - WinMalware - 作業)"><meta property="og:description" content="Simple Reverse - 0x25(2023 Lab - WinMalware - 作業) # Description # 在 next stage payload 的 my_start 導出函數中，惡意程式透過 dynamic API resolution 手法取得了一些 APIs。請問其從 user32.dll 取得的 API 的名稱為何？ A list of all exported functions of user32.dll
Flag format: FLAG{WindowsAPIname}
Background # Dynamic API Resolution Background
Recon # 根據前一個筆記，我們已經知道他怎麼找API，只是我們還不知道他用的到底是哪一個API，因為他有事先用過hash，題目也是要我們找到這一個部分，最簡單的做法是把user32.dll的所有API都用作者自定義的hash function做一遍，直到找到他要的那一個，目前問題最大的應該是不知道__ROL4__的意思，根據x86 and amd64 instruction reference
The rotate left (ROL) and rotate through carry left (RCL) instructions shift all the bits toward more-significant bit positions, except for the most-significant bit, which is rotated to the least-significant bit location. The rotate right (ROR) and rotate through carry right (RCR) instructions shift all the bits toward less significant bit positions, except for the least-significant bit, which is rotated to the most-significant bit location."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="Eductf"><meta property="article:tag" content="CTF"><meta property="article:tag" content="Reverse"><title>Simple Reverse - 0x25(2023 Lab - WinMalware - 作業) | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-cs/reverse/winmalware-lab/simple-reverse---0x252023-lab---winmalware---%E4%BD%9C%E6%A5%AD/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Simple Reverse - 0x25(2023 Lab - WinMalware - 作業)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#description>Description</a></li><li><a href=#background>Background</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit>Exploit</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=simple-reverse---0x252023-lab---winmalware---作業>Simple Reverse - 0x25(2023 Lab - WinMalware - 作業)
<a class=anchor href=#simple-reverse---0x252023-lab---winmalware---%e4%bd%9c%e6%a5%ad>#</a></h1><h2 id=description>Description
<a class=anchor href=#description>#</a></h2><blockquote><p>在 next stage payload 的 my_start 導出函數中，惡意程式透過 dynamic API resolution 手法取得了一些 APIs。請問其從 user32.dll 取得的 API 的名稱為何？
<a href=https://github.com/Mr-Un1k0d3r/WindowsDllsExport/blob/main/Win11-22000/user32.dll.txt>A list of all exported functions of user32.dll</a></p><p>Flag format: FLAG{WindowsAPIname}</p></blockquote><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p><a href=https://hackmd.io/@SBK6401/Bkd51XRM6>Dynamic API Resolution Background</a></p><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><p>根據前一個筆記，我們已經知道他怎麼找API，只是我們還不知道他用的到底是哪一個API，因為他有事先用過hash，題目也是要我們找到這一個部分，最簡單的做法是把user32.dll的所有API都用作者自定義的hash function做一遍，直到找到他要的那一個，目前問題最大的應該是不知道<code>__ROL4__</code>的意思，根據<a href=https://www.felixcloutier.com/x86/rcl:rcr:rol:ror>x86 and amd64 instruction reference</a></p><blockquote><p>The rotate left (ROL) and rotate through carry left (RCL) instructions shift all the bits toward more-significant bit positions, except for the most-significant bit, which is rotated to the least-significant bit location. The rotate right (ROR) and rotate through carry right (RCR) instructions shift all the bits toward less significant bit positions, except for the least-significant bit, which is rotated to the most-significant bit location.</p></blockquote><p>所以很明顯的，這一段就是把hash左移11次，然後加上1187和api_name的字元</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>api_name <span style=color:#f92672>=</span> dll_base <span style=color:#f92672>+</span> name_array[k];
</span></span><span style=display:flex><span>hash <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    hash <span style=color:#f92672>+=</span> __ROL4__(hash, <span style=color:#ae81ff>11</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1187</span> <span style=color:#f92672>+</span> <span style=color:#f92672>*</span>api_name<span style=color:#f92672>++</span>;<span style=color:#75715e>// do self-defined hash function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>while</span> ( <span style=color:#f92672>*</span>api_name );
</span></span></code></pre></div><h2 id=exploit>Exploit
<a class=anchor href=#exploit>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>kernel32_dll <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#39;./kernel32.dll.txt&#39;</span>, <span style=color:#e6db74>&#39;rb&#39;</span>)<span style=color:#f92672>.</span>readlines()
</span></span><span style=display:flex><span>msvcrt_dll <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#39;./msvcrt.dll.txt&#39;</span>, <span style=color:#e6db74>&#39;rb&#39;</span>)<span style=color:#f92672>.</span>readlines()
</span></span><span style=display:flex><span>user32_dll <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#39;./user32.dll.txt&#39;</span>, <span style=color:#e6db74>&#39;rb&#39;</span>)<span style=color:#f92672>.</span>readlines()
</span></span><span style=display:flex><span>kernel32_function_hash <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0x5F00766C</span>, <span style=color:#ae81ff>0x6D555364</span>, <span style=color:#ae81ff>0x42B4FA0</span>, <span style=color:#ae81ff>0xC473C85A</span>]
</span></span><span style=display:flex><span>msvcrt_function_hash <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xCD841E17</span>
</span></span><span style=display:flex><span>user32_function_hash <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x416f607</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__ROL4__</span>(v, b, bit_size):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (v <span style=color:#f92672>&lt;&lt;</span> b) <span style=color:#f92672>|</span> (v <span style=color:#f92672>&gt;&gt;</span> (bit_size <span style=color:#f92672>-</span> b)) <span style=color:#f92672>&amp;</span> (<span style=color:#ae81ff>2</span><span style=color:#f92672>**</span>(bit_size) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># kernel32 Function Hash Compare</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> function_hash <span style=color:#f92672>in</span> kernel32_function_hash:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(len(kernel32_dll)):
</span></span><span style=display:flex><span>        name <span style=color:#f92672>=</span> kernel32_dll[i]<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>        hash <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> j <span style=color:#f92672>in</span> range(len(name)):
</span></span><span style=display:flex><span>            hash <span style=color:#f92672>+=</span> __ROL4__(hash, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>32</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1187</span> <span style=color:#f92672>+</span> name[j]
</span></span><span style=display:flex><span>            hash <span style=color:#f92672>=</span> hash <span style=color:#f92672>&amp;</span> (<span style=color:#ae81ff>2</span><span style=color:#f92672>**</span>(<span style=color:#ae81ff>32</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> hash <span style=color:#f92672>==</span> function_hash:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#34;[+] kernel32 Function    - &#34;</span> <span style=color:#f92672>+</span> hex(function_hash) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; is &#34;</span> <span style=color:#f92672>+</span> name<span style=color:#f92672>.</span>decode())
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># msvcrt Function Hash Compare</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(len(msvcrt_dll)):
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> msvcrt_dll[i]<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>    hash <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> j <span style=color:#f92672>in</span> range(len(name)):
</span></span><span style=display:flex><span>        hash <span style=color:#f92672>+=</span> __ROL4__(hash, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>32</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1187</span> <span style=color:#f92672>+</span> name[j]
</span></span><span style=display:flex><span>        hash <span style=color:#f92672>=</span> hash <span style=color:#f92672>&amp;</span> (<span style=color:#ae81ff>2</span><span style=color:#f92672>**</span>(<span style=color:#ae81ff>32</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> hash <span style=color:#f92672>==</span> msvcrt_function_hash:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;[+] msvcrt Function      - &#34;</span> <span style=color:#f92672>+</span> hex(msvcrt_function_hash) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; is &#34;</span> <span style=color:#f92672>+</span> name<span style=color:#f92672>.</span>decode())
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># user32 Function Hash Compare</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(len(user32_dll)):
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> user32_dll[i]<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>    hash <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> j <span style=color:#f92672>in</span> range(len(name)):
</span></span><span style=display:flex><span>        hash <span style=color:#f92672>+=</span> __ROL4__(hash, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>32</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1187</span> <span style=color:#f92672>+</span> name[j]
</span></span><span style=display:flex><span>        hash <span style=color:#f92672>=</span> hash <span style=color:#f92672>&amp;</span> (<span style=color:#ae81ff>2</span><span style=color:#f92672>**</span>(<span style=color:#ae81ff>32</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> hash <span style=color:#f92672>==</span> user32_function_hash:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;[+] user32 Function      - &#34;</span> <span style=color:#f92672>+</span> hex(user32_function_hash) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; is &#34;</span> <span style=color:#f92672>+</span> name<span style=color:#f92672>.</span>decode())
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;Flag = FLAG{&#34;</span> <span style=color:#f92672>+</span> name<span style=color:#f92672>.</span>decode() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;}&#34;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python exp-lab-6.py
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> kernel32 Function    - 0x5f00766c is LoadLibraryA
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> kernel32 Function    - 0x6d555364 is GetProcAddress
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> kernel32 Function    - 0x42b4fa0 is VirtualAlloc
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> kernel32 Function    - 0xc473c85a is FlushInstructionCache
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> msvcrt Function      - 0xcd841e17 is memcpy
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> user32 Function      - 0x416f607 is MessageBoxA
</span></span><span style=display:flex><span>Flag <span style=color:#f92672>=</span> FLAG<span style=color:#f92672>{</span>MessageBoxA<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>結果如上</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#description>Description</a></li><li><a href=#background>Background</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit>Exploit</a></li></ul></nav></div></aside></main></body></html>