<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  Simple Reverse 0x11(Lab - Exception)
  #


  Background
  #

乘法、除法的運用 — 組合語言筆記
try-except 陳述式


EXCEPTION_CONTINUE_EXECUTION (-1) 例外狀況已關閉。 在例外狀況發生的位置繼續執行。
EXCEPTION_CONTINUE_SEARCH 無法辨識 (0) 例外狀況。 繼續搜尋處理常式的堆疊，先搜尋包含 try-except 語句，然後針對具有下一個最高優先順序的處理常式。
EXCEPTION_EXECUTE_HANDLER 辨識 (1) 例外狀況。 藉由執行 __except 複合陳述式將控制權傳送至例外狀況處理常式，然後在 區塊之後 __except 繼續執行。


  Source Code
  #

:::spoiler IDA Psuedo Code
int __cdecl main(int argc, const char **argv, const char **envp)
{
  char Str[112]; // [rsp+20h] [rbp+0h] BYREF
  int i; // [rsp+A0h] [rbp+80h]

  printf("Give me flag: ");
  scanf("%s", Str);
  if ( strlen(Str) == 38 )
  {
    for ( i = 0; i < 38; ++i )
    {
      if ( Str[i] != byte_14000A000[i] )
        goto LABEL_7;
    }
    puts("Correct :>");
  }
  else
  {
LABEL_7:
    puts("Wrong :<");
  }
  return 0;
}
:::'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-cs/reverse/simple-reverse---0x11lab---exception/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Simple Reverse 0x11(Lab - Exception)"><meta property="og:description" content='Simple Reverse 0x11(Lab - Exception) # Background # 乘法、除法的運用 — 組合語言筆記 try-except 陳述式
EXCEPTION_CONTINUE_EXECUTION (-1) 例外狀況已關閉。 在例外狀況發生的位置繼續執行。 EXCEPTION_CONTINUE_SEARCH 無法辨識 (0) 例外狀況。 繼續搜尋處理常式的堆疊，先搜尋包含 try-except 語句，然後針對具有下一個最高優先順序的處理常式。 EXCEPTION_EXECUTE_HANDLER 辨識 (1) 例外狀況。 藉由執行 __except 複合陳述式將控制權傳送至例外狀況處理常式，然後在 區塊之後 __except 繼續執行。 Source Code # :::spoiler IDA Psuedo Code
int __cdecl main(int argc, const char **argv, const char **envp) { char Str[112]; // [rsp+20h] [rbp+0h] BYREF int i; // [rsp+A0h] [rbp+80h] printf("Give me flag: "); scanf("%s", Str); if ( strlen(Str) == 38 ) { for ( i = 0; i < 38; ++i ) { if ( Str[i] != byte_14000A000[i] ) goto LABEL_7; } puts("Correct :>"); } else { LABEL_7: puts("Wrong :<"); } return 0; } :::'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="CTF"><meta property="article:tag" content="Reverse"><meta property="article:tag" content="Eductf"><title>Simple Reverse 0x11(Lab - Exception) | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-cs/reverse/simple-reverse---0x11lab---exception/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Simple Reverse 0x11(Lab - Exception)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#source-code>Source Code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit>Exploit</a></li><li><a href=#reference>Reference</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=simple-reverse-0x11lab---exception>Simple Reverse 0x11(Lab - Exception)
<a class=anchor href=#simple-reverse-0x11lab---exception>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p><a href=https://mycollegenotebook.medium.com/%E4%B9%98%E6%B3%95-%E9%99%A4%E6%B3%95%E7%9A%84%E9%81%8B%E7%94%A8-%E7%B5%84%E5%90%88%E8%AA%9E%E8%A8%80%E7%AD%86%E8%A8%98-638b1eac4696>乘法、除法的運用 — 組合語言筆記</a>
<a href="https://learn.microsoft.com/zh-tw/cpp/cpp/try-except-statement?view=msvc-170&amp;viewFallbackFrom=msvc-170%3Fns-enrollment-type%3DCollection&amp;ns-enrollment-id=rdg3b1j45ye486">try-except 陳述式</a></p><blockquote><ul><li>EXCEPTION_CONTINUE_EXECUTION (-1) 例外狀況已關閉。 在例外狀況發生的位置繼續執行。</li><li>EXCEPTION_CONTINUE_SEARCH 無法辨識 (0) 例外狀況。 繼續搜尋處理常式的堆疊，先搜尋包含 try-except 語句，然後針對具有下一個最高優先順序的處理常式。</li><li>EXCEPTION_EXECUTE_HANDLER 辨識 (1) 例外狀況。 藉由執行 __except 複合陳述式將控制權傳送至例外狀況處理常式，然後在 區塊之後 __except 繼續執行。</li></ul></blockquote><h2 id=source-code>Source Code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler IDA Psuedo Code</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#66d9ef>__cdecl</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>argv, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>envp)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> Str[<span style=color:#ae81ff>112</span>]; <span style=color:#75715e>// [rsp+20h] [rbp+0h] BYREF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> i; <span style=color:#75715e>// [rsp+A0h] [rbp+80h]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  printf(<span style=color:#e6db74>&#34;Give me flag: &#34;</span>);
</span></span><span style=display:flex><span>  scanf(<span style=color:#e6db74>&#34;%s&#34;</span>, Str);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( strlen(Str) <span style=color:#f92672>==</span> <span style=color:#ae81ff>38</span> )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> ( i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>38</span>; <span style=color:#f92672>++</span>i )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> ( Str[i] <span style=color:#f92672>!=</span> byte_14000A000[i] )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>goto</span> LABEL_7;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    puts(<span style=color:#e6db74>&#34;Correct :&gt;&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>LABEL_7:
</span></span><span style=display:flex><span>    puts(<span style=color:#e6db74>&#34;Wrong :&lt;&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>:::</p><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><p>這一題真的頗複雜(應該也還好&mldr;)，但有一些陷阱和套路，這一題是有關於exception的結構分析</p><p>詳細解析Exception的結構，請看<a href="https://www.youtube.com/live/4-hgyiCV3ZA?feature=share&amp;t=1507">課程影片</a></p><ol><li><p>透過上課教的方式找到Exception Handler Address
有兩種方式</p><ul><li><p>看PE-Bear</p><ul><li>首先我們先看IDA反組譯的psuedo code發現和原始的組語有一些出入(反黃的地方)，代表有一些地方沒有翻出來，此時我們就可以先分析一下是不是有甚麼問題，發現在<code>15DE</code>的地方有個除法，且除數是零，代表一定會發生exception
<img src=https://hackmd.io/_uploads/BkCEpelKn.png alt></li><li>此時就可以用PE-Bear看一下相關的資訊，首先<code>15DE</code>是包含在<code>1590-1748</code>的Scope，所以要找的unwind address就是<code>9750</code>
<img src=https://hackmd.io/_uploads/H1UfyWxtn.png alt></li><li>實際來到<code>9750</code>就會像下圖一樣，但基本上還是需要自己create structure並且手動輸入offset
<img src=https://hackmd.io/_uploads/ryWskWlY2.png alt></li></ul></li><li><p>從xref main function去找</p><ul><li>首先在IDA中找到main function，用XRef的方式找到其他呼叫main function的地方，再跟進去，基本上後面的address跟進去就會是跟上面的地方一樣，這個方法有可能會失敗
<img src=https://hackmd.io/_uploads/BkGYeblYh.png alt></li></ul></li></ul></li><li><p>分析整體的exception handler
看了一下code發現有兩個地方會跳exception，一個是前面提到的==15DE==，另外一個是<code>1660</code>，看了一下三個handler的exception return value<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>，發現分別是<code>0, 1, -1</code>，所以可以先稍微用肉眼跟一下會發生甚麼事
當exception 1發生時，會先看第一條scope發現雖然在範圍內可是return value是零，代表無法辨識要繼續搜尋，可以看到符合第二條scope的範圍且return value是1，此時就會直接跳到==161D==。而當第二個exception發生時，是在==1660==，只有符合第三條指令，但return value是-1，代表他會回復原始的狀態並跳到下一個RIP</p><pre tabindex=0><code>SCOPE_RECORD &lt;rva loc_1400015D5, rva loc_1400015E2, rva sub_140006170, rva loc_1400015E2&gt;
SCOPE_RECORD &lt;rva loc_1400015D5, rva loc_14000161D, rva sub_140006183, rva loc_14000161D&gt;
SCOPE_RECORD &lt;rva loc_140001657, rva loc_140001664, rva sub_140006199, rva loc_140001664&gt;
</code></pre></li><li><p>用x64dbg看一下整體的流程</p><ul><li>首先第一個exception正如我們所說，跳到==161D==，並做一些操作，這邊就要很仔細分析，明顯看到他會跳過一段不重要的code，然後在<code>1626-1654</code>的地方形成一個for-loop，主要的操作是把我們輸入的flag和一個東西做XOR，這個東西實際上去看就是<code>0xBE, 0xBF, 0xC0, 0xC1,...,0xE3</code>(共38個連續數值)。
<img src=https://hackmd.io/_uploads/Sy_UvWgK3.png alt></li><li>For-loop結束後就會遇到第二個exception，但實際跟上去後會發現它不是跳到我們預期的RIP而是跳到<code>169F</code>(不是很清楚為甚麼會這樣)，所以如果盲目的分析中間的第二個loop其實就是浪費時間，因為根本不會執行到，而這一段for-loop在做的事情就是把剛剛第一個exception處理完的結果和一些data相加然後取低位byte，而那些data實際跟上去會是<code>0xEF, 0xF0, 0xF1,...,0xFF, 0x00, 0x01,...,0x14</code>，這裡非常重要，因為0xFF再上去不是0x100而是一樣取低位byte，變成從零開始
<img src=https://hackmd.io/_uploads/B1DRuWxK3.png alt></li><li>==2023/07/03更新：==
經過助教的說明，已經知道為甚麼他會跳到<code>169F</code>，可以看一下上課講義中提到的<code>_C_specific_handler</code>，就在<code>975C</code>，用IDA跟進去看一下發現他在呼叫<code>_C_specific_handler</code>之前有做了一些操作，他把context的RIP改掉了，有一點hook的感覺，原本exception 2發生時要回去的地方應該是<code>1660</code>但加上<code>0x3F</code>之後就變成<code>169F</code>，和我們實際跑的結果相符合
:::spoiler 上課講義
<img src=https://hackmd.io/_uploads/HyiTqrxYh.png alt>
:::
:::spoiler 額外操作
<img src=https://hackmd.io/_uploads/ryIUoSlYn.png alt>
:::</li><li>上述兩個exception做完之後就會直接和encrypted flag進行比對，所以我們要做的事情就是倒過來執行這些東西(encrypted flag - <code>0xEF,...,0x14</code> + <code>0x100</code>) ^ <code>(0xBE, 0xBF, 0xC0, 0xC1,...,0xE3</code>) = FLAG</li></ul></li></ol><h2 id=exploit>Exploit
<a class=anchor href=#exploit>#</a></h2><pre tabindex=0><code class="language-python=" data-lang="python=">first_for_loop = [190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224, 225, 226, 227]

second_for_loop = [239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]

enc_flag = [0xE7, 0xE3, 0x72, 0x78, 0xAC, 0x90, 0x90, 0x7C, 0x90, 0xAC, 0xB1, 0xA6, 0xA4, 0x9E, 0xA7, 0xA2, 0xAC, 0x90, 0xB9, 0xB2, 0xBF, 0xBB, 0xBD, 0xB6, 0xAB, 0x90, 0xBA, 0xB4, 0x90, 0xBF, 0xC0, 0xC0, 0xC4, 0xCA, 0x95, 0xED, 0xC0, 0xB2]


FLAG = []

for i in range(38):
    # print(hex(flag[i] ^ enc_flag[i])[2:], end=&#34;&#34;)

    if enc_flag[i] - second_for_loop[i] &lt; 0:
        tmp = hex(first_for_loop[i] ^ (enc_flag[i] - second_for_loop[i] + 0x100))[2:]
    else:
        tmp = hex(first_for_loop[i] ^ (enc_flag[i] - second_for_loop[i]))[2:]


    FLAG.append(bytes.fromhex(tmp).decode(&#39;cp437&#39;))

print(&#34;&#34;.join(FLAG))
</code></pre><p>Flag: <code>FLAG{__C_specific_handler_is_hooked:O}</code></p><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href="https://learn.microsoft.com/zh-tw/cpp/cpp/try-except-statement?view=msvc-170&amp;viewFallbackFrom=msvc-170%3Fns-enrollment-type%3DCollection&amp;ns-enrollment-id=rdg3b1j45ye486">try-except 陳述式</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#source-code>Source Code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit>Exploit</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside></main></body></html>