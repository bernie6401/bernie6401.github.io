<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  Simple PWN 0x21(fopen, fread, fwrite, fclose)
  #


  tags: CTF PWN eductf
  #

Version: Ubuntu 20.04

  Original Code
  #

:::spoiler fopen
#include <fcntl.h>
#include <stdio.h>

int main()
{
    FILE *fp;
    fp = fopen("./test", "r");
    fclose(fp);

    return 0;
}
:::
:::spoiler fread
#include <fcntl.h>
#include <stdio.h>

int main()
{
    FILE *fp;
    char buf[0x10];

    fp = fopen("./test", "r");
    fread(buf, 0x1, 0x10, fp);
    fclose(fp);

    return 0;
}
:::
:::spoiler fwrite
#include <fcntl.h>
#include <stdio.h>

int main()
{
    FILE *fp;
    char buf[0x10] = "TEST!!";

    fp = fopen("./test_write", "r");
    fread(buf, 0x1, 0x10, fp);
    fclose(fp);

    return 0;
}
:::'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-pwn-0x21fopen-fread-fwrite-fclose/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Simple PWN 0x21(fopen, fread, fwrite, fclose)"><meta property="og:description" content='Simple PWN 0x21(fopen, fread, fwrite, fclose) # tags: CTF PWN eductf # Version: Ubuntu 20.04
Original Code # :::spoiler fopen
#include <fcntl.h> #include <stdio.h> int main() { FILE *fp; fp = fopen("./test", "r"); fclose(fp); return 0; } :::
:::spoiler fread
#include <fcntl.h> #include <stdio.h> int main() { FILE *fp; char buf[0x10]; fp = fopen("./test", "r"); fread(buf, 0x1, 0x10, fp); fclose(fp); return 0; } :::
:::spoiler fwrite
#include <fcntl.h> #include <stdio.h> int main() { FILE *fp; char buf[0x10] = "TEST!!"; fp = fopen("./test_write", "r"); fread(buf, 0x1, 0x10, fp); fclose(fp); return 0; } :::'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="CTF"><meta property="article:tag" content="PWN"><meta property="article:tag" content="Eductf"><title>Simple PWN 0x21(fopen, fread, fwrite, fclose) | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-pwn-0x21fopen-fread-fwrite-fclose/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Simple PWN 0x21(fopen, fread, fwrite, fclose)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#original-code>Original Code</a></li><li><a href=#analyze>Analyze</a><ul><li><a href=#fopen>fopen</a></li><li><a href=#fread>fread</a></li><li><a href=#fwrite>fwrite</a></li><li><a href=#fclose>fclose</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=simple-pwn-0x21fopen-fread-fwrite-fclose>Simple PWN 0x21(fopen, fread, fwrite, fclose)
<a class=anchor href=#simple-pwn-0x21fopen-fread-fwrite-fclose>#</a></h1><h6 id=tags-ctf-pwn-eductf>tags: <code>CTF</code> <code>PWN</code> <code>eductf</code>
<a class=anchor href=#tags-ctf-pwn-eductf>#</a></h6><p>Version: Ubuntu 20.04</p><h2 id=original-code>Original Code
<a class=anchor href=#original-code>#</a></h2><p>:::spoiler fopen</p><pre tabindex=0><code class="language-cpp=" data-lang="cpp=">#include &lt;fcntl.h&gt;
#include &lt;stdio.h&gt;

int main()
{
    FILE *fp;
    fp = fopen(&#34;./test&#34;, &#34;r&#34;);
    fclose(fp);

    return 0;
}
</code></pre><p>:::</p><p>:::spoiler fread</p><pre tabindex=0><code class="language-cpp=" data-lang="cpp=">#include &lt;fcntl.h&gt;
#include &lt;stdio.h&gt;

int main()
{
    FILE *fp;
    char buf[0x10];

    fp = fopen(&#34;./test&#34;, &#34;r&#34;);
    fread(buf, 0x1, 0x10, fp);
    fclose(fp);

    return 0;
}
</code></pre><p>:::</p><p>:::spoiler fwrite</p><pre tabindex=0><code class="language-cpp=" data-lang="cpp=">#include &lt;fcntl.h&gt;
#include &lt;stdio.h&gt;

int main()
{
    FILE *fp;
    char buf[0x10] = &#34;TEST!!&#34;;

    fp = fopen(&#34;./test_write&#34;, &#34;r&#34;);
    fread(buf, 0x1, 0x10, fp);
    fclose(fp);

    return 0;
}
</code></pre><p>:::</p><p>:::spoiler fclose</p><pre tabindex=0><code class="language-cpp=" data-lang="cpp="></code></pre><p>:::</p><h2 id=analyze>Analyze
<a class=anchor href=#analyze>#</a></h2><h3 id=fopen>fopen
<a class=anchor href=#fopen>#</a></h3><ul><li>Flow chart
<img src=https://i.imgur.com/CZgCWFL.png alt></li></ul><ol><li><code>fopen</code> - main()<pre tabindex=0><code class=language-baah! data-lang=baah!>...
&lt;main+26&gt;    call   fopen@plt    &lt;fopen@plt&gt;
pwndbg&gt; si
</code></pre></li><li><code>malloc</code> - <code>iofopen.c</code><pre tabindex=0><code class=language-bash! data-lang=bash!>&lt;__fopen_internal+26&gt;    call   malloc@plt	&lt;malloc@plt&gt; # Size: 0x1d8
pwndbg&gt; heap
...
Allocated chunk | PREV_INUSE
Addr: 0x555555559290
Size: 0x1e1
...
</code></pre>:::spoiler <code>new_f</code><pre tabindex=0><code class=language-bash! data-lang=bash!>pwndbg&gt; p *new_f
$2 = {
  fp = {
    file = {
      _flags = 0,
      _IO_read_ptr = 0x0,
      _IO_read_end = 0x0,
      _IO_read_base = 0x0,
      _IO_write_base = 0x0,
      _IO_write_ptr = 0x0,
      _IO_write_end = 0x0,
      _IO_buf_base = 0x0,
      _IO_buf_end = 0x0,
      _IO_save_base = 0x0,
      _IO_backup_base = 0x0,
      _IO_save_end = 0x0,
      _markers = 0x0,
      _chain = 0x0,
      _fileno = 0,
      _flags2 = 0,
      _old_offset = 0,
      _cur_column = 0,
      _vtable_offset = 0 &#39;\000&#39;,
      _shortbuf = &#34;&#34;,
      _lock = 0x0,
      _offset = 0,
      _codecvt = 0x0,
      _wide_data = 0x0,
      _freeres_list = 0x0,
      _freeres_buf = 0x0,
      __pad5 = 0,
      _mode = 0,
      _unused2 = &#39;\000&#39; &lt;repeats 19 times&gt;
    },
    vtable = 0x0
  },
  lock = {
    lock = 0,
    cnt = 0,
    owner = 0x0
  },
  wd = {
    _IO_read_ptr = 0x0,
    _IO_read_end = 0x0,
    _IO_read_base = 0x0,
    _IO_write_base = 0x0,
    _IO_write_ptr = 0x0,
    _IO_write_end = 0x0,
    _IO_buf_base = 0x0,
    _IO_buf_end = 0x0,
    _IO_save_base = 0x0,
    _IO_backup_base = 0x0,
    _IO_save_end = 0x0,
    _IO_state = {
      __count = 0,
      __value = {
        __wch = 0,
        __wchb = &#34;\000\000\000&#34;
      }
    },
    _IO_last_state = {
      __count = 0,
      __value = {
        __wch = 0,
        __wchb = &#34;\000\000\000&#34;
      }
    },
    _codecvt = {
      __cd_in = {
        step = 0x0,
        step_data = {
          __outbuf = 0x0,
          __outbufend = 0x0,
          __flags = 0,
          __invocation_counter = 0,
          __internal_use = 0,
          __statep = 0x0,
          __state = {
            __count = 0,
            __value = {
              __wch = 0,
              __wchb = &#34;\000\000\000&#34;
            }
          }
        }
      },
      __cd_out = {
        step = 0x0,
        step_data = {
          __outbuf = 0x0,
          __outbufend = 0x0,
          __flags = 0,
          __invocation_counter = 0,
          __internal_use = 0,
          __statep = 0x0,
          __state = {
            __count = 0,
            __value = {
              __wch = 0,
              __wchb = &#34;\000\000\000&#34;
            }
          }
        }
      }
    },
    _shortbuf = L&#34;&#34;,
    _wide_vtable = 0x0
  }
}
</code></pre>:::</li><li>Initialize - <code>iofopen.c</code><pre tabindex=0><code class=language-cpp! data-lang=cpp!>...
_IO_no_init (&amp;new_f-&gt;fp.file, 0, 0, &amp;new_f-&gt;wd, &amp;_IO_wfile_jumps);
_IO_JUMPS (&amp;new_f-&gt;fp) = &amp;_IO_file_jumps;
_IO_new_file_init_internal (&amp;new_f-&gt;fp);
...
</code></pre>:::spoiler <code>_IO_file_jumps</code><pre tabindex=0><code class=language-bash! data-lang=bash!>pwndbg&gt; p _IO_file_jumps
$3 = {
  __dummy = 0,
  __dummy2 = 0,
  __finish = 0x7ffff7e87ff0 &lt;_IO_new_file_finish&gt;,
  __overflow = 0x7ffff7e88a00 &lt;_IO_new_file_overflow&gt;,
  __underflow = 0x7ffff7e886b0 &lt;_IO_new_file_underflow&gt;,
  __uflow = 0x7ffff7e899c0 &lt;__GI__IO_default_uflow&gt;,
  __pbackfail = 0x7ffff7e8ad40 &lt;__GI__IO_default_pbackfail&gt;,
  __xsputn = 0x7ffff7e87be0 &lt;_IO_new_file_xsputn&gt;,
  __xsgetn = 0x7ffff7e877a0 &lt;__GI__IO_file_xsgetn&gt;,
  __seekoff = 0x7ffff7e87010 &lt;_IO_new_file_seekoff&gt;,
  __seekpos = 0x7ffff7e89d60 &lt;_IO_default_seekpos&gt;,
  __setbuf = 0x7ffff7e868f0 &lt;_IO_new_file_setbuf&gt;,
  __sync = 0x7ffff7e86780 &lt;_IO_new_file_sync&gt;,
  __doallocate = 0x7ffff7e7b3b0 &lt;__GI__IO_file_doallocate&gt;,
  __read = 0x7ffff7e87bb0 &lt;__GI__IO_file_read&gt;,
  __write = 0x7ffff7e875f0 &lt;_IO_new_file_write&gt;,
  __seek = 0x7ffff7e86d70 &lt;__GI__IO_file_seek&gt;,
  __close = 0x7ffff7e868e0 &lt;__GI__IO_file_close&gt;,
  __stat = 0x7ffff7e875d0 &lt;__GI__IO_file_stat&gt;,
  __showmanyc = 0x7ffff7e8aed0 &lt;_IO_default_showmanyc&gt;,
  __imbue = 0x7ffff7e8aee0 &lt;_IO_default_imbue&gt;
}
</code></pre>:::<ul><li>parse mode in <a href=https://elixir.bootlin.com/glibc/glibc-2.31/source/libio/fileops.c><code>fileops.c</code> - <code>_IO_new_file_fopen()</code></a></li></ul></li><li><code>__GI__IO_file_fopen</code> - <code>iofopen.c</code><pre tabindex=0><code class=language-bash! data-lang=bash!>...
&lt;__fopen_internal+120&gt;             call   __GI__IO_file_fopen	&lt;__GI__IO_file_fopen&gt;
	rdi: 0x5555555592a0 ◂— 0xfbad248c
    rsi: 0x555555556006 ◂— 0x747365742f2e /* &#39;./test&#39; */
    rdx: 0x555555556004 ◂— 0x747365742f2e0072 /* &#39;r&#39; */
    rcx: 0x1
</code></pre></li><li><code>_IO_file_open</code> - <code>fileops.c</code><pre tabindex=0><code class=language-bash! data-lang=bash!>&lt;__GI__IO_file_fopen+188&gt;    call   _IO_file_open	&lt;_IO_file_open&gt;
    rdi: 0x5555555592a0 ◂— 0xfbad248c
    rsi: 0x555555556006 ◂— 0x747365742f2e /* &#39;./test&#39; */
    rdx: 0x0
    rcx: 0x1b6
</code></pre></li><li><code>sys_open</code> - <code>open64.c</code><pre tabindex=0><code class=language-bash! data-lang=bash!>&lt;_IO_file_open+33&gt;    call   open64	&lt;open64&gt;	# It&#39;ll return file number(fd)
    file: 0x555555556006 ◂— 0x747365742f2e /* &#39;./test&#39; */
    oflag: 0x0 	# read only mode
    vararg: 0x1b6
    ...
    &lt;open64+73&gt;    syscall  &lt;SYS_openat&gt;
        fd: 0xffffff9c
        file: 0x555555556006 ◂— 0x747365742f2e /* &#39;./test&#39; */
        oflag: 0x0
        vararg: 0x0
</code></pre></li></ol><ul><li>Whole work flow
:::spoiler work flow<pre tabindex=0><code class=language-bash! data-lang=bash!>&lt;main+26&gt;    call   fopen@plt	&lt;fopen@plt&gt;
    ...
    &lt;__fopen_internal+26&gt;    call   malloc@plt	&lt;malloc@plt&gt;
        size: 0x1d8
    ...
    &lt;__fopen_internal+81&gt;    call   _IO_no_init	&lt;_IO_no_init&gt;
    ...
    &lt;__fopen_internal+103&gt;    call   _IO_new_file_init_internal	&lt;_IO_new_file_init_internal&gt;
        rdi: 0x5555555592a0 ◂— 0xfbad0000
        ...
        &lt;_IO_new_file_init_internal+25&gt;    call   _IO_link_in	&lt;_IO_link_in&gt;
            rdi: 0x5555555592a0 ◂— 0xfbad240c
            rsi: 0xfbad0000
            rdx: 0x0
            rcx: 0x555555559390 ◂— 0x0
        ...
    &lt;__fopen_internal+120&gt;             call   __GI__IO_file_fopen	&lt;__GI__IO_file_fopen&gt;
        rdi: 0x5555555592a0 ◂— 0xfbad248c
        rsi: 0x555555556006 ◂— 0x747365742f2e /* &#39;./test&#39; */
        rdx: 0x555555556004 ◂— 0x747365742f2e0072 /* &#39;r&#39; */
        rcx: 0x1
        ...
    &lt;__GI__IO_file_fopen+188&gt;    call   _IO_file_open	&lt;_IO_file_open&gt;
        rdi: 0x5555555592a0 ◂— 0xfbad248c
        rsi: 0x555555556006 ◂— 0x747365742f2e /* &#39;./test&#39; */
        rdx: 0x0
        rcx: 0x1b6
            ...
            &lt;_IO_file_open+33&gt;    call   open64	&lt;open64&gt;	# It&#39;ll return file number(fd)
                file: 0x555555556006 ◂— 0x747365742f2e /* &#39;./test&#39; */
                oflag: 0x0 	# read only mode
                vararg: 0x1b6
                ...
                &lt;open64+73&gt;    syscall  &lt;SYS_openat&gt;
                    fd: 0xffffff9c
                    file: 0x555555556006 ◂— 0x747365742f2e /* &#39;./test&#39; */
                    oflag: 0x0
                    vararg: 0x0
</code></pre>:::
:::spoiler <code>*fp</code><pre tabindex=0><code class=language-bash! data-lang=bash!>pwndbg&gt; p *fp
$4 = {
  _flags = -72539000,
  _IO_read_ptr = 0x0,
  _IO_read_end = 0x0,
  _IO_read_base = 0x0,
  _IO_write_base = 0x0,
  _IO_write_ptr = 0x0,
  _IO_write_end = 0x0,
  _IO_buf_base = 0x0,
  _IO_buf_end = 0x0,
  _IO_save_base = 0x0,
  _IO_backup_base = 0x0,
  _IO_save_end = 0x0,
  _markers = 0x0,
  _chain = 0x7ffff7fc45c0 &lt;_IO_2_1_stderr_&gt;,
  _fileno = 3,
  _flags2 = 0,
  _old_offset = 0,
  _cur_column = 0,
  _vtable_offset = 0 &#39;\000&#39;,
  _shortbuf = &#34;&#34;,
  _lock = 0x555555559380,
  _offset = -1,
  _codecvt = 0x0,
  _wide_data = 0x555555559390,
  _freeres_list = 0x0,
  _freeres_buf = 0x0,
  __pad5 = 0,
  _mode = 0,
  _unused2 = &#39;\000&#39; &lt;repeats 19 times&gt;
}
</code></pre>:::</li></ul><h3 id=fread>fread
<a class=anchor href=#fread>#</a></h3><ul><li>Flow chart
<img src=https://i.imgur.com/gESVUEE.png alt></li></ul><h3 id=fwrite>fwrite
<a class=anchor href=#fwrite>#</a></h3><ul><li>Flow chart
<img src=https://i.imgur.com/IF94XNU.png alt></li></ul><h3 id=fclose>fclose
<a class=anchor href=#fclose>#</a></h3><ul><li>Flow chart
<img src=https://i.imgur.com/nOpUw3e.png alt></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#original-code>Original Code</a></li><li><a href=#analyze>Analyze</a><ul><li><a href=#fopen>fopen</a></li><li><a href=#fread>fread</a></li><li><a href=#fwrite>fwrite</a></li><li><a href=#fclose>fclose</a></li></ul></li></ul></nav></div></aside></main></body></html>