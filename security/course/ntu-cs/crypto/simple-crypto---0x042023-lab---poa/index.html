<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  Simple Crypto - 0x04(2023 Lab - POA)
  #


  Background
  #

 Crypto I - Timmy

  Source Code
  #

:::spoiler Source Code
#! /usr/bin/python3
from Crypto.Cipher import AES
import os

from secret import FLAG

def pad(data, block_size):
    data += bytes([0x80] + [0x00] * (15 - len(data) % block_size))
    return data
# padding style: <oooooo[0x80][0x00]...[0x00]> (find first [0x80])

def unpad(data, block_size):
    if len(data) % block_size:
        raise ValueError

    padding_len = 0
    for i in range(1, len(data) + 1):
        if data[-i] == 0x80:
            padding_len = i
            break
        elif data[-i] != 0x00:
            raise ValueError
    else:
        raise ValueError

    return data[:-padding_len]

key = os.urandom(16)
cipher = AES.new(key, AES.MODE_CBC)
ct = cipher.encrypt(pad(FLAG, AES.block_size))
iv = cipher.iv
print((iv + ct).hex())

# same encryption

while True:
    try:
        inp = bytes.fromhex(input().strip()) # hex style input
        iv, ct = inp[:16], inp[16:] # get first 16 bytes from input 
        cipher = AES.new(key, AES.MODE_CBC, iv) 
        pt = unpad(cipher.decrypt(ct), AES.block_size)
        print("Well received :)")
    except ValueError:
        print("Something went wrong :(")
:::'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-cs/crypto/simple-crypto---0x042023-lab---poa/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Simple Crypto - 0x04(2023 Lab - POA)"><meta property="og:description" content='Simple Crypto - 0x04(2023 Lab - POA) # Background # Crypto I - Timmy
Source Code # :::spoiler Source Code
#! /usr/bin/python3 from Crypto.Cipher import AES import os from secret import FLAG def pad(data, block_size): data += bytes([0x80] + [0x00] * (15 - len(data) % block_size)) return data # padding style: <oooooo[0x80][0x00]...[0x00]> (find first [0x80]) def unpad(data, block_size): if len(data) % block_size: raise ValueError padding_len = 0 for i in range(1, len(data) + 1): if data[-i] == 0x80: padding_len = i break elif data[-i] != 0x00: raise ValueError else: raise ValueError return data[:-padding_len] key = os.urandom(16) cipher = AES.new(key, AES.MODE_CBC) ct = cipher.encrypt(pad(FLAG, AES.block_size)) iv = cipher.iv print((iv + ct).hex()) # same encryption while True: try: inp = bytes.fromhex(input().strip()) # hex style input iv, ct = inp[:16], inp[16:] # get first 16 bytes from input cipher = AES.new(key, AES.MODE_CBC, iv) pt = unpad(cipher.decrypt(ct), AES.block_size) print("Well received :)") except ValueError: print("Something went wrong :(") :::'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="CTF"><meta property="article:tag" content="Crypto"><meta property="article:tag" content="Eductf"><title>Simple Crypto - 0x04(2023 Lab - POA) | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-cs/crypto/simple-crypto---0x042023-lab---poa/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Simple Crypto - 0x04(2023 Lab - POA)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#source-code>Source Code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit>Exploit</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=simple-crypto---0x042023-lab---poa>Simple Crypto - 0x04(2023 Lab - POA)
<a class=anchor href=#simple-crypto---0x042023-lab---poa>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p><a href="https://youtu.be/dYyNeMeDM20?si=BEvBPBzCsg8oWv_Q&amp;t=8317">Crypto I - Timmy</a></p><h2 id=source-code>Source Code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler Source Code</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#! /usr/bin/python3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> Crypto.Cipher <span style=color:#f92672>import</span> AES
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> secret <span style=color:#f92672>import</span> FLAG
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>pad</span>(data, block_size):
</span></span><span style=display:flex><span>    data <span style=color:#f92672>+=</span> bytes([<span style=color:#ae81ff>0x80</span>] <span style=color:#f92672>+</span> [<span style=color:#ae81ff>0x00</span>] <span style=color:#f92672>*</span> (<span style=color:#ae81ff>15</span> <span style=color:#f92672>-</span> len(data) <span style=color:#f92672>%</span> block_size))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> data
</span></span><span style=display:flex><span><span style=color:#75715e># padding style: &lt;oooooo[0x80][0x00]...[0x00]&gt; (find first [0x80])</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>unpad</span>(data, block_size):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(data) <span style=color:#f92672>%</span> block_size:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    padding_len <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>1</span>, len(data) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> data[<span style=color:#f92672>-</span>i] <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x80</span>:
</span></span><span style=display:flex><span>            padding_len <span style=color:#f92672>=</span> i
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> data[<span style=color:#f92672>-</span>i] <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0x00</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> data[:<span style=color:#f92672>-</span>padding_len]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>urandom(<span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>cipher <span style=color:#f92672>=</span> AES<span style=color:#f92672>.</span>new(key, AES<span style=color:#f92672>.</span>MODE_CBC)
</span></span><span style=display:flex><span>ct <span style=color:#f92672>=</span> cipher<span style=color:#f92672>.</span>encrypt(pad(FLAG, AES<span style=color:#f92672>.</span>block_size))
</span></span><span style=display:flex><span>iv <span style=color:#f92672>=</span> cipher<span style=color:#f92672>.</span>iv
</span></span><span style=display:flex><span>print((iv <span style=color:#f92672>+</span> ct)<span style=color:#f92672>.</span>hex())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># same encryption</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        inp <span style=color:#f92672>=</span> bytes<span style=color:#f92672>.</span>fromhex(input()<span style=color:#f92672>.</span>strip()) <span style=color:#75715e># hex style input</span>
</span></span><span style=display:flex><span>        iv, ct <span style=color:#f92672>=</span> inp[:<span style=color:#ae81ff>16</span>], inp[<span style=color:#ae81ff>16</span>:] <span style=color:#75715e># get first 16 bytes from input </span>
</span></span><span style=display:flex><span>        cipher <span style=color:#f92672>=</span> AES<span style=color:#f92672>.</span>new(key, AES<span style=color:#f92672>.</span>MODE_CBC, iv) 
</span></span><span style=display:flex><span>        pt <span style=color:#f92672>=</span> unpad(cipher<span style=color:#f92672>.</span>decrypt(ct), AES<span style=color:#f92672>.</span>block_size)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Well received :)&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>ValueError</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Something went wrong :(&#34;</span>)
</span></span></code></pre></div><p>:::</p><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><p>這一題是簡單的padding oracle attack，他一樣是應用在CBC mode上，只是他padding的方式和上課教的有一點不一樣，他會先在最後放一個0x80然後接續放0x00直到長度%16==0，同樣的，我們可以用上課教的方式:</p><ul><li>What we have: 我們有的東西就是密文，所以可以利用它動一些手腳</li><li>Our Goal 1: 目標是要取得原本和47進行XOR的數字是多少</li><li>Our Goal 2: 這樣才可以取得最後的明文69
<img src=https://hackmd.io/_uploads/r1p3yoGlp.png alt></li><li>How to achieve: 我們可以簡單猜一個byte，從0x00開始，把密文換成猜測的byte，這樣256種組合和原本的Goal 1所求的byte進行XOR後會padding正確(也就是0x01)，此時假設我們已經猜到目前是0x2f符合padding正確的目標，代表現在的假明文是0x01，則原本和0x47進行XOR的數字就是0x01⊕0x2f，然後我們就可以回到原本解密的流程，也就是原本的密文0x47⊕剛剛得知的(0x01⊕0x2f)，就會得到想要的正確的明文0x69
<img src=https://hackmd.io/_uploads/H1yKboMlp.png alt></li></ul><p>所以套用到今天的lab意思也是一樣，如果要知道padding是否正確可以問oracle，反正只要符合明文+0x80+(0&mldr;15)*0x00，這一題的flag長度可以從題目給的ciphertext看出來，顯然扣掉16bytes的initial vector後，flag的長度是32 bytes，也就是說我們從第二個block開始解，我們可以單獨把第一個ciphertext block當成第二個ciphertext block的initial vector，合併後再一起送出去，然後不斷變化IV的最後一個byte，如果oracle回傳<code>Well received :)</code>代表第一個bytes猜對了，我們就可以把flag的最後一個bytes求出來$\to$我們猜的byte⊕原本ciphertext的最後一個byte⊕0x80(0x80是我們判斷padding正確的依據)，當然找到真正的plaintext byte後要把我們猜測的block恢復原狀，接著繼續找下一個byte</p><h2 id=exploit>Exploit
<a class=anchor href=#exploit>#</a></h2><p>:::spoiler Whole Exploit Script</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> tqdm <span style=color:#f92672>import</span> trange
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#39;edu-ctf.zoolab.org&#39;</span>,<span style=color:#ae81ff>10004</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># p = process([&#39;python&#39;, &#39;./POA_4af88990ab364609.py&#39;])</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ct <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span>readline()[:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]<span style=color:#f92672>.</span>decode()
</span></span><span style=display:flex><span>ct <span style=color:#f92672>=</span> bytes<span style=color:#f92672>.</span>fromhex(ct)
</span></span><span style=display:flex><span>iv, ct1, ct2 <span style=color:#f92672>=</span> ct[:<span style=color:#ae81ff>16</span>], ct[<span style=color:#ae81ff>16</span>:<span style=color:#ae81ff>32</span>], ct[<span style=color:#ae81ff>32</span>:<span style=color:#ae81ff>48</span>]
</span></span><span style=display:flex><span>flag <span style=color:#f92672>=</span> bytearray(<span style=color:#ae81ff>32</span>) 
</span></span><span style=display:flex><span>index <span style=color:#f92672>=</span> <span style=color:#ae81ff>31</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>count1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>_iv, _ct1, _ct2 <span style=color:#f92672>=</span> bytearray(ct[:<span style=color:#ae81ff>16</span>]), bytearray(ct[<span style=color:#ae81ff>16</span>:<span style=color:#ae81ff>32</span>]), bytearray(ct[<span style=color:#ae81ff>32</span>:<span style=color:#ae81ff>48</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>15</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>    count2 <span style=color:#f92672>=</span> count1
</span></span><span style=display:flex><span>    count1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> j <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>256</span>):
</span></span><span style=display:flex><span>        _ct1[i] <span style=color:#f92672>=</span> j
</span></span><span style=display:flex><span>        p<span style=color:#f92672>.</span>sendline(bytearray<span style=color:#f92672>.</span>hex(_ct1<span style=color:#f92672>+</span>_ct2)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>        reply <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span>readline()[:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]<span style=color:#f92672>.</span>decode()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> reply <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;Well received :)&#39;</span>:
</span></span><span style=display:flex><span>            count1 <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> j <span style=color:#f92672>!=</span> ct1[i]:
</span></span><span style=display:flex><span>                flag[index] <span style=color:#f92672>=</span> ct1[i] <span style=color:#f92672>^</span> _ct1[i] <span style=color:#f92672>^</span> <span style=color:#ae81ff>128</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> abs(count1 <span style=color:#f92672>-</span> count2) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>        flag[index] <span style=color:#f92672>=</span> <span style=color:#ae81ff>128</span>
</span></span><span style=display:flex><span>    _ct1[i] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>^</span> flag[index] <span style=color:#f92672>^</span> ct1[i]
</span></span><span style=display:flex><span>    index <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>_iv, _ct1, _ct2 <span style=color:#f92672>=</span> bytearray(ct[:<span style=color:#ae81ff>16</span>]), bytearray(ct[<span style=color:#ae81ff>16</span>:<span style=color:#ae81ff>32</span>]), bytearray(ct[<span style=color:#ae81ff>32</span>:<span style=color:#ae81ff>48</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>15</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> j <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>256</span>):
</span></span><span style=display:flex><span>        _iv[i] <span style=color:#f92672>=</span> j
</span></span><span style=display:flex><span>        p<span style=color:#f92672>.</span>sendline(bytearray<span style=color:#f92672>.</span>hex(_iv<span style=color:#f92672>+</span>_ct1)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>        reply <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span>readline()[:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]<span style=color:#f92672>.</span>decode()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> reply <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;Well received :)&#39;</span>:
</span></span><span style=display:flex><span>            flag[index] <span style=color:#f92672>=</span> _iv[i] <span style=color:#f92672>^</span> iv[i] <span style=color:#f92672>^</span> <span style=color:#ae81ff>128</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>    _iv[i] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>^</span> flag[index] <span style=color:#f92672>^</span> iv[i]
</span></span><span style=display:flex><span>    index <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(bytes(flag))
</span></span></code></pre></div><p>:::</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#source-code>Source Code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit>Exploit</a></li></ul></nav></div></aside></main></body></html>