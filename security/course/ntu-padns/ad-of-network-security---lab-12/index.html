<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  A&amp;D of Network Security - Lab 12
  #


  tags: Practicum of A&amp;D of NS NTU
  #


  Video
  #

NTU PADNS Lecture 12

  Background
  #

What is _mbscmp?
int _mbscmp(
   const unsigned char *string1,
   const unsigned char *string2
);
Return Value

<0 	string1 is less than string2
=0 	string1 is identical to string2
>0 	string1 is greater than string2

  Recon
  #


  Static - IDA Pro
  #

:::spoiler Main Source Code"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-padns/ad-of-network-security---lab-12/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="A&D of Network Security - Lab 12"><meta property="og:description" content="A&amp;D of Network Security - Lab 12 # tags: Practicum of A&amp;D of NS NTU # Video # NTU PADNS Lecture 12
Background # What is _mbscmp?
int _mbscmp( const unsigned char *string1, const unsigned char *string2 ); Return Value
<0 string1 is less than string2 =0 string1 is identical to string2 >0 string1 is greater than string2
Recon # Static - IDA Pro # :::spoiler Main Source Code"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="NTU"><meta property="article:tag" content="NTU_PADNS"><title>A&amp;D of Network Security - Lab 12 | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-padns/ad-of-network-security---lab-12/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>A&amp;D of Network Security - Lab 12</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#video>Video</a></li><li><a href=#background>Background</a></li><li><a href=#recon>Recon</a><ul><li><a href=#static---ida-pro>Static - IDA Pro</a></li></ul></li><li><a href=#lab-9-1-questions>Lab 9-1 Questions</a></li><li><a href=#lab-9-2-questions>Lab 9-2 Questions</a></li><li><a href=#reference>Reference</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=ad-of-network-security---lab-12>A&amp;D of Network Security - Lab 12
<a class=anchor href=#ad-of-network-security---lab-12>#</a></h1><h6 id=tags-practicum-of-ad-of-ns-ntu>tags: <code>Practicum of A&amp;D of NS</code> <code>NTU</code>
<a class=anchor href=#tags-practicum-of-ad-of-ns-ntu>#</a></h6><h2 id=video>Video
<a class=anchor href=#video>#</a></h2><p><a href="https://files-1.dlc.ntu.edu.tw/cool-video/202305/c6cc49a9-e1f9-4a9e-a7dc-70c4f79c98b1/transcoded.mp4?AWSAccessKeyId=C6ueMrUe5JyPkWQJAyKp&amp;Expires=1684429335&amp;Signature=UQaLvueX0U%2Bvs65WhFgrks9vg%2Fc%3D">NTU PADNS Lecture 12</a></p><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p><a href="https://learn.microsoft.com/en-us/cpp/c-runtime-library/reference/strcmp-wcscmp-mbscmp?view=msvc-170">What is _mbscmp?</a></p><pre tabindex=0><code class=language-clike! data-lang=clike!>int _mbscmp(
   const unsigned char *string1,
   const unsigned char *string2
);
</code></pre><p>Return Value</p><blockquote><p>&lt;0 string1 is less than string2
=0 string1 is identical to string2
>0 string1 is greater than string2</p></blockquote><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><h3 id=static---ida-pro>Static - IDA Pro
<a class=anchor href=#static---ida-pro>#</a></h3><p>:::spoiler Main Source Code</p><pre tabindex=0><code class="language-clike=" data-lang="clike=">int __cdecl main(int argc, const char **argv, const char **envp)
{
  char v4; // [esp+10h] [ebp-181Ch]
  char v5; // [esp+410h] [ebp-141Ch]
  char v6; // [esp+810h] [ebp-101Ch]
  char v7; // [esp+C10h] [ebp-C1Ch]
  CHAR v8; // [esp+1024h] [ebp-808h]
  CHAR ServiceName; // [esp+1428h] [ebp-404h]
  const char *v10; // [esp+1828h] [ebp-4h]

  if ( argc == 1 )
  {
    if ( !sub_401000() )
      sub_402410();
    sub_402360();
  }
  else
  {
    v10 = argv[argc - 1];
    if ( !sub_402510(v10) )
      sub_402410();
    if ( _mbscmp((const unsigned __int8 *)argv[1], &amp;byte_40C170) )
    {
      if ( _mbscmp((const unsigned __int8 *)argv[1], &amp;byte_40C16C) )
      {
        if ( _mbscmp((const unsigned __int8 *)argv[1], &amp;byte_40C168) )
        {
          if ( _mbscmp((const unsigned __int8 *)argv[1], aCc) )
            sub_402410();
          if ( argc != 3 )
            sub_402410();
          if ( !sub_401280(&amp;v5, 1024, &amp;v6, 1024, &amp;v4, 1024, &amp;v7) )
            sub_402E7E(aKSHSPSPerS, &amp;v5);
        }
        else
        {
          if ( argc != 7 )
            sub_402410();
          sub_401070(argv[2], argv[3], argv[4], argv[5]);
        }
      }
      else if ( argc == 3 )
      {
        if ( sub_4025B0(&amp;v8) )
          return -1;
        sub_402900(&amp;v8);
      }
      else
      {
        if ( argc != 4 )
          sub_402410();
        sub_402900(argv[2]);
      }
    }
    else if ( argc == 3 )
    {
      if ( sub_4025B0(&amp;ServiceName) )
        return -1;
      sub_402600(&amp;ServiceName);
    }
    else
    {
      if ( argc != 4 )
        sub_402410();
      sub_402600(argv[2]);
    }
  }
  return 0;
}
</code></pre><p>:::</p><ul><li>If we execute it directly, nothing happened.</li></ul><h2 id=lab-9-1-questions>Lab 9-1 Questions
<a class=anchor href=#lab-9-1-questions>#</a></h2><ol><li><p>How can you get this malware to install itself?
Ans: You can get the program to install itself by providing it with the <code>-in</code> option, along with the password. Alternatively, you can patch the binary to skip the password verification check.
<img src=https://hackmd.io/_uploads/HJvh2Xdr2.png alt></p></li><li><p>What are the command-line options for this program? What is the password requirement?
Ans: The command-line options for the program are one of four values and the password. The password is the string <code>abcd</code> and is required for all actions except the default behavior. The -in option instructs the malware to install itself. The <code>-re</code> option instructs the malware to remove itself. The <code>-c</code> option instructs the malware to update its configuration, including its beacon IP address. The <code>-cc</code> option instructs the malware to print its current configuration to the console. By default, this malware functions as a backdoor if installed.</p></li><li><p>How can you use <code>OllyDbg</code> to permanently patch this malware, so that it doesn’t require the special command-line password?
Ans: You can patch the binary by changing the first bytes of the function at address 0x402510 to always return true. The assembly instruction for this behavior is <code>MOV EAX, 0x1; RETN;</code>, which corresponds to the byte sequence <code>B8 01 00 00 00 C3</code>.</p></li><li><p>What are the host-based indicators of this malware?
Ans: The malware creates the registry key HKLM\Software\Microsoft \XPS\ Configuration (note the trailing space after Microsoft). The malware also creates the service XYZ Manager Service, where XYZ can be a parameter provided at install time or the name of the malware executable. Finally, when the malware copies itself into the Windows System directory, it may change the filename to match the service name.</p></li><li><p>What are the different actions this malware can be instructed to take via the network?
Ans: The malware can be instructed to execute one of five commands via the network: SLEEP, UPLOAD, DOWNLOAD, CMD, or NOTHING. The SLEEP command instructs the malware to perform no action for a given period of time. The UPLOAD command reads a file from the network and writes it to the local system at a specified path. The DOWNLOAD command instructs the malware to send the contents of a local file over the network to the remote host. The CMD command causes the malware to execute a shell command on the local system. The NOTHING command is a no-op command that causes the malware to do nothing.</p></li><li><p>Are there any useful network-based signatures for this malware?
Ans: By default, the malware beacons <a href=http://www.practicalmalwareanalysis.com/>http://www.practicalmalwareanalysis.com/</a> ; however, this is configurable. The beacons are HTTP/1.0 GET requests for resources in the form xxxx/xxxx.xxx, where x is a random alphanumeric ASCII character. The malware does not provide any HTTP headers with its requests</p></li></ol><h2 id=lab-9-2-questions>Lab 9-2 Questions
<a class=anchor href=#lab-9-2-questions>#</a></h2><ol><li>What strings do you see statically in the binary?
Ans: The imports and the string cmd are the only interesting strings that appear statically in the binary.</li><li>What happens when you run this binary?
Ans: It terminates without doing much.</li><li>How can you get this sample to run its malicious payload?
Ans: Rename the file <em>ocl.exe</em> before you run it.</li><li>What is happening at 0x00401133?
Ans: A string is being built on the stack, which is used by attackers to obfuscate strings from simple strings utilities and basic static analysis techniques.</li><li>What arguments are being passed to subroutine 0x00401089?
Ans: The string 1qaz2wsx3edc and a pointer to a buffer of data are passed to subroutine 0x401089.</li><li>What domain name does this malware use?
Ans: The malware uses the domain <code>practicalmalwareanalysis.com</code>.</li><li>What encoding routine is being used to obfuscate the domain name?
Ans: The malware will XOR the encoded DNS name with the string 1qaz2wsx3edc to decode the domain name.</li><li>What is the significance of the <code>CreateProcessA</code> call at 0x0040106E?
Ans: The malware is setting the <code>stdout</code>, <code>stderr</code>, and <code>stdin</code> handles (used in the <code>STARTUPINFO</code> structure of <code>CreateProcessA</code>) to the socket. Since <code>CreateProcessA</code> is called with cmd as an argument, this will create a reverse shell by tying the command shell to the socket.</li></ol><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><p><a href=https://www.cnblogs.com/houhaibushihai/p/10310324.html>Lab 9-1</a>
<a href=https://blog.csdn.net/isinstance/article/details/78520494>恶意代码分析实战 Lab 9-1 习题笔记</a>
<a href=https://blog.csdn.net/isinstance/article/details/78841910>恶意代码分析实战 Lab 9-2 习题笔记</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#video>Video</a></li><li><a href=#background>Background</a></li><li><a href=#recon>Recon</a><ul><li><a href=#static---ida-pro>Static - IDA Pro</a></li></ul></li><li><a href=#lab-9-1-questions>Lab 9-1 Questions</a></li><li><a href=#lab-9-2-questions>Lab 9-2 Questions</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside></main></body></html>