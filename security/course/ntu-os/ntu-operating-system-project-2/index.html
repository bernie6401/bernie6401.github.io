<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  NTU Operating System Project 2
  #


  tags: NTU_OS Operating System NachOS CPU Scheduling System Call
  #

[TOC]

  Motivation
  #


For the first task, We&rsquo;d like to add sleep() function in system call that can help us call sleep in our program.
For the second task, we&rsquo;d like to implement CPU scheduling by FIFO(First-In-First-Out), SJF(Shortest-Job-First), Priority, RR(Round-Robin), and multi-level queue.


  Implementation
  #


  Task1 - System Call
  #



First of all, we need to define a new token, SC_Sleep,  that compiler(scanner) can recognize in code/userprog/syscall.h."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-os/ntu-operating-system-project-2/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="NTU Operating System Project 2"><meta property="og:description" content="NTU Operating System Project 2 # tags: NTU_OS Operating System NachOS CPU Scheduling System Call # [TOC]
Motivation # For the first task, We’d like to add sleep() function in system call that can help us call sleep in our program. For the second task, we’d like to implement CPU scheduling by FIFO(First-In-First-Out), SJF(Shortest-Job-First), Priority, RR(Round-Robin), and multi-level queue. Implementation # Task1 - System Call # First of all, we need to define a new token, SC_Sleep, that compiler(scanner) can recognize in code/userprog/syscall.h."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="NTU_OS"><meta property="article:tag" content="NTU"><title>NTU Operating System Project 2 | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-os/ntu-operating-system-project-2/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>NTU Operating System Project 2</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#motivation>Motivation</a></li><li><a href=#implementation>Implementation</a><ul><li><a href=#task1---system-call>Task1 - System Call</a></li><li><a href=#task2---cpu-scheduling>Task2 - CPU Scheduling</a></li></ul></li><li><a href=#result>Result</a></li><li><a href=#reference>Reference</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=ntu-operating-system-project-2>NTU Operating System Project 2
<a class=anchor href=#ntu-operating-system-project-2>#</a></h1><h6 id=tags-ntu_os-operating-system-nachos-cpu-scheduling-system-call>tags: <code>NTU_OS</code> <code>Operating System</code> <code>NachOS</code> <code>CPU Scheduling</code> <code>System Call</code>
<a class=anchor href=#tags-ntu_os-operating-system-nachos-cpu-scheduling-system-call>#</a></h6><p>[TOC]</p><h2 id=motivation>Motivation
<a class=anchor href=#motivation>#</a></h2><ul><li>For the first task, We&rsquo;d like to add sleep() function in system call that can help us call sleep in our program.</li><li>For the second task, we&rsquo;d like to implement CPU scheduling by FIFO(First-In-First-Out), SJF(Shortest-Job-First), Priority, RR(Round-Robin), and multi-level queue.</li></ul><h2 id=implementation>Implementation
<a class=anchor href=#implementation>#</a></h2><h3 id=task1---system-call>Task1 - System Call
<a class=anchor href=#task1---system-call>#</a></h3><ol><li><p>First of all, we need to define a new token, SC_Sleep, that compiler(scanner) can recognize in <code>code/userprog/syscall.h</code>.</p></li><li><p>So, we have to assign a number to SC_Sleep that it can return the value.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#75715e>#define SC_ThreadFork	9
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define SC_ThreadYield	10
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define SC_PrintInt	11
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* ********************************************* 
</span></span></span><span style=display:flex><span><span style=color:#75715e>  Self-defined
</span></span></span><span style=display:flex><span><span style=color:#75715e> ********************************************* */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define SC_Sleep    12.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>...
</span></span></code></pre></div></li><li><p>Then, observe the other define words like SC_PrintInt in the same file. You can see there&rsquo;re lots of declaration function for each system call such as <code>void PrintInt(int number);</code> or <code>void ThreadFork(void (*func)());</code>,etc.. So, we must declare a function for sleep system call.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#75715e>/* ********************************************* 
</span></span></span><span style=display:flex><span><span style=color:#75715e>  Self-defined
</span></span></span><span style=display:flex><span><span style=color:#75715e> ********************************************* */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> Sleep(<span style=color:#66d9ef>int</span> number);
</span></span><span style=display:flex><span><span style=color:#75715e>#endif </span><span style=color:#75715e>/* IN_ASM */</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>...
</span></span></code></pre></div></li><li><p>According to the assignment description file, another file should be checked is start.s in test/start.s.</p><p>According to the comment above this file, it&rsquo;s a file to assist system calls to <strong>NachOS kernel</strong> by assembly language.</p><blockquote><p>Start.s</p><ul><li>Assembly language <strong>assist for user programs running on top of Nachos</strong>. Since we don&rsquo;t want to pull in the entire C library, we define what we need for a user program here, namely Start and the system calls.</li></ul><p>System call stubs:</p><ul><li>Assembly language assist to make system calls to the Nachos kernel. There is one stub per system call, that places the code for the system call into register r2, and leaves the arguments to the system call alone (in other words, arg1 is in r4, arg2 is in r5, arg3 is in r6, arg4 is in r7)
The return value is in r2. This follows the standard C calling convention on the MIPS.</li></ul></blockquote><pre tabindex=0><code class=language-assembly data-lang=assembly>/* ********************************************* 
  Self-defined
 ********************************************* */
	.globl  Sleep	/* Set Sleep to a global symbol that can be found in real c++ code properly */
	.ent    Sleep	/* Set the entry point for Sleep */
Sleep:
	addiu   $2,$0,SC_Sleep
	syscall
	j       $31
	.end    Sleep
</code></pre></li><li><p>From assignment description file, we should catch the exception situation by userprog/exception.cc. So, we need to define a new case in this file.</p><p>According to the comment above in exception.cc</p><blockquote><p>Entry point into the Nachos kernel from user programs. There are two kinds of things that can cause control to transfer back to here from user code:</p><ul><li><strong>syscall</strong> &ndash; The user code explicitly requests to call a procedure in the Nachos kernel. Right now, the only function we support is &ldquo;Halt&rdquo;.</li><li><strong>exceptions</strong> &ndash; The user code does something that the CPU can&rsquo;t handle. For instance, accessing memory that doesn&rsquo;t exist, arithmetic errors, etc.</li></ul><p>&mldr;</p><p><strong>ExceptionHandler</strong></p><ul><li>Entry point into the Nachos kernel. Called when a user program is executing, and either does a syscall, or generates an addressing or arithmetic exception.</li><li>For system calls, the following is the calling convention:
system call code &ndash; r2
arg1 &ndash; r4
arg2 &ndash; r5
arg3 &ndash; r6
arg4 &ndash; r7
The result of the system call, if any, must be put back into r2.</li><li>And don&rsquo;t forget to increment the pc before returning. <strong>(Or else you&rsquo;ll loop making the same system call forever!</strong></li><li>&ldquo;which&rdquo; is the kind of exception. The list of possible exceptions are in machine.h.</li></ul></blockquote><p>So, observe the previous case, SC_PrintInt, we can guess the value stored in <code>kernel->machine->Readgister(4)</code>. The code is like this&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>/* ********************************************* 
</span></span></span><span style=display:flex><span><span style=color:#75715e>Self-defined
</span></span></span><span style=display:flex><span><span style=color:#75715e>********************************************* */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> SC_Sleep:
</span></span><span style=display:flex><span>    val<span style=color:#f92672>=</span>kernel<span style=color:#f92672>-&gt;</span>machine<span style=color:#f92672>-&gt;</span>ReadRegister(<span style=color:#ae81ff>4</span>);
</span></span><span style=display:flex><span>    cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Sleep a while:&#34;</span> <span style=color:#f92672>&lt;&lt;</span>val <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;(ms)&#34;</span> <span style=color:#f92672>&lt;&lt;</span> endl;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span></code></pre></div><p>But, this code <strong>can not really stop the executing</strong> instead of printing out a normal message. So, refer to the assignment note, we should check <strong><code>kernel->alarm->WaitUntil()</code></strong> function that&rsquo;ll really implement sleep function in <strong>threads/alarm.h</strong>. The result after adding the code is just like&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>/* ********************************************* 
</span></span></span><span style=display:flex><span><span style=color:#75715e>Self-defined
</span></span></span><span style=display:flex><span><span style=color:#75715e>********************************************* */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> SC_Sleep:
</span></span><span style=display:flex><span>    val<span style=color:#f92672>=</span>kernel<span style=color:#f92672>-&gt;</span>machine<span style=color:#f92672>-&gt;</span>ReadRegister(<span style=color:#ae81ff>4</span>);
</span></span><span style=display:flex><span>    cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Sleep a while:&#34;</span> <span style=color:#f92672>&lt;&lt;</span>val <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;(ms)&#34;</span> <span style=color:#f92672>&lt;&lt;</span> endl;
</span></span><span style=display:flex><span>    kernel<span style=color:#f92672>-&gt;</span>alarm<span style=color:#f92672>-&gt;</span>WaitUntil(val);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span></code></pre></div><p>*More info about WainUntil() function and interrupt, you can check out <a href=http://blog.terrynini.tw/tw/OS-NachOS-HW1/#%E4%B8%AD%E6%96%B7%E5%B8%B8%E5%BC%8F>here</a></p></li><li><p><strong>The most important part</strong></p><p>Define a class named <strong>sleepList</strong> in alarm.h and implement the methods in alarm.cc. All the other description can check out <a href=http://blog.terrynini.tw/tw/OS-NachOS-HW1/#%e4%b8%ad%e6%96%b7%e5%b8%b8%e5%bc%8f>OS-NachOS-HW1</a> and use VSode can be more clearly. Lazy to write it down.</p></li><li><p>Refer to <a href=http://blog.terrynini.tw/tw/OS-NachOS-HW1/#%e6%b8%ac%e8%a9%a6-1>OS-NachOS-HW1</a>, you can write your own testing case or just use the ready-made test case on the web. Note that you must revise <code>Makefile</code> in <code>code/test/Makefile</code> like this&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>all</span><span style=color:#f92672>:</span> halt shell matmult sort test1 test2 sleep1 sleep2
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sleep1</span><span style=color:#f92672>:</span> sleep1.o start.o
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>$(</span>LD<span style=color:#66d9ef>)</span> <span style=color:#66d9ef>$(</span>LDFLAGS<span style=color:#66d9ef>)</span> start.o sleep1.o -o sleep1.coff
</span></span><span style=display:flex><span>	../bin/coff2noff sleep1.coff sleep1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sleep2</span><span style=color:#f92672>:</span> sleep2.o start.o
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>$(</span>LD<span style=color:#66d9ef>)</span> <span style=color:#66d9ef>$(</span>LDFLAGS<span style=color:#66d9ef>)</span> start.o sleep2.o -o sleep2.coff
</span></span><span style=display:flex><span>	../bin/coff2noff sleep2.coff sleep2
</span></span></code></pre></div><p>*Note that you must use <strong>tab</strong> in <code>Makefile</code>.</p><p>*The purpose of these manipulation is when you use <code>make</code> command in <code>code/Makefile</code>. It&rsquo;ll execute all <code>Makefile</code> that exist in each folder. It can be observed in <code>code/Makefile</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span>MAKE <span style=color:#f92672>=</span> make
</span></span><span style=display:flex><span>LPR <span style=color:#f92672>=</span> lpr
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>all</span><span style=color:#f92672>:</span> 
</span></span><span style=display:flex><span>	cd threads; <span style=color:#66d9ef>$(</span>MAKE<span style=color:#66d9ef>)</span> depend
</span></span><span style=display:flex><span>	cd threads; <span style=color:#66d9ef>$(</span>MAKE<span style=color:#66d9ef>)</span> nachos
</span></span><span style=display:flex><span>	cd userprog; <span style=color:#66d9ef>$(</span>MAKE<span style=color:#66d9ef>)</span> depend 
</span></span><span style=display:flex><span>	cd userprog; <span style=color:#66d9ef>$(</span>MAKE<span style=color:#66d9ef>)</span> nachos 
</span></span><span style=display:flex><span>	cd filesys; <span style=color:#66d9ef>$(</span>MAKE<span style=color:#66d9ef>)</span> depend
</span></span><span style=display:flex><span>	cd filesys; <span style=color:#66d9ef>$(</span>MAKE<span style=color:#66d9ef>)</span> nachos 
</span></span><span style=display:flex><span>	cd network; <span style=color:#66d9ef>$(</span>MAKE<span style=color:#66d9ef>)</span> depend
</span></span><span style=display:flex><span>	cd network; <span style=color:#66d9ef>$(</span>MAKE<span style=color:#66d9ef>)</span> nachos 
</span></span><span style=display:flex><span>	cd bin; <span style=color:#66d9ef>$(</span>MAKE<span style=color:#66d9ef>)</span> all
</span></span><span style=display:flex><span>	cd test; make all
</span></span></code></pre></div><p>*Error message I encountered:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>...
</span></span><span style=display:flex><span>../bin/coff2noff halt.coff halt
</span></span><span style=display:flex><span>make<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>: execvp: ../bin/coff2noff: Permission denied
</span></span><span style=display:flex><span>make<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>: *** <span style=color:#f92672>[</span>halt<span style=color:#f92672>]</span> Error <span style=color:#ae81ff>127</span>
</span></span><span style=display:flex><span>make<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>: Leaving directory <span style=color:#e6db74>`</span>/home/sbk/NTU/Operating System/Project2/nachos-4.0/code/test<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>make: *** <span style=color:#f92672>[</span>all<span style=color:#f92672>]</span> Error <span style=color:#ae81ff>2</span>
</span></span></code></pre></div><p>According to <a href=https://stackoverflow.com/questions/9106536/why-do-i-get-permission-denied-when-i-try-use-make-to-install-something>Why do I get permission denied when I try use &ldquo;make&rdquo; to install something?</a> page on StackOverflow, just use <code>chmod 777 ./bin/coff2noff</code> in <code>./code</code> folder.</p></li></ol><h3 id=task2---cpu-scheduling>Task2 - CPU Scheduling
<a class=anchor href=#task2---cpu-scheduling>#</a></h3><h4 id=testing>Testing
<a class=anchor href=#testing>#</a></h4><ol><li><p><strong><em>threads/thread.cc</em></strong> - create a test case</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>threadBody</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Thread <span style=color:#f92672>*</span><span style=color:#66d9ef>thread</span> <span style=color:#f92672>=</span> kernel<span style=color:#f92672>-&gt;</span>currentThread;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>thread</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getBurstTime</span>() <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>thread</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>setBurstTime</span>(<span style=color:#66d9ef>thread</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getBurstTime</span>() <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        kernel<span style=color:#f92672>-&gt;</span>interrupt<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>OneTick</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%s: remaining %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, kernel<span style=color:#f92672>-&gt;</span>currentThread<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getName</span>(), kernel<span style=color:#f92672>-&gt;</span>currentThread<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getBurstTime</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> Thread<span style=color:#f92672>::</span><span style=color:#a6e22e>SchedulingTest</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>int</span> thread_num <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name[thread_num] <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;A&#34;</span>, <span style=color:#e6db74>&#34;B&#34;</span>, <span style=color:#e6db74>&#34;C&#34;</span>, <span style=color:#e6db74>&#34;D&#34;</span>};
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> thread_priority[thread_num] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>2</span>};
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> thread_burst[thread_num] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>3</span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Thread <span style=color:#f92672>*</span>t;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> thread_num; i <span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        t <span style=color:#f92672>=</span> new <span style=color:#a6e22e>Thread</span>(name[i]);
</span></span><span style=display:flex><span>        t<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>setPriority</span>(thread_priority[i]);
</span></span><span style=display:flex><span>        t<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>setBurstTime</span>(thread_burst[i]);
</span></span><span style=display:flex><span>        t<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>Fork</span>((VoidFunctionPtr) threadBody, (<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)NULL);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    kernel<span style=color:#f92672>-&gt;</span>currentThread<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>Yield</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p><strong><em>threads/thread.h</em></strong> - define various method in header files and implement these method in c file</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Thread</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>         ...
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>         ...
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>void</span> setBurstTime(<span style=color:#66d9ef>int</span> t)    {burstTime <span style=color:#f92672>=</span> t;}
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getBurstTime</span>()		      {<span style=color:#66d9ef>return</span> burstTime;}
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setStartTime</span>(<span style=color:#66d9ef>int</span> t)	  {startTime <span style=color:#f92672>=</span> t;}
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getStartTime</span>()		      {<span style=color:#66d9ef>return</span> startTime;}
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setPriority</span>(<span style=color:#66d9ef>int</span> t)	    {execPriority <span style=color:#f92672>=</span> t;}
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getPriority</span>()		        {<span style=color:#66d9ef>return</span> execPriority;}
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>SchedulingTest</span>();
</span></span><span style=display:flex><span>         ...
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>int</span> burstTime;	<span style=color:#75715e>// predicted burst time
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         <span style=color:#66d9ef>int</span> startTime;	<span style=color:#75715e>// the start time of the thread
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         <span style=color:#66d9ef>int</span> execPriority;	<span style=color:#75715e>// the execute priority of the thread
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         ...
</span></span><span style=display:flex><span>};
</span></span></code></pre></div></li><li><p><strong><em>threads/kernel.cc</em></strong> - add <code>SchedulingTest()</code> function that we&rsquo;ve defined in <code>thread.h in</code> <code>ThreadKernel</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>void</span> ThreadedKernel<span style=color:#f92672>::</span>SelfTest()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>     ...
</span></span><span style=display:flex><span>     LibSelfTest();				<span style=color:#75715e>// test library routines
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     currentThread<span style=color:#f92672>-&gt;</span>SelfTest();	<span style=color:#75715e>// test thread switching
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     Thread<span style=color:#f92672>::</span>SchedulingTest();	<span style=color:#75715e>// Add this line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                 <span style=color:#75715e>// test semaphore operation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     semaphore <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Semaphore(<span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>     ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p><strong><em>threads/main.cc</em></strong> - if we want to test all types of scheduler, then we need to set extra parameter to choose the type just shown as below</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cd code/threads
</span></span><span style=display:flex><span>$ ./nachos FCFS
</span></span><span style=display:flex><span>$ ./nachos SJF
</span></span><span style=display:flex><span>$ ./nachos Priority
</span></span><span style=display:flex><span>$ ./nachos RR
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>argv)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>     ...
</span></span><span style=display:flex><span>     DEBUG(dbgThread, <span style=color:#e6db74>&#34;Entering main&#34;</span>);
</span></span><span style=display:flex><span>     SchedulerType type <span style=color:#f92672>=</span> RR;
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>if</span>(strcmp(argv[<span style=color:#ae81ff>1</span>], <span style=color:#e6db74>&#34;FCFS&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        type <span style=color:#f92672>=</span> FIFO;
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (strcmp(argv[<span style=color:#ae81ff>1</span>], <span style=color:#e6db74>&#34;SJF&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        type <span style=color:#f92672>=</span> SJF;
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (strcmp(argv[<span style=color:#ae81ff>1</span>], <span style=color:#e6db74>&#34;PRIORITY&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        type <span style=color:#f92672>=</span> Priority;
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (strcmp(argv[<span style=color:#ae81ff>1</span>], <span style=color:#e6db74>&#34;RR&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        type <span style=color:#f92672>=</span> RR;
</span></span><span style=display:flex><span>     kernel <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> KernelType(argc, argv);
</span></span><span style=display:flex><span>     kernel<span style=color:#f92672>-&gt;</span>Initialize(type);    <span style=color:#75715e>// Need to add &#39;type&#39; as parameter here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ol><hr><h4 id=implement>Implement
<a class=anchor href=#implement>#</a></h4><ol start=5><li><p><strong><em>machine/machine.h</em></strong> - let NumPhysPage bigger to avoid <strong>segmentation fault (core dumped)</strong> which is an error message about memory allocation <strong>(note that this error is hard to debug)</strong>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> PageSize <span style=color:#f92672>=</span> <span style=color:#ae81ff>128</span>; 		<span style=color:#75715e>// set the page size equal to
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>										<span style=color:#75715e>// the disk sector size, for simplicity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> NumPhysPages <span style=color:#f92672>=</span> <span style=color:#ae81ff>256</span>;	<span style=color:#75715e>// Change this line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>int</span> MemorySize <span style=color:#f92672>=</span> (NumPhysPages <span style=color:#f92672>*</span> PageSize);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>int</span> TLBSize <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;					<span style=color:#75715e>// if there is a TLB, make it small
</span></span></span></code></pre></div></li><li><p><strong><em>threads/scheduler.h</em></strong> - define additional scheduler type named FIFO(First-In-First-Out) and get type method in header file</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>SchedulerType</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    RR,     <span style=color:#75715e>// Round Robin
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SJF,
</span></span><span style=display:flex><span>    Priority,
</span></span><span style=display:flex><span>    FIFO	<span style=color:#75715e>// Add this line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Scheduler</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#f92672>~</span>Scheduler();
</span></span><span style=display:flex><span>    Scheduler(SchedulerType type);		<span style=color:#75715e>// Initialize list of ready threads
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SchedulerType <span style=color:#a6e22e>getSchedulerType</span>() {<span style=color:#66d9ef>return</span> schedulerType;}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setSchedulerType</span>(SchedulerType t) {schedulerType <span style=color:#f92672>=</span> t;}
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>};
</span></span></code></pre></div></li><li><p><strong><em>threads/scheduler.cc</em></strong> - implement each scheduler type here</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>SJFCompare</span>(Thread <span style=color:#f92672>*</span>a, Thread <span style=color:#f92672>*</span>b)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(a<span style=color:#f92672>-&gt;</span>getBurstTime() <span style=color:#f92672>==</span> b<span style=color:#f92672>-&gt;</span>getBurstTime())
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> a<span style=color:#f92672>-&gt;</span>getBurstTime() <span style=color:#f92672>&gt;</span> b<span style=color:#f92672>-&gt;</span>getBurstTime() <span style=color:#f92672>?</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>:</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>PriorityCompare</span>(Thread <span style=color:#f92672>*</span>a, Thread <span style=color:#f92672>*</span>b)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(a<span style=color:#f92672>-&gt;</span>getPriority() <span style=color:#f92672>==</span> b<span style=color:#f92672>-&gt;</span>getPriority())
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> a<span style=color:#f92672>-&gt;</span>getPriority() <span style=color:#f92672>&gt;</span> b<span style=color:#f92672>-&gt;</span>getPriority() <span style=color:#f92672>?</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>:</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>FIFOCompare</span>(Thread <span style=color:#f92672>*</span>a, Thread <span style=color:#f92672>*</span>b)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>//----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Scheduler::Scheduler
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 	Initialize the list of ready but not running threads.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//	Initially, no ready threads.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Scheduler<span style=color:#f92672>::</span>Scheduler()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Scheduler(RR);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>Scheduler<span style=color:#f92672>::</span>Scheduler(SchedulerType type)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>     schedulerType <span style=color:#f92672>=</span> type;
</span></span><span style=display:flex><span>     <span style=color:#75715e>// readyList = new List&lt;Thread *&gt;;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     <span style=color:#66d9ef>switch</span>(schedulerType)
</span></span><span style=display:flex><span>     {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> RR:
</span></span><span style=display:flex><span>            readyList <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> List<span style=color:#f92672>&lt;</span>Thread <span style=color:#f92672>*&gt;</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> SJF:
</span></span><span style=display:flex><span>            readyList <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SortedList<span style=color:#f92672>&lt;</span>Thread <span style=color:#f92672>*&gt;</span>(SJFCompare);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> Priority:
</span></span><span style=display:flex><span>            readyList <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SortedList<span style=color:#f92672>&lt;</span>Thread <span style=color:#f92672>*&gt;</span>(PriorityCompare);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> FIFO:
</span></span><span style=display:flex><span>            readyList <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SortedList<span style=color:#f92672>&lt;</span>Thread <span style=color:#f92672>*&gt;</span>(FIFOCompare);
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>     toBeDestroyed <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>} 
</span></span></code></pre></div></li><li><p><strong><em>threads/alarm.cc</em></strong> - if you want to implement <strong><em>preemptive</em></strong>, you need to determine whether call <code>interrupt->YieldOnReturn()</code> or not in <code>Alarm::CallBack()</code></p><p>And for the computing burst time, if you decide to use <strong>running time estimation</strong>, you need to compute in <code>Alarm::WaitUntil()</code> shown as below</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>void</span> Alarm<span style=color:#f92672>::</span>CallBack()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>     ...
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>if</span> (status <span style=color:#f92672>==</span> IdleMode <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>woken <span style=color:#f92672>&amp;&amp;</span> _sleepList.IsEmpty())
</span></span><span style=display:flex><span>     ...
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>else</span>    <span style=color:#75715e>// there&#39;s someone to preempt
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(kernel<span style=color:#f92672>-&gt;</span>scheduler<span style=color:#f92672>-&gt;</span>getSchedulerType() <span style=color:#f92672>==</span> RR <span style=color:#f92672>||</span> kernel<span style=color:#f92672>-&gt;</span>scheduler<span style=color:#f92672>-&gt;</span>getSchedulerType() <span style=color:#f92672>==</span> Priority )
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;=== interrupt-&gt;YieldOnReturn ===&#34;</span> <span style=color:#f92672>&lt;&lt;</span> endl;
</span></span><span style=display:flex><span>            interrupt<span style=color:#f92672>-&gt;</span>YieldOnReturn();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> Alarm<span style=color:#f92672>::</span>WaitUntil(<span style=color:#66d9ef>int</span> x)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>     ...
</span></span><span style=display:flex><span>     Thread<span style=color:#f92672>*</span> t <span style=color:#f92672>=</span> kernel<span style=color:#f92672>-&gt;</span>currentThread;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>int</span> worktime <span style=color:#f92672>=</span> kernel<span style=color:#f92672>-&gt;</span>stats<span style=color:#f92672>-&gt;</span>userTicks <span style=color:#f92672>-</span> t<span style=color:#f92672>-&gt;</span>getStartTime();
</span></span><span style=display:flex><span>     t<span style=color:#f92672>-&gt;</span>setBurstTime(t<span style=color:#f92672>-&gt;</span>getBurstTime() <span style=color:#f92672>+</span> worktime);
</span></span><span style=display:flex><span>     t<span style=color:#f92672>-&gt;</span>setStartTime(kernel<span style=color:#f92672>-&gt;</span>stats<span style=color:#f92672>-&gt;</span>userTicks);
</span></span><span style=display:flex><span>     ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ol><hr><h4 id=revise-some-files>Revise Some files
<a class=anchor href=#revise-some-files>#</a></h4><p>You have to include <code>scheduler.h</code> to each header file that we&rsquo;ll use that including <code>kernel.h</code>, <code>userkernel.h</code>, and <code>netkernel.h</code>. Then initial the scheduler type in each c file such as <code>kernel.cc</code>, <code>userkernel.cc</code>, and <code>netkernel.cc</code>. Most of them are very similar.</p><ol start=9><li><p><strong><em>threads/kernel.h</em></strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ThreadedKernel</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> Initialize();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>Initialize</span>(SchedulerType type);
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span>};
</span></span></code></pre></div></li><li><p><strong><em>threads/kernel.cc</em></strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>void</span> ThreadedKernel<span style=color:#f92672>::</span>Initialize()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Initialize(RR);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> ThreadedKernel<span style=color:#f92672>::</span>Initialize(SchedulerType type)<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>{
</span></span><span style=display:flex><span>    stats <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Statistics();		<span style=color:#75715e>// collect statistics
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    interrupt <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Interrupt;		<span style=color:#75715e>// start up interrupt handling
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    scheduler <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Scheduler(type);	<span style=color:#75715e>// initialize the ready queue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    alarm <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Alarm(randomSlice);	<span style=color:#75715e>// start up time slicing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// We didn&#39;t explicitly allocate the current thread we are running in.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// But if it ever tries to give up the CPU, we better have a Thread
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// object to save its state. 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    currentThread <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Thread(<span style=color:#e6db74>&#34;main&#34;</span>);		
</span></span><span style=display:flex><span>    currentThread<span style=color:#f92672>-&gt;</span>setStatus(RUNNING);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    interrupt<span style=color:#f92672>-&gt;</span>Enable();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p><strong><em>userprog/userkernel.h</em></strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;../threads/scheduler.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserProgKernel</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> ThreadedKernel
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> Initialize();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>Initialize</span>(SchedulerType type);
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span>};
</span></span></code></pre></div></li><li><p><strong><em>userprog/userkernel.cc</em></strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>void</span> UserProgKernel<span style=color:#f92672>::</span>Initialize()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Initialize(RR);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> UserProgKernel<span style=color:#f92672>::</span>Initialize(SchedulerType type)<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>{
</span></span><span style=display:flex><span>    ThreadedKernel<span style=color:#f92672>::</span>Initialize(type);	<span style=color:#75715e>// init multithreading
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    machine <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Machine(debugUserProg);
</span></span><span style=display:flex><span>    fileSystem <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileSystem();
</span></span><span style=display:flex><span>    <span style=color:#75715e>#ifdef FILESYS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	synchDisk <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SynchDisk(<span style=color:#e6db74>&#34;New SynchDisk&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>#endif </span><span style=color:#75715e>// FILESYS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div></li><li><p><strong><em>network/netkernel.h</em></strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;../threads/scheduler.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NetKernel</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> UserProgKernel
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> Initialize();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>Initialize</span>(SchedulerType type);
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span>};
</span></span></code></pre></div></li><li><p><strong><em>network/netkernel.cc</em></strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>void</span> NetKernel<span style=color:#f92672>::</span>Initialize()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Initialize(RR);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> NetKernel<span style=color:#f92672>::</span>Initialize(SchedulerType type)<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>{
</span></span><span style=display:flex><span>    UserProgKernel<span style=color:#f92672>::</span>Initialize(type);	<span style=color:#75715e>// init other kernel data structs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    postOfficeIn <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PostOfficeInput(<span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>    postOfficeOut <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PostOfficeOutput(reliability, <span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ol><h2 id=result>Result
<a class=anchor href=#result>#</a></h2><ul><li><p>Task 1 Result
I create another test case named Sleep3.c and aim to test the sleep time <strong>10 times longer</strong> than Sleep1.c and Sleep2.c is aim to test the time that <strong>100 times shorter</strong> than Sleep1.c.</p><ul><li><p>sleep1</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;syscall.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>main() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span>(i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>5</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        Sleep(<span style=color:#ae81ff>1000000</span>);
</span></span><span style=display:flex><span>        PrintInt(<span style=color:#ae81ff>2222</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=https://imgur.com/wk19ont.png alt="testing result for sleep1"></p></li><li><p>Sleep2</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;syscall.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>main() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span>(i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>5</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        Sleep(<span style=color:#ae81ff>10000</span>);
</span></span><span style=display:flex><span>        PrintInt(<span style=color:#ae81ff>99999</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=https://imgur.com/5r37MJg.png alt="result for sleep2"></p></li><li><p>Sleep3</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;syscall.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>main() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span>(i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>5</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        Sleep(<span style=color:#ae81ff>10000000</span>);
</span></span><span style=display:flex><span>        PrintInt(<span style=color:#ae81ff>666</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=https://imgur.com/rrOmAJm.png alt="result for sleep3"></p></li></ul><p>In Sleep1.c, you can feel the sleep function working clearly that compare with a normal code without sleep function or compare with a shorter sleep time such as Sleep2.c
And in Sleep3.c, you can feel the sleeping time much more longer that what we expected but just execute 3 times PrintInt function.<strong>(No idea why)</strong></p></li><li><p>Task 2 Result</p><ul><li>Result of real multi thread testing
<img src=https://imgur.com/tqovjLx.png alt="result of real multi thread testing"></li><li>Result of FCFS
<img src=https://imgur.com/gncST5x.png alt="result of FCFS"></li><li>Result of RR
<img src=https://imgur.com/yIi317H.png alt="result of RR"></li><li>Result of SJF
<img src=https://imgur.com/BMgDkp2.png alt="result of SJF"></li><li>Result of priority
<img src=https://imgur.com/KfFpOP3.png alt="result of priority"></li></ul></li></ul><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><ul><li><a href=http://blog.terrynini.tw/tw/OS-NachOS-HW1/>OS-NachOS-HW1</a></li><li><a href=https://morris821028.github.io/2014/05/30/lesson/hw-nachos4-2/>向 NachOS 4.0 作業進發 (2)</a></li><li><a href=https://hackmd.io/@Z_yUjsyqRzaD5rSUQ6JOVw/S1hiIHr5D>OS 2020 HW2 Nachos Report</a></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#motivation>Motivation</a></li><li><a href=#implementation>Implementation</a><ul><li><a href=#task1---system-call>Task1 - System Call</a></li><li><a href=#task2---cpu-scheduling>Task2 - CPU Scheduling</a></li></ul></li><li><a href=#result>Result</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside></main></body></html>