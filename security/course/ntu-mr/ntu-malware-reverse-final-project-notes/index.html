<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  NTU Malware Reverse Final Project Notes
  #


  tags: NTU_MR Malware Reverse Engineering and Analysis
  #


  Deep learning at the shallow end Malware classification for non-domain experts
  #


  How to reproduce?
  #



Construct Environment
The whole construction step can see 安裝 tensorflow 及 cuda cudnn 心得.
Refer to documentation for tensorflow, I choose the library shown as below&mldr;

  
      
          Object
          CUDA
          cuDNN
          Python
          GPU Driver Version
          tensorflow
          tensorflow-gpu
      
  
  
      
          Version
          11.2
          8.1
          3.6.13
          526.98
          2.6.2
          2.6.0
      
  

Then refer to NVIDIA CUDNN DOCUMENTATION, just use zlibwapi.dll provided by this page directly. This compressed folder is for x64 processor.
Notice that, DO NOT USE this page and this page. These are for x86 processor."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-mr/ntu-malware-reverse-final-project-notes/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="NTU Malware Reverse Final Project Notes"><meta property="og:description" content="NTU Malware Reverse Final Project Notes # tags: NTU_MR Malware Reverse Engineering and Analysis # Deep learning at the shallow end Malware classification for non-domain experts # How to reproduce? # Construct Environment The whole construction step can see 安裝 tensorflow 及 cuda cudnn 心得. Refer to documentation for tensorflow, I choose the library shown as below…
Object CUDA cuDNN Python GPU Driver Version tensorflow tensorflow-gpu Version 11.2 8.1 3.6.13 526.98 2.6.2 2.6.0 Then refer to NVIDIA CUDNN DOCUMENTATION, just use zlibwapi.dll provided by this page directly. This compressed folder is for x64 processor. Notice that, DO NOT USE this page and this page. These are for x86 processor."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="NTU_MR"><meta property="article:tag" content="Malware Reverse Engineering and Analysis"><title>NTU Malware Reverse Final Project Notes | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-mr/ntu-malware-reverse-final-project-notes/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>NTU Malware Reverse Final Project Notes</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#deep-learning-at-the-shallow-end-malware-classification-for-non-domain-experts>Deep learning at the shallow end Malware classification for non-domain experts</a><ul><li><a href=#how-to-reproduce>How to reproduce?</a></li><li><a href=#how-to-fed-into-malimg-dataset>How to Fed into <code>malimg-dataset</code></a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=ntu-malware-reverse-final-project-notes>NTU Malware Reverse Final Project Notes
<a class=anchor href=#ntu-malware-reverse-final-project-notes>#</a></h1><h6 id=tags-ntu_mr-malware-reverse-engineering-and-analysis>tags: <code>NTU_MR</code> <code>Malware Reverse Engineering and Analysis</code>
<a class=anchor href=#tags-ntu_mr-malware-reverse-engineering-and-analysis>#</a></h6><h2 id=deep-learning-at-the-shallow-end-malware-classification-for-non-domain-experts>Deep learning at the shallow end Malware classification for non-domain experts
<a class=anchor href=#deep-learning-at-the-shallow-end-malware-classification-for-non-domain-experts>#</a></h2><h3 id=how-to-reproduce>How to reproduce?
<a class=anchor href=#how-to-reproduce>#</a></h3><ol><li><p>Construct Environment
The whole construction step can see <a href=https://hackmd.io/@cwl0429/install_tf_guide>安裝 tensorflow 及 cuda cudnn 心得</a>.
Refer to <a href=https://www.tensorflow.org/install/source_windows#gpu>documentation for tensorflow</a>, I choose the library shown as below&mldr;</p><table><thead><tr><th style=text-align:center>Object</th><th style=text-align:center>CUDA</th><th style=text-align:center>cuDNN</th><th style=text-align:center>Python</th><th style=text-align:center>GPU Driver Version</th><th style=text-align:center>tensorflow</th><th style=text-align:center>tensorflow-gpu</th></tr></thead><tbody><tr><td style=text-align:center>Version</td><td style=text-align:center>11.2</td><td style=text-align:center>8.1</td><td style=text-align:center>3.6.13</td><td style=text-align:center>526.98</td><td style=text-align:center>2.6.2</td><td style=text-align:center>2.6.0</td></tr></tbody></table><p>Then refer to <a href=https://docs.nvidia.com/deeplearning/cudnn/install-guide/index.html#install-windows>NVIDIA CUDNN DOCUMENTATION</a>, just use <code>zlibwapi.dll</code> provided by this page directly. This compressed folder is for <code>x64</code> processor.
Notice that, <strong><font color=#FF0000>DO NOT USE <a href=http://www.winimage.com/zLibDll/>this page</a> and <a href=https://www.dll-files.com/zlibwapi.dll.html>this page</a></font></strong>. These are for <code>x86</code> processor.</p></li><li><p>Problems Occurs while Setting-Up:</p></li></ol><ul><li>If the command send the exception about <code>zlibwapi.dll</code>, then you can check this page: <a href=https://blog.csdn.net/qq_45071353/article/details/124091856>tensorflow出现报错： Could not locate zlibwapi.dll或者Could not load library cudnn_cnn_infer64_8.dll.</a>
Put <code>zlibwapi.dll</code> to <strong><code>C:\Windows\System32</code></strong> and <strong><code>C:\Windows\SysWOW64</code></strong>. Meanwhile, put the uncompressed folder of <code>zlib123dllx64</code> that download on <a href=https://docs.nvidia.com/deeplearning/cudnn/install-guide/index.html#install-zlib-windows>NVIDIA CUDNN DOCUMENTATION</a> to somewhere and add this path to <code>Environment Variables->System variables->PATH</code>. In my case, it&rsquo;s <code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.2\zlib123dllx64\dll_x64</code>.
The whole step about solving this problems, you can check this video at <code>time=11:36</code>
{%youtube 27fBCKKZdpY %}</li><li>If you can not use <code>nvcc</code> command, check this page: <a href=https://blog.csdn.net/XieRuily/article/details/123670141>CUDA安装和检测【全】（nvcc命令找不到的解决办法）</a></li></ul><ol start=3><li>Then revise the dataset path in code and run directly.</li></ol><h3 id=how-to-fed-into-malimg-dataset>How to Fed into <code>malimg-dataset</code>
<a class=anchor href=#how-to-fed-into-malimg-dataset>#</a></h3><h4 id=revise-original-code>Revise original code
<a class=anchor href=#revise-original-code>#</a></h4><ul><li><font color=FF0000>Note that the <code>kfold</code> parameter can not set less than 2</font></li><li>You can skip or comment all part of converting from .bin files to image, and start from <code>Load image data from the training set</code> section.</li><li>Note that you must preserve some variable and procedure as below<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>max_len <span style=color:#f92672>=</span> int(<span style=color:#ae81ff>1e4</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>binfn_id2cls <span style=color:#f92672>=</span> {} <span style=color:#75715e># file name id is the part before .</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> fn_label_item <span style=color:#f92672>in</span> train_labels_df<span style=color:#f92672>.</span>itertuples():
</span></span><span style=display:flex><span>    binfn_id2cls[fn_label_item<span style=color:#f92672>.</span>Id ] <span style=color:#f92672>=</span> fn_label_item<span style=color:#f92672>.</span>Class
</span></span></code></pre></div></li><li>Furthermore, you must revise some data path problem<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>project_dir <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;D:/NTU/First Year/Malware Reverse Engineering and Analysis/Homework/Final_Project/Dataset&#39;</span>
</span></span><span style=display:flex><span>data_dir <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(project_dir, <span style=color:#e6db74>&#39;malimg_dataset&#39;</span>)
</span></span><span style=display:flex><span>train_dir <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(data_dir, <span style=color:#e6db74>&#39;train&#39;</span>)
</span></span><span style=display:flex><span>test_dir <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(data_dir, <span style=color:#e6db74>&#39;validation&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#############################################################</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Load image data  from the training set</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#############################################################</span>
</span></span><span style=display:flex><span><span style=color:#75715e># NOTE: default value width = 1</span>
</span></span><span style=display:flex><span>train_img_dir <span style=color:#f92672>=</span> train_dir
</span></span><span style=display:flex><span>img_sfx <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;png&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>N_CLASS <span style=color:#f92672>=</span> <span style=color:#ae81ff>25</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##################################################</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Predict classes for test files, and save results </span>
</span></span><span style=display:flex><span><span style=color:#75715e>##################################################</span>
</span></span><span style=display:flex><span>test_img_dir <span style=color:#f92672>=</span> test_dir
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></div></li></ul><h4 id=convert-malimg-data>Convert <code>malimg</code> data
<a class=anchor href=#convert-malimg-data>#</a></h4><ul><li>Common variable will be used below<pre tabindex=0><code class=language-pytoh data-lang=pytoh>project_dir = &#39;D:/NTU/First Year/Malware Reverse Engineering and Analysis/Homework/Final_Project/Dataset&#39;
data_dir = os.path.join(project_dir, &#39;malimg_dataset&#39;)

train_dir = os.path.join(data_dir, &#39;train&#39;)
test_dir = os.path.join(data_dir, &#39;validation-original&#39;)
train_labels_fn = os.path.join(data_dir, &#39;trainLabels.csv&#39;)
</code></pre></li></ul><ol><li>Create csv file to store image ID and Class<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>folders <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>listdir(train_dir)
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;./trainLabels.csv&#39;</span>, <span style=color:#e6db74>&#39;w&#39;</span>, newline<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>) <span style=color:#66d9ef>as</span> csvf:
</span></span><span style=display:flex><span>    <span style=color:#75715e># 建立 CSV 檔寫入器</span>
</span></span><span style=display:flex><span>    writer <span style=color:#f92672>=</span> csv<span style=color:#f92672>.</span>writer(csvf)
</span></span><span style=display:flex><span>    writer<span style=color:#f92672>.</span>writerow([<span style=color:#e6db74>&#39;Id&#39;</span>,<span style=color:#e6db74>&#39;Class&#39;</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> j, f <span style=color:#f92672>in</span> enumerate(folders):
</span></span><span style=display:flex><span>        fullpath <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(train_dir, f)
</span></span><span style=display:flex><span>        files <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>listdir(fullpath)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> files:
</span></span><span style=display:flex><span>            writer<span style=color:#f92672>.</span>writerow([i, j<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>folders <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>listdir(test_dir)
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;./valLabels.csv&#39;</span>, <span style=color:#e6db74>&#39;w&#39;</span>, newline<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>) <span style=color:#66d9ef>as</span> csvf:
</span></span><span style=display:flex><span>    <span style=color:#75715e># 建立 CSV 檔寫入器</span>
</span></span><span style=display:flex><span>    writer <span style=color:#f92672>=</span> csv<span style=color:#f92672>.</span>writer(csvf)
</span></span><span style=display:flex><span>    writer<span style=color:#f92672>.</span>writerow([<span style=color:#e6db74>&#39;Id&#39;</span>,<span style=color:#e6db74>&#39;Class&#39;</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> j, f <span style=color:#f92672>in</span> enumerate(folders):
</span></span><span style=display:flex><span>        fullpath <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(test_dir, f)
</span></span><span style=display:flex><span>        files <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>listdir(fullpath)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> files:
</span></span><span style=display:flex><span>            writer<span style=color:#f92672>.</span>writerow([i, j<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>])
</span></span></code></pre></div></li><li>Move all image in each folder to the same folder<pre tabindex=0><code class=language-python! data-lang=python!>f2 = &#39;D:/NTU/First Year/Malware Reverse Engineering and Analysis/Homework/Final_Project/Dataset/malimg_dataset/validation/&#39;
folders = os.listdir(test_dir)
for j, f in enumerate(folders):
    fullpath = os.path.join(test_dir, f)
    files = os.listdir(fullpath)
    for i in files:
        files_src = os.path.join(fullpath, i)
        files_dest = os.path.join(f2, i)
        shutil.copyfile(files_src, files_dest)   # 複製檔案
</code></pre></li><li>Resize train/val image to 10000bytes
In order to match the data type of this model can accept, we must shrink the image size to 10000 bytes. By the way, the original data are also execute the same procedure for the same purpose.<pre tabindex=0><code class=language-python! data-lang=python!>test_dir = os.path.join(data_dir, &#39;train-unresize&#39;)
files = os.listdir(test_dir)
width = 1
max_len = int(1e4)
f2 = &#39;D:/NTU/First Year/Malware Reverse Engineering and Analysis/Homework/Final_Project/Dataset/malimg_dataset/train/&#39;
for idx, fn in enumerate(files):
    fn_wp = os.path.join(test_dir, fn)
    bin_stream = np.fromfile(fn_wp, dtype=&#39;uint8&#39;)
    bin_stream = bin_stream.reshape(bin_stream.shape[0], 1)
    img_shrink = cv2.resize(bin_stream, (width, max_len))
    file_dest = os.path.join(f2, fn)
    img_shrink.tofile(file_dest)

test_dir = os.path.join(data_dir, &#39;validation-unresize&#39;)
files = os.listdir(test_dir)
width = 1
max_len = int(1e4)
f2 = &#39;D:/NTU/First Year/Malware Reverse Engineering and Analysis/Homework/Final_Project/Dataset/malimg_dataset/validation/&#39;
for idx, fn in enumerate(files):
    fn_wp = os.path.join(test_dir, fn)
    bin_stream = np.fromfile(fn_wp, dtype=&#39;uint8&#39;)
    bin_stream = bin_stream.reshape(bin_stream.shape[0], 1)
    img_shrink = cv2.resize(bin_stream, (width, max_len))
    file_dest = os.path.join(f2, fn)
    img_shrink.tofile(file_dest)
</code></pre></li></ol><h4 id=run-directly>Run directly
<a class=anchor href=#run-directly>#</a></h4><p>If you want to plot confusion matrix, then comment some code at the end and add the code below.</p><pre tabindex=0><code class=language-python! data-lang=python!>from sklearn.metrics import confusion_matrix
import matplotlib.pyplot as plt
labels_name = [&#34;Adialer.C&#34;, &#34;Agent.FYI&#34;, &#34;Allaple.A&#34;, &#34;Allaple.L&#34;, &#34;Alueron.gen!J&#34;, &#34;Autorun.K&#34;, &#34;C2LOP.gen!g&#34;, &#34;C2LOP.P&#34;, &#34;Dialplatform.B&#34;, &#34;Dontovo.A&#34;, &#34;Fakerean&#34;, &#34;Instantaccess&#34;, &#34;Lolyda.AA1&#34;, &#34;Lolyda.AA2&#34;, &#34;Lolyda.AA3&#34;, &#34;Lolyda.AT&#34;, &#34;Malex.gen!J&#34;, &#34;Obfuscator.AD&#34;, &#34;Rbot!gen&#34;, &#34;Skintrim.N&#34;, &#34;Swizzor.gen!E&#34;, &#34;Swizzor.gen!I&#34;, &#34;VB.AT&#34;, &#34;Wintrim.BX&#34;, &#34;Yuner.A&#34;]
mat_con = (confusion_matrix(y_true, y_pred, labels=[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]))

# Setting the attributes
fig, px = plt.subplots(figsize=(8, 8))
px.matshow(mat_con, cmap=plt.cm.jet, alpha=0.5)
for m in range(mat_con.shape[0]):
    for n in range(mat_con.shape[1]):
        px.text(x=m,y=n,s=mat_con[m, n], va=&#39;center&#39;, ha=&#39;center&#39;, size=&#39;large&#39;)

# Sets the labels
num_class = np.array(range(len(labels_name)))
plt.xticks(num_class, labels_name, rotation=90, fontsize=10)
plt.yticks(num_class, labels_name, fontsize=10)
# plt.xlabel(&#39;Predictions&#39;, fontsize=16)
# plt.ylabel(&#39;Actuals&#39;, fontsize=16)
plt.title(&#39;Confusion Matrix&#39;, fontsize=15)
plt.savefig(os.path.join(&#39;./Confusion_matrix/&#39;, &#34;output.png&#34;), format=&#39;png&#39;)
plt.show()
</code></pre></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#deep-learning-at-the-shallow-end-malware-classification-for-non-domain-experts>Deep learning at the shallow end Malware classification for non-domain experts</a><ul><li><a href=#how-to-reproduce>How to reproduce?</a></li><li><a href=#how-to-fed-into-malimg-dataset>How to Fed into <code>malimg-dataset</code></a></li></ul></li></ul></nav></div></aside></main></body></html>