<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  NTU Malware Reverse HW 2 write up
  #


  tags: NTU_MR Malware Reverse Engineering and Analysis NTU
  #

[TOC]

  Task 1
  #

執行勒索病毒Dharma與Process monitor並截圖Dharma的Process Tree，並分析說明每個Process行為

Ans:


Conhost.exe: It’s defined by Microsoft and is normally legal and safe. Working on Win7, Win8, and Win10. The main function of this PE file is to let Command Prompt and Windows File Explorer can interact. The other function is to support users who can drag the file or folder to the command prompt directly. Most of the time, it’s a safe file that even repeats execution many times. However, in some circumstances, the viruses will pretend a conhost.exe file to use massive memory or store it in the wrong folder.[1]
"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-mr/ntu-malware-reverse-hw-2-write-up/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="NTU Malware Reverse HW 2 write up"><meta property="og:description" content="NTU Malware Reverse HW 2 write up # tags: NTU_MR Malware Reverse Engineering and Analysis NTU # [TOC]
Task 1 # 執行勒索病毒Dharma與Process monitor並截圖Dharma的Process Tree，並分析說明每個Process行為 Ans:
Conhost.exe: It’s defined by Microsoft and is normally legal and safe. Working on Win7, Win8, and Win10. The main function of this PE file is to let Command Prompt and Windows File Explorer can interact. The other function is to support users who can drag the file or folder to the command prompt directly. Most of the time, it’s a safe file that even repeats execution many times. However, in some circumstances, the viruses will pretend a conhost.exe file to use massive memory or store it in the wrong folder.[1]"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="NTU_MR"><meta property="article:tag" content="Malware Reverse Engineering and Analysis"><meta property="article:tag" content="NTU"><title>NTU Malware Reverse HW 2 write up | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-mr/ntu-malware-reverse-hw-2-write-up/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>NTU Malware Reverse HW 2 write up</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#task-1>Task 1</a></li><li><a href=#task-2>Task 2</a></li><li><a href=#task-3>Task 3</a></li><li><a href=#task-4>Task 4</a></li><li><a href=#reference>Reference</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=ntu-malware-reverse-hw-2-write-up>NTU Malware Reverse HW 2 write up
<a class=anchor href=#ntu-malware-reverse-hw-2-write-up>#</a></h1><h6 id=tags-ntu_mr-malware-reverse-engineering-and-analysis-ntu>tags: <code>NTU_MR</code> <code>Malware Reverse Engineering and Analysis</code> <code>NTU</code>
<a class=anchor href=#tags-ntu_mr-malware-reverse-engineering-and-analysis-ntu>#</a></h6><p>[TOC]</p><h2 id=task-1>Task 1
<a class=anchor href=#task-1>#</a></h2><p>執行勒索病毒<code>Dharma</code>與Process monitor並截圖<code>Dharma</code>的Process Tree，並分析說明每個Process行為
<img src=https://imgur.com/vzb9g9O.png alt>
Ans:</p><ul><li><p><code>Conhost.exe</code>: It’s defined by Microsoft and is normally legal and safe. Working on <code>Win7</code>, <code>Win8</code>, and <code>Win10</code>. The main function of this PE file is to let Command Prompt and Windows File Explorer can interact. The other function is to support users who can drag the file or folder to the command prompt directly. Most of the time, it’s a safe file that even repeats execution many times. However, in some circumstances, the viruses will pretend a <code>conhost.exe</code> file to use massive memory or store it in the wrong folder.[1]
<img src=https://imgur.com/xQayXgX.png alt></p></li><li><p>mode.com: MODE sets the mode of operation for devices or communications. It can be used to set the mode for printers, monitors, or the serial interface. It can be used to prepare and select code pages and to redirect printer output to the serial interface.[2] You can see in the command below that the virus wants to select code page #1251.[3]
<img src=https://imgur.com/wA1k8hF.png alt></p></li><li><p><code>vssadmin.exe</code>: To display current volume shadow copy[4] backups and all installed shadow copy writers and providers. Applied to <code>Win10</code> and other server-type OS. As the website said, this program will not execute automatically when the operating system startup. These kinds of programs are normally malware, such as viruses, <code>trojan horses</code>, and spyware.[5]
<img src=https://imgur.com/PckhSra.png alt></p></li><li><p><code>mshta.exe</code>: It’s an executable file in Windows and this element is the object that starts the Microsoft HTML application. This application mainly executes a <code>.hta</code> file and runs a script in Windows.[6]</p></li><li><p>There is a growing trend for attackers to heavily utilize tools that already exist on a system rather than relying totally on their custom malware. Using <code>.hta</code> files or its partner in crime, <code>mshta.exe</code> is an alternative to using macro-enabled document for attacks and has been around for a long time. It is a tool so flexible it even has its cell on the <code>MITRE ATT&amp;CK matrix</code>.[7]
<img src=https://imgur.com/Lsnv5ve.png alt></p></li><li><p><code>rundll32.exe</code>: It mainly executes the libraries in a <code>.dll</code> file with 32-bits.[8]
<img src=https://imgur.com/QMWZzw9.png alt></p></li><li><p>The <code>autorun</code> technique is as below. The <code>ransomware</code> will set the value in the <code>autorun</code> registry that will execute when the computer startup automatically. It’ll execute the <code>RegSetValue</code> function to set itself in the <code>autorun</code> key (snapshot is as below).
<img src=https://imgur.com/DqrZhJo.png alt>
<img src=https://imgur.com/eYQNEgK.png alt></p></li></ul><h2 id=task-2>Task 2
<a class=anchor href=#task-2>#</a></h2><p>請解釋<code>MITRE ATT&amp;CK</code>中的 <code>T1490: Inhibit System Recovery</code>的Technique為何？如何偵測與防禦，並且在<code>Dharma</code>勒索病毒中找到攻擊的指令截圖
Ans:</p><ul><li><p>As you can see below, it executes this command line which will delete or remove built-in operating system data and turn off the services that mainly to recover a corrupted system. This may deny access to available backups and recovery options.
Operating systems may contain features that can help fix corrupted systems, such as a backup catalog, volume shadow copies, and automatic repair features. Adversaries may disable or delete system recovery features to augment the effects of Data Destruction and Data Encrypted for Impact.[9]
That is, it’ll increase the difficulty that recovering your files with data rescue software or services.</p></li><li><p>So, how to detect? There’re 4 types of techniques to detect this process such as
• Use process monitoring to monitor the execution and command line parameters
• using the Windows event logs,
• monitoring the status of services involved in a system recovery or
• monitoring the registry for changes associated with system recovery features
The mitigation is data backuping or considering technical controls to prevent the disabling of services or deletion of files involved in the system recovery.
<img src=https://imgur.com/L3ACypk.png alt></p></li></ul><h2 id=task-3>Task 3
<a class=anchor href=#task-3>#</a></h2><p>執行勒索病毒<code>Sodinokibi</code>與Process monitor並找到<code>MITRE ATT&amp;CK</code>中的 <code>T1490: Inhibit System Recovery</code>的Technique攻擊的指令截圖證明
Ans:</p><ul><li>It’ll get a window object named <code>Win32_shadowcopy</code> and delete the backup files for each object just like Dharma. It just encrypts the command and bypasses the malware defender.
<img src=https://imgur.com/kIofmwM.png alt></li></ul><h2 id=task-4>Task 4
<a class=anchor href=#task-4>#</a></h2><p>執行勒索病毒<code>Sodinokibi</code>與Process monitor並將它所使用的<code>MITRE ATT&amp;CK</code>的Technique列於下表(不夠請自行新增表格欄位)
Ans:</p><ul><li>As [10, 11] mentioned, the techniques that <code>Sodinokibi</code> has used are as below. But I can not actually find the event by process monitor of my poor usage skill.<table><thead><tr><th style=text-align:left>Technique名稱</th><th style=text-align:left>Technique說明</th></tr></thead><tbody><tr><td style=text-align:left>Command and Scripting Interpreter</td><td style=text-align:left>The macro in the Word document downloads and runs the <code>Sodinokibi</code> executable. After execution, it runs the following command using <code>cmd.exe</code>. <code>REvil</code> has used <code>PowerShell</code> to delete volume shadow copies and download files.</td></tr><tr><td style=text-align:left>Inhibit System Recovery</td><td style=text-align:left><code>REvil</code> can use <code>vssadmin</code> to delete volume shadow copies and credit to disable recovery features. At first, this command runs <code>vssadmin.exe</code> to delete all volume shadow copies on the system to prevent recovery. Then, it uses <code>bcdedit.exe</code> twice to disable automatic Windows recovery features by modifying boot configuration data.</td></tr><tr><td style=text-align:left>Data Encrypted for Impact</td><td style=text-align:left><code>REvil</code> can encrypt files on victim systems and demands a ransom to decrypt the files. Like most <code>ransomware</code>, <code>Sodinokibi</code> encrypts files and adds a random extension such as <code>test.jpg.1cd8t9ahd5</code>.</td></tr></tbody></table></li></ul><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><ol><li>蒂姆費舍爾. 什麼是Conhost.exe？. Available from: <a href=https://zhtw.eyewated.com/%E4%BB%80%E9%BA%BC%E6%98%AFconhost-exe%EF%BC%9F/>https://zhtw.eyewated.com/%E4%BB%80%E9%BA%BC%E6%98%AFconhost-exe%EF%BC%9F/</a>.</li><li>mode.com in Microsoft. Available from: <a href=https://home.csulb.edu/~murdock/mode.html>https://home.csulb.edu/~murdock/mode.html</a>.</li><li>MS-DOS and Windows command line mode command. Available from: <a href=https://www.computerhope.com/modehlp.htm>https://www.computerhope.com/modehlp.htm</a>.</li><li>Volume Shadow Copy Service. Available from: <a href=https://zh.m.wikipedia.org/wiki/%E7%A3%81%E7%A2%9F%E5%8D%80%E9%99%B0%E5%BD%B1%E8%A4%87%E8%A3%BD%E6%9C%8D%E5%8B%99>https://zh.m.wikipedia.org/wiki/%E7%A3%81%E7%A2%9F%E5%8D%80%E9%99%B0%E5%BD%B1%E8%A4%87%E8%A3%BD%E6%9C%8D%E5%8B%99</a>.</li><li>vssadmin.exe in Microsoft. Available from: <a href=http://startup.filedict.com/vssadmin-vssadmin-exe-8854-8860/>http://startup.filedict.com/vssadmin-vssadmin-exe-8854-8860/</a>.</li><li>mshta.exe Microsoft (R) HTML 主應用程式. Available from: <a href=https://win10.support/zh_tw/mshta-exe-microsoft-r-html-%E4%B8%BB%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/>https://win10.support/zh_tw/mshta-exe-microsoft-r-html-%E4%B8%BB%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F/</a>.</li><li>What Is Mshta, How Can It Be Used and How to Protect Against It. Available from: <a href=https://www.mcafee.com/blogs/other-blogs/mcafee-labs/what-is-mshta-how-can-it-be-used-and-how-to-protect-against-it/>https://www.mcafee.com/blogs/other-blogs/mcafee-labs/what-is-mshta-how-can-it-be-used-and-how-to-protect-against-it/</a>.</li><li>rundll32:Rundll32.exe是什麼？. Available from: <a href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=&amp;cad=rja&amp;uact=8&amp;ved=2ahUKEwjAps7IlYX7AhWqQfUHHbylBOAQFnoECBUQAQ&amp;url=https%3A%2F%2Fwww.easyatm.com.tw%2Fwiki%2Frundll32&amp;usg=AOvVaw2fLPE4XLV2J1RaPX3e0fo4">https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&cad=rja&uact=8&ved=2ahUKEwjAps7IlYX7AhWqQfUHHbylBOAQFnoECBUQAQ&url=https%3A%2F%2Fwww.easyatm.com.tw%2Fwiki%2Frundll32&usg=AOvVaw2fLPE4XLV2J1RaPX3e0fo4</a>.</li><li>Inhibit System Recovery. Available from: <a href=https://attack.mitre.org/techniques/T1490/>https://attack.mitre.org/techniques/T1490/</a>.</li><li>A brief history and further technical analysis of Sodinokibi Ransomware. 2020; Available from: <a href=https://www.picussecurity.com/resource/blog/a-brief-history-and-further-technical-analysis-of-sodinokibi-ransomware>https://www.picussecurity.com/resource/blog/a-brief-history-and-further-technical-analysis-of-sodinokibi-ransomware</a>.</li><li>REvil. 2020; Available from: <a href=https://attack.mitre.org/software/S0496/>https://attack.mitre.org/software/S0496/</a>.</li></ol></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#task-1>Task 1</a></li><li><a href=#task-2>Task 2</a></li><li><a href=#task-3>Task 3</a></li><li><a href=#task-4>Task 4</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside></main></body></html>