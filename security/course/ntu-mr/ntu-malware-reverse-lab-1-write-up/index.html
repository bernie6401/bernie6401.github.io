<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  NTU Malware Reverse Lab 1 write up
  #


  tags: NTU_MR Malware Reverse Engineering and Analysis NTU
  #


  
      
          Name
          何秉學
          StuID
          R11921A16
      
  
  
  


  WannaCry
  #


  Change variable and data type
  #


Follow the video and replace most of the variable that ghidra did not recognize and retype them also.
According to the video, you must search the entry point function(local_6c = FUN_00408140();) first and replace the signature by here
Then click into WinMain function and you&rsquo;ll see a strange url at the beginning of the top. Try to rename and retype it as char*.
Ghidra can not recognize InternetOpenA, and InternetOpenUrlA. But you can found that ghidra cannot recognize hinternet datatype as well. So, we must create new datatype in Datt Type Manager.
And in write_1831_to_tasksche.exe  function, the first if-statement has 4 variable that ghidra can&rsquo;t recognize, including createProcessA, _createFileA, _writeFile, _closeHandle. So, you&rsquo;re not only rename them but retype them for the following statement for each of them.(Ghidra has all type of them but it just can not recognize.)
When you have 1831.bin file(you can follow Analyze part at 5-th and 6-th section), useing Defined String window to check out some function including unzip_something function.
Scroll down the Defined String, you&rsquo;ll see string 13AM4VW2dhxYgXeQepoHkHSQuy6NgaEb94 at 0x0040f488. Then in assembly code, there&rsquo;re 3 similar function be called at the sametime. We called it bitcoin_something function.


  Analyze
  #


For the first part to analyze, you can check out for loop after strange_url variable. It does this loop for 14 times and copy strange_url to strange_url_copy by andding 4.
Next, you can find an if statement at the below. Check this out carefully, it the internet request failed, it&rsquo;ll access wannacry_real_entry() function.
Enter to wannacry_real_entry function, you&rsquo;ll see another if statement to examine your argument input. If you keyin less than 1 argument, it&rsquo;ll execute no_argument_handler function and start create_wannacry_service function.
Checking wannacry program in second function of no_argument_handler function by assembly language, you&rsquo;ll find there&rsquo;re two sprintf structure are not correct in the middle paragraph. Because, there&rsquo;re two more argument should be pushed in stack but not be recognized by ghidra, including s_tasksche.exe_0043136c and 0x00407dea and s_WINDOWS_00431367 at 0x00407df2. So, we have to override this line signature and add the remaining argument back to sprinf.

So, let&rsquo;s take a look at this flow chart of what happened so far 
Then I used another VM(Ubuntu) to command wrestool to analyze wannacry file and output another file named 1831.bin. Using ghidra to analyze this file. Then do the same thing as above that what we do to analyze wannacry file such as change WinMain signature or renamee variable or retype variable, etc.
While you&rsquo;re analyzing in WinMain function, you&rsquo;ll see a strange variable &_Str2_0040f538 which store &lsquo;/i&rsquo; characters. You can just press &lsquo;c&rsquo; in assembly code to show &lsquo;\i&rsquo;.
Next, scroll down this file, you&rsquo;ll see a strange swprintf parameter called _Count_0040f40c. Then select all addr type data and right click mouse and select clear with option. You&rsquo;ll see many unicode strings. Finally, right click DAT_0040f40c and choose Data/TerminatedUnicode.
Finally, you can check this figure to know the whole operation flow 

1.1 What is the &lsquo;killswitch&rsquo; string?
Ans: http://www.iuqerfsodp9ifjaposdfj
1.2 What is the unzip password? (as show in below)
Ans: WNcry@2o17"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/course/ntu-mr/ntu-malware-reverse-lab-1-write-up/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="NTU Malware Reverse Lab 1 write up"><meta property="og:description" content="NTU Malware Reverse Lab 1 write up # tags: NTU_MR Malware Reverse Engineering and Analysis NTU # Name 何秉學 StuID R11921A16 WannaCry # Change variable and data type # Follow the video and replace most of the variable that ghidra did not recognize and retype them also. According to the video, you must search the entry point function(local_6c = FUN_00408140();) first and replace the signature by here Then click into WinMain function and you’ll see a strange url at the beginning of the top. Try to rename and retype it as char*. Ghidra can not recognize InternetOpenA, and InternetOpenUrlA. But you can found that ghidra cannot recognize hinternet datatype as well. So, we must create new datatype in Datt Type Manager. And in write_1831_to_tasksche.exe function, the first if-statement has 4 variable that ghidra can’t recognize, including createProcessA, _createFileA, _writeFile, _closeHandle. So, you’re not only rename them but retype them for the following statement for each of them.(Ghidra has all type of them but it just can not recognize.) When you have 1831.bin file(you can follow Analyze part at 5-th and 6-th section), useing Defined String window to check out some function including unzip_something function. Scroll down the Defined String, you’ll see string 13AM4VW2dhxYgXeQepoHkHSQuy6NgaEb94 at 0x0040f488. Then in assembly code, there’re 3 similar function be called at the sametime. We called it bitcoin_something function. Analyze # For the first part to analyze, you can check out for loop after strange_url variable. It does this loop for 14 times and copy strange_url to strange_url_copy by andding 4. Next, you can find an if statement at the below. Check this out carefully, it the internet request failed, it’ll access wannacry_real_entry() function. Enter to wannacry_real_entry function, you’ll see another if statement to examine your argument input. If you keyin less than 1 argument, it’ll execute no_argument_handler function and start create_wannacry_service function. Checking wannacry program in second function of no_argument_handler function by assembly language, you’ll find there’re two sprintf structure are not correct in the middle paragraph. Because, there’re two more argument should be pushed in stack but not be recognized by ghidra, including s_tasksche.exe_0043136c and 0x00407dea and s_WINDOWS_00431367 at 0x00407df2. So, we have to override this line signature and add the remaining argument back to sprinf. So, let’s take a look at this flow chart of what happened so far Then I used another VM(Ubuntu) to command wrestool to analyze wannacry file and output another file named 1831.bin. Using ghidra to analyze this file. Then do the same thing as above that what we do to analyze wannacry file such as change WinMain signature or renamee variable or retype variable, etc. While you’re analyzing in WinMain function, you’ll see a strange variable &_Str2_0040f538 which store ‘/i’ characters. You can just press ‘c’ in assembly code to show ‘\i’. Next, scroll down this file, you’ll see a strange swprintf parameter called _Count_0040f40c. Then select all addr type data and right click mouse and select clear with option. You’ll see many unicode strings. Finally, right click DAT_0040f40c and choose Data/TerminatedUnicode. Finally, you can check this figure to know the whole operation flow 1.1 What is the ‘killswitch’ string? Ans: http://www.iuqerfsodp9ifjaposdfj 1.2 What is the unzip password? (as show in below) Ans: WNcry@2o17"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="NTU_MR"><meta property="article:tag" content="Malware Reverse Engineering and Analysis"><meta property="article:tag" content="NTU"><title>NTU Malware Reverse Lab 1 write up | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/course/ntu-mr/ntu-malware-reverse-lab-1-write-up/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>NTU Malware Reverse Lab 1 write up</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#wannacry>WannaCry</a><ul><li><a href=#change-variable-and-data-type>Change variable and data type</a></li><li><a href=#analyze>Analyze</a></li></ul></li><li><a href=#norepls>NoREpls</a><ul><li><a href=#step1---checking-language>Step1 - Checking Language</a></li><li><a href=#step2---static-analysis>Step2 - Static Analysis</a></li></ul></li><li><a href=#untitiled>Untitiled</a><ul><li><a href=#refer-to-b1h0>Refer to <a href=https://github.com/gabimarti/crackmes-solutions/blob/master/crackmes.one/evilprogrammer-mexican/b1h0-evilprogrammer-mexican.md>b1h0</a></a></li><li><a href=#step1---try-to-run>Step1 - Try to run</a></li><li><a href=#step2---use-x64dbg-debugger>Step2 - Use x64dbg debugger</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=ntu-malware-reverse-lab-1-write-up>NTU Malware Reverse Lab 1 write up
<a class=anchor href=#ntu-malware-reverse-lab-1-write-up>#</a></h1><h6 id=tags-ntu_mr-malware-reverse-engineering-and-analysis-ntu>tags: <code>NTU_MR</code> <code>Malware Reverse Engineering and Analysis</code> <code>NTU</code>
<a class=anchor href=#tags-ntu_mr-malware-reverse-engineering-and-analysis-ntu>#</a></h6><table><thead><tr><th>Name</th><th>何秉學</th><th>StuID</th><th>R11921A16</th></tr></thead><tbody></tbody></table><h2 id=wannacry>WannaCry
<a class=anchor href=#wannacry>#</a></h2><h3 id=change-variable-and-data-type>Change variable and data type
<a class=anchor href=#change-variable-and-data-type>#</a></h3><ul><li>Follow the video and replace most of the variable that ghidra did not recognize and retype them also.</li><li>According to the video, you must search the entry point function(local_6c = FUN_00408140();) first and replace the signature by <a href=https://learn.microsoft.com/zh-tw/windows/win32/learnwin32/winmain--the-application-entry-point>here</a></li><li>Then click into WinMain function and you&rsquo;ll see a strange url at the beginning of the top. Try to rename and retype it as char*.</li><li>Ghidra can not recognize <a href=https://learn.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetopena>InternetOpenA</a>, and <a href=https://learn.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetopenurla>InternetOpenUrlA</a>. But you can found that ghidra cannot recognize hinternet datatype as well. So, we must create new datatype in Datt Type Manager.</li><li>And in write_1831_to_tasksche.exe function, the first if-statement has 4 variable that ghidra can&rsquo;t recognize, including createProcessA, _createFileA, _writeFile, _closeHandle. So, you&rsquo;re not only rename them but retype them for the following statement for each of them.(Ghidra has all type of them but it just can not recognize.)</li><li>When you have 1831.bin file(you can follow Analyze part at 5-th and 6-th section), useing <strong>Defined String</strong> window to check out some function including unzip_something function.</li><li>Scroll down the <strong>Defined String</strong>, you&rsquo;ll see string <strong>13AM4VW2dhxYgXeQepoHkHSQuy6NgaEb94</strong> at 0x0040f488. Then in assembly code, there&rsquo;re 3 similar function be called at the sametime. We called it bitcoin_something function.</li></ul><h3 id=analyze>Analyze
<a class=anchor href=#analyze>#</a></h3><ul><li>For the first part to analyze, you can check out for loop after strange_url variable. It does this loop for 14 times and copy strange_url to strange_url_copy by andding 4.</li><li>Next, you can find an if statement at the below. Check this out carefully, it the internet request failed, it&rsquo;ll access wannacry_real_entry() function.</li><li>Enter to wannacry_real_entry function, you&rsquo;ll see another if statement to examine your argument input. If you keyin less than 1 argument, it&rsquo;ll execute no_argument_handler function and start create_wannacry_service function.</li><li>Checking wannacry program in second function of no_argument_handler function by assembly language, you&rsquo;ll find there&rsquo;re two sprintf structure are not correct in the middle paragraph. Because, there&rsquo;re two more argument should be pushed in stack but not be recognized by ghidra, including s_tasksche.exe_0043136c and 0x00407dea and s_WINDOWS_00431367 at 0x00407df2. So, we have to override this line signature and add the remaining argument back to sprinf.
<img src=https://imgur.com/HE2vWWo.png alt="2 arguments did not be recognized"></li><li>So, let&rsquo;s take a look at this flow chart of what happened so far <img src=https://imgur.com/JtLrxwf.png alt="flow chart of first stage"></li><li>Then I used another VM(Ubuntu) to command wrestool to analyze wannacry file and output another file named 1831.bin. Using ghidra to analyze this file. Then do the same thing as above that what we do to analyze wannacry file such as change WinMain signature or renamee variable or retype variable, etc.</li><li>While you&rsquo;re analyzing in WinMain function, you&rsquo;ll see a strange variable &_Str2_0040f538 which store &lsquo;/i&rsquo; characters. You can just press &lsquo;c&rsquo; in assembly code to show &lsquo;\i&rsquo;.</li><li>Next, scroll down this file, you&rsquo;ll see a strange swprintf parameter called _Count_0040f40c. Then select all addr type data and right click mouse and select <strong>clear with option</strong>. You&rsquo;ll see many unicode strings. Finally, right click DAT_0040f40c and choose Data/TerminatedUnicode.</li><li>Finally, you can check this figure to know the whole operation flow <img src=https://imgur.com/P00ObJZ.png alt="whole flow chart of wannacry"></li></ul><p>1.1 What is the &lsquo;killswitch&rsquo; string?
Ans: <a href=http://www.iuqerfsodp>http://www.iuqerfsodp</a>9ifjaposdfj
1.2 What is the unzip password? (as show in below)
Ans: WNcry@2o17</p><h2 id=norepls>NoREpls
<a class=anchor href=#norepls>#</a></h2><h3 id=step1---checking-language>Step1 - Checking Language
<a class=anchor href=#step1---checking-language>#</a></h3><ul><li>You should check what lauguage of this program, so load it in IDA and see the import.<img src=https://imgur.com/xEoJhw4.png alt="import of NoREpls.exe"> You can find a lot of functions that resemble C functions such as CreateFileW() and isDebuggerPresent function here as well.->This is important</li></ul><h3 id=step2---static-analysis>Step2 - Static Analysis
<a class=anchor href=#step2---static-analysis>#</a></h3><ul><li>Try to run NoREpls.exe.
<img src=https://imgur.com/2jUCFWL.png alt="run NoREpls.exe"></li><li>Then you can view string window to find the function that prompt the invalid registration. However, here&rsquo;s nothing useful info but a lot of random code. Try to search the string in Name window and we found this.<img src=https://imgur.com/woGONy5.png alt="string in Name window"></li><li>Clicking in it, you&rsquo;ll find important string here.<img src=https://imgur.com/iouRoVv.png alt="string in code"></li><li>Use x-ref to jump to the section in which to call this string.<img src=https://imgur.com/n3VTB6n.png alt="function which called the string"></li><li>You&rsquo;ll see the lable of this section 0x4010DB. So, let&rsquo;s use x-ref method again to jump to where to called.<img src=https://imgur.com/RZunVmt.png alt="jump again"></li><li>Then press f5 to disassemble this section and you&rsquo;ll see the function.<img src=https://imgur.com/EY0aPrE.png alt="checking function"></li><li>Press into sub_401000 function and see an unencrypt secret code here.<img src=https://imgur.com/b3LT1Xe.png alt="secret code"></li><li>Then you got the secret code and registered it successfully<img src=https://imgur.com/OxuKg5o.png alt=successful></li></ul><h2 id=untitiled>Untitiled
<a class=anchor href=#untitiled>#</a></h2><h3 id=refer-to-b1h0>Refer to <a href=https://github.com/gabimarti/crackmes-solutions/blob/master/crackmes.one/evilprogrammer-mexican/b1h0-evilprogrammer-mexican.md>b1h0</a>
<a class=anchor href=#refer-to-b1h0>#</a></h3><h3 id=step1---try-to-run>Step1 - Try to run
<a class=anchor href=#step1---try-to-run>#</a></h3><ul><li>When you tried to run this program，it just flashed a little bit time and vanished rapidly. Then you can use dbg(debugger) to set a broken point.</li></ul><h3 id=step2---use-x64dbg-debugger>Step2 - Use x64dbg debugger
<a class=anchor href=#step2---use-x64dbg-debugger>#</a></h3><ul><li>Actually, when you entry the program, you&rsquo;ll find the flag easily down below the entry point a little bit.</li><li>So, based on the truth we found above, you can observe the address 0x00401500 is as the entry of subroutine that we called sub_result_cracked<img src=https://imgur.com/nky2a3B.png alt=sub_result_cracked></li><li>Then we can find address 0x004013DD called address 0x0040162c that aimed to compare the important value. The command line will print the flag or try_harder depends on this important value.</li><li>So, we can take a look next.<img src=https://imgur.com/oa1XQpK.png alt="compare part">You can focus at 0x0040163A that move C1 to memory and then compare itself at the following command.</li><li>Review what is jle you can take a look at <a href=https://www.796t.com/content/1547538585.html>here</a>. As the default, it&rsquo;ll jump to 0x401653 for sure and move string &ldquo;try harder&rdquo; and print it out.</li><li>So, the first point is we must let the statement false by revise the value of C1 at 0x00401642 like this.<img src=https://imgur.com/tw2Ajit.png alt="revise C1"> You can revise any value that make the statement false. Here is following b1H0 to revise zero.</li><li>Bypass the jump statement, then we must set another breakpoint at 0x00401664 to watch the print out before the program closed.<img src=https://imgur.com/Px3WhS4.png alt="successful result"></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#wannacry>WannaCry</a><ul><li><a href=#change-variable-and-data-type>Change variable and data type</a></li><li><a href=#analyze>Analyze</a></li></ul></li><li><a href=#norepls>NoREpls</a><ul><li><a href=#step1---checking-language>Step1 - Checking Language</a></li><li><a href=#step2---static-analysis>Step2 - Static Analysis</a></li></ul></li><li><a href=#untitiled>Untitiled</a><ul><li><a href=#refer-to-b1h0>Refer to <a href=https://github.com/gabimarti/crackmes-solutions/blob/master/crackmes.one/evilprogrammer-mexican/b1h0-evilprogrammer-mexican.md>b1h0</a></a></li><li><a href=#step1---try-to-run>Step1 - Try to run</a></li><li><a href=#step2---use-x64dbg-debugger>Step2 - Use x64dbg debugger</a></li></ul></li></ul></nav></div></aside></main></body></html>