<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  PicoCTF - Java Code Analysis!?!
  #


  Background
  #

JWT

  Source code
  #

Too Much to list

  Hint
  #


Maybe try to find the JWT Signing Key (&ldquo;secret key&rdquo;) in the source code? Maybe it&rsquo;s hardcoded somewhere? Or maybe try to crack it?
The &lsquo;role&rsquo; and &lsquo;userId&rsquo; fields in the JWT can be of interest to you!
The &lsquo;controllers&rsquo;, &lsquo;services&rsquo; and &lsquo;security&rsquo; java packages in the given source code might need your attention. We&rsquo;ve provided a README.md file that contains some documentation.
Upgrade your &lsquo;role&rsquo; with the new (cracked) JWT. And re-login for the new role to get reflected in browser&rsquo;s localStorage.


  Recon
  #

這一題在AIS3 pre-exam的時候也有看到，但當時根本沒想法，只要題目看起來一複雜我就沒辦法分析了，所以還是看了Martin大的WP才知道解法，但有時候真的很考驗耐心，先看hint發現應該是考跟JWT有關"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/practice/picoctf/web/picoctf---java-code-analysis_/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="PicoCTF - Java Code Analysis!?!"><meta property="og:description" content="PicoCTF - Java Code Analysis!?! # Background # JWT
Source code # Too Much to list
Hint # Maybe try to find the JWT Signing Key (“secret key”) in the source code? Maybe it’s hardcoded somewhere? Or maybe try to crack it? The ‘role’ and ‘userId’ fields in the JWT can be of interest to you! The ‘controllers’, ‘services’ and ‘security’ java packages in the given source code might need your attention. We’ve provided a README.md file that contains some documentation. Upgrade your ‘role’ with the new (cracked) JWT. And re-login for the new role to get reflected in browser’s localStorage. Recon # 這一題在AIS3 pre-exam的時候也有看到，但當時根本沒想法，只要題目看起來一複雜我就沒辦法分析了，所以還是看了Martin大的WP才知道解法，但有時候真的很考驗耐心，先看hint發現應該是考跟JWT有關"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="PicoCTF"><meta property="article:tag" content="CTF"><meta property="article:tag" content="Web"><title>PicoCTF - Java Code Analysis!?! | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/practice/picoctf/web/picoctf---java-code-analysis_/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>PicoCTF - Java Code Analysis!?!</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a></li><li><a href=#hint>Hint</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit---jwt>Exploit - JWT</a></li><li><a href=#reference>Reference</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=picoctf---java-code-analysis>PicoCTF - Java Code Analysis!?!
<a class=anchor href=#picoctf---java-code-analysis>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p>JWT</p><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><p>Too Much to list</p><h2 id=hint>Hint
<a class=anchor href=#hint>#</a></h2><ul><li>Maybe try to find the JWT Signing Key (&ldquo;secret key&rdquo;) in the source code? Maybe it&rsquo;s hardcoded somewhere? Or maybe try to crack it?</li><li>The &lsquo;role&rsquo; and &lsquo;userId&rsquo; fields in the JWT can be of interest to you!</li><li>The &lsquo;controllers&rsquo;, &lsquo;services&rsquo; and &lsquo;security&rsquo; java packages in the given source code might need your attention. We&rsquo;ve provided a README.md file that contains some documentation.</li><li>Upgrade your &lsquo;role&rsquo; with the new (cracked) JWT. And re-login for the new role to get reflected in browser&rsquo;s localStorage.</li></ul><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><p>這一題在AIS3 pre-exam的時候也有看到，但當時根本沒想法，只要題目看起來一複雜我就沒辦法分析了，所以還是看了Martin大的WP才知道解法，但有時候真的很考驗耐心，先看hint發現應該是考跟JWT有關</p><ol><li>先用user/user登入觀察整個網站
發現書架上只有三本書，而且個別的權限都標註在上面(Free/Premium/Admin)，看起來我們的目標是把自己的權限變成admin然後查看flag這本書
<img src=https://hackmd.io/_uploads/BJJYLGuO3.png alt></li><li>JWT Token
用<a href=https://jwt.io/>online tool</a>查看的結果如下，首要目標是找到HS256的secret key
<img src=https://hackmd.io/_uploads/SkMdvf__3.png alt></li></ol><h2 id=exploit---jwt>Exploit - JWT
<a class=anchor href=#exploit---jwt>#</a></h2><ol><li><p>找Secret key
隨便找找，發現在<code>./src/main/java/io/github/nandandesai/pico/security/models/SecretGenerator.java</code>的SecretGenerator class
:::spoiler Source Code</p><pre tabindex=0><code class=language-java! data-lang=java!>package io.github.nandandesai.pico.security;

import io.github.nandandesai.pico.configs.UserDataPaths;
import io.github.nandandesai.pico.utils.FileOperation;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.nio.charset.Charset;

@Service
class SecretGenerator {
    private Logger logger = LoggerFactory.getLogger(SecretGenerator.class);
    private static final String SERVER_SECRET_FILENAME = &#34;server_secret.txt&#34;;

    @Autowired
    private UserDataPaths userDataPaths;

    private String generateRandomString(int len) {
        // not so random
        return &#34;1234&#34;;
    }

    String getServerSecret() {
        try {
            String secret = new String(FileOperation.readFile(userDataPaths.getCurrentJarPath(), SERVER_SECRET_FILENAME), Charset.defaultCharset());
            logger.info(&#34;Server secret successfully read from the filesystem. Using the same for this runtime.&#34;);
            return secret;
        }catch (IOException e){
            logger.info(SERVER_SECRET_FILENAME+&#34; file doesn&#39;t exists or something went wrong in reading that file. Generating a new secret for the server.&#34;);
            String newSecret = generateRandomString(32);
            try {
                FileOperation.writeFile(userDataPaths.getCurrentJarPath(), SERVER_SECRET_FILENAME, newSecret.getBytes());
            } catch (IOException ex) {
                ex.printStackTrace();
            }
            logger.info(&#34;Newly generated secret is now written to the filesystem for persistence.&#34;);
            return newSecret;
        }
    }
}
</code></pre><p>:::
可以發現作者的註解說not so random，secret key是1234，把key拿到jwt online decoder做驗證，發現signature是正確的</p></li><li><p>Construct a Fake Token
根據hint的說明，我們應該只要改userId和role這兩個欄位如下，切記也要改token-payload如下，就可以更改自己的權限
<img src=https://hackmd.io/_uploads/HJWUqfuun.png alt>
<img src=https://hackmd.io/_uploads/H1-LjzOdh.png alt></p></li></ol><p>Flag: <code>picoCTF{w34k_jwt_n0t_g00d_6e5d7df5}</code></p><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><p><a href=https://youtu.be/tsTkxWxLTqk>picoCTF 2023 Java Code Analysis?!?</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a></li><li><a href=#hint>Hint</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit---jwt>Exploit - JWT</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside></main></body></html>