<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='
  PicoCTF - Compress and Attack
  #


  tags: PicoCTF CTF Crypto
  #


  Background
  #


zlib compression property
詳細說明一下zlib的壓縮特性是當壓縮的內容出現重複字元的時候，壓縮過後的長度會不變

>>> import zlib
>>> enc = zlib.compress(bytes("picoCTF{picoCTF{testing_123456}".encode("utf-8")))
>>> len(enc)
33
>>> enc = zlib.compress(bytes("picoCTF{tepicoCTF{testing_123456}".encode("utf-8")))
>>> len(enc)
33
>>> enc = zlib.compress(bytes("picoCTF{tekpicoCTF{testing_123456}".encode("utf-8")))
>>> len(enc)
34
此時重複的部分就是picoCTF{，若是繼續增加重複的部分(例如：picoCTF{te)，壓縮後的長度也不會變，這樣就可以當作一個oracle，也就是利用長度來判斷增加的字元是不是flag重複的一部分

  Source code
  #

:::spoiler
#!/usr/bin/python3 -u

import zlib
from random import randint
import os
from Crypto.Cipher import Salsa20

flag = open("./flag").read()


def compress(text):
    return zlib.compress(bytes(text.encode("utf-8")))

def encrypt(plaintext):
    secret = os.urandom(32)
    cipher = Salsa20.new(key=secret)
    return cipher.nonce + cipher.encrypt(plaintext)

def main():
    while True:
        usr_input = input("Enter your text to be encrypted: ")
        compressed_text = compress(flag + usr_input)
        encrypted = encrypt(compressed_text)
        
        nonce = encrypted[:8]
        encrypted_text =  encrypted[8:]
        print(nonce)
        print(encrypted_text)
        print(len(encrypted_text))

if __name__ == &#39;__main__&#39;:
    main()
:::'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/practice/picoctf/crypto/picoctf---compress-and-attack/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="PicoCTF - Compress and Attack"><meta property="og:description" content='PicoCTF - Compress and Attack # tags: PicoCTF CTF Crypto # Background # zlib compression property 詳細說明一下zlib的壓縮特性是當壓縮的內容出現重複字元的時候，壓縮過後的長度會不變 >>> import zlib >>> enc = zlib.compress(bytes("picoCTF{picoCTF{testing_123456}".encode("utf-8"))) >>> len(enc) 33 >>> enc = zlib.compress(bytes("picoCTF{tepicoCTF{testing_123456}".encode("utf-8"))) >>> len(enc) 33 >>> enc = zlib.compress(bytes("picoCTF{tekpicoCTF{testing_123456}".encode("utf-8"))) >>> len(enc) 34 此時重複的部分就是picoCTF{，若是繼續增加重複的部分(例如：picoCTF{te)，壓縮後的長度也不會變，這樣就可以當作一個oracle，也就是利用長度來判斷增加的字元是不是flag重複的一部分
Source code # :::spoiler
#!/usr/bin/python3 -u import zlib from random import randint import os from Crypto.Cipher import Salsa20 flag = open("./flag").read() def compress(text): return zlib.compress(bytes(text.encode("utf-8"))) def encrypt(plaintext): secret = os.urandom(32) cipher = Salsa20.new(key=secret) return cipher.nonce + cipher.encrypt(plaintext) def main(): while True: usr_input = input("Enter your text to be encrypted: ") compressed_text = compress(flag + usr_input) encrypted = encrypt(compressed_text) nonce = encrypted[:8] encrypted_text = encrypted[8:] print(nonce) print(encrypted_text) print(len(encrypted_text)) if __name__ == &#39;__main__&#39;: main() :::'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="PicoCTF"><meta property="article:tag" content="CTF"><meta property="article:tag" content="Crypto"><title>PicoCTF - Compress and Attack | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/practice/picoctf/crypto/picoctf---compress-and-attack/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>PicoCTF - Compress and Attack</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit>Exploit</a></li><li><a href=#reference>Reference</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=picoctf---compress-and-attack>PicoCTF - Compress and Attack
<a class=anchor href=#picoctf---compress-and-attack>#</a></h1><h6 id=tags-picoctf-ctf-crypto>tags: <code>PicoCTF</code> <code>CTF</code> <code>Crypto</code>
<a class=anchor href=#tags-picoctf-ctf-crypto>#</a></h6><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><ul><li>zlib compression property
詳細說明一下zlib的壓縮特性是當壓縮的內容出現重複字元的時候，壓縮過後的長度會不變</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt;&gt;&gt; import zlib
</span></span><span style=display:flex><span>&gt;&gt;&gt; enc <span style=color:#f92672>=</span> zlib.compress<span style=color:#f92672>(</span>bytes<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;picoCTF{picoCTF{testing_123456}&#34;</span>.encode<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;utf-8&#34;</span><span style=color:#f92672>)))</span>
</span></span><span style=display:flex><span>&gt;&gt;&gt; len<span style=color:#f92672>(</span>enc<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>33</span>
</span></span><span style=display:flex><span>&gt;&gt;&gt; enc <span style=color:#f92672>=</span> zlib.compress<span style=color:#f92672>(</span>bytes<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;picoCTF{tepicoCTF{testing_123456}&#34;</span>.encode<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;utf-8&#34;</span><span style=color:#f92672>)))</span>
</span></span><span style=display:flex><span>&gt;&gt;&gt; len<span style=color:#f92672>(</span>enc<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>33</span>
</span></span><span style=display:flex><span>&gt;&gt;&gt; enc <span style=color:#f92672>=</span> zlib.compress<span style=color:#f92672>(</span>bytes<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;picoCTF{tekpicoCTF{testing_123456}&#34;</span>.encode<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;utf-8&#34;</span><span style=color:#f92672>)))</span>
</span></span><span style=display:flex><span>&gt;&gt;&gt; len<span style=color:#f92672>(</span>enc<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>34</span>
</span></span></code></pre></div><p>此時重複的部分就是<code>picoCTF{</code>，若是繼續增加重複的部分(例如：<code>picoCTF{te</code>)，壓縮後的長度也不會變，這樣就可以當作一個oracle，也就是利用長度來判斷增加的字元是不是flag重複的一部分</p><h2 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h2><p>:::spoiler</p><pre tabindex=0><code class="language-python=" data-lang="python=">#!/usr/bin/python3 -u

import zlib
from random import randint
import os
from Crypto.Cipher import Salsa20

flag = open(&#34;./flag&#34;).read()


def compress(text):
    return zlib.compress(bytes(text.encode(&#34;utf-8&#34;)))

def encrypt(plaintext):
    secret = os.urandom(32)
    cipher = Salsa20.new(key=secret)
    return cipher.nonce + cipher.encrypt(plaintext)

def main():
    while True:
        usr_input = input(&#34;Enter your text to be encrypted: &#34;)
        compressed_text = compress(flag + usr_input)
        encrypted = encrypt(compressed_text)
        
        nonce = encrypted[:8]
        encrypted_text =  encrypted[8:]
        print(nonce)
        print(encrypted_text)
        print(len(encrypted_text))

if __name__ == &#39;__main__&#39;:
    main()
</code></pre><p>:::</p><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><p>這一題很有趣，可以看一下source code發現他特意把<code>encrypted_text</code>的長度leak出來當作解題的一部分資訊，透過上述提到的<code>zlib</code>特性，可以把這個資訊當成一個oracle</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nc mercury.picoctf.net <span style=color:#ae81ff>33976</span>
</span></span><span style=display:flex><span>Enter your text to be encrypted: p
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#39;0\xc17\x10?%a\xeb&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#34;&#39;\xdf\x99\xb0\xd99dvf\xf6\x88\xbfl\xc3\x10\xff\x16,\xf7*\xad\xb3\xb1\xc7\x94\xaam\xc5\xac\xfat^]\x0e\xd8\xfbV\xed\xdd\xf7\xbe\xb0\xed\x8ff\x9e&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>46</span>
</span></span><span style=display:flex><span>Enter your text to be encrypted: pi
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#39;H\x03l\x16\xb12S\xad&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#39;\xc4\x0c\xb1\x9e{q\x9e\x93Q\xeb\xa5G\xbb\x01%\xe6\x1d4\x96\xf3\r+C4\x1c\xe9-\x99ghC\x0c\xef\xec\xba\xb1\x1b\xfa\xa2\x16\xda\x00\x85tq\x02@&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>47</span>
</span></span><span style=display:flex><span>Enter your text to be encrypted: pic
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#39;\xa4\x81\x7f\xb6\x9e\xadW\xef&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#34;\xd2\xe4\x8a2WY]^0</span>$g<span style=color:#e6db74>\x17\xd0\xe8\xd1\x95\xbd \x9eX+\x06\xf8\xcc\x8e\xa8\xfa\xdf\xb3\xac:k\x15\xdb\xa0#&#39;\xb7\xf7^\x06\xce!it\x11\xdd\xa3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>48</span>
</span></span><span style=display:flex><span>Enter your text to be encrypted: pico
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#39;&lt;\x06\x8f\x18\xcf\xf3\x91\x11&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#39;\x84k\xc9\xf4~\x81\xdar\x9bR\x08\x87K\xb7\x1c\xda\x18\x08+\xc1\xfa\x9c\xce\xe1\x7f\x93\xd9\xe6\xf4Jmv\x08\x9b\xaa\xb4\xc0\xb6\xa6f\xdb\x9acF\x0e\x8eF\x98&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>48</span>
</span></span><span style=display:flex><span>Enter your text to be encrypted: picoC
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#39;\x18\x07\xd4&#34;C\x94\xd8\xfe&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#39;g\tWkH\x10\xa4\x8a\x80\xcc\xd8\x94\x02\x08T\x93AV\x0f\x97\xca\x82\xf3\xd1\xd8\xb0\r\xb2\x05\xc6\xbe{\x00\xd8\xc4\xbd\x84\x0fn\x14\xb6\xcf|\x15\xf5\xf2\xf9l&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>48</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>透過上述測試，可以判斷長度應該就是固定48，此時我們就可以依序加入guessing character，並透過oracle判斷加入的字元是對的還是錯的</p><h2 id=exploit>Exploit
<a class=anchor href=#exploit>#</a></h2><pre tabindex=0><code class="language-python=" data-lang="python=">from pwn import *

context.arch = &#39;amd64&#39;

r = remote(&#34;mercury.picoctf.net&#34;, 33976)

def oracle(plaintext):
    r.recvuntil(b&#34;Enter your text to be encrypted: &#34;)
    r.sendline(plaintext.encode())
    nonce = r.recvline().strip().hex()
    encrypted_text = r.recvline().strip().hex()
    return r.recvline().strip().decode()


current_char = &#34;&#34;
guessing_flag = &#34;picoCTF{&#34;
fit_length = oracle(guessing_flag)
print(guessing_flag)
while current_char != &#34;}&#34;:
    for i in string.printable:
        if oracle(guessing_flag + i) == fit_length:
            print(i)
            guessing_flag += i
            current_char = i
            break
        
print(guessing_flag)
r.close()
</code></pre><p>Flag: <code>picoCTF{sheriff_you_solved_the_crime}</code></p><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><p><a href=https://blog.maple3142.net/2021/03/30/picoctf-2021-writeups/#compress-and-attack>maple3142 - compress-and-attack</a>
<a href=https://github.com/apoirrier/CTFs-writeups/blob/master/PicoCTF/Crypto/CompressAndAttack.md>CompressAndAttack Write up</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#background>Background</a></li><li><a href=#source-code>Source code</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit>Exploit</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside></main></body></html>