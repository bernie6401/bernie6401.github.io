<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  PicoCTF - PowerAnalysis Part 1 / Part 2
  #


  Background
  #

Simple Welcome 0x13(2023 HW - Power Analysis):two:

  Recon
  #

這一題幾乎就和上課教的差不多，只是因為有雜訊，所以要慎選trace point，我是直接看第一個trace的分布，決定採用300~400的point，而不管是利用自己刻的correlation coefficient還是用scipy的pearsonr都一樣可以順利解出key但是如果像homework一樣用numpy的corrcoef會有兩個bytes和正解不一樣，超哭，找超久(10/18更新，如果用自己刻的也是要碰用氣，所以如果可以的話，多送幾個trace，或者多用幾個算correlation coefficient的library)


Part 2的部分幾乎一模一樣，就只是他先幫你紀錄好所有的trace，再讓我們做後續的分析


  Exploit
  #


首先先把資料從server拉下來，在存成json
from pwn import *
from string import ascii_letters, digits
import json
from tqdm import trange


def gen_plaintext(length):
    return ''.join(random.choice(ascii_letters + digits) for _ in range(length))


pt = [gen_plaintext(16) for _ in range(50)]
print(pt)
json_file = [None] * len(pt)

for i in trange(len(pt)):
    r = remote('saturn.picoctf.net', 52339)
    r.sendlineafter(b'hex: ', pt[i].encode('utf-8').hex().encode())
    r.recvuntil(b'power measurement result:  ')
    pm = r.recvline().decode().strip()
    json_file[i] = {}
    json_file[i][&#34;pt&#34;] = [ord(digit) for digit in pt[i]]
    json_file[i][&#34;pm&#34;] = pm

    r.close()

json_object = json.dumps(json_file)
with open(&#34;./Crypto/PowerAnalysis- Part 1/trace.json&#34;, 'w') as outfile:
    outfile.write(json_object)

然後再去解析AES key
import json
from tqdm import trange
import numpy as np
import copy
from string import ascii_letters, digits
from numpy import corrcoef
import matplotlib.pyplot as plt
from scipy.stats import pearsonr

jsonFile = open('./PicoCTF/Crypto/PowerAnalysis- Part 1/trace.json', 'r')
j = json.load(jsonFile)

s_box = [
    [0x63, 0x7C, 0x77, 0x7B, 0xF2, 0x6B, 0x6F, 0xC5, 0x30, 0x01, 0x67, 0x2B, 0xFE, 0xD7, 0xAB, 0x76],
    [0xCA, 0x82, 0xC9, 0x7D, 0xFA, 0x59, 0x47, 0xF0, 0xAD, 0xD4, 0xA2, 0xAF, 0x9C, 0xA4, 0x72, 0xC0],
    [0xB7, 0xFD, 0x93, 0x26, 0x36, 0x3F, 0xF7, 0xCC, 0x34, 0xA5, 0xE5, 0xF1, 0x71, 0xD8, 0x31, 0x15],
    [0x04, 0xC7, 0x23, 0xC3, 0x18, 0x96, 0x05, 0x9A, 0x07, 0x12, 0x80, 0xE2, 0xEB, 0x27, 0xB2, 0x75],
    [0x09, 0x83, 0x2C, 0x1A, 0x1B, 0x6E, 0x5A, 0xA0, 0x52, 0x3B, 0xD6, 0xB3, 0x29, 0xE3, 0x2F, 0x84],
    [0x53, 0xD1, 0x00, 0xED, 0x20, 0xFC, 0xB1, 0x5B, 0x6A, 0xCB, 0xBE, 0x39, 0x4A, 0x4C, 0x58, 0xCF],
    [0xD0, 0xEF, 0xAA, 0xFB, 0x43, 0x4D, 0x33, 0x85, 0x45, 0xF9, 0x02, 0x7F, 0x50, 0x3C, 0x9F, 0xA8],
    [0x51, 0xA3, 0x40, 0x8F, 0x92, 0x9D, 0x38, 0xF5, 0xBC, 0xB6, 0xDA, 0x21, 0x10, 0xFF, 0xF3, 0xD2],
    [0xCD, 0x0C, 0x13, 0xEC, 0x5F, 0x97, 0x44, 0x17, 0xC4, 0xA7, 0x7E, 0x3D, 0x64, 0x5D, 0x19, 0x73],
    [0x60, 0x81, 0x4F, 0xDC, 0x22, 0x2A, 0x90, 0x88, 0x46, 0xEE, 0xB8, 0x14, 0xDE, 0x5E, 0x0B, 0xDB],
    [0xE0, 0x32, 0x3A, 0x0A, 0x49, 0x06, 0x24, 0x5C, 0xC2, 0xD3, 0xAC, 0x62, 0x91, 0x95, 0xE4, 0x79],
    [0xE7, 0xC8, 0x37, 0x6D, 0x8D, 0xD5, 0x4E, 0xA9, 0x6C, 0x56, 0xF4, 0xEA, 0x65, 0x7A, 0xAE, 0x08],
    [0xBA, 0x78, 0x25, 0x2E, 0x1C, 0xA6, 0xB4, 0xC6, 0xE8, 0xDD, 0x74, 0x1F, 0x4B, 0xBD, 0x8B, 0x8A],
    [0x70, 0x3E, 0xB5, 0x66, 0x48, 0x03, 0xF6, 0x0E, 0x61, 0x35, 0x57, 0xB9, 0x86, 0xC1, 0x1D, 0x9E],
    [0xE1, 0xF8, 0x98, 0x11, 0x69, 0xD9, 0x8E, 0x94, 0x9B, 0x1E, 0x87, 0xE9, 0xCE, 0x55, 0x28, 0xDF],
    [0x8C, 0xA1, 0x89, 0x0D, 0xBF, 0xE6, 0x42, 0x68, 0x41, 0x99, 0x2D, 0x0F, 0xB0, 0x54, 0xBB, 0x16]
]

def data_preprocess(json_data):
    pt_col = []
    # ct_col = []
    trace_col = []
    for bytes in range(16):
        tmp_pt_col = []
        # tmp_ct_col = []
        for trace_idx in range(len(json_data)):
            tmp_pt_col.append(json_data[trace_idx]['pt'][bytes])
            # tmp_ct_col.append(json_data[trace_idx]['ct'][bytes])
        pt_col.append(tmp_pt_col)
        # ct_col.append(tmp_ct_col)
    for point in range(300, 400):#len(json_data[0]['pm'])
        tmp_trace_col = []
        for trace_idx in range(len(json_data)):
            tmp_trace_col.append(json_data[trace_idx]['pm'][point])
        trace_col.append(tmp_trace_col)

    return pt_col, trace_col

def sbox_preprocess(pt_col):
    sbox_result_tmp = []
    for sbox_key in range(256): # 總共有256個sbox key
        tmp = []
        for trace in range(len(pt_col)): # 有50個trace
            tmp.append(pt_col[trace] ^ sbox_key)
        sbox_result_tmp.append(tmp)
    return sbox_result_tmp

def choose_sbox(sbox_result_tmp):
    sbox_result = copy.deepcopy(sbox_result_tmp)
    for sbox_key in range(256):
        for trace in range(50):
            hex_value = '{0:0>2x}'.format(sbox_result_tmp[sbox_key][trace])
            x, y = hex_value[0], hex_value[1]
            sbox_result[sbox_key][trace] = s_box[int(x, 16)][int(y, 16)]

    return sbox_result

def cal_hamming_weight(sbox_result_col):
    hw_model = copy.deepcopy(sbox_result_col)
    for i in range(len(sbox_result_col)):   # 256
        for j in range(len(sbox_result_col[i])):    # 50
            hw_model[i][j] = bin(sbox_result_col[i][j]).count('1')

    return hw_model

def cal_correlation(hw_model_col_result, trace_col):
    correlation_result = []
    for i in trange(len(hw_model_col_result)):#(ascii_letters + digits).encode():
        for j in range(biggest_length):#len(trace_col)
            # correlation_result.append(corrcoef(hw_model_col_result[i], trace_col[j])[0, -1])
            # correlation_result.append(pearsonr(hw_model_col_result[i], trace_col[j])[0])
            correlation_result.append(run_pearson_correlation(hw_model_col_result[i], trace_col[j]))
    return correlation_result

def run_pearson_correlation(x, y):
    mean_x = np.mean(x)
    mean_y = np.mean(y)

    covariance = np.sum((x - mean_x) * (y - mean_y))

    std_dev_x = np.sqrt(np.sum((x - mean_x)**2))
    std_dev_y = np.sqrt(np.sum((y - mean_y)**2))

    correlation = covariance / (std_dev_x * std_dev_y)

    return correlation

def display_pt(offset:int, data_offset = (0, len(j[0][&#34;pm&#34;]))):
    plt.plot(range(data_offset[0], data_offset[1]), j[offset][&#34;pm&#34;][data_offset[0]:data_offset[1]])
    plt.savefig(fname=&#34;./PicoCTF/Crypto/PowerAnalysis- Part 1/pt_&#34; + str(offset) + &#34;.jpg&#34;)
    plt.clf()

# display_pt(1, (0, 700))
# display_pt(1)
pt_col, trace_col = data_preprocess(j)
flag = ''
biggest_length = 100#len(trace_col)
for idx in trange(16):
    sbox_preprocess_result = sbox_preprocess(pt_col[idx])
    choose_sbox_result = choose_sbox(sbox_preprocess_result)
    hw_model_col_result = cal_hamming_weight(choose_sbox_result)
    correlation_result = cal_correlation(hw_model_col_result, trace_col)
    key_idx = correlation_result.index(max(correlation_result))
    # flag += (ascii_letters + digits)[key_idx // biggest_length]
    from Crypto.Util.number import long_to_bytes
    flag += long_to_bytes(key_idx // biggest_length).hex()


print('The key of AES is: ' + flag )


Flag: picoCTF{4999139026d84bf20427eb48d4edec53}"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/practice/picoctf/crypto/sidechannel/picoctf---poweranalysis-part-1-_-part-2/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="PicoCTF - PowerAnalysis Part 1 / Part 2"><meta property="og:description" content="PicoCTF - PowerAnalysis Part 1 / Part 2 # Background # Simple Welcome 0x13(2023 HW - Power Analysis):two:
Recon # 這一題幾乎就和上課教的差不多，只是因為有雜訊，所以要慎選trace point，我是直接看第一個trace的分布，決定採用300~400的point，而不管是利用自己刻的correlation coefficient還是用scipy的pearsonr都一樣可以順利解出key但是如果像homework一樣用numpy的corrcoef會有兩個bytes和正解不一樣，超哭，找超久(10/18更新，如果用自己刻的也是要碰用氣，所以如果可以的話，多送幾個trace，或者多用幾個算correlation coefficient的library) Part 2的部分幾乎一模一樣，就只是他先幫你紀錄好所有的trace，再讓我們做後續的分析 Exploit # 首先先把資料從server拉下來，在存成json from pwn import * from string import ascii_letters, digits import json from tqdm import trange def gen_plaintext(length): return ''.join(random.choice(ascii_letters + digits) for _ in range(length)) pt = [gen_plaintext(16) for _ in range(50)] print(pt) json_file = [None] * len(pt) for i in trange(len(pt)): r = remote('saturn.picoctf.net', 52339) r.sendlineafter(b'hex: ', pt[i].encode('utf-8').hex().encode()) r.recvuntil(b'power measurement result: ') pm = r.recvline().decode().strip() json_file[i] = {} json_file[i][&#34;pt&#34;] = [ord(digit) for digit in pt[i]] json_file[i][&#34;pm&#34;] = pm r.close() json_object = json.dumps(json_file) with open(&#34;./Crypto/PowerAnalysis- Part 1/trace.json&#34;, 'w') as outfile: outfile.write(json_object) 然後再去解析AES key import json from tqdm import trange import numpy as np import copy from string import ascii_letters, digits from numpy import corrcoef import matplotlib.pyplot as plt from scipy.stats import pearsonr jsonFile = open('./PicoCTF/Crypto/PowerAnalysis- Part 1/trace.json', 'r') j = json.load(jsonFile) s_box = [ [0x63, 0x7C, 0x77, 0x7B, 0xF2, 0x6B, 0x6F, 0xC5, 0x30, 0x01, 0x67, 0x2B, 0xFE, 0xD7, 0xAB, 0x76], [0xCA, 0x82, 0xC9, 0x7D, 0xFA, 0x59, 0x47, 0xF0, 0xAD, 0xD4, 0xA2, 0xAF, 0x9C, 0xA4, 0x72, 0xC0], [0xB7, 0xFD, 0x93, 0x26, 0x36, 0x3F, 0xF7, 0xCC, 0x34, 0xA5, 0xE5, 0xF1, 0x71, 0xD8, 0x31, 0x15], [0x04, 0xC7, 0x23, 0xC3, 0x18, 0x96, 0x05, 0x9A, 0x07, 0x12, 0x80, 0xE2, 0xEB, 0x27, 0xB2, 0x75], [0x09, 0x83, 0x2C, 0x1A, 0x1B, 0x6E, 0x5A, 0xA0, 0x52, 0x3B, 0xD6, 0xB3, 0x29, 0xE3, 0x2F, 0x84], [0x53, 0xD1, 0x00, 0xED, 0x20, 0xFC, 0xB1, 0x5B, 0x6A, 0xCB, 0xBE, 0x39, 0x4A, 0x4C, 0x58, 0xCF], [0xD0, 0xEF, 0xAA, 0xFB, 0x43, 0x4D, 0x33, 0x85, 0x45, 0xF9, 0x02, 0x7F, 0x50, 0x3C, 0x9F, 0xA8], [0x51, 0xA3, 0x40, 0x8F, 0x92, 0x9D, 0x38, 0xF5, 0xBC, 0xB6, 0xDA, 0x21, 0x10, 0xFF, 0xF3, 0xD2], [0xCD, 0x0C, 0x13, 0xEC, 0x5F, 0x97, 0x44, 0x17, 0xC4, 0xA7, 0x7E, 0x3D, 0x64, 0x5D, 0x19, 0x73], [0x60, 0x81, 0x4F, 0xDC, 0x22, 0x2A, 0x90, 0x88, 0x46, 0xEE, 0xB8, 0x14, 0xDE, 0x5E, 0x0B, 0xDB], [0xE0, 0x32, 0x3A, 0x0A, 0x49, 0x06, 0x24, 0x5C, 0xC2, 0xD3, 0xAC, 0x62, 0x91, 0x95, 0xE4, 0x79], [0xE7, 0xC8, 0x37, 0x6D, 0x8D, 0xD5, 0x4E, 0xA9, 0x6C, 0x56, 0xF4, 0xEA, 0x65, 0x7A, 0xAE, 0x08], [0xBA, 0x78, 0x25, 0x2E, 0x1C, 0xA6, 0xB4, 0xC6, 0xE8, 0xDD, 0x74, 0x1F, 0x4B, 0xBD, 0x8B, 0x8A], [0x70, 0x3E, 0xB5, 0x66, 0x48, 0x03, 0xF6, 0x0E, 0x61, 0x35, 0x57, 0xB9, 0x86, 0xC1, 0x1D, 0x9E], [0xE1, 0xF8, 0x98, 0x11, 0x69, 0xD9, 0x8E, 0x94, 0x9B, 0x1E, 0x87, 0xE9, 0xCE, 0x55, 0x28, 0xDF], [0x8C, 0xA1, 0x89, 0x0D, 0xBF, 0xE6, 0x42, 0x68, 0x41, 0x99, 0x2D, 0x0F, 0xB0, 0x54, 0xBB, 0x16] ] def data_preprocess(json_data): pt_col = [] # ct_col = [] trace_col = [] for bytes in range(16): tmp_pt_col = [] # tmp_ct_col = [] for trace_idx in range(len(json_data)): tmp_pt_col.append(json_data[trace_idx]['pt'][bytes]) # tmp_ct_col.append(json_data[trace_idx]['ct'][bytes]) pt_col.append(tmp_pt_col) # ct_col.append(tmp_ct_col) for point in range(300, 400):#len(json_data[0]['pm']) tmp_trace_col = [] for trace_idx in range(len(json_data)): tmp_trace_col.append(json_data[trace_idx]['pm'][point]) trace_col.append(tmp_trace_col) return pt_col, trace_col def sbox_preprocess(pt_col): sbox_result_tmp = [] for sbox_key in range(256): # 總共有256個sbox key tmp = [] for trace in range(len(pt_col)): # 有50個trace tmp.append(pt_col[trace] ^ sbox_key) sbox_result_tmp.append(tmp) return sbox_result_tmp def choose_sbox(sbox_result_tmp): sbox_result = copy.deepcopy(sbox_result_tmp) for sbox_key in range(256): for trace in range(50): hex_value = '{0:0>2x}'.format(sbox_result_tmp[sbox_key][trace]) x, y = hex_value[0], hex_value[1] sbox_result[sbox_key][trace] = s_box[int(x, 16)][int(y, 16)] return sbox_result def cal_hamming_weight(sbox_result_col): hw_model = copy.deepcopy(sbox_result_col) for i in range(len(sbox_result_col)): # 256 for j in range(len(sbox_result_col[i])): # 50 hw_model[i][j] = bin(sbox_result_col[i][j]).count('1') return hw_model def cal_correlation(hw_model_col_result, trace_col): correlation_result = [] for i in trange(len(hw_model_col_result)):#(ascii_letters + digits).encode(): for j in range(biggest_length):#len(trace_col) # correlation_result.append(corrcoef(hw_model_col_result[i], trace_col[j])[0, -1]) # correlation_result.append(pearsonr(hw_model_col_result[i], trace_col[j])[0]) correlation_result.append(run_pearson_correlation(hw_model_col_result[i], trace_col[j])) return correlation_result def run_pearson_correlation(x, y): mean_x = np.mean(x) mean_y = np.mean(y) covariance = np.sum((x - mean_x) * (y - mean_y)) std_dev_x = np.sqrt(np.sum((x - mean_x)**2)) std_dev_y = np.sqrt(np.sum((y - mean_y)**2)) correlation = covariance / (std_dev_x * std_dev_y) return correlation def display_pt(offset:int, data_offset = (0, len(j[0][&#34;pm&#34;]))): plt.plot(range(data_offset[0], data_offset[1]), j[offset][&#34;pm&#34;][data_offset[0]:data_offset[1]]) plt.savefig(fname=&#34;./PicoCTF/Crypto/PowerAnalysis- Part 1/pt_&#34; + str(offset) + &#34;.jpg&#34;) plt.clf() # display_pt(1, (0, 700)) # display_pt(1) pt_col, trace_col = data_preprocess(j) flag = '' biggest_length = 100#len(trace_col) for idx in trange(16): sbox_preprocess_result = sbox_preprocess(pt_col[idx]) choose_sbox_result = choose_sbox(sbox_preprocess_result) hw_model_col_result = cal_hamming_weight(choose_sbox_result) correlation_result = cal_correlation(hw_model_col_result, trace_col) key_idx = correlation_result.index(max(correlation_result)) # flag += (ascii_letters + digits)[key_idx // biggest_length] from Crypto.Util.number import long_to_bytes flag += long_to_bytes(key_idx // biggest_length).hex() print('The key of AES is: ' + flag ) Flag: picoCTF{4999139026d84bf20427eb48d4edec53}"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="PicoCTF"><meta property="article:tag" content="CTF"><meta property="article:tag" content="Crypto"><title>PicoCTF - PowerAnalysis Part 1 / Part 2 | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/practice/picoctf/crypto/sidechannel/picoctf---poweranalysis-part-1-_-part-2/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>PicoCTF - PowerAnalysis Part 1 / Part 2</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit>Exploit</a><ul><li><a href=#exploit-part-2>Exploit Part 2</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=picoctf---poweranalysis-part-1--part-2>PicoCTF - PowerAnalysis Part 1 / Part 2
<a class=anchor href=#picoctf---poweranalysis-part-1--part-2>#</a></h1><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p><a href=https://hackmd.io/@SBK6401/HJNScTc-T>Simple Welcome 0x13(2023 HW - Power Analysis):two:</a></p><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><p>這一題幾乎就和上課教的差不多，只是因為有雜訊，所以要慎選trace point，我是直接看第一個trace的分布，決定採用300~400的point，而不管是利用自己刻的correlation coefficient還是用scipy的pearsonr都一樣可以順利解出key但是如果像homework一樣用numpy的corrcoef會有兩個bytes和正解不一樣，超哭，找超久(10/18更新，如果用自己刻的也是要碰用氣，所以如果可以的話，多送幾個trace，或者多用幾個算correlation coefficient的library)
<img src=https://hackmd.io/_uploads/SJ4YLRnZT.jpg alt></p><ul><li>Part 2的部分幾乎一模一樣，就只是他先幫你紀錄好所有的trace，再讓我們做後續的分析</li></ul><h2 id=exploit>Exploit
<a class=anchor href=#exploit>#</a></h2><ul><li>首先先把資料從server拉下來，在存成json<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> string <span style=color:#f92672>import</span> ascii_letters, digits
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> tqdm <span style=color:#f92672>import</span> trange
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>gen_plaintext</span>(length):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;&#39;</span><span style=color:#f92672>.</span>join(random<span style=color:#f92672>.</span>choice(ascii_letters <span style=color:#f92672>+</span> digits) <span style=color:#66d9ef>for</span> _ <span style=color:#f92672>in</span> range(length))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pt <span style=color:#f92672>=</span> [gen_plaintext(<span style=color:#ae81ff>16</span>) <span style=color:#66d9ef>for</span> _ <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>50</span>)]
</span></span><span style=display:flex><span>print(pt)
</span></span><span style=display:flex><span>json_file <span style=color:#f92672>=</span> [<span style=color:#66d9ef>None</span>] <span style=color:#f92672>*</span> len(pt)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> trange(len(pt)):
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#39;saturn.picoctf.net&#39;</span>, <span style=color:#ae81ff>52339</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;hex: &#39;</span>, pt[i]<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)<span style=color:#f92672>.</span>hex()<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;power measurement result:  &#39;</span>)
</span></span><span style=display:flex><span>    pm <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>recvline()<span style=color:#f92672>.</span>decode()<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>    json_file[i] <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>    json_file[i][<span style=color:#e6db74>&#34;pt&#34;</span>] <span style=color:#f92672>=</span> [ord(digit) <span style=color:#66d9ef>for</span> digit <span style=color:#f92672>in</span> pt[i]]
</span></span><span style=display:flex><span>    json_file[i][<span style=color:#e6db74>&#34;pm&#34;</span>] <span style=color:#f92672>=</span> pm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>json_object <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>dumps(json_file)
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#34;./Crypto/PowerAnalysis- Part 1/trace.json&#34;</span>, <span style=color:#e6db74>&#39;w&#39;</span>) <span style=color:#66d9ef>as</span> outfile:
</span></span><span style=display:flex><span>    outfile<span style=color:#f92672>.</span>write(json_object)
</span></span></code></pre></div></li><li>然後再去解析AES key<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> tqdm <span style=color:#f92672>import</span> trange
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> numpy <span style=color:#66d9ef>as</span> np
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> copy
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> string <span style=color:#f92672>import</span> ascii_letters, digits
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> numpy <span style=color:#f92672>import</span> corrcoef
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> matplotlib.pyplot <span style=color:#66d9ef>as</span> plt
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> scipy.stats <span style=color:#f92672>import</span> pearsonr
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jsonFile <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#39;./PicoCTF/Crypto/PowerAnalysis- Part 1/trace.json&#39;</span>, <span style=color:#e6db74>&#39;r&#39;</span>)
</span></span><span style=display:flex><span>j <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>load(jsonFile)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>s_box <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0x63</span>, <span style=color:#ae81ff>0x7C</span>, <span style=color:#ae81ff>0x77</span>, <span style=color:#ae81ff>0x7B</span>, <span style=color:#ae81ff>0xF2</span>, <span style=color:#ae81ff>0x6B</span>, <span style=color:#ae81ff>0x6F</span>, <span style=color:#ae81ff>0xC5</span>, <span style=color:#ae81ff>0x30</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x67</span>, <span style=color:#ae81ff>0x2B</span>, <span style=color:#ae81ff>0xFE</span>, <span style=color:#ae81ff>0xD7</span>, <span style=color:#ae81ff>0xAB</span>, <span style=color:#ae81ff>0x76</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0xCA</span>, <span style=color:#ae81ff>0x82</span>, <span style=color:#ae81ff>0xC9</span>, <span style=color:#ae81ff>0x7D</span>, <span style=color:#ae81ff>0xFA</span>, <span style=color:#ae81ff>0x59</span>, <span style=color:#ae81ff>0x47</span>, <span style=color:#ae81ff>0xF0</span>, <span style=color:#ae81ff>0xAD</span>, <span style=color:#ae81ff>0xD4</span>, <span style=color:#ae81ff>0xA2</span>, <span style=color:#ae81ff>0xAF</span>, <span style=color:#ae81ff>0x9C</span>, <span style=color:#ae81ff>0xA4</span>, <span style=color:#ae81ff>0x72</span>, <span style=color:#ae81ff>0xC0</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0xB7</span>, <span style=color:#ae81ff>0xFD</span>, <span style=color:#ae81ff>0x93</span>, <span style=color:#ae81ff>0x26</span>, <span style=color:#ae81ff>0x36</span>, <span style=color:#ae81ff>0x3F</span>, <span style=color:#ae81ff>0xF7</span>, <span style=color:#ae81ff>0xCC</span>, <span style=color:#ae81ff>0x34</span>, <span style=color:#ae81ff>0xA5</span>, <span style=color:#ae81ff>0xE5</span>, <span style=color:#ae81ff>0xF1</span>, <span style=color:#ae81ff>0x71</span>, <span style=color:#ae81ff>0xD8</span>, <span style=color:#ae81ff>0x31</span>, <span style=color:#ae81ff>0x15</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0x04</span>, <span style=color:#ae81ff>0xC7</span>, <span style=color:#ae81ff>0x23</span>, <span style=color:#ae81ff>0xC3</span>, <span style=color:#ae81ff>0x18</span>, <span style=color:#ae81ff>0x96</span>, <span style=color:#ae81ff>0x05</span>, <span style=color:#ae81ff>0x9A</span>, <span style=color:#ae81ff>0x07</span>, <span style=color:#ae81ff>0x12</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0xE2</span>, <span style=color:#ae81ff>0xEB</span>, <span style=color:#ae81ff>0x27</span>, <span style=color:#ae81ff>0xB2</span>, <span style=color:#ae81ff>0x75</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0x09</span>, <span style=color:#ae81ff>0x83</span>, <span style=color:#ae81ff>0x2C</span>, <span style=color:#ae81ff>0x1A</span>, <span style=color:#ae81ff>0x1B</span>, <span style=color:#ae81ff>0x6E</span>, <span style=color:#ae81ff>0x5A</span>, <span style=color:#ae81ff>0xA0</span>, <span style=color:#ae81ff>0x52</span>, <span style=color:#ae81ff>0x3B</span>, <span style=color:#ae81ff>0xD6</span>, <span style=color:#ae81ff>0xB3</span>, <span style=color:#ae81ff>0x29</span>, <span style=color:#ae81ff>0xE3</span>, <span style=color:#ae81ff>0x2F</span>, <span style=color:#ae81ff>0x84</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0x53</span>, <span style=color:#ae81ff>0xD1</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0xED</span>, <span style=color:#ae81ff>0x20</span>, <span style=color:#ae81ff>0xFC</span>, <span style=color:#ae81ff>0xB1</span>, <span style=color:#ae81ff>0x5B</span>, <span style=color:#ae81ff>0x6A</span>, <span style=color:#ae81ff>0xCB</span>, <span style=color:#ae81ff>0xBE</span>, <span style=color:#ae81ff>0x39</span>, <span style=color:#ae81ff>0x4A</span>, <span style=color:#ae81ff>0x4C</span>, <span style=color:#ae81ff>0x58</span>, <span style=color:#ae81ff>0xCF</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0xD0</span>, <span style=color:#ae81ff>0xEF</span>, <span style=color:#ae81ff>0xAA</span>, <span style=color:#ae81ff>0xFB</span>, <span style=color:#ae81ff>0x43</span>, <span style=color:#ae81ff>0x4D</span>, <span style=color:#ae81ff>0x33</span>, <span style=color:#ae81ff>0x85</span>, <span style=color:#ae81ff>0x45</span>, <span style=color:#ae81ff>0xF9</span>, <span style=color:#ae81ff>0x02</span>, <span style=color:#ae81ff>0x7F</span>, <span style=color:#ae81ff>0x50</span>, <span style=color:#ae81ff>0x3C</span>, <span style=color:#ae81ff>0x9F</span>, <span style=color:#ae81ff>0xA8</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0x51</span>, <span style=color:#ae81ff>0xA3</span>, <span style=color:#ae81ff>0x40</span>, <span style=color:#ae81ff>0x8F</span>, <span style=color:#ae81ff>0x92</span>, <span style=color:#ae81ff>0x9D</span>, <span style=color:#ae81ff>0x38</span>, <span style=color:#ae81ff>0xF5</span>, <span style=color:#ae81ff>0xBC</span>, <span style=color:#ae81ff>0xB6</span>, <span style=color:#ae81ff>0xDA</span>, <span style=color:#ae81ff>0x21</span>, <span style=color:#ae81ff>0x10</span>, <span style=color:#ae81ff>0xFF</span>, <span style=color:#ae81ff>0xF3</span>, <span style=color:#ae81ff>0xD2</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0xCD</span>, <span style=color:#ae81ff>0x0C</span>, <span style=color:#ae81ff>0x13</span>, <span style=color:#ae81ff>0xEC</span>, <span style=color:#ae81ff>0x5F</span>, <span style=color:#ae81ff>0x97</span>, <span style=color:#ae81ff>0x44</span>, <span style=color:#ae81ff>0x17</span>, <span style=color:#ae81ff>0xC4</span>, <span style=color:#ae81ff>0xA7</span>, <span style=color:#ae81ff>0x7E</span>, <span style=color:#ae81ff>0x3D</span>, <span style=color:#ae81ff>0x64</span>, <span style=color:#ae81ff>0x5D</span>, <span style=color:#ae81ff>0x19</span>, <span style=color:#ae81ff>0x73</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0x60</span>, <span style=color:#ae81ff>0x81</span>, <span style=color:#ae81ff>0x4F</span>, <span style=color:#ae81ff>0xDC</span>, <span style=color:#ae81ff>0x22</span>, <span style=color:#ae81ff>0x2A</span>, <span style=color:#ae81ff>0x90</span>, <span style=color:#ae81ff>0x88</span>, <span style=color:#ae81ff>0x46</span>, <span style=color:#ae81ff>0xEE</span>, <span style=color:#ae81ff>0xB8</span>, <span style=color:#ae81ff>0x14</span>, <span style=color:#ae81ff>0xDE</span>, <span style=color:#ae81ff>0x5E</span>, <span style=color:#ae81ff>0x0B</span>, <span style=color:#ae81ff>0xDB</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0xE0</span>, <span style=color:#ae81ff>0x32</span>, <span style=color:#ae81ff>0x3A</span>, <span style=color:#ae81ff>0x0A</span>, <span style=color:#ae81ff>0x49</span>, <span style=color:#ae81ff>0x06</span>, <span style=color:#ae81ff>0x24</span>, <span style=color:#ae81ff>0x5C</span>, <span style=color:#ae81ff>0xC2</span>, <span style=color:#ae81ff>0xD3</span>, <span style=color:#ae81ff>0xAC</span>, <span style=color:#ae81ff>0x62</span>, <span style=color:#ae81ff>0x91</span>, <span style=color:#ae81ff>0x95</span>, <span style=color:#ae81ff>0xE4</span>, <span style=color:#ae81ff>0x79</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0xE7</span>, <span style=color:#ae81ff>0xC8</span>, <span style=color:#ae81ff>0x37</span>, <span style=color:#ae81ff>0x6D</span>, <span style=color:#ae81ff>0x8D</span>, <span style=color:#ae81ff>0xD5</span>, <span style=color:#ae81ff>0x4E</span>, <span style=color:#ae81ff>0xA9</span>, <span style=color:#ae81ff>0x6C</span>, <span style=color:#ae81ff>0x56</span>, <span style=color:#ae81ff>0xF4</span>, <span style=color:#ae81ff>0xEA</span>, <span style=color:#ae81ff>0x65</span>, <span style=color:#ae81ff>0x7A</span>, <span style=color:#ae81ff>0xAE</span>, <span style=color:#ae81ff>0x08</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0xBA</span>, <span style=color:#ae81ff>0x78</span>, <span style=color:#ae81ff>0x25</span>, <span style=color:#ae81ff>0x2E</span>, <span style=color:#ae81ff>0x1C</span>, <span style=color:#ae81ff>0xA6</span>, <span style=color:#ae81ff>0xB4</span>, <span style=color:#ae81ff>0xC6</span>, <span style=color:#ae81ff>0xE8</span>, <span style=color:#ae81ff>0xDD</span>, <span style=color:#ae81ff>0x74</span>, <span style=color:#ae81ff>0x1F</span>, <span style=color:#ae81ff>0x4B</span>, <span style=color:#ae81ff>0xBD</span>, <span style=color:#ae81ff>0x8B</span>, <span style=color:#ae81ff>0x8A</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0x70</span>, <span style=color:#ae81ff>0x3E</span>, <span style=color:#ae81ff>0xB5</span>, <span style=color:#ae81ff>0x66</span>, <span style=color:#ae81ff>0x48</span>, <span style=color:#ae81ff>0x03</span>, <span style=color:#ae81ff>0xF6</span>, <span style=color:#ae81ff>0x0E</span>, <span style=color:#ae81ff>0x61</span>, <span style=color:#ae81ff>0x35</span>, <span style=color:#ae81ff>0x57</span>, <span style=color:#ae81ff>0xB9</span>, <span style=color:#ae81ff>0x86</span>, <span style=color:#ae81ff>0xC1</span>, <span style=color:#ae81ff>0x1D</span>, <span style=color:#ae81ff>0x9E</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0xE1</span>, <span style=color:#ae81ff>0xF8</span>, <span style=color:#ae81ff>0x98</span>, <span style=color:#ae81ff>0x11</span>, <span style=color:#ae81ff>0x69</span>, <span style=color:#ae81ff>0xD9</span>, <span style=color:#ae81ff>0x8E</span>, <span style=color:#ae81ff>0x94</span>, <span style=color:#ae81ff>0x9B</span>, <span style=color:#ae81ff>0x1E</span>, <span style=color:#ae81ff>0x87</span>, <span style=color:#ae81ff>0xE9</span>, <span style=color:#ae81ff>0xCE</span>, <span style=color:#ae81ff>0x55</span>, <span style=color:#ae81ff>0x28</span>, <span style=color:#ae81ff>0xDF</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0x8C</span>, <span style=color:#ae81ff>0xA1</span>, <span style=color:#ae81ff>0x89</span>, <span style=color:#ae81ff>0x0D</span>, <span style=color:#ae81ff>0xBF</span>, <span style=color:#ae81ff>0xE6</span>, <span style=color:#ae81ff>0x42</span>, <span style=color:#ae81ff>0x68</span>, <span style=color:#ae81ff>0x41</span>, <span style=color:#ae81ff>0x99</span>, <span style=color:#ae81ff>0x2D</span>, <span style=color:#ae81ff>0x0F</span>, <span style=color:#ae81ff>0xB0</span>, <span style=color:#ae81ff>0x54</span>, <span style=color:#ae81ff>0xBB</span>, <span style=color:#ae81ff>0x16</span>]
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>data_preprocess</span>(json_data):
</span></span><span style=display:flex><span>    pt_col <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#75715e># ct_col = []</span>
</span></span><span style=display:flex><span>    trace_col <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> bytes <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>16</span>):
</span></span><span style=display:flex><span>        tmp_pt_col <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#75715e># tmp_ct_col = []</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trace_idx <span style=color:#f92672>in</span> range(len(json_data)):
</span></span><span style=display:flex><span>            tmp_pt_col<span style=color:#f92672>.</span>append(json_data[trace_idx][<span style=color:#e6db74>&#39;pt&#39;</span>][bytes])
</span></span><span style=display:flex><span>            <span style=color:#75715e># tmp_ct_col.append(json_data[trace_idx][&#39;ct&#39;][bytes])</span>
</span></span><span style=display:flex><span>        pt_col<span style=color:#f92672>.</span>append(tmp_pt_col)
</span></span><span style=display:flex><span>        <span style=color:#75715e># ct_col.append(tmp_ct_col)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> point <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>300</span>, <span style=color:#ae81ff>400</span>):<span style=color:#75715e>#len(json_data[0][&#39;pm&#39;])</span>
</span></span><span style=display:flex><span>        tmp_trace_col <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trace_idx <span style=color:#f92672>in</span> range(len(json_data)):
</span></span><span style=display:flex><span>            tmp_trace_col<span style=color:#f92672>.</span>append(json_data[trace_idx][<span style=color:#e6db74>&#39;pm&#39;</span>][point])
</span></span><span style=display:flex><span>        trace_col<span style=color:#f92672>.</span>append(tmp_trace_col)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> pt_col, trace_col
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>sbox_preprocess</span>(pt_col):
</span></span><span style=display:flex><span>    sbox_result_tmp <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> sbox_key <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>256</span>): <span style=color:#75715e># 總共有256個sbox key</span>
</span></span><span style=display:flex><span>        tmp <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trace <span style=color:#f92672>in</span> range(len(pt_col)): <span style=color:#75715e># 有50個trace</span>
</span></span><span style=display:flex><span>            tmp<span style=color:#f92672>.</span>append(pt_col[trace] <span style=color:#f92672>^</span> sbox_key)
</span></span><span style=display:flex><span>        sbox_result_tmp<span style=color:#f92672>.</span>append(tmp)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sbox_result_tmp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>choose_sbox</span>(sbox_result_tmp):
</span></span><span style=display:flex><span>    sbox_result <span style=color:#f92672>=</span> copy<span style=color:#f92672>.</span>deepcopy(sbox_result_tmp)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> sbox_key <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>256</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trace <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>50</span>):
</span></span><span style=display:flex><span>            hex_value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{0:0&gt;2x}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(sbox_result_tmp[sbox_key][trace])
</span></span><span style=display:flex><span>            x, y <span style=color:#f92672>=</span> hex_value[<span style=color:#ae81ff>0</span>], hex_value[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>            sbox_result[sbox_key][trace] <span style=color:#f92672>=</span> s_box[int(x, <span style=color:#ae81ff>16</span>)][int(y, <span style=color:#ae81ff>16</span>)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sbox_result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>cal_hamming_weight</span>(sbox_result_col):
</span></span><span style=display:flex><span>    hw_model <span style=color:#f92672>=</span> copy<span style=color:#f92672>.</span>deepcopy(sbox_result_col)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(len(sbox_result_col)):   <span style=color:#75715e># 256</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> j <span style=color:#f92672>in</span> range(len(sbox_result_col[i])):    <span style=color:#75715e># 50</span>
</span></span><span style=display:flex><span>            hw_model[i][j] <span style=color:#f92672>=</span> bin(sbox_result_col[i][j])<span style=color:#f92672>.</span>count(<span style=color:#e6db74>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> hw_model
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>cal_correlation</span>(hw_model_col_result, trace_col):
</span></span><span style=display:flex><span>    correlation_result <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> trange(len(hw_model_col_result)):<span style=color:#75715e>#(ascii_letters + digits).encode():</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> j <span style=color:#f92672>in</span> range(biggest_length):<span style=color:#75715e>#len(trace_col)</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># correlation_result.append(corrcoef(hw_model_col_result[i], trace_col[j])[0, -1])</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># correlation_result.append(pearsonr(hw_model_col_result[i], trace_col[j])[0])</span>
</span></span><span style=display:flex><span>            correlation_result<span style=color:#f92672>.</span>append(run_pearson_correlation(hw_model_col_result[i], trace_col[j]))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> correlation_result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run_pearson_correlation</span>(x, y):
</span></span><span style=display:flex><span>    mean_x <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>mean(x)
</span></span><span style=display:flex><span>    mean_y <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>mean(y)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    covariance <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>sum((x <span style=color:#f92672>-</span> mean_x) <span style=color:#f92672>*</span> (y <span style=color:#f92672>-</span> mean_y))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    std_dev_x <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>sqrt(np<span style=color:#f92672>.</span>sum((x <span style=color:#f92672>-</span> mean_x)<span style=color:#f92672>**</span><span style=color:#ae81ff>2</span>))
</span></span><span style=display:flex><span>    std_dev_y <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>sqrt(np<span style=color:#f92672>.</span>sum((y <span style=color:#f92672>-</span> mean_y)<span style=color:#f92672>**</span><span style=color:#ae81ff>2</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    correlation <span style=color:#f92672>=</span> covariance <span style=color:#f92672>/</span> (std_dev_x <span style=color:#f92672>*</span> std_dev_y)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> correlation
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>display_pt</span>(offset:int, data_offset <span style=color:#f92672>=</span> (<span style=color:#ae81ff>0</span>, len(j[<span style=color:#ae81ff>0</span>][<span style=color:#e6db74>&#34;pm&#34;</span>]))):
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>plot(range(data_offset[<span style=color:#ae81ff>0</span>], data_offset[<span style=color:#ae81ff>1</span>]), j[offset][<span style=color:#e6db74>&#34;pm&#34;</span>][data_offset[<span style=color:#ae81ff>0</span>]:data_offset[<span style=color:#ae81ff>1</span>]])
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>savefig(fname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;./PicoCTF/Crypto/PowerAnalysis- Part 1/pt_&#34;</span> <span style=color:#f92672>+</span> str(offset) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.jpg&#34;</span>)
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>clf()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># display_pt(1, (0, 700))</span>
</span></span><span style=display:flex><span><span style=color:#75715e># display_pt(1)</span>
</span></span><span style=display:flex><span>pt_col, trace_col <span style=color:#f92672>=</span> data_preprocess(j)
</span></span><span style=display:flex><span>flag <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>biggest_length <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span><span style=color:#75715e>#len(trace_col)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> idx <span style=color:#f92672>in</span> trange(<span style=color:#ae81ff>16</span>):
</span></span><span style=display:flex><span>    sbox_preprocess_result <span style=color:#f92672>=</span> sbox_preprocess(pt_col[idx])
</span></span><span style=display:flex><span>    choose_sbox_result <span style=color:#f92672>=</span> choose_sbox(sbox_preprocess_result)
</span></span><span style=display:flex><span>    hw_model_col_result <span style=color:#f92672>=</span> cal_hamming_weight(choose_sbox_result)
</span></span><span style=display:flex><span>    correlation_result <span style=color:#f92672>=</span> cal_correlation(hw_model_col_result, trace_col)
</span></span><span style=display:flex><span>    key_idx <span style=color:#f92672>=</span> correlation_result<span style=color:#f92672>.</span>index(max(correlation_result))
</span></span><span style=display:flex><span>    <span style=color:#75715e># flag += (ascii_letters + digits)[key_idx // biggest_length]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>from</span> Crypto.Util.number <span style=color:#f92672>import</span> long_to_bytes
</span></span><span style=display:flex><span>    flag <span style=color:#f92672>+=</span> long_to_bytes(key_idx <span style=color:#f92672>//</span> biggest_length)<span style=color:#f92672>.</span>hex()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;The key of AES is: &#39;</span> <span style=color:#f92672>+</span> flag )
</span></span></code></pre></div></li></ul><p>Flag: <code>picoCTF{4999139026d84bf20427eb48d4edec53}</code></p><hr><h3 id=exploit-part-2>Exploit Part 2
<a class=anchor href=#exploit-part-2>#</a></h3><p>為了不要讓主程式的變化太大，因此我有調整了一下data preprocessing的部分，還找到了一個bug，
:::spoiler Exp</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> tqdm <span style=color:#f92672>import</span> trange
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> numpy <span style=color:#66d9ef>as</span> np
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> copy
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pathlib <span style=color:#f92672>import</span> Path
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> numpy <span style=color:#f92672>import</span> corrcoef
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> matplotlib.pyplot <span style=color:#66d9ef>as</span> plt
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> scipy.stats <span style=color:#f92672>import</span> pearsonr
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> ast
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># root = &#34;./PicoCTF/Crypto/PowerAnalysis- Part 1/&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># jsonFile = open(root + &#39;traces.json&#39;, &#39;r&#39;)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># j = json.load(jsonFile)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>s_box <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0x63</span>, <span style=color:#ae81ff>0x7C</span>, <span style=color:#ae81ff>0x77</span>, <span style=color:#ae81ff>0x7B</span>, <span style=color:#ae81ff>0xF2</span>, <span style=color:#ae81ff>0x6B</span>, <span style=color:#ae81ff>0x6F</span>, <span style=color:#ae81ff>0xC5</span>, <span style=color:#ae81ff>0x30</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x67</span>, <span style=color:#ae81ff>0x2B</span>, <span style=color:#ae81ff>0xFE</span>, <span style=color:#ae81ff>0xD7</span>, <span style=color:#ae81ff>0xAB</span>, <span style=color:#ae81ff>0x76</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0xCA</span>, <span style=color:#ae81ff>0x82</span>, <span style=color:#ae81ff>0xC9</span>, <span style=color:#ae81ff>0x7D</span>, <span style=color:#ae81ff>0xFA</span>, <span style=color:#ae81ff>0x59</span>, <span style=color:#ae81ff>0x47</span>, <span style=color:#ae81ff>0xF0</span>, <span style=color:#ae81ff>0xAD</span>, <span style=color:#ae81ff>0xD4</span>, <span style=color:#ae81ff>0xA2</span>, <span style=color:#ae81ff>0xAF</span>, <span style=color:#ae81ff>0x9C</span>, <span style=color:#ae81ff>0xA4</span>, <span style=color:#ae81ff>0x72</span>, <span style=color:#ae81ff>0xC0</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0xB7</span>, <span style=color:#ae81ff>0xFD</span>, <span style=color:#ae81ff>0x93</span>, <span style=color:#ae81ff>0x26</span>, <span style=color:#ae81ff>0x36</span>, <span style=color:#ae81ff>0x3F</span>, <span style=color:#ae81ff>0xF7</span>, <span style=color:#ae81ff>0xCC</span>, <span style=color:#ae81ff>0x34</span>, <span style=color:#ae81ff>0xA5</span>, <span style=color:#ae81ff>0xE5</span>, <span style=color:#ae81ff>0xF1</span>, <span style=color:#ae81ff>0x71</span>, <span style=color:#ae81ff>0xD8</span>, <span style=color:#ae81ff>0x31</span>, <span style=color:#ae81ff>0x15</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0x04</span>, <span style=color:#ae81ff>0xC7</span>, <span style=color:#ae81ff>0x23</span>, <span style=color:#ae81ff>0xC3</span>, <span style=color:#ae81ff>0x18</span>, <span style=color:#ae81ff>0x96</span>, <span style=color:#ae81ff>0x05</span>, <span style=color:#ae81ff>0x9A</span>, <span style=color:#ae81ff>0x07</span>, <span style=color:#ae81ff>0x12</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0xE2</span>, <span style=color:#ae81ff>0xEB</span>, <span style=color:#ae81ff>0x27</span>, <span style=color:#ae81ff>0xB2</span>, <span style=color:#ae81ff>0x75</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0x09</span>, <span style=color:#ae81ff>0x83</span>, <span style=color:#ae81ff>0x2C</span>, <span style=color:#ae81ff>0x1A</span>, <span style=color:#ae81ff>0x1B</span>, <span style=color:#ae81ff>0x6E</span>, <span style=color:#ae81ff>0x5A</span>, <span style=color:#ae81ff>0xA0</span>, <span style=color:#ae81ff>0x52</span>, <span style=color:#ae81ff>0x3B</span>, <span style=color:#ae81ff>0xD6</span>, <span style=color:#ae81ff>0xB3</span>, <span style=color:#ae81ff>0x29</span>, <span style=color:#ae81ff>0xE3</span>, <span style=color:#ae81ff>0x2F</span>, <span style=color:#ae81ff>0x84</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0x53</span>, <span style=color:#ae81ff>0xD1</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0xED</span>, <span style=color:#ae81ff>0x20</span>, <span style=color:#ae81ff>0xFC</span>, <span style=color:#ae81ff>0xB1</span>, <span style=color:#ae81ff>0x5B</span>, <span style=color:#ae81ff>0x6A</span>, <span style=color:#ae81ff>0xCB</span>, <span style=color:#ae81ff>0xBE</span>, <span style=color:#ae81ff>0x39</span>, <span style=color:#ae81ff>0x4A</span>, <span style=color:#ae81ff>0x4C</span>, <span style=color:#ae81ff>0x58</span>, <span style=color:#ae81ff>0xCF</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0xD0</span>, <span style=color:#ae81ff>0xEF</span>, <span style=color:#ae81ff>0xAA</span>, <span style=color:#ae81ff>0xFB</span>, <span style=color:#ae81ff>0x43</span>, <span style=color:#ae81ff>0x4D</span>, <span style=color:#ae81ff>0x33</span>, <span style=color:#ae81ff>0x85</span>, <span style=color:#ae81ff>0x45</span>, <span style=color:#ae81ff>0xF9</span>, <span style=color:#ae81ff>0x02</span>, <span style=color:#ae81ff>0x7F</span>, <span style=color:#ae81ff>0x50</span>, <span style=color:#ae81ff>0x3C</span>, <span style=color:#ae81ff>0x9F</span>, <span style=color:#ae81ff>0xA8</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0x51</span>, <span style=color:#ae81ff>0xA3</span>, <span style=color:#ae81ff>0x40</span>, <span style=color:#ae81ff>0x8F</span>, <span style=color:#ae81ff>0x92</span>, <span style=color:#ae81ff>0x9D</span>, <span style=color:#ae81ff>0x38</span>, <span style=color:#ae81ff>0xF5</span>, <span style=color:#ae81ff>0xBC</span>, <span style=color:#ae81ff>0xB6</span>, <span style=color:#ae81ff>0xDA</span>, <span style=color:#ae81ff>0x21</span>, <span style=color:#ae81ff>0x10</span>, <span style=color:#ae81ff>0xFF</span>, <span style=color:#ae81ff>0xF3</span>, <span style=color:#ae81ff>0xD2</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0xCD</span>, <span style=color:#ae81ff>0x0C</span>, <span style=color:#ae81ff>0x13</span>, <span style=color:#ae81ff>0xEC</span>, <span style=color:#ae81ff>0x5F</span>, <span style=color:#ae81ff>0x97</span>, <span style=color:#ae81ff>0x44</span>, <span style=color:#ae81ff>0x17</span>, <span style=color:#ae81ff>0xC4</span>, <span style=color:#ae81ff>0xA7</span>, <span style=color:#ae81ff>0x7E</span>, <span style=color:#ae81ff>0x3D</span>, <span style=color:#ae81ff>0x64</span>, <span style=color:#ae81ff>0x5D</span>, <span style=color:#ae81ff>0x19</span>, <span style=color:#ae81ff>0x73</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0x60</span>, <span style=color:#ae81ff>0x81</span>, <span style=color:#ae81ff>0x4F</span>, <span style=color:#ae81ff>0xDC</span>, <span style=color:#ae81ff>0x22</span>, <span style=color:#ae81ff>0x2A</span>, <span style=color:#ae81ff>0x90</span>, <span style=color:#ae81ff>0x88</span>, <span style=color:#ae81ff>0x46</span>, <span style=color:#ae81ff>0xEE</span>, <span style=color:#ae81ff>0xB8</span>, <span style=color:#ae81ff>0x14</span>, <span style=color:#ae81ff>0xDE</span>, <span style=color:#ae81ff>0x5E</span>, <span style=color:#ae81ff>0x0B</span>, <span style=color:#ae81ff>0xDB</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0xE0</span>, <span style=color:#ae81ff>0x32</span>, <span style=color:#ae81ff>0x3A</span>, <span style=color:#ae81ff>0x0A</span>, <span style=color:#ae81ff>0x49</span>, <span style=color:#ae81ff>0x06</span>, <span style=color:#ae81ff>0x24</span>, <span style=color:#ae81ff>0x5C</span>, <span style=color:#ae81ff>0xC2</span>, <span style=color:#ae81ff>0xD3</span>, <span style=color:#ae81ff>0xAC</span>, <span style=color:#ae81ff>0x62</span>, <span style=color:#ae81ff>0x91</span>, <span style=color:#ae81ff>0x95</span>, <span style=color:#ae81ff>0xE4</span>, <span style=color:#ae81ff>0x79</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0xE7</span>, <span style=color:#ae81ff>0xC8</span>, <span style=color:#ae81ff>0x37</span>, <span style=color:#ae81ff>0x6D</span>, <span style=color:#ae81ff>0x8D</span>, <span style=color:#ae81ff>0xD5</span>, <span style=color:#ae81ff>0x4E</span>, <span style=color:#ae81ff>0xA9</span>, <span style=color:#ae81ff>0x6C</span>, <span style=color:#ae81ff>0x56</span>, <span style=color:#ae81ff>0xF4</span>, <span style=color:#ae81ff>0xEA</span>, <span style=color:#ae81ff>0x65</span>, <span style=color:#ae81ff>0x7A</span>, <span style=color:#ae81ff>0xAE</span>, <span style=color:#ae81ff>0x08</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0xBA</span>, <span style=color:#ae81ff>0x78</span>, <span style=color:#ae81ff>0x25</span>, <span style=color:#ae81ff>0x2E</span>, <span style=color:#ae81ff>0x1C</span>, <span style=color:#ae81ff>0xA6</span>, <span style=color:#ae81ff>0xB4</span>, <span style=color:#ae81ff>0xC6</span>, <span style=color:#ae81ff>0xE8</span>, <span style=color:#ae81ff>0xDD</span>, <span style=color:#ae81ff>0x74</span>, <span style=color:#ae81ff>0x1F</span>, <span style=color:#ae81ff>0x4B</span>, <span style=color:#ae81ff>0xBD</span>, <span style=color:#ae81ff>0x8B</span>, <span style=color:#ae81ff>0x8A</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0x70</span>, <span style=color:#ae81ff>0x3E</span>, <span style=color:#ae81ff>0xB5</span>, <span style=color:#ae81ff>0x66</span>, <span style=color:#ae81ff>0x48</span>, <span style=color:#ae81ff>0x03</span>, <span style=color:#ae81ff>0xF6</span>, <span style=color:#ae81ff>0x0E</span>, <span style=color:#ae81ff>0x61</span>, <span style=color:#ae81ff>0x35</span>, <span style=color:#ae81ff>0x57</span>, <span style=color:#ae81ff>0xB9</span>, <span style=color:#ae81ff>0x86</span>, <span style=color:#ae81ff>0xC1</span>, <span style=color:#ae81ff>0x1D</span>, <span style=color:#ae81ff>0x9E</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0xE1</span>, <span style=color:#ae81ff>0xF8</span>, <span style=color:#ae81ff>0x98</span>, <span style=color:#ae81ff>0x11</span>, <span style=color:#ae81ff>0x69</span>, <span style=color:#ae81ff>0xD9</span>, <span style=color:#ae81ff>0x8E</span>, <span style=color:#ae81ff>0x94</span>, <span style=color:#ae81ff>0x9B</span>, <span style=color:#ae81ff>0x1E</span>, <span style=color:#ae81ff>0x87</span>, <span style=color:#ae81ff>0xE9</span>, <span style=color:#ae81ff>0xCE</span>, <span style=color:#ae81ff>0x55</span>, <span style=color:#ae81ff>0x28</span>, <span style=color:#ae81ff>0xDF</span>],
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>0x8C</span>, <span style=color:#ae81ff>0xA1</span>, <span style=color:#ae81ff>0x89</span>, <span style=color:#ae81ff>0x0D</span>, <span style=color:#ae81ff>0xBF</span>, <span style=color:#ae81ff>0xE6</span>, <span style=color:#ae81ff>0x42</span>, <span style=color:#ae81ff>0x68</span>, <span style=color:#ae81ff>0x41</span>, <span style=color:#ae81ff>0x99</span>, <span style=color:#ae81ff>0x2D</span>, <span style=color:#ae81ff>0x0F</span>, <span style=color:#ae81ff>0xB0</span>, <span style=color:#ae81ff>0x54</span>, <span style=color:#ae81ff>0xBB</span>, <span style=color:#ae81ff>0x16</span>]
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>data_prepreprocess</span>():
</span></span><span style=display:flex><span>    pts <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    traces <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> f <span style=color:#f92672>in</span> Path(<span style=color:#e6db74>&#34;./PicoCTF/Crypto/PowerAnalysis- Part 2/traces&#34;</span>)<span style=color:#f92672>.</span>iterdir():
</span></span><span style=display:flex><span>        l <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read_text()<span style=color:#f92672>.</span>splitlines()
</span></span><span style=display:flex><span>        pt <span style=color:#f92672>=</span> bytes<span style=color:#f92672>.</span>fromhex(l[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;: &#34;</span>)[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>        trace <span style=color:#f92672>=</span> ast<span style=color:#f92672>.</span>literal_eval(l[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;: &#34;</span>)[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>        pts<span style=color:#f92672>.</span>append(pt<span style=color:#f92672>.</span>hex())
</span></span><span style=display:flex><span>        traces<span style=color:#f92672>.</span>append(trace)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> pts, traces
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>data_preprocess</span>(pts, traces):
</span></span><span style=display:flex><span>    pt_col <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    trace_col <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> bytes <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>16</span>):
</span></span><span style=display:flex><span>        tmp_pt_col <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trace_idx <span style=color:#f92672>in</span> range(len(pts)):
</span></span><span style=display:flex><span>            tmp_pt_col<span style=color:#f92672>.</span>append(int(pts[trace_idx][bytes<span style=color:#f92672>*</span><span style=color:#ae81ff>2</span>:(bytes<span style=color:#f92672>*</span><span style=color:#ae81ff>2</span>)<span style=color:#f92672>+</span><span style=color:#ae81ff>2</span>], <span style=color:#ae81ff>16</span>))
</span></span><span style=display:flex><span>        pt_col<span style=color:#f92672>.</span>append(tmp_pt_col)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> point <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>300</span>, <span style=color:#ae81ff>400</span>):<span style=color:#75715e>#len(json_data[0][&#39;pm&#39;])</span>
</span></span><span style=display:flex><span>        tmp_trace_col <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trace_idx <span style=color:#f92672>in</span> range(len(pts)):
</span></span><span style=display:flex><span>            tmp_trace_col<span style=color:#f92672>.</span>append(traces[trace_idx][point])
</span></span><span style=display:flex><span>        trace_col<span style=color:#f92672>.</span>append(tmp_trace_col)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> pt_col, trace_col
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>sbox_preprocess</span>(pt_col):
</span></span><span style=display:flex><span>    sbox_result_tmp <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> sbox_key <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>256</span>): <span style=color:#75715e># 總共有256個sbox key</span>
</span></span><span style=display:flex><span>        tmp <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trace <span style=color:#f92672>in</span> range(len(pt_col)): <span style=color:#75715e># 有50個trace</span>
</span></span><span style=display:flex><span>            tmp<span style=color:#f92672>.</span>append(pt_col[trace] <span style=color:#f92672>^</span> sbox_key)
</span></span><span style=display:flex><span>        sbox_result_tmp<span style=color:#f92672>.</span>append(tmp)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sbox_result_tmp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>choose_sbox</span>(sbox_result_tmp):
</span></span><span style=display:flex><span>    sbox_result <span style=color:#f92672>=</span> copy<span style=color:#f92672>.</span>deepcopy(sbox_result_tmp)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> sbox_key <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>256</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> trace <span style=color:#f92672>in</span> range(len(sbox_result_tmp[<span style=color:#ae81ff>0</span>])):
</span></span><span style=display:flex><span>            hex_value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{0:0&gt;2x}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(sbox_result_tmp[sbox_key][trace])
</span></span><span style=display:flex><span>            x, y <span style=color:#f92672>=</span> hex_value[<span style=color:#ae81ff>0</span>], hex_value[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>            sbox_result[sbox_key][trace] <span style=color:#f92672>=</span> s_box[int(x, <span style=color:#ae81ff>16</span>)][int(y, <span style=color:#ae81ff>16</span>)]
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sbox_result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>cal_hamming_weight</span>(sbox_result_col):
</span></span><span style=display:flex><span>    hw_model <span style=color:#f92672>=</span> copy<span style=color:#f92672>.</span>deepcopy(sbox_result_col)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(len(sbox_result_col)):   <span style=color:#75715e># 256</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> j <span style=color:#f92672>in</span> range(len(sbox_result_col[i])):    <span style=color:#75715e># 50</span>
</span></span><span style=display:flex><span>            hw_model[i][j] <span style=color:#f92672>=</span> bin(sbox_result_col[i][j])<span style=color:#f92672>.</span>count(<span style=color:#e6db74>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> hw_model
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>cal_correlation</span>(hw_model_col_result, trace_col):
</span></span><span style=display:flex><span>    correlation_result <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> trange(len(hw_model_col_result)):<span style=color:#75715e>#(ascii_letters + digits).encode():</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> j <span style=color:#f92672>in</span> range(biggest_length):<span style=color:#75715e>#len(trace_col)</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># correlation_result.append(corrcoef(hw_model_col_result[i], trace_col[j])[0, -1])</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># correlation_result.append(pearsonr(hw_model_col_result[i], trace_col[j])[0])</span>
</span></span><span style=display:flex><span>            correlation_result<span style=color:#f92672>.</span>append(run_pearson_correlation(hw_model_col_result[i], trace_col[j]))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> correlation_result
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run_pearson_correlation</span>(x, y):
</span></span><span style=display:flex><span>    mean_x <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>mean(x)
</span></span><span style=display:flex><span>    mean_y <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>mean(y)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    covariance <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>sum((x <span style=color:#f92672>-</span> mean_x) <span style=color:#f92672>*</span> (y <span style=color:#f92672>-</span> mean_y))
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    std_dev_x <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>sqrt(np<span style=color:#f92672>.</span>sum((x <span style=color:#f92672>-</span> mean_x)<span style=color:#f92672>**</span><span style=color:#ae81ff>2</span>))
</span></span><span style=display:flex><span>    std_dev_y <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>sqrt(np<span style=color:#f92672>.</span>sum((y <span style=color:#f92672>-</span> mean_y)<span style=color:#f92672>**</span><span style=color:#ae81ff>2</span>))
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    correlation <span style=color:#f92672>=</span> covariance <span style=color:#f92672>/</span> (std_dev_x <span style=color:#f92672>*</span> std_dev_y)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> correlation
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>display_pt</span>(offset:int, traces, data_offset <span style=color:#f92672>=</span> (<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2666</span>)):
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>plot(range(data_offset[<span style=color:#ae81ff>0</span>], data_offset[<span style=color:#ae81ff>1</span>]), traces[offset][data_offset[<span style=color:#ae81ff>0</span>]:data_offset[<span style=color:#ae81ff>1</span>]])
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>savefig(fname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;./PicoCTF/Crypto/PowerAnalysis- Part 2/pt_&#34;</span> <span style=color:#f92672>+</span> str(offset) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.jpg&#34;</span>)
</span></span><span style=display:flex><span>    plt<span style=color:#f92672>.</span>clf()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pts, traces <span style=color:#f92672>=</span> data_prepreprocess()
</span></span><span style=display:flex><span><span style=color:#75715e># display_pt(1, (0, 700))</span>
</span></span><span style=display:flex><span><span style=color:#75715e># display_pt(1, traces, (0, 2666))</span>
</span></span><span style=display:flex><span>pt_col, trace_col <span style=color:#f92672>=</span> data_preprocess(pts, traces)
</span></span><span style=display:flex><span>flag <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>biggest_length <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span><span style=color:#75715e>#len(trace_col)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> idx <span style=color:#f92672>in</span> trange(<span style=color:#ae81ff>16</span>):
</span></span><span style=display:flex><span>    sbox_preprocess_result <span style=color:#f92672>=</span> sbox_preprocess(pt_col[idx])
</span></span><span style=display:flex><span>    choose_sbox_result <span style=color:#f92672>=</span> choose_sbox(sbox_preprocess_result)
</span></span><span style=display:flex><span>    hw_model_col_result <span style=color:#f92672>=</span> cal_hamming_weight(choose_sbox_result)
</span></span><span style=display:flex><span>    correlation_result <span style=color:#f92672>=</span> cal_correlation(hw_model_col_result, trace_col)
</span></span><span style=display:flex><span>    key_idx <span style=color:#f92672>=</span> correlation_result<span style=color:#f92672>.</span>index(max(correlation_result))
</span></span><span style=display:flex><span>    <span style=color:#75715e># flag += (ascii_letters + digits)[key_idx // biggest_length]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>from</span> Crypto.Util.number <span style=color:#f92672>import</span> long_to_bytes
</span></span><span style=display:flex><span>    flag <span style=color:#f92672>+=</span> long_to_bytes(key_idx <span style=color:#f92672>//</span> biggest_length)<span style=color:#f92672>.</span>hex()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;The key of AES is: &#39;</span> <span style=color:#f92672>+</span> flag )
</span></span></code></pre></div><p>:::</p><p>Flag: <code>picoCTF{b7698f76b7e524ee7cd80dbde0cdff59}</code></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#recon>Recon</a></li><li><a href=#exploit>Exploit</a><ul><li><a href=#exploit-part-2>Exploit Part 2</a></li></ul></li></ul></nav></div></aside></main></body></html>