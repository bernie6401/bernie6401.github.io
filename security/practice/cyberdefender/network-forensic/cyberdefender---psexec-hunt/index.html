<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  CyberDefender - PsExec Hunt
  #

:::spoiler
[TOC]
:::

  Scenario
  #


Our Intrusion Detection System (IDS) has raised an alert, indicating suspicious lateral movement activity involving the use of PsExec. To effectively respond to this incident, your role as a SOC Analyst is to analyze the captured network traffic stored in a PCAP file.

  ==Q1==
  #


In order to effectively trace the attacker&rsquo;s activities within our network, can you determine the IP address of the machine where the attacker initially gained access?"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/practice/cyberdefender/network-forensic/cyberdefender---psexec-hunt/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="CyberDefender - PsExec Hunt"><meta property="og:description" content="CyberDefender - PsExec Hunt # :::spoiler [TOC] :::
Scenario # Our Intrusion Detection System (IDS) has raised an alert, indicating suspicious lateral movement activity involving the use of PsExec. To effectively respond to this incident, your role as a SOC Analyst is to analyze the captured network traffic stored in a PCAP file.
==Q1== # In order to effectively trace the attacker’s activities within our network, can you determine the IP address of the machine where the attacker initially gained access?"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="CyberDefender"><meta property="article:tag" content="Network Forensics"><title>CyberDefender - PsExec Hunt | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/practice/cyberdefender/network-forensic/cyberdefender---psexec-hunt/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>CyberDefender - PsExec Hunt</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#scenario>Scenario</a></li><li><a href=#q1>==Q1==</a><ul><li><a href=#recon>Recon</a></li><li><a href=#exploit>Exploit</a></li></ul></li><li><a href=#q2>==Q2==</a><ul><li><a href=#recon-1>Recon</a></li><li><a href=#exploit-1>Exploit</a></li></ul></li><li><a href=#q3>==Q3==</a><ul><li><a href=#recon-2>Recon</a></li></ul></li><li><a href=#q4>==Q4==</a><ul><li><a href=#recon-3>Recon</a></li></ul></li><li><a href=#q5>==Q5==</a><ul><li><a href=#recon-4>Recon</a></li><li><a href=#exploit-2>Exploit</a></li></ul></li><li><a href=#q6>==Q6==</a><ul><li><a href=#recon-5>Recon</a></li><li><a href=#exploit-3>Exploit</a></li></ul></li><li><a href=#q7>==Q7==</a><ul><li><a href=#recon-6>Recon</a></li><li><a href=#exploit-4>Exploit</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=cyberdefender---psexec-hunt>CyberDefender - PsExec Hunt
<a class=anchor href=#cyberdefender---psexec-hunt>#</a></h1><p>:::spoiler
[TOC]
:::</p><h2 id=scenario>Scenario
<a class=anchor href=#scenario>#</a></h2><blockquote><p>Our Intrusion Detection System (IDS) has raised an alert, indicating suspicious lateral movement activity involving the use of PsExec. To effectively respond to this incident, your role as a SOC Analyst is to analyze the captured network traffic stored in a PCAP file.</p></blockquote><h2 id=q1>==Q1==
<a class=anchor href=#q1>#</a></h2><blockquote><p>In order to effectively trace the attacker&rsquo;s activities within our network, can you determine the IP address of the machine where the attacker initially gained access?</p></blockquote><h3 id=recon>Recon
<a class=anchor href=#recon>#</a></h3><p>我判斷的方式很簡單，就直接從endpoints看封包數量，選最多或是前幾多的IP就對了</p><h3 id=exploit>Exploit
<a class=anchor href=#exploit>#</a></h3><p><img src=https://hackmd.io/_uploads/SJA8VgrM6.png alt></p><p>Flag: <code>10.0.0.130</code></p><h2 id=q2>==Q2==
<a class=anchor href=#q2>#</a></h2><blockquote><p>To fully comprehend the extent of the breach, can we determine the machine&rsquo;s hostname to which the attacker pivoted?</p></blockquote><h3 id=recon-1>Recon
<a class=anchor href=#recon-1>#</a></h3><p>這一題找超久，題目要找到攻擊者所轉向的電腦主機名稱，首先聚焦在問題中提到的hostname，我一直以為是Browser的host name，但看起來他不是這個意思
<img src=https://hackmd.io/_uploads/B16zT8BfT.png alt>
我先用export看他哪時候把psexec放到該主機上，可見最早放到主機上的時間是packet #192，所以直覺應該是往前找，畢竟要先把該主機compromised才能做後續的操作
<img src=https://hackmd.io/_uploads/HyGEC8Hza.png alt></p><h3 id=exploit-1>Exploit
<a class=anchor href=#exploit-1>#</a></h3><p>慢慢找會發現packet #131的target name字數剛好和答案相同，不過也和一開始的猜想大致相同，也就是*-PC代表hostname
Filter: <code>ntlmssp.challenge.target_name == "SALES-PC"</code>
<img src=https://hackmd.io/_uploads/BJHgP-rz6.png alt></p><p>Flag: <code>SALES-PC</code></p><h2 id=q3>==Q3==
<a class=anchor href=#q3>#</a></h2><blockquote><p>After identifying the initial entry point, it&rsquo;s crucial to understand how far the attacker has moved laterally within our network. Knowing the username of the account the attacker used for authentication will give us insights into the extent of the breach. What is the username utilized by the attacker for authentication?</p></blockquote><h3 id=recon-2>Recon
<a class=anchor href=#recon-2>#</a></h3><p>這一題是找最久的，因為沒有和前面連起來，不然其實應該很快就找到，如果把filter去掉，然後看packet #131左右的其他packet會發現NTLM的authentication user name，這就是這一題的答案，我找到最後還想說用regular expression dump出英文字母六碼的所有結果，最後當然也是沒有然後
<img src=https://hackmd.io/_uploads/SkPvZDrGT.png alt></p><p>Flag: <code>ssales</code></p><h2 id=q4>==Q4==
<a class=anchor href=#q4>#</a></h2><blockquote><p>After figuring out how the attacker moved within our network, we need to know what they did on the target machine. What&rsquo;s the name of the service executable the attacker set up on the target?</p></blockquote><h3 id=recon-3>Recon
<a class=anchor href=#recon-3>#</a></h3><p>這一題就很簡單了，可以看第二題所得知的export file，他會把所有機器之間通訊的檔案以及hostname/filename都呈現出來，因此這一題很明顯就是<code>PSEXESVC</code></p><p>Flag: <code>PSEXESVC</code></p><h2 id=q5>==Q5==
<a class=anchor href=#q5>#</a></h2><blockquote><p>We need to know how the attacker installed the service on the compromised machine to understand the attacker&rsquo;s lateral movement tactics. This can help identify other affected systems. Which network share was used by PsExec to install the service on the target machine?</p></blockquote><h3 id=recon-4>Recon
<a class=anchor href=#recon-4>#</a></h3><p>題目想知道攻擊者選擇哪個network share安裝psexec，所以直覺會想到要用看主機之間傳送的檔案紀錄</p><h3 id=exploit-2>Exploit
<a class=anchor href=#exploit-2>#</a></h3><p>呈第二題，既然知道最早是從packet #192把該檔案透過\\ADMIN$帳號傳送給別台主機，則答案應該就是<code>ADMIN$</code></p><p>Flag: <code>ADMIN$</code></p><h2 id=q6>==Q6==
<a class=anchor href=#q6>#</a></h2><blockquote><p>We must identify the network share used to communicate between the two machines. Which network share did PsExec use for communication?</p></blockquote><h3 id=recon-5>Recon
<a class=anchor href=#recon-5>#</a></h3><p>題目想知道psexec是用哪個network share進行通訊，也是直覺可以從smb的檔案之間的紀錄下手</p><h3 id=exploit-3>Exploit
<a class=anchor href=#exploit-3>#</a></h3><p>可以看到<code>\\IPC$</code>所傳送的filename包含stdout/stdin/stderr，所以基本上應該就是該帳號在進行通訊</p><p>Flag: <code>IPC$</code></p><h2 id=q7>==Q7==
<a class=anchor href=#q7>#</a></h2><blockquote><p>Now that we have a clearer picture of the attacker&rsquo;s activities on the compromised machine, it&rsquo;s important to identify any further lateral movement. What is the machine&rsquo;s hostname to which the attacker attempted to pivot within our network?</p></blockquote><h3 id=recon-6>Recon
<a class=anchor href=#recon-6>#</a></h3><p>題目想知道後續的橫向移動的目標是哪一題主機，並指出hostname為何，所以可以從packet #192往後找，或是我們可以直接下filter:<code>ntlmssp.ntlmv2_response.nb_domain_name</code>，就可以知道</p><h3 id=exploit-4>Exploit
<a class=anchor href=#exploit-4>#</a></h3><p>要注意的是，NTLM中的NetBIOS Domain Name貌似和SMB2 Host是不一樣的，NTLM中的domain name應該是連接smb的那台主機所處的domain name為何，而smb2 host應該是被連接的那台機器所處的domain，可能是一台印表機之類的，這樣想就蠻合理的，而題目要我們找的是ntlm domain的hostname
<img src=https://hackmd.io/_uploads/BJkUUvHMT.png alt></p><p>Flag: <code>MARKETING-PC</code></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#scenario>Scenario</a></li><li><a href=#q1>==Q1==</a><ul><li><a href=#recon>Recon</a></li><li><a href=#exploit>Exploit</a></li></ul></li><li><a href=#q2>==Q2==</a><ul><li><a href=#recon-1>Recon</a></li><li><a href=#exploit-1>Exploit</a></li></ul></li><li><a href=#q3>==Q3==</a><ul><li><a href=#recon-2>Recon</a></li></ul></li><li><a href=#q4>==Q4==</a><ul><li><a href=#recon-3>Recon</a></li></ul></li><li><a href=#q5>==Q5==</a><ul><li><a href=#recon-4>Recon</a></li><li><a href=#exploit-2>Exploit</a></li></ul></li><li><a href=#q6>==Q6==</a><ul><li><a href=#recon-5>Recon</a></li><li><a href=#exploit-3>Exploit</a></li></ul></li><li><a href=#q7>==Q7==</a><ul><li><a href=#recon-6>Recon</a></li><li><a href=#exploit-4>Exploit</a></li></ul></li></ul></nav></div></aside></main></body></html>